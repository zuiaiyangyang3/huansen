window.Laya=function(t){"use strict";class e{}e.Loader=null,e.Context=null,e.Browser=null,e.Laya=null,e.loader=null,e.timer=null,e.systemTimer=null,e.physicsTimer=null,e.stage=null;class i{static getPoolBySign(t){return i._poolDic[t]||(i._poolDic[t]=[])}static clearBySign(t){i._poolDic[t]&&(i._poolDic[t].length=0)}static recover(t,e){!1===e[i.POOLSIGN]&&(e[i.POOLSIGN]=!0,i.getPoolBySign(t).push(e))}static recoverByClass(t){if(t){var e=t.__className||t.constructor._$gid;e&&i.recover(e,t)}}static _getClassSign(t){var e=t.__className||t._$gid;return e||(t._$gid=e=i._CLSID+"",i._CLSID++),e}static createByClass(t){return i.getItemByClass(i._getClassSign(t),t)}static getItemByClass(t,e){let s,r=i.getPoolBySign(t);return s=r.length?r.pop():new e,s[i.POOLSIGN]=!1,s}static getItemByCreateFun(t,e,s=null){var r=i.getPoolBySign(t),a=r.length?r.pop():e.call(s);return a[i.POOLSIGN]=!1,a}static getItem(t){var e=i.getPoolBySign(t),s=e.length?e.pop():null;return s&&(s[i.POOLSIGN]=!1),s}}i._CLSID=0,i.POOLSIGN="__InPool",i._poolDic={};class s{constructor(t=0,e=0){this.x=t,this.y=e}static create(){return i.getItemByClass("Point",s)}setTo(t,e){return this.x=t,this.y=e,this}reset(){return this.x=this.y=0,this}recover(){i.recover("Point",this.reset())}distance(t,e){return Math.sqrt((this.x-t)*(this.x-t)+(this.y-e)*(this.y-e))}toString(){return this.x+","+this.y}normalize(){var t=Math.sqrt(this.x*this.x+this.y*this.y);if(t>0){var e=1/t;this.x*=e,this.y*=e}}copy(t){return this.setTo(t.x,t.y)}}s.TEMP=new s,s.EMPTY=new s;class r{static isMouseEvent(t){return a.has(t)}constructor(){this.touchId=0,this.delta=0,this.button=0,this.touchPos=new s}setTo(t,e,i){return this.type=t,this.currentTarget=e,this.target=i,this}stopPropagation(){this._stopped=!0}get touches(){return this._touches}get altKey(){var t;return null===(t=this.nativeEvent)||void 0===t?void 0:t.altKey}get ctrlKey(){var t;return null===(t=this.nativeEvent)||void 0===t?void 0:t.ctrlKey}get shiftKey(){var t;return null===(t=this.nativeEvent)||void 0===t?void 0:t.shiftKey}get metaKey(){var t;return null===(t=this.nativeEvent)||void 0===t?void 0:t.metaKey}get key(){return this.nativeEvent.key}get keyCode(){return this.nativeEvent.keyCode}get charCode(){var t;return null===(t=this.nativeEvent)||void 0===t?void 0:t.code}get keyLocation(){return this.nativeEvent?this.nativeEvent.location||this.nativeEvent.keyLocation:0}get stageX(){return this.touchPos.x}get stageY(){return this.touchPos.y}}r.EMPTY=new r,r.MOUSE_DOWN="mousedown",r.MOUSE_UP="mouseup",r.RIGHT_MOUSE_DOWN="rightmousedown",r.RIGHT_MOUSE_UP="rightmouseup",r.CLICK="click",r.RIGHT_CLICK="rightclick",r.MOUSE_MOVE="mousemove",r.MOUSE_OVER="mouseover",r.MOUSE_OUT="mouseout",r.MOUSE_WHEEL="mousewheel",r.ROLL_OVER="mouseover",r.ROLL_OUT="mouseout",r.DOUBLE_CLICK="doubleclick",r.MOUSE_DRAG="mousedrag",r.MOUSE_DRAG_END="mousedragend",r.DRAG_START="dragstart",r.DRAG_MOVE="dragmove",r.DRAG_END="dragend",r.KEY_DOWN="keydown",r.KEY_PRESS="keypress",r.KEY_UP="keyup",r.CHANGE="change",r.CHANGED="changed",r.WILL_RESIZE="willResize",r.RESIZE="resize",r.ADDED="added",r.REMOVED="removed",r.DISPLAY="display",r.UNDISPLAY="undisplay",r.ERROR="error",r.COMPLETE="complete",r.LOADED="loaded",r.READY="ready",r.PROGRESS="progress",r.INPUT="input",r.RENDER="render",r.OPEN="open",r.MESSAGE="message",r.CLOSE="close",r.FRAME="enterframe",r.ENTER="enter",r.SELECT="select",r.BLUR="blur",r.FOCUS="focus",r.VISIBILITY_CHANGE="visibilitychange",r.FOCUS_CHANGE="focuschange",r.PLAYED="played",r.PAUSED="paused",r.STOPPED="stopped",r.START="start",r.END="end",r.LINK="link",r.LABEL="label",r.FULL_SCREEN_CHANGE="fullscreenchange",r.DEVICE_LOST="devicelost",r.TRANSFORM_CHANGED="transformchanged",r.LAYERCHANGE="layerChange",r.staticMask="staticMask",r.TRIGGER_ENTER="triggerenter",r.TRIGGER_STAY="triggerstay",r.TRIGGER_EXIT="triggerexit",r.COLLISION_ENTER="collisionenter",r.COLLISION_STAY="collisionstay",r.COLLISION_EXIT="collisionexit",r.JOINT_BREAK="jointbreak",r._Add_Script="addscript";const a=new Set([r.MOUSE_DOWN,r.MOUSE_UP,r.MOUSE_MOVE,r.CLICK,r.DOUBLE_CLICK,r.RIGHT_CLICK,r.RIGHT_MOUSE_DOWN,r.RIGHT_MOUSE_UP,r.MOUSE_OVER,r.MOUSE_OUT,r.MOUSE_WHEEL,r.MOUSE_DRAG,r.MOUSE_DRAG_END]);class n{}n.version="3.2.1",n.isPlaying=!0,n.isPreview=!1,n.isConch=!!window&&null!=window.conch;class l{}var o;t.RenderTargetFormat=void 0,(o=t.RenderTargetFormat||(t.RenderTargetFormat={}))[o.None=-1]="None",o[o.R8G8B8=0]="R8G8B8",o[o.R8G8B8A8=1]="R8G8B8A8",o[o.R16G16B16A16=17]="R16G16B16A16",o[o.R32G32B32=30]="R32G32B32",o[o.R32G32B32A32=15]="R32G32B32A32",o[o.R16G16B16=31]="R16G16B16",o[o.DEPTH_16=35]="DEPTH_16",o[o.STENCIL_8=36]="STENCIL_8",o[o.DEPTHSTENCIL_24_8=37]="DEPTHSTENCIL_24_8",o[o.DEPTH_32=38]="DEPTH_32",o[o.DEPTHSTENCIL_24_Plus=39]="DEPTHSTENCIL_24_Plus";class h{constructor(){}static isZero(t){return Math.abs(t)<h.zeroTolerance}static nearEqual(t,e){return!!h.isZero(t-e)}static fastInvSqrt(t){return h.isZero(t)?t:1/Math.sqrt(t)}}h.zeroTolerance=1e-6,h.MaxValue=340282347e30,h.MinValue=-340282347e30,h.Deg2Rad=Math.PI/180;class u{constructor(t=0,e=0,i=0,s=0){this.x=t,this.y=e,this.z=i,this.w=s}setValue(t,e,i,s){this.x=t,this.y=e,this.z=i,this.w=s}fromArray(t,e=0){this.x=t[e+0],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3]}toArray(){return[this.x,this.y,this.z,this.w]}writeTo(t,e=0){t[e+0]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w}cloneTo(t){t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w}clone(){var t=new u;return this.cloneTo(t),t}static lerp(t,e,i,s){var r=t.x,a=t.y,n=t.z,l=t.w;s.x=r+i*(e.x-r),s.y=a+i*(e.y-a),s.z=n+i*(e.z-n),s.w=l+i*(e.w-l)}static transformByM4x4(t,e,i){var s=t.x,r=t.y,a=t.z,n=t.w,l=e.elements;i.x=s*l[0]+r*l[4]+a*l[8]+n*l[12],i.y=s*l[1]+r*l[5]+a*l[9]+n*l[13],i.z=s*l[2]+r*l[6]+a*l[10]+n*l[14],i.w=s*l[3]+r*l[7]+a*l[11]+n*l[15]}static equals(t,e){return h.nearEqual(Math.abs(t.x),Math.abs(e.x))&&h.nearEqual(Math.abs(t.y),Math.abs(e.y))&&h.nearEqual(Math.abs(t.z),Math.abs(e.z))&&h.nearEqual(Math.abs(t.w),Math.abs(e.w))}equal(t){return u.equals(this,t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static normalize(t,e){var i=t.length();if(i>0){var s=1/i;e.x=t.x*s,e.y=t.y*s,e.z=t.z*s,e.w=t.w*s}}static add(t,e,i){i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z,i.w=t.w+e.w}static subtract(t,e,i){i.x=t.x-e.x,i.y=t.y-e.y,i.z=t.z-e.z,i.w=t.w-e.w}static multiply(t,e,i){i.x=t.x*e.x,i.y=t.y*e.y,i.z=t.z*e.z,i.w=t.w*e.w}static scale(t,e,i){i.x=t.x*e,i.y=t.y*e,i.z=t.z*e,i.w=t.w*e}static Clamp(t,e,i,s){var r=t.x,a=t.y,n=t.z,l=t.w,o=e.x,h=e.y,u=e.z,d=e.w,c=i.x,_=i.y,p=i.z,f=i.w;r=(r=r>c?c:r)<o?o:r,a=(a=a>_?_:a)<h?h:a,n=(n=n>p?p:n)<u?u:n,l=(l=l>f?f:l)<d?d:l,s.x=r,s.y=a,s.z=n,s.w=l}static distanceSquared(t,e){var i=t.x-e.x,s=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return i*i+s*s+r*r+a*a}static distance(t,e){var i=t.x-e.x,s=t.y-e.y,r=t.z-e.z,a=t.w-e.w;return Math.sqrt(i*i+s*s+r*r+a*a)}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static min(t,e,i){i.x=Math.min(t.x,e.x),i.y=Math.min(t.y,e.y),i.z=Math.min(t.z,e.z),i.w=Math.min(t.w,e.w)}static max(t,e,i){i.x=Math.max(t.x,e.x),i.y=Math.max(t.y,e.y),i.z=Math.max(t.z,e.z),i.w=Math.max(t.w,e.w)}}u.ZERO=new u,u.ONE=new u(1,1,1,1),u.UnitX=new u(1,0,0,0),u.UnitY=new u(0,1,0,0),u.UnitZ=new u(0,0,1,0),u.UnitW=new u(0,0,0,1),u.tempVec4=new u(0,0,0,0);class d{static distanceSquared(t,e){var i=t.x-e.x,s=t.y-e.y,r=t.z-e.z;return i*i+s*s+r*r}static distance(t,e){var i=t.x-e.x,s=t.y-e.y,r=t.z-e.z;return Math.sqrt(i*i+s*s+r*r)}static min(t,e,i){i.x=Math.min(t.x,e.x),i.y=Math.min(t.y,e.y),i.z=Math.min(t.z,e.z)}static max(t,e,i){i.x=Math.max(t.x,e.x),i.y=Math.max(t.y,e.y),i.z=Math.max(t.z,e.z)}static transformQuat(t,e,i){var s=t.x,r=t.y,a=t.z,n=e.x,l=e.y,o=e.z,h=e.w,u=h*s+l*a-o*r,d=h*r+o*s-n*a,c=h*a+n*r-l*s,_=-n*s-l*r-o*a;i.x=u*h+_*-n+d*-o-c*-l,i.y=d*h+_*-l+c*-n-u*-o,i.z=c*h+_*-o+u*-l-d*-n}static scalarLength(t){var e=t.x,i=t.y,s=t.z;return Math.sqrt(e*e+i*i+s*s)}static scalarLengthSquared(t){var e=t.x,i=t.y,s=t.z;return e*e+i*i+s*s}static normalize(t,e){var i=t.x,s=t.y,r=t.z,a=i*i+s*s+r*r;a>0&&(a=1/Math.sqrt(a),e.x=i*a,e.y=s*a,e.z=r*a)}static multiply(t,e,i){i.x=t.x*e.x,i.y=t.y*e.y,i.z=t.z*e.z}static scale(t,e,i){i.x=t.x*e,i.y=t.y*e,i.z=t.z*e}static lerp(t,e,i,s){var r=t.x,a=t.y,n=t.z;s.x=r+i*(e.x-r),s.y=a+i*(e.y-a),s.z=n+i*(e.z-n)}static transformV3ToV3(t,e,i){d.transformV3ToV4(t,e,c),i.x=c.x,i.y=c.y,i.z=c.z}static transformV3ToV4(t,e,i){var s=t.x,r=t.y,a=t.z,n=e.elements;i.x=s*n[0]+r*n[4]+a*n[8]+n[12],i.y=s*n[1]+r*n[5]+a*n[9]+n[13],i.z=s*n[2]+r*n[6]+a*n[10]+n[14],i.w=s*n[3]+r*n[7]+a*n[11]+n[15]}static TransformNormal(t,e,i){var s=t.x,r=t.y,a=t.z,n=e.elements;i.x=s*n[0]+r*n[4]+a*n[8],i.y=s*n[1]+r*n[5]+a*n[9],i.z=s*n[2]+r*n[6]+a*n[10]}static transformCoordinate(t,e,i){var s=t.x,r=t.y,a=t.z,n=e.elements,l=s*n[3]+r*n[7]+a*n[11]+n[15];i.x=(s*n[0]+r*n[4]+a*n[8]+n[12])/l,i.y=(s*n[1]+r*n[5]+a*n[9]+n[13])/l,i.z=(s*n[2]+r*n[6]+a*n[10]+n[14])/l}static Clamp(t,e,i,s){var r=t.x,a=t.y,n=t.z,l=e.x,o=e.y,h=e.z,u=i.x,d=i.y,c=i.z;r=(r=r>u?u:r)<l?l:r,a=(a=a>d?d:a)<o?o:a,n=(n=n>c?c:n)<h?h:n,s.x=r,s.y=a,s.z=n}static add(t,e,i){i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z}static subtract(t,e,i){i.x=t.x-e.x,i.y=t.y-e.y,i.z=t.z-e.z}static cross(t,e,i){var s=t.x,r=t.y,a=t.z,n=e.x,l=e.y,o=e.z;i.x=r*o-a*l,i.y=a*n-s*o,i.z=s*l-r*n}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static equals(t,e){return h.nearEqual(t.x,e.x)&&h.nearEqual(t.y,e.y)&&h.nearEqual(t.z,e.z)}constructor(t=0,e=0,i=0){this.x=t,this.y=e,this.z=i}equal(t){return d.equals(this,t)}setValue(t,e,i){return this.x=t,this.y=e,this.z=i,this}set(t,e,i){return this.x=t,this.y=e,this.z=i,this}fromArray(t,e=0){this.x=t[e+0],this.y=t[e+1],this.z=t[e+2]}toArray(){return[this.x,this.y,this.z]}writeTo(t,e=0){t[e+0]=this.x,t[e+1]=this.y,t[e+2]=this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}vsub(t,e){return e.x=this.x-t.x,e.y=this.y-t.y,e.z=this.z-t.z,e}vadd(t,e){return e.x=this.x+t.x,e.y=this.y+t.y,e.z=this.z+t.z,e}scale(t,e){return e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e}normalize(){let t=this.x,e=this.y,i=this.z;var s=t*t+e*e+i*i;return s>0&&(s=1/Math.sqrt(s),this.x=t*s,this.y=e*s,this.z=i*s),this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t,e){var i=this.x,s=this.y,r=this.z,a=t.x,n=t.y,l=t.z;return e.x=s*l-r*n,e.y=r*a-i*l,e.z=i*n-s*a,e}cloneTo(t){t.x=this.x,t.y=this.y,t.z=this.z}clone(){var t=new d;return this.cloneTo(t),t}toDefault(){this.x=0,this.y=0,this.z=0}}d._tempVector3=new d,d.ZERO=new d(0,0,0),d.ONE=new d(1,1,1),d.NegativeUnitX=new d(-1,0,0),d.UnitX=new d(1,0,0),d.UnitY=new d(0,1,0),d.UnitZ=new d(0,0,1),d.ForwardRH=new d(0,0,-1),d.ForwardLH=new d(0,0,1),d.Up=new d(0,1,0);const c=new u;class _{static setResolution(t,e){_.customResolution=!0,_._resoluWidth=t,_._resoluHeight=e}}var p;_.enableDynamicBatch=!0,_.enableStaticBatch=!0,_.enableUniformBufferObject=!0,_.pixelRatio=1,_.customResolution=!1,_.defaultCacheRTMemory=256,_.defaultPhysicsMemory=16,_.enableMultiLight=!0,_.maxLightCount=32,_.lightClusterCount=new d(12,12,12),_.maxMorphTargetCount=32,_.useBVHCull=!1,_.BVH_max_SpatialCount=7,_.BVH_limit_size=32,_.BVH_Min_Build_nums=10,_._resoluWidth=-1,_._resoluHeight=-1,_.debugFrustumCulling=!1,t.TextureDimension=void 0,(p=t.TextureDimension||(t.TextureDimension={}))[p.Tex2D=0]="Tex2D",p[p.Cube=1]="Cube",p[p.Tex3D=2]="Tex3D",p[p.Texture2DArray=3]="Texture2DArray",p[p.CubeArray=4]="CubeArray",p[p.Unkonw=5]="Unkonw",p[p.None=6]="None";class f{}f.isAntialias=!0,f.useWebGL2=!0,f.FPS=60,f.useRetinalCanvas=!1,f.animationInterval=50,f.webGL2D_MeshAllocMaxMem=!0,f.defaultFontSize=12,f.defaultFont="Arial",f.isAlpha=!1,f.isDepth=!1,f.isfailIfMajorPerformanceCaveat=!1,f.powerPreference="default",f.premultipliedAlpha=!0,f.isStencil=!0,f.preserveDrawingBuffer=!1,f.printWebglOrder=!1,f.fontFamilyMap={"报隶":"报隶-简","黑体":"黑体-简","楷体":"楷体-简","兰亭黑":"兰亭黑-简","隶变":"隶变-简","凌慧体":"凌慧体-简","翩翩体":"翩翩体-简","苹方":"苹方-简","手札体":"手札体-简","宋体":"宋体-简","娃娃体":"娃娃体-简","魏碑":"魏碑-简","行楷":"行楷-简","雅痞":"雅痞-简","圆体":"圆体-简"},f.fixedFrames=!0,f.destroyResourceImmediatelyDefault=!0,f._enableWindowRAFFunction=!0;const g={};var m,y;t.HDREncodeFormat=void 0,(m=t.HDREncodeFormat||(t.HDREncodeFormat={}))[m.NONE=0]="NONE",m[m.RGBM=1]="RGBM",m[m.RGBD=2]="RGBD",t.TextureFormat=void 0,(y=t.TextureFormat||(t.TextureFormat={}))[y.R8G8B8=0]="R8G8B8",y[y.R8G8B8A8=1]="R8G8B8A8",y[y.R5G6B5=16]="R5G6B5",y[y.Alpha8=2]="Alpha8",y[y.DXT1=3]="DXT1",y[y.DXT3=29]="DXT3",y[y.DXT5=4]="DXT5",y[y.ETC1RGB=5]="ETC1RGB",y[y.ETC2RGB=6]="ETC2RGB",y[y.ETC2RGBA=7]="ETC2RGBA",y[y.ETC2SRGB_Alpha8=8]="ETC2SRGB_Alpha8",y[y.ETC2SRGB=28]="ETC2SRGB",y[y.ETC2RGB_Alpha1=32]="ETC2RGB_Alpha1",y[y.ETC2SRGB_Alpha1=33]="ETC2SRGB_Alpha1",y[y.PVRTCRGB_2BPPV=9]="PVRTCRGB_2BPPV",y[y.PVRTCRGBA_2BPPV=10]="PVRTCRGBA_2BPPV",y[y.PVRTCRGB_4BPPV=11]="PVRTCRGB_4BPPV",y[y.PVRTCRGBA_4BPPV=12]="PVRTCRGBA_4BPPV",y[y.R32G32B32A32=15]="R32G32B32A32",y[y.R32G32B32=30]="R32G32B32",y[y.R16G16B16A16=17]="R16G16B16A16",y[y.R16G16B16=31]="R16G16B16",y[y.ASTC4x4=18]="ASTC4x4",y[y.ASTC4x4SRGB=23]="ASTC4x4SRGB",y[y.ASTC6x6=19]="ASTC6x6",y[y.ASTC6x6SRGB=24]="ASTC6x6SRGB",y[y.ASTC8x8=20]="ASTC8x8",y[y.ASTC8x8SRGB=25]="ASTC8x8SRGB",y[y.ASTC10x10=21]="ASTC10x10",y[y.ASTC10x10SRGB=26]="ASTC10x10SRGB",y[y.ASTC12x12=22]="ASTC12x12",y[y.ASTC12x12SRGB=27]="ASTC12x12SRGB",y[y.KTXTEXTURE=-1]="KTXTEXTURE",y[y.PVRTEXTURE=-2]="PVRTEXTURE";class T{constructor(){this._flag=0,this._items=[]}add(t,e,i){let s=this._items,r=s.findIndex(((i,s,r)=>i==t&&r[s+1]==e));-1!=r?(s[r+2]=i,s[r+3]=1):s.push(t,e,i,1)}once(t,e,i){let s=this._items,r=s.findIndex(((i,s,r)=>i==t&&r[s+1]==e));-1!=r?(s[r+2]=i,s[r+3]=2):s.push(t,e,i,2)}remove(t,e){let i=this._items,s=i.findIndex(((i,s,r)=>i==t&&r[s+1]==e));-1!=s&&(0!=this._flag?(i[s+3]=0,this._flag=2):i.splice(s,4))}clear(){let t=this._items;0!=this._flag?(t.forEach(((t,e,i)=>{e%4==3&&(i[e]=0)})),this._flag=2):t.length=0}clearForTarget(t){if(!t)return;let e=this._items;if(0!=this._flag)e.forEach(((e,i,s)=>{i%4==1&&s[i]==t&&(s[i+2]=0)})),this._flag=2;else{let i=e.length-4;for(;i>=0;)e[i+1]==t&&e.splice(i,4),i-=4}}get count(){return this._items.length/4}invoke(...t){if(0!=this._flag)return;this._flag=1;let e=this._items,i=e.length;for(let s=0;s<i;s+=4){if(0==e[s+3])continue;let i=e[s+2];try{null!=i?e[s].call(e[s+1],...i,...t):e[s].call(e[s+1],...t)}catch(t){console.error(t)}2==e[s+3]&&(e[s+3]=0,this._flag=2)}if(2==this._flag){let t=e.length,i=0;for(;i<t;)0!=e[i+3]?i+=4:(e.splice(i,4),t-=4)}this._flag=0}}const x=[];class v{onStartListeningToType(t){}hasListener(t){let e=this._events&&this._events[t];return!!e&&e.count>0}event(t,e){let i=this._events&&this._events[t];if(!i)return!1;let s=i.count>0;if(Array.isArray(e))i.invoke(...e);else if(void 0!==e)i.invoke(e);else if(e===r.EMPTY){let e=x.length>0?x.pop():new r;i.invoke(e.setTo(t,this,this)),e.target=e.currentTarget=null,x.push(e)}else i.invoke();return s}on(t,e,i,s){2==arguments.length&&(i=e,e=null),this._events||(this._events={});let r=this._events[t];return r||(this.onStartListeningToType(t),this._events[t]=r=new T),r.add(i,e,s),this}once(t,e,i,s){2==arguments.length&&(i=e,e=null),this._events||(this._events={});let r=this._events[t];return r||(this.onStartListeningToType(t),this._events[t]=r=new T),r.once(i,e,s),this}off(t,e,i){2==arguments.length&&(i=e,e=null);let s=this._events&&this._events[t];return s&&s.remove(i,e),this}offAll(t){if(null==t)this._events=null;else{let e=this._events&&this._events[t];e&&e.clear()}return this}offAllCaller(t){if(t&&this._events)for(let e in this._events)this._events[e].clearForTarget(t);return this}}var S,E=0,w=0,D=0;class b extends v{static get cpuMemory(){return b._cpuMemory}static get gpuMemory(){return b._gpuMemory}static _addCPUMemory(t){b._cpuMemory+=t}static _addGPUMemory(t){b._gpuMemory+=t}static _addMemory(t,e){b._cpuMemory+=t,b._gpuMemory+=e}static destroyUnusedResources(){w=0,D=0,e.loader.loading?e.timer.frameLoop(1,b,b._destroyUnusedResources):b._destroyUnusedResources(!0)}static _destroyUnusedResources(t){if(!t&&e.loader.loading)return;e.timer.clear(b,b._destroyUnusedResources);let i=0;for(let t in b._idResourcesMap){let e=b._idResourcesMap[t];e.lock||0!==e._referenceCount||(e.destroy(),i++)}b.DEBUG&&i>0&&console.debug(`destroyUnusedResources(${i})`),i>0&&D<5&&(D++,e.timer.frameLoop(1,b,b._destroyUnusedResources))}get id(){return this._id}get cpuMemory(){return this._cpuMemory}get gpuMemory(){return this._gpuMemory}get destroyed(){return this._destroyed}get obsolute(){return this._obsolute}set obsolute(t){this._obsolute!=t&&(this._obsolute=t,t&&!n.isPlaying&&this.event("obsolute"))}get deps(){return this._deps}get referenceCount(){return this._referenceCount}constructor(t){super(),this._cpuMemory=0,this._gpuMemory=0,this._id=0,this._referenceCount=0,this._id=++E,this._destroyed=!1,this._referenceCount=0,(null==t||t)&&(b._idResourcesMap[this._id]=this),this.lock=!1,this.destroyedImmediately=!0,this._deps=[],this._traceDeps=!1}_setCPUMemory(t){var e=t-this._cpuMemory;this._cpuMemory=t,b._addCPUMemory(e)}_setGPUMemory(t){var e=t-this._gpuMemory;this._gpuMemory=t,b._addGPUMemory(e)}_setCreateURL(t,e){this.url=t,this.uuid=e}isCreateFromURL(t){return this.uuid&&t.length===this.uuid.length+6&&t.endsWith(this.uuid)||this.url===t}_addReference(t=1){this._referenceCount+=t}_removeReference(t=1){this._referenceCount-=t,w>0&&this._referenceCount<=0&&!this.lock&&this.destroyedImmediately&&this.destroy()}_clearReference(){this._referenceCount=0}addDep(t){t instanceof b&&(t._addReference(),this._deps.push(t),!n.isPlaying&&t._traceDeps&&t.on("obsolute",this,this.onDepObsolute))}addDeps(t){for(let e of t)e instanceof b&&(e._addReference(),this._deps.push(e),!n.isPlaying&&e._traceDeps&&e.on("obsolute",this,this.onDepObsolute))}onDepObsolute(){this.obsolute=!0}_disposeResource(){}destroy(){if(!this._destroyed){this._destroyed=!0,this.lock=!1,w++,this._disposeResource();for(let t of this._deps)t._removeReference(),!n.isPlaying&&t._traceDeps&&t.off("obsolute",this,this.onDepObsolute);w--,this.offAll(),delete b._idResourcesMap[this.id],this.url&&(b.DEBUG&&console.debug(`destroy ${Object.getPrototypeOf(this).constructor.name} ${this.url}`),e.loader.clearRes(this.url,this))}}}b._idResourcesMap={},b._cpuMemory=0,b._gpuMemory=0,b.DEBUG=!1;class C extends b{get width(){return this._width}set width(t){this._width=t}get height(){return this._height}set height(t){this._height=t}get dimension(){return this._dimension}get format(){return this._format}get mipmap(){return this._texture.mipmap}get mipmapCount(){return this._texture.mipmapCount}get anisoLevel(){return this._texture.anisoLevel}set anisoLevel(t){this._texture.anisoLevel=t}get filterMode(){return this._texture.filterMode}set filterMode(t){this._texture.filterMode=t}get wrapModeU(){return this._texture.wrapU}set wrapModeU(t){this._texture.wrapU=t}get wrapModeV(){return this._texture.wrapV}set wrapModeV(t){this._texture.wrapV=t}get wrapModeW(){return this._texture.wrapW}set wrapModeW(t){this._texture.wrapW=t}get compareMode(){return this._texture.compareMode}set compareMode(t){this._texture.compareMode=l.textureContext.setTextureCompareMode(this._texture,t)}get gammaCorrection(){return this._texture.gammaCorrection}get baseMipmapLevel(){return this._texture.baseMipmapLevel}set baseMipmapLevel(t){this._texture.baseMipmapLevel=t}get maxMipmapLevel(){return this._texture.maxMipmapLevel}set maxMipmapLevel(t){this._texture.maxMipmapLevel=t}get gammaSpace(){return this._texture.useSRGBLoad||this._texture.gammaCorrection>1}constructor(e,i,s){super(),this._gammaSpace=!1,this._width=e,this._height=i,this._format=s,this.destroyedImmediately=f.destroyResourceImmediatelyDefault,this.hdrEncodeFormat=t.HDREncodeFormat.NONE}gpuCompressFormat(){switch(this._format){case t.TextureFormat.R8G8B8:case t.TextureFormat.R8G8B8A8:case t.TextureFormat.R16G16B16:case t.TextureFormat.R16G16B16A16:case t.TextureFormat.R32G32B32:case t.TextureFormat.R32G32B32A32:case t.TextureFormat.R5G6B5:case t.TextureFormat.Alpha8:return!1;case t.TextureFormat.DXT1:case t.TextureFormat.DXT3:case t.TextureFormat.DXT5:case t.TextureFormat.ETC1RGB:case t.TextureFormat.ETC2RGB:case t.TextureFormat.ETC2RGBA:case t.TextureFormat.ETC2SRGB_Alpha8:case t.TextureFormat.ETC2SRGB:case t.TextureFormat.ETC2RGB_Alpha1:case t.TextureFormat.ETC2SRGB_Alpha1:case t.TextureFormat.PVRTCRGB_2BPPV:case t.TextureFormat.PVRTCRGBA_2BPPV:case t.TextureFormat.PVRTCRGB_4BPPV:case t.TextureFormat.PVRTCRGBA_4BPPV:case t.TextureFormat.ASTC4x4:case t.TextureFormat.ASTC4x4SRGB:case t.TextureFormat.ASTC6x6:case t.TextureFormat.ASTC6x6SRGB:case t.TextureFormat.ASTC8x8:case t.TextureFormat.ASTC8x8SRGB:case t.TextureFormat.ASTC10x10:case t.TextureFormat.ASTC10x10SRGB:case t.TextureFormat.ASTC12x12:case t.TextureFormat.ASTC12x12SRGB:return!0;default:return!1}}_getFormatByteCount(){switch(this._format){case t.TextureFormat.R8G8B8:return 3;case t.TextureFormat.R8G8B8A8:return 4;case t.TextureFormat.R5G6B5:case t.TextureFormat.Alpha8:return 1;case t.TextureFormat.R16G16B16A16:return 2;case t.TextureFormat.R32G32B32A32:return 4;default:throw"Texture2D: unknown format."}}_getSource(){return this._texture.resource}get defaultTexture(){throw"defaulte"}_disposeResource(){this._texture.dispose()}}t.DepthTextureMode=void 0,(S=t.DepthTextureMode||(t.DepthTextureMode={}))[S.None=0]="None",S[S.Depth=1]="Depth",S[S.DepthNormals=2]="DepthNormals",S[S.DepthAndDepthNormals=3]="DepthAndDepthNormals",S[S.MotionVectors=4]="MotionVectors";class R extends C{static createFromPool(t,e,i,s,r=!1,a=1,n=!1,l=!1){r=r&&!(t&t-1)&&!(e&e-1);let o=R._pool.length;for(let h=0;h<o;h++){let u=R._pool[h];if(u.width==t&&u.height==e&&u.colorFormat==i&&u.depthStencilFormat==s&&u._generateMipmap==r&&u.multiSamples==a&&u.generateDepthTexture==n&&u._gammaSpace==l){u._inPool=!1;let t=R._pool[o-1];return R._pool[h]=t,R._pool.length-=1,R._poolMemory-=u._renderTarget.gpuMemory/1024/1024,u}}let h=new R(t,e,i,s,r,a,n,l);return h.lock=!0,h}static recoverToPool(t){t._inPool||t.destroyed||(R._pool.push(t),R._poolMemory+=t._renderTarget.gpuMemory/1024/1024,t._inPool=!0)}static clearPool(){if(!(R._poolMemory<_.defaultCacheRTMemory)){for(var t in R._pool)R._pool[t].destroy();R._pool=[],R._poolMemory=0}}static get bindCanvasRender(){return R._bindCanvasRender}static set bindCanvasRender(t){t!=this._bindCanvasRender&&(this._bindCanvasRender=t)}get generateDepthTexture(){return this._generateDepthTexture}set generateDepthTexture(e){this.depthStencilFormat!=t.RenderTargetFormat.None?(e&&!this._depthStencilTexture&&(this._depthStencilTexture=new C(this.width,this.height,this.depthStencilFormat),this._depthStencilTexture._dimension=t.TextureDimension.Tex2D,this._depthStencilTexture._texture=l.textureContext.createRenderTargetDepthTexture(this._renderTarget,t.TextureDimension.Tex2D,this.width,this.height)),this._generateDepthTexture=e):this._generateDepthTexture=!1}get depthStencilTexture(){return this._depthStencilTexture}get colorFormat(){return this._renderTarget.colorFormat}get depthStencilFormat(){return this._renderTarget.depthStencilFormat}get multiSamples(){return this._renderTarget._samples}get isCube(){return this._renderTarget._isCube}get samples(){return this._renderTarget._samples}get generateMipmap(){return this._renderTarget._generateMipmap}constructor(e,i,s,r,a=!1,n=1,l=!1,o=!1){super(e,i,s),this._inPool=!1,this._isCameraTarget=!1,this._generateDepthTexture=!1,this._gammaSpace=o,this._depthStencilFormat=null==r?t.RenderTargetFormat.None:r,this._generateMipmap=a,this._multiSamples=n,this._generateDepthTexture=l,this._createRenderTarget()}_createRenderTarget(){this._dimension=t.TextureDimension.Tex2D,this._renderTarget=l.textureContext.createRenderTargetInternal(this.width,this.height,this._format,this._depthStencilFormat,this._generateMipmap,this._gammaSpace,this._multiSamples),this._generateMipmap=this._renderTarget._generateMipmap,this._renderTarget._texturesResolve?this._texture=this._renderTarget._texturesResolve[0]:this._texture=this._renderTarget._textures[0],this.generateDepthTexture=this._generateDepthTexture}recreate(e,i,s,r,a=!1,n=1,l=!1,o=!1){this._width=e,this._height=i,this._format=s,this._gammaSpace=o,this._depthStencilFormat=null==r?t.RenderTargetFormat.None:r,this._generateMipmap=a,this._multiSamples=n,this._generateDepthTexture=l,this._disposeResource(),this._createRenderTarget()}getData(t,e,i,s,r){return l.textureContext.readRenderTargetPixelData(this._renderTarget,t,e,i,s,r),r}getDataAsync(t,e,i,s,r){return l.textureContext.readRenderTargetPixelDataAsync(this._renderTarget,t,e,i,s,r)}_disposeResource(){var t;this._renderTarget.dispose(),this._renderTarget=null,null===(t=this._depthStencilTexture)||void 0===t||t.destroy(),this._depthStencilTexture=null}}R._pool=[],R._poolMemory=0;class A{static __init__(){var t;let i=window.Laya||e.Laya;if(A._window)return A._window;let s,r=A._window=window,a=A._document=r.document,n=A.userAgent=r.navigator.userAgent,l=r.navigator.maxTouchPoints||0,o=r.navigator.platform;window.conch&&"conchUseWXAdapter"in A.window&&(s=["wxMiniGame","MiniAdpter","wx"]),"my"in A.window&&(n.indexOf("TB/")>-1||n.indexOf("Taobao/")>-1||n.indexOf("TM/")>-1?s=["tbMiniGame","TBMiniAdapter","my"]:n.indexOf("AlipayMiniGame")>-1&&(s=["aliPayMiniGame","ALIMiniAdapter","my"])),(-1==n.indexOf("OPPO")&&n.indexOf("MiniGame")>-1||-1!=n.indexOf("runtime")||-1!=n.indexOf("miniprogram")&&window.isWXMiMi)&&"wx"in A.window&&(s="tt"in A.window?["ttMiniGame","TTMiniAdapter","tt"]:"bl"in A.window?["biliMiniGame","BLMiniAdapter",null]:"qq"in A.window?["qqMiniGame","QQMiniAdapter",null]:["wxMiniGame","MiniAdpter","wx"]),"hbs"in A.window&&(s=["hwMiniGame","HWMiniAdapter",null]),n.indexOf("SwanGame")>-1&&(s=["bdMiniGame","BMiniAdapter",null]),n.indexOf("QuickGame")>-1&&(s=["miMiniGame","KGMiniAdapter","qg"]),n.indexOf("OPPO")>-1&&n.indexOf("MiniGame")>-1&&(s=["qgMiniGame","QGMiniAdapter","qg"],f.fixedFrames=!1),n.indexOf("VVGame")>-1&&(s=["vvMiniGame","VVMiniAdapter","qg"],f.fixedFrames=!1),null!=s&&(A.window[s[0]](i,i),i[s[1]].enable(),A.miniGameContext=A.window[s[2]]),r.trace=console.log,r.requestAnimationFrame=r.requestAnimationFrame||r.webkitRequestAnimationFrame||r.mozRequestAnimationFrame||r.oRequestAnimationFrame||r.msRequestAnimationFrame||function(t){return r.setTimeout(t,1e3/60)};var h=a.body.style;h.margin=0,h.overflow="hidden",h["-webkit-user-select"]="none",h["-webkit-tap-highlight-color"]="rgba(200,200,200,0)";var u=a.getElementsByTagName("meta");let d,c={width:"device-width","initial-scale":"1.0","minimum-scale":"1.0","maximum-scale":"1.0","user-scalable":"no"};for(const t of u)if("viewport"==t.name){d=t;break}if(d){let t=(d.content||"").split(",");for(let e of t){let t=e.split("=");c[t[0].trim()]||(c[t[0]]=t[1])}}else d=a.createElement("meta"),d.name="viewport",null===(t=a.getElementsByTagName("head")[0])||void 0===t||t.appendChild(d);return d.content=Object.keys(c).map((t=>t+"="+c[t])),A.onMobile=!!window.conch||n.indexOf("Mobile")>-1,A.onIOS=!!n.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),A.onIPhone=n.indexOf("iPhone")>-1,A.onMac=n.indexOf("Mac OS X")>-1,A.onIPad=n.indexOf("iPad")>-1||"MacIntel"===o&&l>1,A.onAndroid=n.indexOf("Android")>-1||n.indexOf("Adr")>-1,A.onOpenHarmonyOS=n.indexOf("OpenHarmony")>-1,A.onWP=n.indexOf("Windows Phone")>-1,A.onQQBrowser=n.indexOf("QQBrowser")>-1,A.onMQQBrowser=n.indexOf("MQQBrowser")>-1||n.indexOf("Mobile")>-1&&n.indexOf("QQ")>-1,A.onIE=!!r.ActiveXObject||"ActiveXObject"in r,A.onWeiXin=n.indexOf("MicroMessenger")>-1,A.onSafari=n.indexOf("Safari")>-1&&-1===n.indexOf("Chrome"),A.onChrome=n.indexOf("Chrome")>-1,A.onPC=!A.onMobile,A.onFirefox=n.indexOf("Firefox")>-1,A.onEdge=n.indexOf("Edge")>-1||n.indexOf("Edg")>-1,A.onMiniGame=n.indexOf("MiniGame")>-1,A.onBDMiniGame=n.indexOf("SwanGame")>-1,A.onLayaRuntime=!!window.conch,n.indexOf("OPPO")>-1&&n.indexOf("MiniGame")>-1?(A.onQGMiniGame=!0,A.onMiniGame=!1):"qq"in A.window&&n.indexOf("MiniGame")>-1?(A.onQQMiniGame=!0,A.onMiniGame=!1):"bl"in A.window&&n.indexOf("MiniGame")>-1?(A.onBLMiniGame=!0,A.onMiniGame=!1):"tt"in A.window&&n.indexOf("MiniGame")>-1&&(A.onTTMiniGame=!0,A.onMiniGame=!1),A.onHWMiniGame="hbs"in A.window,A.onVVMiniGame=n.indexOf("VVGame")>-1,A.onKGMiniGame=n.indexOf("QuickGame")>-1,n.indexOf("AlipayMiniGame")>-1&&(A.onAlipayMiniGame=!0,A.onMiniGame=!1),(n.indexOf("TB/")>-1||n.indexOf("Taobao/")>-1||n.indexOf("TM/")>-1)&&(A.onTBMiniGame=!0),(A.onAndroid||A.onIOS)&&(!o||-1==o.indexOf("Win")&&-1==o.indexOf("Mac"))?A.onAndroid?A.platform=A.PLATFORM_ANDROID:A.platform=A.PLATFORM_IOS:A.platform=A.PLATFORM_PC,r}static get _isMiniGame(){return A.onMiniGame||A.onBDMiniGame||A.onQGMiniGame||A.onKGMiniGame||A.onVVMiniGame||A.onAlipayMiniGame||A.onQQMiniGame||A.onBLMiniGame||A.onTTMiniGame||A.onHWMiniGame||A.onTBMiniGame||A.window&&A.window.isWXMiMi}static createElement(t){return A.__init__(),A._document.createElement(t)}static getElementById(t){return A.__init__(),A._document.getElementById(t)}static removeElement(t){t&&t.parentNode&&t.parentNode.removeChild(t)}static now(){return Date.now()}static get clientWidth(){return A.__init__(),A._clientWidth||A._window.innerWidth||A._document.body.clientWidth}static set clientWidth(t){A._clientWidth=t}static get clientHeight(){return A.__init__(),A._clientHeight||A._window.innerHeight||A._document.body.clientHeight||A._document.documentElement.clientHeight}static set clientHeight(t){A._clientHeight=t}static get width(){return A.__init__(),(e.stage&&e.stage.canvasRotation?A.clientHeight:A.clientWidth)*A.pixelRatio}static get height(){return A.__init__(),(e.stage&&e.stage.canvasRotation?A.clientWidth:A.clientHeight)*A.pixelRatio}static get pixelRatio(){return A._pixelRatio<0&&(A.__init__(),A.userAgent.indexOf("Mozilla/6.0(Linux; Android 6.0; HUAWEI NXT-AL10 Build/HUAWEINXT-AL10)")>-1?A._pixelRatio=2:(A._pixelRatio=A._window.devicePixelRatio||1,A._pixelRatio<1&&(A._pixelRatio=1))),A._pixelRatio}static get container(){return A._container||(A.__init__(),A._container=A.createElement("div"),A._container.id="layaContainer",A._document.body.appendChild(A._container)),A._container}static set container(t){A._container=t}static get window(){return A._window||A.__init__()}static get document(){return A.__init__(),A._document}static getQueryString(t){if(A.onMiniGame)return null;if(!window.location||!window.location.search)return null;var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)"),i=window.location.search.substring(1).match(e);return null!=i?unescape(i[2]):null}static getSafariToolbarOffset(){return(A.window.__innerHeight||A.document.body.clientHeight||A.document.documentElement.clientHeight)-A.window.innerHeight}static loadLib(t){return new Promise(((e,i)=>{let s=A.document.createElement("script");s.onload=function(){e()},s.onerror=function(){i(`load ${t} failed`)},s.src=t,A.document.body.appendChild(s)}))}}A.PLATFORM_PC=0,A.PLATFORM_ANDROID=1,A.PLATFORM_IOS=2,A.bundles=new Map,A._pixelRatio=-1,A.mainCanvas=null,A.hanzi=new RegExp("^[一-龥]$"),A.fontMap={},A.measureText=function(t,e){let i=A.hanzi.test(t);if(i&&A.fontMap[e])return A.fontMap[e];let s=A.context;s.font=e;let r=s.measureText(t);return i&&(A.fontMap[e]=r),r};let I=window;I.__getBundle_=function(t){let e=A.bundles.get(t);return e||A.bundles.set(t,e={}),e},I.__setBundle_=function(t,e,i){let s=A.bundles.get(t);s&&function(t,e,i){var s;if(e&&"object"==typeof e||"function"==typeof e)for(let r of Object.getOwnPropertyNames(e))t.hasOwnProperty(r)||r===i||Object.defineProperty(t,r,{get:()=>e[r],enumerable:!(s=Object.getOwnPropertyDescriptor(e,r))||s.enumerable})}(s,e,"default"),A.bundles.set(t,e),i&&(I[i]=e)};var M=1;const B=180/Math.PI,L=Math.PI/180;class P{static toRadian(t){return t*L}static toAngle(t){return t*B}static toHexColor(t){if(t<0||isNaN(t))return null;for(var e=t.toString(16);e.length<6;)e="0"+e;return"#"+e}static fromStringColor(t){if(!t)return 0;if(t.indexOf("rgba(")>=0||t.indexOf("rgb(")>=0){let e=t.indexOf("("),i=t.indexOf(")");if(-1==e||-1==i)return 0;let s=(t=t.substring(e+1,i)).split(","),r=s.length;for(let t=0;t<r;t++)s[t]=parseFloat(s[t]),isNaN(s[t])&&(s[t]=0);return 4==s.length?(s[0]<<24)+(s[1]<<16)+(s[2]<<8)+Math.round(255*s[3]):(s[0]<<16)+(s[1]<<8)+s[2]}{"#"===t.charAt(0)&&(t=t.substring(1));let e=t.length;if(3===e||4===e){let i="";for(let s=0;s<e;s++)i+=t[s]+t[s];t=i}return parseInt(t,16)}}static getGID(){return M++}static copyArray(t,e){if(t||(t=[]),!e)return t;t.length=e.length;var i=e.length;for(let s=0;s<i;s++)t[s]=e[s];return t}static transPointList(t,e,i){var s,r=t.length;for(s=0;s<r;s+=2)t[s]+=e,t[s+1]+=i}static parseInt(t,e=0){var i=parseInt(t,e);return isNaN(i)?0:i}static getBaseName(t){let e=t.lastIndexOf("/");return-1!=e&&(t=t.substring(e+1)),e=t.indexOf("?"),-1!=e&&(t=t.substring(0,e)),t}static getFileExtension(t){let e=t.lastIndexOf(".");if(-1!=e){let i=t.substring(e+1).toLowerCase(),s=i.indexOf("?");if(-1!=s&&(i=i.substring(0,s)),"ls"===i){let s=t.lastIndexOf(".",e-1);if(-1!=s){let r=t.substring(s+1,e+1)+i;if("lanit.ls"===r||"ltcb.ls"===r)return r}}return i}return""}static replaceFileExtension(t,e,i){if(!t)return t;let s=t.lastIndexOf(".");if(e.length>0&&!i&&(e="."+e),-1!=s){let i=t.indexOf("?",s);return-1!=i?t.substring(0,s)+e+t.substring(i):t.substring(0,s)+e}return t+e}static isUUID(t){return t&&t.length>=36&&45===t.charCodeAt(8)&&45===t.charCodeAt(13)}static uint8ArrayToArrayBuffer(e){let i;const s=e.width,r=e.height,a=s*r*4,n=e instanceof R?e.colorFormat:e.getColorFormat();switch(n){case t.RenderTargetFormat.R8G8B8:case t.RenderTargetFormat.R8G8B8A8:i=new Uint8Array(a);break;case t.RenderTargetFormat.R16G16B16A16:i=new Float32Array(a);break;default:throw"this function is not surpprt "+e.format.toString()+"format Material"}if(l.textureContext.readRenderTargetPixelData(e._renderTarget,0,0,e.width,e.height,i),n===t.RenderTargetFormat.R16G16B16A16){const t=i,e=new Uint8Array(a);for(let i=0,s=t.length;i<s;i++)e[i]=Math.min(Math.floor(255*t[i]),255);i=e}const o=i,h=A.createElement("canvas");h.height=r,h.width=s;const u=h.getContext("2d"),d=u.createImageData(s,r);d.data.set(new Uint8ClampedArray(o)),u.putImageData(d,0,0);const c=h.toDataURL();return h.remove(),c}static uint8ArrayToArrayBufferAsync(e){let i;const s=e.width,r=e.height,a=s*r*4,n=e instanceof R?e.colorFormat:e.getColorFormat();switch(n){case t.RenderTargetFormat.R8G8B8:case t.RenderTargetFormat.R8G8B8A8:i=new Uint8Array(a);break;case t.RenderTargetFormat.R16G16B16A16:i=new Float32Array(a);break;default:throw"this function is not surpprt "+e.format.toString()+"format Material"}return e.getDataAsync(0,0,s,r,i).then((()=>{if(n===t.RenderTargetFormat.R16G16B16A16){const t=i,e=new Uint8Array(a);for(let i=0,s=t.length;i<s;i++)e[i]=Math.min(Math.floor(255*t[i]),255);i=e}const e=i,l=A.createElement("canvas");l.height=r,l.width=s;const o=l.getContext("2d"),h=o.createImageData(s,r);h.data.set(new Uint8ClampedArray(e)),o.putImageData(h,0,0);const u=l.toDataURL();return l.remove(),Promise.resolve(u)}))}}class N{constructor(){this.uuidMap={},this.shaderNameMap={},this.metaMap={}}UUID_to_URL(t){return this.uuidMap[t]}UUID_to_URL_async(t){return Promise.resolve(null)}URL_to_UUID_async(t){return Promise.resolve(null)}resolveURL(t,e){if(t.startsWith("res://")){let i=t.substring(6);return N.inst.UUID_to_URL_async(i).then((t=>(e&&e(t),t)))}return e&&e(t),Promise.resolve(t)}shaderName_to_URL(t){return this.shaderNameMap[t]}shaderName_to_URL_async(t){return Promise.resolve(null)}getMeta(t,e){return Promise.resolve(null)}getSubAssetURL(t,e,i,s){return i?`${P.replaceFileExtension(t,"")}@${i}.${s}`:t}}N.inst=new N;class O{static __init__(){null==O.basePath&&(O.basePath=location&&null!=location.protocol&&""!=location.protocol?O.getPath(location.protocol+"//"+location.host+location.pathname):"")}static initMiniGameExtensionOverrides(){n.isPreview||(Object.assign(this.overrideFileExts,this.safeFileExtConversionMap),this.hasExtOverrides=!0,this.usingSafeFileExts=!0)}constructor(t){this._url=O.formatURL(t),this._path=O.getPath(t)}get url(){return this._url}get path(){return this._path}static get rootPath(){return O.basePaths["~/"]}static set rootPath(t){O.basePaths["~/"]=t}static formatURL(t,e){if(!t)return e||O.basePath||"";if(t.startsWith("res://")){let e=t.substring(6),i=N.inst.UUID_to_URL(e);if(!i)return t;t=i}if(-1==t.indexOf(":")&&47!==t.charCodeAt(0)){null!=O.customFormat&&(t=O.customFormat(t));let i=O.version[t];if(null!=i){let e=t.lastIndexOf(".");t=t.substring(0,e)+"-"+i+t.substring(e)}if(null==e){e=O.basePath;for(let i in O.basePaths)if(t.startsWith(i)){126===i.charCodeAt(0)&&(t=t.substring(i.length)),e=O.basePaths[i];break}}t=O.join(e,t)}return t}static postFormatURL(t){if(O.hasExtOverrides){let e=P.getFileExtension(t),i=O.overrideFileExts[e];null!=i&&(t=P.replaceFileExtension(t,i))}return t}static normalize(t){if(-1==t.indexOf("./"))return t;let e=t.split("/"),i=e.length,s=0;for(;s<i;)if("."!=e[s]){if(".."==e[s]){let t=s-1;if(t>=0&&".."!==e[t]){e.splice(t,2),i-=2,s--;continue}}s++}else e.splice(s,1),i--;return e.length=i,e.join("/")}static getResURLByUUID(t){return P.isUUID(t)?"res://"+t:t}static join(t,e){if(!e)return"";if(e.indexOf(":")>0)return e;if(t){let i=e.charCodeAt(0);126!==i&&47!==i&&(e=47!==t.charCodeAt(t.length-1)?t+"/"+e:t+e)}return O.normalize(e)}static getPath(t){var e=t.lastIndexOf("/");return e>0?t.substring(0,e+1):""}static getFileName(t){var e=t.lastIndexOf("/");return e>0?t.substring(e+1):t}static getURLVerion(t){var e=t.indexOf("?");return e>=0?t.substring(e):null}static overrideExtension(t,e,i){if(!i||O.usingSafeFileExts){for(let i of t)O.overrideFileExts[i]=e;O.hasExtOverrides=!0}else for(let i of t)O.safeFileExtConversionMap[i]=e}}O.version={},O.basePaths={},O.overrideFileExts={},O.hasExtOverrides=!1,O.usingSafeFileExts=!1,O.safeFileExtConversionMap={rendertexture:"rt.json",videotexture:"rt.json",controller:"controller.json",mc:"mc.bin",mcc:"mcc.json",shader:"shader.json",fui:"fui.json",glsl:"glsl.txt",skel:"skel.bin",lavm:"lavm.json"},O.customFormat=function(t){return t};class F{constructor(t=0,e=0,i=0,s=0){this.x=t,this.y=e,this.width=i,this.height=s}get right(){return this.x+this.width}get bottom(){return this.y+this.height}setTo(t,e,i,s){return this.x=t,this.y=e,this.width=i,this.height=s,this}reset(){return this.x=this.y=this.width=this.height=0,this}recover(){this!=F.TEMP&&this!=F.EMPTY&&i.recover("Rectangle",this.reset())}static create(){return i.getItemByClass("Rectangle",F)}copyFrom(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this}contains(t,e){return!(this.width<=0||this.height<=0)&&(t>=this.x&&t<this.right&&e>=this.y&&e<this.bottom)}intersects(t){return!(t.x>this.x+this.width||t.x+t.width<this.x||t.y>this.y+this.height||t.y+t.height<this.y)}intersection(t,e=null){return this.intersects(t)?(e||(e=new F),e.x=Math.max(this.x,t.x),e.y=Math.max(this.y,t.y),e.width=Math.min(this.right,t.right)-e.x,e.height=Math.min(this.bottom,t.bottom)-e.y,e):null}union(t,e=null){return e||(e=new F),this.clone(e),t.width<=0||t.height<=0?e:(e.addPoint(t.x,t.y),e.addPoint(t.right,t.bottom),this)}toString(){return this.x+","+this.y+","+this.width+","+this.height}equals(t){return!(!t||t.x!==this.x||t.y!==this.y||t.width!==this.width||t.height!==this.height)}addPoint(t,e){return this.x>t&&(this.width+=this.x-t,this.x=t),this.y>e&&(this.height+=this.y-e,this.y=e),this.width<t-this.x&&(this.width=t-this.x),this.height<e-this.y&&(this.height=e-this.y),this}_getBoundPoints(){return U.length=0,0==this.width||0==this.height||U.push(this.x,this.y,this.x+this.width,this.y,this.x,this.y+this.height,this.x+this.width,this.y+this.height),U}static _getBoundPointS(t,e,i,s,r){return k.length=0,0==i||0==s||(r&&(t*=r.width,e*=r.height,i*=r.width,s*=r.height),k.push(t,e,t+i,e,t,e+s,t+i,e+s)),k}static _getWrapRec(t,e=null){if(!t||t.length<1)return e?e.setTo(0,0,0,0):F.TEMP.setTo(0,0,0,0);e=e||F.create();var i,r,a,n,l,o=t.length,h=s.TEMP;for(a=l=-(r=n=99999),i=0;i<o;i+=2)h.x=t[i],h.y=t[i+1],r=r<h.x?r:h.x,n=n<h.y?n:h.y,a=a>h.x?a:h.x,l=l>h.y?l:h.y;return e.setTo(r,n,a-r,l-n)}isEmpty(){return this.width<=0||this.height<=0}clone(t=null){return t||(t=new F),this.cloneTo(t),t}cloneTo(t){t.x=this.x,t.y=this.y,t.width=this.width,t.height=this.height}}F.EMPTY=new F,F.TEMP=new F;const U=[],k=[];class G{constructor(t=1,e=0,i=0,s=1,r=0,a=0,n=0){if(this._bTransform=!1,null!=G._createFun)return G._createFun(t,e,i,s,r,a,n);this.a=t,this.b=e,this.c=i,this.d=s,this.tx=r,this.ty=a,this._checkTransform()}identity(){return this.a=this.d=1,this.b=this.tx=this.ty=this.c=0,this._bTransform=!1,this}_checkTransform(){return this._bTransform=1!==this.a||0!==this.b||0!==this.c||1!==this.d}setTranslate(t,e){return this.tx=t,this.ty=e,this}translate(t,e){return this.tx+=t,this.ty+=e,this}scale(t,e){return this.a*=t,this.d*=e,this.c*=t,this.b*=e,this.tx*=t,this.ty*=e,this._bTransform=!0,this}rotate(t){var e=Math.cos(t),i=Math.sin(t),s=this.a,r=this.c,a=this.tx;return this.a=s*e-this.b*i,this.b=s*i+this.b*e,this.c=r*e-this.d*i,this.d=r*i+this.d*e,this.tx=a*e-this.ty*i,this.ty=a*i+this.ty*e,this._bTransform=!0,this}skew(t,e){var i=Math.tan(t),s=Math.tan(e),r=this.a,a=this.b;return this.a+=s*this.c,this.b+=s*this.d,this.c+=i*r,this.d+=i*a,this}invertTransformPoint(t){var e=this.a,i=this.b,s=this.c,r=this.d,a=this.tx,n=e*r-i*s,l=r/n,o=-i/n,h=-s/n,u=e/n,d=(s*this.ty-r*a)/n,c=-(e*this.ty-i*a)/n;return t.setTo(l*t.x+h*t.y+d,o*t.x+u*t.y+c)}transformPoint(t){return t.setTo(this.a*t.x+this.c*t.y+this.tx,this.b*t.x+this.d*t.y+this.ty)}transformPointN(t){return t.setTo(this.a*t.x+this.c*t.y,this.b*t.x+this.d*t.y)}getScaleX(){return 0===this.b?this.a:Math.sqrt(this.a*this.a+this.b*this.b)}getScaleY(){return 0===this.c?this.d:Math.sqrt(this.c*this.c+this.d*this.d)}invert(){var t=this.a,e=this.b,i=this.c,s=this.d,r=this.tx,a=t*s-e*i;return this.a=s/a,this.b=-e/a,this.c=-i/a,this.d=t/a,this.tx=(i*this.ty-s*r)/a,this.ty=-(t*this.ty-e*r)/a,this}setTo(t,e,i,s,r,a){return this.a=t,this.b=e,this.c=i,this.d=s,this.tx=r,this.ty=a,this}concat(t){var e=this.a,i=this.c,s=this.tx;return this.a=e*t.a+this.b*t.c,this.b=e*t.b+this.b*t.d,this.c=i*t.a+this.d*t.c,this.d=i*t.b+this.d*t.d,this.tx=s*t.a+this.ty*t.c+t.tx,this.ty=s*t.b+this.ty*t.d+t.ty,this}static mul(t,e,i){var s=t.a,r=t.b,a=t.c,n=t.d,l=t.tx,o=t.ty,h=e.a,u=e.b,d=e.c,c=e.d,_=e.tx,p=e.ty;return 0!==u||0!==d?(i.a=s*h+r*d,i.b=s*u+r*c,i.c=a*h+n*d,i.d=a*u+n*c,i.tx=h*l+d*o+_,i.ty=u*l+c*o+p):(i.a=s*h,i.b=r*c,i.c=a*h,i.d=n*c,i.tx=h*l+_,i.ty=c*o+p),i}static mul16(t,e,i){var s=t.a,r=t.b,a=t.c,n=t.d,l=t.tx,o=t.ty,h=e.a,u=e.b,d=e.c,c=e.d,_=e.tx,p=e.ty;return 0!==u||0!==d?(i[0]=s*h+r*d,i[1]=s*u+r*c,i[4]=a*h+n*d,i[5]=a*u+n*c,i[12]=h*l+d*o+_,i[13]=u*l+c*o+p):(i[0]=s*h,i[1]=r*c,i[4]=a*h,i[5]=n*c,i[12]=h*l+_,i[13]=c*o+p),i}scaleEx(t,e){var i=this.a,s=this.b,r=this.c,a=this.d;0!==s||0!==r?(this.a=t*i,this.b=t*s,this.c=e*r,this.d=e*a):(this.a=t*i,this.b=0*a,this.c=0*i,this.d=e*a),this._bTransform=!0}rotateEx(t){var e=Math.cos(t),i=Math.sin(t),s=this.a,r=this.b,a=this.c,n=this.d;0!==r||0!==a?(this.a=e*s+i*a,this.b=e*r+i*n,this.c=-i*s+e*a,this.d=-i*r+e*n):(this.a=e*s,this.b=i*n,this.c=-i*s,this.d=e*n),this._bTransform=!0}clone(){var t=G.create();return t.a=this.a,t.b=this.b,t.c=this.c,t.d=this.d,t.tx=this.tx,t.ty=this.ty,t._bTransform=this._bTransform,t}copyTo(t){return t.a=this.a,t.b=this.b,t.c=this.c,t.d=this.d,t.tx=this.tx,t.ty=this.ty,t._bTransform=this._bTransform,t}toString(){return this.a+","+this.b+","+this.c+","+this.d+","+this.tx+","+this.ty}destroy(){this.recover()}recover(){i.recover("Matrix",this.identity())}static create(){return i.getItemByClass("Matrix",G)}}G.EMPTY=new G,G.TEMP=new G,G._createFun=null;class V extends Error{constructor(){super("Not implemented.")}}class H extends Error{constructor(t){super(`Index out of range: ${t}`)}}class z extends Error{constructor(){super("readable flag need to be true.")}}class W{static getSystemEndian(){if(!W._sysEndian){var t=new ArrayBuffer(2);new DataView(t).setInt16(0,256,!0),W._sysEndian=256===new Int16Array(t)[0]?W.LITTLE_ENDIAN:W.BIG_ENDIAN}return W._sysEndian}constructor(t=null){this._xd_=!0,this._allocated_=8,this._pos_=0,this._length=0,t?(this._u8d_=new Uint8Array(t),this._d_=new DataView(this._u8d_.buffer),this._length=this._d_.byteLength):this._resizeBuffer(this._allocated_)}get buffer(){var t=this._d_.buffer;return t.byteLength===this._length?t:t.slice(0,this._length)}get endian(){return this._xd_?W.LITTLE_ENDIAN:W.BIG_ENDIAN}set endian(t){this._xd_=t===W.LITTLE_ENDIAN}set length(t){this._allocated_<t?this._resizeBuffer(this._allocated_=Math.floor(Math.max(t,2*this._allocated_))):this._allocated_>t&&this._resizeBuffer(this._allocated_=t),this._length=t}get length(){return this._length}_resizeBuffer(t){try{var e=new Uint8Array(t);null!=this._u8d_&&(this._u8d_.length<=t?e.set(this._u8d_):e.set(this._u8d_.subarray(0,t))),this._u8d_=e,this._d_=new DataView(e.buffer)}catch(e){throw"Invalid typed array length:"+t}}getString(){return this.readString()}readString(){return this._rUTF(this.getUint16())}getFloat32Array(t,e){return this.readFloat32Array(t,e)}readFloat32Array(t,e){var i=t+e;i=i>this._length?this._length:i;var s=new Float32Array(this._d_.buffer.slice(t,i));return this._pos_=i,s}getUint8Array(t,e){return this.readUint8Array(t,e)}readUint8Array(t,e){var i=t+e;i=i>this._length?this._length:i;var s=new Uint8Array(this._d_.buffer.slice(t,i));return this._pos_=i,s}getInt16Array(t,e){return this.readInt16Array(t,e)}readInt16Array(t,e){var i=t+e;i=i>this._length?this._length:i;var s=new Int16Array(this._d_.buffer.slice(t,i));return this._pos_=i,s}getFloat32(){return this.readFloat32()}readFloat32(){if(this._pos_+4>this._length)throw new H(this._pos_+4);var t=this._d_.getFloat32(this._pos_,this._xd_);return this._pos_+=4,t}getFloat64(){return this.readFloat64()}readFloat64(){if(this._pos_+8>this._length)throw new H(this._pos_+8);var t=this._d_.getFloat64(this._pos_,this._xd_);return this._pos_+=8,t}writeFloat32(t){this._ensureWrite(this._pos_+4),this._d_.setFloat32(this._pos_,t,this._xd_),this._pos_+=4}writeFloat64(t){this._ensureWrite(this._pos_+8),this._d_.setFloat64(this._pos_,t,this._xd_),this._pos_+=8}getInt32(){return this.readInt32()}readInt32(){if(this._pos_+4>this._length)throw new H(this._pos_+4);var t=this._d_.getInt32(this._pos_,this._xd_);return this._pos_+=4,t}getUint32(){return this.readUint32()}readUint32(){if(this._pos_+4>this._length)throw new H(this._pos_+4);var t=this._d_.getUint32(this._pos_,this._xd_);return this._pos_+=4,t}writeInt32(t){this._ensureWrite(this._pos_+4),this._d_.setInt32(this._pos_,t,this._xd_),this._pos_+=4}writeUint32(t){this._ensureWrite(this._pos_+4),this._d_.setUint32(this._pos_,t,this._xd_),this._pos_+=4}getInt16(){return this.readInt16()}readInt16(){if(this._pos_+2>this._length)throw new H(this._pos_+2);var t=this._d_.getInt16(this._pos_,this._xd_);return this._pos_+=2,t}getUint16(){return this.readUint16()}readUint16(){if(this._pos_+2>this._length)throw new H(this._pos_+2);var t=this._d_.getUint16(this._pos_,this._xd_);return this._pos_+=2,t}writeUint16(t){this._ensureWrite(this._pos_+2),this._d_.setUint16(this._pos_,t,this._xd_),this._pos_+=2}writeInt16(t){this._ensureWrite(this._pos_+2),this._d_.setInt16(this._pos_,t,this._xd_),this._pos_+=2}getUint8(){return this.readUint8()}readUint8(){if(this._pos_+1>this._length)throw new H(this._pos_+1);return this._u8d_[this._pos_++]}writeUint8(t){this._ensureWrite(this._pos_+1),this._d_.setUint8(this._pos_,t),this._pos_++}_getUInt8(t){return this._readUInt8(t)}_readUInt8(t){return this._d_.getUint8(t)}_getUint16(t){return this._readUint16(t)}_readUint16(t){return this._d_.getUint16(t,this._xd_)}_getMatrix(){return this._readMatrix()}_readMatrix(){return new G(this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32())}_rUTF(t){var e,i,s=this._pos_+t,r=String.fromCharCode,a=this._u8d_,n=[],l=0;for(n.length=1e3;this._pos_<s;)if((e=a[this._pos_++])<128)0!=e&&(n[l++]=r(e));else if(e<224)n[l++]=r((63&e)<<6|127&a[this._pos_++]);else if(e<240)i=a[this._pos_++],n[l++]=r((31&e)<<12|(127&i)<<6|127&a[this._pos_++]);else{const t=(15&e)<<18|(127&(i=a[this._pos_++]))<<12|(127&a[this._pos_++])<<6|127&a[this._pos_++];if(t>=65536){const e=t-65536,i=55296|e>>10,s=56320|1023&e;n[l++]=r(i),n[l++]=r(s)}else n[l++]=r(t)}return n.length=l,n.join("")}getCustomString(t){return this.readCustomString(t)}readCustomString(t){for(var e,i="",s=0,r=String.fromCharCode,a=this._u8d_;t>0;)if((e=a[this._pos_])<128)i+=r(e),this._pos_++,t--;else for(s=e-128,this._pos_++,t-=s;s>0;)e=a[this._pos_++],i+=r(a[this._pos_++]<<8|e),s--;return i}get pos(){return this._pos_}set pos(t){this._pos_=t}get bytesAvailable(){return this._length-this._pos_}clear(){this._pos_=0,this.length=0}__getBuffer(){return this._d_.buffer}writeUTFBytes(t){for(var e=0,i=(t+="").length;e<i;e++){var s=t.charCodeAt(e);if(s<=127)this.writeByte(s);else if(s<=2047)this._ensureWrite(this._pos_+2),this._u8d_.set([192|s>>6,128|63&s],this._pos_),this._pos_+=2;else if(s>=55296&&s<=56319){e++;const i=t.charCodeAt(e);if(!Number.isNaN(i)&&i>=56320&&i<=57343){const t=64+(1023&s),e=1023&i,r=240|t>>8&63,a=128|t>>2&63,n=128|(3&t)<<4|e>>6&15,l=128|63&e;this._ensureWrite(this._pos_+4),this._u8d_.set([r,a,n,l],this._pos_),this._pos_+=4}}else s<=65535?(this._ensureWrite(this._pos_+3),this._u8d_.set([224|s>>12,128|s>>6&63,128|63&s],this._pos_),this._pos_+=3):(this._ensureWrite(this._pos_+4),this._u8d_.set([240|s>>18,128|s>>12&63,128|s>>6&63,128|63&s],this._pos_),this._pos_+=4)}}writeUTFString(t){var e=this.pos;this.writeUint16(1),this.writeUTFBytes(t);var i=this.pos-e-2;this._d_.setUint16(e,i,this._xd_)}writeUTFString32(t){var e=this.pos;this.writeUint32(1),this.writeUTFBytes(t);var i=this.pos-e-4;this._d_.setUint32(e,i,this._xd_)}readUTFString(){return this.readUTFBytes(this.getUint16())}readUTFString32(){return this.readUTFBytes(this.getUint32())}getUTFString(){return this.readUTFString()}readUTFBytes(t=-1){if(0===t)return"";var e=this.bytesAvailable;if(t>e)throw new H(this._pos_+t);return t=t>0?t:e,this._rUTF(t)}getUTFBytes(t=-1){return this.readUTFBytes(t)}writeByte(t){this._ensureWrite(this._pos_+1),this._d_.setInt8(this._pos_,t),this._pos_+=1}readByte(){if(this._pos_+1>this._length)throw new H(this._pos_+1);return this._d_.getInt8(this._pos_++)}getByte(){return this.readByte()}_ensureWrite(t){this._length<t&&(this._length=t),this._allocated_<t&&(this.length=t)}writeArrayBuffer(t,e=0,i=0){if(e<0||i<0)throw new H(e+i);0==i&&(i=t.byteLength-e),this._ensureWrite(this._pos_+i);var s=new Uint8Array(t);this._u8d_.set(s.subarray(e,e+i),this._pos_),this._pos_+=i}readArrayBuffer(t){var e;return e=this._u8d_.buffer.slice(this._pos_,this._pos_+t),this._pos_=this._pos_+t,e}}W.BIG_ENDIAN="bigEndian",W.LITTLE_ENDIAN="littleEndian",W._sysEndian=null;class Y{static __init__(){for(var t=0;t<256;++t){var e=t-127;e<-27?($[0|t]=0,$[256|t]=32768,K[0|t]=24,K[256|t]=24):e<-14?($[0|t]=1024>>-e-14,$[256|t]=1024>>-e-14|32768,K[0|t]=-e-1,K[256|t]=-e-1):e<=15?($[0|t]=e+15<<10,$[256|t]=e+15<<10|32768,K[0|t]=13,K[256|t]=13):e<128?($[0|t]=31744,$[256|t]=64512,K[0|t]=24,K[256|t]=24):($[0|t]=31744,$[256|t]=64512,K[0|t]=13,K[256|t]=13)}for(Q[0]=0,t=1;t<1024;++t){var i=t<<13;for(e=0;!(8388608&i);)e-=8388608,i<<=1;i&=-8388609,e+=947912704,Q[t]=i|e}for(t=1024;t<2048;++t)Q[t]=939524096+(t-1024<<13);for(Z[0]=0,t=1;t<31;++t)Z[t]=t<<23;for(Z[31]=1199570944,Z[32]=2147483648,t=33;t<63;++t)Z[t]=2147483648+(t-32<<23);for(Z[63]=3347054592,J[0]=0,t=1;t<64;++t)J[t]=32===t?0:1024}static roundToFloat16Bits(t){j[0]=t;var e=q[0],i=e>>23&511;return $[i]+((8388607&e)>>K[i])}static convertToNumber(t){var e=t>>10;return q[0]=Q[J[e]+(1023&t)]+Z[e],j[0]}}const X=new ArrayBuffer(4),j=new Float32Array(X),q=new Uint32Array(X),$=new Uint32Array(512),K=new Uint32Array(512),Q=new Uint32Array(2048),Z=new Uint32Array(64),J=new Uint32Array(64);var tt,et;t.FilterMode=void 0,(tt=t.FilterMode||(t.FilterMode={}))[tt.Point=0]="Point",tt[tt.Bilinear=1]="Bilinear",tt[tt.Trilinear=2]="Trilinear",t.RenderCapable=void 0,(et=t.RenderCapable||(t.RenderCapable={}))[et.Element_Index_Uint32=0]="Element_Index_Uint32",et[et.TextureFormat_R32G32B32A32=1]="TextureFormat_R32G32B32A32",et[et.TextureFormat_R16G16B16A16=2]="TextureFormat_R16G16B16A16",et[et.Texture_anisotropic=3]="Texture_anisotropic",et[et.RenderTextureFormat_R16G16B16A16=4]="RenderTextureFormat_R16G16B16A16",et[et.RenderTextureFormat_R32G32B32A32=5]="RenderTextureFormat_R32G32B32A32",et[et.RenderTextureFormat_Depth=6]="RenderTextureFormat_Depth",et[et.RenderTextureFormat_ShadowMap=7]="RenderTextureFormat_ShadowMap",et[et.Vertex_VAO=8]="Vertex_VAO",et[et.DrawElement_Instance=9]="DrawElement_Instance",et[et.Shader_TextureLod=10]="Shader_TextureLod",et[et.COMPRESS_TEXTURE_S3TC=11]="COMPRESS_TEXTURE_S3TC",et[et.COMPRESS_TEXTURE_S3TC_SRGB=12]="COMPRESS_TEXTURE_S3TC_SRGB",et[et.COMPRESS_TEXTURE_PVRTC=13]="COMPRESS_TEXTURE_PVRTC",et[et.COMPRESS_TEXTURE_ETC1=14]="COMPRESS_TEXTURE_ETC1",et[et.COMPRESS_TEXTURE_ETC=15]="COMPRESS_TEXTURE_ETC",et[et.COMPRESS_TEXTURE_ASTC=16]="COMPRESS_TEXTURE_ASTC",et[et.Texture_SRGB=17]="Texture_SRGB",et[et.MSAA=18]="MSAA",et[et.UnifromBufferObject=19]="UnifromBufferObject",et[et.Texture3D=20]="Texture3D",et[et.Texture_FloatLinearFiltering=21]="Texture_FloatLinearFiltering",et[et.Texture_HalfFloatLinearFiltering=22]="Texture_HalfFloatLinearFiltering";const it=827611204,st=861165636,rt=877942852,at=894720068,nt=131072;class lt{constructor(t,e,i,s,r,a,n,l,o,h){this.width=t,this.height=e,this.mipmapCount=i,this.isCube=s,this.blockBytes=a,this.dataOffset=n,this.format=l,this.source=h,this.bpp=r,this.compressed=o}static getDDSTextureInfo(e){let i=new Int32Array(e,0,31),s=i[4],r=i[3],a=1;131072&i[2]&&(a=Math.max(1,i[7]));let n=i[21],o=!(4&~i[20]),h=!(64&~i[20]),u=(i[20]&nt)===nt,d=!(512&~i[28]),c=n===it||n===st||n===at||n===rt,_=t.TextureFormat.DXT1,p=i[1]+4,f=1;switch(n){case it:_=t.TextureFormat.DXT1,f=8;break;case st:_=t.TextureFormat.DXT3,f=16;break;case rt:case at:_=t.TextureFormat.DXT5,f=16;break;case 113:_=t.TextureFormat.R16G16B16A16,f=4;break;case 116:_=t.TextureFormat.R32G32B32A32,f=4;break;default:throw"Unsupported format "+(g=n,String.fromCharCode(255&g,g>>8&255,g>>16&255,g>>24&255))}var g;if(542327876!==i[0])throw"Invalid magic number in DDS header";if(!o&&!h&&!u)throw"Unsupported format, must contain a FourCC, RGB or LUMINANCE code";let m=l.renderEngine.getCapable(t.RenderCapable.COMPRESS_TEXTURE_S3TC)||l.renderEngine.getCapable(t.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB);if(c&&!m)throw"Compressed textures are not supported on this platform.";return new lt(s,r,a,d,0,f,p,_,c,e)}}const ot=6408,ht=6407,ut=5121;class dt{static getLayaFormat(e,i,s,r){if(0!=e){if(e==ot&&32856==i&&s==ut)return{format:t.TextureFormat.R8G8B8A8,sRGB:!1};if(e==ot&&35907==i&&s==ut)return{format:t.TextureFormat.R8G8B8A8,sRGB:!0};if(e==ot&&34836==i&&5126==s)return{format:t.TextureFormat.R32G32B32A32,sRGB:!1};if(e==ot&&34842==i&&5131==s)return{format:t.TextureFormat.R16G16B16A16,sRGB:!1};if(e==ht&&34837==i&&5126==s)return{format:t.TextureFormat.R32G32B32,sRGB:!1};if(e==ht&&34843==i&&5131==s)return{format:t.TextureFormat.R16G16B16,sRGB:!1};if(e==ht&&35905==i&&s==ut)return{format:t.TextureFormat.R8G8B8,sRGB:!0};if(e==ht&&32849==i&&s==ut)return{format:t.TextureFormat.R8G8B8,sRGB:!1};throw"ktx: Unsupported UnCompressed image data."}switch(i){case 36196:return{format:t.TextureFormat.ETC1RGB,sRGB:!1};case 37496:return{format:t.TextureFormat.ETC2RGBA,sRGB:!1};case 37492:return{format:t.TextureFormat.ETC2RGB,sRGB:!1};case 37497:return{format:t.TextureFormat.ETC2SRGB_Alpha8,sRGB:!0};case 37493:return{format:t.TextureFormat.ETC2SRGB,sRGB:!0};case 37494:return{format:t.TextureFormat.ETC2RGB_Alpha1,sRGB:!1};case 37495:return{format:t.TextureFormat.ETC2SRGB_Alpha1,sRGB:!0};case 37808:return{format:t.TextureFormat.ASTC4x4,sRGB:!1};case 37812:return{format:t.TextureFormat.ASTC6x6,sRGB:!1};case 37815:return{format:t.TextureFormat.ASTC8x8,sRGB:!1};case 37819:return{format:t.TextureFormat.ASTC10x10,sRGB:!1};case 37821:return{format:t.TextureFormat.ASTC12x12,sRGB:!1};case 37840:return{format:t.TextureFormat.ASTC4x4SRGB,sRGB:!0};case 37844:return{format:t.TextureFormat.ASTC6x6SRGB,sRGB:!0};case 37847:return{format:t.TextureFormat.ASTC8x8SRGB,sRGB:!0};case 37851:return{format:t.TextureFormat.ASTC10x10SRGB,sRGB:!0};case 37853:return{format:t.TextureFormat.ASTC12x12SRGB,sRGB:!0};default:throw"KTX: UnSupported Compressed format."}}static getKTXTextureInfo(t){let e=new Uint8Array(t,0,12);if(171===e[0]&&75===e[1]&&84===e[2]&&88===e[3]&&32===e[4]&&50===e[5]&&48===e[6]&&187===e[7]&&13===e[8]&&10===e[9]&&26===e[10]&&10===e[11])throw"ktx2 !";if(171===e[0]&&75===e[1]&&84===e[2]&&88===e[3]&&32===e[4]&&49===e[5]&&49===e[6]&&187===e[7]&&13===e[8]&&10===e[9]&&26===e[10]&&10===e[11])return dt.createKTX1Info(t);throw"ktx data wrong, not ktx1 or ktx2 buffer!"}static createKTX1Info(e){let i=Uint32Array.BYTES_PER_ELEMENT,s=new DataView(e,12,13*i),r=67305985==s.getUint32(0,!0),a=s.getUint32(1*i,r),n=s.getUint32(2*i,r),l=s.getUint32(3*i,r),o=s.getUint32(4*i,r);s.getUint32(5*i,r);let h=s.getUint32(6*i,r),u=s.getUint32(7*i,r);s.getUint32(8*i,r);let d=s.getUint32(9*i,r),c=s.getUint32(10*i,r),_=s.getUint32(11*i,r),p=s.getUint32(12*i,r),f=dt.getLayaFormat(l,o,a,n),g=f.format,m=f.sRGB,y=t.TextureDimension.Tex2D;c>1&&d>1?y=t.TextureDimension.CubeArray:c>1&&d<=1?y=t.TextureDimension.Cube:c<=1&&d>1&&(y=t.TextureDimension.Texture2DArray);return new dt(e,0==l,m,y,h,u,g,_||1,p,64)}constructor(t,e,i,s,r,a,n,l,o,h){this.source=t,this.compress=e,this.sRGB=i,this.dimension=s,this.width=r,this.height=a,this.format=n,this.mipmapCount=l,this.bytesOfKeyValueData=o,this.headerOffset=h}}class ct extends C{static __init__(){var e=new Uint8Array(4);if(e[0]=128,e[1]=128,e[2]=128,e[3]=255,ct.grayTexture=new ct(1,1,t.TextureFormat.R8G8B8A8,!1,!1),ct.grayTexture.setPixelsData(e,!1,!1),ct.grayTexture.lock=!0,ct.grayTexture.name="Default_Gray",e[0]=255,e[1]=255,e[2]=255,e[3]=255,ct.whiteTexture=new ct(1,1,t.TextureFormat.R8G8B8A8,!1,!1),ct.whiteTexture.setPixelsData(e,!1,!1),ct.whiteTexture.lock=!0,ct.whiteTexture.name="Default_White",e[0]=0,e[1]=0,e[2]=0,e[3]=255,ct.blackTexture=new ct(1,1,t.TextureFormat.R8G8B8A8,!1,!1),ct.blackTexture.setPixelsData(e,!1,!1),ct.blackTexture.lock=!0,ct.blackTexture.name="Default_Black",l.renderEngine.getCapable(t.RenderCapable.TextureFormat_R16G16B16A16)){let e=new Uint16Array(4);e[0]=14336,e[1]=14336,e[2]=15360,e[3]=15360,ct.normalTexture=new ct(1,1,t.TextureFormat.R16G16B16A16,!1,!1,!1),ct.normalTexture.setPixelsData(e,!1,!1)}else e[0]=128,e[1]=128,e[2]=255,e[3]=255,ct.normalTexture=new ct(1,1,t.TextureFormat.R8G8B8A8,!1,!1,!1),ct.normalTexture.setPixelsData(e,!1,!1);ct.normalTexture.lock=!0,ct.normalTexture.name="Default_Normal",ct.errorTexture=ct.whiteTexture}static _SimpleAnimatorTextureParse(e,i=null,s=null){var r,a,n=new W(e);switch(n.readUTFString()){case"LAYAANIMATORTEXTURE:0000":var o,h=n.readInt32(),u=n.readInt32();r=new Float32Array(h*h*4),a=new Float32Array(n.readArrayBuffer(4*u)),r.set(a,0),(o=new ct(h,h,t.TextureFormat.R32G32B32A32,!1,!1)).setPixelsData(r,!1,!1),o.filterMode=t.FilterMode.Point;break;case"LAYACOMPRESSANIMATORTEXTURE:0000":h=n.readInt32(),u=n.readInt32();if(r=new Uint16Array(n.readArrayBuffer(2*u)),l.renderEngine.getCapable(t.RenderCapable.TextureFormat_R16G16B16A16))(a=new Uint16Array(h*h*4)).set(r,0),(o=new ct(h,h,t.TextureFormat.R16G16B16A16,!1,!1)).setPixelsData(a,!1,!1),o.filterMode=t.FilterMode.Point;else{console.log("The platform does not support 16-bit floating-point textures"),l.renderEngine.getCapable(t.RenderCapable.TextureFormat_R32G32B32A32)||console.error("The platform does not support 32-bit floating-point textures"),a=new Float32Array(h*h*4);for(var d=0,c=r.length;d<c;d++)a[d]=Y.convertToNumber(r[d]);(o=new ct(h,h,t.TextureFormat.R32G32B32A32,!1,!1)).setPixelsData(a,!1,!1),o.filterMode=t.FilterMode.Point}break;default:throw"Laya3D:unknow version."}return o}static _parseImage(i,s=null,r=null){let a=r?r[2]:t.TextureFormat.R8G8B8A8,l=!r||r[3],o=!!r&&r[4],h=!!r&&r[5],u=!!s&&s.premultiplyAlpha,d=new ct(i.width,i.height,a,l,o,h,u);return s?(d.setImageData(i,u,!1),d.setProperties(s)):d.setImageData(i,!1,!1),o&&(n.isConch&&i._nativeObj?d._pixels=new Uint8Array(i._nativeObj.getImageData(0,0,i.width,i.height)):(e.Browser.canvas.size(i.width,i.height),e.Browser.canvas.clear(),e.Browser.context.drawImage(i,0,0,i.width,i.height),d._pixels=new Uint8Array(e.Browser.context.getImageData(0,0,i.width,i.height).data.buffer))),d}static _parseDDS(t,e=null,i=null){let s=lt.getDDSTextureInfo(t),r=i[5],a=new ct(s.width,s.height,s.format,s.mipmapCount>1,!1,r);return a.setDDSData(s),e&&a.setProperties(e),a}static _parseKTX(t,e=null,i=null){let s=dt.getKTXTextureInfo(t),r=new ct(s.width,s.height,s.format,s.mipmapCount>1,!1,s.sRGB);return r.setKTXData(s),e&&r.setProperties(e),r}static _parsePVR(t,e=null,i=null){throw"pvr !"}static load(t,i){e.loader.load(t,i,null,e.Loader.TEXTURE2D)}constructor(e,i,s,r=!0,a,n=!1,o=!1){super(e,i,s),this._canRead=!1,this._dimension=t.TextureDimension.Tex2D,this._gammaSpace=n,this._canRead=a,this._texture=l.textureContext.createTextureInternal(this._dimension,e,i,s,r,n,o)}setImageData(t,e,i){let s=this._texture;l.textureContext.setTextureImageData(s,t,e,i)}setPixelsData(t,e,i){let s=this._texture;l.textureContext.setTexturePixelsData(s,t,e,i)}setSubPixelsData(t,e,i,s,r,a,n,o,h){let u=this._texture;l.textureContext.setTextureSubPixelsData(u,r,a,n,t,e,i,s,o,h)}setDDSData(t){let e=this._texture;l.textureContext.setTextureDDSData(e,t)}setKTXData(t){let e=this._texture;l.textureContext.setTextureKTXData(e,t)}setHDRData(t){let e=this._texture;l.textureContext.setTextureHDRData(e,t)}get defaultTexture(){return ct.grayTexture}getPixels(){if(this._canRead&&this._pixels)return this._pixels;throw new Error("Texture2D: must set texture canRead is true.")}setProperties(t){t&&(null!=t.wrapModeU&&(this.wrapModeU=t.wrapModeU),null!=t.wrapModeV&&(this.wrapModeV=t.wrapModeV),null!=t.filterMode&&(this.filterMode=t.filterMode),null!=t.anisoLevel&&(this.anisoLevel=t.anisoLevel))}}ct.TEXTURE2D="TEXTURE2D",ct.grayTexture=null,ct.whiteTexture=null,ct.blackTexture=null,ct.normalTexture=null,ct.errorTexture=null;class _t{static gammaToLinearSpace(t){return t<=.04045?t/12.92:t<1?Math.pow((t+.055)/1.055,2.4):Math.pow(t,2.4)}static linearToGammaSpace(t){return t<=0?0:t<=.0031308?12.92*t:t<=1?1.055*Math.pow(t,.41666)-.055:Math.pow(t,.41666)}constructor(t=1,e=1,i=1,s=1){this.r=t,this.g=e,this.b=i,this.a=s}equal(t){if(!t)return!1;const e=(t,e)=>{var i=1e-5;return-i<t-e&&t-e<i};return e(t.r,this.r)&&e(t.g,this.g)&&e(t.b,this.b)&&e(t.a,this.a)}toLinear(t){t.r=_t.gammaToLinearSpace(this.r),t.g=_t.gammaToLinearSpace(this.g),t.b=_t.gammaToLinearSpace(this.b),t.a=this.a}toGamma(t){t.r=_t.linearToGammaSpace(this.r),t.g=_t.linearToGammaSpace(this.g),t.b=_t.linearToGammaSpace(this.b),t.a=this.a}cloneTo(t){t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a}scale(t){return this.r=this.r*t,this.g=this.g*t,this.b=this.b*t,this}setValue(t,e,i,s){this.r=t,this.g=e,this.b=i,this.a=s}fromArray(t,e=0){this.r=t[e+0],this.g=t[e+1],this.b=t[e+2],this.a=t[e+3]}toArray(){return[this.r,this.g,this.b,this.a]}clone(){var t=new _t;return this.cloneTo(t),t}}_t.RED=new _t(1,0,0,1),_t.GREEN=new _t(0,1,0,1),_t.BLUE=new _t(0,0,1,1),_t.CYAN=new _t(0,1,1,1),_t.YELLOW=new _t(1,.92,.016,1),_t.MAGENTA=new _t(1,0,1,1),_t.GRAY=new _t(.5,.5,.5,1),_t.WHITE=new _t(1,1,1,1),_t.BLACK=new _t(0,0,0,1),_t.CLEAR=new _t(0,0,0,0);class pt extends C{static get currentActive(){return pt._currentActive}get depthStencilFormat(){return this._depthStencilFormat}get defaultTexture(){return ct.grayTexture}getIsReady(){return!0}getColorFormat(){return this._colorFormat}get sourceWidth(){return this._width}get sourceHeight(){return this._height}get offsetX(){return 0}get offsetY(){return 0}constructor(e,i,s=t.RenderTargetFormat.R8G8B8,r=t.RenderTargetFormat.None){super(e,i,s),this._mgrKey=0,this._invertY=!1,this._colorFormat=s,this._depthStencilFormat=r,0!=e&&0!=i&&this._create(),this.lock=!0}get isCube(){return this._renderTarget._isCube}get samples(){return this._renderTarget._samples}get generateMipmap(){return this._renderTarget._generateMipmap}_start(){throw new V}_end(){throw new V}_create(){this._renderTarget=l.textureContext.createRenderTargetInternal(this.width,this.height,this._colorFormat,this.depthStencilFormat,!1,!1,1),this._texture=this._renderTarget._textures[0],this._texture.gammaCorrection=2.2}clear(t=0,e=0,i=0,s=1){pt._clearColor.r=t,pt._clearColor.g=e,pt._clearColor.b=i,pt._clearColor.a=s,pt._clear=!0}getData(t,e,i,s){return l.textureContext.getRenderTextureData(this._renderTarget,t,e,i,s)}getDataAsync(t,e,i,s,r){return l.textureContext.readRenderTargetPixelDataAsync(this._renderTarget,t,e,i,s,r)}recycle(){}_disposeResource(){this._renderTarget&&this._renderTarget.dispose()}}pt._clearColor=new _t(0,0,0,0),pt._clear=!1,pt._clearLinearColor=new _t,pt.defuv=[0,0,1,0,1,1,0,1],pt.flipyuv=[0,1,1,1,1,0,0,0];const ft=new F,gt=new F;class mt extends b{static create(t,e,i,s,r,a=0,n=0,l=0,o=0){return mt._create(t,e,i,s,r,a,n,l,o)}static _create(t,e,i,s,r,a=0,n=0,l=0,o=0,h=null){var u,d=t instanceof mt,c=d?t.uv:mt.DEF_UV,_=d?t.bitmap:t;_.width&&e+s>_.width&&(s=_.width-e),_.height&&i+r>_.height&&(r=_.height-i),h?(u=h).setTo(_,null,l||s,o||r):u=new mt(_,null,l||s,o||r),u.width=s,u.height=r,u.offsetX=a,u.offsetY=n;var p=1/_.width,f=1/_.height;e*=p,i*=f,s*=p,r*=f;var g=u.uv[0],m=u.uv[1],y=u.uv[4],T=u.uv[5],x=y-g,v=T-m,S=function(t,e,i){for(var s=0;s<8;s+=2)i[s]+=t,i[s+1]+=e;return i}(c[0],c[1],[e,i,e+s,i,e+s,i+r,e,i+r]);u.uv=new Float32Array([g+S[0]*x,m+S[1]*v,y-(1-S[2])*x,m+S[3]*v,y-(1-S[4])*x,T-(1-S[5])*v,g+S[6]*x,T-(1-S[7])*v]);var E=t.scaleRate;return E&&1!=E?(u.sourceWidth/=E,u.sourceHeight/=E,u.width/=E,u.height/=E,u.scaleRate=E,u.offsetX/=E,u.offsetY/=E):u.scaleRate=1,u}static createFromTexture(t,e,i,s,r){var a=t.scaleRate;1!=a&&(e*=a,i*=a,s*=a,r*=a);var n=F.TEMP.setTo(e-t.offsetX,i-t.offsetY,s,r),l=n.intersection(ft.setTo(0,0,t.width,t.height),gt);return l?mt.create(t,l.x,l.y,l.width,l.height,l.x-n.x,l.y-n.y,s,r):null}get uv(){return this._uv}set uv(t){this.uvrect[0]=Math.min(t[0],t[2],t[4],t[6]),this.uvrect[1]=Math.min(t[1],t[3],t[5],t[7]),this.uvrect[2]=Math.max(t[0],t[2],t[4],t[6])-this.uvrect[0],this.uvrect[3]=Math.max(t[1],t[3],t[5],t[7])-this.uvrect[1],this._uv=t}get width(){return this._w?this._w:this.bitmap?this.uv&&this.uv!==mt.DEF_UV?(this.uv[2]-this.uv[0])*this.bitmap.width:this.bitmap.width:0}set width(t){this._w=t,this.sourceWidth||(this.sourceWidth=t)}get height(){return this._h?this._h:this.bitmap?this.uv&&this.uv!==mt.DEF_UV?(this.uv[5]-this.uv[1])*this.bitmap.height:this.bitmap.height:0}set height(t){this._h=t,this.sourceHeight||(this.sourceHeight=t)}get bitmap(){return this._bitmap}set bitmap(t){this._bitmap!=t&&(this._bitmap&&this._bitmap._removeReference(this._referenceCount),this._bitmap=t,t&&t._addReference(this._referenceCount))}constructor(t=null,e=null,i=0,s=0){super(!1),this.uvrect=[0,0,1,1],this._w=0,this._h=0,this.offsetX=0,this.offsetY=0,this.sourceWidth=0,this.sourceHeight=0,this.scaleRate=1;let r=t instanceof mt?t.bitmap:t;this.setTo(r,e,i,s)}_addReference(t=1){super._addReference(t),this._bitmap&&this._bitmap._addReference(t)}_removeReference(t=1){this._bitmap&&this._bitmap._removeReference(t),super._removeReference(t)}_getSource(t=null){return this._destroyed||!this._bitmap?null:(this.recoverBitmap(t),this._bitmap.destroyed?null:this.bitmap._getSource())}setTo(t=null,e=null,i=0,s=0){this.bitmap=t,this.sourceWidth=i,this.sourceHeight=s,t&&(this._w=t.width,this._h=t.height,this.sourceWidth=this.sourceWidth||t.width,this.sourceHeight=this.sourceHeight||t.height),this.uv=e||mt.DEF_UV}load(t,i){return this._destroyed?Promise.resolve():e.loader.load(t).then((t=>{let e=t.bitmap;this.bitmap=e,this.sourceWidth=this._w=e.width,this.sourceHeight=this._h=e.height,i&&i.run(),this.event(r.READY,this)}))}getTexturePixels(i,s,r,a){var n,l,o,h=this.bitmap,u=this._w,d=this._h,c=this.sourceWidth,_=this.sourceHeight,p=h.width,f=h.height,g=this.offsetX,m=this.offsetY;let y=r,T=a;if(i+r>u+g&&(y-=i+r-u-g),i+r>c&&(r-=i+r-c),s+a>d+m&&(T-=s+a-d-m),s+a>_&&(a-=s+a-_),r<=0||a<=0)return null;let x=g>i?g-i:0,v=m>s?m-s:0,S=i>g?i-g:0,E=s>m?s-m:0;y-=x,T-=v;var w=4*r,D=null;try{D=h.getPixels()}catch(t){}if(D){if(0==i&&0==s&&r==p&&a==f)return D;let t=this._uv.slice(),e=Math.round(t[0]*p),h=Math.round(t[1]*f);var b=new Uint8Array(r*a*4);for(n=4*e+4*S+(l=(h+E)*(w=4*p)),o=0;o<T;o++)b.set(D.slice(n,n+4*y),4*r*(o+v)+4*x),n+=w;return b}var C=new e.Context;C.size(r,a);let R=new pt(r,a,t.RenderTargetFormat.R8G8B8A8);C.render2D=C.render2D.clone(R);var A=null;if(0!=i||0!=s||r!=p||a!=f){var I=(A=this._uv.slice())[0],M=A[1],B=(A[2]-I)/u,L=(A[7]-M)/d;A=[I+S*B,M+E*L,I+(S+y)*B,M+E*L,I+(S+y)*B,M+(E+T)*L,I+S*B,M+(E+T)*L]}C.startRender(),C._drawTextureM(this,x,v,y,T,null,1,A,4294967295),C.endRender();var P=R.getData(0,0,r,a);for(C.destroy(),R.destroy(),b=new Uint8Array(r*a*4),n=0,l=(a-1)*w,o=a-1;o>=0;o--)b.set(P.slice(l,l+w),n),n+=w,l-=w;return b}getPixels(t,e,i,s){return this.getTexturePixels(t,e,i,s)}recoverBitmap(t){var i=this._bitmap.url;this._destroyed||this._bitmap&&!this._bitmap.destroyed||!i||e.loader.load(i).then((e=>{this.bitmap=e.bitmap,t&&t()}))}disposeBitmap(){!this._destroyed&&this._bitmap&&this._bitmap.destroy()}get valid(){return!this._destroyed&&this._bitmap&&!this._bitmap.destroyed}get obsolute(){return this._obsolute||!this._bitmap||this._bitmap.destroyed||this._bitmap.obsolute}set obsolute(t){this._obsolute=t}_disposeResource(){let t=this._bitmap;this._bitmap=null,t&&t._removeReference(this._referenceCount)}getCachedClip(t,e,i,s){let r=`${t}_${e}_${i}_${s}`;this._clipCache||(this._clipCache=new Map);let a=this._clipCache.get(r);return a||(a=mt.createFromTexture(this,t,e,i,s),a&&(a._sizeGrid=this._sizeGrid),this._clipCache.size>100&&this._clipCache.clear(),this._clipCache.set(r,a),a)}}mt.DEF_UV=new Float32Array([0,0,1,0,1,1,0,1]),mt.NO_UV=new Float32Array([0,0,0,0,0,0,0,0]),mt.INV_UV=new Float32Array([0,1,1,1,1,0,0,0]);class yt{static enable(t,i=null){e.loader.fetch(t,"json").then((t=>{t&&(yt.addAtlases(t),i&&i.run())}))}static addAtlases(t){let e=yt._fileLoadDic;for(let i in t){let s=t[i],r=O.formatURL(s[0]),a=s[1],n=a.length,l={url:i};for(let t=0;t<n;t++)e[r+a[t]]=l}}static addAtlas(t,e,i){e=O.formatURL(e);let s=yt._fileLoadDic,r={url:t};for(let t of i)s[e+t]=r}static getFileLoadPath(t){return yt._fileLoadDic[t]}}yt._fileLoadDic={};class Tt{static workerSupported(){return!!Worker}static set enable(t){if(Tt._enable!=t){if(t){if(!Worker)return;Tt._worker||(Tt._worker=new Worker(g.workerLoaderLib||Tt.workerPath),Tt._worker.onmessage=Tt.workerMessage,Tt._dispatcher=new v)}Tt._enable=t}}static get enable(){return Tt._enable}static load(t,e){return new Promise((i=>{Tt._worker.postMessage({url:t,options:e}),Tt._dispatcher.once(t,i)}))}static workerMessage(t){let e=t.data;if(e)switch(e.type){case"Image":Tt._dispatcher.event(e.url,e.imageBitmap);break;case"Disable":Tt.enable=!1}}}Tt.workerPath="libs/laya.workerloader.js",Tt._enable=!1;class xt extends b{constructor(t,e,i){super(),this.dir=t,this.textures=e,this.frames=i,this.lock=!0}_disposeResource(){for(let t of this.textures)t&&t.destroy();for(let t of this.frames)t.destroy();this.frames.length=0,this.textures.length=0}}class vt{constructor(t){this._callback=t,this._items=[],this._weights=[],this._progress=0}get itemCount(){return this._items.length}reset(){this._items.length=0,this._weights.length=0,this._progress=0}createCallback(t){let e=this._items.length;return this._items.push(0),null==t?this._weights.push(null):this._weights.push(Math.max(0,Math.min(t,1))),t=>this.update(e,t)}update(t,e){if(-1!=t){this._items[t]=Math.max(0,Math.min(e,1));let i=0,s=this._items,r=this._weights,a=1/s.length;for(let t=0;t<s.length;t++){let e=s[t],n=r[t];null!=e&&(i+=e*(null!=n?n:a))}(e=i)>1&&(e=1)}e>this._progress&&(this._progress=e,this._callback(e))}}class St{constructor(t=null,e=null,i=null,s=!1){this.once=!1,this._id=0,this.setTo(t,e,i,s)}setTo(t,e,i,s=!1){return this._id=St._gid++,this.caller=t,this.method=e,this.args=i,this.once=s,this}run(){if(null==this.method)return null;var t=this._id,e=this.method.apply(this.caller,this.args);return this._id===t&&this.once&&this.recover(),e}runWith(t){if(null==this.method)return null;var e=this._id;if(null==t)var i=this.method.apply(this.caller,this.args);else i=this.args||t.unshift?this.args?this.method.apply(this.caller,this.args.concat(t)):this.method.apply(this.caller,t):this.method.call(this.caller,t);return this._id===e&&this.once&&this.recover(),i}clear(){return this.caller=null,this.method=null,this.args=null,this}recover(){this._id>0&&(this._id=0,St._pool.push(this.clear()))}static create(t,e,i=null,s=!0){return St._pool.length?St._pool.pop().setTo(t,e,i,s):new St(t,e,i,s)}}St._pool=[],St._gid=1;class Et{static compareVersion(t,e){let i=t.split("."),s=e.split(".");const r=Math.max(i.length,s.length);for(;i.length<r;)i.push("0");for(;s.length<r;)s.push("0");for(let t=0;t<r;t++){const e=parseInt(i[t]),r=parseInt(s[t]);if(e>r)return!0;if(e<r)return!1}return!0}static get isSupport(){if(A._isMiniGame){var t=A.window.wx.getSystemInfoSync().SDKVersion;return Et.compareVersion(t,"2.14.0")}return!!A.onLayaRuntime||!!A.window.Blob&&!!A.window.Blob}static arrayBufferToURL(t,e){if(!Et.isSupport)return t;if(Et.data[t])return Et.data[t];var i="";if(A._isMiniGame||A.onLayaRuntime)i=A.window.wx.createBufferURL(e);else if(A.window.Blob){let t=new Blob([e],{type:"application/octet-binary"});i=A.window.URL.createObjectURL(t)}return Et.isSavaData&&(Et.data[t]=i),i}static _arrayBufferToURL(t){if(!Et.isSupport)return null;var e="";if(A._isMiniGame||A.onLayaRuntime)e=A.window.wx.createBufferURL(t);else if(A.window.Blob){let i=new Blob([t],{type:"application/octet-binary"});e=A.window.URL.createObjectURL(i)}return e}static destroy(t){if(Et.isSupport){var e=Et.data[t];e&&(A._isMiniGame||A.onLayaRuntime?A.window.wx.revokeBufferURL(e):A.window.Blob&&A.window.URL.revokeObjectURL(e),delete Et.data[t])}}}Et.data={},Et.isSavaData=!1;class wt{static decodeString(t){let e=t.length,i="",s=0,r=0;for(;;){if(r=t.indexOf("&",s),-1==r){i+=t.substring(s);break}i+=t.substring(s,r),s=r+1,r=s;let a=Math.min(e,r+10);for(;r<a&&";"!=t[r];r++);if(r<a&&r>s){let e=t.substring(s,r),a=0;if("#"==e[0])e.length>1?(a="x"==e[1]?parseInt(e.substring(2),16):parseInt(e.substring(1)),i+=String.fromCharCode(a),s=r+1):i+="&";else{switch(e){case"amp":a=38;break;case"apos":a=39;break;case"gt":a=62;break;case"lt":a=60;break;case"nbsp":a=32;break;case"quot":a=34}a>0?(i+=String.fromCharCode(a),s=r+1):i+="&"}}else i+="&"}return i}static encodeString(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&apos;").replace(/"/g,"&quot;")}static getString(t,e,i){if(null==t)return null==i?null:i;let s=t[e];return null!=s?""+s:null==i?null:i}static getInt(t,e,i){let s=this.getString(t,e);if(null!=s&&s.length>0)if("%"==s[s.length-1]){let t=parseInt(s.substring(0,s.length-1));if(!isNaN(t))return Math.ceil(t/100*i)}else{let t=parseInt(s);if(!isNaN(t))return t}return null==i?0:i}static getFloat(t,e,i){let s=this.getString(t,e);if(null==s||0==s.length)return null==i?0:i;let r=parseFloat(s);return isNaN(r)?null==i?0:i:r}static getBool(t,e,i){let s=this.getString(t,e);return null==s||0==s.length?null!=i&&i:"true"==s||"1"==s||"false"!=s&&"0"!=s&&(null!=i&&i)}}var Dt;t.XMLTagType=void 0,(Dt=t.XMLTagType||(t.XMLTagType={}))[Dt.Start=0]="Start",Dt[Dt.End=1]="End",Dt[Dt.Void=2]="Void",Dt[Dt.CDATA=3]="CDATA",Dt[Dt.Comment=4]="Comment",Dt[Dt.Instruction=5]="Instruction";class bt{static begin(t,e){bt.source=t,bt.lowerCaseName=e,this.sourceLen=t.length,this.parsePos=0,this.lastTagEnd=0,this.tagPos=0,this.tagLength=0,this.tagName=null}static nextTag(){let e,i,s="";for(this.tagType=t.XMLTagType.Start,this.lastTagEnd=this.parsePos,this.attrParsed=!1,this.lastTagName=this.tagName;-1!=(e=this.source.indexOf("<",this.parsePos))&&(this.parsePos=e,e++,e!=this.sourceLen);){if(i=this.source[e],"!"==i){if(this.sourceLen>e+7&&"<![CDATA["==this.source.substring(e-1,e+8))return e=this.source.indexOf("]]>",e),this.tagType=t.XMLTagType.CDATA,this.tagName="",this.tagPos=this.parsePos,this.tagLength=-1==e?this.sourceLen-this.parsePos:e+3-this.parsePos,this.parsePos+=this.tagLength,!0;if(this.sourceLen>e+2&&"\x3c!--"==this.source.substring(e-1,e+3))return e=this.source.indexOf("--\x3e",e),this.tagType=t.XMLTagType.Comment,this.tagName="",this.tagPos=this.parsePos,this.tagLength=-1==e?this.sourceLen-this.parsePos:e+3-this.parsePos,this.parsePos+=this.tagLength,!0;e++,this.tagType=t.XMLTagType.Instruction}else"/"==i?(e++,this.tagType=t.XMLTagType.End):"?"==i&&(e++,this.tagType=t.XMLTagType.Instruction);for(;e<this.sourceLen&&(i=this.source[e],-1==" \t\n\r\v".indexOf(i)&&">"!=i&&"/"!=i);e++);if(e==this.sourceLen)break;s+=this.source.substring(this.parsePos+1,e),s.length>0&&"/"==s[0]&&(s=s.substring(1));let r=!1,a=!1,n=-1;for(;e<this.sourceLen;e++)if(i=this.source[e],'"'==i?r||(a=!a):"'"==i&&(a||(r=!r)),">"==i){if(!r&&!a){n=-1;break}n=e}else if("<"==i)break;if(-1!=n&&(e=n),e==this.sourceLen)break;return"/"==this.source[e-1]&&(this.tagType=t.XMLTagType.Void),this.tagName=s,this.lowerCaseName&&(this.tagName=this.tagName.toLowerCase()),this.tagPos=this.parsePos,this.tagLength=e+1-this.parsePos,this.parsePos+=this.tagLength,!0}return this.tagPos=this.sourceLen,this.tagLength=0,this.tagName=null,!1}static getTagSource(){return this.source.substring(this.tagPos,this.tagPos+this.tagLength)}static getRawText(t){if(this.lastTagEnd==this.tagPos)return"";if(t){let t=this.lastTagEnd;for(;t<this.tagPos;t++){let e=this.source[t];if(-1==" \t\n\r\v".indexOf(e))break}return t==this.tagPos?"":this.source.substring(t,this.tagPos).trim()}return this.source.substring(this.lastTagEnd,this.tagPos)}static getText(t){if(this.lastTagEnd==this.tagPos)return"";if(t){let t=this.lastTagEnd;for(;t<this.tagPos;t++){let e=this.source[t];if(-1==" \t\n\r\v".indexOf(e))break}return t==this.tagPos?"":wt.decodeString(this.source.substring(t,this.tagPos)).trimEnd()}return wt.decodeString(this.source.substring(this.lastTagEnd,this.tagPos))}static get attributes(){if(!this.attrParsed){for(let t in this._attrs)delete this._attrs[t];this.parseAttributes(this._attrs),this.attrParsed=!0}return this._attrs}static getAttribute(t){return this.attributes[t]}static parseAttributes(t){let e,i=0,s=0,r=!1,a=0,n="",l=this.tagPos,o=this.tagPos+this.tagLength;if(l<o&&"<"==this.source[l])for(;l<o;l++){let t=this.source[l];if(-1!=" \t\n\r\v".indexOf(t)||">"==t||"/"==t)break}for(;l<o;l++){let h=this.source[l];if("="==h){i=-1,s=-1,a=0;for(let t=l+1;t<o;t++){let e=this.source[t];if(-1!=" \t\n\r\v".indexOf(e)){if(-1!=i&&0==a){s=t-1;break}}else if(">"==e){if(0==a){s=t-1;break}}else if('"'==e)if(-1!=i){if(1!=a){s=t-1;break}}else a=2,i=t+1;else if("'"==e)if(-1!=i){if(2!=a){s=t-1;break}}else a=1,i=t+1;else-1==i&&(i=t)}if(-1==i||-1==s)break;e=n,this.lowerCaseName&&(e=e.toLowerCase()),n="",t[e]=wt.decodeString(this.source.substring(i,s+1)),l=s+1}else-1==" \t\n\r\v".indexOf(h)?((r||"/"==h||">"==h)&&(n.length>0&&(e=n,this.lowerCaseName&&(e=e.toLowerCase()),t[e]="",n=""),r=!1),"/"!=h&&">"!=h&&(n+=h)):n.length>0&&(r=!0)}}}bt._attrs={},String.prototype.trimEnd||(String.prototype.trimEnd=function(){return this.replace(/\s+$/g,"")});class Ct{constructor(t){t&&this.parse(t)}get attributes(){return this._attrs||(this._attrs={}),this._attrs}getAttrString(t,e){return wt.getString(this._attrs,t,e)}getAttrInt(t,e){return wt.getInt(this._attrs,t,e)}getAttrFloat(t,e){return wt.getFloat(this._attrs,t,e)}getAttrBool(t,e){return wt.getBool(this._attrs,t,e)}setAttribute(t,e){this._attrs||(this._attrs={}),this._attrs[t]=e}getNode(t){return this._children?this._children.find((e=>e.name==t)):null}elements(t){return this._children||(this._children=new Array),t?this._children.filter((e=>e.name==t)):this._children}parse(e){let i;this.reset();let s=new Array;for(bt.begin(e);bt.nextTag();)if(bt.tagType==t.XMLTagType.Start||bt.tagType==t.XMLTagType.Void){let e;if(i)e=new Ct;else{if(null!=this.name)throw this.reset(),new Error("Invalid xml format - no root node.");e=this}e.name=bt.tagName,e._attrs=Object.assign({},bt.attributes),i&&(bt.tagType!=t.XMLTagType.Void&&s.push(i),null==i._children&&(i._children=new Array),i._children.push(e)),bt.tagType!=t.XMLTagType.Void&&(i=e)}else if(bt.tagType==t.XMLTagType.End){if(null==i||i.name!=bt.tagName)throw this.reset(),new Error("Invalid xml format - <"+bt.tagName+"> dismatched.");null!=i._children&&0!=i._children.length||(i.text=bt.getText()),i=s.length>0?s.pop():null}}reset(){this._attrs=null,null!=this._children&&this._children.length,this.text=null}}class Rt extends v{constructor(){super(...arguments),this._http=new XMLHttpRequest}send(t,e=null,i="get",s="text",r){this._responseType=s,this._data=null,(A.onVVMiniGame||A.onQGMiniGame||A.onQQMiniGame||A.onAlipayMiniGame||A.onBLMiniGame||A.onHWMiniGame||A.onTTMiniGame||A.onTBMiniGame)&&(t=Rt._urlEncode(t)),this._url=t;let a=this._http;if(a.open(i,t,!0),e?"string"==typeof e?a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"):(a.setRequestHeader("Content-Type","application/json"),e instanceof ArrayBuffer||(e=JSON.stringify(e))):A.onBLMiniGame&&A.onAndroid&&(e={}),r)for(let t=0;t<r.length;t++)a.setRequestHeader(r[t++],r[t]);let n="arraybuffer"!==s?"text":"arraybuffer";a.responseType=n,a.dataType&&(a.dataType=n),a.onerror=t=>{this._onError(t)},a.onabort=t=>{this._onAbort(t)},a.onprogress=t=>{this._onProgress(t)},a.onload=t=>{this._onLoad(t)},a.send(e)}_onProgress(t){t&&t.lengthComputable&&this.event(r.PROGRESS,t.loaded/t.total)}_onAbort(t){this.error("Request was aborted by user")}_onError(t){this.error("Request failed Status:"+this._http.status+" text:"+this._http.statusText)}_onLoad(t){var e=this._http,i=void 0!==e.status?e.status:200;200===i||204===i||0===i?this.complete():this.error("["+e.status+"]"+e.statusText+":"+e.responseURL)}error(t){this.clear(),this.event(r.ERROR,t)}complete(){this.clear();var t=!0;try{"json"===this._responseType?this._data=JSON.parse(this._http.responseText):"xml"===this._responseType?this._data=new Ct(this._http.responseText):this._data=this._http.response||this._http.responseText}catch(e){t=!1,this.error(e.message)}t&&this.event(r.COMPLETE,this._data instanceof Array?[this._data]:this._data)}clear(){var t=this._http;t.onerror=t.onabort=t.onprogress=t.onload=null}get url(){return this._url}get data(){return this._data}get http(){return this._http}reset(){this.offAll(),this._data=null}}Rt._urlEncode=encodeURI;class At{constructor(){this.httpRequestPool=[]}common(t,e,i,s,a,n){let l=this.getRequestInst();l.on(r.COMPLETE,(()=>{let t=l.data;this.returnRequestInst(l),n(t)})),l.on(r.ERROR,null,(t=>{this.returnRequestInst(l),n(null,t)})),a&&l.on(r.PROGRESS,a),l.send(e,null,"get",s),t.$ref=l}image(t,e,i,s,r){let a=new A.window.Image;a.crossOrigin="",a.onload=()=>{a.onload=null,a.onerror=null,r(a)},a.onerror=()=>{a.onload=null,a.onerror=null,r(null,"")},a.src=e,t.$ref=a}imageWithBlob(t,e,i,s,r){let a=Et.arrayBufferToURL(i,e);this.image(t,a,i,s,r)}imageWithWorker(t,e,i,s,r){Tt.enable=!0,Tt.enable?Tt.load(e,t.workerLoaderOptions).then((t=>{t?r(t):r(null,"workerloader failed!")})):this.image(t,e,i,s,r)}audio(t,e,i,s,r){let a=A.createElement("audio");a.crossOrigin="",a.oncanplaythrough=()=>{a.oncanplaythrough=null,a.onerror=null,r(a)},a.onerror=()=>{a.oncanplaythrough=null,a.onerror=null,r(null,"")},a.src=e,t.$ref=a}getRequestInst(){return 0==this.httpRequestPool.length||A.onVVMiniGame||A.onHWMiniGame?new Rt:this.httpRequestPool.pop()}returnRequestInst(t){t.reset(),this.httpRequestPool.length<10&&this.httpRequestPool.push(t)}}var It=0;const Mt={ext:null,typeId:null,main:!1,loaderType:null};class Bt extends v{static registerLoader(t,e,i,s){let r;i?(r=Bt.typeMap[i],r?r.loaderType!=e&&(r={typeId:r.typeId,loaderType:e}):Bt.typeMap[i]=r={typeId:It++,loaderType:e}):r={typeId:It++,loaderType:e},s&&(Bt.hotReloadableFlags[r.typeId]=!0);for(let s of t){let t=Bt.extMap[s];if(t&&i){let i=t.findIndex((t=>t.typeId==r.typeId));-1==i?t.push(r):t[i].loaderType=e}else Bt.extMap[s]=[r]}}constructor(){super(),this.retryNum=1,this.retryDelay=0,this.maxLoader=5,this._loadings=new Map,this._queue=[],this._downloadings=new Set}get loading(){return this._loadings.size>0}load(t,e,i,s,r,a,n,l,o){let h,u,d,c,_=Nt;if(e instanceof St?(h=e,u=s):"string"==typeof e?u=e:null!=e&&(u=e.type,_=e),null==r&&null==a&&null==l&&null==n&&null==o||(_=_===Nt?{priority:r,cache:a,ignoreCache:l,group:n,useWorkerLoader:o}:Object.assign(_,{priority:r,cache:a,ignoreCache:l,group:n,useWorkerLoader:o})),!1===_.cache&&(_.ignoreCache=!0),d=i instanceof St?t=>i.runWith(t):i,Array.isArray(t)){let e;d&&(e=new vt(d));let i=[];for(let s=0;s<t.length;s++){let r=t[s];r&&("string"==typeof r?i.push(this._load1(r,u,_,null==e?void 0:e.createCallback())):i.push(this._load1(r.url,r.type||u,_!==Nt?Object.assign({},_,r):r,null==e?void 0:e.createCallback())))}c=Promise.all(i)}else c="string"==typeof t?this._load1(t,u,_,d):this._load1(t.url,t.type||u,_!==Nt?Object.assign({},_,t):t,d);return h?c.then((t=>(h.runWith(t),t))):c}_load1(t,e,i,s){if(n.isPreview){if(t.startsWith("res://")){let r=t.substring(6);return N.inst.UUID_to_URL_async(r).then((a=>{var n;return a?this._load2(a,r,e,i,s):(!i.silent&&Bt.warnFailed(t,void 0,null===(n=i.initiator)||void 0===n?void 0:n.url),Promise.resolve(null))}))}return N.inst.URL_to_UUID_async(t).then((r=>this._load2(t,r,e,i,s)))}return this._load2(t,null,e,i,s)}_load2(t,e,i,s,a){var n,l;let{ext:o,typeId:h,main:u,loaderType:d}=Bt.getURLInfo(t,i);if(!d)return!s.silent&&Bt.warnFailed(t,void 0,null===(n=s.initiator)||void 0===n?void 0:n.url),Promise.resolve(null);let c,_=O.formatURL(t);if(s.group){let t=Bt.groupMap[s.group];t||(t=Bt.groupMap[s.group]=new Set),t.add(_)}if(!s.ignoreCache){let t=Bt._getRes(_,i);if(void 0!==t){if(null==t)return Promise.resolve(null);if(!(t instanceof b))return Promise.resolve(t);if(t.obsolute&&(c=t),!(c||t.uuid&&e&&e!=t.uuid))return Promise.resolve(t)}}let p=_;u||(p+="@"+h);let f=this._loadings.get(p);if(f){let t=s.initiator;for(;t;){if(t===f)return Promise.resolve();t=t.options.initiator}return null!=f.result?f.result:(a&&f.onProgress.add(a),new Promise((t=>f.onComplete.add(t))))}let g=yt.getFileLoadPath(_);if(g)return this.load(g.url,{type:Bt.ATLAS,baseUrl:g.baseUrl}).then((()=>Bt.getRes(t,i)));f=Pt.length>0?Pt.pop():new Lt,f.type=i,f.url=t,f.uuid=e,f.ext=o,delete(s=Object.assign(f.options,s)).type,null==s.priority&&(s.priority=0),null==s.useWorkerLoader&&(s.useWorkerLoader=Tt.enable),a&&f.onProgress.add(a),f.loader=this,f.obsoluteInst=c;let m,y=new d;this._loadings.set(p,f);try{Bt.LoaderStat_LoaderResourceCount++,this._tempTime=performance.now(),m=y.load(f)}catch(e){!s.silent&&Bt.warnFailed(t,e,null===(l=s.initiator)||void 0===l?void 0:l.url),m=Promise.resolve(null)}return m.then((i=>(Bt.LoaderStat_LoadResourceTime+=performance.now()-this._tempTime,i instanceof b&&(i.obsolute=!1,i._setCreateURL(t,e)),!1!==f.options.cache&&Bt._cacheRes(_,i,h,u),null!=i&&null!=y.postLoad?(f.result=i,y.postLoad(f,i).then((()=>(f.progress.update(-1,1),f.onComplete.invoke(i),i)))):(f.progress.update(-1,1),f.onComplete.invoke(i),i)))).catch((e=>{var i;return!s.silent&&Bt.warnFailed(t,e,null===(i=s.initiator)||void 0===i?void 0:i.url),!1!==f.options.cache&&Bt._cacheRes(_,null,h,u),f.onComplete.invoke(null),null})).then((t=>(this._loadings.delete(p),f.reset(),Pt.push(f),0==this._loadings.size&&this.event(r.COMPLETE),t)))}fetch(t,e,i,s){var r;let a={originalUrl:t,url:t,contentType:e,priority:null!==(r=(s=s||Nt).priority)&&void 0!==r?r:1,retryCnt:0,onProgress:i,onComplete:null};return s.useWorkerLoader&&(a.useWorkerLoader=!0,a.workerLoaderOptions=s.workerLoaderOptions),s.blob&&(a.blob=s.blob),s.noRetry&&(a.retryCnt=-1),s.silent&&(a.silent=!0),N.inst.resolveURL(t).then((t=>t?new Promise((e=>{a.url=O.formatURL(t),a.onComplete=e,this.queueToDownload(a)})):null))}queueToDownload(t){if(this._downloadings.size<this.maxLoader)return void this.download(t);let e=t.priority;if(0==e)this._queue.push(t);else{let i=this._queue.findIndex((t=>t.priority<e));-1!=i?this._queue.splice(i,0,t):this._queue.push(t)}}download(t){this._downloadings.add(t),Bt.LoaderStat_LoadRequestCount++,t.startTime=performance.now();let e=O.postFormatURL(t.url);if("image"==t.contentType){let i=Bt.preLoadedMap[t.url];if(i){if(!(i instanceof ArrayBuffer))return void this.completeItem(t,i);t.blob=i}t.blob?Bt.downloader.imageWithBlob(t,t.blob,t.originalUrl,t.onProgress,((e,i)=>{e||(t.retryCnt=-1),this.completeItem(t,e,i)})):t.useWorkerLoader?Bt.downloader.imageWithWorker(t,e,t.originalUrl,t.onProgress,((e,i)=>{e||(t.useWorkerLoader=!1),this.completeItem(t,e,i)})):Bt.downloader.image(t,e,t.originalUrl,t.onProgress,((e,i)=>this.completeItem(t,e,i)))}else if("sound"==t.contentType)Bt.downloader.audio(t,e,t.originalUrl,t.onProgress,((e,i)=>this.completeItem(t,e,i)));else{let i=Bt.preLoadedMap[t.url];if(i)return void this.completeItem(t,i);Bt.downloader.common(t,e,t.originalUrl,t.contentType,t.onProgress,((e,i)=>this.completeItem(t,e,i)))}}completeItem(t,i,s){this._downloadings.delete(t),Bt.LoaderStat_LoadRequestTime+=performance.now()-t.startTime,i?(this._downloadings.size<this.maxLoader&&this._queue.length>0&&this.download(this._queue.shift()),t.onProgress&&t.onProgress(1),t.onComplete(i)):-1!=t.retryCnt&&t.retryCnt<this.retryNum?(t.retryCnt++,t.silent||console.debug(`Retry to load ${t.url} (${t.retryCnt})`),e.systemTimer.once(this.retryDelay,this,this.queueToDownload,[t],!1)):(!t.silent&&Bt.warnFailed(t.url),t.onProgress&&t.onProgress(1),this._downloadings.size<this.maxLoader&&this._queue.length>0&&this.download(this._queue.shift()),t.onComplete(null))}static getURLInfo(t,e){let i,s,r,a,n=t.startsWith("data:")?"png":P.getFileExtension(t);if(n.length>0&&(i=Bt.extMap[n]),e){let t=Bt.typeMap[e];if(!t)return Mt;s=t.typeId;let n=0;i?i[0].typeId===s||-1!=(n=i.findIndex((t=>t.typeId===s)))?(r=0==n,a=i[n].loaderType):(r=!1,a=t.loaderType):(r=e!=Bt.TEXTURE2D,a=t.loaderType)}else{if(!i)return Mt;r=!0,s=i[0].typeId,a=i[0].loaderType}return{ext:n,main:r,typeId:s,loaderType:a}}static warnFailed(t,e,i){i?this.warn(`Failed to load '${t}' (in '${i}')`,e):this.warn(`Failed to load '${t}'`,e)}static warn(t,e){e?console.warn(t,e):console.warn(t)}static getRes(t,e){return t=O.formatURL(t),Bt._getRes(t,e)||null}static _getRes(t,e){let i,s=Bt.loadedMap[t];if(s){if(e){let t=Bt.typeMap[e];if(!t)return;if(2==s.length)s[0]==t.typeId&&(i=s[1]);else{let e=s.indexOf(t.typeId);-1!=e&&(i=s[e+1])}}else i=s[1];return i instanceof b&&i.destroyed?void 0:i}}static getTexture2D(t){return Bt.getRes(t,Bt.TEXTURE2D)}static getBaseTexture(t){return Bt.getRes(t,Bt.TEXTURE2D)}static getAtlas(t){return Bt.getRes(t,Bt.ATLAS)}getRes(t,e){return Bt.getRes(t,e)}static createNodes(t){var e;return null===(e=Bt.getRes(t))||void 0===e?void 0:e.create()}static cacheRes(t,e,i){t=O.formatURL(t);let s=Bt.getURLInfo(t,i);null!=s.typeId&&Bt._cacheRes(t,e,s.typeId,s.main)}static _cacheRes(t,e,i,s){let r=Bt.loadedMap[t];if(s)r?(r[0]=i,r[1]=e):r=Bt.loadedMap[t]=[i,e];else if(r){let t=r.findIndex((t=>t===i));-1!=t?r[t+1]=e:r.push(i,e)}else r=Bt.loadedMap[t]=[null,void 0,i,e]}cacheRes(t,e,i){Bt.cacheRes(t,e,i)}static clearRes(t,e){t=O.formatURL(t),Bt._clearRes(t,e)}clearRes(t,e){t=O.formatURL(t),Bt._clearRes(t,e)}static _clearRes(t,e){let i=Bt.loadedMap[t];if(i)if(e){if(i[1]==e)2==i.length?delete Bt.loadedMap[t]:i[1]=void 0;else{let s=i.indexOf(e);if(-1==s)return;4==i.length&&null==i[0]?delete Bt.loadedMap[t]:i.splice(s-1,2)}e instanceof b&&!e.destroyed&&e.destroy()}else if(delete Bt.loadedMap[t],i.length>2)for(let t=1;t<i.length;t+=2){let e=i[t];e instanceof b&&!e.destroyed&&e.destroy()}else{let t=i[1];t instanceof b&&!t.destroyed&&t.destroy()}}clearTextureRes(t){t=O.formatURL(t);let e=Bt.loadedMap[t];if(!e)return;let i=e[1];if(i instanceof mt)i.disposeBitmap();else if(i instanceof xt)for(let t of i.textures)t.disposeBitmap()}static setGroup(t,e){t=O.formatURL(t);let i=Bt.groupMap[e];i||(i=Bt.groupMap[e]=new Set),i.add(t)}static clearResByGroup(t){let e=Bt.groupMap[t];if(e)for(let t of e)Bt._clearRes(t)}clearUnLoaded(){if(0==this._queue.length)return;let t=this._queue.concat();this._queue.length=0;for(let e of t)e.onComplete(null)}cancelLoadByUrls(t){if(t)for(var e=0,i=t.length;e<i;e++)this.cancelLoadByUrl(t[e])}cancelLoadByUrl(t){t=O.formatURL(t);let e=this._queue.findIndex((e=>e.url==t));if(-1!=e){let t=this._queue[e];this._queue.splice(e,1),t.onComplete(null)}}loadPackage(t,i,s){let r,a;if("string"==typeof i?(a=i,r=s):r=s||i,a)return a.endsWith("/")||(a+="/"),O.basePaths[t.length>0?t+"/":t]=a,this._loadSubFileConfig(t,null,r);{if(n.isPreview)return Promise.resolve();let i=e.Browser.miniGameContext;return null==i?this._loadSubFileConfig(t,null,r):this._loadMiniPackage(i,t,r).then((()=>this._loadSubFileConfig(t,i,r)))}}_loadMiniPackage(t,e,i){return t.subPkgNameSeperator&&(e=e.replace(/\//g,t.subPkgNameSeperator)),e.length>0?new Promise(((s,r)=>{let a=t.loadSubpackage({name:e,success:t=>{s(t)},fail:t=>{r(t)}});a.onProgressUpdate&&a.onProgressUpdate((t=>{i&&i(t)}))})):Promise.resolve()}_loadSubFileConfig(t,i,s){return i&&i.subPkgPathSeperator&&(t=t.replace(/\//g,i.subPkgPathSeperator)),t.length>0&&(t+="/"),this.fetch(t+"fileconfig.json","json",s).then((s=>{let r=[],a=s.files;for(let t in a)if(t.length>0)for(let e of a[t])r.push(t+"/"+e);else for(let e of a[t])r.push(e);if(s.hash){let t=0,e=O.version;for(let i of s.hash)null!=i&&(e[r[t]]=i),t++}let n,l,o=s.config,h=o.length,u=0,d=0,c=0,_=0,p=0,f=N.inst.metaMap;for(;;){if(null==n){if(u>=h)break;l=o[u],n=l.i,Array.isArray(n)?p=n.length:(c=n,p=0,_=1),d=0}if(0==_){if(d>=p){u++,n=null;continue}_=n[d++],_>0?(c=_,_=0):_=-_}else _--;let t=r[c+_];switch(l.t){case 0:f[t]=l;break;case 1:yt.addAtlas(t,l.prefix,l.frames);break;case 2:N.inst.shaderNameMap[l.shaderName]=t;break;case 3:Bt.preLoadedMap[O.formatURL(t)]=l}}return!i&&s.entry?e.Browser.loadLib(O.formatURL(t+s.entry)):Promise.resolve()}))}}Bt.TEXT="text",Bt.JSON="json",Bt.XML="xml",Bt.BUFFER="arraybuffer",Bt.IMAGE="image",Bt.SOUND="sound",Bt.VIDEO="video",Bt.ATLAS="atlas",Bt.FONT="font",Bt.TTF="ttf",Bt.HIERARCHY="HIERARCHY",Bt.MESH="MESH",Bt.MATERIAL="MATERIAL",Bt.TEXTURE2D="TEXTURE2D",Bt.TEXTURECUBE="TEXTURE2D",Bt.TEXTURE2DARRAY="TEXTURE2D",Bt.ANIMATIONCLIP="ANIMATIONCLIP",Bt.TERRAINHEIGHTDATA="TERRAINHEIGHTDATA",Bt.TERRAINRES="TERRAIN",Bt.SPINE="SPINE",Bt.extMap={},Bt.typeMap={},Bt.hotReloadableFlags={},Bt.downloader=new At,Bt.groupMap={},Bt.loadedMap={},Bt.preLoadedMap={};class Lt{constructor(){this.options={},this.onProgress=new T,this.onComplete=new T,this.progress=new vt((t=>this.onProgress.invoke(t)))}reset(){for(let t in this.options)delete this.options[t];this.onProgress.clear(),this.onComplete.clear(),this.progress.reset(),this.obsoluteInst=null,this.result=null}}const Pt=[],Nt={};class Ot{static regClass(t,e){Ot._classMap[t]=e}static getClass(t){return Ot._classMap[t]}static getInstance(t){var e=Ot.getClass(t);return e?new e:(console.warn("[error] Undefined class:",t),null)}}function Ft(){}Ot._classMap={};class Ut{}Ut.ENUM_TEXTALIGN_DEFAULT=0,Ut.ENUM_TEXTALIGN_CENTER=1,Ut.ENUM_TEXTALIGN_RIGHT=2,Ut.INDEX_BYTES=2,Ut.MAX_CLIP_SIZE=99999999;class kt{}kt.NOT_ACTIVE=1,kt.ACTIVE_INHIERARCHY=2,kt.AWAKED=4,kt.NOT_READY=8,kt.DISPLAY=16,kt.HAS_ZORDER=32,kt.HAS_MOUSE=64,kt.DISPLAYED_INSTAGE=128,kt.DRAWCALL_OPTIMIZE=256,kt.PROCESS_COLLISIONS=512,kt.PROCESS_TRIGGERS=1024,kt.HAS_SCRIPT=2048,kt.ESCAPE_DRAWING_TO_TEXTURE=4096,kt.DISABLE_INNER_CLIPPING=8192,kt.DISABLE_OUTER_CLIPPING=16384,kt.DISABLE_VISIBILITY=32768,kt.EDITING_NODE=65536,kt.HIDE_BY_EDITOR=131072,kt.LOCK_BY_EDITOR=262144;class Gt{}Gt.HideInHierarchy=1,Gt.HideInInspector=2,Gt.DontSave=4,Gt.HideAndDontSave=7;class Vt{get hideFlags(){return this._hideFlags}set hideFlags(t){this._hideFlags=t}constructor(){var t;this._hideFlags=0,this._status=0,this._enabled=!0,this._id=P.getGID(),this._singleton=null===(t=Object.getPrototypeOf(this)._$singleton)||void 0===t||t,this._initialize()}_initialize(){this._extra={}}hasHideFlag(t){return!!(this._hideFlags&t)}get id(){return this._id}get enabled(){return this._enabled}set enabled(t){this._enabled!=t&&(this._enabled=t,this.owner&&this._setActive(t&&this.owner.activeInHierarchy))}get awaked(){return this._status>0}get destroyed(){return 4==this._status}_isScript(){return!1}_resetComp(){this._enabled=!0,this._status=0,this._enableState=!1,this.owner=null}_setOwner(t){if(0!=this._status)throw new Error("reuse a destroyed component");this.owner=t,this._isScript()&&t._setBit(kt.HAS_SCRIPT,!0),this._onAdded(),this.onAdded()}_onAdded(){}_onAwake(){}_onEnable(){this.onEnable()}_onDisable(){this.onDisable()}_onDestroy(){}_parse(t,e=null){}_parseInteractive(t=null,e=null){}_cloneTo(t){}_setActive(t){var i,s;if(t){if(0==this._status&&(this._status=1,(n.isPlaying||this.runInEditor)&&(this._onAwake(),this.onAwake())),this._enabled&&!this._enableState&&(this._enableState=!0,n.isPlaying||this.runInEditor)){((null===(i=this.owner._is3D&&this.owner._scene)||void 0===i?void 0:i._componentDriver)||e.stage._componentDriver).add(this),n.isPlaying&&this._isScript()&&this.setupScript(),this._onEnable()}}else if(this._enableState&&(this._enableState=!1,n.isPlaying||this.runInEditor)){((null===(s=this.owner._is3D&&this.owner._scene)||void 0===s?void 0:s._componentDriver)||e.stage._componentDriver).remove(this),e.stage.offAllCaller(this),this._onDisable()}}setupScript(){}destroy(){4!=this._status&&(this.owner?this.owner._destroyComponent(this):this.destroyed||this._destroy(!0))}_destroy(t){var s;if(t)(n.isPlaying||this.runInEditor)&&(this._onDestroy(),this.onDestroy(),this.onReset&&(this.onReset(),this._resetComp(),i.recoverByClass(this)));else if(this._setActive(!1),this._status=4,n.isPlaying||this.runInEditor){((null===(s=this.owner._is3D&&this.owner._scene)||void 0===s?void 0:s._componentDriver)||e.stage._componentDriver)._toDestroys.add(this)}}onAdded(){}onAwake(){}onEnable(){}onDisable(){}onDestroy(){}}var Ht,zt,Wt,Yt,Xt,jt,qt,$t;t.RenderParams=void 0,(Ht=t.RenderParams||(t.RenderParams={}))[Ht.Max_Active_Texture_Count=0]="Max_Active_Texture_Count",Ht[Ht.Max_Uniform_Count=1]="Max_Uniform_Count",Ht[Ht.Max_AnisoLevel_Count=2]="Max_AnisoLevel_Count",Ht[Ht.MAX_Texture_Size=3]="MAX_Texture_Size",Ht[Ht.MAX_Texture_Image_Uint=4]="MAX_Texture_Image_Uint",Ht[Ht.SHADER_CAPAILITY_LEVEL=5]="SHADER_CAPAILITY_LEVEL",Ht[Ht.FLOAT=6]="FLOAT",Ht[Ht.UNSIGNED_BYTE=7]="UNSIGNED_BYTE",Ht[Ht.BYTE=8]="BYTE",Ht[Ht.UNSIGNED_SHORT=9]="UNSIGNED_SHORT";class Kt{static __init__(){Kt._elementInfos={single:[1,l.renderEngine.getParams(t.RenderParams.FLOAT),0],vector2:[2,l.renderEngine.getParams(t.RenderParams.FLOAT),0],vector3:[3,l.renderEngine.getParams(t.RenderParams.FLOAT),0],vector4:[4,l.renderEngine.getParams(t.RenderParams.FLOAT),0],color:[4,l.renderEngine.getParams(t.RenderParams.FLOAT),0],byte4:[4,l.renderEngine.getParams(t.RenderParams.UNSIGNED_BYTE),0],byte3:[3,l.renderEngine.getParams(t.RenderParams.UNSIGNED_BYTE),0],byte2:[2,l.renderEngine.getParams(t.RenderParams.UNSIGNED_BYTE),0],byte:[1,l.renderEngine.getParams(t.RenderParams.UNSIGNED_BYTE),0],short2:[2,l.renderEngine.getParams(t.RenderParams.UNSIGNED_SHORT),0],short4:[4,l.renderEngine.getParams(t.RenderParams.UNSIGNED_SHORT),0],normalizedshort2:[2,l.renderEngine.getParams(t.RenderParams.UNSIGNED_SHORT),1],normalizedshort4:[4,l.renderEngine.getParams(t.RenderParams.UNSIGNED_SHORT),1],halfvector2:[2,l.renderEngine.getParams(t.RenderParams.FLOAT),0],halfvector4:[4,l.renderEngine.getParams(t.RenderParams.FLOAT),0],nbyte4:[4,l.renderEngine.getParams(t.RenderParams.BYTE),1],ubyte4:[4,l.renderEngine.getParams(t.RenderParams.UNSIGNED_BYTE),1]}}static getElementInfos(t){var e=Kt._elementInfos[t];if(e)return e;throw"VertexElementFormat: this vertexElementFormat is not implement."}}Kt.Single="single",Kt.Vector2="vector2",Kt.Vector3="vector3",Kt.Vector4="vector4",Kt.Color="color",Kt.Byte4="byte4",Kt.Byte3="byte3",Kt.Byte2="byte2",Kt.ByteOne="byte",Kt.Short2="short2",Kt.Short4="short4",Kt.NormalizedShort2="normalizedshort2",Kt.NormalizedShort4="normalizedshort4",Kt.HalfVector2="halfvector2",Kt.HalfVector4="halfvector4",Kt.NorByte4="nbyte4",Kt.NorUByte4="ubyte4";class Qt{}class Zt{get id(){return this._id}get vertexStride(){return this._vertexStride}get vertexElementCount(){return this._vertexElements.length}constructor(t,e){this._id=++Zt._uniqueIDCounter,this._vertexElementsDic={},this._vertexStride=t,this._vertexElements=e,this._VAElements=[];var i=e.length;this._shaderValues={};for(var s=0;s<i;s++){var r=e[s],a=r._elementUsage;this._vertexElementsDic[a]=r;var n=new Qt,l=Kt.getElementInfos(r._elementFormat);n.elementString=r._elementFormat,n.elementCount=l[0],n.elementType=l[1],n.normalized=l[2],n.vertexStride=this._vertexStride,n.elementOffset=r._offset,this._shaderValues[a]=n,this._VAElements.push({format:r._elementFormat,stride:r._offset,shaderLocation:a})}}getVertexElementByIndex(t){return this._vertexElements[t]}getVertexElementByUsage(t){return this._vertexElementsDic[t]}}Zt._uniqueIDCounter=1;class Jt{get offset(){return this._offset}get elementFormat(){return this._elementFormat}get elementUsage(){return this._elementUsage}constructor(t,e,i){this._offset=t,this._elementFormat=e,this._elementUsage=i}}class te{constructor(t,e,i){this._stride=0,this._vertNum=0,this._indexNum=0,this._stride=t,this._VBBuff=new ArrayBuffer(e||32),this._IBBuff=new ArrayBuffer(i||8),this.onVBRealloc(this._VBBuff),this.onIBRealloc(this._IBBuff)}get vbBuffer(){return this._VBBuff}get ibBuffer(){return this._IBBuff}get indexNum(){return this._indexNum}get vertexNum(){return this._vertNum}clearMesh(){this._vertNum=0,this._indexNum=0}expVBSize(t){if(t){let e=this._vertNum*this._stride;if(e+t>this._VBBuff.byteLength){let i=this._VBBuff;this._VBBuff=new ArrayBuffer(e+8*t),new Uint8Array(this._VBBuff,0,e).set(new Uint8Array(i,0,e)),this.onVBRealloc(this._VBBuff)}}}expIBSize(t){if(t){let e=2*this._indexNum;if(e+t>this._IBBuff.byteLength){let i=this._IBBuff;this._IBBuff=new ArrayBuffer(e+8*t),new Uint8Array(this._IBBuff,0,e).set(new Uint8Array(i,0,e)),this.onIBRealloc(this._IBBuff)}}}}class ee extends te{static __int__(){ee._fixib=function(t){let e=new W(6*t*2),i=new Uint16Array(e.buffer);for(var s=0,r=0,a=0;a<t;a++)i[s++]=r,i[s++]=r+2,i[s++]=r+1,i[s++]=r,i[s++]=r+3,i[s++]=r+2,r+=4;return i}(ee._maxIB),ee.VertexDeclarition=new Zt(48,[new Jt(0,Kt.Vector4,0),new Jt(16,Kt.Vector4,1),new Jt(32,Kt.Vector4,2)])}constructor(t=4){super(ee.const_stride,t,4),this._curVBPos=0}onVBRealloc(t){this._vbFloat32Array=new Float32Array(t)}onIBRealloc(t){}addQuad(t,e,i,s){this.expVBSize(ee.const_stride);var r=this._vbFloat32Array;let a=(i>>>16&255)/255,n=(i>>>8&255)/255,l=(255&i)/255,o=(i>>>24)/255;var h=this._curVBPos,u=s?1:0;r[h++]=t[0],r[h++]=t[1],r[h++]=e[0],r[h++]=e[1],r[h++]=l,r[h++]=n,r[h++]=a,r[h++]=o,r[h++]=u,h+=3,r[h++]=t[2],r[h++]=t[3],r[h++]=e[2],r[h++]=e[3],r[h++]=l,r[h++]=n,r[h++]=a,r[h++]=o,r[h++]=u,h+=3,r[h++]=t[4],r[h++]=t[5],r[h++]=e[4],r[h++]=e[5],r[h++]=l,r[h++]=n,r[h++]=a,r[h++]=o,r[h++]=u,h+=3,r[h++]=t[6],r[h++]=t[7],r[h++]=e[6],r[h++]=e[7],r[h++]=l,r[h++]=n,r[h++]=a,r[h++]=o,r[h++]=u,h+=3,this._curVBPos=h,this._vertNum+=4,this._indexNum+=6}clearMesh(){super.clearMesh(),this._curVBPos=0}get ibBuffer(){return ee._fixib.buffer}get vertexDeclarition(){return ee.VertexDeclarition}}ee.const_stride=48,ee._maxIB=16384;class ie extends v{constructor(){super(),this.left=0,this.top=0,this.width=0,this.height=0;let t=this._rectMeshNormY=new ee;t.addQuad([0,0,1,0,1,1,0,1],[0,0,1,0,1,1,0,1],4294967295,!0),this._rectMeshVBNormY=new Float32Array(t.vbBuffer);let e=this._rectMeshInvY=new ee;e.addQuad([0,0,1,0,1,1,0,1],[0,1,1,1,1,0,0,0],4294967295,!0),this._rectMeshVBInvY=new Float32Array(e.vbBuffer),this.useFlipY(!1)}onChange(){this.event(ie.EVENT_CHANGE)}useFlipY(t){this._rectMesh=t?this._rectMeshInvY:this._rectMeshNormY,this._rectMeshVB=t?this._rectMeshVBInvY:this._rectMeshVBNormY}set render2D(t){this._render2D=t}get type(){return-1}}ie.COLOR=32,ie.EVENT_CHANGE="change",ie._filter=function(t,e,i,s){var r=this._next;if(!r)return;var a=t.filters,n=a.length,l=t.renderNode2D;if(1==n&&!l&&a[0].type==ie.COLOR)return e.save(),e.setColorFilter(a[0]),r._fun.call(r,t,e,i,s),void e.restore();let o=t._getCacheStyle(),h=0,u=0;if(this._renderNextToCacheRT(t,e,16,16,16,16)){h=o.cacheRect.x,u=o.cacheRect.y;let t=o.renderTexture,i=t,s=t.width,r=t.height,l=e.render2D.out;for(let l=0;l<n;l++){t=i;var d=a[l];d._render2D=e.render2D,d.useFlipY(0!=l),d.render(t,s,r),s=d.width,r=d.height,i=d.texture,h+=d.left,u+=d.top}e.render2D.setRenderTarget(l),o.renderTexture=i,o.renderTexOffx=h,o.renderTexOffy=u}o.renderTexture&&e._drawRenderTexture(o.renderTexture,i+o.renderTexOffx,s+o.renderTexOffy,o.renderTexture.width,o.renderTexture.height,null,1,pt.defuv)};class se{static multiply(t,e,i){return(t.x-i.x)*(e.y-i.y)-(e.x-i.x)*(t.y-i.y)}static dis(t,e){return(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)}static _getPoints(t,e=!1,i=null){for(se._mPointList||(se._mPointList=[]);se._mPointList.length<t;)se._mPointList.push(new s);return i||(i=[]),i.length=0,e?se.getFrom(i,se._mPointList,t):se.getFromR(i,se._mPointList,t),i}static getFrom(t,e,i){var s;for(s=0;s<i;s++)t.push(e[s]);return t}static getFromR(t,e,i){var s;for(s=0;s<i;s++)t.push(e.pop());return t}static pListToPointList(t,e=!1){var i,s=t.length/2,r=se._getPoints(s,e,se._tempPointList);for(i=0;i<s;i++)r[i].setTo(t[i+i],t[i+i+1]);return r}static pointListToPlist(t){var e,i,s=t.length,r=se._temPList;for(r.length=0,e=0;e<s;e++)i=t[e],r.push(i.x,i.y);return r}static scanPList(t){return P.copyArray(t,se.pointListToPlist(se.scan(se.pListToPointList(t,!0))))}static scan(t){var e,i,s,r,a,n=0,l=t.length,o={};for((r=se._temArr).length=0,e=(l=t.length)-1;e>=0;e--)(a=(s=t[e]).x+"_"+s.y)in o||(o[a]=!0,r.push(s));for(l=r.length,P.copyArray(t,r),e=1;e<l;e++)(t[e].y<t[n].y||t[e].y==t[n].y&&t[e].x<t[n].x)&&(n=e);for(s=t[0],t[0]=t[n],t[n]=s,e=1;e<l-1;e++){for(n=e,i=e+1;i<l;i++)(se.multiply(t[i],t[n],t[0])>0||0==se.multiply(t[i],t[n],t[0])&&se.dis(t[0],t[i])<se.dis(t[0],t[n]))&&(n=i);s=t[e],t[e]=t[n],t[n]=s}if((r=se._temArr).length=0,t.length<3)return P.copyArray(r,t);for(r.push(t[0],t[1],t[2]),e=3;e<l;e++){for(;r.length>=2&&se.multiply(t[e],r[r.length-1],r[r.length-2])>=0;)r.pop();t[e]&&r.push(t[e])}return r}}se._tempPointList=[],se._temPList=[],se._temArr=[];class re{}re.ALPHA=1,re.TRANSFORM=2,re.BLEND=4,re.CANVAS=8,re.FILTERS=16,re.MASK=32,re.CLIP=64,re.TEXTURE=128,re.GRAPHICS=256,re.RENDERNODE2D=512,re.CUSTOM=1024,re.HITAREA=2048,re.CHILDS=4096,re.REPAINT_NONE=0,re.REPAINT_NODE=1,re.REPAINT_CACHE=2,re.REPAINT_ALL=3,t.GPUEngineStatisticsInfo=void 0,(zt=t.GPUEngineStatisticsInfo||(t.GPUEngineStatisticsInfo={}))[zt.C_UniformBufferUploadCount=0]="C_UniformBufferUploadCount",zt[zt.C_GeometryBufferUploadCount=1]="C_GeometryBufferUploadCount",zt[zt.C_TriangleCount=2]="C_TriangleCount",zt[zt.C_SetRenderPassCount=3]="C_SetRenderPassCount",zt[zt.C_DrawCallCount=4]="C_DrawCallCount",zt[zt.C_Instancing_DrawCallCount=5]="C_Instancing_DrawCallCount",zt[zt.C_ShaderCompile=6]="C_ShaderCompile",zt[zt.T_ShaderCompile=7]="T_ShaderCompile",zt[zt.FrameClearCount=8]="FrameClearCount",zt[zt.M_GPUMemory=9]="M_GPUMemory",zt[zt.M_GPUBuffer=10]="M_GPUBuffer",zt[zt.M_VertexBuffer=11]="M_VertexBuffer",zt[zt.M_IndexBuffer=12]="M_IndexBuffer",zt[zt.M_UniformBlockBuffer=13]="M_UniformBlockBuffer",zt[zt.RC_GPUBuffer=14]="RC_GPUBuffer",zt[zt.RC_VertexBuffer=15]="RC_VertexBuffer",zt[zt.RC_IndexBuffer=16]="RC_IndexBuffer",zt[zt.RC_UniformBlockBuffer=17]="RC_UniformBlockBuffer",zt[zt.M_ALLTexture=18]="M_ALLTexture",zt[zt.M_Texture2D=19]="M_Texture2D",zt[zt.M_TextureCube=20]="M_TextureCube",zt[zt.M_Texture3D=21]="M_Texture3D",zt[zt.M_Texture2DArray=22]="M_Texture2DArray",zt[zt.RC_ALLTexture=23]="RC_ALLTexture",zt[zt.RC_Texture2D=24]="RC_Texture2D",zt[zt.RC_TextureCube=25]="RC_TextureCube",zt[zt.RC_Texture3D=26]="RC_Texture3D",zt[zt.RC_Texture2DArray=27]="RC_Texture2DArray",zt[zt.M_ALLRenderTexture=28]="M_ALLRenderTexture",zt[zt.RC_ALLRenderTexture=29]="RC_ALLRenderTexture",zt[zt.Count=30]="Count",t.RenderPassStatisticsInfo=void 0,(Wt=t.RenderPassStatisticsInfo||(t.RenderPassStatisticsInfo={}))[Wt.T_CameraRender=0]="T_CameraRender",Wt[Wt.T_Render_OpaqueRender=1]="T_Render_OpaqueRender",Wt[Wt.T_Render_TransparentRender=2]="T_Render_TransparentRender",Wt[Wt.T_Render_PostProcess=3]="T_Render_PostProcess",Wt[Wt.T_Render_CameraEventCMD=4]="T_Render_CameraEventCMD",Wt[Wt.T_Render_ShadowPassMode=5]="T_Render_ShadowPassMode",Wt[Wt.T_Render_CameraOtherDest=6]="T_Render_CameraOtherDest",Wt[Wt.T_RenderPreUpdate=7]="T_RenderPreUpdate",Wt[Wt.T_OtherRender=8]="T_OtherRender",Wt[Wt.T_OnlyMeshRender=9]="T_OnlyMeshRender",Wt[Wt.T_OnlySkinnedMeshRender=10]="T_OnlySkinnedMeshRender",Wt[Wt.T_OnlyShurikenParticleRender=11]="T_OnlyShurikenParticleRender",Wt[Wt.T_CameraMainCull=12]="T_CameraMainCull",Wt[Wt.T_ShadowMapCull=13]="T_ShadowMapCull",Wt[Wt.RenderPassStatisticCount=14]="RenderPassStatisticCount";class ae{static show(t,i,s){ae.checkUI()&&(this.hide(),ae._show=!0,l.renderEngine._enableStatistics=!0,ae._currentShowArray=s||ae.AllShow,ae._statUI.show(t,i,ae._currentShowArray),e.systemTimer.frameLoop(1,null,ae.loop),e.timer.frameLoop(1,null,ae.clear))}static showToggle(t,i,s){ae.checkUI()&&(this.hide(),ae._show=!0,ae._currentToggleArray=s,ae._statUI.showToggle(t,i,s),e.systemTimer.frameLoop(1,null,ae.loop),e.timer.frameLoop(1,null,ae.clear))}static checkUI(){if(!ae._statUI){let t=Ot.getClass("StatUI");if(!t)return console.error("StatUI not found"),!1;ae._statUI=new t}return!0}static hide(){ae._show&&(ae._show=!1,ae._currentShowArray=null,ae._currentToggleArray=null,e.timer.clear(null,ae.loop),e.timer.clear(null,ae.clear),ae._statUI&&ae._statUI.hide())}static loop(){ae._count++;let t=A.now();if(t-ae._timer<1e3)return;let e=ae._count;if(ae.FPS=Math.round(1e3*e/(t-ae._timer)),ae._show){ae.updateEngineData();let t=ae.FPS>0?Math.floor(1e3/ae.FPS).toString():" ";ae._fpsStr=ae.FPS+(ae.renderSlow?" slow":"")+" "+t+"ms",ae._statUI.update()}ae._count=0,ae._timer=t}static updateEngineData(){ae.trianglesFaces+=l.renderEngine.getStatisticsInfo(t.GPUEngineStatisticsInfo.C_TriangleCount),ae.drawCall+=l.renderEngine.getStatisticsInfo(t.GPUEngineStatisticsInfo.C_DrawCallCount),ae.instanceDrawCall+=l.renderEngine.getStatisticsInfo(t.GPUEngineStatisticsInfo.C_Instancing_DrawCallCount),ae.gpuMemory=l.renderEngine.getStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUMemory),ae.textureMemory=l.renderEngine.getStatisticsInfo(t.GPUEngineStatisticsInfo.M_ALLTexture),ae.renderTextureMemory=l.renderEngine.getStatisticsInfo(t.GPUEngineStatisticsInfo.M_ALLRenderTexture),ae.bufferMemory=l.renderEngine.getStatisticsInfo(t.GPUEngineStatisticsInfo.M_GPUBuffer)}static clear(){ae._currentShowArray&&!ae._count&&(ae._currentShowArray.forEach((t=>{"average"==t.mode&&(ae[t.value]=0)})),l.renderEngine.clearStatisticsInfo(),ae.renderPassStatArray.fill(0))}static render(t,e,i){ae._show&&ae._statUI.render(t,e,i)}}ae.FPSStatUIParams={title:"FPS",value:"_fpsStr",color:"yellow",units:"int",mode:"summit"},ae.NodeStatUIParams={title:"Node",value:"spriteCount",color:"white",units:"int",mode:"summit"},ae.Sprite3DStatUIParams={title:"Sprite3D",value:"sprite3DCount",color:"white",units:"int",mode:"summit"},ae.DrawCall={title:"DrawCall",value:"drawCall",color:"white",units:"int",mode:"average"},ae.TriangleFace={title:"TriangleFace",value:"trianglesFaces",color:"white",units:"int",mode:"average"},ae.RenderNode={title:"RenderNode",value:"renderNode",color:"white",units:"int",mode:"summit"},ae.SkinRenderNode={title:"SkinRenderNode",value:"skinRenderNode",color:"white",units:"int",mode:"summit"},ae.ParticleRenderNode={title:"ParticleRenderNode",value:"particleRenderNode",color:"white",units:"int",mode:"summit"},ae.FrustumCulling={title:"FrustumCulling",value:"frustumCulling",color:"white",units:"int",mode:"average"},ae.UniformUpload={title:"UniformUpload",value:"uniformUpload",color:"white",units:"int",mode:"average"},ae.OpaqueDrawCall={title:"OpaqueDrawCall",value:"opaqueDrawCall",color:"white",units:"int",mode:"average"},ae.TransDrawCall={title:"TransDrawCall",value:"transDrawCall",color:"white",units:"int",mode:"average"},ae.DepthCastDrawCall={title:"DepthCastDrawCall",value:"depthCastDrawCall",color:"white",units:"int",mode:"average"},ae.ShadowDrawCall={title:"ShadowDrawCall",value:"shadowMapDrawCall",color:"white",units:"int",mode:"average"},ae.InstanceDrawCall={title:"InstanceDrawCall",value:"instanceDrawCall",color:"white",units:"int",mode:"average"},ae.CMDDrawCall={title:"CMDDrawCall",value:"cmdDrawCall",color:"white",units:"int",mode:"average"},ae.BlitDrawCall={title:"BlitDrawCall",value:"blitDrawCall",color:"white",units:"int",mode:"average"},ae.GPUMemory={title:"GPUMemory",value:"gpuMemory",color:"white",units:"M",mode:"summit"},ae.TextureMemeory={title:"TextureMemory",value:"textureMemory",color:"white",units:"M",mode:"summit"},ae.RenderTextureMemory={title:"RenderTextureMemory",value:"renderTextureMemory",color:"white",units:"M",mode:"summit"},ae.BufferMemory={title:"BufferMemory",value:"bufferMemory",color:"white",units:"M",mode:"summit"},ae.uploadUniformNum={title:"UploadUniformNum",value:"uploadUniform",color:"white",units:"int",mode:"average"},ae.AllShow=[ae.FPSStatUIParams,ae.NodeStatUIParams,ae.Sprite3DStatUIParams,ae.DrawCall,ae.TriangleFace,ae.RenderNode,ae.SkinRenderNode,ae.ParticleRenderNode,ae.FrustumCulling,ae.OpaqueDrawCall,ae.TransDrawCall,ae.ShadowDrawCall,ae.DepthCastDrawCall,ae.InstanceDrawCall,ae.CMDDrawCall,ae.BlitDrawCall,ae.GPUMemory,ae.TextureMemeory,ae.RenderTextureMemory,ae.BufferMemory,ae.uploadUniformNum],ae.memoryShow=[ae.GPUMemory,ae.TextureMemeory,ae.RenderTextureMemory,ae.BufferMemory],ae.renderShow=[ae.DrawCall,ae.TriangleFace,ae.OpaqueDrawCall,ae.TransDrawCall,ae.ShadowDrawCall,ae.DepthCastDrawCall,ae.InstanceDrawCall,ae.CMDDrawCall,ae.BlitDrawCall],ae.toogle_Shadow={title:"Shadow",value:"enableShadow",color:"white"},ae.toogle_MulLight={title:"MulLight",value:"enableMulLight",color:"white"},ae.toogle_Light={title:"Light",value:"enableLight",color:"white"},ae.toogle_Postprocess={title:"Postprocess",value:"enablePostprocess",color:"white"},ae.toogle_AnimatorUpdate={title:"AnimatorUpdate",value:"enableAnimatorUpdate",color:"white"},ae.toogle_PhysicsUpdate={title:"PhysicsUpdate",value:"enablePhysicsUpdate",color:"white"},ae.toogle_Skin={title:"Skin",value:"enableSkin",color:"white"},ae.toogle_Transparent={title:"Transparent",value:"enableTransparent",color:"white"},ae.toogle_Particle={title:"Particle",value:"enableParticle",color:"white"},ae.toogle_msaa={title:"MSAA",value:"enablemsaa",color:"white"},ae.toogle_CameraCMD={title:"CameraCMD",value:"enableCameraCMD",color:"white"},ae.toogle_Opaque={title:"Opaque",value:"enableOpaque",color:"white"},ae.AllToggle=[ae.toogle_Shadow,ae.toogle_Light,ae.toogle_MulLight,ae.toogle_Postprocess,ae.toogle_AnimatorUpdate,ae.toogle_PhysicsUpdate,ae.toogle_Opaque,ae.toogle_Transparent,ae.toogle_CameraCMD,ae.toogle_Skin,ae.toogle_Particle,ae.toogle_msaa],ae.RenderModeToggle=[ae.toogle_Shadow,ae.toogle_Light,ae.toogle_MulLight,ae.toogle_Postprocess,ae.toogle_AnimatorUpdate,ae.toogle_PhysicsUpdate],ae.RenderFuncToggle=[ae.toogle_Opaque,ae.toogle_Transparent,ae.toogle_CameraCMD,ae.toogle_Skin,ae.toogle_Particle,ae.toogle_msaa],ae.FPS=0,ae.loopCount=0,ae.spriteRenderUseCacheCount=0,ae.canvasNormal=0,ae.canvasBitmap=0,ae.canvasReCache=0,ae.renderSlow=!1,ae._timer=0,ae._count=0,ae._fpsStr="",ae.spriteCount=0,ae.sprite3DCount=0,ae.drawCall=0,ae.draw2D=0,ae.trianglesFaces=0,ae.renderNode=0,ae.meshRenderNode=0,ae.skinRenderNode=0,ae.particleRenderNode=0,ae.frustumCulling=0,ae.uniformUpload=0,ae.opaqueDrawCall=0,ae.transDrawCall=0,ae.depthCastDrawCall=0,ae.shadowMapDrawCall=0,ae.instanceDrawCall=0,ae.cmdDrawCall=0,ae.blitDrawCall=0,ae.renderPassStatArray=[],ae.enableRenderPassStatArray=!1,ae.textureMemory=0,ae.renderTextureMemory=0,ae.bufferMemory=0,ae.uploadUniform=0,ae.enableShadow=!0,ae.enableMulLight=!0,ae.enableLight=!0,ae.enableCameraCMD=!0,ae.enablePostprocess=!0,ae.enableSkin=!0,ae.enableTransparent=!0,ae.enableParticle=!0,ae.enableAnimatorUpdate=!0,ae.enablePhysicsUpdate=!0,ae.enablemsaa=!0,ae.enableOpaque=!0,window.Stat=ae,t.BufferTargetType=void 0,(Yt=t.BufferTargetType||(t.BufferTargetType={}))[Yt.ARRAY_BUFFER=0]="ARRAY_BUFFER",Yt[Yt.ELEMENT_ARRAY_BUFFER=1]="ELEMENT_ARRAY_BUFFER",Yt[Yt.UNIFORM_BUFFER=2]="UNIFORM_BUFFER",Yt[Yt.COPY_READ_BUFFER=3]="COPY_READ_BUFFER",Yt[Yt.COPY_WRITE_BUFFER=4]="COPY_WRITE_BUFFER",Yt[Yt.TRANSFORM_FEEDBACK_BUFFER=5]="TRANSFORM_FEEDBACK_BUFFER",t.BufferUsage=void 0,(Xt=t.BufferUsage||(t.BufferUsage={}))[Xt.Static=0]="Static",Xt[Xt.Dynamic=1]="Dynamic",Xt[Xt.Stream=2]="Stream",t.DrawType=void 0,(jt=t.DrawType||(t.DrawType={}))[jt.DrawArray=0]="DrawArray",jt[jt.DrawArrayInstance=1]="DrawArrayInstance",jt[jt.DrawElement=2]="DrawElement",jt[jt.DrawElementInstance=3]="DrawElementInstance",t.IndexFormat=void 0,(qt=t.IndexFormat||(t.IndexFormat={}))[qt.UInt8=0]="UInt8",qt[qt.UInt16=1]="UInt16",qt[qt.UInt32=2]="UInt32",t.MeshTopology=void 0,($t=t.MeshTopology||(t.MeshTopology={}))[$t.Points=0]="Points",$t[$t.Lines=1]="Lines",$t[$t.LineLoop=2]="LineLoop",$t[$t.LineStrip=3]="LineStrip",$t[$t.Triangles=4]="Triangles",$t[$t.TriangleStrip=5]="TriangleStrip",$t[$t.TriangleFan=6]="TriangleFan";const ne=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];class le{static restoreTempArray(){ne[0]=1,ne[1]=0,ne[4]=0,ne[5]=1,ne[12]=0,ne[13]=0}static clear(){le.worldAlpha=1}}le.worldMatrix4=ne,le.worldMatrix=new G,le.matWVP=null,le.worldAlpha=1,le.worldScissorTest=!1,le.width=0,le.height=0,le.InvertY=!1;class oe{constructor(t=null){this._renderTexture=null,this._renderTexture=t}setRenderTarget(t){}get out(){return this._renderTexture}}class he extends oe{constructor(t=null){super(t),he.rendercontext2D||(he.rendercontext2D=l.render2DRenderPassFactory.createRenderContext2D()),this._renderElement=l.render2DRenderPassFactory.createRenderElement2D()}clone(t){return new he(t)}_createMesh(e){let i=l.renderDeviceFactory.createRenderGeometryElement(t.MeshTopology.Triangles,t.DrawType.DrawElement),s=l.renderDeviceFactory.createBufferState();i.bufferState=s;let r=l.renderDeviceFactory.createVertexBuffer(t.BufferUsage.Dynamic);r.vertexDeclaration=e;let a=l.renderDeviceFactory.createIndexBuffer(t.BufferUsage.Dynamic);return s.applyState([r],a),i.indexFormat=t.IndexFormat.UInt16,i}getGeo(t){let e=he._geoMap[t.id];return null==e&&(e=this._createMesh(t),he._geoMap[t.id]=e),e}renderStart(t,e){this._renderTexture?(he.rendercontext2D.invertY=this._renderTexture._invertY,he.rendercontext2D.setRenderTarget(this._renderTexture._renderTarget,t,e)):(he.rendercontext2D.invertY=!1,he.rendercontext2D.setOffscreenView(le.width,le.height),he.rendercontext2D.setRenderTarget(null,t,e)),pt._clear=!1}setRenderTarget(t){he.rendercontext2D.setRenderTarget(null==t?void 0:t._renderTarget,!1,pt._clearColor)}drawMesh(t,e){ae.draw2D++,this._renderElement.geometry=t,this._renderElement.value2DShaderData=e.shaderData,this._renderElement.subShader=e._shader.getSubShaderAt(0),this._renderElement.materialShaderData=e.shaderData,he.rendercontext2D.drawRenderElementOne(this._renderElement)}drawElement(t){he.rendercontext2D.drawRenderElementOne(t)}draw(t,e,i,s,r,a,n){ae.draw2D++;let l=this.getGeo(t.vertexDeclarition),o=l.bufferState,h=o._vertexBuffers[0],u=o._bindedIndexBuffer;h.setDataLength(i),h.setData(t.vbBuffer,e,0,i),u._setIndexDataLength(r),u._setIndexData(new Uint16Array(t.ibBuffer,s,r/2),0),l.clearRenderParams(),l.setDrawElemenParams(r/2,0);let d=n;this._renderElement.geometry=l,this._renderElement.value2DShaderData=a.shaderData,d?(this._renderElement.subShader=d._shader.getSubShaderAt(0),this._renderElement.materialShaderData=d.shaderData):(this._renderElement.subShader=a._defaultShader.getSubShaderAt(0),this._renderElement.materialShaderData=null),he.rendercontext2D.drawRenderElementOne(this._renderElement)}renderEnd(){}}he._geoMap={};class ue{constructor(){this.elements=[],this.length=0}_add(t){this.length===this.elements.length?this.elements.push(t):this.elements[this.length]=t}add(t){let e=this.elements.indexOf(t);"number"!=typeof t&&-1!=e&&e<this.length||(this.length===this.elements.length?this.elements.push(t):this.elements[this.length]=t,this.length++)}indexof(t){let e=this.elements.indexOf(t);return-1!=e&&e<this.length?e:-1}remove(t){let e=this.elements.indexOf(t);-1!=e&&e<this.length&&(this.elements[e]=this.elements[this.length-1],this.elements[this.length-1]=null,this.length--)}clear(){this.elements=[],this.length=0}clean(){this.elements.length=this.length}destroy(){this.elements=null}}class de extends ue{add(t){this._add(t),this.length++}}class ce{constructor(){this.batchFun=null,this.batch=!1,this.indexStart=-1,this.elementLenth=0}static create(){return 0!=this._pool.length?this._pool.pop():new ce}static recover(t){this._pool.push(t)}}ce._pool=[];class _e{static regisBatch(t,e){if(_e._batchMapManager[t])throw"Overlapping batch optimization";_e._batchMapManager[t]=e}get list(){return this._list}set list(t){this._list=t}constructor(){this._lastRenderNodeType=-1,this._renderEnd=!0,this.list=new de,this._renderElementList=new de,this._batchInfoList=new de}addRenderObject(t){this.list.add(t)}removeRenderObject(t){this.list.remove(t)}clearList(){this._list.clear(),this._renderElementList.clear();for(var t=0,e=this._batchInfoList.length;t<e;t++){let e=this._batchInfoList.elements[t];e.batch&&e.batchFun.recover(),ce.recover(e)}this._batchInfoList.clear()}renderUpdate(){var t=he.rendercontext2D;let e=this._list.elements;for(let i=0,s=this._list.length;i<s;i++){let s=e[i];s.renderUpdate&&s._renderUpdateMask!=ae.loopCount&&(s.renderUpdate(t),s._renderUpdateMask=ae.loopCount)}}render(t){this.renderUpdate();for(var e=0,i=this._list.length;e<i;e++)this._cull(this._list.elements[e],t);this._batch(),t.drawRenderElementList(this._renderElementList),this.endRender()}_cull(t,e){{t.preRenderUpdate&&t.preRenderUpdate(e);let s=t._renderElements.length;if(1==s)this._batchStart(t._renderType,1),this._renderElementList.add(t._renderElements[0]);else{this._batchStart(t._renderType,s);for(var i=0;i<s;i++)this._renderElementList.add(t._renderElements[i])}}}_batch(){this._batchInfoList.add(this._lastbatch2DInfo),this._renderElementList.length=0;for(var t=0,e=this._batchInfoList.length;t<e;t++){let e=this._batchInfoList.elements[t];if(e.batch)e.batchFun.batchRenderElement(this._renderElementList,e.indexStart,e.elementLenth);else for(let t=e.indexStart,i=e.elementLenth+e.indexStart;t<i;t++)this._renderElementList.add(this._renderElementList.elements[t])}}_batchStart(t,e){if(-1==this._lastRenderNodeType)return this._lastbatch2DInfo=ce.create(),this._lastbatch2DInfo.batch=!1,this._lastbatch2DInfo.batchFun=_e._batchMapManager[t],this._lastbatch2DInfo.indexStart=0,this._lastbatch2DInfo.elementLenth=e,void(this._lastRenderNodeType=t);this._lastRenderNodeType==t?(this._lastbatch2DInfo.batch=!!this._lastbatch2DInfo.batchFun,this._lastbatch2DInfo.elementLenth+=e):(this._batchInfoList.add(this._lastbatch2DInfo),this._lastbatch2DInfo=ce.create(),this._lastbatch2DInfo.batch=!1,this._lastbatch2DInfo.batchFun=_e._batchMapManager[t],this._lastbatch2DInfo.indexStart=this._renderElementList.length,this._lastbatch2DInfo.elementLenth=e,this._lastRenderNodeType=t)}endRender(){this.clearList(),this._renderEnd=!0,this._lastRenderNodeType=-1}}var pe,fe,ge,me,ye,Te,xe;_e._batchMapManager={},t.BlendEquationSeparate=void 0,(pe=t.BlendEquationSeparate||(t.BlendEquationSeparate={}))[pe.ADD=0]="ADD",pe[pe.SUBTRACT=1]="SUBTRACT",pe[pe.REVERSE_SUBTRACT=2]="REVERSE_SUBTRACT",pe[pe.MIN=3]="MIN",pe[pe.MAX=4]="MAX",t.BlendFactor=void 0,(fe=t.BlendFactor||(t.BlendFactor={}))[fe.Zero=0]="Zero",fe[fe.One=1]="One",fe[fe.SourceColor=2]="SourceColor",fe[fe.OneMinusSourceColor=3]="OneMinusSourceColor",fe[fe.DestinationColor=4]="DestinationColor",fe[fe.OneMinusDestinationColor=5]="OneMinusDestinationColor",fe[fe.SourceAlpha=6]="SourceAlpha",fe[fe.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",fe[fe.DestinationAlpha=8]="DestinationAlpha",fe[fe.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",fe[fe.SourceAlphaSaturate=10]="SourceAlphaSaturate",fe[fe.BlendColor=11]="BlendColor",fe[fe.OneMinusBlendColor=12]="OneMinusBlendColor",t.BlendType=void 0,(ge=t.BlendType||(t.BlendType={}))[ge.BLEND_DISABLE=0]="BLEND_DISABLE",ge[ge.BLEND_ENABLE_ALL=1]="BLEND_ENABLE_ALL",ge[ge.BLEND_ENABLE_SEPERATE=2]="BLEND_ENABLE_SEPERATE",t.CompareFunction=void 0,(me=t.CompareFunction||(t.CompareFunction={}))[me.Never=0]="Never",me[me.Less=1]="Less",me[me.Equal=2]="Equal",me[me.LessEqual=3]="LessEqual",me[me.Greater=4]="Greater",me[me.NotEqual=5]="NotEqual",me[me.GreaterEqual=6]="GreaterEqual",me[me.Always=7]="Always",me[me.Off=8]="Off",t.CullMode=void 0,(ye=t.CullMode||(t.CullMode={}))[ye.Off=0]="Off",ye[ye.Front=1]="Front",ye[ye.Back=2]="Back",t.FrontFace=void 0,(Te=t.FrontFace||(t.FrontFace={}))[Te.CW=0]="CW",Te[Te.CCW=1]="CCW",t.StencilOperation=void 0,(xe=t.StencilOperation||(t.StencilOperation={}))[xe.Keep=0]="Keep",xe[xe.Zero=1]="Zero",xe[xe.Replace=2]="Replace",xe[xe.IncrementSaturate=3]="IncrementSaturate",xe[xe.DecrementSaturate=4]="DecrementSaturate",xe[xe.Invert=5]="Invert",xe[xe.IncrementWrap=6]="IncrementWrap",xe[xe.DecrementWrap=7]="DecrementWrap";class ve{get cull(){return this._cull}set cull(t){this._cull=t}get blend(){return this._blend}set blend(t){this._blend=t}get srcBlend(){return this._srcBlend}set srcBlend(t){this._srcBlend=t}get dstBlend(){return this._dstBlend}set dstBlend(t){this._dstBlend=t}get srcBlendRGB(){return this._srcBlendRGB}set srcBlendRGB(t){this._srcBlendRGB=t}get dstBlendRGB(){return this._dstBlendRGB}set dstBlendRGB(t){this._dstBlendRGB=t}get srcBlendAlpha(){return this._srcBlendAlpha}set srcBlendAlpha(t){this._srcBlendAlpha=t}get dstBlendAlpha(){return this._dstBlendAlpha}set dstBlendAlpha(t){this._dstBlendAlpha=t}get blendEquation(){return this._blendEquation}set blendEquation(t){this._blendEquation=t}get blendEquationRGB(){return this._blendEquationRGB}set blendEquationRGB(t){this._blendEquationRGB=t}get blendEquationAlpha(){return this._blendEquationAlpha}set blendEquationAlpha(t){this._blendEquationAlpha=t}get depthTest(){return this._depthTest}set depthTest(t){this._depthTest=t}get depthWrite(){return this._depthWrite}set depthWrite(t){this._depthWrite=t}get stencilWrite(){return this._stencilWrite}set stencilWrite(t){this._stencilWrite=t}get stencilTest(){return this._stencilTest}set stencilTest(t){this._stencilTest=t}get stencilRef(){return this._stencilRef}set stencilRef(t){this._stencilRef=t}get stencilOp(){return this._stencilOp}set stencilOp(t){this._stencilOp=t}createObj(){}constructor(){this._stencilOp=new d,this.createObj(),this.cull=ve.CULL_BACK,this.blend=ve.BLEND_DISABLE,this.srcBlend=ve.BLENDPARAM_ONE,this.dstBlend=ve.BLENDPARAM_ZERO,this.srcBlendRGB=ve.BLENDPARAM_ONE,this.dstBlendRGB=ve.BLENDPARAM_ZERO,this.srcBlendAlpha=ve.BLENDPARAM_ONE,this.dstBlendAlpha=ve.BLENDPARAM_ZERO,this.blendEquation=ve.BLENDEQUATION_ADD,this.blendEquationRGB=ve.BLENDEQUATION_ADD,this.blendEquationAlpha=ve.BLENDEQUATION_ADD,this.depthTest=ve.DEPTHTEST_LEQUAL,this.depthWrite=!0,this.stencilRef=1,this.stencilTest=ve.STENCILTEST_OFF,this.stencilWrite=!1,this.stencilOp=new d(ve.STENCILOP_KEEP,ve.STENCILOP_KEEP,ve.STENCILOP_REPLACE)}setNull(){this.cull=null,this.blend=null,this.srcBlend=null,this.dstBlend=null,this.srcBlendRGB=null,this.dstBlendRGB=null,this.srcBlendAlpha=null,this.dstBlendAlpha=null,this.blendEquation=null,this.blendEquationRGB=null,this.blendEquationAlpha=null,this.depthTest=null,this.depthWrite=null,this.stencilRef=null,this.stencilTest=null,this.stencilWrite=null,this.stencilOp.set(null,null,null)}cloneTo(t){t.cull=this.cull,t.blend=this.blend,t.srcBlend=this.srcBlend,t.dstBlend=this.dstBlend,t.srcBlendRGB=this.srcBlendRGB,t.dstBlendRGB=this.dstBlendRGB,t.srcBlendAlpha=this.srcBlendAlpha,t.dstBlendAlpha=this.dstBlendAlpha,t.blendEquation=this.blendEquation,t.blendEquationRGB=this.blendEquationRGB,t.blendEquationAlpha=this.blendEquationAlpha,t.depthTest=this.depthTest,t.depthWrite=this.depthWrite,t.stencilRef=this.stencilRef,t.stencilTest=this.stencilTest,t.stencilWrite=this.stencilWrite,this.stencilOp.cloneTo(t.stencilOp)}clone(){var t=new ve;return this.cloneTo(t),t}}ve.CULL_NONE=t.CullMode.Off,ve.CULL_FRONT=t.CullMode.Front,ve.CULL_BACK=t.CullMode.Back,ve.BLEND_DISABLE=t.BlendType.BLEND_DISABLE,ve.BLEND_ENABLE_ALL=t.BlendType.BLEND_ENABLE_ALL,ve.BLEND_ENABLE_SEPERATE=t.BlendType.BLEND_ENABLE_SEPERATE,ve.BLENDPARAM_ZERO=t.BlendFactor.Zero,ve.BLENDPARAM_ONE=t.BlendFactor.One,ve.BLENDPARAM_SRC_COLOR=t.BlendFactor.SourceColor,ve.BLENDPARAM_ONE_MINUS_SRC_COLOR=t.BlendFactor.OneMinusSourceColor,ve.BLENDPARAM_DST_COLOR=t.BlendFactor.DestinationColor,ve.BLENDPARAM_ONE_MINUS_DST_COLOR=t.BlendFactor.OneMinusDestinationColor,ve.BLENDPARAM_SRC_ALPHA=t.BlendFactor.SourceAlpha,ve.BLENDPARAM_ONE_MINUS_SRC_ALPHA=t.BlendFactor.OneMinusSourceAlpha,ve.BLENDPARAM_DST_ALPHA=t.BlendFactor.DestinationAlpha,ve.BLENDPARAM_ONE_MINUS_DST_ALPHA=t.BlendFactor.OneMinusDestinationAlpha,ve.BLENDPARAM_SRC_ALPHA_SATURATE=t.BlendFactor.SourceAlphaSaturate,ve.BLENDPARAM_BLENDCOLOR=t.BlendFactor.BlendColor,ve.BLENDPARAM_BLEND_ONEMINUS_COLOR=t.BlendFactor.OneMinusBlendColor,ve.BLENDEQUATION_ADD=t.BlendEquationSeparate.ADD,ve.BLENDEQUATION_SUBTRACT=t.BlendEquationSeparate.SUBTRACT,ve.BLENDEQUATION_REVERSE_SUBTRACT=t.BlendEquationSeparate.REVERSE_SUBTRACT,ve.BLENDEQUATION_MIN=t.BlendEquationSeparate.MIN,ve.BLENDEQUATION_MAX=t.BlendEquationSeparate.MAX,ve.DEPTHTEST_OFF=t.CompareFunction.Off,ve.DEPTHTEST_NEVER=t.CompareFunction.Never,ve.DEPTHTEST_LESS=t.CompareFunction.Less,ve.DEPTHTEST_EQUAL=t.CompareFunction.Equal,ve.DEPTHTEST_LEQUAL=t.CompareFunction.LessEqual,ve.DEPTHTEST_GREATER=t.CompareFunction.Greater,ve.DEPTHTEST_NOTEQUAL=t.CompareFunction.NotEqual,ve.DEPTHTEST_GEQUAL=t.CompareFunction.GreaterEqual,ve.DEPTHTEST_ALWAYS=t.CompareFunction.Always,ve.STENCILTEST_OFF=t.CompareFunction.Off,ve.STENCILTEST_NEVER=t.CompareFunction.Never,ve.STENCILTEST_LESS=t.CompareFunction.Less,ve.STENCILTEST_EQUAL=t.CompareFunction.Equal,ve.STENCILTEST_LEQUAL=t.CompareFunction.LessEqual,ve.STENCILTEST_GREATER=t.CompareFunction.Greater,ve.STENCILTEST_NOTEQUAL=t.CompareFunction.NotEqual,ve.STENCILTEST_GEQUAL=t.CompareFunction.GreaterEqual,ve.STENCILTEST_ALWAYS=t.CompareFunction.Always,ve.STENCILOP_KEEP=t.StencilOperation.Keep,ve.STENCILOP_ZERO=t.StencilOperation.Zero,ve.STENCILOP_REPLACE=t.StencilOperation.Replace,ve.STENCILOP_INCR=t.StencilOperation.IncrementSaturate,ve.STENCILOP_INCR_WRAP=t.StencilOperation.IncrementWrap,ve.STENCILOP_DECR=t.StencilOperation.DecrementSaturate,ve.STENCILOP_DECR_WRAP=t.StencilOperation.DecrementWrap,ve.STENCILOP_INVERT=t.StencilOperation.Invert,ve.Default=new ve;class Se{static splitToWords(t,e){for(var i,s,r=[],a=-1,n=0,l=t.length;n<l;n++)if(i=t.charAt(n)," \t=+-*/&%!<>()'\",;".indexOf(i)>=0){if(a>=0&&n-a>1&&(s=t.substr(a,n-a),r.push(s)),'"'==i||"'"==i){var o=t.indexOf(i,n+1);if(o<0)throw"Sharder err:"+t;r.push(t.substr(n+1,o-n-1)),n=o,a=-1;continue}"("==i&&e&&r.length>0&&(s=r[r.length-1]+";","vec4;main;".indexOf(s)<0&&(e.useFuns+=s)),a=-1}else a<0&&(a=n);return a<l&&l-a>1&&(s=t.substr(a,l-a),r.push(s)),r}constructor(t){this.codes={},this.funs={},this.curUseID=-1,this.funnames="",this.script=t;for(var e,i,s=0;!((s=t.indexOf("#begin",s))<0);){for(i=s+5;!((i=t.indexOf("#end",i))<0)&&"i"===t.charAt(i+4);)i+=5;if(i<0)throw"add include err,no #end:"+t;e=t.indexOf("\n",s);var r=Se.splitToWords(t.substr(s,e-s),null);"code"==r[1]?this.codes[r[2]]=t.substr(e+1,i-e-1):"function"==r[1]&&(e=t.indexOf("function",s),e+=8,this.funs[r[3]]=t.substr(e+1,i-e-1),this.funnames+=r[3]+";"),s=i+1}}getWith(t=null){var e=t?this.codes[t]:this.script;if(!e)throw"get with error:"+t;return e}getFunsScript(t){var e="";for(var i in this.funs)t.indexOf(i+";")>=0&&(e+=this.funs[i]);return e}}class Ee{constructor(t){this.childs=[],this.text="",this.useFuns="",this.z=0,this.includefiles=t}setParent(t){t.childs.push(this),this.z=t.z+1,this.parent=t}setCondition(t,e){t&&(this.conditionType=e,t=t.replace(/(\s*$)/g,""),this.condition=function(){return this[t]},this.condition.__condition=t)}toscript(t,e){return this._toscript(t,e,++Ee.__id)}_toscript(t,e,i){if(this.childs.length<1&&!this.text)return e;if(e.length,this.condition){var s=!!this.condition.call(t);if(2===this.conditionType&&(s=!s),!s&&Ee.__noCompileEnable)return e}if(!this.noCompile&&Ee.__noCompileEnable||this.text&&e.push(this.text),this.childs.length>0&&this.childs.forEach((function(s,r,a){s._toscript(t,e,i)})),this.includefiles.length>0&&this.useFuns.length>0)for(var r,a=0,n=this.includefiles.length;a<n;a++)this.includefiles[a].curUseID!=i&&(r=this.includefiles[a].file.getFunsScript(this.useFuns)).length>0&&(this.includefiles[a].curUseID=i,e[0]=r+e[0]);return e}}Ee.__id=1,Ee.__noCompileEnable=!0;const we=new RegExp("\r","g"),De=new RegExp("[ \\t=\\+\\-*/&%!<>!%(),;\\|]","g"),be={Back:t.CullMode.Back,Front:t.CullMode.Front,Off:t.CullMode.Off},Ce={Disable:t.BlendType.BLEND_DISABLE,All:t.BlendType.BLEND_ENABLE_ALL,Seperate:t.BlendType.BLEND_ENABLE_SEPERATE},Re={Zero:t.BlendFactor.Zero,One:t.BlendFactor.One,SourceColor:t.BlendFactor.SourceColor,OneMinusSourceColor:t.BlendFactor.OneMinusSourceColor,DestinationColor:t.BlendFactor.DestinationColor,OneMinusDestinationColor:t.BlendFactor.OneMinusDestinationColor,SourceAlpha:t.BlendFactor.SourceAlpha,OneMinusSourceAlpha:t.BlendFactor.OneMinusSourceAlpha,DestinationAlpha:t.BlendFactor.DestinationAlpha,OneMinusDestinationAlpha:t.BlendFactor.OneMinusDestinationAlpha,SourceAlphaSaturate:t.BlendFactor.SourceAlphaSaturate,BlendColor:t.BlendFactor.BlendColor,OneMinusBlendColor:t.BlendFactor.OneMinusBlendColor},Ae={Add:t.BlendEquationSeparate.ADD,Subtract:t.BlendEquationSeparate.SUBTRACT,Reverse_substract:t.BlendEquationSeparate.REVERSE_SUBTRACT,Min:t.BlendEquationSeparate.MIN,Max:t.BlendEquationSeparate.MAX},Ie={Never:t.CompareFunction.Never,Less:t.CompareFunction.Less,Equal:t.CompareFunction.Equal,LessEqual:t.CompareFunction.LessEqual,Greater:t.CompareFunction.Greater,NotEqual:t.CompareFunction.NotEqual,GreaterEqual:t.CompareFunction.GreaterEqual,Always:t.CompareFunction.Always,Off:t.CompareFunction.Off},Me={Keep:t.StencilOperation.Keep,Zero:t.StencilOperation.Zero,Replace:t.StencilOperation.Replace,IncrementSaturate:t.StencilOperation.IncrementSaturate,DecrementSaturate:t.StencilOperation.DecrementSaturate,Invert:t.StencilOperation.Invert,IncrementWrap:t.StencilOperation.IncrementWrap,DecrementWrap:t.StencilOperation.DecrementWrap};class Be{static addInclude(t,e,i){if(!e||0===e.length)return console.error("shader include file err:"+t),null;if(!i&&Be.includes[t])return console.warn("shader include file already exists:"+t),Be.includes[t];e=e.replace(we,"");let s=new Se(e);return Be.includes[t]=s,s}static compile(t,e,i){let s={vsNode:new Ee([]),psNode:new Ee([]),includeNames:new Set,defs:new Set},r=[];t=t.replace(we,""),e=e.replace(we,""),Be._compileToTree(s.vsNode,t,s.defs,r,i),Be._compileToTree(s.psNode,e,s.defs,r,i);for(let t of r)t.file?s.includeNames.add(t.name):console.warn(`ShaderCompile missing file ${t.name}`);return s}static compileAsync(t,e,i){let s={vsNode:new Ee([]),psNode:new Ee([]),includeNames:new Set,defs:new Set},r=[];return t=t.replace(we,""),e=e.replace(we,""),Be._compileToTree(s.vsNode,t,s.defs,r,i),Be._compileToTree(s.psNode,e,s.defs,r,i),this._loadIncludesDeep(s,r,0)}static _loadIncludesDeep(t,i,s){let r,a=i.length;for(let e=s;e<a;e++){let s=i[e];s.file?t.includeNames.add(s.name):(r||(r=[]),r.push(s))}return r?e.loader.load(r.map((t=>t.name))).then((e=>{let s=r.length;for(let a=0;a<s;a++){let s=r[a],n=e[a];if(n){t.includeNames.add(s.name);let e=n.getWith(s.codeName);s.node.condition?s.node.text=e:(Be._compileToTree(s.node,e,t.defs,i,O.getPath(s.name)),s.node.text="")}else{let t=s.node.parent.childs;t.splice(t.indexOf(s.node),1)}}return i.length>a?Be._loadIncludesDeep(t,i,a):t})):Promise.resolve(t)}static _compileToTree(t,e,i,s,r){let a,n,l,o,h,u,d,c,_,p,f=e.split("\n");for(c=0;c<f.length;c++)if(l=f[c],!(l.length<1)&&(u=l.indexOf("//"),0!==u))if(u>=0&&(l=l.substr(0,u)),(u=l.indexOf("#"))<0){n=t.childs[t.childs.length-1];let e=t.includefiles;if(n&&!n.name){e.length>0&&Se.splitToWords(l,n),n.text+="\n"+l;continue}a=new Ee(e),a.text=l,a.noCompile=!0,e.length>0&&Se.splitToWords(l,a),a.setParent(t)}else{for(a=new Ee(t.includefiles),a.text=l,a.noCompile=!0,o="#",p=u+1,_=l.length;p<_;p++){let t=l.charAt(p);if(" "===t||"\t"===t||"?"===t)break;o+=t}switch(a.name=o,o){case"#ifdef":case"#ifndef":for(a.src=l,a.noCompile=null!=l.match(/[!&|()=<>]/),a.noCompile?console.log("function():Boolean{return "+l.substr(u+a.name.length)+"}"):(d=l.replace(/^\s*/,"").split(/\s+/),a.setCondition(d[1],"#ifdef"===o?Be.IFDEF_YES:Be.IFDEF_ELSE),a.text=a.text),a.setParent(t),t=a,d=l.substr(p).split(De),p=0;p<d.length;p++)l=d[p],l.length&&i.add(l);break;case"#if":case"#elif":for(a.src=l,a.noCompile=!0,"#elif"==o&&(n=(t=t.parent).childs[t.childs.length-1],n.text=n.src,n.noCompile=!0,n.condition=null),a.setParent(t),t=a,d=l.substr(p).split(De),p=0;p<d.length;p++)l=d[p],l.length&&"defined"!=l&&i.add(l);break;case"#else":a.src=l,n=(t=t.parent).childs[t.childs.length-1],a.noCompile=n.noCompile,a.noCompile||(a.condition=n.condition,a.conditionType=n.conditionType==Be.IFDEF_YES?Be.IFDEF_ELSE:Be.IFDEF_YES),a.setParent(t),t=a;break;case"#endif":n=(t=t.parent).childs[t.childs.length-1],a.noCompile=n.noCompile,a.noCompile||(a.text=a.text),a.setParent(t);break;case"#include":d=Se.splitToWords(l,null);let e,c=d[1];c.startsWith(".")?c=O.join(r,c):c.startsWith("/")?c=O.formatURL(c.substring(1)):(e=Be.includes[c],e||(c="internal/"+c)),e=Be.includes[c],!e&&Be.loadIncludeFileSync&&(Be.loadIncludeFileSync(c),e=Be.includes[c]);let _="with"==d[2]?d[3]:null;s.push({name:c,codeName:_,node:a,file:e}),a.setParent(t),(u=d[0].indexOf("?"))<0?(e&&(l=e.getWith(_),this._compileToTree(a,l,i,s,O.getPath(c))),a.text=""):(a.setCondition(d[0].substr(u+1),Be.IFDEF_YES),e&&(a.text=e.getWith(_)));break;case"#import":d=Se.splitToWords(l,null),h=d[1],a.includefiles.push({node:a,file:Be.includes[h],ofs:a.text.length});break;default:a.setParent(t)}}}static getRenderState(t,e){if(!t)return;e.cull=be[t.cull],e.blend=Ce[t.blend],e.srcBlend=Re[t.srcBlend],e.dstBlend=Re[t.dstBlend],e.srcBlendRGB=Re[t.srcBlendRGB],e.dstBlendRGB=Re[t.dstBlendRGB],e.srcBlendAlpha=Re[t.srcBlendAlpha],e.dstBlendAlpha=Re[t.dstBlendAlpha],e.blendEquation=Ae[t.blendEquation],e.blendEquationRGB=Ae[t.blendEquationRGB],e.blendEquationAlpha=Ae[t.blendEquationAlpha],e.depthTest=Ie[t.depthTest],e.depthWrite=t.depthWrite,e.stencilRef=t.stencilRef,e.stencilTest=Ie[t.stencilTest],e.stencilWrite=t.stencilWrite;let i=t.stencilOp,s=i?i[0]:null,r=i?i[1]:null,a=i?i[2]:null;e.stencilOp.x=Me[s],e.stencilOp.y=Me[r],e.stencilOp.z=Me[a]}}Be.IFDEF_NO=0,Be.IFDEF_YES=1,Be.IFDEF_ELSE=2,Be.IFDEF_PARENT=3,Be.includes={};const Le=new Float32Array([1,0,0,0,1,0,0,0,1]),Pe=new d,Ne=new d,Oe=new d;class Fe{static createRotationQuaternion(t,e){var i=t.x,s=t.y,r=t.z,a=t.w,n=i*i,l=s*s,o=r*r,h=i*s,u=r*a,d=r*i,c=s*a,_=s*r,p=i*a,f=e.elements;f[0]=1-2*(l+o),f[1]=2*(h+u),f[2]=2*(d-c),f[3]=2*(h-u),f[4]=1-2*(o+n),f[5]=2*(_+p),f[6]=2*(d+c),f[7]=2*(_-p),f[8]=1-2*(l+n)}static createFromTranslation(t,e){var i=e.elements;i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=1,i[5]=0,i[6]=t.x,i[7]=t.y,i[8]=1}static createFromRotation(t,e){var i=e.elements,s=Math.sin(t),r=Math.cos(t);i[0]=r,i[1]=s,i[2]=0,i[3]=-s,i[4]=r,i[5]=0,i[6]=0,i[7]=0,i[8]=1}static createFromScaling(t,e){var i=e.elements;i[0]=t.x,i[1]=0,i[2]=0,i[3]=0,i[4]=t.y,i[5]=0,i[6]=0,i[7]=0,i[8]=t.z}static createFromMatrix4x4(t,e){var i=t.elements,s=e.elements;s[0]=i[0],s[1]=i[1],s[2]=i[2],s[3]=i[4],s[4]=i[5],s[5]=i[6],s[6]=i[8],s[7]=i[9],s[8]=i[10]}static multiply(t,e,i){var s=t.elements,r=e.elements,a=i.elements,n=s[0],l=s[1],o=s[2],h=s[3],u=s[4],d=s[5],c=s[6],_=s[7],p=s[8],f=r[0],g=r[1],m=r[2],y=r[3],T=r[4],x=r[5],v=r[6],S=r[7],E=r[8];a[0]=f*n+g*h+m*c,a[1]=f*l+g*u+m*S,a[2]=f*o+g*d+m*p,a[3]=y*n+T*h+x*c,a[4]=y*l+T*u+x*_,a[5]=y*o+T*d+x*p,a[6]=v*n+S*h+E*c,a[7]=v*l+S*u+E*_,a[8]=v*o+S*d+E*p}constructor(t=!0){t&&(this.elements=Le.slice())}cloneByArray(t){this.elements.set(t)}determinant(){var t=this.elements,e=t[0],i=t[1],s=t[2],r=t[3],a=t[4],n=t[5],l=t[6],o=t[7],h=t[8];return e*(h*a-n*o)+i*(-h*r+n*l)+s*(o*r-a*l)}translate(t,e){var i=e.elements,s=this.elements,r=s[0],a=s[1],n=s[2],l=s[3],o=s[4],h=s[5],u=s[6],d=s[7],c=s[8],_=t.x,p=t.y;i[0]=r,i[1]=a,i[2]=n,i[3]=l,i[4]=o,i[5]=h,i[6]=_*r+p*l+u,i[7]=_*a+p*o+d,i[8]=_*n+p*h+c}rotate(t,e){var i=e.elements,s=this.elements,r=s[0],a=s[1],n=s[2],l=s[3],o=s[4],h=s[5],u=s[6],d=s[7],c=s[8],_=Math.sin(t),p=Math.cos(t);i[0]=p*r+_*l,i[1]=p*a+_*o,i[2]=p*n+_*h,i[3]=p*l-_*r,i[4]=p*o-_*a,i[5]=p*h-_*n,i[6]=u,i[7]=d,i[8]=c}scale(t,e){var i=e.elements,s=this.elements,r=t.x,a=t.y;i[0]=r*s[0],i[1]=r*s[1],i[2]=r*s[2],i[3]=a*s[3],i[4]=a*s[4],i[5]=a*s[5],i[6]=s[6],i[7]=s[7],i[8]=s[8]}invert(t){var e=t.elements,i=this.elements,s=i[0],r=i[1],a=i[2],n=i[3],l=i[4],o=i[5],h=i[6],u=i[7],d=i[8],c=d*l-o*u,_=-d*n+o*h,p=u*n-l*h,f=s*c+r*_+a*p;f&&(f=1/f,e[0]=c*f,e[1]=(-d*r+a*u)*f,e[2]=(o*r-a*l)*f,e[3]=_*f,e[4]=(d*s-a*h)*f,e[5]=(-o*s+a*n)*f,e[6]=p*f,e[7]=(-u*s+r*h)*f,e[8]=(l*s-r*n)*f)}transpose(t){var e=t.elements,i=this.elements;if(t===this){var s=i[1],r=i[2],a=i[5];e[1]=i[3],e[2]=i[6],e[3]=s,e[5]=i[7],e[6]=r,e[7]=a}else e[0]=i[0],e[1]=i[3],e[2]=i[6],e[3]=i[1],e[4]=i[4],e[5]=i[7],e[6]=i[2],e[7]=i[5],e[8]=i[8]}identity(){this.elements.set(Le)}cloneTo(t){var e,i;(e=this.elements)!==(i=t.elements)&&i.set(e)}clone(){var t=new Fe(!1);return t.elements=this.elements.slice(),t}static lookAt(t,e,i,s){d.subtract(t,e,Pe),d.normalize(Pe,Pe),d.cross(i,Pe,Ne),d.normalize(Ne,Ne),d.cross(Pe,Ne,Oe);var r=Pe,a=Ne,n=Oe,l=s.elements;l[0]=a.x,l[3]=a.y,l[6]=a.z,l[1]=n.x,l[4]=n.y,l[7]=n.z,l[2]=r.x,l[5]=r.y,l[8]=r.z}static forwardLookAt(t,e,i,s){var r=Ne,a=Oe,n=Pe;e.vsub(t,n).normalize(),i.cross(n,r).normalize(),n.cross(r,a);var l=s.elements;l[0]=r.x,l[1]=r.y,l[2]=r.z,l[3]=a.x,l[4]=a.y,l[5]=a.z,l[6]=n.x,l[7]=n.y,l[8]=n.z}}Fe.DEFAULT=new Fe,Fe.Temp=new Fe;const Ue=new d,ke=new d,Ge=new d,Ve=new d,He=new Fe;class ze{static createFromYawPitchRoll(t,e,i,s){var r=.5*i,a=.5*e,n=.5*t,l=Math.sin(r),o=Math.cos(r),h=Math.sin(a),u=Math.cos(a),d=Math.sin(n),c=Math.cos(n);s.x=c*h*o+d*u*l,s.y=d*u*o-c*h*l,s.z=c*u*l-d*h*o,s.w=c*u*o+d*h*l}static multiply(t,e,i){var s=t.x,r=t.y,a=t.z,n=t.w,l=e.x,o=e.y,h=e.z,u=e.w,d=r*h-a*o,c=a*l-s*h,_=s*o-r*l,p=s*l+r*o+a*h;i.x=s*u+l*n+d,i.y=r*u+o*n+c,i.z=a*u+h*n+_,i.w=n*u-p}static rotationAxisAngle(t,e,i){const s=d._tempVector3;d.normalize(t,s),e*=.5;const r=Math.sin(e);i.x=s.x*r,i.y=s.y*r,i.z=s.z*r,i.w=Math.cos(e)}static arcTanAngle(t,e){return 0==t?1==e?Math.PI/2:-Math.PI/2:t>0?Math.atan(e/t):t<0?e>0?Math.atan(e/t)+Math.PI:Math.atan(e/t)-Math.PI:0}static angleTo(t,e,i){d.subtract(e,t,Ue),d.normalize(Ue,Ue),i.x=Math.asin(Ue.y),i.y=ze.arcTanAngle(-Ue.z,-Ue.x)}static createFromAxisAngle(t,e,i){e*=.5;var s=Math.sin(e);i.x=s*t.x,i.y=s*t.y,i.z=s*t.z,i.w=Math.cos(e)}static createFromMatrix4x4(t,e){var i,s,r=t.elements,a=r[0]+r[5]+r[10];a>0?(i=Math.sqrt(a+1),e.w=.5*i,i=.5/i,e.x=(r[6]-r[9])*i,e.y=(r[8]-r[2])*i,e.z=(r[1]-r[4])*i):r[0]>=r[5]&&r[0]>=r[10]?(s=.5/(i=Math.sqrt(1+r[0]-r[5]-r[10])),e.x=.5*i,e.y=(r[1]+r[4])*s,e.z=(r[2]+r[8])*s,e.w=(r[6]-r[9])*s):r[5]>r[10]?(s=.5/(i=Math.sqrt(1+r[5]-r[0]-r[10])),e.x=(r[4]+r[1])*s,e.y=.5*i,e.z=(r[9]+r[6])*s,e.w=(r[8]-r[2])*s):(s=.5/(i=Math.sqrt(1+r[10]-r[0]-r[5])),e.x=(r[8]+r[2])*s,e.y=(r[9]+r[6])*s,e.z=.5*i,e.w=(r[1]-r[4])*s)}static slerp(t,e,i,s){var r,a,n,l,o,h=t.x,u=t.y,d=t.z,c=t.w,_=e.x,p=e.y,f=e.z,g=e.w;return(a=h*_+u*p+d*f+c*g)<0&&(a=-a,_=-_,p=-p,f=-f,g=-g),1-a>1e-6?(r=Math.acos(a),n=Math.sin(r),l=Math.sin((1-i)*r)/n,o=Math.sin(i*r)/n):(l=1-i,o=i),s.x=l*h+o*_,s.y=l*u+o*p,s.z=l*d+o*f,s.w=l*c+o*g,s}static lerp(t,e,i,s){var r=1-i;ze.dot(t,e)>=0?(s.x=r*t.x+i*e.x,s.y=r*t.y+i*e.y,s.z=r*t.z+i*e.z,s.w=r*t.w+i*e.w):(s.x=r*t.x-i*e.x,s.y=r*t.y-i*e.y,s.z=r*t.z-i*e.z,s.w=r*t.w-i*e.w),s.normalize(s)}static add(t,e,i){i.x=t.x+e.x,i.y=t.y+e.y,i.z=t.z+e.z,i.w=t.w+e.w}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}constructor(t=0,e=0,i=0,s=1){this.x=t,this.y=e,this.z=i,this.w=s}setValue(t,e,i,s){this.x=t,this.y=e,this.z=i,this.w=s}set(t,e,i,s){return this.x=t,this.y=e,this.z=i,this.w=s,this}scaling(t,e){e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e.w=this.w*t}normalize(t){var e=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;e>0&&(e=1/Math.sqrt(e),t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}rotateX(t,e){t*=.5;var i=Math.sin(t),s=Math.cos(t);e.x=this.x*s+this.w*i,e.y=this.y*s+this.z*i,e.z=this.z*s-this.y*i,e.w=this.w*s-this.x*i}rotateY(t,e){t*=.5;var i=Math.sin(t),s=Math.cos(t);e.x=this.x*s-this.z*i,e.y=this.y*s+this.w*i,e.z=this.z*s+this.x*i,e.w=this.w*s-this.y*i}rotateZ(t,e){t*=.5;var i=Math.sin(t),s=Math.cos(t);e.x=this.x*s+this.y*i,e.y=this.y*s-this.x*i,e.z=this.z*s+this.w*i,e.w=this.w*s-this.z*i}getYawPitchRoll(t){d.transformQuat(d.ForwardRH,this,ke),d.transformQuat(d.Up,this,Ge);var e=Ge;ze.angleTo(d.ZERO,ke,Ve);var i=Ve;i.x==Math.PI/2?(i.y=ze.arcTanAngle(e.z,e.x),i.z=0):i.x==-Math.PI/2?(i.y=ze.arcTanAngle(-e.z,-e.x),i.z=0):(Ke.createRotationY(-i.y,Ke.TEMPMatrix0),Ke.createRotationX(-i.x,Ke.TEMPMatrix1),d.transformCoordinate(Ge,Ke.TEMPMatrix0,Ge),d.transformCoordinate(Ge,Ke.TEMPMatrix1,Ge),i.z=ze.arcTanAngle(e.y,-e.x)),i.y<=-Math.PI&&(i.y=Math.PI),i.z<=-Math.PI&&(i.z=Math.PI),i.y>=Math.PI&&i.z>=Math.PI&&(i.y=0,i.z=0,i.x=Math.PI-i.x);var s=t;s.x=i.y,s.y=i.x,s.z=i.z}invert(t){var e=this.x,i=this.y,s=this.z,r=this.w,a=e*e+i*i+s*s+r*r,n=a?1/a:0;t.x=-e*n,t.y=-i*n,t.z=-s*n,t.w=r*n}identity(){this.x=0,this.y=0,this.z=0,this.w=1}fromArray(t,e=0){this.x=t[e+0],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3]}cloneTo(t){this!==t&&(t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w)}clone(){var t=new ze;return this.cloneTo(t),t}equals(t){return h.nearEqual(this.x,t.x)&&h.nearEqual(this.y,t.y)&&h.nearEqual(this.z,t.z)&&h.nearEqual(this.w,t.w)}static rotationLookAt(t,e,i){ze.lookAt(d.ZERO,t,e,i)}static lookAt(t,e,i,s){Fe.lookAt(t,e,i,He),ze.rotationMatrix(He,s)}static forwardLookAt(t,e,i,s){Fe.forwardLookAt(t,e,i,He),ze.rotationMatrix(He,s)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static invert(t,e){var i=t.lengthSquared();h.isZero(i)||(i=1/i,e.x=-t.x*i,e.y=-t.y*i,e.z=-t.z*i,e.w=t.w*i)}static rotationMatrix(t,e){var i,s,r=t.elements,a=r[0],n=r[1],l=r[2],o=r[3],h=r[4],u=r[5],d=r[6],c=r[7],_=r[8],p=a+h+_;p>0?(i=Math.sqrt(p+1),e.w=.5*i,i=.5/i,e.x=(u-c)*i,e.y=(d-l)*i,e.z=(n-o)*i):a>=h&&a>=_?(s=.5/(i=Math.sqrt(1+a-h-_)),e.x=.5*i,e.y=(n+o)*s,e.z=(l+d)*s,e.w=(u-c)*s):h>_?(s=.5/(i=Math.sqrt(1+h-a-_)),e.x=(o+n)*s,e.y=.5*i,e.z=(c+u)*s,e.w=(d-l)*s):(s=.5/(i=Math.sqrt(1+_-a-h)),e.x=(d+l)*s,e.y=(c+u)*s,e.z=.5*i,e.w=(n-o)*s)}}ze.TEMP=new ze,ze.DEFAULT=new ze,ze.NAN=new ze(NaN,NaN,NaN,NaN);const We=new d,Ye=new d,Xe=new d,je=new d,qe=new ze,$e=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class Ke{static createRotationX(t,e){var i=e.elements,s=Math.sin(t),r=Math.cos(t);i[1]=i[2]=i[3]=i[4]=i[7]=i[8]=i[11]=i[12]=i[13]=i[14]=0,i[0]=i[15]=1,i[5]=i[10]=r,i[6]=s,i[9]=-s}static createRotationY(t,e){var i=e.elements,s=Math.sin(t),r=Math.cos(t);i[1]=i[3]=i[4]=i[6]=i[7]=i[9]=i[11]=i[12]=i[13]=i[14]=0,i[5]=i[15]=1,i[0]=i[10]=r,i[2]=-s,i[8]=s}static createRotationZ(t,e){var i=e.elements,s=Math.sin(t),r=Math.cos(t);i[2]=i[3]=i[6]=i[7]=i[8]=i[9]=i[11]=i[12]=i[13]=i[14]=0,i[10]=i[15]=1,i[0]=i[5]=r,i[1]=s,i[4]=-s}static createRotationYawPitchRoll(t,e,i,s){ze.createFromYawPitchRoll(t,e,i,qe),Ke.createRotationQuaternion(qe,s)}static createRotationAxis(t,e,i){var s=t.x,r=t.y,a=t.z,n=Math.cos(e),l=Math.sin(e),o=s*s,h=r*r,u=a*a,d=s*r,c=s*a,_=r*a,p=i.elements;p[3]=p[7]=p[11]=p[12]=p[13]=p[14]=0,p[15]=1,p[0]=o+n*(1-o),p[1]=d-n*d+l*a,p[2]=c-n*c-l*r,p[4]=d-n*d-l*a,p[5]=h+n*(1-h),p[6]=_-n*_+l*s,p[8]=c-n*c+l*r,p[9]=_-n*_-l*s,p[10]=u+n*(1-u)}static createRotationQuaternion(t,e){var i=e.elements,s=t.x,r=t.y,a=t.z,n=t.w,l=s*s,o=r*r,h=a*a,u=s*r,d=a*n,c=a*s,_=r*n,p=r*a,f=s*n;i[3]=i[7]=i[11]=i[12]=i[13]=i[14]=0,i[15]=1,i[0]=1-2*(o+h),i[1]=2*(u+d),i[2]=2*(c-_),i[4]=2*(u-d),i[5]=1-2*(h+l),i[6]=2*(p+f),i[8]=2*(c+_),i[9]=2*(p-f),i[10]=1-2*(o+l)}static createTranslate(t,e){var i=e.elements;i[4]=i[8]=i[1]=i[9]=i[2]=i[6]=i[3]=i[7]=i[11]=0,i[0]=i[5]=i[10]=i[15]=1,i[12]=t.x,i[13]=t.y,i[14]=t.z}static createScaling(t,e){var i=e.elements;i[0]=t.x,i[5]=t.y,i[10]=t.z,i[1]=i[4]=i[8]=i[12]=i[9]=i[13]=i[2]=i[6]=i[14]=i[3]=i[7]=i[11]=0,i[15]=1}static multiply(t,e,i){var s=e.elements,r=t.elements,a=i.elements,n=s[0],l=s[1],o=s[2],h=s[3],u=s[4],d=s[5],c=s[6],_=s[7],p=s[8],f=s[9],g=s[10],m=s[11],y=s[12],T=s[13],x=s[14],v=s[15],S=r[0],E=r[1],w=r[2],D=r[3],b=r[4],C=r[5],R=r[6],A=r[7],I=r[8],M=r[9],B=r[10],L=r[11],P=r[12],N=r[13],O=r[14],F=r[15];a[0]=n*S+l*b+o*I+h*P,a[1]=n*E+l*C+o*M+h*N,a[2]=n*w+l*R+o*B+h*O,a[3]=n*D+l*A+o*L+h*F,a[4]=u*S+d*b+c*I+_*P,a[5]=u*E+d*C+c*M+_*N,a[6]=u*w+d*R+c*B+_*O,a[7]=u*D+d*A+c*L+_*F,a[8]=p*S+f*b+g*I+m*P,a[9]=p*E+f*C+g*M+m*N,a[10]=p*w+f*R+g*B+m*O,a[11]=p*D+f*A+g*L+m*F,a[12]=y*S+T*b+x*I+v*P,a[13]=y*E+T*C+x*M+v*N,a[14]=y*w+T*R+x*B+v*O,a[15]=y*D+T*A+x*L+v*F}static createFromQuaternion(t,e){var i=e.elements,s=t.x,r=t.y,a=t.z,n=t.w,l=s+s,o=r+r,h=a+a,u=s*l,d=r*l,c=r*o,_=a*l,p=a*o,f=a*h,g=n*l,m=n*o,y=n*h;i[0]=1-c-f,i[1]=d+y,i[2]=_-m,i[3]=0,i[4]=d-y,i[5]=1-u-f,i[6]=p+g,i[7]=0,i[8]=_+m,i[9]=p-g,i[10]=1-u-c,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1}static createAffineTransformation(t,e,i,s){var r=s.elements,a=e.x,n=e.y,l=e.z,o=e.w,h=a+a,u=n+n,d=l+l,c=a*h,_=a*u,p=a*d,f=n*u,g=n*d,m=l*d,y=o*h,T=o*u,x=o*d,v=i.x,S=i.y,E=i.z;r[0]=(1-(f+m))*v,r[1]=(_+x)*v,r[2]=(p-T)*v,r[3]=0,r[4]=(_-x)*S,r[5]=(1-(c+m))*S,r[6]=(g+y)*S,r[7]=0,r[8]=(p+T)*E,r[9]=(g-y)*E,r[10]=(1-(c+f))*E,r[11]=0,r[12]=t.x,r[13]=t.y,r[14]=t.z,r[15]=1}static createLookAt(t,e,i,s){var r=s.elements,a=We,n=Ye,l=Xe;d.subtract(t,e,l),d.normalize(l,l),d.cross(i,l,a),d.normalize(a,a),d.cross(l,a,n),r[3]=r[7]=r[11]=0,r[15]=1,r[0]=a.x,r[4]=a.y,r[8]=a.z,r[1]=n.x,r[5]=n.y,r[9]=n.z,r[2]=l.x,r[6]=l.y,r[10]=l.z,r[12]=-d.dot(a,t),r[13]=-d.dot(n,t),r[14]=-d.dot(l,t)}static createPerspective(t,e,i,s,r){var a=1/Math.tan(.5*t),n=i/(a/e),l=i/a;Ke.createPerspectiveOffCenter(-n,n,-l,l,i,s,r)}static createPerspectiveOffCenter(t,e,i,s,r,a,n){var l=n.elements,o=a/(a-r);l[1]=l[2]=l[3]=l[4]=l[6]=l[7]=l[12]=l[13]=l[15]=0,l[0]=2*r/(e-t),l[5]=2*r/(s-i),l[8]=(t+e)/(e-t),l[9]=(s+i)/(s-i),l[10]=-o,l[11]=-1,l[14]=-r*o}static createOrthoOffCenter(t,e,i,s,r,a,n){var l=n.elements,o=1/(a-r);l[1]=l[2]=l[3]=l[4]=l[6]=l[8]=l[7]=l[9]=l[11]=0,l[15]=1,l[0]=2/(e-t),l[5]=2/(s-i),l[10]=-o,l[12]=(t+e)/(t-e),l[13]=(s+i)/(i-s),l[14]=-r*o}constructor(t=1,e=0,i=0,s=0,r=0,a=1,n=0,l=0,o=0,h=0,u=1,d=0,c=0,_=0,p=0,f=1,g=null){if(0!=arguments.length){if(1!==arguments.length||null!==arguments[0]){var m=this.elements=g||new Float32Array(16);m[0]=t,m[1]=e,m[2]=i,m[3]=s,m[4]=r,m[5]=a,m[6]=n,m[7]=l,m[8]=o,m[9]=h,m[10]=u,m[11]=d,m[12]=c,m[13]=_,m[14]=p,m[15]=f}}else this.elements=$e.slice()}getElementByRowColumn(t,e){if(t<0||t>3)throw new Error("row for matrices run from 0 to 3, inclusive.");if(e<0||e>3)throw new Error("column for matrices run from 0 to 3, inclusive.");return this.elements[4*t+e]}setElementByRowColumn(t,e,i){if(t<0||t>3)throw new Error("row for matrices run from 0 to 3, inclusive.");if(e<0||e>3)throw new Error("column for matrices run from 0 to 3, inclusive.");this.elements[4*t+e]=i}setRotation(t){var e=t.x,i=t.y,s=t.z,r=t.w,a=e*e,n=i*i,l=s*s,o=e*i,h=s*r,u=s*e,d=i*r,c=i*s,_=e*r,p=this.elements;p[0]=1-2*(n+l),p[1]=2*(o+h),p[2]=2*(u-d),p[4]=2*(o-h),p[5]=1-2*(l+a),p[6]=2*(c+_),p[8]=2*(u+d),p[9]=2*(c-_),p[10]=1-2*(n+a)}setPosition(t){var e=this.elements;e[12]=t.x,e[13]=t.y,e[14]=t.z}equalsOtherMatrix(t){var e=this.elements,i=t.elements;return h.nearEqual(e[0],i[0])&&h.nearEqual(e[1],i[1])&&h.nearEqual(e[2],i[2])&&h.nearEqual(e[3],i[3])&&h.nearEqual(e[4],i[4])&&h.nearEqual(e[5],i[5])&&h.nearEqual(e[6],i[6])&&h.nearEqual(e[7],i[7])&&h.nearEqual(e[8],i[8])&&h.nearEqual(e[9],i[9])&&h.nearEqual(e[10],i[10])&&h.nearEqual(e[11],i[11])&&h.nearEqual(e[12],i[12])&&h.nearEqual(e[13],i[13])&&h.nearEqual(e[14],i[14])&&h.nearEqual(e[15],i[15])}decomposeTransRotScale(t,e,i){var s=Qe;return this.decomposeTransRotMatScale(t,s,i)?(ze.createFromMatrix4x4(s,e),!0):(e.identity(),!1)}decomposeTransRotMatScale(t,e,i){var s=this.elements,r=t,a=e.elements,n=i;r.x=s[12],r.y=s[13],r.z=s[14];var l=s[0],o=s[1],u=s[2],c=s[4],_=s[5],p=s[6],f=s[8],g=s[9],m=s[10],y=n.x=Math.sqrt(l*l+o*o+u*u),T=n.y=Math.sqrt(c*c+_*_+p*p),x=n.z=Math.sqrt(f*f+g*g+m*m);if(h.isZero(y)||h.isZero(T)||h.isZero(x))return a[1]=a[2]=a[3]=a[4]=a[6]=a[7]=a[8]=a[9]=a[11]=a[12]=a[13]=a[14]=0,a[0]=a[5]=a[10]=a[15]=1,!1;var v=We;v.x=f/x,v.y=g/x,v.z=m/x;var S=Ye;S.x=l/y,S.y=o/y,S.z=u/y;var E=Xe;d.cross(v,S,E);var w=Ye;return d.cross(E,v,w),a[3]=a[7]=a[11]=a[12]=a[13]=a[14]=0,a[15]=1,a[0]=w.x,a[1]=w.y,a[2]=w.z,a[4]=E.x,a[5]=E.y,a[6]=E.z,a[8]=v.x,a[9]=v.y,a[10]=v.z,a[0]*l+a[1]*o+a[2]*u<0&&(n.x=-y),a[4]*c+a[5]*_+a[6]*p<0&&(n.y=-T),a[8]*f+a[9]*g+a[10]*m<0&&(n.z=-x),!0}decomposeYawPitchRoll(t){var e=Math.asin(-this.elements[9]);t.y=e,Math.cos(e)>h.zeroTolerance?(t.z=Math.atan2(this.elements[1],this.elements[5]),t.x=Math.atan2(this.elements[8],this.elements[10])):(t.z=Math.atan2(-this.elements[4],this.elements[0]),t.x=0)}normalize(){var t=this.elements,e=t[0],i=t[1],s=t[2],r=Math.sqrt(e*e+i*i+s*s);if(!r)return t[0]=0,t[1]=0,void(t[2]=0);1!=r&&(r=1/r,t[0]=e*r,t[1]=i*r,t[2]=s*r)}transpose(){var t,e;return e=(t=this.elements)[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}invert(t){var e=this.elements,i=t.elements,s=e[0],r=e[1],a=e[2],n=e[3],l=e[4],o=e[5],h=e[6],u=e[7],d=e[8],c=e[9],_=e[10],p=e[11],f=e[12],g=e[13],m=e[14],y=e[15],T=s*o-r*l,x=s*h-a*l,v=s*u-n*l,S=r*h-a*o,E=r*u-n*o,w=a*u-n*h,D=d*g-c*f,b=d*m-_*f,C=d*y-p*f,R=c*m-_*g,A=c*y-p*g,I=_*y-p*m,M=T*I-x*A+v*R+S*C-E*b+w*D;0!==Math.abs(M)&&(M=1/M,i[0]=(o*I-h*A+u*R)*M,i[1]=(a*A-r*I-n*R)*M,i[2]=(g*w-m*E+y*S)*M,i[3]=(_*E-c*w-p*S)*M,i[4]=(h*C-l*I-u*b)*M,i[5]=(s*I-a*C+n*b)*M,i[6]=(m*v-f*w-y*x)*M,i[7]=(d*w-_*v+p*x)*M,i[8]=(l*A-o*C+u*D)*M,i[9]=(r*C-s*A-n*D)*M,i[10]=(f*E-g*v+y*T)*M,i[11]=(c*v-d*E-p*T)*M,i[12]=(o*b-l*R-h*D)*M,i[13]=(s*R-r*b+a*D)*M,i[14]=(g*x-f*S-m*T)*M,i[15]=(d*S-c*x+_*T)*M)}static billboard(t,e,i,s,r){d.subtract(t,e,We);var a=d.scalarLengthSquared(We);h.isZero(a)?(d.scale(s,-1,Ye),Ye.cloneTo(We)):d.scale(We,1/Math.sqrt(a),We),d.cross(i,We,Xe),d.normalize(Xe,Xe),d.cross(We,Xe,je);var n=Xe,l=je,o=We,u=t,c=r.elements;c[0]=n.x,c[1]=n.y,c[2]=n.z,c[3]=0,c[4]=l.x,c[5]=l.y,c[6]=l.z,c[7]=0,c[8]=o.x,c[9]=o.y,c[10]=o.z,c[11]=0,c[12]=u.x,c[13]=u.y,c[14]=u.z,c[15]=1}identity(){this.elements.set($e)}isIdentity(){let t=this.elements,e=Ke.DEFAULT.elements;for(let r=0,a=t.length;r<a;r++)if(i=t[r],s=e[r],!(Math.abs(i-s)<1e-7))return!1;var i,s;return!0}cloneTo(t){this.elements!==t.elements&&t.elements.set(this.elements)}cloneByArray(t){this.elements.set(t)}clone(){var t=new Ke(null);return t.elements=this.elements.slice(),t}static translation(t,e){var i=e.elements;i[0]=i[5]=i[10]=i[15]=1,i[12]=t.x,i[13]=t.y,i[14]=t.z}getTranslationVector(t){var e=this.elements;t.x=e[12],t.y=e[13],t.z=e[14]}setTranslationVector(t){var e=this.elements,i=t;e[12]=i.x,e[13]=i.y,e[14]=i.z}getForward(t){var e=this.elements;t.x=-e[8],t.y=-e[9],t.z=-e[10]}setForward(t){var e=this.elements;e[8]=-t.x,e[9]=-t.y,e[10]=-t.z}getInvertFront(){this.decomposeTransRotScale(We,qe,Ye);var t=Ye,e=t.x<0;return t.y<0&&(e=!e),t.z<0&&(e=!e),e}}Ke.TEMPMatrix0=new Ke,Ke.TEMPMatrix1=new Ke,Ke.DEFAULT=new Ke,Ke.DEFAULTINVERT=new Ke(-1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),Ke.ZERO=new Ke(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const Qe=new Ke;class Ze{constructor(t=0,e=0){this.x=t,this.y=e}setValue(t,e){this.x=t,this.y=e}static scale(t,e,i){i.x=t.x*e,i.y=t.y*e}static equals(t,e){return h.nearEqual(t.x,e.x)&&h.nearEqual(t.y,e.y)}fromArray(t,e=0){this.x=t[e+0],this.y=t[e+1]}toArray(){return[this.x,this.y]}writeTo(t,e=0){t[e+0]=this.x,t[e+1]=this.y}cloneTo(t){t.x=this.x,t.y=this.y}static dot(t,e){return t.x*e.x+t.y*e.y}static normalize(t,e){var i=t.x,s=t.y,r=i*i+s*s;r>0&&(r=1/Math.sqrt(r),e.x=i*r,e.y=s*r)}static scalarLength(t){var e=t.x,i=t.y;return Math.sqrt(e*e+i*i)}clone(){var t=new Ze;return this.cloneTo(t),t}}var Je,ti,ei;function ii(e){switch(e){case t.ShaderDataType.Int:return 0;case t.ShaderDataType.Bool:return!1;case t.ShaderDataType.Float:return 0;case t.ShaderDataType.Vector2:return Ze.ZERO;case t.ShaderDataType.Vector3:return d.ZERO;case t.ShaderDataType.Vector4:return u.ZERO;case t.ShaderDataType.Color:return _t.BLACK;case t.ShaderDataType.Matrix4x4:return Ke.DEFAULT;case t.ShaderDataType.Matrix3x3:return Fe.DEFAULT}return null}Ze.ZERO=new Ze(0,0),Ze.ONE=new Ze(1,1),Ze.TempVector2=new Ze,t.ShaderDataType=void 0,(Je=t.ShaderDataType||(t.ShaderDataType={}))[Je.None=0]="None",Je[Je.Int=1]="Int",Je[Je.Bool=2]="Bool",Je[Je.Float=3]="Float",Je[Je.Vector2=4]="Vector2",Je[Je.Vector3=5]="Vector3",Je[Je.Vector4=6]="Vector4",Je[Je.Color=7]="Color",Je[Je.Matrix4x4=8]="Matrix4x4",Je[Je.Texture2D=9]="Texture2D",Je[Je.Texture3D=10]="Texture3D",Je[Je.TextureCube=11]="TextureCube",Je[Je.Buffer=12]="Buffer",Je[Je.Matrix3x3=13]="Matrix3x3",Je[Je.Texture2DArray=14]="Texture2DArray";t.UniformBufferParamsType=void 0,(ti=t.UniformBufferParamsType||(t.UniformBufferParamsType={}))[ti.Number=0]="Number",ti[ti.Vector2=1]="Vector2",ti[ti.Vector3=2]="Vector3",ti[ti.Vector4=3]="Vector4",ti[ti.Matrix4x4=4]="Matrix4x4",ti[ti.Vector4Array=5]="Vector4Array",ti[ti.MatrixArray=6]="MatrixArray";class si{constructor(t){this._uniformParamsState=new Map(t),this._createBuffer(),this._updateFlag=new Ze,this._resetUpdateFlag()}_createBuffer(){var t=0;this._layoutMap={};this._uniformParamsState.forEach(((e,i)=>{t+=this._addUniformParams(i,e,t)})),this._bytelength=4*Math.ceil(t/4)*4,this._buffer=new Float32Array(t)}_getArraySize(t){let e=t.indexOf("["),i=t.indexOf("]");if(-1!=e&&-1!=i&&e<i)return parseFloat(t.substring(e+1,i));throw t+" is illegal "}_addUniformParams(e,i,s){let r,a=0,n=0,l=s%4;switch(i){case t.UniformBufferParamsType.Number:a=1,n=1;break;case t.UniformBufferParamsType.Vector2:switch(a=2,l){case 0:case 2:n=2;break;case 1:case 3:s+=1,n=3}break;case t.UniformBufferParamsType.Vector3:switch(a=3,n=3,l){case 1:case 2:case 3:s+=4-l,n=4-l+3}break;case t.UniformBufferParamsType.Vector4:switch(a=4,l){case 0:n=4;break;case 1:s+=3,n=7;break;case 2:s+=2,n=6;break;case 3:s+=1,n=5}break;case t.UniformBufferParamsType.Matrix4x4:a=16,r=l?4-l:l,s+=r,n=a+r;break;case t.UniformBufferParamsType.Vector4Array:a=4*this._getArraySize(ci.propertyIDToName(e)),r=l?4-l:l,s+=r,n=a+r;break;case t.UniformBufferParamsType.MatrixArray:a=16*this._getArraySize(ci.propertyIDToName(e)),r=l?4-l:l,s+=r,n=a+r;break;default:throw"Unifrom Buffer Params Type is illegal "}const o=new Ze(s,a);return this._layoutMap[e]=o,n}_getParamsInfo(t){return this._layoutMap[t]}_setUpdateFlag(t,e){t<this._updateFlag.x&&(this._updateFlag.x=t),e>this._updateFlag.y&&(this._updateFlag.y=e)}destroy(){delete this._buffer,this._uniformParamsState.clear(),this._uniformParamsState=null,this._layoutMap=null,this._updateFlag=null}_resetUpdateFlag(){this._updateFlag.setValue(this._buffer.length,0)}_has(t){return!!this._getParamsInfo(t)}_setData(e,i){switch(this._uniformParamsState.get(e)){case t.UniformBufferParamsType.Number:this.setNumberbyIndex(e,i);break;case t.UniformBufferParamsType.Vector2:this.setVector2byIndex(e,i);break;case t.UniformBufferParamsType.Vector3:this.setVector3byIndex(e,i);break;case t.UniformBufferParamsType.Vector4:this.setVector4byIndex(e,i);break;case t.UniformBufferParamsType.Matrix4x4:this.setMatrixbyIndex(e,i);break;case t.UniformBufferParamsType.Vector4Array:this.setVector4ArraybyIndex(e,i);break;case t.UniformBufferParamsType.MatrixArray:this.setMatrixArraybyIndex(e,i)}}getbyteLength(){return this._bytelength}setVector4Array(t,e){const i=ci.propertyNameToID(t);this.setVector4ArraybyIndex(i,e)}setVector4ArraybyIndex(t,e){const i=this._getParamsInfo(t);if(!i)return;let s=i.x,r=i.y/4;for(let t=0;t<r;t++){let i=e[t];this._buffer[s++]=i.x,this._buffer[s++]=i.y,this._buffer[s++]=i.z,this._buffer[s++]=i.w}this._setUpdateFlag(i.x,s)}setMatrixArray(t,e){const i=ci.propertyNameToID(t);this.setMatrixArraybyIndex(i,e)}setMatrixArraybyIndex(t,e){const i=this._getParamsInfo(t);if(!i)return;let s=i.x,r=i.y/4;for(let t=0;t<r;t++){let i=e[t];this._buffer.set(i.elements,s),s+=16}this._setUpdateFlag(i.x,s)}setNumber(t,e){const i=ci.propertyNameToID(t);this.setNumberbyIndex(i,e)}setNumberbyIndex(t,e){const i=this._getParamsInfo(t);if(!i)return;let s=i.x;this._buffer[s++]=e,this._setUpdateFlag(i.x,s)}setVector2(t,e){const i=ci.propertyNameToID(t);this.setVector2byIndex(i,e)}setVector2byIndex(t,e){const i=this._getParamsInfo(t);if(!i)return;let s=i.x;this._buffer[s++]=e.x,this._buffer[s++]=e.y,this._setUpdateFlag(i.x,s)}setVector3(t,e){const i=ci.propertyNameToID(t);this.setVector3byIndex(i,e)}setVector3byIndex(t,e){const i=this._getParamsInfo(t);if(!i)return;let s=i.x;this._buffer[s++]=e.x,this._buffer[s++]=e.y,this._buffer[s++]=e.z,this._setUpdateFlag(i.x,s)}setVector4(t,e){const i=ci.propertyNameToID(t);this.setVector4byIndex(i,e)}setVector4byIndex(t,e){const i=this._getParamsInfo(t);if(!i)return;let s=i.x;this._buffer[s++]=e.x,this._buffer[s++]=e.y,this._buffer[s++]=e.z,this._buffer[s++]=e.w,this._setUpdateFlag(i.x,s)}setColor(t,e){const i=ci.propertyNameToID(t);this.setColorbyIndex(i,e)}setColorbyIndex(t,e){const i=this._getParamsInfo(t);if(!i)return;let s=i.x;this._buffer[s++]=_t.gammaToLinearSpace(e.r),this._buffer[s++]=_t.gammaToLinearSpace(e.g),this._buffer[s++]=_t.gammaToLinearSpace(e.b),this._buffer[s++]=_t.gammaToLinearSpace(e.a),this._setUpdateFlag(i.x,s)}setMatrix(t,e){const i=ci.propertyNameToID(t);this.setMatrixbyIndex(i,e)}setMatrixbyIndex(t,e){const i=this._getParamsInfo(t);if(!i)return;let s=i.x;this._buffer.set(e.elements,s),s+=16,this._setUpdateFlag(i.x,s)}clone(){let t=new si(this._uniformParamsState);return this.cloneTo(t),t}cloneTo(t){t._bytelength==this._bytelength&&(t._buffer=Float32Array.from(this._buffer),this._updateFlag.setValue(0,this._buffer.length))}}class ri{}class ai{constructor(t,e,i){this._owner=t,this.name=e,this._VS=i.vsNode,this._PS=i.psNode,this._defs=i.defs,this._validDefine=l.unitRenderModuleDataFactory.createDefineDatas();for(let t of i.defs)this._validDefine.add(ci.getDefineByName(t))}withCompile(t){return null}}ai._defineStrings=[];class ni{get shader(){return this._shader}get subShaderIndex(){return this._subShaderIndex}get passIndex(){return this._passIndex}get defineNames(){return this._defineNames}constructor(t,e,i,s){this._subShaderIndex=0,this._passIndex=0,this.setValue(t,e,i,s)}setValue(t,e,i,s){if(!t)throw"ShaderVariantInfo:Shader can't be null.";var r=t.getSubShaderAt(e);if(!r)throw`ShaderVariantInfo:Shader don't have subShaderIndex of ${e}.`;var a=r._passes[i];if(!a)throw`ShaderVariantInfo:Shader don't have passIndex of ${i}.`;for(var n=a._validDefine,l=0,o=s.length;l<o;l++){var h=s[l];if(!n.has(ci.getDefineByName(h)))throw`ShaderVariantInfo:Invalid defineName ${h} in ${t._name} subShaderIndex of ${e} passIndex of ${i}.`}this._shader=t,this._subShaderIndex=e,this._passIndex=i,this._defineNames=s}equal(t){if(this._shader!==t._shader||this._subShaderIndex!==t._subShaderIndex||this._passIndex!==t._passIndex)return!1;var e=this._defineNames,i=t._defineNames;if(e.length!==i.length)return!1;for(var s=0,r=this._defineNames.length;s<r;s++)if(e[s]!==i[s])return!1;return!0}clone(){return new ni(this._shader,this._subShaderIndex,this._passIndex,this._defineNames.slice())}}class li{constructor(t){this.items=t||{}}add(t,e){let i=t._owner._owner,s=i._subShaders.indexOf(t._owner),r=t._owner._passes.indexOf(t),a=t.nodeCommonMap;if(!a)return;e=e.filter((t=>!ci._configDefineValues.has(ci.getDefineByName(t))));let n=this.items[i._name];n||(n=[],this.items[i._name]=n),n.some((t=>t.subShaderIndex===s&&t.passIndex===r&&t.defines.length===e.length&&t.defines.every(((t,i)=>t===e[i]))&&t.nodeCommonMap.length===a.length&&t.nodeCommonMap.every(((t,e)=>t===a[e]))))||(n.push({subShaderIndex:s,passIndex:r,defines:e,nodeCommonMap:a.concat()}),console.debug(`Shader variant: ${i._name}/${s}/${r}/${e.join(",")}/${a?a.join(","):""}`))}compileAll(){let t=this.items;for(let e in t){let i=t[e];for(let t of i){let i=ci.compileShaderByDefineNames(e,t.subShaderIndex,t.passIndex,t.defines,t.nodeCommonMap),s=`${e}/${t.subShaderIndex}/${t.passIndex}/${t.defines.join(",")}/${t.nodeCommonMap?t.nodeCommonMap.join(","):""}`;i?console.debug("Warm up",s):console.warn("Warm up failed!",s)}}}}li.active=new li;class oi extends ai{get pipelineMode(){return this._pipelineMode}set pipelineMode(t){this._pipelineMode=t,this.moduleData.pipelineMode=t}set nodeCommonMap(t){this._nodeUniformCommonMap=t,this.moduleData.nodeCommonMap=t}get nodeCommonMap(){return this._nodeUniformCommonMap}get statefirst(){return this._statefirst}set statefirst(t){this._statefirst=t,this.moduleData.statefirst=t}get renderState(){return this.moduleData.renderState}constructor(t,e){super(t,null,e),this._statefirst=!1,this.moduleData=l.unitRenderModuleDataFactory.createShaderPass(this),this.moduleData.validDefine=this._validDefine}static createShaderInstance(t,e,i){let s=new ri;s.is2D=e,s.vs=t._VS,s.ps=t._PS,s.attributeMap=t._owner._attributeMap,s.uniformMap=t._owner._uniformMap;var r=ai._defineStrings;return r.length=0,ci._getNamesByDefineData(i,r),s.defineString=r,ci.debugMode&&li.active.add(t,r),l.renderDeviceFactory.createShaderInstance(s,t)}withCompile(t,e=!1){var i=this.moduleData.getCacheShader(t);return i||(i=oi.createShaderInstance(this,e,t),this.moduleData.setCacheShader(t,i),i)}}oi._debugDefineStrings=[],oi._debugDefineMasks=[];class hi{static __init__(){hi.instanceWorldMatrixDeclaration=new Zt(64,[new Jt(0,Kt.Vector4,hi.MESH_WORLDMATRIX_ROW0),new Jt(16,Kt.Vector4,hi.MESH_WORLDMATRIX_ROW1),new Jt(32,Kt.Vector4,hi.MESH_WORLDMATRIX_ROW2),new Jt(48,Kt.Vector4,hi.MESH_WORLDMATRIX_ROW3)]),hi.instanceSimpleAnimatorDeclaration=new Zt(16,[new Jt(0,Kt.Vector4,hi.MESH_SIMPLEANIMATOR)]),hi.instanceLightMapScaleOffsetDeclaration=new Zt(16,[new Jt(0,Kt.Vector4,hi.MESH_LIGHTMAPSCALEOFFSET)])}static getVertexDeclaration(t,e=!0){var i=hi._vertexDeclarationMap[t+(e?"_0":"_1")];if(!i){for(var s=t.split(","),r=0,a=[],n=0,l=s.length;n<l;n++){var o;switch(s[n]){case"POSITION":o=new Jt(r,Kt.Vector3,hi.MESH_POSITION0),r+=12;break;case"NORMAL":o=new Jt(r,Kt.Vector3,hi.MESH_NORMAL0),r+=12;break;case"COLOR":o=new Jt(r,Kt.Vector4,hi.MESH_COLOR0),r+=16;break;case"UV":o=new Jt(r,Kt.Vector2,hi.MESH_TEXTURECOORDINATE0),r+=8;break;case"UV1":o=new Jt(r,Kt.Vector2,hi.MESH_TEXTURECOORDINATE1),r+=8;break;case"BLENDWEIGHT":o=new Jt(r,Kt.Vector4,hi.MESH_BLENDWEIGHT0),r+=16;break;case"BLENDINDICES":e?(o=new Jt(r,Kt.Vector4,hi.MESH_BLENDINDICES0),r+=16):(o=new Jt(r,Kt.Byte4,hi.MESH_BLENDINDICES0),r+=4);break;case"TANGENT":o=new Jt(r,Kt.Vector4,hi.MESH_TANGENT0),r+=16;break;case"NORMAL_BYTE":o=new Jt(r,Kt.NorByte4,hi.MESH_NORMAL0),r+=4;break;default:throw"VertexMesh: unknown vertex flag."}a.push(o)}i=new Zt(r,a),hi._vertexDeclarationMap[t+(e?"_0":"_1")]=i}return i}}hi.MESH_POSITION0=0,hi.MESH_COLOR0=1,hi.MESH_TEXTURECOORDINATE0=2,hi.MESH_NORMAL0=3,hi.MESH_TANGENT0=4,hi.MESH_BLENDINDICES0=5,hi.MESH_BLENDWEIGHT0=6,hi.MESH_TEXTURECOORDINATE1=7,hi.MESH_WORLDMATRIX_ROW0=8,hi.MESH_WORLDMATRIX_ROW1=9,hi.MESH_WORLDMATRIX_ROW2=10,hi.MESH_WORLDMATRIX_ROW3=11,hi.MESH_SIMPLEANIMATOR=12,hi.MESH_LIGHTMAPSCALEOFFSET=13,hi.MESH_CUSTOME0=12,hi.MESH_CUSTOME1=13,hi.MESH_CUSTOME2=14,hi.MESH_CUSTOME3=15,hi._vertexDeclarationMap={};class ui{static regIncludeBindUnifrom(t,e,i){let s={},r=s[t]={};r.uniformMap=e,r.defaultValue=i,Object.assign(ui.IncludeUniformMap,s)}constructor(e=ui.DefaultAttributeMap,i={},s=null){this._uniformBufferDataMap=new Map,this._flags={},this._passes=[],this.moduleData=l.unitRenderModuleDataFactory.createSubShader(),this._attributeMap=e,this._uniformMap=i,this._uniformDefaultValue=s,this._uniformTypeMap=new Map;for(const e in i)if("object"==typeof i[e]){let t=i[e],s=new Map;for(const e in t){let i=di(t[e]);s.set(e,i),this._uniformTypeMap.set(e,t[e])}let r=new Map;s.forEach(((t,e)=>{r.set(ci.propertyNameToID(e),t)}));let a=new si(r);this._uniformBufferDataMap.set(e,a)}else{let s=i[e];if(this._uniformTypeMap.set(e,s),s==t.ShaderDataType.Texture2D||s==t.ShaderDataType.TextureCube||s==t.ShaderDataType.Texture3D||s==t.ShaderDataType.Texture2DArray){let t=ci.getDefineByName(`Gamma_${e}`),i=ci.propertyNameToID(e);l.renderEngine.addTexGammaDefine(i,t)}}}addShaderPass(t,e,i="Forward"){return this._addShaderPass(Be.compile(t,e),i)}_addShaderPass(t,e="Forward"){var i=new oi(this,t);return i.pipelineMode=e,this._passes.push(i),this.moduleData.addShaderPass(i.moduleData),this._addIncludeUniform(t.includeNames),i}_addIncludeUniform(t){for(let i of t)if(ui.IncludeUniformMap[i]){let t=ui.IncludeUniformMap[i],s=t.uniformMap,r=t.defaultValue;for(var e in s)this._uniformTypeMap.has(e)||(this._uniformTypeMap.set(e,s[e]),this._uniformMap[e]=s[e]);for(var e in r)this._uniformDefaultValue[e]||(this._uniformDefaultValue[e]=r[e])}}}function di(e){switch(e){case t.ShaderDataType.Float:return t.UniformBufferParamsType.Number;case t.ShaderDataType.Vector2:return t.UniformBufferParamsType.Vector2;case t.ShaderDataType.Vector3:return t.UniformBufferParamsType.Vector3;case t.ShaderDataType.Vector4:case t.ShaderDataType.Color:return t.UniformBufferParamsType.Vector4;case t.ShaderDataType.Matrix4x4:return t.UniformBufferParamsType.Matrix4x4;default:throw"ShaderDataType can not be in UniformBuffer."}}ui.IncludeUniformMap={},ui.DefaultAttributeMap={a_Position:[hi.MESH_POSITION0,t.ShaderDataType.Vector4],a_Normal:[hi.MESH_NORMAL0,t.ShaderDataType.Vector3],a_Tangent0:[hi.MESH_TANGENT0,t.ShaderDataType.Vector4],a_Texcoord0:[hi.MESH_TEXTURECOORDINATE0,t.ShaderDataType.Vector2],a_Texcoord1:[hi.MESH_TEXTURECOORDINATE1,t.ShaderDataType.Vector2],a_Color:[hi.MESH_COLOR0,t.ShaderDataType.Vector4],a_BoneWeights:[hi.MESH_BLENDWEIGHT0,t.ShaderDataType.Vector4],a_BoneIndices:[hi.MESH_BLENDINDICES0,t.ShaderDataType.Vector4],a_WorldMat:[hi.MESH_WORLDMATRIX_ROW0,t.ShaderDataType.Matrix4x4],a_SimpleTextureParams:[hi.MESH_SIMPLEANIMATOR,t.ShaderDataType.Vector4],a_LightmapScaleOffset:[hi.MESH_LIGHTMAPSCALEOFFSET,t.ShaderDataType.Vector4]},t.ShaderFeatureType=void 0,(ei=t.ShaderFeatureType||(t.ShaderFeatureType={}))[ei.DEFAULT=0]="DEFAULT",ei[ei.D3=1]="D3",ei[ei.D2=2]="D2",ei[ei.PostProcess=3]="PostProcess",ei[ei.Sky=4]="Sky",ei[ei.Effect=5]="Effect";class ci{static init(){ci._configDefineValues=l.unitRenderModuleDataFactory.createDefineDatas(),ci.SHADERDEFINE_BLITSCREEN_INVERTY=ci.getDefineByName("BLITSCREEN_INVERTY"),ci.SHADERDEFINE_REMAP_POSITIONZ=ci.getDefineByName("REMAP_Z"),ci.SHADERDEFINE_LOD_TEXTURE_SAMPLE=ci.getDefineByName("LOD_TEXTURE_SAMPLE"),ci.SHADERDEFINE_BREAK_TEXTURE_SAMPLE=ci.getDefineByName("BREAK_TEXTURE_SAMPLE"),l.renderEngine._remapZ&&ci._configDefineValues.add(ci.SHADERDEFINE_REMAP_POSITIONZ),l.renderEngine._screenInvertY,l.renderEngine._lodTextureSample&&ci._configDefineValues.add(ci.SHADERDEFINE_LOD_TEXTURE_SAMPLE),l.renderEngine._breakTextureSample&&ci._configDefineValues.add(ci.SHADERDEFINE_BREAK_TEXTURE_SAMPLE),ci._compileDefineDatas=l.unitRenderModuleDataFactory.createDefineDatas()}static _getNamesByDefineData(t,e){return l.renderEngine.getNamesByDefineData(t,e),e}static getDefineByName(t){return l.renderEngine.getDefineByName(t)}static propertyNameToID(t){return l.renderEngine.propertyNameToID(t)}static propertyIDToName(t){return l.renderEngine.propertyIDToName(t)}static addInclude(t,e){Be.addInclude(t,e)}static compileShaderByDefineNames(t,e,i,s,r){var a=ci.find(t);if(a){var n=a.getSubShaderAt(e);if(n){var l=n._passes[i];if(l.nodeCommonMap=r,l){var o=ci._compileDefineDatas;ci._configDefineValues.cloneTo(o);for(let t of s)o.add(ci.getDefineByName(t));return l.withCompile(o),!0}}}return!1}static add(t,e=!1,i=!1){return ci._preCompileShader[t]=new ci(t,e,i)}static find(t){return ci._preCompileShader[t]}static parse(t,e){var i;t.name||console.warn("shader name is empty",t),t.uniformMap||console.warn(`${t.name}: uniformMap is empty`);let s=ci.add(t.name,t.enableInstancing,t.supportReflectionProbe);s._surportVolumetricGI=t.surportVolumetricGI;let r=new ui(t.attributeMap?t.attributeMap:ui.DefaultAttributeMap,t.uniformMap,t.defaultValue);s.addSubShader(r);let a=t.shaderPass;for(var n in a){let s=a[n];if(!s.VS){console.warn(`${t.name}: VS of pass ${n} is empty`);continue}if(!s.FS){console.warn(`${t.name}: FS of pass ${n} is empty`);continue}let l=r._addShaderPass(Be.compile(s.VS,s.FS,e),s.pipeline);l.statefirst=null!==(i=s.statefirst)&&void 0!==i&&i,Be.getRenderState(s.renderState,l.renderState)}return s}get name(){return this._name}constructor(t,e,i){this._enableInstancing=!1,this._supportReflectionProbe=!1,this._surportVolumetricGI=!1,this._subShaders=[],this._name=t,this._enableInstancing=e,this._supportReflectionProbe=i}addSubShader(t){this._subShaders.push(t),t._owner=this,t.moduleData.enableInstance=this._enableInstancing}getSubShaderAt(t){return this._subShaders[t]}}ci.PERIOD_CUSTOM=0,ci.PERIOD_MATERIAL=1,ci.PERIOD_SPRITE=2,ci.PERIOD_CAMERA=3,ci.PERIOD_SCENE=4,ci._propertyNameMap={},ci._propertyNameCounter=0,ci._preCompileShader={},ci.debugMode=!1;class _i{constructor(){this._controlPoints=[new s,new s,new s],this._calFun=this.getPoint2}_switchPoint(t,e){var i=this._controlPoints.shift();i.setTo(t,e),this._controlPoints.push(i)}getPoint2(t,e){var i=this._controlPoints[0],s=this._controlPoints[1],r=this._controlPoints[2],a=Math.pow(1-t,2)*i.x+2*t*(1-t)*s.x+Math.pow(t,2)*r.x,n=Math.pow(1-t,2)*i.y+2*t*(1-t)*s.y+Math.pow(t,2)*r.y;e.push(a,n)}getPoint3(t,e){var i=this._controlPoints[0],s=this._controlPoints[1],r=this._controlPoints[2],a=this._controlPoints[3],n=Math.pow(1-t,3)*i.x+3*s.x*t*(1-t)*(1-t)+3*r.x*t*t*(1-t)+a.x*Math.pow(t,3),l=Math.pow(1-t,3)*i.y+3*s.y*t*(1-t)*(1-t)+3*r.y*t*t*(1-t)+a.y*Math.pow(t,3);e.push(n,l)}insertPoints(t,e){var i,s;for(s=1/(t=t>0?t:5),i=0;i<=1;i+=s)this._calFun(i,e)}getBezierPoints(t,e=5,i=2){var r,a;if((a=t.length)<2*(i+1))return[];var n=[];switch(i){case 2:this._calFun=this.getPoint2;break;case 3:this._calFun=this.getPoint3;break;default:return[]}for(;this._controlPoints.length<=i;)this._controlPoints.push(s.create());for(r=0;r<2*i;r+=2)this._switchPoint(t[r],t[r+1]);for(r=2*i;r<a;r+=2)this._switchPoint(t[r],t[r+1]),r/2%i==0&&this.insertPoints(e,n);return n}}_i.I=new _i;class pi{static __init__(){}static setDepthTest(t){l.renderEngine._GLRenderState.setDepthTest(t)}static setDepthMask(t){l.renderEngine._GLRenderState.setDepthMask(t)}static setDepthFunc(t){l.renderEngine._GLRenderState.setDepthFunc(t)}static setStencilTest(t){l.renderEngine._GLRenderState.setStencilTest(t)}static setStencilMask(t){l.renderEngine._GLRenderState.setStencilMask(t)}static setStencilFunc(t,e){l.renderEngine._GLRenderState.setStencilFunc(t,e)}static setstencilOp(t,e,i){l.renderEngine._GLRenderState.setstencilOp(t,e,i)}static setBlend(t){l.renderEngine._GLRenderState.setBlend(t)}static setBlendEquation(t){l.renderEngine._GLRenderState.setBlendEquation(t)}static setBlendEquationSeparate(t,e){l.renderEngine._GLRenderState.setBlendEquationSeparate(t,e)}static setBlendFunc(t,e){l.renderEngine._GLRenderState.setBlendFunc(t,e)}static setBlendFuncSeperate(t,e,i,s){l.renderEngine._GLRenderState.setBlendFuncSeperate(t,e,i,s)}static setCullFace(t){l.renderEngine._GLRenderState.setCullFace(t)}static setFrontFace(t){l.renderEngine._GLRenderState.setFrontFace(t)}}pi.stencilFuncArray=new Array(2),pi.blendEquationSeparateArray=new Array(2),pi.blenfunArray=new Array(2),pi.blendFuncSeperateArray=new Array(4),pi.stencilOpArray=new Array(3);class fi{static _init_(){fi.fns=[fi.BlendNormal,fi.BlendAdd,fi.BlendMultiply,fi.BlendScreen,fi.BlendOverlay,fi.BlendLight,fi.BlendMask,fi.BlendDestinationOut,fi.BlendAddOld,fi.BlendSourceAlpha],fi.targetFns=[fi.BlendNormalTarget,fi.BlendAddTarget,fi.BlendMultiplyTarget,fi.BlendScreenTarget,fi.BlendOverlayTarget,fi.BlendLightTarget,fi.BlendMask,fi.BlendDestinationOut,fi.BlendAddTargetOld,fi.BlendSourceAlpha]}static BlendNormal(){pi.setBlendFunc(t.BlendFactor.One,t.BlendFactor.OneMinusSourceAlpha)}static BlendAddOld(){pi.setBlendFunc(t.BlendFactor.One,t.BlendFactor.DestinationAlpha)}static BlendAdd(){pi.setBlendFunc(t.BlendFactor.One,t.BlendFactor.One)}static BlendMultiply(){pi.setBlendFunc(t.BlendFactor.DestinationColor,t.BlendFactor.OneMinusSourceAlpha)}static BlendScreen(){pi.setBlendFunc(t.BlendFactor.One,t.BlendFactor.One)}static BlendOverlay(){pi.setBlendFunc(t.BlendFactor.One,t.BlendFactor.OneMinusSourceAlpha)}static BlendLight(){pi.setBlendFunc(t.BlendFactor.One,t.BlendFactor.One)}static BlendNormalTarget(){pi.setBlendFunc(t.BlendFactor.One,t.BlendFactor.OneMinusSourceAlpha)}static BlendAddTargetOld(){pi.setBlendFunc(t.BlendFactor.One,t.BlendFactor.DestinationAlpha)}static BlendAddTarget(){pi.setBlendFunc(t.BlendFactor.One,t.BlendFactor.One)}static BlendMultiplyTarget(){pi.setBlendFunc(t.BlendFactor.DestinationColor,t.BlendFactor.OneMinusSourceAlpha)}static BlendScreenTarget(){pi.setBlendFunc(t.BlendFactor.One,t.BlendFactor.One)}static BlendOverlayTarget(){pi.setBlendFunc(t.BlendFactor.One,t.BlendFactor.OneMinusSourceColor)}static BlendLightTarget(){pi.setBlendFunc(t.BlendFactor.One,t.BlendFactor.One)}static BlendMask(){pi.setBlendFunc(t.BlendFactor.Zero,t.BlendFactor.SourceAlpha)}static BlendDestinationOut(){pi.setBlendFunc(t.BlendFactor.Zero,t.BlendFactor.Zero)}static BlendSourceAlpha(){pi.setBlendFunc(t.BlendFactor.SourceAlpha,t.BlendFactor.OneMinusSourceAlpha)}}fi.activeBlendFunction=null,fi.NAMES=["normal","add","multiply","screen","overlay","light","mask","destination-out","add_old"],fi.TOINT={normal:0,add:1,multiply:2,screen:3,overlay:4,light:5,mask:6,"destination-out":7,lighter:1,lighter_old:8,add_old:8},fi.NORMAL="normal",fi.MASK="mask",fi.LIGHTER="lighter";const gi={purple:"#800080",orange:"#ffa500",white:"#FFFFFF",red:"#FF0000",green:"#00FF00",blue:"#0000FF",black:"#000000",yellow:"#FFFF00",gray:"#808080"};class mi{constructor(t){if(this.arrColor=[],mi._DEFAULT||mi._initDefault(),null==t||"none"==t)return this.strColor="#00000000",this.numColor=0,void(this.arrColor=[0,0,0,0]);let e;"string"==typeof t?(e=P.fromStringColor(t),this.strColor=t):(e=t,this.strColor=P.toHexColor(e)),this.strColor.indexOf("rgba")>=0||9===this.strColor.length?(this.arrColor=[((4278190080&e)>>>24)/255,((16711680&e)>>16)/255,((65280&e)>>8)/255,(255&e)/255],this.numColor=(4278190080&e)>>>24|(16711680&e)>>8|(65280&e)<<8|(255&e)<<24):(this.arrColor=[((16711680&e)>>16)/255,((65280&e)>>8)/255,(255&e)/255,1],this.numColor=4278190080|(16711680&e)>>16|65280&e|(255&e)<<16)}static _initDefault(){for(var t in mi._DEFAULT={},gi)mi._SAVE[t]=mi._DEFAULT[t]=new mi(gi[t]);return mi._DEFAULT}static _initSaveMap(){mi._SAVE_SIZE=0,mi._SAVE=Object.assign({},mi._DEFAULT)}static create(t){let e=t+"",i=mi._SAVE[e];return null!=i?i:(mi._SAVE_SIZE>500&&mi._initSaveMap(),mi._SAVE_SIZE++,mi._SAVE[e]=new mi(t))}}mi._SAVE={},mi._SAVE_SIZE=0;class yi{static _Defaultinit(){yi.DEFAULT=new yi("#000000")}static create(t){if(t){var e=t instanceof mi?t:mi.create(t);return e._drawStyle||(e._drawStyle=new yi(t))}return yi.DEFAULT}constructor(t){this.setValue(t)}setValue(t){this._color=t?t instanceof mi?t:mi.create(t):mi.create("#000000")}reset(){this._color=mi.create("#000000")}toInt(){return this._color.numColor}equal(t){return"string"==typeof t?this._color.strColor===t:t instanceof mi&&this._color.numColor===t.numColor}toColorStr(){return this._color.strColor}}class Ti{constructor(){this._lastOriX=0,this._lastOriY=0,this.paths=[],this._curPath=null}beginPath(t){this.paths.length=1,this._curPath=this.paths[0]=new xi,this._curPath.convex=t}closePath(){this._curPath.loop=!0}newPath(){this._curPath=new xi,this.paths.push(this._curPath)}addPoint(t,e){this._curPath.path.push(t,e)}push(t,e){this._curPath?this._curPath.path.length>0&&(this._curPath=new xi,this.paths.push(this._curPath)):(this._curPath=new xi,this.paths.push(this._curPath));var i=this._curPath;i.path=t.slice(),i.convex=e}reset(){this.paths.length=0}}class xi{constructor(){this.path=[],this.loop=!1,this.convex=!1}}class vi{constructor(){}static _createArray(){var t=[];return t._length=0,t}static _init(){var t=vi._namemap={};return t[vi.TYPE_ALPHA]="ALPHA",t[vi.TYPE_FILESTYLE]="fillStyle",t[vi.TYPE_FONT]="font",t[vi.TYPE_LINEWIDTH]="lineWidth",t[vi.TYPE_STROKESTYLE]="strokeStyle",t[vi.TYPE_ENABLEMERGE]="_mergeID",t[vi.TYPE_MARK]=t[vi.TYPE_TRANSFORM]=t[vi.TYPE_TRANSLATE]=[],t[vi.TYPE_TEXTBASELINE]="textBaseline",t[vi.TYPE_TEXTALIGN]="textAlign",t[vi.TYPE_GLOBALCOMPOSITEOPERATION]="_nBlendType",t[vi.TYPE_SHADER]="shader",t[vi.TYPE_FILTERS]="filters",t[vi.TYPE_COLORFILTER]="_colorFiler",t}isSaveMark(){return!1}restore(t){this._dataObj[this._valueName]=this._value,vi.POOL[vi.POOL._length++]=this,this._newSubmit&&(t.stopMerge=!0)}static save(t,e,i,s){if((t._saveMark._saveuse&e)!==e){t._saveMark._saveuse|=e;var r=vi.POOL,a=r._length>0?r[--r._length]:new vi;a._value=i[a._valueName=vi._namemap[e]],a._dataObj=i,a._newSubmit=s;var n=t._save;n[n._length++]=a}}}vi.TYPE_ALPHA=1,vi.TYPE_FILESTYLE=2,vi.TYPE_FONT=8,vi.TYPE_LINEWIDTH=256,vi.TYPE_STROKESTYLE=512,vi.TYPE_MARK=1024,vi.TYPE_TRANSFORM=2048,vi.TYPE_TRANSLATE=4096,vi.TYPE_ENABLEMERGE=8192,vi.TYPE_TEXTBASELINE=16384,vi.TYPE_TEXTALIGN=32768,vi.TYPE_GLOBALCOMPOSITEOPERATION=65536,vi.TYPE_CLIPRECT=131072,vi.TYPE_CLIPRECT_STENCIL=262144,vi.TYPE_IBVB=524288,vi.TYPE_SHADER=1048576,vi.TYPE_FILTERS=2097152,vi.TYPE_FILTERS_TYPE=4194304,vi.TYPE_COLORFILTER=8388608,vi.POOL=vi._createArray(),vi._namemap=vi._init();class Si{constructor(){this._globalClipMatrix=new G,this._clipInfoID=-1,this._clipRect=new F}isSaveMark(){return!1}restore(t){this._globalClipMatrix.copyTo(t._globalClipMatrix),this._clipRect.clone(t._clipRect),t._clipInfoID=this._clipInfoID,Si.POOL[Si.POOL._length++]=this}static save(t){if((t._saveMark._saveuse&vi.TYPE_CLIPRECT)!=vi.TYPE_CLIPRECT){t._saveMark._saveuse|=vi.TYPE_CLIPRECT;var e=Si.POOL,i=e._length>0?e[--e._length]:new Si;t._globalClipMatrix.copyTo(i._globalClipMatrix),t._clipRect.clone(i._clipRect),i._clipInfoID=t._clipInfoID;var s=t._save;s[s._length++]=i}}}Si.POOL=vi._createArray();class Ei{constructor(){this._saveuse=0}isSaveMark(){return!0}restore(t){t._saveMark=this._preSaveMark,Ei.POOL[Ei.POOL._length++]=this}static Create(t){var e=Ei.POOL,i=e._length>0?e[--e._length]:new Ei;return i._saveuse=0,i._preSaveMark=t._saveMark,t._saveMark=i,i}}Ei.POOL=vi._createArray();class wi{constructor(){this._matrix=new G}isSaveMark(){return!1}restore(t){t._curMat=this._savematrix,wi.POOL[wi.POOL._length++]=this}static save(t){var e=t._saveMark;if((e._saveuse&vi.TYPE_TRANSFORM)!==vi.TYPE_TRANSFORM){e._saveuse|=vi.TYPE_TRANSFORM;var i=wi.POOL,s=i._length>0?i[--i._length]:new wi;s._savematrix=t._curMat,t._curMat=t._curMat.copyTo(s._matrix);var r=t._save;r[r._length++]=s}}}wi.POOL=vi._createArray();class Di{constructor(){this._mat=new G}isSaveMark(){return!1}restore(t){this._mat.copyTo(t._curMat),Di.POOL[Di.POOL._length++]=this}static save(t){var e=Di.POOL,i=e._length>0?e[--e._length]:new Di;t._curMat.copyTo(i._mat);var s=t._save;s[s._length++]=i}}Di.POOL=vi._createArray();var bi;class Ci{destroy(){}static __init__(){ci.addInclude("Sprite2DFrag.glsl","vec3 gammaToLinear(in vec3 value)\n{\n    return pow((value + 0.055) / 1.055, vec3(2.4));\n}\n\nvec4 gammaToLinear(in vec4 value)\n{\n    return vec4(gammaToLinear(value.rgb), value.a);\n}\n\nvec3 linearToGamma(in vec3 value)\n{\n    return vec3(mix(pow(value.rgb, vec3(0.41666)) * 1.055 - vec3(0.055), value.rgb * 12.92, vec3(lessThanEqual(value.rgb, vec3(0.0031308)))));\n\n    // return pow(value, vec3(1.0 / 2.2));\n    // return pow(value, vec3(0.455));\n}\n\nvec4 linearToGamma(in vec4 value)\n{\n    return vec4(linearToGamma(value.rgb), value.a);\n}\n\nvec4 transspaceColor(vec4 color)\n{\n     \n #ifndef GAMMATEXTURE\n     //是linear数据\n     #ifdef GAMMASPACE\n         color.xyz = linearToGamma(color.xyz);    \n     #endif\n #else\n     //gamma数据\n     #ifndef GAMMASPACE\n         color.xyz = gammaToLinear(color.xyz);\n     #endif\n #endif\n     return color;\n }\n\n#if defined(PRIMITIVEMESH)\n    varying vec4 v_color;\n    varying vec2 v_cliped;\n  \n\n    vec4 getGlColor(vec4 color){\n        #ifdef GAMMASPACE\n            return color;\n        #else\n            return gammaToLinear(color);\n        #endif\n    }\n\n#elif defined(TEXTUREVS)\n    varying vec2 v_cliped;\n    varying vec4 v_texcoordAlpha;\n    varying vec4 v_color;\n    varying float v_useTex;\n    \n    //uniform\n    uniform sampler2D u_spriteTexture;\n\n    #ifdef BLUR_FILTER\n        uniform vec4 u_strength_sig2_2sig2_gauss1; // TODO模糊的过程中会导致变暗变亮\n        uniform vec2 u_blurInfo;\n        #define PI 3.141593\n    #endif\n\n    #ifdef COLOR_FILTER\n        uniform vec4 u_colorAlpha;\n        uniform mat4 u_colorMat;\n    #endif\n\n    #ifdef GLOW_FILTER\n        uniform vec4 u_color;\n        uniform vec4 u_blurInfo1;\n        uniform vec4 u_blurInfo2;\n    #endif\n\n    #ifdef COLOR_ADD\n        uniform vec4 u_colorAdd;\n    #endif\n\n    #ifdef FILLTEXTURE\n        uniform vec4 u_TexRange; // startu,startv,urange, vrange\n    #endif\n\n\n    #ifdef BLUR_FILTER\n        float getGaussian(float x, float y)\n        {\n            return u_strength_sig2_2sig2_gauss1.w * exp(-(x * x + y * y) / u_strength_sig2_2sig2_gauss1.z);\n        }\n\n        vec4 blur()\n        {\n            const float blurw = 9.0;\n            vec4 vec4Color = vec4(0.0, 0.0, 0.0, 0.0);\n            vec2 halfsz = vec2(blurw, blurw) / 2.0 / u_blurInfo;\n            vec2 startpos = v_texcoordAlpha.xy - halfsz;\n            vec2 ctexcoord = startpos;\n            vec2 step = 1.0 / u_blurInfo; //每个像素\n\n            for (float y = 0.0; y <= blurw; ++y)\n            {\n                ctexcoord.x = startpos.x;\n                for (float x = 0.0; x <= blurw; ++x)\n                {\n                    // TODO 纹理坐标的固定偏移应该在vs中处理\n                    vec4Color +=transspaceColor(texture2D(u_spriteTexture, ctexcoord) * getGaussian(x - blurw / 2.0, y - blurw / 2.0));\n                    ctexcoord.x += step.x;\n                }\n                ctexcoord.y += step.y;\n            }\n            // vec4Color.w=1.0;  这个会导致丢失alpha。以后有时间再找模糊会导致透明的问题\n            return vec4Color;\n        }\n    #endif\n\n    vec4 getSpriteTextureColor(){\n        #ifdef FILLTEXTURE\n            vec4 color = texture2D(u_spriteTexture, fract(v_texcoordAlpha.xy) * u_TexRange.zw + u_TexRange.xy);\n        #else\n            vec4 color = texture2D(u_spriteTexture, v_texcoordAlpha.xy);\n        #endif\n        return transspaceColor(color);\n    }\n\n    void setglColor(in vec4 color){\n        if (v_useTex <= 0.)\n            color = vec4(1., 1., 1., 1.);\n\n        color.a *= v_color.w;\n        // color.rgb*=v_color.w;\n        vec4 transColor = v_color;\n        #ifndef GAMMASPACE\n            transColor = gammaToLinear(v_color);\n        #endif\n        color.rgb *= transColor.rgb;\n        gl_FragColor = color;\n\n        #ifdef COLOR_ADD\n            gl_FragColor = vec4(u_colorAdd.rgb, u_colorAdd.a * gl_FragColor.a);\n            gl_FragColor.xyz *= u_colorAdd.a;\n        #endif\n\n        #ifdef BLUR_FILTER\n            gl_FragColor = blur();\n            gl_FragColor.w *= v_color.w;\n        #endif\n\n        #ifdef COLOR_FILTER\n            mat4 alphaMat = u_colorMat;\n\n            alphaMat[0][3] *= gl_FragColor.a;\n            alphaMat[1][3] *= gl_FragColor.a;\n            alphaMat[2][3] *= gl_FragColor.a;\n\n            gl_FragColor = gl_FragColor * alphaMat;\n            gl_FragColor += u_colorAlpha / 255.0 * gl_FragColor.a;\n        #endif\n\n        #ifdef GLOW_FILTER\n            const float c_IterationTime = 10.0;\n            float floatIterationTotalTime = c_IterationTime * c_IterationTime;\n            vec4 vec4Color = vec4(0.0, 0.0, 0.0, 0.0);\n            vec2 vec2FilterDir = vec2(-u_blurInfo1.z / u_blurInfo2.x, -u_blurInfo1.w / u_blurInfo2.y);\n            vec2 vec2FilterOff = vec2(u_blurInfo1.x / u_blurInfo2.x / c_IterationTime * 2.0, u_blurInfo1.y / u_blurInfo2.y / c_IterationTime * 2.0);\n            float maxNum = u_blurInfo1.x * u_blurInfo1.y;\n            vec2 vec2Off = vec2(0.0, 0.0);\n            float floatOff = c_IterationTime / 2.0;\n            for (float i = 0.0; i <= c_IterationTime; ++i){\n                for (float j = 0.0; j <= c_IterationTime; ++j){\n                    vec2Off = vec2(vec2FilterOff.x * (i - floatOff), vec2FilterOff.y * (j - floatOff));\n                    vec4Color += transspaceColor(texture2D(u_spriteTexture, v_texcoordAlpha.xy + vec2FilterDir + vec2Off))  ;\n                }\n            }\n            vec4Color /= floatIterationTotalTime;\n            gl_FragColor = vec4(u_color.rgb, vec4Color.a * u_blurInfo2.z);\n            gl_FragColor.rgb *= gl_FragColor.a;\n        #endif\n    }\n#endif\n\n\n\nvoid clip(){\n    if(v_cliped.x<0.) discard;\n    if(v_cliped.x>1.) discard;\n    if(v_cliped.y<0.) discard;\n    if(v_cliped.y>1.) discard;\n}"),ci.addInclude("Sprite2DVertex.glsl",'#include "Sprite2DShaderInfo.glsl";\nuniform vec4 u_clipMatDir;\nuniform vec2 u_clipMatPos;// 这个是全局的，不用再应用矩阵了。\nuniform vec2 u_size;\nuniform float u_VertAlpha;\nvarying vec2 v_cliped;\n#ifdef WORLDMAT\n    uniform mat4 u_mmat;\n    vec4 transedPos;\n#endif\nvarying vec4 v_color;\n\n\n#if defined(PRIMITIVEMESH)\n    // attribute vec4 a_position;\n    // attribute vec4 a_attribColor;\n\n    void getVertexInfo(inout vertexInfo info){\n        info.color = a_attribColor;\n        info.color.a*=u_VertAlpha;\n        float clipw = length(u_clipMatDir.xy);\n        float cliph = length(u_clipMatDir.zw);\n        #ifdef WORLDMAT\n            vec2 clippos = transedPos.xy - u_clipMatPos.xy;\n        #else\n        vec2 clippos = a_position.xy - u_clipMatPos.xy;\t//pos已经应用矩阵了，为了减的有意义，clip的位置也要缩放\n        #endif\n\n        if(clipw>20000. && cliph>20000.)\n            info.cliped = vec2(0.5,0.5);\n        else {\n            //clipdir是带缩放的方向，由于上面clippos是在缩放后的空间计算的，所以需要把方向先normalize一下\n            info.cliped =vec2( dot(clippos,u_clipMatDir.xy)/clipw/clipw, dot(clippos,u_clipMatDir.zw)/cliph/cliph);\n        }\n    }\n\n    void getPosition(inout vec4 pos){\n        pos = vec4(a_position.xy,0.,1.);\n        #ifdef WORLDMAT\n            pos = u_mmat*pos;\n            transedPos=pos;\n            pos = vec4((pos.x/u_size.x-0.5)*2.0,(0.5-pos.y/u_size.y)*2.0,pos.z,1.0);\n        #else\n            pos = vec4((a_position.x/u_size.x-0.5)*2.0,(0.5-a_position.y/u_size.y)*2.0,a_position.z,1.0);\n        #endif\n    }\n\n#elif defined(TEXTUREVS)\n\t//texture和fillrect使用的。\n    // attribute vec4 a_posuv;\n    // attribute vec4 a_attribColor;\n    // attribute vec4 a_attribFlags;\n    #ifdef MVP3D\n        uniform mat4 u_MvpMatrix;\n    #endif\n\n    varying vec4 v_texcoordAlpha;\n    varying float v_useTex;\n\n    void getVertexInfo(inout vertexInfo info){\n       \t//texcoordAlpha\n        info.texcoordAlpha.xy = a_posuv.zw;\n        //color\n        info.color = a_attribColor;\n        info.color.a*=u_VertAlpha;\n\t    info.color.xyz*= info.color.w;//反正后面也要预乘\n        //useTex\n        info.useTex = a_attribFlags.r;\n\n        //clip\n    \tfloat clipw = length(u_clipMatDir.xy);\n    \tfloat cliph = length(u_clipMatDir.zw);\n\t    vec2 clpos = u_clipMatPos.xy;\n        #ifdef WORLDMAT\n            vec2 clippos = transedPos.xy - clpos;\n        #else\n        vec2 clippos = a_posuv.xy - clpos;\t//pos已经应用矩阵了，为了减的有意义，clip的位置也要缩放\n        #endif\n        if(clipw>20000. && cliph>20000.)\n            info.cliped = vec2(0.5,0.5);\n        else {\n            //转成0到1之间。/clipw/clipw 表示clippos与normalize之后的clip朝向点积之后，再除以clipw\n            info.cliped = vec2( dot(clippos,u_clipMatDir.xy)/clipw/clipw, dot(clippos,u_clipMatDir.zw)/cliph/cliph);\n        }\n    }\n\n    void getPosition(inout vec4 glPosition){\n        vec4 pos = vec4(a_posuv.xy,0.,1.);\n        #ifdef WORLDMAT\n            pos= u_mmat * pos;\n            transedPos=pos;//vec4(pos.x,pos.y,0.0,1.0);\n        #endif\n        vec4 pos1 = vec4((pos.x/u_size.x-0.5)*2.0,(0.5-pos.y/u_size.y)*2.0,0.,1.0);\n        #ifdef MVP3D\n            glPosition = u_MvpMatrix * pos1;\n        #else\n            glPosition = pos1;\n        #endif\n        \n        #ifdef INVERTY\n            glPosition.y = -glPosition.y;\n        #endif\n    }\n\n#endif'),ci.addInclude("Sprite2DShaderInfo.glsl","\n#if defined(PRIMITIVEMESH)\n    struct vertexInfo {\n        vec4 color;\n        vec2 cliped;\n    };\n#elif defined(TEXTUREVS)\n   struct vertexInfo {\n        vec4 color;\n        vec2 cliped;\n        vec4 texcoordAlpha;\n        float useTex;\n    };\n#endif"),Ci.textureShader=ci.add("Sprite2DTexture",!1,!1),Ci.textureShader.shaderType=t.ShaderFeatureType.D2;let e=new ui(Ci.textureAttribute,{},{});Ci.textureShader.addSubShader(e),e.addShaderPass('#define SHADER_NAME TextureVS2D\n#include "Sprite2DVertex.glsl";\n\nvoid main() {\n\tvec4 pos;\n\t//先计算位置，再做裁剪\n\tgetPosition(pos);\n\tvertexInfo info;\n\tgetVertexInfo(info);\n\n\tv_cliped = info.cliped;\n\tv_texcoordAlpha = info.texcoordAlpha;\n\tv_useTex = info.useTex;\n\tv_color = info.color;\n\n\tgl_Position = pos;\n\n}\n','#define SHADER_NAME TextureFS2D\n//texture和fillrect使用的。\n#if defined(GL_FRAGMENT_PRECISION_HIGH) // 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\n#include "Sprite2DFrag.glsl";\n\nvoid main()\n{\n    clip();\n    vec4 color = getSpriteTextureColor();\n    setglColor(color);\n}\n'),Ci.primitiveShader=ci.add("Sprite2DPrimitive",!1,!1),Ci.primitiveShader.shaderType=t.ShaderFeatureType.D2,e=new ui(Ci.primitiveAttribute,{},{}),Ci.primitiveShader.addSubShader(e),e.addShaderPass('#define SHADER_NAME PrimitiveVS2D\n#include "Sprite2DVertex.glsl";\n\n\n#ifdef WORLDMAT\n\tuniform mat4 mmat;\n#endif\n\nvoid main(){\n\tvec4 pos;\n\t//先计算位置，再做裁剪\n\tgetPosition(pos);\n\tvertexInfo info;\n\tgetVertexInfo(info);\n\t\n\t//Update \n\tv_color = info.color;\n\tv_cliped = info.cliped;\n\t\n\tgl_Position = pos;\n}','#define SHADER_NAME PrimitiveFS2D\nprecision mediump float;\n\n#include "Sprite2DFrag.glsl";\n\nvoid main(){\n\tclip();\n\tgl_FragColor = getGlColor(v_color);\n\tgl_FragColor.rgb*=gl_FragColor.a;\n}')}}Ci.primitiveAttribute={a_position:[0,t.ShaderDataType.Vector4],a_attribColor:[1,t.ShaderDataType.Vector4]},Ci.textureAttribute={a_posuv:[0,t.ShaderDataType.Vector4],a_attribColor:[1,t.ShaderDataType.Vector4],a_attribFlags:[2,t.ShaderDataType.Vector4]};class Ri{static __init__(){Ri.TEXTURE2D=ci.getDefineByName("TEXTURE2D"),Ri.PRIMITIVE=ci.getDefineByName("PRIMITIVE"),Ri.FILTERGLOW=ci.getDefineByName("GLOW_FILTER"),Ri.FILTERBLUR=ci.getDefineByName("BLUR_FILTER"),Ri.FILTERCOLOR=ci.getDefineByName("COLOR_FILTER"),Ri.COLORADD=ci.getDefineByName("COLOR_ADD"),Ri.WORLDMAT=ci.getDefineByName("WORLDMAT"),Ri.FILLTEXTURE=ci.getDefineByName("FILLTEXTURE"),Ri.MVP3D=ci.getDefineByName("MVP3D"),Ri.GAMMASPACE=ci.getDefineByName("GAMMASPACE"),Ri.INVERTY=ci.getDefineByName("INVERTY"),Ri.GAMMATEXTURE=ci.getDefineByName("GAMMATEXTURE"),Ri.TEXTURESHADER=ci.getDefineByName("TEXTUREVS"),Ri.PRIMITIVESHADER=ci.getDefineByName("PRIMITIVEMESH"),Ri.initSprite2DCommandEncoder()}static initSprite2DCommandEncoder(){Ri.UNIFORM_MMAT=ci.propertyNameToID("u_mmat"),Ri.UNIFORM_CLIPMATDIR=ci.propertyNameToID("u_clipMatDir"),Ri.UNIFORM_CLIPMATPOS=ci.propertyNameToID("u_clipMatPos"),Ri.UNIFORM_MMAT2=ci.propertyNameToID("u_mmat2"),Ri.UNIFORM_SIZE=ci.propertyNameToID("u_size"),Ri.UNIFORM_VERTALPHA=ci.propertyNameToID("u_VertAlpha"),Ri.UNIFORM_MVPMatrix=ci.propertyNameToID("u_MvpMatrix"),Ri.UNIFORM_SPRITETEXTURE=ci.propertyNameToID("u_spriteTexture"),Ri.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1=ci.propertyNameToID("u_strength_sig2_2sig2_gauss1"),Ri.UNIFORM_BLURINFO=ci.propertyNameToID("u_blurInfo"),Ri.UNIFORM_COLORALPHA=ci.propertyNameToID("u_colorAlpha"),Ri.UNIFORM_COLORMAT=ci.propertyNameToID("u_colorMat"),Ri.UNIFORM_COLOR=ci.propertyNameToID("u_color"),Ri.UNIFORM_BLURINFO1=ci.propertyNameToID("u_blurInfo1"),Ri.UNIFORM_BLURINFO2=ci.propertyNameToID("u_blurInfo2"),Ri.UNIFORM_COLORADD=ci.propertyNameToID("u_colorAdd"),Ri.UNIFORM_TEXRANGE=ci.propertyNameToID("u_TexRange");const e=l.renderDeviceFactory.createGlobalUniformMap("Sprite2D");e.addShaderUniform(Ri.UNIFORM_MMAT,"u_mmat",t.ShaderDataType.Matrix4x4),e.addShaderUniform(Ri.UNIFORM_CLIPMATDIR,"u_clipMatDir",t.ShaderDataType.Vector4),e.addShaderUniform(Ri.UNIFORM_CLIPMATPOS,"u_clipMatPos",t.ShaderDataType.Vector2),e.addShaderUniform(Ri.UNIFORM_MMAT2,"u_mmat2",t.ShaderDataType.Matrix4x4),e.addShaderUniform(Ri.UNIFORM_SIZE,"u_size",t.ShaderDataType.Vector2),e.addShaderUniform(Ri.UNIFORM_VERTALPHA,"u_VertAlpha",t.ShaderDataType.Float),e.addShaderUniform(Ri.UNIFORM_MVPMatrix,"u_MvpMatrix",t.ShaderDataType.Matrix4x4),e.addShaderUniform(Ri.UNIFORM_SPRITETEXTURE,"u_spriteTexture",t.ShaderDataType.Texture2D),e.addShaderUniform(Ri.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1,"u_strength_sig2_2sig2_gauss1",t.ShaderDataType.Vector4),e.addShaderUniform(Ri.UNIFORM_BLURINFO,"u_blurInfo",t.ShaderDataType.Vector2),e.addShaderUniform(Ri.UNIFORM_COLORALPHA,"u_colorAlpha",t.ShaderDataType.Vector4),e.addShaderUniform(Ri.UNIFORM_COLORMAT,"u_colorMat",t.ShaderDataType.Matrix4x4),e.addShaderUniform(Ri.UNIFORM_COLOR,"u_color",t.ShaderDataType.Vector4),e.addShaderUniform(Ri.UNIFORM_BLURINFO1,"u_blurInfo1",t.ShaderDataType.Vector4),e.addShaderUniform(Ri.UNIFORM_BLURINFO2,"u_blurInfo2",t.ShaderDataType.Vector4),e.addShaderUniform(Ri.UNIFORM_COLORADD,"u_colorAdd",t.ShaderDataType.Vector4),e.addShaderUniform(Ri.UNIFORM_TEXRANGE,"u_TexRange",t.ShaderDataType.Vector4)}}t.RenderSpriteData=void 0,(bi=t.RenderSpriteData||(t.RenderSpriteData={}))[bi.Zero=0]="Zero",bi[bi.Texture2D=1]="Texture2D",bi[bi.Primitive=2]="Primitive";class Ai{constructor(e){this._needRelease=!1,this.mainID=t.RenderSpriteData.Zero,this.ref=1,this._cacheID=0,this.mainID=e,Ai.prototype.initialize.call(this)}initialize(){let e=this.mainID;this.shaderData=this.shaderData||l.renderDeviceFactory.createShaderData(null),this.mainID==t.RenderSpriteData.Texture2D&&this.shaderData.addDefine(Ri.TEXTURESHADER),this.mainID==t.RenderSpriteData.Primitive&&this.shaderData.addDefine(Ri.PRIMITIVESHADER),this.textureHost=null,this.clipMatDir=new u(Ut.MAX_CLIP_SIZE,0,0,Ut.MAX_CLIP_SIZE),this.clipMatPos=new Ze,this._cacheID=e;let i=Ai._cache[this._cacheID];e>0&&!i&&(i=Ai._cache[this._cacheID]=[],i._length=0),this.shaderData.setBool(ci.DEPTH_WRITE,!1),this.shaderData.setInt(ci.DEPTH_TEST,ve.DEPTHTEST_OFF),this.shaderData.setInt(ci.BLEND,ve.BLEND_ENABLE_ALL),this.shaderData.setInt(ci.BLEND_EQUATION,ve.BLENDEQUATION_ADD),this.shaderData.setInt(ci.BLEND_SRC,ve.BLENDPARAM_ONE),this.shaderData.setInt(ci.BLEND_DST,ve.BLENDPARAM_ONE_MINUS_SRC_ALPHA),this.shaderData.setNumber(Ri.UNIFORM_VERTALPHA,1),this.shaderData.setInt(ci.CULL,ve.CULL_NONE)}reinit(){this.initialize()}static _initone(t,e){Ai._compileDefine=l.unitRenderModuleDataFactory.createDefineDatas(),Ai._typeClass[t]=e,Ai._cache[t]=[],Ai._cache[t]._length=0,Ai.globalShaderData=l.renderDeviceFactory.createShaderData(null)}static create(t){var e=Ai._cache[t]?Ai._cache[t]:[];if(e._length){let t=e[--e._length];return t.reinit(),t}return new Ai._typeClass[t]}set size(t){this.shaderData.setVector2(Ri.UNIFORM_SIZE,t)}get size(){return this.shaderData.getVector2(Ri.UNIFORM_SIZE)}set vertAlpha(t){this.shaderData.setNumber(Ri.UNIFORM_VERTALPHA,t)}get vertAlpha(){return this.shaderData.getNumber(Ri.UNIFORM_VERTALPHA)}set mmat(t){this.shaderData.setMatrix4x4(Ri.UNIFORM_MMAT,t)}get mmat(){return this.shaderData.getMatrix4x4(Ri.UNIFORM_MMAT)}set u_MvpMatrix(t){this.shaderData.setMatrix4x4(Ri.UNIFORM_MVPMatrix,t)}get u_MvpMatrix(){return this.shaderData.getMatrix4x4(Ri.UNIFORM_MVPMatrix)}get textureHost(){return this._textureHost}set textureHost(t){this._textureHost=t;let e,i=!1;this.textureHost&&(this.textureHost instanceof C?i=1!=this.textureHost.gammaCorrection:this.textureHost instanceof mt&&this.textureHost.bitmap&&(i=1!=this.textureHost.bitmap.gammaCorrection)),i?this.shaderData.addDefine(Ri.GAMMATEXTURE):this.shaderData.removeDefine(Ri.GAMMATEXTURE),e=t instanceof mt?t.bitmap:t,this.shaderData.setTexture(Ri.UNIFORM_SPRITETEXTURE,e)}set color(t){t&&this.shaderData.setVector(Ri.UNIFORM_COLOR,t)}get color(){return this.shaderData.getVector(Ri.UNIFORM_COLOR)}set colorAdd(t){this.shaderData.setVector(Ri.UNIFORM_COLORADD,t)}get colorAdd(){return this.shaderData.getVector(Ri.UNIFORM_COLORADD)}set clipMatDir(t){this.shaderData.setVector(Ri.UNIFORM_CLIPMATDIR,t)}get clipMatDir(){return this.shaderData.getVector(Ri.UNIFORM_CLIPMATDIR)}set clipMatPos(t){this.shaderData.setVector2(Ri.UNIFORM_CLIPMATPOS,t)}get clipMatPos(){return this.shaderData.getVector2(Ri.UNIFORM_CLIPMATPOS)}upload(t,e){}setFilter(t){t&&this.shaderData.addDefine(t.typeDefine)}clear(){this.shaderData&&this.shaderData.clearDefine()}blendNormal(){this.shaderData.setInt(ci.BLEND_SRC,ve.BLENDPARAM_SRC_ALPHA),this.shaderData.setInt(ci.BLEND_DST,ve.BLENDPARAM_ONE_MINUS_SRC_ALPHA)}blendPremulAlpha(){this.shaderData.setInt(ci.BLEND_SRC,ve.BLENDPARAM_ONE),this.shaderData.setInt(ci.BLEND_DST,ve.BLENDPARAM_ONE_MINUS_SRC_ALPHA)}blendAdd(){this.shaderData.setInt(ci.BLEND_SRC,ve.BLENDPARAM_ONE),this.shaderData.setInt(ci.BLEND_DST,ve.BLENDPARAM_ONE)}blendMask(){this.shaderData.setInt(ci.BLEND_SRC,ve.BLENDPARAM_ZERO),this.shaderData.setInt(ci.BLEND_DST,ve.BLENDPARAM_SRC_ALPHA)}release(){if(--this.ref<1){let t=Ai._cache[this._cacheID];t&&(t[t._length++]=this),this.clear(),this.filters=null,this.ref=1}}}Ai._cache=[],Ai._typeClass=[];const Ii=15*Math.PI/180,Mi=new Array(256),Bi=new Array(4),Li=new Ze;class Pi{static _checkMinAngle(t,e,i,s,r,a){const n=i-t,l=s-e,o=r-i,h=a-s,u=(n*o+l*h)/(Math.sqrt(n*n+l*l)*Math.sqrt(o*o+h*h)),d=Math.acos(Math.abs(u));return Math.abs(d)<Ii}static createLine2(t,e,i,s,r,a){if(t.length<4)return null;let n=s;var l=Mi.length>t.length+2?Mi:new Array(t.length+2);l[0]=t[0],l[1]=t[1];var o=2,h=0,u=t.length;for(h=2;h<u;h+=2)Math.abs(t[h]-t[h-2])+Math.abs(t[h+1]-t[h-1])>.01&&(l[o++]=t[h],l[o++]=t[h+1]);let d=Math.abs(t[0]-l[o-2])+Math.abs(t[1]-l[o-1]);a&&d>0&&(d>1e-13?(l[o++]=t[0],l[o++]=t[1]):(l[o-2]=t[0],l[o-1]=t[1]));var c=r;u=o/2;var _,p,f,g,m,y,T=i/2;for(_=l[0],p=l[1],f=l[2],g=l[3],this.getNormal(_,p,f,g,T,Li),c.push(_-Li.x,p-Li.y,_+Li.x,p+Li.y),h=1;h<u-1;h++)_=l[2*(h-1)],p=l[2*(h-1)+1],f=l[2*h],g=l[2*h+1],m=l[2*(h+1)],y=l[2*(h+1)+1],e.push(s+0,s+1,s+3,s+3,s+2,s+0),s+=2,s+=this._setMiddleVertexs(_,p,f,g,m,y,T,c,Li,e,s);if(_=l[o-4],p=l[o-3],f=l[o-2],g=l[o-1],this.getNormal(_,p,f,g,T,Li),c.push(f-Li.x,g-Li.y,f+Li.x,g+Li.y),e.push(s+0,s+1,s+3,s+3,s+2,s+0),f==l[0]&&g==l[1]){m=l[2],y=l[3];let t=c.length/2;s+=4,Bi[0]=n+t-2,Bi[1]=n+t-1,Bi[2]=n,Bi[3]=n+1,this._setMiddleVertexs(_,p,f,g,m,y,T,c,Li,e,s,Bi)}return c}static _setMiddleVertexs(t,e,i,s,r,a,n,l,o,h,u,d=null){this.getNormal(t,e,i,s,n,o);let c=o.x,_=o.y;this.getNormal(i,s,r,a,n,o);let p=o.x,f=o.y;if(this._checkMinAngle(t,e,i,s,r,a))return d?h.push(d[0],d[1],d[3],d[3],d[2],d[0]):(l.push(i-c,s-_,i+c,s+_),l.push(i-p,s-f,i+p,s+f),h.push(u+0,u+1,u+3,u+3,u+2,u+0)),2;let g=-_+e-(-_+s),m=-c+i-(-c+t),y=(-c+t)*(-_+s)-(-c+i)*(-_+e),T=-f+a-(-f+s),x=-p+i-(-p+r),v=(-p+r)*(-f+s)-(-p+i)*(-f+a),S=g*x-T*m;if(S=g*x-T*m,Math.abs(S)<.1)return S+=10.1,l.push(i-c,s-_,i+c,s+_),0;let E=(m*v-x*y)/S,w=(T*y-g*v)/S;return d?S>0?(l.push(E,w,i,s),h.push(d[0],u+0,d[2]),h.push(d[2],u+1,d[0])):(l.push(i-(E-i),s-(w-s),i,s),h.push(d[1],u+0,d[3]),h.push(d[3],u+1,d[1])):(l.push(i-c,s-_,i+c,s+_),S>0?(l.push(E,w,i,s),h.push(u+0,u+2,u+4),h.push(u+4,u+3,u+0)):(l.push(i-(E-i),s-(w-s),i,s),h.push(u+1,u+2,u+5),h.push(u+5,u+3,u+1)),l.push(i-p,s-f,i+p,s+f)),4}static getNormal(t,e,i,s,r,a){a||(a=new Ze);let n=s-e,l=t-i,o=Math.sqrt(n*n+l*l);return a.x=n/o*r,a.y=l/o*r,a}static createLineTriangle(t,e,i,s,r,a,n){var l=t.slice(),o=l.length,h=l[0],u=l[1],d=l[2],c=(l[2],0),_=0,p=0,f=0,g=o/2;if(!(g<=1)&&2!=g){for(var m=new Array(4*g),y=0,T=0,x=0;x<g-1;x++)h=l[T++],u=l[T++],d=l[T++],f=l[T++]-u,0!=(p=d-h)&&0!=f&&(c=Math.sqrt(p*p+f*f))>.001&&(m[_=4*y]=h,m[_+1]=u,m[_+2]=p/c,m[_+3]=f/c,y++);for(s?(h=l[o-2],u=l[o-1],d=l[0],f=l[1]-u,0!=(p=d-h)&&0!=f&&(c=Math.sqrt(p*p+f*f))>.001&&(m[_=4*y]=h,m[_+1]=u,m[_+2]=p/c,m[_+3]=f/c,y++)):(m[_=4*y]=h,m[_+1]=u,m[_+2]=p/c,m[_+3]=f/c,y++),T=0,x=0;x<g;x++)h=l[T],u=l[T+1],d=l[T+2],l[T+3]}}}class Ni{constructor(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}}class Oi{static earcut(t,e,i){i=i||2;var s,r,a,n,l,o,h,u=e&&e.length,d=u?e[0]*i:t.length,c=Oi.linkedList(t,0,d,i,!0),_=[];if(!c)return _;if(u&&(c=Oi.eliminateHoles(t,e,c,i)),t.length>80*i){s=a=t[0],r=n=t[1];for(var p=i;p<d;p+=i)(l=t[p])<s&&(s=l),(o=t[p+1])<r&&(r=o),l>a&&(a=l),o>n&&(n=o);h=0!==(h=Math.max(a-s,n-r))?1/h:0}return Oi.earcutLinked(c,_,i,s,r,h),_}static linkedList(t,e,i,s,r){var a,n;if(r===Oi.signedArea(t,e,i,s)>0)for(a=e;a<i;a+=s)n=Oi.insertNode(a,t[a],t[a+1],n);else for(a=i-s;a>=e;a-=s)n=Oi.insertNode(a,t[a],t[a+1],n);return n&&Oi.equals(n,n.next)&&(Oi.removeNode(n),n=n.next),n}static filterPoints(t,e){if(!t)return t;e||(e=t);var i,s=t;do{if(i=!1,s.steiner||!Oi.equals(s,s.next)&&0!==Oi.area(s.prev,s,s.next))s=s.next;else{if(Oi.removeNode(s),(s=e=s.prev)===s.next)break;i=!0}}while(i||s!==e);return e}static earcutLinked(t,e,i,s,r,a,n=null){if(t){!n&&a&&Oi.indexCurve(t,s,r,a);for(var l,o,h=t;t.prev!==t.next;)if(l=t.prev,o=t.next,a?Oi.isEarHashed(t,s,r,a):Oi.isEar(t))e.push(l.i/i),e.push(t.i/i),e.push(o.i/i),Oi.removeNode(t),t=o.next,h=o.next;else if((t=o)===h){n?1===n?(t=Oi.cureLocalIntersections(t,e,i),Oi.earcutLinked(t,e,i,s,r,a,2)):2===n&&Oi.splitEarcut(t,e,i,s,r,a):Oi.earcutLinked(Oi.filterPoints(t,null),e,i,s,r,a,1);break}}}static isEar(t){var e=t.prev,i=t,s=t.next;if(Oi.area(e,i,s)>=0)return!1;for(var r=t.next.next;r!==t.prev;){if(Oi.pointInTriangle(e.x,e.y,i.x,i.y,s.x,s.y,r.x,r.y)&&Oi.area(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}static isEarHashed(t,e,i,s){var r=t.prev,a=t,n=t.next;if(Oi.area(r,a,n)>=0)return!1;for(var l=r.x<a.x?r.x<n.x?r.x:n.x:a.x<n.x?a.x:n.x,o=r.y<a.y?r.y<n.y?r.y:n.y:a.y<n.y?a.y:n.y,h=r.x>a.x?r.x>n.x?r.x:n.x:a.x>n.x?a.x:n.x,u=r.y>a.y?r.y>n.y?r.y:n.y:a.y>n.y?a.y:n.y,d=Oi.zOrder(l,o,e,i,s),c=Oi.zOrder(h,u,e,i,s),_=t.nextZ;_&&_.z<=c;){if(_!==t.prev&&_!==t.next&&Oi.pointInTriangle(r.x,r.y,a.x,a.y,n.x,n.y,_.x,_.y)&&Oi.area(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(_=t.prevZ;_&&_.z>=d;){if(_!==t.prev&&_!==t.next&&Oi.pointInTriangle(r.x,r.y,a.x,a.y,n.x,n.y,_.x,_.y)&&Oi.area(_.prev,_,_.next)>=0)return!1;_=_.prevZ}return!0}static cureLocalIntersections(t,e,i){var s=t;do{var r=s.prev,a=s.next.next;!Oi.equals(r,a)&&Oi.intersects(r,s,s.next,a)&&Oi.locallyInside(r,a)&&Oi.locallyInside(a,r)&&(e.push(r.i/i),e.push(s.i/i),e.push(a.i/i),Oi.removeNode(s),Oi.removeNode(s.next),s=t=a),s=s.next}while(s!==t);return s}static splitEarcut(t,e,i,s,r,a){var n=t;do{for(var l=n.next.next;l!==n.prev;){if(n.i!==l.i&&Oi.isValidDiagonal(n,l)){var o=Oi.splitPolygon(n,l);return n=Oi.filterPoints(n,n.next),o=Oi.filterPoints(o,o.next),Oi.earcutLinked(n,e,i,s,r,a),void Oi.earcutLinked(o,e,i,s,r,a)}l=l.next}n=n.next}while(n!==t)}static eliminateHoles(t,e,i,s){var r,a,n,l,o,h=[];for(r=0,a=e.length;r<a;r++)n=e[r]*s,l=r<a-1?e[r+1]*s:t.length,(o=Oi.linkedList(t,n,l,s,!1))===o.next&&(o.steiner=!0),h.push(Oi.getLeftmost(o));for(h.sort(Oi.compareX),r=0;r<h.length;r++)Oi.eliminateHole(h[r],i),i=Oi.filterPoints(i,i.next);return i}static compareX(t,e){return t.x-e.x}static eliminateHole(t,e){if(e=Oi.findHoleBridge(t,e)){var i=Oi.splitPolygon(e,t);Oi.filterPoints(i,i.next)}}static findHoleBridge(t,e){var i,s=e,r=t.x,a=t.y,n=-1/0;do{if(a<=s.y&&a>=s.next.y&&s.next.y!==s.y){var l=s.x+(a-s.y)*(s.next.x-s.x)/(s.next.y-s.y);if(l<=r&&l>n){if(n=l,l===r){if(a===s.y)return s;if(a===s.next.y)return s.next}i=s.x<s.next.x?s:s.next}}s=s.next}while(s!==e);if(!i)return null;if(r===n)return i.prev;var o,h=i,u=i.x,d=i.y,c=1/0;for(s=i.next;s!==h;)r>=s.x&&s.x>=u&&r!==s.x&&Oi.pointInTriangle(a<d?r:n,a,u,d,a<d?n:r,a,s.x,s.y)&&((o=Math.abs(a-s.y)/(r-s.x))<c||o===c&&s.x>i.x)&&Oi.locallyInside(s,t)&&(i=s,c=o),s=s.next;return i}static indexCurve(t,e,i,s){var r=t;do{null===r.z&&(r.z=Oi.zOrder(r.x,r.y,e,i,s)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,Oi.sortLinked(r)}static sortLinked(t){var e,i,s,r,a,n,l,o,h=1;do{for(i=t,t=null,a=null,n=0;i;){for(n++,s=i,l=0,e=0;e<h&&(l++,s=s.nextZ);e++);for(o=h;l>0||o>0&&s;)0!==l&&(0===o||!s||i.z<=s.z)?(r=i,i=i.nextZ,l--):(r=s,s=s.nextZ,o--),a?a.nextZ=r:t=r,r.prevZ=a,a=r;i=s}a.nextZ=null,h*=2}while(n>1);return t}static zOrder(t,e,i,s,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-s)*r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}static getLeftmost(t){var e=t,i=t;do{e.x<i.x&&(i=e),e=e.next}while(e!==t);return i}static pointInTriangle(t,e,i,s,r,a,n,l){return(r-n)*(e-l)-(t-n)*(a-l)>=0&&(t-n)*(s-l)-(i-n)*(e-l)>=0&&(i-n)*(a-l)-(r-n)*(s-l)>=0}static isValidDiagonal(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!Oi.intersectsPolygon(t,e)&&Oi.locallyInside(t,e)&&Oi.locallyInside(e,t)&&Oi.middleInside(t,e)}static area(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}static equals(t,e){return t.x===e.x&&t.y===e.y}static intersects(t,e,i,s){return!!(Oi.equals(t,e)&&Oi.equals(i,s)||Oi.equals(t,s)&&Oi.equals(i,e))||Oi.area(t,e,i)>0!=Oi.area(t,e,s)>0&&Oi.area(i,s,t)>0!=Oi.area(i,s,e)>0}static intersectsPolygon(t,e){var i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&Oi.intersects(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}static locallyInside(t,e){return Oi.area(t.prev,t,t.next)<0?Oi.area(t,e,t.next)>=0&&Oi.area(t,t.prev,e)>=0:Oi.area(t,e,t.prev)<0||Oi.area(t,t.next,e)<0}static middleInside(t,e){var i=t,s=!1,r=(t.x+e.x)/2,a=(t.y+e.y)/2;do{i.y>a!=i.next.y>a&&i.next.y!==i.y&&r<(i.next.x-i.x)*(a-i.y)/(i.next.y-i.y)+i.x&&(s=!s),i=i.next}while(i!==t);return s}static splitPolygon(t,e){var i=new Ni(t.i,t.x,t.y),s=new Ni(e.i,e.x,e.y),r=t.next,a=e.prev;return t.next=e,e.prev=t,i.next=r,r.prev=i,s.next=i,i.prev=s,a.next=s,s.prev=a,s}static insertNode(t,e,i,s){var r=new Ni(t,e,i);return s?(r.next=s.next,r.prev=s,s.next.prev=r,s.next=r):(r.prev=r,r.next=r),r}static removeNode(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}static signedArea(t,e,i,s){for(var r=0,a=e,n=i-s;a<i;a+=s)r+=(t[n]-t[a])*(t[a+1]+t[n+1]),n=a;return r}}class Fi{constructor(){this.clear()}clear(){this.submitType=-1,this.blendShader=this.other=0}}class Ui{constructor(){this.clipInfoID=-1,this.blendType=-1,this._id=0,this._renderType=0,this._key=new Fi,this._startIdx=0,this._numEle=0,this._colorFiler=null,this.shaderValue=null,this._id=++Ui.ID}static create(t,e,i){var s=new Ui;s._mesh=e,s._key.clear(),s._key.submitType=Ui.KEY_DRAWTEXTURE,s._startIdx=e.indexNum*Ut.INDEX_BYTES,s._numEle=0;var r=t._nBlendType;return s._key.blendShader=r,s.shaderValue=i,s.material=t._material,s._colorFiler=t._colorFiler,s}}Ui.KEY_ONCE=-1,Ui.KEY_FILLRECT=1,Ui.KEY_DRAWTEXTURE=2,Ui.KEY_VG=3,Ui.KEY_TRIANGLES=4,Ui.ID=1,Ui.RENDERBASE=new Ui;class ki{}ki.loopStTm=0,ki.loopCount=0;class Gi{constructor(t){this._data=[],this._ndata=0,this._clipid=-1,this._clipMatrix=new G,this._enable=!1,this._clipid=t._clipInfoID,t._globalClipMatrix.copyTo(this._clipMatrix)}clear(){this._tex=null,this._imgId=-1,this._ndata=0,this._enable=!1,this._colorFiler=null}destroy(){this.clear(),this._data.length=0,this._data=null}add(t,e,i,s,r,a){this._ndata>0&&(this._tex!=e||this._imgId!=i||this._clipid>=0&&this._clipid!=t._clipInfoID)&&this.submit(t),this._clipid=t._clipInfoID,t._globalClipMatrix.copyTo(this._clipMatrix),this._tex=e,this._imgId=i,this._colorFiler=t._colorFiler,this._data[this._ndata]=s,this._data[this._ndata+1]=r,this._data[this._ndata+2]=a,this._ndata+=3}getPos(){return 0==Gi.__nPosPool?new Array(8):Gi.__posPool[--Gi.__nPosPool]}enable(t,e){t!==this._enable&&(this._enable=t,this._enable||this.submit(e))}submit(e){var i=this._ndata;if(!i)return;e.drawLeftData();let s=Ai.create(t.RenderSpriteData.Texture2D);e.fillShaderValue(s),s.textureHost=this._tex;let r=e._mesh=e._meshQuatTex,a=e._curSubmit=Ui.create(e,r,s);a._key.other=this._imgId,a._colorFiler=this._colorFiler;var n=s.clipMatDir;let l=this._clipMatrix;n.x=l.a,n.y=l.b,n.z=l.c,n.w=l.d,s.clipMatDir=n;var o=s.clipMatPos;o.x=l.tx,o.y=l.ty,s.clipMatPos=o,a.clipInfoID=this._clipid;for(var h=0;h<i;h+=3)r.addQuad(this._data[h],this._data[h+1],this._data[h+2],!0),Gi.__posPool[Gi.__nPosPool++]=this._data[h];this._ndata=0,ki.loopCount%100==0&&(this._data.length=0),e.drawLeftData()}}Gi.__posPool=[],Gi.__nPosPool=0;class Vi{constructor(){this.isRandomTouch=!0,this.char="",this.deleted=!1,this.uv=new Array(8),this.pos=0,this.orix=0,this.oriy=0,this.touchTick=0,this.isSpace=!1}touch(){var t=ki.loopCount;this.touchTick!=t&&(this.texture.touchRect(this,t),this.touchTick=t)}}var Hi=[0,0,0,0];const zi=new Vi;class Wi{constructor(t){this.charRender=t}getFontSizeInfo(t,e){let i="bold "+e+"px "+t;Hi[0]=e/2,Hi[1]=e/2,Hi[2]=e,Hi[3]=e;this.charRender.scale(1,1),zi.height=e,this.charRender.fontsz=e;var s=this.charRender.getCharBmp("g",i,0,"red",null,zi,16,16,16,16);return this.bmpData32=new Uint32Array(s.data.buffer),this.updateBbx(s,Hi,!1),s=this.charRender.getCharBmp("有",i,0,"red",null,zi,16,16,16,16),this.bmpData32=new Uint32Array(s.data.buffer),Hi[2]<16+zi.width&&(Hi[2]=16+zi.width),this.updateBbx(s,Hi,!1),Math.max(16-Hi[0],0)<<24|Math.max(16-Hi[1],0)<<16|Hi[2]-Hi[0]<<8|Hi[3]-Hi[1]}checkBmpLine(t,e,i,s){this.bmpData32.buffer!=t.data.buffer&&(this.bmpData32=new Uint32Array(t.data.buffer));for(var r=t.width*e+i,a=i;a<s;a++)if(0!=this.bmpData32[r++])return!0;return!1}updateBbx(t,e,i=!1){var s=t.width,r=t.height,a=0,n=e[1],l=0,o=n;if(this.checkBmpLine(t,n,0,s))for(;;){if((o=(n+l)/2|0)+1>=n){e[1]=o;break}this.checkBmpLine(t,o,0,s)?n=o:l=o}if(e[3]>r)e[3]=r;else if(o=n=e[3],l=r,this.checkBmpLine(t,n,0,s))for(;;){if((o=(n+l)/2|0)-1<=n){e[3]=o;break}this.checkBmpLine(t,o,0,s)?n=o:l=o}if(!i){var h=e[0],u=s*e[1];for(o=e[1];o<e[3];o++){for(a=0;a<h;a++)if(0!=this.bmpData32[u+a]){h=a;break}u+=s}e[0]=h;var d=e[2];for(u=s*e[1],o=e[1];o<e[3];o++){for(a=d;a<s;a++)if(0!=this.bmpData32[u+a]){d=a;break}u+=s}e[2]=d}}}class Yi{constructor(t=0,e=0,i=0){this.atlasID=0,this._width=0,this._height=0,this._texCount=0,this._rowInfo=null,this._cells=null,this._used=0,this._cells=null,this._rowInfo=null,this.atlasID=i,this._init(t,e)}addRect(t,e,i,s){return!!this._get(e,i,s)&&(this._fill(s.x,s.y,e,i,t),this._texCount++,!0)}_release(){this._cells=null,this._rowInfo=null}_init(t,e){return this._width=t,this._height=e,this._release(),0!=this._width&&(this._cells=new Uint8Array(this._width*this._height*3),this._rowInfo=new Uint8Array(this._height),this._used=0,this._clear(),!0)}_get(t,e,i){if(t>this._width||e>this._height)return!1;for(var s=-1,r=-1,a=this._width,n=this._height,l=this._cells,o=0;o<n;o++)if(!(this._rowInfo[o]<t))for(var h=0;h<a;){var u=3*(o*a+h);if(0!=l[u]||l[u+1]<t||l[u+2]<e)h+=l[u+1];else{s=h,r=o;for(var d=0;d<t;d++)if(l[3*d+u+2]<e){s=-1;break}if(!(s<0))return i.x=s,i.y=r,!0;h+=l[u+1]}}return!1}_fill(t,e,i,s,r){var a=this._width,n=this._height;this._check(t+i<=a&&e+s<=n);for(var l=e;l<s+e;++l){this._check(this._rowInfo[l]>=i),this._rowInfo[l]-=i;for(var o=0;o<i;o++){var h=3*(t+l*a+o);this._check(0==this._cells[h]),this._cells[h]=r,this._cells[h+1]=i,this._cells[h+2]=s}}if(t>0)for(l=0;l<s;++l){var u=0;for(o=t-1;o>=0&&0==this._cells[3*((e+l)*a+o)];--o,++u);for(o=u;o>0;--o)this._cells[3*((e+l)*a+t-o)+1]=o,this._check(o>0)}if(e>0)for(o=t;o<t+i;++o){for(u=0,l=e-1;l>=0&&0==this._cells[3*(o+l*a)];--l,u++);for(l=u;l>0;--l)this._cells[3*(o+(e-l)*a)+2]=l,this._check(l>0)}this._used+=i*s/(this._width*this._height)}_check(t){0==t&&console.log("xtexMerger 错误啦")}_clear(){this._texCount=0;for(var t=0;t<this._height;t++)this._rowInfo[t]=this._width;for(var e=0;e<this._height;e++)for(var i=0;i<this._width;i++){var s=3*(e*this._width+i);this._cells[s]=0,this._cells[s+1]=this._width-i,this._cells[s+2]=this._width-e}}}var Xi;t.WrapMode=void 0,(Xi=t.WrapMode||(t.WrapMode={}))[Xi.Repeat=0]="Repeat",Xi[Xi.Clamp=1]="Clamp",Xi[Xi.Mirrored=2]="Mirrored";class ji extends ct{constructor(e=es.atlasWidth,i=es.atlasWidth){super(e,i,t.TextureFormat.R8G8B8A8,!1,!1,!0,!0),this._discardTm=0,this.genID=0,this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=0,this.ri=null,this.setPixelsData(null,!0,!1),this.lock=!0,this.filterMode=t.FilterMode.Bilinear,this.wrapModeU=t.WrapMode.Clamp,this.wrapModeV=t.WrapMode.Clamp,es.debugUV&&this.fillWhite()}addChar(t,e,i,s=null){if(es.isWan1Wan)return this.addCharCanvas(t,e,i,s);var r,a,n,o,h=t.data;return t.data instanceof Uint8ClampedArray&&(h=new Uint8Array(h.buffer)),l.textureContext.setTextureSubPixelsData(this._texture,h,0,!1,e,i,t.width,t.height,!0,!1),r=e/this.width,a=i/this.height,n=(e+t.width)/this.width,o=(i+t.height)/this.height,(s=s||new Array(8))[0]=r,s[1]=a,s[2]=n,s[3]=a,s[4]=n,s[5]=o,s[6]=r,s[7]=o,s}addCharCanvas(t,e,i,s=null){var r,a,o,h;return l.textureContext.setTextureSubImageData(this._texture,t,e,i,!0,!1),n.isConch?(r=e/this.width,a=i/this.height,o=(e+t.width)/this.width,h=(i+t.height)/this.height):(r=(e+1)/this.width,a=(i+1)/this.height,o=(e+t.width-1)/this.width,h=(i+t.height-1)/this.height),(s=s||new Array(8))[0]=r,s[1]=a,s[2]=o,s[3]=a,s[4]=o,s[5]=h,s[6]=r,s[7]=h,s}fillWhite(){var t=new Uint8Array(this.width*this.height*4);t.fill(255),l.textureContext.setTextureImageData(this._getSource(),t,!0,!1)}discard(){e.stage.setGlobalRepaint(),this.destroy()}static getTextTexture(t,e){return new ji(t,e)}_disposeResource(){this.destroy()}static clean(){var t=ki.loopStTm;if(0===ji.cleanTm&&(ji.cleanTm=t),t-ji.cleanTm>=es.checkCleanTextureDt){for(let i=0;i<ji.poolLen;i++){var e=ji.pool[i];t-e._discardTm>=es.destroyUnusedTextureDt&&(e.destroy(),ji.pool[i]=ji.pool[ji.poolLen-1],ji.poolLen--,i--)}ji.cleanTm=t}}touchTexture(){let t=ki.loopCount;this.lastTouchTm!=t&&(this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=t)}touchRect(t,e){this.lastTouchTm!=e&&(this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=e);var i=es.atlasWidth*es.atlasWidth,s=qi.atlasGridW*qi.atlasGridW;this.curUsedCovRate+=t.bmpWidth*t.bmpHeight/i,this.curUsedCovRateAtlas+=Math.ceil(t.bmpWidth/qi.atlasGridW)*Math.ceil(t.bmpHeight/qi.atlasGridW)/(i/s)}}ji.pool=new Array(10),ji.poolLen=0,ji.cleanTm=0,ji.EVENT_REUSE="texture_recycling";class qi{constructor(){this.texWidth=1024,this.texHeight=1024,this.texture=null,this.charMaps={},this.texHeight=this.texWidth=es.atlasWidth,this.texture=ji.getTextTexture(this.texWidth,this.texHeight),this.texWidth/qi.atlasGridW>256&&(qi.atlasGridW=Math.ceil(this.texWidth/256)),this.atlasgrid=new Yi(this.texWidth/qi.atlasGridW,this.texHeight/qi.atlasGridW,this.texture.id)}setProtecteDist(t){}getAEmpty(t,e,i){var s=this.atlasgrid.addRect(1,Math.ceil(t/qi.atlasGridW),Math.ceil(e/qi.atlasGridW),i);return s&&(i.x*=qi.atlasGridW,i.y*=qi.atlasGridW),s}get usedRate(){return this.atlasgrid._used}destroy(){for(var t in this.charMaps){this.charMaps[t].deleted=!0}this.texture.discard()}printDebugInfo(){}}qi.atlasGridW=16;class $i{static parse(t){if(t===Qi)return Ki;let e=$i._cache[t];return e||(e=$i._cache[t]=new $i(t)),Qi=t,Ki=e,e}constructor(t){this._family="Arial",this._size=14,this._italic=!1,this._bold=!1,this.setFont(t||"14px Arial")}setFont(t){this._font=t;var e=t.split(" "),i=e.length;if(i<2)1==i&&e[0].indexOf("px")>0&&(this._size=parseInt(e[0]));else{var s=-1;for(let r=0;r<i;r++)if(e[r].indexOf("px")>0||e[r].indexOf("pt")>0){s=r,this._size=parseInt(e[r]),this._size<=0&&(console.debug("font parse error:"+t),this._size=14);break}var r=s+1,a=e[r];for(r++;r<i;r++)a+=" "+e[r];this._family=a.split(",")[0],this._italic=e.indexOf("italic")>=0,this._bold=e.indexOf("bold")>=0}}}$i._cache={};var Ki,Qi="";class Zi{constructor(){this.pagecharsCtx=null,this.width=-1,this.pageChars=[],this.scalex=1,this.scaley=1}setText(t){this.text=t,this._nativeObj?this._nativeObj._text=t:this.width=-1,this.cleanCache()}toString(){return this.text}get length(){return this.text?this.text.length:0}cleanCache(){if(this._nativeObj)return void this._nativeObj.cleanCache();let t=this.pageChars;if(t.length>0){for(var e in t){let i=t[e];if(!i)continue;let s=i.tex;1==i.words.length&&s&&s.ri&&s.destroy()}this.pageChars=[]}this.scalex=1,this.scaley=1}get splitRender(){return this._splitRender}set splitRender(t){this._splitRender=t,this._nativeObj&&(this._nativeObj.splitRender=t)}}class Ji{constructor(){this.fontsz=16}getWidth(t,e){return 0}scale(t,e){}get canvasWidth(){return 0}set canvasWidth(t){}getCharBmp(t,e,i,s,r,a,n,l,o,h,u=null){return null}}class ts extends Ji{constructor(t,e,i=!0,s=!0,r=!1){super(),this.ctx=null,this.lastScaleX=1,this.lastScaleY=1,this.maxTexW=0,this.maxTexH=0,this.scaleFontSize=!0,this.showDbgInfo=!1,this.supportImageData=!0,this.maxTexW=t,this.maxTexH=e,this.scaleFontSize=i,this.supportImageData=s,this.showDbgInfo=r,ts.canvas||(ts.canvas=A.createElement("canvas"),ts.canvas.width=1024,ts.canvas.height=512,ts.canvas.style.left="-10000px",ts.canvas.style.position="absolute",window.document.body.appendChild(ts.canvas),this.ctx=ts.canvas.getContext("2d",{willReadFrequently:!0}))}get canvasWidth(){return ts.canvas.width}set canvasWidth(t){ts.canvas.width!=t&&(ts.canvas.width=t,t>2048&&console.warn("画文字设置的宽度太大，超过2048了"),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.lastScaleX,this.lastScaleY))}getWidth(t,e){return this.ctx?(this.ctx._lastFont!=t&&(this.ctx.font=t,this.ctx._lastFont=t),this.ctx.measureText(e).width):0}scale(t,e){if(!this.supportImageData)return this.lastScaleX=t,void(this.lastScaleY=e);this.lastScaleX==t&&this.lastScaleY==e||(this.ctx.setTransform(t,0,0,e,0,0),this.lastScaleX=t,this.lastScaleY=e)}getCharBmp(t,e,i,s,r,a,n,l,o,h,u=null){if(!this.supportImageData)return this.getCharCanvas(t,e,i,s,r,a,n,l,o,h);var d=this.ctx,c=this.fontsz;d.font!=e&&(d.font=e,d._lastFont=e),a.width=d.measureText(t).width;var _=a.width*this.lastScaleX,p=a.height*this.lastScaleY;_+=(n+o)*this.lastScaleX,p+=(l+h)*this.lastScaleY,_=Math.ceil(_),p=Math.ceil(p);var f=(_=Math.min(_,ts.canvas.width))+2*i+1,g=(p=Math.min(p,ts.canvas.height))+2*i+1;u&&(f=Math.max(f,u[0]+u[2]+1),g=Math.max(g,u[1]+u[3]+1)),d.clearRect(0,0,f/this.lastScaleX+1,g/this.lastScaleY+1),d.save(),d.textBaseline="middle",i>0&&(d.lineJoin="round",d.strokeStyle=r,d.lineWidth=i,d.strokeText(t,n,l+c/2)),s&&(d.fillStyle=s,d.fillText(t,n,l+c/2)),this.showDbgInfo&&(d.strokeStyle="#ff0000",d.strokeRect(1,1,_-2,p-2),d.strokeStyle="#00ff00",d.strokeRect(n,l,a.width,a.height)),u&&(u[2]<=0&&(u[2]=Math.ceil(-u[2]+(a.width+2*i)*this.lastScaleX)),u[2]<=0&&(u[2]=1));var m=u?d.getImageData(u[0],u[1],u[2],u[3]+1):d.getImageData(0,0,_,p+1);return d.restore(),a.bmpWidth=m.width,a.bmpHeight=m.height,m}getCharCanvas(t,e,i,s,r,a,n,l,o,h){var u=this.ctx;u.font!=e&&(u.font=e,u._lastFont=e),A.window.isIOSHighPerformanceModePlus&&(u.font=e),a.width=u.measureText(t).width;var d=a.width*this.lastScaleX,c=a.height*this.lastScaleY;d+=(n+o)*this.lastScaleX,c+=(l+h)*this.lastScaleY+1,d=Math.min(d,this.maxTexW),c=Math.min(c,this.maxTexH),ts.canvas.width=Math.min(d+1,this.maxTexW),ts.canvas.height=Math.min(c+1,this.maxTexH),u.font=e,u.clearRect(0,0,d+1+i,c+1+i),u.setTransform(1,0,0,1,0,0),u.save(),this.scaleFontSize&&u.scale(this.lastScaleX,this.lastScaleY),u.translate(n,l),u.textAlign="left";var _=this.fontsz;return u.textBaseline="middle",i>0?(u.lineJoin="round",u.strokeStyle=r,u.fillStyle=s,u.lineWidth=i,u.fillAndStrokeText?u.fillAndStrokeText(t,0,_/2):(u.strokeText(t,0,_/2),u.fillText(t,0,_/2))):s&&(u.fillStyle=s,u.fillText(t,0,_/2)),this.showDbgInfo&&(u.strokeStyle="#ff0000",u.strokeRect(0,0,d,c),u.strokeStyle="#00ff00",u.strokeRect(0,0,a.width,a.height)),u.restore(),a.bmpWidth=ts.canvas.width,a.bmpHeight=ts.canvas.height,ts.canvas}}ts.canvas=null;class es extends v{constructor(){super(),this.fontSizeInfo={},this.mapFont={},this.fontID=0,this.fontScaleX=1,this.fontScaleY=1,this._curStrPos=0,this.textAtlases=[],this.isoTextures=[],this.lastFont=null,this.fontSizeW=0,this.fontSizeH=0,this.fontSizeOffX=0,this.fontSizeOffY=0,this.renderPerChar=!0,this._fontMeasure=null;var t=!1,i=e.Laya.MiniAdpter;i&&i.systemInfo&&i.systemInfo.system&&(t="ios 10.1.1"===i.systemInfo.system.toLowerCase()),(e.Browser.onMiniGame||e.Browser.onTTMiniGame||e.Browser.onBLMiniGame||e.Browser.onAlipayMiniGame||e.Browser.onTBMiniGame)&&!t&&(es.isWan1Wan=!0),this.charRender=new ts(2048,2048,es.scaleFontWithCtx,!es.isWan1Wan,!1),es.textRenderInst=this,e.Laya.textRender=this}set fontMeasure(t){this._fontMeasure=t}get fontMeasure(){return this._fontMeasure}_wan1wansz(t,e){let i="bold "+e+"px "+t;var s=1.5*this.charRender.getWidth(i,"有")<<8|1.5*e;return this.fontSizeInfo[t]=s,s}getFontSizeInfo(t){var e=this.fontSizeInfo[t];return e||(e=es.isWan1Wan?this._wan1wansz(t,es.standardFontSize):this._fontMeasure.getFontSizeInfo(t,es.standardFontSize),this.fontSizeInfo[t]=e),e}setFont(t){if(this.lastFont!=t){this.lastFont=t;var e=this.getFontSizeInfo(t._family),i=e>>24,s=e>>16&255,r=e>>8&255,a=255&e,n=t._size/es.standardFontSize;this.fontSizeOffX=Math.ceil(i*n),this.fontSizeOffY=Math.ceil(s*n),this.fontSizeW=Math.ceil(r*n),this.fontSizeH=Math.ceil(a*n),t._font.indexOf("italic")>=0?this.fontStr=t._font.replace("italic",""):this.fontStr=t._font}}getNextChar(t){var e=t.length,i=this._curStrPos;if(!t.substring)return null;if(i>=e)return null;for(var s=i,r=0;s<e;s++){var a=t.charCodeAt(s);if(a>>>11==27){if(1==r)break;r=1,s++}else if(65038===a||65039===a);else if(8205==a)r=2;else if(0==r)r=1;else if(1==r)break}return this._curStrPos=s,t.substring(i,s)}filltext(t,e,i,s,r,a,n,l,o){if(!(e.length<=0)){var h=$i.parse(r),u=0;switch(o){case"center":u=Ut.ENUM_TEXTALIGN_CENTER;break;case"right":u=Ut.ENUM_TEXTALIGN_RIGHT}this._fast_filltext(t,e,i,s,h,a,n,l,u)}}_fast_filltext(t,e,i,s,r,a,n,l,o){if(e&&!(e.length>=1))return;if(l<0&&(l=0),this.setFont(r),this.fontScaleX=this.fontScaleY=1,es.scaleFontWithCtx){let e=t.getMatScaleX(),i=t.getMatScaleY();if(e<1e-4||i<.1)return;e>1&&(this.fontScaleX=Math.min(es.maxFontScale,e)),i>1&&(this.fontScaleY=Math.min(es.maxFontScale,i))}r._italic&&(t._italicDeg=13);let h=e,u=e instanceof Zi,d=e&&e.toString(),c=u?h.pageChars:[],_=0;switch(u?(d=h.text,_=h.width,_<0&&(_=h.width=this.charRender.getWidth(this.fontStr,d))):_=d?this.charRender.getWidth(this.fontStr,d):0,o){case Ut.ENUM_TEXTALIGN_CENTER:i-=_/2;break;case Ut.ENUM_TEXTALIGN_RIGHT:i-=_}u&&(this.hasFreedText(c)||h.pagecharsCtx!=t)&&(c=h.pageChars=[]);let p=this.renderPerChar=!u||es.forceSplitRender||u&&h.splitRender;if(!c||c.length<1){if(u&&(h.scalex=this.fontScaleX,h.scaley=this.fontScaleY),p){let t,e=0,i=0;for(this._curStrPos=0;t=this.getNextChar(d),t;){let s=this.getCharRenderInfo(t,r,a,n,l,!1);if(!s)break;if(s.isSpace);else{var f=c[s.texture.id];if(f)f=f.words;else{var g={texgen:s.texture.genID,tex:s.texture,words:new Array};c[s.texture.id]=g,f=g.words}f.push({ri:s,x:e,y:i,w:s.bmpWidth/this.fontScaleX,h:s.bmpHeight/this.fontScaleY}),e+=s.width}}}else{let t=r._size/3|0,e=es.noAtlas||(_+t+t)*this.fontScaleX>es.atlasWidth,i=this.getCharRenderInfo(d,r,a,n,l,e);c[0]={texgen:i.texture.genID,tex:i.texture,words:[{ri:i,x:0,y:0,w:i.bmpWidth/this.fontScaleX,h:i.bmpHeight/this.fontScaleY}]}}u&&(h.pagecharsCtx=t)}this._drawResortedWords(t,i,s,c),t._italicDeg=0}_drawResortedWords(t,e,i,s){var r=!!t._charSubmitCache&&t._charSubmitCache._enable,a=t._curMat;for(var n in s){var l=s[n];if(l){var o=l.words,h=o.length;if(!(h<=0))for(var u=s[n].tex,d=0;d<h;d++){var c=o[d],_=c.ri;_.isSpace||(t.touchRes(_),t.drawTexAlign=!0,t._inner_drawTexture(u,u.id,e+c.x-_.orix,i+c.y-_.oriy,c.w,c.h,a,_.uv,1,r,4294967295))}}}}hasFreedText(t){for(let s in t){var e=t[s];if(e){var i=e.tex;if(i.destroyed||i.genID!=e.texgen)return!0}}return!1}getCharRenderInfo(t,e,i,s,r,a=!1){var n=this.mapFont[e._family];null==n&&(this.mapFont[e._family]=n=this.fontID++);var l=t+"_"+n+"_"+e._size+"_"+i;r>0&&(l+="_"+s+r),e._bold&&(l+="P"),1==this.fontScaleX&&1==this.fontScaleY||(l+=(20*this.fontScaleX|0)+"_"+(20*this.fontScaleY|0));var o,h,u=0,d=this.textAtlases.length;if(!a)for(u=0;u<d;u++)if(o=(h=this.textAtlases[u]).charMaps[l])return o.touch(),o;o=new Vi,this.charRender.scale(this.fontScaleX,this.fontScaleY),o.char=t,o.height=e._size;var c=e._size/3|0,_=null;r||(r=0);var p=Math.ceil((this.charRender.getWidth(this.fontStr,t)+2*r)*this.fontScaleX);let f=Math.min(2048,p+2*c*this.fontScaleX);if(f>this.charRender.canvasWidth&&(this.charRender.canvasWidth=f),a){if(this.charRender.fontsz=e._size,_=this.charRender.getCharBmp(t,this.fontStr,r,i,s,o,c,c,c,c,null)){var g=ji.getTextTexture(_.width,_.height);g.addChar(_,0,0,o.uv),o.texture=g,o.orix=c,o.oriy=c,g.ri=o,this.isoTextures.push(g)}}else{var m=t.length,y=1*r,T=Math.ceil((this.fontSizeW+2*y)*this.fontScaleX),x=Math.ceil((this.fontSizeH+2*y)*this.fontScaleY);es.imgdtRect[0]=(c-this.fontSizeOffX-y)*this.fontScaleX|0,es.imgdtRect[1]=(c-this.fontSizeOffY-y)*this.fontScaleY|0,this.renderPerChar||1==m?(es.imgdtRect[2]=Math.max(p,T),es.imgdtRect[3]=Math.max(p,x)):(es.imgdtRect[2]=-this.fontSizeOffX*this.fontScaleX,es.imgdtRect[3]=x),this.charRender.fontsz=e._size,(_=this.charRender.getCharBmp(t,this.fontStr,r,i,s,o,c,c,c,c,es.imgdtRect))&&(h=this.addBmpData(_,o),es.isWan1Wan?(o.orix=c,o.oriy=c):(o.orix=this.fontSizeOffX+y,o.oriy=this.fontSizeOffY+y),h.charMaps[l]=o)}return o}addBmpData(t,e){for(var i,s=t.width,r=t.height,a=this.textAtlases.length,n=!1,l=0;l<a&&!(n=(i=this.textAtlases[l]).getAEmpty(s,r,is));l++);if(!n){if(i=new qi,this.textAtlases.push(i),!(n=i.getAEmpty(s,r,is)))throw"err1";this.cleanAtlases()}return n&&(i.texture.addChar(t,is.x,is.y,e.uv),e.texture=i.texture),i}GC(){for(var t=0,e=this.textAtlases.length,i=es.destroyAtlasDt,s=0,r=ki.loopCount,a=-1,n=0,l=null,o=null;t<e;t++){if(l=(o=this.textAtlases[t]).texture){s+=l.curUsedCovRateAtlas;var h=o.usedRate-l.curUsedCovRateAtlas;n<h&&(n=h,a=t)}r-o.texture.lastTouchTm>i&&(es.showLog&&console.log(o.texture.id),o.destroy(),this.textAtlases[t]=this.textAtlases[e-1],e--,t--,a=-1)}for(this.textAtlases.length=e,e=this.isoTextures.length,t=0;t<e;t++)r-(l=this.isoTextures[t]).lastTouchTm>es.destroyUnusedTextureDt&&(l.ri.deleted=!0,l.ri.texture=null,l.destroy(),this.isoTextures[t]=this.isoTextures[e-1],e--,t--);this.isoTextures.length=e;var u=this.textAtlases.length>1&&this.textAtlases.length-s>=2;(es.atlasWidth*es.atlasWidth*4*this.textAtlases.length>es.cleanMem||u||es.simClean)&&(es.simClean=!1,es.showLog&&console.log("清理使用率低的贴图。总使用率:",s,":",this.textAtlases.length,"最差贴图:"+a),a>=0&&((o=this.textAtlases[a]).destroy(),this.textAtlases[a]=this.textAtlases[this.textAtlases.length-1],this.textAtlases.length=this.textAtlases.length-1,this.event("GC")))}cleanAtlases(){}printDbgInfo(){for(var t in console.log("图集个数:"+this.textAtlases.length+",每个图集大小:"+es.atlasWidth+"x"+es.atlasWidth," 用canvas:",es.isWan1Wan),console.log("图集占用空间:"+es.atlasWidth*es.atlasWidth*4/1024/1024*this.textAtlases.length+"M"),console.log("缓存用到的字体:"),this.mapFont){var e=this.getFontSizeInfo(t),i=e>>24,s=e>>16&255,r=e>>8&255,a=255&e;console.log("    "+t," off:",i,s," size:",r,a)}var n=0;console.log("缓存数据:");var l=0,o=0;this.textAtlases.forEach((function(t){var e=t.texture.id,i=ki.loopCount-t.texture.lastTouchTm,s=i>0?i+"帧以前":"当前帧";for(var r in l+=t.texture.curUsedCovRate,o+=t.texture.curUsedCovRateAtlas,console.log("--图集(id:"+e+",当前使用率:"+(1e3*t.texture.curUsedCovRate|0)+"‰","当前图集使用率:",(100*t.texture.curUsedCovRateAtlas|0)+"%","图集使用率:",100*t.usedRate|0,"%, 使用于:"+s+")--:"),t.charMaps){var a=t.charMaps[r];console.log("     off:",a.orix,a.oriy," bmp宽高:",a.bmpWidth,a.bmpHeight,"无效:",a.deleted,"touchdt:",ki.loopCount-a.touchTick,"位置:",a.uv[0]*es.atlasWidth|0,a.uv[1]*es.atlasWidth|0,"字符:",a.char,"key:",r),n++}})),console.log("独立贴图文字("+this.isoTextures.length+"个):"),this.isoTextures.forEach((function(t){console.log("    size:",t.width,t.height,"touch间隔:",ki.loopCount-t.lastTouchTm,"char:",t.ri.char)})),console.log("总缓存:",n,"总使用率:",l,"总当前图集使用率:",o)}showAtlas(t,i,s,r,a,n){if(!this.textAtlases[t])return console.log("没有这个图集"),null;var l=new br,o=this.textAtlases[t].texture,h={width:es.atlasWidth,height:es.atlasWidth,sourceWidth:es.atlasWidth,sourceHeight:es.atlasWidth,offsetX:0,offsetY:0,getIsReady:function(){return!0},_addReference:function(){},_removeReference:function(){},_getSource:function(){return o._getSource()},bitmap:{id:o.id},_uv:mt.DEF_UV};return l.size=function(t,e){return this.width=t,this.height=e,l.graphics.clear(),l.graphics.drawRect(0,0,l.width,l.height,i),l.graphics.drawTexture(h,0,0,l.width,l.height),this},l.graphics.drawRect(0,0,a,n,i),l.graphics.drawTexture(h,0,0,a,n),l.pos(s,r),e.stage.addChild(l),l}}es.useOldCharBook=!1,es.atlasWidth=1024,es.noAtlas=!1,es.forceSplitRender=!1,es.forceWholeRender=!1,es.scaleFontWithCtx=!0,es.maxFontScale=4,es.standardFontSize=32,es.destroyAtlasDt=10,es.checkCleanTextureDt=2e3,es.destroyUnusedTextureDt=3e3,es.cleanMem=104857600,es.isWan1Wan=!1,es.showLog=!1,es.debugUV=!1,es.imgdtRect=[0,0,0,0],es.simClean=!1;const is=new s;class ss extends te{static __init__(){ss.VertexDeclarition=new Zt(48,[new Jt(0,Kt.Vector4,0),new Jt(16,Kt.Vector4,1),new Jt(32,Kt.Vector4,2)])}constructor(){super(ss.const_stride,4,4)}onVBRealloc(t){this._vbFloat32Array=new Float32Array(t)}onIBRealloc(t){this._ibU16Array=new Uint16Array(t)}addData(t,e,i,s,r,a=null){let n=t.length/2;this.expVBSize(n*ss.const_stride);var l=t.length>>1,o=this._vertNum*ss.const_stride>>2,h=this._vbFloat32Array,u=0,d=s.a,c=s.b,_=s.c,p=s.d,f=s.tx,g=s.ty,m=0;let y=0,T=0,x=1,v=1;a&&(y=a[0],T=a[1],x=a[2],v=a[3]);let S=(r>>>16&255)/255,E=(r>>>8&255)/255,w=(255&r)/255,D=(r>>>24)/255;for(m=0;m<l;m++){var b=t[u],C=t[u+1];h[o]=b*d+C*_+f,h[o+1]=b*c+C*p+g,h[o+2]=y+e[u]*x,h[o+3]=T+e[u+1]*v,h[o+4]=w,h[o+5]=E,h[o+6]=S,h[o+7]=D,h[o+8]=255,o+=12,u+=2}var R=this._vertNum,A=this._indexNum;this.expIBSize(i.byteLength);var I=this._ibU16Array;if(R>0)for(let t=A,e=0,s=A+i.length;t<s;t++,e++)I[t]=i[e]+R;else I.set(i);this._vertNum+=l,this._indexNum+=i.length}get vertexDeclarition(){return ss.VertexDeclarition}}ss.const_stride=48,ss.VertexDeclarition=null;class rs extends te{static __init__(){rs.vertexDeclaration=new Zt(24,[new Jt(0,Kt.Vector2,0),new Jt(8,Kt.Vector4,1)])}constructor(){super(rs.const_stride,4,4),this._vbFloat32Array=null}onVBRealloc(t){this._vbFloat32Array=new Float32Array(t)}onIBRealloc(t){}addVertAndIBToMesh(t,e,i){var s=this._vertNum*rs.const_stride;this.expVBSize(t.length/2*rs.const_stride);var r=s>>2,a=this._vbFloat32Array,n=0;let l=(e>>>16&255)/255,o=(e>>>8&255)/255,h=(255&e)/255,u=(e>>>24)/255;for(var d=t.length/2,c=0;c<d;c++)a[r++]=t[n],a[r++]=t[n+1],n+=2,a[r++]=h,a[r++]=o,a[r++]=l,a[r++]=u;this.expIBSize(2*i.length),new Uint16Array(this._IBBuff,2*this._indexNum,i.length).set(new Uint16Array(i)),this._vertNum+=d,this._indexNum+=i.length}get vertexDeclarition(){return rs.vertexDeclaration}}rs.const_stride=24,rs.vertexDeclaration=null;const as=new G(Ut.MAX_CLIP_SIZE,0,0,Ut.MAX_CLIP_SIZE,0,0),ns=[0,0,0,0,0,0,0,0],ls=new G;class os{static __init__(){if(os.MAXCLIPRECT=new F(0,0,Ut.MAX_CLIP_SIZE,Ut.MAX_CLIP_SIZE),hs.DEFAULT=new hs,!os._textRender){let t=os._textRender=new es;t.fontMeasure=new Wi(t.charRender)}}constructor(){if(this._alpha=1,this._material=null,this._fillStyle=yi.DEFAULT,this._strokeStyle=yi.DEFAULT,this._drawTexToDrawTri_Vert=new Float32Array(8),this._drawTexToDrawTri_Index=new Uint16Array([0,1,2,0,2,3]),this._tempUV=new Float32Array(8),this._drawTriUseAbsMatrix=!1,this._other=null,this._path=null,this._drawCount=1,this._width=Ut.MAX_CLIP_SIZE,this._height=Ut.MAX_CLIP_SIZE,this._renderCount=0,this.stopMerge=!0,this._curSubmit=Ui.RENDERBASE,this._submitKey=new Fi,this._meshQuatTex=new ee,this._meshVG=new rs,this._meshTex=new ss,this._transedPoints=new Array(8),this._temp4Points=new Array(8),this._clipRect=os.MAXCLIPRECT,this._globalClipMatrix=as.clone(),this._clipInfoID=0,this._clipID_Gen=0,this._matBuffer=new Float32Array(6),this._lastMatScaleX=1,this._lastMatScaleY=1,this._lastMat_a=1,this._lastMat_b=0,this._lastMat_c=0,this._lastMat_d=1,this._nBlendType=0,this._save=null,this._charSubmitCache=null,this._saveMark=null,this._shader2D=new Ci,this.sprite=null,this._italicDeg=0,this._lastTex=null,this._fillColor=0,this._flushCnt=0,this.defTexture=null,this._colorFiler=null,this.drawTexAlign=!1,this._incache=!1,this._isMain=!1,this._render2D=null,this._clearColor=new _t(0,0,0,0),this._clear=!1,this._shaderValueNeedRelease=[],this.render2D=new he,os._contextcount++,!this.defTexture){var e=new ct(2,2,t.TextureFormat.R8G8B8A8,!0,!1,!1);e.setPixelsData(new Uint8Array(16),!1,!1),e.lock=!0,this.defTexture=new mt(e)}this._lastTex=this.defTexture,this._other=hs.DEFAULT,this._curMat=G.create(),this._charSubmitCache=new Gi(this),this._mesh=this._meshQuatTex,this._mesh.clearMesh(),this._save=[Ei.Create(this)],this._save.length=10,this.clear(),this._render2DManager=new _e}copyState(t){}set isMain(t){this._isMain=t}get isMain(){return this._isMain}set render2D(t){this._render2D=t}get render2D(){return this._render2D}get lineJoin(){return""}set lineJoin(t){}get lineCap(){return""}set lineCap(t){}get miterLimit(){return""}set miterLimit(t){}touchRes(t){t.touch()}transformByMatrix(t,e,i){this.transform(t.a,t.b,t.c,t.d,t.tx+e,t.ty+i)}drawRect(t,e,i,s,r,a,n){var l=this;null!=r&&(l.fillStyle=r,l.fillRect(t,e,i,s)),null!=a&&(l.strokeStyle=a,l.lineWidth=n,l.strokeRect(t,e,i,s))}alpha(t){this.globalAlpha*=t}_transform(t,e,i){this.translate(e,i),this.transform(t.a,t.b,t.c,t.d,t.tx,t.ty),this.translate(-e,-i)}_rotate(t,e,i){this.translate(e,i),this.rotate(t),this.translate(-e,-i)}_scale(t,e,i,s){this.translate(i,s),this.scale(t,e),this.translate(-i,-s)}_drawLine(t,e,i,s,r,a,n,l,o){this.beginPath(),this.strokeStyle=n,this.lineWidth=l,this.moveTo(t+i,e+s),this.lineTo(t+r,e+a),this.stroke()}_drawLines(t,e,i,s,r,a){this.beginPath(),this.strokeStyle=s,this.lineWidth=r,this.addPath(i.slice(),!1,!1,t,e),this.stroke()}drawCurves(t,e,i,s,r){this.beginPath(),this.strokeStyle=s,this.lineWidth=r,this.moveTo(t+i[0],e+i[1]);for(var a=2,n=i.length;a<n;)this.quadraticCurveTo(t+i[a++],e+i[a++],t+i[a++],e+i[a++]);this.stroke()}_fillAndStroke(t,e,i,s=!1){null!=t&&(this.fillStyle=t,this.fill()),null!=e&&i>0&&(this.strokeStyle=e,this.lineWidth=i,this.stroke())}_drawCircle(t,e,i,s,r,a,n){this.beginPath(!0),this.arc(t,e,i,i,0,2*Math.PI,!1,!0,40),this.closePath(),this._fillAndStroke(s,r,a)}_drawEllipse(t,e,i,s,r,a,n){this.beginPath(!0),this.arc(t,e,i,s,0,2*Math.PI,!1,!0,40),this.closePath(),this._fillAndStroke(r,a,n)}_drawRoundRect(t,e,i,s,r,a,n,l,o,h,u){this.beginPath(!0);var d=this._getPath();0>=r?d.addPoint(t,e):this.arc(t+r,e+r,r,r,Math.PI,Math.PI+.5*Math.PI);let c=t+i-a;0>=a?d.addPoint(c,e):this.arc(c,e+a,a,a,Math.PI+.5*Math.PI,2*Math.PI),c=t+i-l;let _=e+s-l;0>=l?d.addPoint(c,_):this.arc(c,_,l,l,0,.5*Math.PI),c=t+n,_=e+s-n,0>=n?d.addPoint(c,_):this.arc(c,_,n,n,Math.PI-.5*Math.PI,Math.PI),d.addPoint(t,e+r),this.closePath(),this._fillAndStroke(o,h,u)}_drawPie(t,e,i,s,r,a,n,l,o){this.beginPath(),this.moveTo(t,e),this.arc(t,e,i,i,s,r),this.closePath(),this._fillAndStroke(a,n,l)}_drawPoly(t,e,i,s,r,a,n,l){this.beginPath(),this.addPath(i.slice(),!0,n,t,e),this.closePath(),this._fillAndStroke(s,r,a,n)}_drawPath(t,e,i,s,r){this.beginPath();for(var a=0,n=i.length;a<n;a++){var l=i[a];switch(l[0]){case"moveTo":this.moveTo(t+l[1],e+l[2]);break;case"lineTo":this.lineTo(t+l[1],e+l[2]);break;case"arcTo":this.arcTo(t+l[1],e+l[2],t+l[3],e+l[4],l[5]);break;case"closePath":this.closePath()}}null!=s&&(this.fillStyle=s.fillStyle,this.fill()),null!=r&&(this.strokeStyle=r.strokeStyle,this.lineWidth=r.lineWidth||1,this.lineJoin=r.lineJoin,this.lineCap=r.lineCap,this.miterLimit=r.miterLimit,this.stroke())}static set2DRenderConfig(){}clearBG(t,e,i,s){null==t||null==t?this._clear=!1:(this._clearColor.setValue(t,e,i,s),this._clear=!0)}_releaseMem(){this._curMat&&this._curMat.destroy(),this._curMat=null,this._shader2D.destroy(),this._shader2D=null,this._charSubmitCache.clear(),this._path=null,this._save=null,this.sprite=null}destroy(){--os._contextcount,this.sprite=null,this._charSubmitCache&&this._charSubmitCache.destroy(),this.defTexture&&(this.defTexture.bitmap&&this.defTexture.bitmap.destroy(),this.defTexture.destroy())}clear(){this._submitKey.clear(),this._drawCount=1,this._other=hs.DEFAULT,this._alpha=1,this._nBlendType=0,this._clipRect=os.MAXCLIPRECT,this._fillStyle=this._strokeStyle=yi.DEFAULT,this._curMat.identity(),this._other.clear(),this._saveMark=this._save[0],this._save._length=1}size(t,e){this._width==t&&this._height==e||(this._width=t,this._height=e,this.isMain&&(le.width=t,le.height=e)),0===t&&0===e&&this._releaseMem()}get width(){return this._width}set width(t){this.size(t,this._height)}get height(){return this._height}set height(t){this.size(this._width,t)}getMatScaleX(){return this._lastMat_a==this._curMat.a&&this._lastMat_b==this._curMat.b||(this._lastMatScaleX=this._curMat.getScaleX(),this._lastMat_a=this._curMat.a,this._lastMat_b=this._curMat.b),this._lastMatScaleX}getMatScaleY(){return this._lastMat_c==this._curMat.c&&this._lastMat_d==this._curMat.d||(this._lastMatScaleY=this._curMat.getScaleY(),this._lastMat_c=this._curMat.c,this._lastMat_d=this._curMat.d),this._lastMatScaleY}getFillColor(){return this._fillColor}set fillStyle(t){this._fillStyle.equal(t)||(vi.save(this,vi.TYPE_FILESTYLE,this._shader2D,!1),this._fillStyle=yi.create(t),this._submitKey.other=-this._fillStyle.toInt())}get fillStyle(){return this._fillStyle}set globalAlpha(t){(t=Math.floor(1e3*t)/1e3)!=this._alpha&&(vi.save(this,vi.TYPE_ALPHA,this._shader2D,!1),this._alpha=t)}get globalAlpha(){return this._alpha}set textAlign(t){this._other.textAlign===t||(this._other=this._other.make(),vi.save(this,vi.TYPE_TEXTALIGN,this._other,!1),this._other.textAlign=t)}get textAlign(){return this._other.textAlign}set textBaseline(t){this._other.textBaseline===t||(this._other=this._other.make(),vi.save(this,vi.TYPE_TEXTBASELINE,this._other,!1),this._other.textBaseline=t)}get textBaseline(){return this._other.textBaseline}set globalCompositeOperation(t){this._drawToRender2D(this._curSubmit);var e=fi.TOINT[t];null==e||this._nBlendType===e||(vi.save(this,vi.TYPE_GLOBALCOMPOSITEOPERATION,this,!0),this._curSubmit=Ui.RENDERBASE,this._nBlendType=e)}get globalCompositeOperation(){return fi.NAMES[this._nBlendType]}set strokeStyle(t){this._strokeStyle.equal(t)||(vi.save(this,vi.TYPE_STROKESTYLE,this._shader2D,!1),this._strokeStyle=yi.create(t),this._submitKey.other=-this._strokeStyle.toInt())}get strokeStyle(){return this._strokeStyle}translate(t,e){0===t&&0===e||(Di.save(this),this._curMat._bTransform?(wi.save(this),this._curMat.tx+=t*this._curMat.a+e*this._curMat.c,this._curMat.ty+=t*this._curMat.b+e*this._curMat.d):(this._curMat.tx=t,this._curMat.ty=e))}set lineWidth(t){this._other.lineWidth===t||(this._other=this._other.make(),vi.save(this,vi.TYPE_LINEWIDTH,this._other,!1),this._other.lineWidth=t)}get lineWidth(){return this._other.lineWidth}save(){this._save[this._save._length++]=Ei.Create(this)}restore(){var t=this._save._length,e=this._nBlendType;if(!(t<1)){for(var i=t-1;i>=0;i--){var s=this._save[i];if(s.restore(this),s.isSaveMark())return void(this._save._length=i)}e!=this._nBlendType&&(this.stopMerge=!0)}}fillText(t,e,i,s,r,a,n=0,l=""){os._textRender.filltext(this,t,e,i,s,r,l,n,a)}drawText(t,e,i,s,r,a){os._textRender.filltext(this,t,e,i,s,r,null,0,a)}strokeWord(t,e,i,s,r,a,n){os._textRender.filltext(this,t,e,i,s,null,r,a,n)}fillBorderText(t,e,i,s,r,a,n,l){os._textRender.filltext(this,t,e,i,s,r,a,n,l)}_fast_filltext(t,e,i,s,r,a,n,l){os._textRender._fast_filltext(this,t,e,i,s,r,a,n,l)}_fillRect(e,i,s,r,a){var n=this._curSubmit,l=this._mesh.vertexNum+4<os._MAXVERTNUM&&n&&n._key.submitType===Ui.KEY_DRAWTEXTURE&&n._key.blendShader===this._nBlendType&&!this.isStopMerge(n)&&this._curSubmit.material==this._material;l||(this._drawToRender2D(this._curSubmit),this._mesh=this._meshQuatTex);let o=this._mesh;this.transformQuad(e,i,s,r,0,this._curMat,this._transedPoints),this.clipedOff(this._transedPoints)||(l||(n=this._curSubmit=Ui.create(this,o,Ai.create(t.RenderSpriteData.Texture2D)),this.fillShaderValue(n.shaderValue),this._copyClipInfo(n.shaderValue),n.clipInfoID=this._clipInfoID,!this._lastTex||this._lastTex.destroyed?n.shaderValue.textureHost=this.defTexture:n.shaderValue.textureHost=this._lastTex,n._key.other=this._lastTex&&this._lastTex.bitmap?this._lastTex.bitmap.id:-1),o.addQuad(this._transedPoints,mt.NO_UV,a,!1),this._curSubmit._numEle+=6)}fillRect(t,e,i,s,r){var a=r?yi.create(r):this._fillStyle,n=this.mixRGBandAlpha(a.toInt());this._fillRect(t,e,i,s,n)}fillTexture(t,i,s,r,a,n,l,o){t._getSource()?this._fillTexture(t,t.width,t.height,t.uvrect,i,s,r,a,n,l.x,l.y,o):this.sprite&&e.systemTimer.callLater(this,this._repaintSprite)}_fillTexture(e,i,s,r,a,n,l,o,h,d,c,_){var p=this._curSubmit;this._drawToRender2D(this._curSubmit),this._mesh=this._meshQuatTex;var f=!0,g=!0;switch(h){case"repeat":break;case"repeat-x":g=!1;break;case"repeat-y":f=!1;break;case"no-repeat":f=g=!1}var m=this._temp4Points,y=0,T=0,x=0,v=0,S=0,E=0;if(d<0?(x=a,y=-d%i/i):x=a+d,c<0?(v=n,T=-c%s/s):v=n+c,S=a+l,E=n+o,!f&&(S=Math.min(S,a+d+i)),!g&&(E=Math.min(E,n+c+s)),!(S<a||E<n||x>S||v>E)){var w=(S-a-d)/i,D=(E-n-c)/s;if(this.transformQuad(x,v,S-x,E-v,0,this._curMat,this._transedPoints),m[0]=y,m[1]=T,m[2]=w,m[3]=T,m[4]=w,m[5]=D,m[6]=y,m[7]=D,!this.clipedOff(this._transedPoints)){var b=Ai.create(t.RenderSpriteData.Texture2D);b.shaderData.addDefine(Ri.FILLTEXTURE);var C=r.concat();u.tempVec4.setValue(C[0],C[1],C[2],C[3]),b.u_TexRange=u.tempVec4,p=this._curSubmit=Ui.create(this,this._mesh,b),this.fillShaderValue(b),p.clipInfoID=this._clipInfoID,p.shaderValue.textureHost=e;var R=this._mixRGBandAlpha(_,this._alpha);this._mesh.addQuad(this._transedPoints,m,R,!0),this._curSubmit._numEle+=6}this.breakNextMerge()}}setColorFilter(t){vi.save(this,vi.TYPE_COLORFILTER,this,!0),this._colorFiler=t,this.stopMerge=!0}drawTexture(t,e,i,s,r,a=4294967295){this._drawTextureM(t,e,i,s,r,null,1,null,a)}drawTextures(t,i,s,r,a){if(t._getSource())for(var n=i.length/2,l=0,o=t.bitmap.id,h=0;h<n;h++){const e="number"==typeof a[h]?a[h]:4294967295;this._inner_drawTexture(t,o,i[l++]+s,i[l++]+r,0,0,null,null,1,!1,e)}else this.sprite&&e.systemTimer.callLater(this,this._repaintSprite)}_drawTextureM(t,e,i,s,r,a,n,l,o){var h=this.sprite;return!!t._getSource((function(){h&&h.repaint()}))&&this._inner_drawTexture(t,t.bitmap.id,e,i,s,r,a,l,n,!1,o)}_drawRenderTexture(t,e,i,s,r,a,n,l,o=4294967295){return this._inner_drawTexture(t,-1,e,i,s,r,a,l,n,!1,o)}_copyClipInfo(t){let e=this._globalClipMatrix;var i=t.clipMatDir;i.x=e.a,i.y=e.b,i.z=e.c,i.w=e.d,t.clipMatDir=i;var s=t.clipMatPos;s.x=e.tx,s.y=e.ty,t.clipMatPos=s}_copyClipInfoToShaderData(t){let e=this._globalClipMatrix;u.tempVec4.setValue(e.a,e.b,e.c,e.d),t.setVector(Ri.UNIFORM_CLIPMATDIR,u.tempVec4),Ze.TempVector2.setValue(e.tx,e.ty),t.setVector2(Ri.UNIFORM_CLIPMATPOS,Ze.TempVector2)}isStopMerge(t){return this.stopMerge||t.clipInfoID!==this._clipInfoID}drawCallOptimize(t){return this._charSubmitCache.enable(t,this),t}_drawToRender2D(t){let e=this._mesh;if(e.indexNum<=0)return;let i=t.shaderValue,s=i.shaderData;switch(t._key.blendShader){case 1:case 3:case 5:s.setInt(ci.BLEND_SRC,ve.BLENDPARAM_ONE),s.setInt(ci.BLEND_DST,ve.BLENDPARAM_ONE);break;case 2:s.setInt(ci.BLEND_SRC,ve.BLENDPARAM_DST_COLOR),s.setInt(ci.BLEND_DST,ve.BLENDPARAM_ONE_MINUS_SRC_ALPHA);break;case 6:s.setInt(ci.BLEND_SRC,ve.BLENDPARAM_ZERO),s.setInt(ci.BLEND_DST,ve.BLENDPARAM_SRC_ALPHA);break;case 7:s.setInt(ci.BLEND_SRC,ve.BLENDPARAM_ZERO),s.setInt(ci.BLEND_DST,ve.BLENDPARAM_ZERO);break;case 9:s.setInt(ci.BLEND_SRC,ve.BLENDPARAM_SRC_ALPHA),s.setInt(ci.BLEND_DST,ve.BLENDPARAM_ONE_MINUS_SRC_ALPHA);break;default:s.setInt(ci.BLEND_SRC,ve.BLENDPARAM_ONE),s.setInt(ci.BLEND_DST,ve.BLENDPARAM_ONE_MINUS_SRC_ALPHA)}if(t._colorFiler){var r=t._colorFiler;i.setFilter(r),Ke.TEMPMatrix0.cloneByArray(r._mat),s.setMatrix4x4(Ri.UNIFORM_COLORMAT,Ke.TEMPMatrix0),u.tempVec4.setValue(r._alpha[0],r._alpha[1],r._alpha[2],r._alpha[3]),s.setVector(Ri.UNIFORM_COLORALPHA,u.tempVec4)}this._drawMesh(e,0,e.vertexNum,t._startIdx,e.indexNum,t.shaderValue,t.material),this.stopMerge=!1,this._drawCount++}_drawMesh(t,e,i,s,r,a,n){if(t.indexNum){let l=this._render2D;this._render2DManager._renderEnd||this._render2DManager.render(he.rendercontext2D),l.draw(t,e,i*t.vertexDeclarition.vertexStride,s,2*r,a,n)}t.clearMesh(),a._needRelease||(a._needRelease=!0,this._shaderValueNeedRelease.push(a))}_inner_drawTexture(e,i,s,r,a,n,l,o,h,u,d){if(a<=0||n<=0)return!1;var c=this._curSubmit._key;if(o=o||e._uv,c.submitType===Ui.KEY_TRIANGLES&&c.other===i){var _=this._drawTexToDrawTri_Vert;_[0]=s,_[1]=r,_[2]=s+a,_[3]=r,_[4]=s+a,_[5]=r+n,_[6]=s,_[7]=r+n,this._drawTriUseAbsMatrix=!0;var p=this._tempUV;return p[0]=o[0],p[1]=o[1],p[2]=o[2],p[3]=o[3],p[4]=o[4],p[5]=o[5],p[6]=o[6],p[7]=o[7],this.drawTriangles(e,0,0,_,p,this._drawTexToDrawTri_Index,l||this._curMat,h,null,null),this._drawTriUseAbsMatrix=!1,!0}var f=this._curSubmit,g=u?this._charSubmitCache.getPos():this._transedPoints;if(this.transformQuad(s,r,a||e.width,n||e.height,this._italicDeg,l||this._curMat,g),this.drawTexAlign){var m=Math.round;g[0]=m(g[0]),g[1]=m(g[1]),g[2]=m(g[2]),g[3]=m(g[3]),g[4]=m(g[4]),g[5]=m(g[5]),g[6]=m(g[6]),g[7]=m(g[7]),this.drawTexAlign=!1}var y=this._mixRGBandAlpha(d,this._alpha*h);if(u)return this._charSubmitCache.add(this,e,i,g,o,y),!0;var T=i>=0&&c.submitType===Ui.KEY_DRAWTEXTURE&&c.other===i&&!this.isStopMerge(this._curSubmit)&&this._mesh.vertexNum+4<os._MAXVERTNUM&&this._curSubmit.material==this._material;if(T||(this._drawToRender2D(this._curSubmit),this._mesh=this._meshQuatTex),this._lastTex=e,!T){let s=Ai.create(t.RenderSpriteData.Texture2D);this.fillShaderValue(s),s.textureHost=e,this._curSubmit=f=Ui.create(this,this._mesh,s),f._key.other=i,this._copyClipInfo(f.shaderValue),f.clipInfoID=this._clipInfoID}return this._mesh.addQuad(g,o,y,!0),f._numEle+=6,!0}fillShaderValue(t){t.size=new Ze(this._width,this._height),this._copyClipInfo(t)}clipedOff(t){return this._clipRect.width<=0||this._clipRect.height<=0}transformQuad(t,e,i,s,r,a,n){var l=0;0!=r&&(l=Math.tan(r*Math.PI/180)*s);var o=t+i,h=e+s,u=a.tx,d=a.ty,c=a.a,_=a.b,p=a.c,f=a.d,g=t+l,m=e,y=o+l,T=e,x=o,v=h,S=t,E=h;a._bTransform?(n[0]=g*c+m*p+u,n[1]=g*_+m*f+d,n[2]=y*c+T*p+u,n[3]=y*_+T*f+d,n[4]=x*c+v*p+u,n[5]=x*_+v*f+d,n[6]=S*c+E*p+u,n[7]=S*_+E*f+d):(n[0]=g+u,n[1]=m+d,n[2]=y+u,n[3]=T+d,n[4]=x+u,n[5]=v+d,n[6]=S+u,n[7]=E+d)}breakNextMerge(){this.stopMerge=!0}_repaintSprite(){this.sprite&&this.sprite.repaint()}drawTextureWithTransform(t,e,i,s,r,a,n,l,o,h,u,d=4294967295){var c,_=this._curMat;if(h&&(c=this.globalCompositeOperation,this.globalCompositeOperation=h),!a)return this._drawTextureM(t,e+n,i+l,s,r,_,o,u,d),void(h&&(this.globalCompositeOperation=c));ls.a=a.a,ls.b=a.b,ls.c=a.c,ls.d=a.d,ls.tx=a.tx+n,ls.ty=a.ty+l,ls._bTransform=a._bTransform,a&&_._bTransform?(G.mul(ls,_,ls),(a=ls)._bTransform=!0):(ls.tx+=_.tx,ls.ty+=_.ty,a=ls),this._drawTextureM(t,e,i,s,r,a,o,u,d),h&&(this.globalCompositeOperation=c)}drawGeo(t,e,i,s){this.drawLeftData();let r=this._curMat,a=this._matBuffer;a[0]=r.a,a[1]=r.b,a[2]=r.tx+r.a*i+r.c*s,a[3]=r.c,a[4]=r.d,a[5]=r.ty+r.b*i+r.d*s,e.setBuffer("u_NMatrix",a),e.setVector2("u_size",new Ze(this._width,this._height)),this._render2D.drawMesh(t,e)}drawGeos(t,e,i,s){this.drawLeftData();let r=this._curMat,a=this._matBuffer;a[0]=r.a,a[1]=r.b,a[2]=r.tx+r.a*i+r.c*s,a[3]=r.c,a[4]=r.d,a[5]=r.ty+r.b*i+r.d*s;for(let i=0,s=e.length;i<s;i++){let s=e[i][0];s.setBuffer("u_NMatrix",a),s.setVector2("u_size",new Ze(this._width,this._height)),t.clearRenderParams(),t.setDrawElemenParams(e[i][1],e[i][2]),this._render2D.drawMesh(t,s)}}drawTriangles(i,s,r,a,n,l,o,h,u,d=4294967295){if(null==h&&(h=1),i._getSource()){var c=null;u&&(c=this.globalCompositeOperation,this.globalCompositeOperation=u);var _=i.bitmap,p=this._curSubmit._key,f=p.submitType===Ui.KEY_TRIANGLES&&p.other===_.id&&p.blendShader==this._nBlendType&&this._mesh.vertexNum+a.length/2<os._MAXVERTNUM&&this._curSubmit.material==this._material;if(f||(this._drawToRender2D(this._curSubmit),this._mesh=this._meshTex),!f){var g=this._curSubmit=Ui.create(this,this._mesh,Ai.create(t.RenderSpriteData.Texture2D));g.shaderValue.textureHost=i,this.fillShaderValue(g.shaderValue),g._key.submitType=Ui.KEY_TRIANGLES,g._key.other=_.id,this._copyClipInfo(g.shaderValue),g.clipInfoID=this._clipInfoID}var m=this._mixRGBandAlpha(d,this._alpha*h);this._drawTriUseAbsMatrix?this._mesh.addData(a,n,l,o,m,null):(o?(ls.a=o.a,ls.b=o.b,ls.c=o.c,ls.d=o.d,ls.tx=o.tx+s,ls.ty=o.ty+r):(ls.a=1,ls.b=0,ls.c=0,ls.d=1,ls.tx=s,ls.ty=r),G.mul(ls,this._curMat,ls),this._mesh.addData(a,n,l,ls||this._curMat,m,null)),this._curSubmit._numEle+=l.length,u&&(this.globalCompositeOperation=c)}else this.sprite&&e.systemTimer.callLater(this,this._repaintSprite)}transform(t,e,i,s,r,a){wi.save(this),G.mul(G.TEMP.setTo(t,e,i,s,r,a),this._curMat,this._curMat),this._curMat._checkTransform()}rotate(t){wi.save(this),this._curMat.rotateEx(t)}scale(t,e){wi.save(this),this._curMat.scaleEx(t,e)}clipRect(t,e,i,s,r){if(Si.save(this),this._clipRect==os.MAXCLIPRECT?this._clipRect=new F(t,e,i,s):(this._clipRect.width=i,this._clipRect.height=s,this._clipRect.x=t,this._clipRect.y=e),this._clipID_Gen++,this._clipID_Gen%=1e4,this._clipInfoID=this._clipID_Gen,r)as.copyTo(this._globalClipMatrix);else{var a=this._globalClipMatrix,n=a.tx,l=a.ty,o=n+a.a,h=l+a.d;if(this._clipRect.width>=Ut.MAX_CLIP_SIZE?(a.a=a.d=Ut.MAX_CLIP_SIZE,a.b=a.c=a.tx=a.ty=0):this._curMat._bTransform?(a.tx=this._clipRect.x*this._curMat.a+this._clipRect.y*this._curMat.c+this._curMat.tx,a.ty=this._clipRect.x*this._curMat.b+this._clipRect.y*this._curMat.d+this._curMat.ty,a.a=this._clipRect.width*this._curMat.a,a.b=this._clipRect.width*this._curMat.b,a.c=this._clipRect.height*this._curMat.c,a.d=this._clipRect.height*this._curMat.d):(a.tx=this._clipRect.x+this._curMat.tx,a.ty=this._clipRect.y+this._curMat.ty,a.a=this._clipRect.width,a.b=a.c=0,a.d=this._clipRect.height),a.a>0&&a.d>0){var u=a.tx+a.a,d=a.ty+a.d;u<=n||d<=l||a.tx>=o||a.ty>=h?(a.a=-.1,a.d=-.1):(a.tx<n&&(a.a-=n-a.tx,a.tx=n),u>o&&(a.a-=u-o),a.ty<l&&(a.d-=l-a.ty,a.ty=l),d>h&&(a.d-=d-h),a.a<=0&&(a.a=-.1),a.d<=0&&(a.d=-.1))}}}startRender(){for(let t of this._shaderValueNeedRelease)t.release(),t._needRelease=!1;this._shaderValueNeedRelease.length=0,this._render2D.renderStart(this._clear,this._clearColor),this.clear()}endRender(){this.flush(),this._render2DManager._renderEnd||this._render2DManager.render(he.rendercontext2D),this._render2D.renderEnd(),this._curSubmit=Ui.RENDERBASE}drawLeftData(){this._drawToRender2D(this._curSubmit)}flush(){this.drawLeftData(),this._clipID_Gen=0,this._path&&this._path.reset(),this._curSubmit=Ui.RENDERBASE,this._flushCnt++,this._flushCnt%60==0&&this.isMain&&es.textRenderInst&&es.textRenderInst.GC()}beginPath(t=!1){this._getPath().beginPath(t)}closePath(){this._path.closePath()}addPath(t,e,i,s,r){let a=t.length;for(let e=0;e<a-1;e+=2)t[e]+=s,t[e+1]+=r;e&&a>5&&(t[a-2]!=t[0]||t[a-1]!=t[1])&&t.push(t[0],t[1]),this._getPath().push(t,i)}fill(){var t=this._curMat,e=this._getPath(),i=this._curSubmit;i._key.submitType===Ui.KEY_VG&&i._key.blendShader===this._nBlendType&&!this.isStopMerge(i)&&this._curSubmit.material==this._material||(this._drawToRender2D(i),this._mesh=this._meshVG,this._curSubmit=this.addVGSubmit(this._mesh),this.fillShaderValue(this._curSubmit.shaderValue));for(var s,r=this.mixRGBandAlpha(this.fillStyle.toInt()),a=0,n=0,l=e.paths.length;n<l;n++){var o=e.paths[n],h=o.path.length/2;if(!(h<3||3==h&&!o.convex)){var u,d,c,_,p=o.path.concat(),f=0;if(t._bTransform)for(f=0;f<h;f++)d=(u=f<<1)+1,c=p[u],_=p[d],p[u]=t.a*c+t.c*_+t.tx,p[d]=t.b*c+t.d*_+t.ty;else for(f=0;f<h;f++)d=(u=f<<1)+1,c=p[u],_=p[d],p[u]=c+t.tx,p[d]=_+t.ty;this._mesh.vertexNum+h>os._MAXVERTNUM&&(this._curSubmit._numEle+=a,a=0,this._mesh=new rs,this._curSubmit=this.addVGSubmit(this._mesh),this.fillShaderValue(this._curSubmit.shaderValue));var g=this._mesh.vertexNum;if(o.convex){var m=h-2;s=new Array(3*m);for(var y=0,T=0;T<m;T++)s[y++]=g,s[y++]=T+1+g,s[y++]=T+2+g}else if(s=Oi.earcut(p,null,2),g>0)for(var x=0;x<s.length;x++)s[x]+=g;this._mesh.addVertAndIBToMesh(p,r,s),a+=s.length}}this._curSubmit._numEle+=a}addVGSubmit(e){var i=Ui.create(this,e,Ai.create(t.RenderSpriteData.Primitive));return this.fillShaderValue(i.shaderValue),i._key.submitType=Ui.KEY_VG,this._copyClipInfo(i.shaderValue),i.clipInfoID=this._clipInfoID,i}stroke(){if(!(this.lineWidth<=0)){var t=this.mixRGBandAlpha(this.strokeStyle._color.numColor),e=this._getPath(),i=this._curSubmit;i._key.submitType===Ui.KEY_VG&&i._key.blendShader===this._nBlendType&&!this.isStopMerge(i)&&this._curSubmit.material==this._material||(this._drawToRender2D(this._curSubmit),this._mesh=this._meshVG,this._curSubmit=this.addVGSubmit(this._mesh),this.fillShaderValue(this._curSubmit.shaderValue));for(var s=0,r=0,a=e.paths.length;r<a;r++){var n=e.paths[r];if(!(n.path.length<=0)){var l=[],o=[],h=2*n.path.length;if(!(h<2)){this._mesh.vertexNum+h>os._MAXVERTNUM&&(this._curSubmit._numEle+=s,s=0,this._drawToRender2D(this._curSubmit),this._mesh=new rs,this._curSubmit=this.addVGSubmit(this._mesh),this.fillShaderValue(this._curSubmit.shaderValue)),Pi.createLine2(n.path,l,this.lineWidth,this._mesh.vertexNum,o,n.loop);var u,d,c,_,p=o.length/2,f=this._curMat,g=0;if(f._bTransform)for(g=0;g<p;g++)d=(u=g<<1)+1,c=o[u],_=o[d],o[u]=f.a*c+f.c*_+f.tx,o[d]=f.b*c+f.d*_+f.ty;else for(g=0;g<p;g++)d=(u=g<<1)+1,c=o[u],_=o[d],o[u]=c+f.tx,o[d]=_+f.ty;this._mesh.addVertAndIBToMesh(o,t,l),s+=l.length}}}this._curSubmit._numEle+=s}}moveTo(t,e){var i=this._getPath();i.newPath(),i._lastOriX=t,i._lastOriY=e,i.addPoint(t,e)}lineTo(t,e){var i=this._getPath();Math.abs(t-i._lastOriX)<.001&&Math.abs(e-i._lastOriY)<.001||(i._lastOriX=t,i._lastOriY=e,i.addPoint(t,e))}arcTo(t,e,i,s,r){var a=0,n=0,l=0,o=this._path._lastOriX-t,h=this._path._lastOriY-e,u=Math.sqrt(o*o+h*h);if(!(u<=1e-6)){var d=o/u,c=h/u,_=i-t,p=s-e,f=_*_+p*p,g=Math.sqrt(f);if(!(g<=1e-6)){var m=_/g,y=p/g,T=d+m,x=c+y,v=Math.sqrt(T*T+x*x);if(!(v<=1e-6)){var S=T/v,E=x/v,w=Math.acos(S*d+E*c),D=Math.PI/2-w,b=(u=r*Math.tan(D))*d+t,C=u*c+e,R=Math.sqrt(u*u+r*r),A=t+S*R,I=e+E*R,M=0,B=0;if(d*y-c*m>=0){var L=2*D/os.SEGNUM;M=Math.sin(L),B=Math.cos(L)}else L=2*-D/os.SEGNUM,M=Math.sin(L),B=Math.cos(L);var P=this._path._lastOriX,N=this._path._lastOriY,O=b,F=C;(Math.abs(O-this._path._lastOriX)>.1||Math.abs(F-this._path._lastOriY)>.1)&&(n=O,l=F,P=O,N=F,this._path._lastOriX=n,this._path._lastOriY=l,this._path.addPoint(n,l));var U=b-A,k=C-I;for(a=0;a<os.SEGNUM;a++){var G=U*B+k*M,V=-U*M+k*B;n=G+A,l=V+I,(Math.abs(P-n)>.1||Math.abs(N-l)>.1)&&(this._path._lastOriX=n,this._path._lastOriY=l,this._path.addPoint(n,l),P=n,N=l),U=G,k=V}}}}}arc(t,e,i,s,r,a,n=!1,l=!0,o=20){r>a&&([r,a]=[a,r]);var h=this.getMatScaleX(),u=this.getMatScaleY(),d=i*(h>u?h:u),c=2*Math.PI*d;let _=0|Math.max(c/5,o),p=2*Math.PI/_;var f=this._getPath();let g=t+Math.cos(r)*i,m=e+Math.sin(r)*s;g==this._path._lastOriX&&m==this._path._lastOriY||f.addPoint(g,m);let y=Math.ceil(r/p)*p;for(;a-y>=p;)g=t+Math.cos(y)*i,m=e+Math.sin(y)*s,f.addPoint(g,m),y+=p;g=t+Math.cos(a)*i,m=e+Math.sin(a)*s,g==this._path._lastOriX&&m==this._path._lastOriY||f.addPoint(g,m)}quadraticCurveTo(t,e,i,s){for(var r=_i.I.getBezierPoints([this._path._lastOriX,this._path._lastOriY,t,e,i,s],30,2),a=0,n=r.length/2;a<n;a++)this.lineTo(r[2*a],r[2*a+1]);this.lineTo(i,s)}mixRGBandAlpha(t){return this._mixRGBandAlpha(t,this._alpha)}_mixRGBandAlpha(t,e){if(e>=1)return t;var i=(4278190080&t)>>>24;return 0!=i?i*=e:i=255*e,16777215&t|i<<24}strokeRect(t,e,i,s,r){if(this.lineWidth>0){var a=this.mixRGBandAlpha(this.strokeStyle._color.numColor),n=this.lineWidth/2;this._fillRect(t-n,e-n,i+this.lineWidth,this.lineWidth,a),this._fillRect(t-n,e-n+s,i+this.lineWidth,this.lineWidth,a),this._fillRect(t-n,e+n,this.lineWidth,s-this.lineWidth,a),this._fillRect(t-n+i,e+n,this.lineWidth,s-this.lineWidth,a)}}drawParticle(t,e,i){}_getPath(){return this._path||(this._path=new Ti)}get canvas(){return this._canvas}_fillTexture_h(t,e,i,s,r,a,n,l,o){if(!(s<=0)){for(var h=a,u=Math.floor(l/s),d=l%s,c=0;c<u;c++)this._inner_drawTexture(t,e,h,n,s,r,this._curMat,i,1,!1,o),h+=s;if(d>0){var _=i[2]-i[0],p=i[0]+_*(d/s),f=ns;f[0]=i[0],f[1]=i[1],f[2]=p,f[3]=i[3],f[4]=p,f[5]=i[5],f[6]=i[6],f[7]=i[7],this._inner_drawTexture(t,e,h,n,d,r,this._curMat,f,1,!1,o)}}}_fillTexture_v(t,e,i,s,r,a,n,l,o){if(!(r<=0)){for(var h=n,u=Math.floor(l/r),d=l%r,c=0;c<u;c++)this._inner_drawTexture(t,e,a,h,s,r,this._curMat,i,1,!1,o),h+=r;if(d>0){var _=i[7]-i[1],p=i[1]+_*(d/r),f=ns;f[0]=i[0],f[1]=i[1],f[2]=i[2],f[3]=i[3],f[4]=i[4],f[5]=p,f[6]=i[6],f[7]=p,this._inner_drawTexture(t,e,a,h,s,d,this._curMat,f,1,!1,o)}}}drawTextureWithSizeGrid(t,e,i,s,r,a,n,l,o){if(t._getSource()){e+=n,i+=l;var h=t.uv,u=t.bitmap.width,d=t.bitmap.height,c=a[0],_=a[3],p=a[1],f=a[2],g=a[4];s==t.width&&(_=p=0),r==t.height&&(c=f=0);var m=c/d,y=_/u,T=p/u,x=f/d,v=t.bitmap.id,S=this._curMat,E=this._tempUV,w=1,D=1;_+p>s&&(w=s/(_+p)),c+f>r&&(D=r/(c+f)),_*=w,p*=w,c*=D,f*=D;var b=h[0],C=h[1],R=h[4],A=h[5],I=b,M=C,B=R,L=A;if(_&&c&&(B=b+y,L=C+m,E[0]=b,E[1]=C,E[2]=B,E[3]=C,E[4]=B,E[5]=L,E[6]=b,E[7]=L,this._inner_drawTexture(t,v,e,i,_,c,S,E,1,!1,o)),p&&c&&(I=R-T,M=C,B=R,L=C+m,E[0]=I,E[1]=M,E[2]=B,E[3]=M,E[4]=B,E[5]=L,E[6]=I,E[7]=L,this._inner_drawTexture(t,v,s-p+e,0+i,p,c,S,E,1,!1,o)),_&&f&&(I=b,M=A-x,B=b+y,L=A,E[0]=I,E[1]=M,E[2]=B,E[3]=M,E[4]=B,E[5]=L,E[6]=I,E[7]=L,this._inner_drawTexture(t,v,0+e,r-f+i,_,f,S,E,1,!1,o)),p&&f&&(I=R-T,M=A-x,B=R,L=A,E[0]=I,E[1]=M,E[2]=B,E[3]=M,E[4]=B,E[5]=L,E[6]=I,E[7]=L,this._inner_drawTexture(t,v,s-p+e,r-f+i,p,f,S,E,1,!1,o)),c&&(I=b+y,M=C,B=R-T,L=C+m,E[0]=I,E[1]=M,E[2]=B,E[3]=M,E[4]=B,E[5]=L,E[6]=I,E[7]=L,g?this._fillTexture_h(t,v,E,t.width-_-p,c,_+e,i,s-_-p,o):this._inner_drawTexture(t,v,_+e,i,s-_-p,c,S,E,1,!1,o)),f&&(I=b+y,M=A-x,B=R-T,L=A,E[0]=I,E[1]=M,E[2]=B,E[3]=M,E[4]=B,E[5]=L,E[6]=I,E[7]=L,g?this._fillTexture_h(t,v,E,t.width-_-p,f,_+e,r-f+i,s-_-p,o):this._inner_drawTexture(t,v,_+e,r-f+i,s-_-p,f,S,E,1,!1,o)),_&&(I=b,M=C+m,B=b+y,L=A-x,E[0]=I,E[1]=M,E[2]=B,E[3]=M,E[4]=B,E[5]=L,E[6]=I,E[7]=L,g?this._fillTexture_v(t,v,E,_,t.height-c-f,e,c+i,r-c-f,o):this._inner_drawTexture(t,v,e,c+i,_,r-c-f,S,E,1,!1,o)),p&&(I=R-T,M=C+m,B=R,L=A-x,E[0]=I,E[1]=M,E[2]=B,E[3]=M,E[4]=B,E[5]=L,E[6]=I,E[7]=L,g?this._fillTexture_v(t,v,E,p,t.height-c-f,s-p+e,c+i,r-c-f,o):this._inner_drawTexture(t,v,s-p+e,c+i,p,r-c-f,S,E,1,!1,o)),I=b+y,M=C+m,B=R-T,L=A-x,E[0]=I,E[1]=M,E[2]=B,E[3]=M,E[4]=B,E[5]=L,E[6]=I,E[7]=L,g){var P=os.tmpUVRect;P[0]=I,P[1]=M,P[2]=B-I,P[3]=L-M,this._fillTexture(t,t.width-_-p,t.height-c-f,P,_+e,c+i,s-_-p,r-c-f,"repeat",0,0,o)}else this._inner_drawTexture(t,v,_+e,c+i,s-_-p,r-c-f,S,E,1,!1,o)}}}os._MAXVERTNUM=65535,os.MAXCLIPRECT=null,os.SEGNUM=32,os._contextcount=0,os._textRender=null,os.tmpUVRect=[0,0,0,0];class hs{constructor(){this.lineWidth=1}clear(){this.lineWidth=1,this.textAlign=this.textBaseline=null}make(){return this===hs.DEFAULT?new hs:this}}class us{static __init__(){us.map[re.ALPHA|re.TRANSFORM|re.GRAPHICS]=us.alpha_transform_drawLayaGL,us.map[re.ALPHA|re.GRAPHICS]=us.alpha_drawLayaGL,us.map[re.TRANSFORM|re.GRAPHICS]=us.transform_drawLayaGL,us.map[re.TRANSFORM|re.CHILDS]=us.transform_drawNodes,us.map[re.ALPHA|re.TRANSFORM|re.TEXTURE]=us.alpha_transform_drawTexture,us.map[re.ALPHA|re.TEXTURE]=us.alpha_drawTexture,us.map[re.TRANSFORM|re.TEXTURE]=us.transform_drawTexture,us.map[re.GRAPHICS|re.CHILDS]=us.drawLayaGL_drawNodes}static transform_drawTexture(t,e,i,s){var r=t.texture;e.save(),e.transformByMatrix(t.transform,i,s);var a=t._isWidthSet?t._width:r.sourceWidth,n=t._isHeightSet?t._height:r.sourceHeight,l=a/r.sourceWidth,o=n/r.sourceHeight;if(a=r.width*l,n=r.height*o,a<=0||n<=0)return null;var h=-t.pivotX+r.offsetX*l,u=-t.pivotY+r.offsetY*o;t._getBit(kt.HIDE_BY_EDITOR)||e.drawTexture(r,h,u,a,n),e.restore()}static alpha_drawTexture(t,e,i,s){var r=t._style,a=r.alpha,n=t.texture;if(a>.01||t._needRepaint()){var l=e.globalAlpha;e.globalAlpha*=a;var o=t._isWidthSet?t._width:n.sourceWidth,h=t._isHeightSet?t._height:n.sourceHeight,u=o/n.sourceWidth,d=h/n.sourceHeight;if(o=n.width*u,h=n.height*d,o<=0||h<=0)return null;var c=i-r.pivotX+n.offsetX*u,_=s-r.pivotY+n.offsetY*d;t._getBit(kt.HIDE_BY_EDITOR)||e.drawTexture(n,c,_,o,h),e.globalAlpha=l}}static alpha_transform_drawTexture(t,e,i,s){var r=t._style,a=r.alpha,n=t.texture;if(a>.01||t._needRepaint()){var l=e.globalAlpha;e.globalAlpha*=a,e.save(),e.transformByMatrix(t.transform,i,s);var o=t._isWidthSet?t._width:n.sourceWidth,h=t._isHeightSet?t._height:n.sourceHeight,u=o/n.sourceWidth,d=h/n.sourceHeight;if(o=n.width*u,h=n.height*d,o<=0||h<=0)return null;var c=-r.pivotX+n.offsetX*u,_=-r.pivotY+n.offsetY*d;t._getBit(kt.HIDE_BY_EDITOR)||e.drawTexture(n,c,_,o,h),e.restore(),e.globalAlpha=l}}static alpha_transform_drawLayaGL(t,e,i,s){var r=t._style,a=r.alpha;if(a>.01||t._needRepaint()){var n=e.globalAlpha;e.globalAlpha*=a,e.save(),e.transformByMatrix(t.transform,i,s),t._getBit(kt.HIDE_BY_EDITOR)||t._graphics&&t._graphics._render(t,e,-r.pivotX,-r.pivotY),e.restore(),e.globalAlpha=n}}static alpha_drawLayaGL(t,e,i,s){var r=t._style,a=r.alpha;if(a>.01||t._needRepaint()){var n=e.globalAlpha;e.globalAlpha*=a,t._getBit(kt.HIDE_BY_EDITOR)||t._graphics&&t._graphics._render(t,e,i-r.pivotX,s-r.pivotY),e.globalAlpha=n}}static transform_drawLayaGL(t,e,i,s){var r=t._style;e.save(),e.transformByMatrix(t.transform,i,s),t._getBit(kt.HIDE_BY_EDITOR)||t._graphics&&t._graphics._render(t,e,-r.pivotX,-r.pivotY),e.restore()}static transform_drawNodes(t,e,i,s){var r=t._getBit(kt.DRAWCALL_OPTIMIZE)&&e.drawCallOptimize(!0),a=t._style;e.save(),e.transformByMatrix(t.transform,i,s),i=-a.pivotX,s=-a.pivotY;var n=t._children,l=n.length;let o,h,u,d,c,_,p;a.viewport&&(o=a.viewport,h=o.x,u=o.y,d=o.right,c=o.bottom);for(let t=0;t<l;++t){let r=n[t],a=r._visible||r._getBit(kt.DISABLE_VISIBILITY);o&&((_=r._x)>=d||_+r.width<=h||(p=r._y)>=c||p+r.height<=u)&&(a=!1),a&&r.render(e,i,s)}e.restore(),r&&e.drawCallOptimize(!1)}static drawLayaGL_drawNodes(t,e,i,s){var r=t._getBit(kt.DRAWCALL_OPTIMIZE)&&e.drawCallOptimize(!0);let a=e._drawingToTexture;var n=t._style;i-=n.pivotX,s-=n.pivotY,t._getBit(kt.HIDE_BY_EDITOR)||t._graphics&&t._graphics._render(t,e,i,s);var l=t._children,o=l.length;let h,u,d,c,_,p,f,g;n.viewport&&(h=n.viewport,u=h.x,d=h.y,c=h.right,_=h.bottom);for(let t=0;t<o;++t){let r=l[t];g=a?r._visible&&!r._getBit(kt.ESCAPE_DRAWING_TO_TEXTURE):r._visible||r._getBit(kt.DISABLE_VISIBILITY),h&&((p=r._x)>=c||p+r.width<=u||(f=r._y)>=_||f+r.height<=d)&&(g=!1),g&&r.render(e,i,s)}r&&e.drawCallOptimize(!1)}}us.map=[];var ds=0;class cs extends os{constructor(){super(...arguments),this.cache=null,this.mustTouchRes=[],this.randomTouchRes=[],this.genID=ds++}touchRes(t){t.isRandomTouch?this.randomTouchRes.push(t):this.mustTouchRes.push(t)}}class _s extends oe{constructor(){super(null),this.renderResult=[]}clone(t){return null}_createMesh(){}setVertexDecl(t){this._tex_vert_decl!=t&&(this._tex_vert_decl=t,this._createMesh())}renderStart(){}draw(t,e,i,s,r,a){this.setVertexDecl(t.vertexDeclarition);let n=new ps(t,e,i,s,r,a),l=a.clipMatPos,o=a.clipMatDir,h=n.localClipMatrix;h.a=o.x,h.b=o.y,h.c=o.z,h.d=o.w,h.tx=l.x,h.ty=l.y,a.shaderData.addDefine(Ri.WORLDMAT),n.toNativeMesh(),this.renderResult.push(n)}drawMesh(t,e){throw new V}drawElement(t){throw new V}renderEnd(){}}class ps{constructor(t,e,i,s,r,a){this.localClipMatrix=new G,this.vertexDeclarition=t.vertexDeclarition,this.vbBuffer=new ArrayBuffer(i),this.ibBuffer=new ArrayBuffer(r),new Uint8Array(this.vbBuffer).set(new Uint8Array(t.vbBuffer,e,i)),new Uint8Array(this.ibBuffer).set(new Uint8Array(t.ibBuffer,s,r)),this.mtl=a,this.vboff=0,this.vblen=i,this.iboff=0,this.iblen=r}toNativeMesh(){let e=l.renderDeviceFactory,i=this.geo=e.createRenderGeometryElement(t.MeshTopology.Triangles,t.DrawType.DrawElement),s=i.bufferState=e.createBufferState(),r=e.createVertexBuffer(t.BufferUsage.Dynamic);r.vertexDeclaration=this.vertexDeclarition;let a=e.createIndexBuffer(t.BufferUsage.Dynamic);s.applyState([r],a),i.indexFormat=t.IndexFormat.UInt16,r.setDataLength(this.vblen),r.setData(this.vbBuffer,this.vboff,0,this.vblen),a._setIndexDataLength(this.iblen),a._setIndexData(new Uint16Array(this.ibBuffer,this.iboff,this.iblen/2),0),i.clearRenderParams(),i.setDrawElemenParams(this.iblen/2,0),this.renderElement=l.render2DRenderPassFactory.createRenderElement2D(),this.renderElement.geometry=i,this.renderElement.value2DShaderData=this.mtl.shaderData,this.renderElement.subShader=this.mtl._defaultShader.getSubShaderAt(0),this.renderElement.materialShaderData=null}destroyGPUResource(){this.renderElement&&this.renderElement.destroy();let t=this.geo;t&&(t.bufferState._vertexBuffers[0].destroy(),t.bufferState._bindedIndexBuffer.destroy(),t.bufferState.destroy(),t.bufferState,t.destroy(),this.geo=null)}}class fs{constructor(){this.page=null}reset(){this.page&&this.page.reset(),this.page=null}}function gs(t,e,i){let s=t.tx+t.a,r=t.ty+t.d,a=e.tx+e.a,n=e.ty+e.d,l=i.tx=Math.max(t.tx,e.tx),o=i.ty=Math.max(t.ty,e.ty);if(i.b=i.c=0,i.tx=l,i.ty=o,s<=e.tx||r<=e.ty||a<=t.tx||n<=t.ty)i.a=-.1,i.d=-.1;else{let t=Math.min(s,a),e=Math.min(r,n);i.a=t-l,i.d=e-o}return i}class ms{constructor(t,e,i){this.alpha=1,this.width=0,this.height=0,this.blend=0;let s=this.curMatrix=t._curMat.clone();s.tx+=s.a*e+s.c*i,s.ty+=s.b*e+s.d*i,this.alpha=t.globalAlpha,this.render2d=t.render2D,this.width=t.width,this.height=t.height,this.clipInfo=t._globalClipMatrix.clone(),this.blend=t._nBlendType}_copyClipInfo(t){let e=this.clipInfo;var i=t.clipMatDir;i.x=e.a,i.y=e.b,i.z=e.c,i.w=e.d,t.clipMatDir=i;var s=t.clipMatPos;s.x=e.tx,s.y=e.ty,t.clipMatPos=s}clipRect(t){let e=t.x,i=t.y,s=t.width,r=t.height;var a=this.clipInfo,n=a.tx,l=a.ty,o=n+a.a,h=l+a.d;if(s>=Ut.MAX_CLIP_SIZE)a.a=a.d=Ut.MAX_CLIP_SIZE,a.b=a.c=a.tx=a.ty=0;else{let t=this.curMatrix;t._bTransform?(a.tx=e*t.a+i*t.c+t.tx,a.ty=e*t.b+i*t.d+t.ty,a.a=s*t.a,a.b=s*t.b,a.c=r*t.c,a.d=r*t.d):(a.tx=e+t.tx,a.ty=i+t.ty,a.a=s,a.b=a.c=0,a.d=r)}if(a.a>0&&a.d>0){var u=a.tx+a.a,d=a.ty+a.d;u<=n||d<=l||a.tx>=o||a.ty>=h?(a.a=-.1,a.d=-.1):(a.tx<n&&(a.a-=n-a.tx,a.tx=n),u>o&&(a.a-=u-o),a.ty<l&&(a.d-=l-a.ty,a.ty=l),d>h&&(a.d-=d-h),a.a<=0&&(a.a=-.1),a.d<=0&&(a.d=-.1))}}setBlendMode(t){this.blend=fi.TOINT[t]}_applyBlend(t){let e=t.shaderData;switch(this.blend){case 1:case 3:case 5:e.setInt(ci.BLEND_SRC,ve.BLENDPARAM_ONE),e.setInt(ci.BLEND_DST,ve.BLENDPARAM_ONE);break;case 2:e.setInt(ci.BLEND_SRC,ve.BLENDPARAM_DST_COLOR),e.setInt(ci.BLEND_DST,ve.BLENDPARAM_ONE_MINUS_SRC_ALPHA);break;case 6:e.setInt(ci.BLEND_SRC,ve.BLENDPARAM_ZERO),e.setInt(ci.BLEND_DST,ve.BLENDPARAM_SRC_ALPHA);break;case 7:e.setInt(ci.BLEND_SRC,ve.BLENDPARAM_ZERO),e.setInt(ci.BLEND_DST,ve.BLENDPARAM_ZERO);break;case 9:e.setInt(ci.BLEND_SRC,ve.BLENDPARAM_SRC_ALPHA),e.setInt(ci.BLEND_DST,ve.BLENDPARAM_ONE_MINUS_SRC_ALPHA);break;default:e.setInt(ci.BLEND_SRC,ve.BLENDPARAM_ONE),e.setInt(ci.BLEND_DST,ve.BLENDPARAM_ONE_MINUS_SRC_ALPHA)}}}class ys{constructor(){this.sprite=null,this.meshes=null,this.defferTouchRes=null,this.defferTouchResRand=null,this.children=null}reset(){this.clearGPUObject()}clearGPUObject(){this.meshes&&this.meshes.forEach((t=>{t.destroyGPUResource()}))}render(t,e,i){let s=t.transform,r=e.curMatrix;if(i)r.copyTo(vs);else{let i=t._x,a=t._y;s?(s.copyTo(Es),Es.tx=i,Es.ty=a,G.mul(Es,r,vs)):(vs.a=r.a,vs.b=r.b,vs.c=r.c,vs.d=r.d,vs.tx=r.a*i+r.c*a+r.tx,vs.ty=r.b*i+r.d*a+r.ty),e.alpha*=t.alpha,t.blendMode&&e.setBlendMode(t.blendMode)}Ts.setValue(e.width,e.height);let a=ws,n=a.elements;n[0]=vs.a,n[1]=vs.b,n[4]=vs.c,n[5]=vs.d,n[12]=vs.tx,n[13]=vs.ty,this.meshes.forEach((t=>{let i=e.render2d,s=t.mtl;s.textureHost instanceof ji&&s.textureHost.touchTexture(),s.size=Ts;let r=t.localClipMatrix;r.a==Ut.MAX_CLIP_SIZE&&r.d==Ut.MAX_CLIP_SIZE?e.clipInfo.copyTo(Ds):(G.mul(r,vs,Ds),gs(e.clipInfo,Ds,Ds));let n=s.clipMatDir,l=s.clipMatPos;n.x=Ds.a,n.y=Ds.b,n.z=Ds.c,n.w=Ds.d,s.clipMatDir=n,l.x=Ds.tx,l.y=Ds.ty,s.clipMatPos=l,s.mmat=a,s.vertAlpha=e.alpha,e._applyBlend(s),i.drawElement(t.renderElement)})),this.defferTouchRes.forEach((t=>{t.touch()})),this.defferTouchResRand.forEach((t=>t.touch())),this.children&&this.children.forEach((t=>{let i=e.curMatrix.clone(),s=e.alpha,r=t.parent._cacheStyle.cacheInfo,a=r.mat;G.mul(a,i,e.curMatrix),e.alpha*=r.alpha;let n=e.blend;null!=r.blend&&e.setBlendMode(r.blend);let l=e.clipInfo.clone(),o=r.clipMatrix;G.mul(o,e.curMatrix,Ds),gs(e.clipInfo,Ds,e.clipInfo),t._cacheStyle.cacheInfo.page.render(t,e,!1),e.curMatrix=i,e.alpha=s,e.blend=n,e.clipInfo=l}))}}var Ts=new Ze;class xs{static curMatSubSpriteMat(t,e,i){if(t._renderType&re.TRANSFORM)t.transform.copyTo(Ss),Ss.tx=t._x,Ss.ty=t._y,Ss.invert(),G.mul(Ss,e,i);else{e.copyTo(i);let s=-t._x,r=-t._y;i.tx+=i.a*s+i.c*r,i.ty+=i.b*s+i.d*r}return i}static renderCacheAsNormal(t,i,s,a,n){let l=!1;var o=i._getCacheStyle().cacheInfo.page;if(!o||i._needRepaint()||e.stage.isGlobalRepaint()){if(i.alpha<=1e-6&&(i.alpha=.001),l=!0,t instanceof cs){let e=t.cache;e.children?e.children.indexOf(i)<0&&e.children.push(i):e.children=[i];let s=i.parent,r=s._cacheStyle.cacheInfo;if(r.page=e,t.genID!=r.contextID){r.contextID=t.genID;let l=t._curMat.clone();0==a&&0==n||(l.tx+=a*l.a+n*l.c,l.ty+=a*l.b+n*l.d),r.mat=xs.curMatSubSpriteMat(i,l,l),r.alpha=t.globalAlpha/i.alpha;let o=e.sprite;if(s.blendMode)r.blend=s.blendMode;else{let t=s;for(;t!=o;)if(t=t.parent,t.blendMode){r.blend=t.blendMode;break}}r.clipMatrix=t._globalClipMatrix.clone()}}(o=i._cacheStyle.cacheInfo.page=new ys).sprite=i,ae.canvasNormal++;let e=new cs;e.cache=o;let h=new _s;e.render2D=h,e.startRender(),s._fun(i,e,0,0),e.endRender(),o.meshes=h.renderResult,o.defferTouchRes=e.mustTouchRes,o.defferTouchResRand=e.randomTouchRes,i.once(r.REMOVED,(()=>{(o=i._cacheStyle.cacheInfo.page).reset()}))}if(!(t instanceof cs)){let e=new ms(t,a,n);o.render(i,e,!0)}return l}}var vs=new G,Ss=new G,Es=new G,ws=new Ke,Ds=new G;class bs{static __init__(){us.__init__();var t=new bs(69905,null);let e=bs.renders.length=2*re.CHILDS;for(let i=0;i<e;i++)bs.renders[i]=t;bs.renders[0]=new bs(0,null)}static _initRenderFun(t,e,i,s){var r=t._renderType;(bs.renders[r]=bs._getTypeRender(r))._fun(t,e,i,s)}static _getTypeRender(t){if(us.map[t]&&n.isPlaying)return new bs(t,null);for(var e=null,i=re.CHILDS;i>0;)i&t&&(e=new bs(i,e)),i>>=1;return e}constructor(t,e){if(this._spriteRect_TextureSpace=new F,this._maskRect_TextureSpace=new F,us.map[t]&&n.isPlaying)return this._fun=us.map[t],void(this._next=bs.NORENDER);switch(this._next=e||bs.NORENDER,t){case 0:return void(this._fun=this._no);case re.ALPHA:return void(this._fun=this._alpha);case re.TRANSFORM:return void(this._fun=this._transform);case re.BLEND:return void(this._fun=this._blend);case re.CANVAS:return void(this._fun=this._canvas);case re.MASK:return void(this._fun=this._mask);case re.CLIP:return void(this._fun=this._clip);case re.GRAPHICS:return void(this._fun=this._graphics);case re.CHILDS:return void(this._fun=this._children);case re.CUSTOM:return void(this._fun=this._custom);case re.TEXTURE:return void(this._fun=this._texture);case re.FILTERS:return void(this._fun=ie._filter);case re.HITAREA:return void(this._fun=this._hitarea);case re.RENDERNODE2D:this._fun=this._renderNode2D;break;case 69905:return void(this._fun=bs._initRenderFun)}}_renderNode2D(t,e,i,s){t._renderNode.addCMDCall&&t._renderNode.addCMDCall(e,i,s),e.drawLeftData(),e._render2DManager._renderEnd?(e._render2DManager._renderEnd=!1,e._render2DManager.addRenderObject(t._renderNode)):e._render2DManager.addRenderObject(t._renderNode),this._next!=bs.NORENDER&&this._next._fun(t,e,i,s)}_no(t,e,i,s){}_custom(t,e,i,s){t.customRender(e,i,s),this._next._fun(t,e,0,0)}_clip(t,e,i,s){let r=this._next;if(r==bs.NORENDER)return;if(t._getBit(kt.DISABLE_INNER_CLIPPING)&&!e._drawingToTexture)return void r._fun(t,e,i,s);let a=t._style.scrollRect,n=a.width,l=a.height;0===n&&(n=.001),0===l&&(l=.001),e.save(),e.clipRect(i,s,n,l),r._fun(t,e,i-a.x,s-a.y),e.restore()}_texture(t,e,i,s){if(!t._getBit(kt.HIDE_BY_EDITOR)){var r=t.texture;if(r._getSource()){var a=t._isWidthSet?t._width:r.sourceWidth,n=t._isHeightSet?t._height:r.sourceHeight,l=a/r.sourceWidth,o=n/r.sourceHeight;if(a=r.width*l,n=r.height*o,a>0&&n>0){let h=i-t.pivotX+r.offsetX*l,u=s-t.pivotY+r.offsetY*o;e._material=t.graphics.material,e.drawTexture(r,h,u,a,n,4294967295),e._material=null}}}this._next!=bs.NORENDER&&this._next._fun(t,e,i,s)}_graphics(t,e,i,s){if(!t._getBit(kt.HIDE_BY_EDITOR)){let r=t._style,a=t._graphics;a&&a._render(t,e,i-r.pivotX,s-r.pivotY)}this._next!=bs.NORENDER&&this._next._fun(t,e,i,s)}_hitarea(t,e,i,s){if(!e._drawingToTexture&&t.hitArea){var r=t._style,a=t.hitArea._hit,n=e.globalAlpha;e.globalAlpha*=.5,a&&a._render(t,e,i-r.pivotX,s-r.pivotY),(a=t.hitArea._unHit)&&a._render(t,e,i-r.pivotX,s-r.pivotY),e.globalAlpha=n}this._next!=bs.NORENDER&&this._next._fun(t,e,i,s)}_alpha(t,e,i,s){var r=t._style.alpha;if(r>.01||t._needRepaint()){var a=e.globalAlpha;e.globalAlpha*=r,this._next!=bs.NORENDER&&this._next._fun(t,e,i,s),e.globalAlpha=a}}_transform(t,e,i,s){var r=t.transform,a=this._next;r&&a!=bs.NORENDER?(e.save(),e.transform(r.a,r.b,r.c,r.d,r.tx+i,r.ty+s),a._fun(t,e,0,0),e.restore()):a!=bs.NORENDER&&a._fun(t,e,i,s)}_children(t,e,i,s){let r=t._style,a=t._children,n=a.length;i-=t.pivotX,s-=t.pivotY;let l,o,h,u,d,c,_,p=t._getBit(kt.DRAWCALL_OPTIMIZE)&&e.drawCallOptimize(!0),f=e._drawingToTexture;r.viewport&&(l=r.viewport,o=l.x,h=l.y,u=l.right,d=l.bottom);for(let r=0;r<n;++r){let n,p=a[r];n=f?p._visible&&!p._getBit(kt.ESCAPE_DRAWING_TO_TEXTURE):p._visible||p._getBit(kt.DISABLE_VISIBILITY),n&&(l&&((c=p._x)>=u||c+p.width<=o||(_=p._y)>=d||_+p.height<=h)?n=!1:t._cacheStyle.mask!=p||p._getBit(kt.DISABLE_VISIBILITY)||(n=!1)),n&&(p._getBit(kt.DISABLE_OUTER_CLIPPING)&&e.clipRect(0,0,1,1,!0),p.render(e,i,s))}p&&e.drawCallOptimize(!1)}_renderNextToCacheRT(i,s,r=0,a=0,n=0,l=0){var o=i._getCacheStyle();if(i._needRepaint()||!o.renderTexture||e.stage.isGlobalRepaint()){o.renderTexture&&o.renderTexture.destroy();let e=i._cacheStyle._calculateCacheRect(i,"bitmap",0,0),h=o.cacheRect;if(h.width<=0||h.height<=0)return o.renderTexture=null,!1;ae.canvasBitmap++;let u=h.width*e.x+r+n,d=h.height*e.y+a+l,c=new pt(u,d,t.RenderTargetFormat.R8G8B8A8),_=new os;return _.copyState(s),_.size(u,d),_.clearBG(0,0,0,0),_.render2D=new he(c),_.startRender(),h.x-=r,h.y-=a,this._next._fun(i,_,-h.x,-h.y),_.endRender(),_.render2D.setRenderTarget(s.render2D.out),_.destroy(),o.renderTexture=c,!0}return!1}_canvas(t,e,i,s){var r=t._cacheStyle,a=this._next;if(!e._drawingToTexture&&r.mask&&r.mask._getBit(kt.DISABLE_VISIBILITY))return void a._fun(t,e,i,s);if("bitmap"===t.cacheAs){e.drawLeftData(),this._renderNextToCacheRT(t,e);var n=r.cacheRect;e._material=t.graphics.material;let a=r.renderTexture;a&&e._drawRenderTexture(a,i+n.x,s+n.y,a.width,a.height,null,1,[0,1,1,1,1,0,0,0]),e._material=null}else{if(!bs.cacheNormalEnable)return void a._fun(t,e,i,s);e.drawLeftData(),xs.renderCacheAsNormal(e,t,this._next,i,s)}}static RenderToRenderTexture(e,i,s,r,a=null,n=!0){let l=e._getCacheStyle()._calculateCacheRect(e,"bitmap",0,0),o=e._cacheStyle.cacheRect,h=new os;h._drawingToTexture=!0,i&&h.copyState(i);let u=a;if(u)h.size(u.width,u.height),h.clearBG(pt._clearColor.r,pt._clearColor.g,pt._clearColor.b,pt._clearColor.a);else{let e=o.width*l.x+(n?0:o.x),i=o.height*l.y+(n?0:o.y);u=new pt(e,i,t.RenderTargetFormat.R8G8B8A8),h.size(e,i),h.clearBG(0,0,0,0)}return h.render2D=h.render2D.clone(u),h.startRender(),n?e.render(h,s-e.x-o.x,r-e.y-o.y):e.render(h,s-e.x,r-e.y),h.endRender(),h._drawingToTexture=!1,i&&h.render2D.setRenderTarget(i.render2D.out),h.destroy(),u}static RenderToCacheTexture(t,i,s,r,a=!0){var n=t._getCacheStyle();return!(!t._needRepaint()&&n.renderTexture&&!e.stage.isGlobalRepaint())&&(n.renderTexture&&n.renderTexture.destroy(),n.renderTexture=bs.RenderToRenderTexture(t,i,s,r,null,a),!0)}_blend(t,e,i,s){var r=t._style;e.save(),e.globalCompositeOperation=r.blendMode,this._next._fun(t,e,i,s),e.restore()}_mask(i,s,r,a){let n=i._getCacheStyle();if(i._needRepaint()||!n.renderTexture||n.renderTexture.destroyed||e.stage.isGlobalRepaint()){n.renderTexture&&n.renderTexture.destroy(),i._cacheStyle._calculateCacheRect(i,"bitmap",0,0);let e=this._spriteRect_TextureSpace.copyFrom(n.cacheRect);if(e.width<=0||e.height<=0)return;e.x+=i.pivotX,e.y+=i.pivotY;let r=i.mask,a=r._getCacheStyle();a._calculateCacheRect(r,"bitmap",0,0);let l=this._maskRect_TextureSpace.copyFrom(a.cacheRect);l.x+=r._x,l.y+=r._y;let o=Math.max(e.x,l.x),h=Math.max(e.y,l.y),u=Math.min(e.x+e.width,l.x+l.width)-o,d=Math.min(e.y+e.height,l.y+l.height)-h;if(u<=0||d<=0)return;bs.RenderToCacheTexture(r,s,0,0);let c=new pt(u,d,t.RenderTargetFormat.R8G8B8A8),_=new os;_.clearBG(0,0,0,0),_.size(u,d),_.render2D=new he(c),_.startRender(),this._next._fun(i,_,i.pivotX-o,i.pivotY-h);let p=a.renderTexture;_.globalCompositeOperation="mask",_._drawRenderTexture(p,l.x-o,l.y-h,l.width,l.height,null,1,[0,1,1,1,1,0,0,0]),_.endRender(),_.render2D.setRenderTarget(s.render2D.out),_.destroy(),n.renderTexture=c,n.cacheRect.x=o-i.pivotX,n.cacheRect.y=h-i.pivotY,n.cacheRect.width=c.width,n.cacheRect.height=c.height}let l=n.renderTexture,o=n.cacheRect;s._drawRenderTexture(l,r+o.x,a+o.y,l.width,l.height,null,1,[0,1,1,1,1,0,0,0])}}bs.cacheNormalEnable=!0,bs.renders=[],bs.NORENDER=new bs(0,null);class Cs extends b{get source(){return this._source}get width(){return this._width}set width(t){this._width=t}get height(){return this._height}set height(t){this._height=t}_getSource(){return this._source}constructor(t=!1){super(),this._source=t?A.createElement("canvas"):this,this.lock=!0}clear(){this._ctx&&(this._ctx.clear?this._ctx.clear():this._ctx.clearRect(0,0,this._width,this._height)),this._texture&&(this._texture.destroy(),this._texture=null)}destroy(){super.destroy(),this._setCPUMemory(0),this._ctx&&this._ctx.destroy&&this._ctx.destroy(),this._ctx=null}release(){}get context(){return this._ctx||(this._source==this?this._ctx=new os:this._ctx=this._source.getContext(n.isConch?"layagl":"2d"),this._ctx._canvas=this),this._ctx}_setContext(t){this._ctx=t}getContext(t,e=null){return this.context}getMemSize(){return 0}size(t,e){(this._width!=t||this._height!=e||this._source&&(this._source.width!=t||this._source.height!=e))&&(this._width=t,this._height=e,this._setCPUMemory(t*e*4),this._ctx&&this._ctx.size&&this._ctx.size(t,e),this._source&&(this._source.height=e,this._source.width=t),this._texture&&(this._texture.destroy(),this._texture=null))}getTexture(){if(!this._texture){var e=new ct(this.source.width,this.source.height,t.TextureFormat.R8G8B8A8,!0,!1,!1);e.setImageData(this.source,!1,!1),this._texture=new mt(e)}return this._texture}toBase64(t,e){return this._source?this._source.toDataURL(t,e):null}}class Rs{reset(){return this.bounds&&this.bounds.recover(),this.userBounds&&this.userBounds.recover(),this.bounds=null,this.userBounds=null,this.temBM=null,this}recover(){i.recover("BoundsStyle",this.reset())}static create(){return i.getItemByClass("BoundsStyle",Rs)}}class As{constructor(){this.renderTexOffx=0,this.renderTexOffy=0,this.cacheInfo=new fs,this.reset()}onInvisible(){}set renderTexture(t){this._renderTexture&&t!=this._renderTexture&&this._renderTexture.destroy(),this._renderTexture=t}get renderTexture(){return this._renderTexture}recover(){this!==As.EMPTY&&i.recover("SpriteCache",this.reset())}reset(){return this.userSetCache="none",this.staticCache=!1,this.mask=null,this.maskParent=null,this.cacheRect&&this.cacheRect.recover(),this.cacheRect=null,this.cacheInfo.reset(),this}static create(){return i.getItemByClass("SpriteCache",As)}_calculateCacheRect(t,e,i,s){var r,a=t._getCacheStyle();if(a.cacheRect||(a.cacheRect=F.create()),"bitmap"===e?((r=t.getSelfBounds()).width=r.width,r.height=r.height,r.x=r.x-t.pivotX,r.y=r.y-t.pivotY,r.x=Math.floor(r.x+i)-i,r.y=Math.floor(r.y+s)-s,r.width=Math.floor(r.width),r.height=Math.floor(r.height),a.cacheRect.copyFrom(r)):a.cacheRect.setTo(-t._style.pivotX,-t._style.pivotY,1,1),r=a.cacheRect,t._style.scrollRect){var n=t._style.scrollRect;r.x-=n.x,r.y-=n.y}return As._scaleInfo.setTo(1,1),As._scaleInfo}}As.EMPTY=new As,As._scaleInfo=new s,As.CANVAS_EXTEND_EDGE=16;class Is{constructor(){this.reset()}reset(){return this.scaleX=this.scaleY=1,this.skewX=this.skewY=0,this.pivotX=this.pivotY=this.rotation=0,this.alpha=1,this.scrollRect&&this.scrollRect.recover(),this.scrollRect=null,this.viewport&&this.viewport.recover(),this.viewport=null,this.hitArea=null,this.dragging=null,this.blendMode=null,this}recover(){this!==Is.EMPTY&&i.recover("SpriteStyle",this.reset())}static create(){return i.getItemByClass("SpriteStyle",Is)}}Is.EMPTY=new Is;class Ms{static create(t){var e=i.getItemByClass("AlphaCmd",Ms);return e.alpha=t,e}recover(){i.recover("AlphaCmd",this)}run(t,e,i){t.alpha(this.alpha)}get cmdID(){return Ms.ID}}Ms.ID="Alpha";class Bs{constructor(){this.lineWidth=0}static create(t,e,s,r,a,n){var l=i.getItemByClass("DrawCircleCmd",Bs);return l.x=t,l.y=e,l.radius=s,l.fillColor=r,l.lineColor=a,l.lineWidth=n,l}recover(){this.fillColor=null,this.lineColor=null,i.recover("DrawCircleCmd",this)}run(t,e,i){let s=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0;if(this.percent&&t.sprite){let r=t.sprite.width,a=t.sprite.height;t._drawCircle(this.x*r+e,this.y*a+i,this.radius*Math.min(r,a)-s,this.fillColor,this.lineColor,this.lineWidth,0)}else t._drawCircle(this.x+e,this.y+i,this.radius-s,this.fillColor,this.lineColor,this.lineWidth,0)}get cmdID(){return Bs.ID}getBoundPoints(t){return F._getBoundPointS(this.x-this.radius,this.y-this.radius,this.radius+this.radius,this.radius+this.radius,this.percent?t:null)}}Bs.ID="DrawCircle",Ot.regClass("DrawCircleCmd",Bs);class Ls{static create(t,e,s,r,a){var n=i.getItemByClass("DrawCurvesCmd",Ls);return n.x=t,n.y=e,n.points=s,n.lineColor=r,n.lineWidth=a,n}recover(){this.points=null,this.lineColor=null,i.recover("DrawCurvesCmd",this)}run(t,e,i){this.points&&t.drawCurves(this.x+e,this.y+i,this.points,this.lineColor,this.lineWidth)}get cmdID(){return Ls.ID}getBoundPoints(){return _i.I.getBezierPoints(this.points)}}Ls.ID="DrawCurves",Ot.regClass("DrawCurvesCmd",Ls);class Ps{constructor(){this.color=4294967295}static create(t,e,s,r,a,n){null==r&&(r=t.sourceWidth),null==a&&(a=t.sourceHeight);let l=r/t.sourceWidth,o=a/t.sourceHeight;r=t.width*l,a=t.height*o,e+=t.offsetX*l,s+=t.offsetY*o;var h=i.getItemByClass("DrawImageCmd",Ps);return h.texture=t,t._addReference(),h.x=e,h.y=s,h.width=r,h.height=a,h.color=null!=n?mi.create(n).numColor:4294967295,h}recover(){this.texture&&this.texture._removeReference(),this.texture=null,i.recover("DrawImageCmd",this)}run(t,e,i){this.texture&&t.drawTexture(this.texture,this.x+e,this.y+i,this.width,this.height,this.color)}get cmdID(){return Ps.ID}}Ps.ID="DrawImage";class Ns{constructor(){this.lineWidth=0}static create(t,e,s,r,a,n){var l=i.getItemByClass("DrawLineCmd",Ns);return l.fromX=t,l.fromY=e,l.toX=s,l.toY=r,l.lineColor=a,l.lineWidth=n,l}recover(){i.recover("DrawLineCmd",this)}run(t,e,i){let s=this.lineWidth<1||this.lineWidth%2==0?0:.5;if(this.percent&&t.sprite){let r=t.sprite.width,a=t.sprite.height;t._drawLine(e,i,this.fromX*r+s,this.fromY*a+s,this.toX*r+s,this.toY*a+s,this.lineColor,this.lineWidth,0)}else t._drawLine(e,i,this.fromX+s,this.fromY+s,this.toX+s,this.toY+s,this.lineColor,this.lineWidth,0)}get cmdID(){return Ns.ID}getBoundPoints(t){let e;Os.length=0,e=.5*this.lineWidth;let i=this.fromX,s=this.fromY,r=this.toX,a=this.toY;return this.percent&&(i*=t.width,s*=t.height,r*=t.width,a*=t.height),i==r?Os.push(i+e,s,r+e,a,i-e,s,r-e,a):s==a?Os.push(i,s+e,r,a+e,i,s-e,r,a-e):Os.push(i,s,r,a),Os}}Ns.ID="DrawLine";const Os=[];Ot.regClass("DrawLineCmd",Ns);class Fs{constructor(){this.lineWidth=0}static create(t,e,s,r,a){var n=i.getItemByClass("DrawLinesCmd",Fs);return n.x=t,n.y=e,n.points=s,n.lineColor=r,n.lineWidth=a,n}recover(){this.points=null,this.lineColor=null,i.recover("DrawLinesCmd",this)}run(t,e,i){let s=this.lineWidth<1||this.lineWidth%2==0?0:.5;this.points&&t._drawLines(this.x+s+e,this.y+s+i,this.points,this.lineColor,this.lineWidth,0)}get cmdID(){return Fs.ID}}Fs.ID="DrawLines",Ot.regClass("DrawLinesCmd",Fs);class Us{static create(t,e,s,r,a){var n=i.getItemByClass("DrawPathCmd",Us);return n.x=t,n.y=e,n.paths=s,n.brush=r,n.pen=a,n}recover(){this.paths=null,this.brush=null,this.pen=null,i.recover("DrawPathCmd",this)}run(t,e,i){this.paths&&t._drawPath(this.x+e,this.y+i,this.paths,this.brush,this.pen)}get cmdID(){return Us.ID}getBoundPoints(){let t=ks;t.length=0;let e=this.paths,i=e.length;for(let s=0;s<i;s++){let i=e[s];i.length>1&&(t.push(i[1],i[2]),i.length>3&&t.push(i[3],i[4]))}return t}}Us.ID="DrawPath";const ks=[];Ot.regClass("DrawPathCmd",Us);class Gs{constructor(){this.radius=0,this.lineWidth=0}static create(t,e,s,r,a,n,l,o){var h=i.getItemByClass("DrawPieCmd",Gs);return h.x=t,h.y=e,h.radius=s,h._startAngle=r,h._endAngle=a,h.fillColor=n,h.lineColor=l,h.lineWidth=o,h}recover(){this.fillColor=null,this.lineColor=null,i.recover("DrawPieCmd",this)}run(t,e,i){let s=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,r=this.lineColor?this.lineWidth:0;t._drawPie(this.x+s+e,this.y+s+i,this.radius-r,this._startAngle,this._endAngle,this.fillColor,this.lineColor,this.lineWidth,0)}get cmdID(){return Gs.ID}get startAngle(){return 180*this._startAngle/Math.PI}set startAngle(t){this._startAngle=t*Math.PI/180}get endAngle(){return 180*this._endAngle/Math.PI}set endAngle(t){this._endAngle=t*Math.PI/180}getBoundPoints(){let t=Vs;Vs.length=0;let e=Math.PI/180,i=this.endAngle-this.startAngle,s=this.x,r=this.y,a=this.radius;if(i>=360||i<=-360)return t.push(s-a,r-a),t.push(s+a,r-a),t.push(s+a,r+a),t.push(s-a,r+a),t;t.push(s,r);var n=i%360;n<0&&(n+=360);var l=this.startAngle+n,o=this.startAngle*e,h=l*e;t.push(s+a*Math.cos(o),r+a*Math.sin(o)),t.push(s+a*Math.cos(h),r+a*Math.sin(h));for(var u=90*Math.ceil(this.startAngle/90),d=90*Math.floor(l/90),c=u;c<=d;c+=90){var _=c*e;t.push(s+a*Math.cos(_),r+a*Math.sin(_))}return t}}Gs.ID="DrawPie";const Vs=[];Ot.regClass("DrawPieCmd",Gs);class Hs{static create(t,e,s,r,a,n){var l=i.getItemByClass("DrawPolyCmd",Hs);return l.x=t,l.y=e,l.points=s,l.fillColor=r,l.lineColor=a,l.lineWidth=n,l}recover(){this.points=null,this.fillColor=null,this.lineColor=null,i.recover("DrawPolyCmd",this)}run(t,e,i){let s=this.points.length<=6,r=this.lineWidth>=1&&this.lineColor?this.lineWidth%2==0?0:.5:0;this.points&&t._drawPoly(this.x+r+e,this.y+r+i,this.points,this.fillColor,this.lineColor,this.lineWidth,s,0)}get cmdID(){return Hs.ID}}Hs.ID="DrawPoly",Ot.regClass("DrawPolyCmd",Hs);class zs{constructor(){this.lineWidth=0}static create(t,e,s,r,a,n,l,o){var h=i.getItemByClass("DrawRectCmd",zs);return h.x=t,h.y=e,h.width=s,h.height=r,h.fillColor=a,h.lineColor=n,h.lineWidth=l,h.percent=o,h}recover(){this.fillColor=null,this.lineColor=null,i.recover("DrawRectCmd",this)}run(t,e,i){let s=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,r=this.lineColor?this.lineWidth:0;if(this.percent&&t.sprite){let a=t.sprite.width,n=t.sprite.height;t.drawRect(this.x*a+s+e,this.y*n+s+i,this.width*a-r,this.height*n-r,this.fillColor,this.lineColor,this.lineWidth)}else t.drawRect(this.x+s+e,this.y+s+i,this.width-r,this.height-r,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return zs.ID}getBoundPoints(t){return F._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?t:null)}}zs.ID="DrawRect",Ot.regClass("DrawRectCmd",zs);class Ws{constructor(){this.color=4294967295,this.uv=null}static create(t,e,s,r,a,n,l,o,h,u){null==r&&(r=t.sourceWidth),null==a&&(a=t.sourceHeight);let d=r/t.sourceWidth,c=a/t.sourceHeight;r=t.width*d,a=t.height*c,e+=t.offsetX*d,s+=t.offsetY*c;var _=i.getItemByClass("DrawTextureCmd",Ws);return _.texture=t,t._addReference(),_.x=e,_.y=s,_.width=r,_.height=a,_.matrix=n,_.alpha=l,_.blendMode=h,_.uv=u||null,_.color=null!=o?mi.create(o).numColor:4294967295,_}recover(){this.texture&&this.texture._removeReference(),this.texture=null,this.matrix=null,i.recover("DrawTextureCmd",this)}run(t,e,i){this.texture&&t.drawTextureWithTransform(this.texture,this.x,this.y,this.width,this.height,this.matrix,e,i,this.alpha,this.blendMode,this.uv,this.color)}get cmdID(){return Ws.ID}}Ws.ID="DrawTexture",Ot.regClass("DrawTextureCmd",Ws);class Ys{constructor(){this.color=4294967295}static create(t,e,s,r,a,n,l,o){var h=i.getItemByClass("FillTextureCmd",Ys);return h.texture=t,t._addReference(),h.x=e,h.y=s,h.width=r,h.height=a,h.type=n,h.offset=l,h.color=null!=o?mi.create(o).numColor:4294967295,h}recover(){this.texture&&this.texture._removeReference(),this.texture=null,this.offset=null,i.recover("FillTextureCmd",this)}run(t,e,i){if(this.texture)if(this.percent&&t.sprite){let r=t.sprite.width,a=t.sprite.height;t.fillTexture(this.texture,this.x*r+e,this.y*a+i,this.width*r,this.height*a,this.type,this.offset||s.EMPTY,this.color)}else t.fillTexture(this.texture,this.x+e,this.y+i,this.width,this.height,this.type,this.offset||s.EMPTY,this.color)}get cmdID(){return Ys.ID}getBoundPoints(t){return this.width&&this.height?F._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?t:null):F._getBoundPointS(this.x,this.y,this.texture.width,this.texture.height)}}Ys.ID="FillTexture",Ot.regClass("FillTextureCmd",Ys);class Xs{static create(){return i.getItemByClass("RestoreCmd",Xs)}recover(){i.recover("RestoreCmd",this)}run(t){t.restore()}get cmdID(){return Xs.ID}}Xs.ID="Restore";class js{static create(t,e,s){var r=i.getItemByClass("RotateCmd",js);return r.angle=t,r.pivotX=e,r.pivotY=s,r}recover(){i.recover("RotateCmd",this)}run(t,e,i){t._rotate(this.angle,this.pivotX+e,this.pivotY+i)}get cmdID(){return js.ID}}js.ID="Rotate";class qs{static create(t,e,s,r){var a=i.getItemByClass("ScaleCmd",qs);return a.scaleX=t,a.scaleY=e,a.pivotX=s,a.pivotY=r,a}recover(){i.recover("ScaleCmd",this)}run(t,e,i){t._scale(this.scaleX,this.scaleY,this.pivotX+e,this.pivotY+i)}get cmdID(){return qs.ID}}qs.ID="Scale";class $s{static create(t,e,s){var r=i.getItemByClass("TransformCmd",$s);return r.matrix=t,r.pivotX=e,r.pivotY=s,r}recover(){this.matrix=null,i.recover("TransformCmd",this)}run(t,e,i){t._transform(this.matrix,this.pivotX+e,this.pivotY+i)}get cmdID(){return $s.ID}}$s.ID="Transform";class Ks{static create(t,e){var s=i.getItemByClass("TranslateCmd",Ks);return s.tx=t,s.ty=e,s}recover(){i.recover("TranslateCmd",this)}run(t){t.translate(this.tx,this.ty)}get cmdID(){return Ks.ID}}Ks.ID="Translate";class Qs{static create(t,e,s,r,a,n,l,o,h,u){var d=i.getItemByClass("DrawTrianglesCmd",Qs);return d.texture=t,d.x=e,d.y=s,d.vertices=r,d.uvs=a,d.indices=n,d.matrix=l,d.alpha=o,d.color=null!=h?mi.create(h).numColor:4294967295,d.blendMode=u,d}recover(){this.texture=null,this.vertices=null,this.uvs=null,this.indices=null,this.matrix=null,i.recover("DrawTrianglesCmd",this)}run(t,e,i){t.drawTriangles(this.texture,this.x+e,this.y+i,this.vertices,this.uvs,this.indices,this.matrix,this.alpha,this.blendMode,this.color)}get cmdID(){return Qs.ID}getBoundPoints(){let t=this.vertices;var e=t.length;if(e<2)return[];for(var i=t[0],s=t[1],r=i,a=s,n=2;n<e;){var l=t[n++],o=t[n++];i>l&&(i=l),s>o&&(s=o),r<l&&(r=l),a<o&&(a=o)}return[i,s,r,s,r,a,i,a]}}Qs.ID="DrawTriangles",Ot.regClass("DrawTrianglesCmd",Qs);class Zs{constructor(){this.color=4294967295}static create(t,e,s,r,a,n,l=!1,o=null){let h=i.getItemByClass("Draw9GridTextureCmd",Zs);return h.texture=t,t._addReference(),h.x=e,h.y=s,h.width=r,h.height=a,h.sizeGrid=n,h.percent=l,h.color=null!=o?mi.create(o).numColor:4294967295,h}recover(){this.texture._removeReference(),i.recover("Draw9GridTextureCmd",this)}run(t,e,i){if(this.texture){let s=this.sizeGrid||this.texture._sizeGrid||Js;if(this.percent&&t.sprite){let r=t.sprite.width,a=t.sprite.height;t.drawTextureWithSizeGrid(this.texture,this.x*r,this.y*a,this.width*r,this.height*a,s,e,i,this.color)}else t.drawTextureWithSizeGrid(this.texture,this.x,this.y,this.width,this.height,s,e,i,this.color)}}get cmdID(){return Zs.ID}getBoundPoints(t){let e=this.x,i=this.y,s=this.width,r=this.height;return this.percent&&(e*=t.width,i*=t.height,s*=t.width,r*=t.height),[e,i,s,i,s,r,e,r]}}Zs.ID="Draw9GridTexture";const Js=[0,0,0,0,0];Ot.regClass("Draw9GridTextureCmd",Zs);class tr{static create(){return i.getItemByClass("SaveCmd",tr)}recover(){i.recover("SaveCmd",this)}run(t){t.save()}get cmdID(){return tr.ID}}tr.ID="Save";class er{constructor(){this.lineWidth=0}static create(t,e,s,r,a,n,l,o){var h=i.getItemByClass("DrawEllipseCmd",er);return h.x=t,h.y=e,h.width=s,h.height=r,h.fillColor=a,h.lineColor=n,h.lineWidth=l,h.percent=o,h}recover(){this.fillColor=null,this.lineColor=null,i.recover("DrawEllipseCmd",this)}run(t,e,i){let s=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0;if(this.percent&&t.sprite){let r=t.sprite.width,a=t.sprite.height;t._drawEllipse(this.x*r+e,this.y*a+i,this.width*r-s,this.height*a-s,this.fillColor,this.lineColor,this.lineWidth)}else t._drawEllipse(this.x+e,this.y+i,this.width-s,this.height-s,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return er.ID}getBoundPoints(t){return F._getBoundPointS(this.x-this.width,this.y-this.height,2*this.width,2*this.height,this.percent?t:null)}}er.ID="DrawEllipse",Ot.regClass("DrawEllipseCmd",er);class ir{constructor(){this.lineWidth=0}static create(t,e,s,r,a,n,l,o,h,u,d,c){var _=i.getItemByClass("DrawRoundRectCmd",ir);return _.x=t,_.y=e,_.width=s,_.height=r,_.lt=a,_.rt=n,_.lb=l,_.rb=o,_.fillColor=h,_.lineColor=u,_.lineWidth=d,_.percent=c,_}recover(){this.fillColor=null,this.lineColor=null,i.recover("DrawRoundRectCmd",this)}run(t,e,i){let s=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,r=this.lineColor?this.lineWidth:0;if(this.percent&&t.sprite){let a=t.sprite.width,n=t.sprite.height;t._drawRoundRect(this.x*a+s+e,this.y*n+s+i,this.width*a-r,this.height*n-r,this.lt,this.rt,this.lb,this.rb,this.fillColor,this.lineColor,this.lineWidth)}else t._drawRoundRect(this.x+s+e,this.y+s+i,this.width-r,this.height-r,this.lt,this.rt,this.lb,this.rb,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return ir.ID}getBoundPoints(t){return F._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?t:null)}}ir.ID="DrawRoundRect",Ot.regClass("DrawRoundRectCmd",ir);class sr{constructor(){this.x=0,this.y=0,this._strokeColor="#000000",this._loosyBound=null}get text(){return this._text}set text(t){this._text=t}get strokeColor(){return this._strokeColor}set strokeColor(t){this._strokeColor=t}get stroke(){return this._stroke}set stroke(t){this._stroke=t}get align(){return this._align}set align(t){this._align=t}static create(t,e,s,r,a,n,l,o){var h=i.getItemByClass("FillTextCmd",sr);switch(h._text=null,h._wordText=null,h.x=e,h.y=s,h.font=r,h.color=a,h._stroke=l,h._strokeColor=o,n){case"center":h._align=Ut.ENUM_TEXTALIGN_CENTER;break;case"right":h._align=Ut.ENUM_TEXTALIGN_RIGHT;break;default:h._align=Ut.ENUM_TEXTALIGN_DEFAULT}return t instanceof Zi?(h._wordText=t,t.cleanCache()):h._text=t,h}recover(){i.recover("FillTextCmd",this)}run(t,i,s){e.stage.isGlobalRepaint()&&this._wordText&&this._wordText.cleanCache(),null==this._text&&(this._text=""),null==this._fontObj&&(this.font=null),null==this._color&&(this._color="#ffffff"),t._fast_filltext(this._wordText||this._text,this.x+i,this.y+s,this._fontObj,this._color,this._strokeColor,this._stroke,this._align)}get cmdID(){return sr.ID}get font(){return this._font}set font(t){this._font=t,t||(t=f.defaultFontSize+"px "+f.defaultFont),this._fontObj=$i.parse(t),this._wordText&&this._wordText.cleanCache()}get color(){return this._color}set color(t){this._color=t,this._wordText&&this._wordText.cleanCache()}getBoundPoints(){if(!this._loosyBound){let t=e.Browser.context;t.save(),t.font=this.font;let i=t.measureText(this.text).width;t.restore();let s=this.x,r=this.y;switch(this._align){case Ut.ENUM_TEXTALIGN_CENTER:s-=i/2;break;case Ut.ENUM_TEXTALIGN_RIGHT:s-=i}this._fontObj||(this.font=null),s-=4,r-=this._fontObj._size,this._loosyBound=new F(s,r,i+8,2*this._fontObj._size)}return F._getBoundPointS(this._loosyBound.x,this._loosyBound.y,this._loosyBound.width,this._loosyBound.height,null)}}sr.ID="FillText",Ot.regClass("FillTextCmd",sr);const rr=new G,ar=new G,nr=[];class lr{constructor(){this._cacheBoundsType=!1}destroy(){this._graphics=null,this._cacheBoundsType=!1,this._temp&&(this._temp.length=0),this._rstBoundPoints&&(this._rstBoundPoints.length=0),this._bounds&&this._bounds.recover(),this._bounds=null,i.recover("GraphicsBounds",this)}static create(){return i.getItemByClass("GraphicsBounds",lr)}reset(){this._temp&&(this._temp.length=0)}getBounds(t=!1){return(!this._bounds||!this._temp||this._temp.length<1||t!=this._cacheBoundsType)&&(this._bounds=F._getWrapRec(this.getBoundPoints(t),this._bounds)),this._cacheBoundsType=t,this._bounds}getBoundPoints(t=!1){return(!this._temp||this._temp.length<1||t!=this._cacheBoundsType)&&(this._temp=this._getCmdPoints(t)),this._cacheBoundsType=t,this._rstBoundPoints=P.copyArray(this._rstBoundPoints,this._temp)}_getCmdPoints(t=!1){let e=this._graphics.cmds,i=this._graphics._sp;this._affectBySize=!1;let s=this._temp||(this._temp=[]);if(s.length=0,0==e.length)return s;let r=nr;r.length=0;let a=ar;a.identity();let n=rr;for(let t=0,l=e.length;t<l;t++){let l=e[t];switch(l.percent&&(this._affectBySize=!0),l.cmdID){case Ms.ID:case tr.ID:r.push(a),a=a.clone();break;case Xs.ID:a=r.pop();break;case qs.ID:n.identity(),n.translate(-l.pivotX,-l.pivotY),n.scale(l.scaleX,l.scaleY),n.translate(l.pivotX,l.pivotY),this._switchMatrix(a,n);break;case js.ID:n.identity(),n.translate(-l.pivotX,-l.pivotY),n.rotate(l.angle),n.translate(l.pivotX,l.pivotY),this._switchMatrix(a,n);break;case Ks.ID:n.identity(),n.translate(l.tx,l.ty),this._switchMatrix(a,n);break;case $s.ID:n.identity(),n.translate(-l.pivotX,-l.pivotY),n.concat(l.matrix),n.translate(l.pivotX,l.pivotY),this._switchMatrix(a,n);break;case Ps.ID:case Ys.ID:or(s,F._getBoundPointS(l.x,l.y,l.width,l.height),a);break;case Ws.ID:a.copyTo(n),l.matrix&&n.concat(l.matrix),or(s,F._getBoundPointS(l.x,l.y,l.width,l.height),n);break;case zs.ID:case Bs.ID:case er.ID:case ir.ID:case Ns.ID:or(s,l.getBoundPoints(i),a);break;case Ls.ID:or(s,l.getBoundPoints(),a,l.x,l.y);break;case Fs.ID:case Hs.ID:or(s,l.points,a,l.x,l.y);break;case Us.ID:or(s,l.getBoundPoints(),a,l.x,l.y);break;case Gs.ID:case Qs.ID:or(s,l.getBoundPoints(),a);break;case Zs.ID:or(s,l.getBoundPoints(i),a);break;case sr.ID:or(s,l.getBoundPoints(),a);break;default:or(s,F._getBoundPointS(i.x,i.y,i.width,i.height,null),a)}}return s.length>200?s=P.copyArray(s,F._getWrapRec(s)._getBoundPoints()):s.length>8&&(s=se.scanPList(s)),s}_switchMatrix(t,e){e.concat(t),e.copyTo(t)}}function or(t,e,i,s=0,r=0){let a=e.length;for(let n=0;n<a;n+=2)hr(t,e[n]+s,e[n+1]+r,i)}function hr(t,e,i,r){var a=s.TEMP;a.setTo(e||0,i||0),r.transformPoint(a),t.push(a.x,a.y)}class ur{static create(t,e,s,r){var a=i.getItemByClass("ClipRectCmd",ur);return a.x=t,a.y=e,a.width=s,a.height=r,a}recover(){i.recover("ClipRectCmd",this)}run(t,e,i){t.clipRect(this.x+e,this.y+i,this.width,this.height)}get cmdID(){return ur.ID}}ur.ID="ClipRect";class dr{static create(t,e,s){var r=i.getItemByClass("DrawTexturesCmd",dr);return r.texture=t,t._addReference(),r.pos=e,r.colors=s||[],r}recover(){this.texture._removeReference(),this.texture=null,this.pos=null,i.recover("DrawTexturesCmd",this)}run(t,e,i){t.drawTextures(this.texture,this.pos,e,i,this.colors)}get cmdID(){return dr.ID}}dr.ID="DrawTextures";class cr{constructor(){}static regCacheByFunction(t,e){var i;cr.unRegCacheByFunction(t,e),i={tryDispose:t,getCacheList:e},cr._cacheList.push(i)}static unRegCacheByFunction(t,e){var i,s;for(s=cr._cacheList.length,i=0;i<s;i++)if(cr._cacheList[i].tryDispose==t&&cr._cacheList[i].getCacheList==e)return void cr._cacheList.splice(i,1)}static forceDispose(){var t,e=cr._cacheList.length;for(t=0;t<e;t++)cr._cacheList[t].tryDispose(!0)}static beginCheck(t=15e3){e.systemTimer.loop(t,null,cr._checkLoop)}static stopCheck(){e.systemTimer.clear(null,cr._checkLoop)}static _checkLoop(){var t=cr._cacheList;if(!(t.length<1)){var i,s,r=e.Browser.now();for(s=i=t.length;i>0&&(cr._index++,cr._index=cr._index%s,t[cr._index].tryDispose(!1),!(e.Browser.now()-r>cr.loopTimeLimit));)i--}}}cr.loopTimeLimit=2,cr._cacheList=[],cr._index=0;class _r{constructor(){this.useDic={},this.shapeDic={},this.shapeLineDic={},this._id=0,this._checkKey=!1,this._freeIdArray=[],cr.regCacheByFunction(this.startDispose.bind(this),this.getCacheList.bind(this))}static getInstance(){return _r.instance=_r.instance||new _r}getId(){return this._id++}addShape(t,e){this.shapeDic[t]=e,this.useDic[t]||(this.useDic[t]=!0)}addLine(t,e){this.shapeLineDic[t]=e,this.shapeLineDic[t]||(this.shapeLineDic[t]=!0)}getShape(t){this._checkKey&&null!=this.useDic[t]&&(this.useDic[t]=!0)}deleteShape(t){this.shapeDic[t]&&(this.shapeDic[t]=null,delete this.shapeDic[t]),this.shapeLineDic[t]&&(this.shapeLineDic[t]=null,delete this.shapeLineDic[t]),null!=this.useDic[t]&&delete this.useDic[t]}getCacheList(){var t,e=[];for(t in this.shapeDic)e.push(this.shapeDic[t]);for(t in this.shapeLineDic)e.push(this.shapeLineDic[t]);return e}startDispose(t){var e;for(e in this.useDic)this.useDic[e]=!1;this._checkKey=!0}endDispose(){if(this._checkKey){var t;for(t in this.useDic)this.useDic[t]||this.deleteShape(t);this._checkKey=!1}}}class pr{static create(t,e){var s=i.getItemByClass("DrawGeoCmd"+e.id,pr);return s.init(t,e),s}static creatGEO(e,i,s,r,a){let n=l.renderDeviceFactory.createRenderGeometryElement(t.MeshTopology.Triangles,t.DrawType.DrawElement),o=l.renderDeviceFactory.createBufferState();n.bufferState=o;let h=l.renderDeviceFactory.createVertexBuffer(t.BufferUsage.Dynamic);h.vertexDeclaration=e;let u=l.renderDeviceFactory.createIndexBuffer(t.BufferUsage.Dynamic);return o.applyState([h],u),n.indexFormat=t.IndexFormat.UInt16,h.setDataLength(s),h.setData(i.buffer,0,0,s),u._setIndexDataLength(a),u._setIndexData(new Uint16Array(r.buffer,0,a/2),0),n.clearRenderParams(),n.setDrawElemenParams(a/2,0),n}init(t,e){this.material=e,this.geo=t}recover(){i.recover("DrawGeoCmd"+this.material.id,this)}run(t,e,i){t.drawGeo(this.geo,this.material,e,i)}get cmdID(){return pr.ID}}pr.ID="DrawGeoCmd";class fr{static create(t,e){var s=i.getItemByClass("DrawGeosCmd",fr);return s.init(t,e),s}init(t,e){this.elements=e,this.geo=t}recover(){i.recover("DrawGeosCmd",this)}run(t,e,i){t.drawGeos(this.geo,this.elements,e,i)}get cmdID(){return fr.ID}}fr.ID="DrawGeoCmd";class gr{static add2DGlobalUniformData(t,e,i){l.renderDeviceFactory.createGlobalUniformMap("Sprite2DGlobal").addShaderUniform(t,e,i)}static get globalShaderData(){return Ai.globalShaderData}constructor(){this._sp=null,this._render=this._renderEmpty,this._cmds=[],this._vectorgraphArray=null,this._graphicBounds=null,this._createData()}_createData(){}_clearData(){}_destroyData(){}destroy(){this.clear(!0),this._graphicBounds&&this._graphicBounds.destroy(),this._graphicBounds=null,this._vectorgraphArray=null,this._sp&&(this._sp._renderType=0,this._sp=null),this._destroyData()}clear(t=!0){if(t)for(let t=0,e=this._cmds.length;t<e;t++)this._cmds[t].recover();if(this._cmds.length=0,this._render=this._renderEmpty,this._clearData(),this._sp&&(this._sp._renderType&=~re.GRAPHICS),this._repaint(),this._vectorgraphArray){for(let t=0,e=this._vectorgraphArray.length;t<e;t++)_r.getInstance().deleteShape(this._vectorgraphArray[t]);this._vectorgraphArray.length=0}}_clearBoundsCache(t){this._graphicBounds&&(t&&!this._graphicBounds._affectBySize||this._graphicBounds.reset())}_initGraphicBounds(){this._graphicBounds||(this._graphicBounds=lr.create(),this._graphicBounds._graphics=this)}_repaint(){this._clearBoundsCache(),this._sp&&this._sp.repaint()}_isOnlyOne(){return 1===this._cmds.length}get cmds(){return this._cmds}set cmds(t){this._sp&&(this._sp._renderType|=re.GRAPHICS),this._cmds=t;let e=t.length;this._render=0===e?this._renderEmpty:1===e?this._renderOne:this._renderAll,this._repaint()}addCmd(t){if(null!=t)return this._sp&&(this._sp._renderType|=re.GRAPHICS),this._cmds.push(t),this._render=1===this._cmds.length?this._renderOne:this._renderAll,this._repaint(),t;console.warn("null cmd")}removeCmd(t){let e=this.cmds.indexOf(t);if(-1!=e){this._cmds.splice(e,1);let t=this._cmds.length;this._render=0===t?this._renderEmpty:1===t?this._renderOne:this._renderAll,this._repaint()}}getBounds(t=!1){return this._initGraphicBounds(),this._graphicBounds.getBounds(t)}getBoundPoints(t=!1){return this._initGraphicBounds(),this._graphicBounds.getBoundPoints(t)}get material(){return this._material}set material(t){this._material!=t&&(this._material&&this._material._removeReference(),this._material=t,null!=t&&t._addReference())}drawImage(t,e=0,i=0,s=null,r=null,a=null){return t&&t.bitmap?this.addCmd(Ps.create(t,e,i,s,r,a)):null}drawTexture(t,e=0,i=0,s=null,r=null,a=null,n=1,l=null,o=null,h){return!t||n<.01?null:t.bitmap?this.addCmd(Ws.create(t,e,i,s,r,a,n,l,o,h)):null}drawTextures(t,e,i){return t?this.addCmd(dr.create(t,e,i)):null}drawGeo(t,e){return this.addCmd(pr.create(t,e))}drawGeos(t,e){return this.addCmd(fr.create(t,e))}drawTriangles(t,e,i,s,r,a,n=null,l=1,o=null,h=null){return this.addCmd(Qs.create(t,e,i,s,r,a,n,l,o,h))}fillTexture(t,e,i,r=0,a=0,n="repeat",l=null,o=null){return t&&t.bitmap?this.addCmd(Ys.create(t,e,i,r,a,n,l||s.EMPTY,o)):null}clipRect(t,e,i,s){return this.addCmd(ur.create(t,e,i,s))}fillText(t,e,i,s,r,a){return this.addCmd(sr.create(t,e,i,s,r,a,0,""))}fillBorderText(t,e,i,s,r,a,n,l){return this.addCmd(sr.create(t,e,i,s,r,a,n,l))}strokeText(t,e,i,s,r,a,n){return this.addCmd(sr.create(t,e,i,s,null,n,a,r))}alpha(t){return this.addCmd(Ms.create(t))}transform(t,e=0,i=0){return this.addCmd($s.create(t,e,i))}rotate(t,e=0,i=0){return this.addCmd(js.create(t,e,i))}scale(t,e,i=0,s=0){return this.addCmd(qs.create(t,e,i,s))}translate(t,e){return this.addCmd(Ks.create(t,e))}save(){return this.addCmd(tr.create())}restore(){return this.addCmd(Xs.create())}replaceTextColor(t){this._repaint();let e=this._cmds;for(let i=e.length-1;i>-1;i--){let s=e[i];switch(s.cmdID){case sr.ID:s.color=t;break;case Ps.ID:s.color=null!=t?mi.create(t).numColor:4294967295}}}loadImage(t,i=0,s=0,r=null,a=null,n=null){let l=e.loader.getRes(t);l?(this.drawImage(l,i,s,r,a),n&&n.call(this._sp)):e.loader.load(t).then((t=>{this.drawImage(t,i,s,r,a),n&&n.call(this._sp)}))}_renderEmpty(t,e,i,s){}_renderAll(t,e,i,s){e.sprite=t,e._material=this._material;var r=this._cmds;for(let t=0,a=r.length;t<a;t++)r[t].run(e,i,s);e._material=null}_renderOne(t,e,i,s){e.sprite=t,e._material=this._material,this._cmds[0].run(e,i,s),e._material=null}drawLine(t,e,i,s,r,a=1){return this.addCmd(Ns.create(t,e,i,s,r,a))}drawLines(t,e,i,s,r=1){return!i||i.length<4?null:this.addCmd(Fs.create(t,e,i,s,r))}drawCurves(t,e,i,s,r=1){return this.addCmd(Ls.create(t,e,i,s,r))}drawRect(t,e,i,s,r,a=null,n=1,l){return this.addCmd(zs.create(t,e,i,s,r,a,n,l))}drawRoundRect(t,e,i,s,r,a,n,l,o,h=null,u=1,d){return this.addCmd(ir.create(t,e,i,s,r,a,n,l,o,h,u,d))}drawCircle(t,e,i,s,r=null,a=1){return this.addCmd(Bs.create(t,e,i,s,r,a))}drawEllipse(t,e,i,s,r,a,n,l){return this.addCmd(er.create(t,e,i,s,r,a,n,l))}drawPie(t,e,i,s,r,a,n=null,l=1){return this.addCmd(Gs.create(t,e,i,P.toRadian(s),P.toRadian(r),a,n,l))}drawPoly(t,e,i,s,r=null,a=1){return this.addCmd(Hs.create(t,e,i,s,r,a))}drawPath(t,e,i,s=null,r=null){return this.addCmd(Us.create(t,e,i,s,r))}draw9Grid(t,e=0,i=0,s=0,r=0,a,n){this.addCmd(Zs.create(t,e,i,s,r,a,!1,n))}}const mr=[];class yr extends v{get url(){return this._url}set url(t){this._url=t}get hideFlags(){return this._hideFlags}set hideFlags(t){this._hideFlags=t}get is3D(){return this._is3D}get destroyed(){return this._destroyed}constructor(){super(),this._bits=0,this._hideFlags=0,this._children=mr,this._parent=null,this._destroyed=!1,this.name="",this._initialize()}_initialize(){this._extra={}}_setBit(t,e){t===kt.DISPLAY&&(this._getBit(t)!=e&&this._updateDisplayedInstage());e?this._bits|=t:this._bits&=~t}_getBit(t){return!!(this._bits&t)}_updateDisplayedInstage(){var t;t=this;for(var i=e.stage,s=!1;t;){if(t._getBit(kt.DISPLAY)){s=t._getBit(kt.DISPLAYED_INSTAGE);break}if(t===i||t._getBit(kt.DISPLAYED_INSTAGE)){s=!0;break}t=t._parent}this._setBit(kt.DISPLAYED_INSTAGE,s)}_setUpNoticeChain(){this._getBit(kt.DISPLAY)&&this._setBitUp(kt.DISPLAY)}_setBitUp(t){var e=this;for(e._setBit(t,!0),e=e._parent;e;){if(e._getBit(t))return;e._setBit(t,!0),e=e._parent}}onStartListeningToType(t){t!==r.DISPLAY&&t!==r.UNDISPLAY||this._getBit(kt.DISPLAY)||this._setBitUp(kt.DISPLAY)}bubbleEvent(t,e){let i=Tr.length>0?Tr.pop():[];i.length=0;let s=this;for(;s;)s.activeInHierarchy&&i.push(s),s=s.parent;if(e instanceof r){e._stopped=!1;for(let s of i)if(e.setTo(t,s,this),s.event(t,e),e._stopped)break}else for(let s of i)s.event(t,e);Tr.push(i)}hasHideFlag(t){return!!(this._hideFlags&t)}destroy(t=!0){this._destroyed=!0,this.destroyAllComponent(),this._parent&&this._parent.removeChild(this),this._children&&(t?this.destroyChildren():this.removeChildren()),this.onDestroy(),this._children=null,this.offAll()}onDestroy(){}destroyChildren(){if(this._children)for(let t=0,e=this._children.length;t<e;t++)this._children[0]&&this._children[0].destroy(!0)}addChild(t){if(!t||this._destroyed||t===this)return t;if(t._zOrder&&this._setBit(kt.HAS_ZORDER,!0),t._parent===this){var e=this.getChildIndex(t);e!==this._children.length-1&&(this._children.splice(e,1),this._children.push(t),this._childChanged())}else t._parent&&t._parent.removeChild(t),this._children===mr&&(this._children=[]),this._children.push(t),t._setParent(this);return t}addChildren(...t){for(var e=0,i=t.length;e<i;)this.addChild(t[e++])}addChildAt(t,e){if(!t||this._destroyed||t===this)return t;if(t._zOrder&&this._setBit(kt.HAS_ZORDER,!0),e>=0&&e<=this._children.length){if(t._parent===this){var i=this.getChildIndex(t);this._children.splice(i,1),this._children.splice(e,0,t),this._childChanged()}else t._parent&&t._parent.removeChild(t),this._children===mr&&(this._children=[]),this._children.splice(e,0,t),t._setParent(this);return t}throw new H(e)}getChildIndex(t){return this._children.indexOf(t)}getChildByName(t){for(let e of this._children)if(e&&e.name===t)return e;return null}getChildAt(t){return this._children[t]||null}setChildIndex(t,e){var i=this._children;if(e<0||e>=i.length)throw new H(e);var s=this.getChildIndex(t);if(s<0)throw new Error("node must be a child of this object.");return i.splice(s,1),i.splice(e,0,t),this._childChanged(),t}_childChanged(t=null){}removeChild(t){if(!this._children)return t;var e=this._children.indexOf(t);return this.removeChildAt(e)}removeSelf(){return this._parent&&this._parent.removeChild(this),this}removeChildByName(t){var e=this.getChildByName(t);return e&&this.removeChild(e),e}removeChildAt(t){var e=this.getChildAt(t);return e&&(this._children.splice(t,1),e._setParent(null)),e}removeChildren(t=0,e=2147483647){if(this._children&&this._children.length>0){var i=this._children;if(0===t&&e>=i.length-1){var s=i;this._children=mr}else s=i.splice(t,e-t+1);for(var r=0,a=s.length;r<a;r++)s[r]._setParent(null)}return this}replaceChild(t,e){var i=this._children.indexOf(e);return i>-1?(this._children.splice(i,1,t),e._setParent(null),t._setParent(this),t):null}get numChildren(){return this._children?this._children.length:0}get parent(){return this._parent}isAncestorOf(t){let e=t.parent;for(;e;){if(e==this)return!0;e=e.parent}return!1}_setParent(t){if(this._parent!==t)if(t)this._parent=t,this._onAdded(),this.event(r.ADDED),this._getBit(kt.DISPLAY)&&(this._setUpNoticeChain(),t.displayedInStage&&this._displayChild(this,!0)),t._childChanged(this);else{this._onRemoved(),this.event(r.REMOVED);let e=this._parent;this._getBit(kt.DISPLAY)&&this._displayChild(this,!1),this._parent=t,e._childChanged(this)}}get displayedInStage(){return this._getBit(kt.DISPLAY)||this._setBitUp(kt.DISPLAY),this._getBit(kt.DISPLAYED_INSTAGE)}_setDisplay(t){this._getBit(kt.DISPLAYED_INSTAGE)!==t&&(this._setBit(kt.DISPLAYED_INSTAGE,t),t?this.event(r.DISPLAY):this.event(r.UNDISPLAY))}_displayChild(t,e){var i=t._children;if(i)for(var s=0,r=i.length;s<r;s++){var a=i[s];a&&(a._getBit(kt.DISPLAY)&&(a._children.length>0?this._displayChild(a,e):a._setDisplay(e)))}t._setDisplay(e)}contains(t){if(t===this)return!0;for(;t;){if(t._parent===this)return!0;t=t._parent}return!1}timerLoop(t,e,i,s=null,r=!0,a=!1){this.timer.loop(t,e,i,s,r,a)}timerOnce(t,e,i,s=null,r=!0){this.timer._create(!1,!1,t,e,i,s,r)}frameLoop(t,e,i,s=null,r=!0){this.timer._create(!0,!0,t,e,i,s,r)}frameOnce(t,e,i,s=null,r=!0){this.timer._create(!0,!1,t,e,i,s,r)}clearTimer(t,e){this.timer.clear(t,e)}callLater(t,e=null){this.timer.callLater(this,t,e)}runCallLater(t){this.timer.runCallLater(this,t)}get scene(){return this._scene}get active(){return!this._getBit(kt.NOT_READY)&&!this._getBit(kt.NOT_ACTIVE)}set active(t){if(t=!!t,!this._getBit(kt.NOT_ACTIVE)!==t){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw new Error("recursive set active");this._setBit(kt.NOT_ACTIVE,!t),this._parent&&this._parent.activeInHierarchy&&this._processActive(t,!0)}}get activeInHierarchy(){return this._getBit(kt.ACTIVE_INHIERARCHY)}_onActive(){ae.spriteCount++}_onInActive(){ae.spriteCount--}_onActiveInScene(){this.event(yr.EVENT_SET_ACTIVESCENE,this._scene)}_onInActiveInScene(){this.event(yr.EVENT_SET_IN_ACTIVESCENE,this._scene)}onAwake(){}onEnable(){}onDisable(){}_parse(t,e){}_setBelongScene(t){if(!this._scene||this.scene!=t){this._scene=t,this._onActiveInScene();for(let e=0,i=this._children.length;e<i;e++)this._children[e]._setBelongScene(t)}}_setUnBelongScene(){if(this._scene!==this){this._onInActiveInScene(),this._scene=null;for(let t=0,e=this._children.length;t<e;t++)this._children[t]._setUnBelongScene()}}_processActive(t,e){this._activeChangeScripts||(this._activeChangeScripts=[]);let i=this._activeChangeScripts;t?this._activeHierarchy(i,e):this._inActiveHierarchy(i,e);for(let e=0,s=i.length;e<s;e++){let s=i[e];s.owner&&s._setActive(t)}i.length=0}_activeHierarchy(t,e){if(this._setBit(kt.ACTIVE_INHIERARCHY,!0),this._components)for(let e=0,i=this._components.length;e<i;e++){let i=this._components[e];i._isScript()?i._enabled&&t.push(i):i._setActive(!0)}this._onActive();for(let i=0,s=this._children.length;i<s;i++){let s=this._children[i];!s._getBit(kt.NOT_ACTIVE)&&!s._getBit(kt.NOT_READY)&&s._activeHierarchy(t,e)}this._getBit(kt.AWAKED)||(this._setBit(kt.AWAKED,!0),this.onAwake()),this.onEnable()}_inActiveHierarchy(t,e){if(this._onInActive(),this._components)for(let e=0,i=this._components.length;e<i;e++){let i=this._components[e];i._isScript()?i._enabled&&t.push(i):i._setActive(!1)}this._setBit(kt.ACTIVE_INHIERARCHY,!1);for(let i=0,s=this._children.length;i<s;i++){let s=this._children[i];s&&!s._getBit(kt.NOT_ACTIVE)&&s._inActiveHierarchy(t,e)}this.onDisable()}_onAdded(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw new Error("recursive set active");{let t=this._parent.scene;t&&this._setBelongScene(t),this._parent.activeInHierarchy&&this.active&&this._processActive(!0)}}_onRemoved(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw new Error("recursive set active");this._parent.activeInHierarchy&&this.active&&this._processActive(!1),this._parent.scene&&this._setUnBelongScene()}_addComponentInstance(t){var e;this._components||(this._components=[]),this._components.push(t),t._setOwner(this),this.activeInHierarchy&&t._setActive(!0),null===(e=this._componentsChanged)||void 0===e||e.call(this,t,0)}_destroyComponent(t){var e;if(!this._components)return;let i=this._components.indexOf(t);-1!=i&&(this._components.splice(i,1),t._destroy(),null===(e=this._componentsChanged)||void 0===e||e.call(this,t,1))}destroyAllComponent(){var t;if(this._components){for(let t=0,e=this._components.length;t<e;t++){let e=this._components[t];e&&!e.destroyed&&e._destroy()}this._components.length=0,null===(t=this._componentsChanged)||void 0===t||t.call(this,null,2)}}_cloneTo(t,e,i){if(this._components)for(let e=0,i=this._components.length;e<i;e++){var s=t.addComponent(this._components[e].constructor);this._components[e]._cloneTo(s)}}addComponentInstance(t){if(t.owner)throw new Error("the component is belong to other node.");return t._singleton&&this.getComponent(t.constructor)?console.warn("the component is singleton, can't add the second one.",t):this._addComponentInstance(t),t}addComponent(t){let e=i.createByClass(t);if(!e)throw new Error("missing "+t.toString());return e._singleton&&this.getComponent(t)?console.warn("the component is singleton, can't add the second one.",e):this._addComponentInstance(e),e}getComponent(t){if(this._components)for(let e=0,i=this._components.length;e<i;e++){let i=this._components[e];if(i instanceof t)return i}return null}get components(){return this._components||mr}getComponents(t){var e;if(this._components)for(let i=0,s=this._components.length;i<s;i++){let s=this._components[i];s instanceof t&&(e=e||[]).push(s)}return e}get timer(){return this._scene?this._scene.timer:e.timer}onAfterDeserialize(){}}yr.EVENT_SET_ACTIVESCENE="ActiveScene",yr.EVENT_SET_IN_ACTIVESCENE="InActiveScene";const Tr=[],xr=.5*Math.PI,vr=2*Math.PI;class Sr{static linearNone(t,e,i,s){return i*t/s+e}static linearIn(t,e,i,s){return i*t/s+e}static linearInOut(t,e,i,s){return i*t/s+e}static linearOut(t,e,i,s){return i*t/s+e}static bounceIn(t,e,i,s){return i-Sr.bounceOut(s-t,0,i,s)+e}static bounceInOut(t,e,i,s){return t<.5*s?.5*Sr.bounceIn(2*t,0,i,s)+e:.5*Sr.bounceOut(2*t-s,0,i,s)+.5*i+e}static bounceOut(t,e,i,s){return(t/=s)<1/2.75?i*(7.5625*t*t)+e:t<2/2.75?i*(7.5625*(t-=1.5/2.75)*t+.75)+e:t<2.5/2.75?i*(7.5625*(t-=2.25/2.75)*t+.9375)+e:i*(7.5625*(t-=2.625/2.75)*t+.984375)+e}static backIn(t,e,i,s,r=1.70158){return i*(t/=s)*t*((r+1)*t-r)+e}static backInOut(t,e,i,s,r=1.70158){return(t/=.5*s)<1?.5*i*(t*t*((1+(r*=1.525))*t-r))+e:i/2*((t-=2)*t*((1+(r*=1.525))*t+r)+2)+e}static backOut(t,e,i,s,r=1.70158){return i*((t=t/s-1)*t*((r+1)*t+r)+1)+e}static elasticIn(t,e,i,s,r=0,a=0){var n;return 0==t?e:1==(t/=s)?e+i:(a||(a=.3*s),!r||i>0&&r<i||i<0&&r<-i?(r=i,n=a/4):n=a/vr*Math.asin(i/r),-r*Math.pow(2,10*(t-=1))*Math.sin((t*s-n)*vr/a)+e)}static elasticInOut(t,e,i,s,r=0,a=0){var n;return 0==t?e:2==(t/=.5*s)?e+i:(a||(a=s*(.3*1.5)),!r||i>0&&r<i||i<0&&r<-i?(r=i,n=a/4):n=a/vr*Math.asin(i/r),t<1?r*Math.pow(2,10*(t-=1))*Math.sin((t*s-n)*vr/a)*-.5+e:r*Math.pow(2,-10*(t-=1))*Math.sin((t*s-n)*vr/a)*.5+i+e)}static elasticOut(t,e,i,s,r=0,a=0){var n;return 0==t?e:1==(t/=s)?e+i:(a||(a=.3*s),!r||i>0&&r<i||i<0&&r<-i?(r=i,n=a/4):n=a/vr*Math.asin(i/r),r*Math.pow(2,-10*t)*Math.sin((t*s-n)*vr/a)+i+e)}static strongIn(t,e,i,s){return i*(t/=s)*t*t*t*t+e}static strongInOut(t,e,i,s){return(t/=.5*s)<1?.5*i*t*t*t*t*t+e:.5*i*((t-=2)*t*t*t*t+2)+e}static strongOut(t,e,i,s){return i*((t=t/s-1)*t*t*t*t+1)+e}static sineInOut(t,e,i,s){return.5*-i*(Math.cos(Math.PI*t/s)-1)+e}static sineIn(t,e,i,s){return-i*Math.cos(t/s*xr)+i+e}static sineOut(t,e,i,s){return i*Math.sin(t/s*xr)+e}static quintIn(t,e,i,s){return i*(t/=s)*t*t*t*t+e}static quintInOut(t,e,i,s){return(t/=.5*s)<1?.5*i*t*t*t*t*t+e:.5*i*((t-=2)*t*t*t*t+2)+e}static quintOut(t,e,i,s){return i*((t=t/s-1)*t*t*t*t+1)+e}static quartIn(t,e,i,s){return i*(t/=s)*t*t*t+e}static quartInOut(t,e,i,s){return(t/=.5*s)<1?.5*i*t*t*t*t+e:.5*-i*((t-=2)*t*t*t-2)+e}static quartOut(t,e,i,s){return-i*((t=t/s-1)*t*t*t-1)+e}static cubicIn(t,e,i,s){return i*(t/=s)*t*t+e}static cubicInOut(t,e,i,s){return(t/=.5*s)<1?.5*i*t*t*t+e:.5*i*((t-=2)*t*t+2)+e}static cubicOut(t,e,i,s){return i*((t=t/s-1)*t*t+1)+e}static quadIn(t,e,i,s){return i*(t/=s)*t+e}static quadInOut(t,e,i,s){return(t/=.5*s)<1?.5*i*t*t+e:.5*-i*(--t*(t-2)-1)+e}static quadOut(t,e,i,s){return-i*(t/=s)*(t-2)+e}static expoIn(t,e,i,s){return 0==t?e:i*Math.pow(2,10*(t/s-1))+e-.001*i}static expoInOut(t,e,i,s){return 0==t?e:t==s?e+i:(t/=.5*s)<1?.5*i*Math.pow(2,10*(t-1))+e:.5*i*(2-Math.pow(2,-10*--t))+e}static expoOut(t,e,i,s){return t==s?e+i:i*(1-Math.pow(2,-10*t/s))+e}static circIn(t,e,i,s){return-i*(Math.sqrt(1-(t/=s)*t)-1)+e}static circInOut(t,e,i,s){return(t/=.5*s)<1?.5*-i*(Math.sqrt(1-t*t)-1)+e:.5*i*(Math.sqrt(1-(t-=2)*t)+1)+e}static circOut(t,e,i,s){return i*Math.sqrt(1-(t=t/s-1)*t)+e}}class Er{constructor(){this.gid=0,this.repeat=1,this._count=0}static to(t,e,s,r=null,a=null,n=0,l=!1,o=!0){return i.getItemByClass("tween",Er)._create(t,e,s,r,a,n,l,!0,o,!0)}static from(t,e,s,r=null,a=null,n=0,l=!1,o=!0){return i.getItemByClass("tween",Er)._create(t,e,s,r,a,n,l,!1,o,!0)}to(t,e,i,s=null,r=null,a=0,n=!1){return this._create(t,e,i,s,r,a,n,!0,!1,!0)}from(t,e,i,s=null,r=null,a=0,n=!1){return this._create(t,e,i,s,r,a,n,!1,!1,!0)}_create(t,i,s,r,a,n,l,o,h,u){if(!t)throw new Error("Tween:target is null");this._target=t,this._duration=s,this._ease=r||i.ease||Er.easeNone,this._complete=a||i.complete,this._delay=n,this._props=[],this._usedTimer=0,this._startTimer=A.now(),this._usedPool=h,this._delayParam=null,this.update=i.update;var d=t.$_GID||(t.$_GID=P.getGID());return Er.tweenMap[d]?(l&&Er.clearTween(t),Er.tweenMap[d].push(this)):Er.tweenMap[d]=[this],u?n<=0?this.firstStart(t,i,o):(this._delayParam=[t,i,o],e.timer.once(n,this,this.firstStart,this._delayParam)):this._initProps(t,i,o),this}firstStart(t,e,i){this._delayParam=null,t.destroyed?this.clear():(this._initProps(t,e,i),this._beginLoop())}_initProps(t,e,i){for(var s in e)if("number"==typeof t[s]){var r=i?t[s]:e[s],a=i?e[s]:t[s];this._props.push([s,r,a-r]),i||(t[s]=r)}}_beginLoop(){e.timer.frameLoop(1,this,this._doEase)}_doEase(){this._updateEase(A.now())}_updateEase(t){var e=this._target;if(e){if(e.destroyed)return Er.clearTween(e);var i=this._usedTimer=t-this._startTimer-this._delay;if(!(i<0)){if(i>=this._duration)return this.complete();for(var s=i>0?this._ease(i,0,1,this._duration):0,r=this._props,a=0,n=r.length;a<n;a++){var l=r[a];e[l[0]]=l[1]+s*l[2]}this.update&&this.update.run()}}}set progress(t){var e=t*this._duration;this._startTimer=A.now()-this._delay-e}complete(){if(this._target){e.timer.runTimer(this,this.firstStart);for(var t=this._target,i=this._props,s=this._complete,r=0,a=i.length;r<a;r++){var n=i[r];t[n[0]]=n[1]+n[2]}this.update&&this.update.run(),this._count++,0!=this.repeat&&this._count>=this.repeat?(this.clear(),s&&s.run()):this.restart()}}pause(){var t;e.timer.clear(this,this._beginLoop),e.timer.clear(this,this._doEase),e.timer.clear(this,this.firstStart),(t=A.now()-this._startTimer-this._delay)<0&&(this._usedTimer=t)}setStartTime(t){this._startTimer=t}static clearAll(t){if(t&&t.$_GID){var e=Er.tweenMap[t.$_GID];if(e){for(var i=0,s=e.length;i<s;i++)e[i]._clear();e.length=0}}}static clear(t){t.clear()}static clearTween(t){Er.clearAll(t)}clear(){this._target&&(this._remove(),this._clear())}_clear(){this.pause(),e.timer.clear(this,this.firstStart),this._complete=null,this._target=null,this._ease=null,this._props=null,this._delayParam=null,this.repeat=1,this._usedPool&&(this.update=null,i.recover("tween",this))}recover(){this._usedPool=!0,this._clear()}_remove(){var t=Er.tweenMap[this._target.$_GID];if(t)for(var e=0,i=t.length;e<i;e++)if(t[e]===this){t.splice(e,1);break}}restart(){if(this.pause(),this._usedTimer=0,this._startTimer=A.now(),this._delayParam)e.timer.once(this._delay,this,this.firstStart,this._delayParam);else{for(var t=this._props,i=0,s=t.length;i<s;i++){var r=t[i];this._target[r[0]]=r[1]}e.timer.once(this._delay,this,this._beginLoop)}}resume(){this._usedTimer>=this._duration||(this._startTimer=A.now()-this._usedTimer-this._delay,this._delayParam?this._usedTimer<0?e.timer.once(-this._usedTimer,this,this.firstStart,this._delayParam):this.firstStart.apply(this,this._delayParam):this._beginLoop())}static easeNone(t,e,i,s){return i*t/s+e}}Er.tweenMap=[];class wr{constructor(){this.ratio=.92,this.maxOffset=60,this._dragging=!1,this._clickOnly=!0}start(t,i,s,a,n,l,o=.92){this.clearTimer(),this.target=t,this.area=i,this.hasInertia=s,this.elasticDistance=i?a:0,this.elasticBackTime=n,this.data=l,this.ratio=o,this._parent=t.parent,this._clickOnly=!0,this._dragging=!0,this._elasticRateX=this._elasticRateY=1,this._lastX=this._parent.mouseX,this._lastY=this._parent.mouseY,e.stage.on(r.MOUSE_UP,this,this.onStageMouseUp),e.stage.on(r.MOUSE_OUT,this,this.onStageMouseUp),e.systemTimer.frameLoop(1,this,this.loop)}clearTimer(){e.systemTimer.clear(this,this.loop),e.systemTimer.clear(this,this.tweenMove),this._tween&&(this._tween.recover(),this._tween=null)}stop(){this._dragging&&(e.stage.off(r.MOUSE_UP,this,this.onStageMouseUp),e.stage.off(r.MOUSE_OUT,this,this.onStageMouseUp),this._dragging=!1,this.target&&this.area&&this.backToArea(),this.clear())}loop(){var t=this._parent.getMousePoint(),i=t.x,s=t.y,a=i-this._lastX,n=s-this._lastY;if(this._clickOnly){if(!(Math.abs(a*e.stage._canvasTransform.getScaleX())>1||Math.abs(n*e.stage._canvasTransform.getScaleY())>1))return;this._clickOnly=!1,this._offsets||(this._offsets=[]),this._offsets.length=0,this.target.event(r.DRAG_START,this.data)}else this._offsets.push(a,n);0===a&&0===n||(this._lastX=i,this._lastY=s,this.target.x+=a*this._elasticRateX,this.target.y+=n*this._elasticRateY,this.area&&this.checkArea(),this.target.event(r.DRAG_MOVE,this.data))}checkArea(){if(this.elasticDistance<=0)this.backToArea();else{if(this.target._x<this.area.x)var t=this.area.x-this.target._x;else t=this.target._x>this.area.x+this.area.width?this.target._x-this.area.x-this.area.width:0;if(this._elasticRateX=Math.max(0,1-t/this.elasticDistance),this.target._y<this.area.y)var e=this.area.y-this.target.y;else e=this.target._y>this.area.y+this.area.height?this.target._y-this.area.y-this.area.height:0;this._elasticRateY=Math.max(0,1-e/this.elasticDistance)}}backToArea(){this.target.x=Math.min(Math.max(this.target._x,this.area.x),this.area.x+this.area.width),this.target.y=Math.min(Math.max(this.target._y,this.area.y),this.area.y+this.area.height)}onStageMouseUp(t){if(e.stage.off(r.MOUSE_UP,this,this.onStageMouseUp),e.stage.off(r.MOUSE_OUT,this,this.onStageMouseUp),e.systemTimer.clear(this,this.loop),!this._clickOnly&&this.target)if(this.hasInertia){this._offsets.length<1&&this._offsets.push(this._parent.mouseX-this._lastX,this._parent.mouseY-this._lastY),this._offsetX=this._offsetY=0;for(var i=this._offsets.length,s=Math.min(i,6),a=this._offsets.length-s,n=i-1;n>a;n--)this._offsetY+=this._offsets[n--],this._offsetX+=this._offsets[n];this._offsetX=this._offsetX/s*2,this._offsetY=this._offsetY/s*2,Math.abs(this._offsetX)>this.maxOffset&&(this._offsetX=this._offsetX>0?this.maxOffset:-this.maxOffset),Math.abs(this._offsetY)>this.maxOffset&&(this._offsetY=this._offsetY>0?this.maxOffset:-this.maxOffset),e.systemTimer.frameLoop(1,this,this.tweenMove)}else this.elasticDistance>0?this.checkElastic():this.clear()}checkElastic(){var t=NaN,e=NaN;if(this.target.x<this.area.x?t=this.area.x:this.target._x>this.area.x+this.area.width&&(t=this.area.x+this.area.width),this.target.y<this.area.y?e=this.area.y:this.target._y>this.area.y+this.area.height&&(e=this.area.y+this.area.height),isNaN(t)&&isNaN(e))this.clear();else{var i={};isNaN(t)||(i.x=t),isNaN(e)||(i.y=e),this._tween=Er.to(this.target,i,this.elasticBackTime,Sr.sineOut,St.create(this,this.clear),0,!1,!1)}}tweenMove(){this._offsetX*=this.ratio*this._elasticRateX,this._offsetY*=this.ratio*this._elasticRateY,this.target.x+=this._offsetX,this.target.y+=this._offsetY,this.area&&this.checkArea(),this.target.event(r.DRAG_MOVE,this.data),(Math.abs(this._offsetX)<1&&Math.abs(this._offsetY)<1||this._elasticRateX<.5||this._elasticRateY<.5)&&(e.systemTimer.clear(this,this.tweenMove),this.elasticDistance>0?this.checkElastic():this.clear())}clear(){if(this.target){this.clearTimer();var t=this.target;this.target=null,this._parent=null,t.event(r.DRAG_END,this.data)}}}class Dr{static getGlobalRecByPoints(t,e,i,r,a){var n,l;n=s.create().setTo(e,i),n=t.localToGlobal(n),l=s.create().setTo(r,a),l=t.localToGlobal(l);var o=F._getWrapRec([n.x,n.y,l.x,l.y]);return n.recover(),l.recover(),o}static getGlobalPosAndScale(t){return Dr.getGlobalRecByPoints(t,0,0,1,1)}static getTransformRelativeToWindow(t,i,s){var r=e.stage,a=Dr.getGlobalPosAndScale(t),n=r._canvasTransform.clone(),l=n.tx,o=n.ty;n.rotate(-Math.PI/180*r.canvasDegree),n.scale(r.clientScaleX,r.clientScaleY);var h,u,d,c,_=r.canvasDegree%180!=0;return _?(h=s+a.y,u=i+a.x,h*=n.d,u*=n.a,90==r.canvasDegree?(h=l-h,u+=o):(h+=l,u=o-u)):(h=i+a.x,u=s+a.y,h*=n.a,u*=n.d,h+=l,u+=o),u+=r._safariOffsetY,_?(d=n.d*a.height,c=n.a*a.width):(d=n.a*a.width,c=n.d*a.height),{x:h,y:u,scaleX:d,scaleY:c}}static fitDOMElementInArea(t,i,s,r,a,n){t._fitLayaAirInitialized||(t._fitLayaAirInitialized=!0,t.style.transformOrigin=t.style.webKittransformOrigin="left top",t.style.position="absolute");var l=Dr.getTransformRelativeToWindow(i,s,r);t.style.transform=t.style.webkitTransform="scale("+l.scaleX+","+l.scaleY+") rotate("+e.stage.canvasDegree+"deg)",t.style.width=a+"px",t.style.height=n+"px",t.style.left=l.x+"px",t.style.top=l.y+"px"}static updateOrder(t){if(!t||t.length<2)return!1;for(var e,i,s,r=1,a=t.length;r<a;){for(s=t[e=r],i=t[e]._zOrder;--e>-1&&t[e]._zOrder>i;)t[e+1]=t[e];t[e+1]=s,r++}return!0}}class br extends yr{destroy(t=!0){super.destroy(t),this._style&&this._style.recover(),this._cacheStyle&&this._cacheStyle.recover(),this._boundStyle&&this._boundStyle.recover(),this._transform&&this._transform.recover(),this._style=null,this._cacheStyle=null,this._boundStyle=null,this._transform=null,this._texture&&this._texture._removeReference(),this._texture=null,this._graphics&&this._ownGraphics&&this._graphics.destroy(),this._graphics=null}constructor(){super(),this._x=0,this._y=0,this._width=0,this._height=0,this._anchorX=0,this._anchorY=0,this._visible=!0,this._mouseState=0,this._zOrder=0,this._renderType=0,this._transform=null,this._tfChanged=!1,this._repaint=re.REPAINT_NONE,this._texture=null,this._sizeFlag=0,this._style=Is.EMPTY,this._cacheStyle=As.EMPTY,this._filterArr=null,this._boundStyle=null,this._graphics=null,this._renderNode=null,this._ownGraphics=!1,this.mouseThrough=!1,this.hitTestPrior=!1,this.autoSize=!1,this._globalDeltaFlages=0,this._cacheGlobal=!1,this._globalPosx=0,this._globalPosy=0,this._globalRotate=0,this._globalScalex=1,this._globalScaley=1}get scene(){return this._scene}updateZOrder(){Dr.updateOrder(this._children)&&this.repaint()}_getBoundsStyle(){return this._boundStyle||(this._boundStyle=Rs.create()),this._boundStyle}_setCustomRender(){}set customRenderEnable(t){t&&(this._renderType|=re.CUSTOM,this._setCustomRender())}get cacheAs(){return this._getCacheStyle().userSetCache}set cacheAs(t){t!==this._cacheStyle.userSetCache&&(this._getCacheStyle().userSetCache=t,this.mask&&"normal"===t||("bitmap"==t||"normal"==t?this._renderType|=re.CANVAS:this._renderType&=~re.CANVAS,this.repaint()))}get staticCache(){return this._getCacheStyle().staticCache}set staticCache(t){this._getCacheStyle().staticCache=t,t||this.reCache()}reCache(){this._repaint|=re.REPAINT_CACHE}get renderNode2D(){return this._renderNode}set renderNode2D(t){t?(this._renderType|=re.RENDERNODE2D,this._renderNode=t):this._renderType&=~re.RENDERNODE2D}getRepaint(){return this._repaint}_setX(t){this._x=t}_setY(t){this._y=t}get x(){return this._x}set x(t){if(!this._destroyed&&this._x!==t){this._setX(t),this.cacheGlobal&&(this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Position_X|br.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(br.Sprite_GlobalDeltaFlage_Position_X|br.Sprite_GlobalDeltaFlage_Matrix,!0)),this.parentRepaint(re.REPAINT_CACHE);var e=this._getCacheStyle().maskParent;e&&e.repaint(re.REPAINT_CACHE)}}get y(){return this._y}set y(t){if(!this._destroyed&&this._y!==t){this._setY(t),this.cacheGlobal&&(this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Position_Y|br.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(br.Sprite_GlobalDeltaFlage_Position_Y|br.Sprite_GlobalDeltaFlage_Matrix,!0)),this.parentRepaint(re.REPAINT_CACHE);var e=this._getCacheStyle().maskParent;e&&e.repaint(re.REPAINT_CACHE)}}get width(){return this.get_width()}set width(t){this.set_width(t)}set_width(t){let e=this._sizeFlag;null==t?(t=0,this._sizeFlag&=-2):0==t?this._sizeFlag|=1:this._sizeFlag&=-2,this._width===t&&e==this._sizeFlag||(this._width=t,this._setWidth(t),this._setPivotX(this._anchorX*t),this._graphics&&this._graphics._clearBoundsCache(!0),this._setTranformChange(),this._shouldRefreshLayout())}get_width(){return this.autoSize?this.texture?this.texture.width:this._graphics||0!==this._children.length?this.getSelfBounds().width:0:0!=this._width||1&this._sizeFlag||!this.texture?this._width:this.texture.width}get height(){return this.get_height()}set height(t){this.set_height(t)}set_height(t){let e=this._sizeFlag;null==t?(t=0,this._sizeFlag&=-3):0==t?this._sizeFlag|=2:this._sizeFlag&=-3,this._height===t&&e==this._sizeFlag||(this._height=t,this._setHeight(t),this._setPivotY(this._anchorY*t),this._graphics&&this._graphics._clearBoundsCache(!0),this._setTranformChange(),this._shouldRefreshLayout())}get_height(){return this.autoSize?this.texture?this.texture.height:this._graphics||0!==this._children.length?this.getSelfBounds().height:0:0!=this._height||2&this._sizeFlag||!this.texture?this._height:this.texture.height}get _isWidthSet(){return 0!=this._width||!!(1&this._sizeFlag)}get _isHeightSet(){return 0!=this._height||!!(2&this._sizeFlag)}_setWidth(t){}_setHeight(t){}_shouldRefreshLayout(){}get displayWidth(){return this.width*this.scaleX}get displayHeight(){return this.height*this.scaleY}setSelfBounds(t){this._getBoundsStyle().userBounds=t}getBounds(){return this._getBoundsStyle().bounds=F._getWrapRec(this._boundPointsToParent())}getSelfBounds(){return this._boundStyle&&this._boundStyle.userBounds?this._boundStyle.userBounds:this._graphics||0!==this._children.length||this._texture?this._getBoundsStyle().bounds=F._getWrapRec(this._getBoundPointsM(!1)):F.TEMP.setTo(0,0,this.width,this.height)}_boundPointsToParent(t=!1){let e=0,i=0;this._style&&(e=this.pivotX,i=this.pivotY,t=t||0!==this._style.rotation,this._style.scrollRect&&(e+=this._style.scrollRect.x,i+=this._style.scrollRect.y));let r=this._getBoundPointsM(t);if(!r||r.length<1)return r;if(8!=r.length&&(r=t?se.scanPList(r):F._getWrapRec(r,F.TEMP)._getBoundPoints()),!this.transform)return P.transPointList(r,this._x-e,this._y-i),r;let a=s.TEMP,n=r.length;for(let t=0;t<n;t+=2)a.x=r[t],a.y=r[t+1],this.toParentPoint(a),r[t]=a.x,r[t+1]=a.y;return r}_getBoundPointsM(t=!1){if(this._boundStyle&&this._boundStyle.userBounds)return this._boundStyle.userBounds._getBoundPoints();this._boundStyle||this._getBoundsStyle();let e,i=this._boundStyle.temBM;if(i||(i=this._boundStyle.temBM=[]),this._style.scrollRect){i.length=0;var s=F.TEMP;return s.copyFrom(this._style.scrollRect),i.push(...s._getBoundPoints()),i}this._graphics?e=this._graphics.getBoundPoints():(i.length=0,e=i),this._renderNode&&((s=F.TEMP).setTo(0,0,this.width,this.height),e.push(...s._getBoundPoints())),this._texture&&((s=F.TEMP).setTo(0,0,this.width||this._texture.width,this.height||this._texture.height),e.push(...s._getBoundPoints()));let r=this._children;for(let i=0,s=r.length;i<s;i++){let s=r[i];if(!0===s._visible&&s._cacheStyle.maskParent!=this){let i=s._boundPointsToParent(t);i&&(e?e.push(...i):e=i)}}return e}getGraphicBounds(t=!1){return this._graphics?this._graphics.getBounds(t):F.TEMP.setTo(0,0,0,0)}_getCacheStyle(){return this._cacheStyle===As.EMPTY&&(this._cacheStyle=As.create()),this._cacheStyle}getStyle(){return this._style===Is.EMPTY&&(this._style=Is.create()),this._style}setStyle(t){this._style=t}get scaleX(){return this._style.scaleX}set scaleX(t){this.set_scaleX(t)}get scaleY(){return this._style.scaleY}set scaleY(t){this.set_scaleY(t)}set_scaleX(t){this.getStyle().scaleX!==t&&(this.cacheGlobal&&(this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Scale_X|br.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(br.Sprite_GlobalDeltaFlage_Scale_X|br.Sprite_GlobalDeltaFlage_Matrix,!0)),this._setScaleX(t),this._setTranformChange(),this._shouldRefreshLayout())}get_scaleX(){return this._style.scaleX}set_scaleY(t){this.getStyle().scaleY!==t&&(this.cacheGlobal&&(this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Scale_Y|br.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(br.Sprite_GlobalDeltaFlage_Scale_Y|br.Sprite_GlobalDeltaFlage_Matrix,!0)),this._setScaleY(t),this._setTranformChange(),this._shouldRefreshLayout())}get_scaleY(){return this._style.scaleY}_setScaleX(t){this._style.scaleX=t}_setScaleY(t){this._style.scaleY=t}get rotation(){return this._style.rotation}set rotation(t){this.getStyle().rotation!==t&&(this.cacheGlobal&&(this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Rotation|br.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(br.Sprite_GlobalDeltaFlage_Rotation|br.Sprite_GlobalDeltaFlage_Matrix,!0)),this._setRotation(t),this._setTranformChange())}_setRotation(t){this.getStyle().rotation=t}get skewX(){return this._style.skewX}set skewX(t){this.getStyle().skewX!==t&&(this._setSkewX(t),this._setTranformChange())}_setSkewX(t){this._style.skewX=t}get skewY(){return this._style.skewY}set skewY(t){this.getStyle().skewY!==t&&(this._setSkewY(t),this._setTranformChange())}_setSkewY(t){this._style.skewY=t}_createTransform(){return G.create()}_adjustTransform(){this._tfChanged=!1;var t=this._style,e=t.scaleX,i=t.scaleY,s=t.skewX,r=t.skewY,a=t.rotation,n=this._transform||(this._transform=this._createTransform());if(a||1!==e||1!==i||0!==s||0!==r){n._bTransform=!0;var l=.0174532922222222*(a-s),o=.0174532922222222*(a+r),h=Math.cos(o),u=Math.sin(o),d=Math.sin(l),c=Math.cos(l);n.a=e*h,n.b=e*u,n.c=-i*d,n.d=i*c,n.tx=n.ty=0}else n.identity(),this._renderType&=~re.TRANSFORM;return n}_setTransform(t){}get transform(){return this._tfChanged?this._adjustTransform():this._transform}set transform(t){this.set_transform(t)}get_transform(){return this._tfChanged?this._adjustTransform():this._transform}set_transform(t){this._tfChanged=!1;var e=this._transform||(this._transform=this._createTransform());t.copyTo(e),this._setTransform(e),t&&(this._x=e.tx,this._y=e.ty,e.tx=e.ty=0),t?this._renderType|=re.TRANSFORM:this._renderType&=~re.TRANSFORM,this.parentRepaint()}_getPivotX(){return this._style.pivotX}_setPivotX(t){this.getStyle().pivotX=t}_getPivotY(){return this._style.pivotY}_setPivotY(t){this.getStyle().pivotY=t}get pivotX(){return this._getPivotX()}set pivotX(t){if(this.getStyle().pivotX!=t){this._setPivotX(t);let e=this.width;0!=e&&(this._anchorX=t/e),this._shouldRefreshLayout(),this.repaint()}}get pivotY(){return this._getPivotY()}set pivotY(t){if(this.getStyle().pivotY!=t){this._setPivotY(t);let e=this.height;0!=e&&(this._anchorY=t/e),this._shouldRefreshLayout(),this.repaint()}}get anchorX(){return this.get_anchorX()}get_anchorX(){return this._anchorX}set anchorX(t){this.set_anchorX(t)}set_anchorX(t){isNaN(t)&&(t=null),this._anchorX!=t&&(this._anchorX=t,null!=t&&(this._setPivotX(t*this.width),this._shouldRefreshLayout(),this.repaint()))}get anchorY(){return this.get_anchorY()}get_anchorY(){return this._anchorY}set anchorY(t){this.set_anchorY(t)}set_anchorY(t){isNaN(t)&&(t=null),this._anchorY!=t&&(this._anchorY=t,null!=t&&(this._setPivotY(t*this.height),this._shouldRefreshLayout(),this.repaint()))}_setAlpha(t){this._style.alpha!==t&&(this.getStyle().alpha=t,1!==t?this._renderType|=re.ALPHA:this._renderType&=~re.ALPHA,this.parentRepaint())}_getAlpha(){return this._style.alpha}get alpha(){return this._getAlpha()}set alpha(t){t=t<0?0:t>1?1:t,this._setAlpha(t)}get visible(){return this.get_visible()}set visible(t){this.set_visible(t)}get_visible(){return this._visible}set_visible(t){this._visible!==t&&(this._visible=t,this.parentRepaint(re.REPAINT_ALL))}get blendMode(){return this._style.blendMode}set blendMode(t){this.getStyle().blendMode!=t&&(this.getStyle().blendMode=t,t&&"source-over"!=t?this._renderType|=re.BLEND:this._renderType&=~re.BLEND,this.parentRepaint())}get graphics(){return this._graphics||(this.graphics=new gr,this._ownGraphics=!0),this._graphics}set graphics(t){this.setGraphics(t,!1)}setGraphics(t,e){this._graphics&&(this._graphics._sp=null,this._ownGraphics&&this._graphics.destroy()),this._ownGraphics=e,this._graphics=t,t?(this._renderType|=re.GRAPHICS,t._sp=this):this._renderType&=~re.GRAPHICS,this.repaint()}get material(){var t;return null===(t=this._graphics)||void 0===t?void 0:t.material}set material(t){null==this._graphics&&null==t||(this.graphics.material=t)}get scrollRect(){return this._style.scrollRect}set scrollRect(t){null==this.getStyle().scrollRect&&null==t||(this.getStyle().scrollRect=t,t?this._renderType|=re.CLIP:this._renderType&=~re.CLIP,this.repaint())}get viewport(){return this._style.viewport}set viewport(t){if("string"==typeof t){let e=t.split(",");e.length>3&&(t=new F(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])))}this.getStyle().viewport=t}pos(t,e,i=!1){if(this._x!==t||this._y!==e){if(this._destroyed)return this;if(i){this._setX(t),this._setY(e),this.parentRepaint(re.REPAINT_CACHE);var s=this._cacheStyle.maskParent;if(s&&s.repaint(re.REPAINT_CACHE),this.cacheGlobal){let t=br.Sprite_GlobalDeltaFlage_Position_X|br.Sprite_GlobalDeltaFlage_Position_Y;this._setGlobalCacheFlag(t,!0),this._syncGlobalFlag(t,!0)}}else this.x=t,this.y=e}return this}pivot(t,e){return this.pivotX=t,this.pivotY=e,this}size(t,e){return this.width=t,this.height=e,this}scale(t,e,i){if(this._destroyed)return this;var s=this.getStyle();return s.scaleX==t&&s.scaleY==e||(i?(this._setScaleX(t),this._setScaleY(e),this._setTranformChange(),this._shouldRefreshLayout()):(this.scaleX=t,this.scaleY=e)),this}skew(t,e){return this.skewX=t,this.skewY=e,this}render(t,e,i){bs.renders[this._renderType]._fun(this,t,e+this._x,i+this._y),this._repaint=0}drawToCanvas(t,e,i,s){return br.drawToCanvas(this,t,e,i,s)}static drawToCanvas(t,e,i,s,r,a=!0){let n=br.drawToRenderTexture2D(t,e,i,s,r,null);for(var l=n.getData(0,0,e,i),o=new ImageData(e,i),h=4*e,u=o.data,d=i-1,c=d*h,_=0;d>=0;d--)u.set(l.subarray(_,_+h),c),c-=h,_+=h;var p=new Cs(!0);return p.size(e,i),p.getContext("2d").putImageData(o,0,0),n.destroy(),p}drawToTexture(t,e,i,s,r=null,a=!0){return br.drawToTexture(this,t,e,i,s,r,a)}static drawToTexture(e,i,s,r,a,n=null,l=!0){let o=n||new pt(i,s,t.RenderTargetFormat.R8G8B8A8),h=new os;n?h.size(n.width,n.height):h.size(i,s),h.render2D=h.render2D.clone(o),h._drawingToTexture=!0;let u=bs.RenderToRenderTexture(e,h,r,a,o,l);if(h._drawingToTexture=!1,h.destroy(),!n){return new mt(u,mt.INV_UV)}return u}drawToRenderTexture2D(t,e,i,s,r=null,a=!0,n=!1){return br.drawToRenderTexture2D(this,t,e,i,s,r,a,n)}static drawToRenderTexture2D(e,i,s,r,a,n=null,l=!0,o=!1){let h=n||new pt(i,s,t.RenderTargetFormat.R8G8B8A8),u=new os;n?u.size(n.width,n.height):u.size(i,s),u.render2D=u.render2D.clone(h),u._drawingToTexture=!0,o&&(h._invertY=!0);let d=bs.RenderToRenderTexture(e,u,r,a,h,l);return u._drawingToTexture=!1,u.destroy(),d}customRender(t,e,i){this._repaint=re.REPAINT_ALL}_applyFilters(){}get filters(){return this._filterArr}set filters(t){if(t&&0===t.length&&(t=null),this._filterArr)for(let t of this._filterArr)t&&t.off(ie.EVENT_CHANGE,this,this.repaint);if(this._filterArr=t?t.slice():null,t)for(let e of t)e&&e.on(ie.EVENT_CHANGE,this,this.repaint);t?this._renderType|=re.FILTERS:this._renderType&=~re.FILTERS,t&&t.length>0&&(this._getBit(kt.DISPLAY)||this._setBitUp(kt.DISPLAY)),this.repaint()}localToGlobal(t,i=!1,r=null){!0===i&&(t=new s(t.x,t.y));var a=this;for(r=r||e.stage;a&&!a._destroyed&&a!=r;)t=a.toParentPoint(t),a=a.parent;return t}globalToLocal(t,i=!1,r=null){i&&(t=new s(t.x,t.y));var a=this,n=[];for(r=r||e.stage;a&&!a._destroyed&&a!=r;)n.push(a),a=a.parent;for(var l=n.length-1;l>=0;)t=(a=n[l]).fromParentPoint(t),l--;return t}toParentPoint(t){if(!t)return t;t.x-=this.pivotX,t.y-=this.pivotY,this.transform&&this._transform.transformPoint(t),t.x+=this._x,t.y+=this._y;var e=this._style.scrollRect;return e&&(t.x-=e.x,t.y-=e.y),t}fromParentPoint(t){if(!t)return t;t.x-=this._x,t.y-=this._y;var e=this._style.scrollRect;return e&&(t.x+=e.x,t.y+=e.y),this.transform&&this._transform.invertTransformPoint(t),t.x+=this.pivotX,t.y+=this.pivotY,t}onStartListeningToType(t){super.onStartListeningToType(t),1!==this._mouseState&&r.isMouseEvent(t)&&(this.mouseEnabled=!0,this._setBit(kt.HAS_MOUSE,!0),this._parent&&this._onDisplay())}_onDisplay(t){if(1!==this._mouseState){var e=this;for(e=e.parent;e&&1!==e._mouseState&&!e._getBit(kt.HAS_MOUSE);)e.mouseEnabled=!0,e._setBit(kt.HAS_MOUSE,!0),e=e.parent}}_setParent(t){super._setParent(t),t&&this._getBit(kt.HAS_MOUSE)&&this._onDisplay()}loadImage(t,i=null){if(t){let s=e.loader.getRes(t);s?(this.texture=s,this.repaint(re.REPAINT_ALL),i&&i.run()):(this._skinBaseUrl&&(t=O.formatURL(t,this._skinBaseUrl)),e.loader.load(t).then((t=>{this.texture=t,this.repaint(re.REPAINT_ALL),i&&i.run()})))}else this.texture=null,this.repaint(re.REPAINT_ALL),i&&i.run();return this}static fromImage(t){return(new br).loadImage(t)}repaint(t=re.REPAINT_CACHE){this._repaint&t||(this._repaint|=t,this.parentRepaint(t)),this._getCacheStyle(),this._cacheStyle&&(this._cacheStyle.renderTexture=null),this._cacheStyle&&this._cacheStyle.maskParent&&this._cacheStyle.maskParent.repaint(t)}_needRepaint(){return!!(this._repaint&re.REPAINT_CACHE)}_childChanged(t=null){super._childChanged(t),this._children.length?this._renderType|=re.CHILDS:this._renderType&=~re.CHILDS,t&&this._getBit(kt.HAS_ZORDER)&&e.systemTimer.callLater(this,this.updateZOrder),this.repaint(re.REPAINT_ALL)}parentRepaint(t=re.REPAINT_CACHE){var e=this._parent;!e||e._repaint&t||(e._repaint|=t,e.parentRepaint(t))}get stage(){return e.stage}get hitArea(){return this._style.hitArea}set hitArea(t){this.getStyle().hitArea=t}_setMask(t){}get mask(){return this._cacheStyle.mask}set mask(t){t==this||t&&this.mask==t&&t._cacheStyle.maskParent==this||(this.mask&&(this.mask._getCacheStyle().maskParent=null),this._getCacheStyle().mask=t,this._setMask(t),t?(t._getCacheStyle().maskParent=this,this._renderType|=re.MASK):this._renderType&=~re.MASK,this.repaint())}get mouseEnabled(){return this._mouseState>1}set mouseEnabled(t){this._mouseState=t?2:1}startDrag(t=null,e=!1,i=0,s=300,r=null,a=.92){this._style.dragging||(this.getStyle().dragging=new wr),this._style.dragging.start(this,t,e,i,s,r,a)}stopDrag(){this._style.dragging&&this._style.dragging.stop()}_setDisplay(t){this._getCacheStyle(),t||this._cacheStyle.onInvisible(),super._setDisplay(t)}hitTestPoint(t,e){var i=this.globalToLocal(s.TEMP.setTo(t,e));return t=i.x,e=i.y,(this._style.hitArea?this._style.hitArea:this._isWidthSet&&this._isHeightSet?F.TEMP.setTo(0,0,this._width,this._height):this.getSelfBounds()).contains(t,e,this)}getMousePoint(){return this.globalToLocal(s.TEMP.setTo(e.stage.mouseX,e.stage.mouseY))}get mouseX(){return this.getMousePoint().x}get mouseY(){return this.getMousePoint().y}get zOrder(){return this._zOrder}set zOrder(t){this._zOrder!=t&&(this._zOrder=t,this._parent&&(t&&this._parent._setBit(kt.HAS_ZORDER,!0),e.systemTimer.callLater(this._parent,this.updateZOrder)))}get texture(){return this._texture}_setTexture(t){}set texture(t){"string"==typeof t?this.loadImage(t):this._texture!=t&&(this._texture&&this._texture._removeReference(),this._texture=t,t&&t._addReference(),this._setTexture(t),this._setWidth(this.width),this._setHeight(this.height),t?this._renderType|=re.TEXTURE:this._renderType&=~re.TEXTURE,this.repaint())}_setTranformChange(){this._tfChanged=!0,this._renderType|=re.TRANSFORM,this.parentRepaint(re.REPAINT_CACHE)}set drawCallOptimize(t){this._setBit(kt.DRAWCALL_OPTIMIZE,t)}get drawCallOptimize(){return this._getBit(kt.DRAWCALL_OPTIMIZE)}onAfterDeserialize(){super.onAfterDeserialize(),n.isPlaying&&(this._gcmds&&(this.graphics.cmds=this._gcmds,delete this._gcmds),this._filters&&(this.filters=this._filters,delete this._filters))}get cacheGlobal(){return this._cacheGlobal}set cacheGlobal(t){if(this._cacheGlobal!=t)if(this._cacheGlobal=t,t){if(this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Position_X,!0),this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Position_Y,!0),this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Scale_X,!0),this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Scale_Y,!0),this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Rotation,!0),this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Matrix,!0),this._parent==e.stage||!this._parent)return;this._parent.cacheGlobal=t}else this._children.forEach((e=>{e.cacheGlobal=t}))}getGlobalMatrix(){return null==this._globalMatrix&&(this._globalMatrix=G.create()),this._getGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Matrix)&&(this._globalMatrix.identity(),this._globalMatrix.translate(-this.pivotX,-this.pivotY),this._globalMatrix.scale(this.globalScaleX,this.globalScaleY),this._globalMatrix.rotate(P.toRadian(this.globalRotation)),this._globalMatrix.translate(this.globalPosX,this.globalPosY),this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Matrix,!1)),this._globalMatrix}set globalPosX(t){this.setGlobalPos(t,this._globalPosy)}setGlobalPos(t,e){if(t!=this.globalPosX||e!=this.globalPosY)if(this._cacheGlobal){let i=this.parent.getGlobalMatrix().invertTransformPoint(s.TEMP.setTo(t,e));this._setX(i.x),this._setY(i.y),this._globalPosx=t,this._globalPosy=e;let r=br.Sprite_GlobalDeltaFlage_Position_X|br.Sprite_GlobalDeltaFlage_Position_Y;this._setGlobalCacheFlag(r,!1),this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(r|br.Sprite_GlobalDeltaFlage_Matrix,!0)}else{s.TEMP.setTo(t,e);let i=this.globalToLocal(s.TEMP,!1,null);i=this.toParentPoint(i),this.x=i.x,this.y=i.y}}get globalPosX(){if(this._cacheGlobal){if(this._getGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Matrix|br.Sprite_GlobalDeltaFlage_Position_X)){this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Position_X,!1);let t=this.parent.getGlobalMatrix(),e=this.toParentPoint(s.TEMP.setTo(this.pivotX,this.pivotY));e=t.transformPoint(e),this._globalPosx=e.x,this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(br.Sprite_GlobalDeltaFlage_Matrix,!0)}return this._globalPosx}return this.localToGlobal(s.TEMP.setTo(0,0),!1,null).x}get globalPosY(){if(this._cacheGlobal){if(this._getGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Matrix|br.Sprite_GlobalDeltaFlage_Position_Y)){this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Position_Y,!1);let t=this.parent.getGlobalMatrix(),e=this.toParentPoint(s.TEMP.setTo(this.pivotX,this.pivotY));e=t.transformPoint(e),this._globalPosy=e.y,this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(br.Sprite_GlobalDeltaFlage_Matrix,!0)}return this._globalPosy}return this.localToGlobal(s.TEMP.setTo(0,0),!1,null).y}set globalPosY(t){this.setGlobalPos(this._globalPosx,t)}get globalRotation(){if(this._cacheGlobal)return this._getGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Rotation)&&(this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Rotation,!1),this._parent!=e.stage&&this._parent?this._globalRotate=this.rotation+this.parent.globalRotation:this._globalRotate=this.rotation),this._globalRotate;for(var t=0,i=this;i&&i!==e.stage;)t+=i.rotation,i=i.parent;return t}set globalRotation(t){t!=this.globalRotation&&(this._parent!=e.stage&&this._parent?(this._setRotation(t-this.parent.globalRotation),this._setTranformChange()):(this._setRotation(t),this._setTranformChange()),this._cacheGlobal&&(this._globalRotate=t,this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Rotation,!1),this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(br.Sprite_GlobalDeltaFlage_Matrix,!0)))}get globalScaleX(){if(this._cacheGlobal)return this._getGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Scale_X)&&(this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Scale_X,!1),this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Matrix,!0),this._parent!=e.stage&&this._parent?this._globalScalex=this.scaleX*this.parent.globalScaleX:this._globalScalex=this.scaleX,this._syncGlobalFlag(br.Sprite_GlobalDeltaFlage_Matrix,!0)),this._globalScalex;for(var t=1,i=this;i&&i!==e.stage;)t*=i.scaleX,i=i.parent;return t}get globalScaleY(){if(this._cacheGlobal)return this._getGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Scale_Y)&&(this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Scale_Y,!1),this._setGlobalCacheFlag(br.Sprite_GlobalDeltaFlage_Matrix,!0),this._parent!=e.stage&&this._parent?this._globalScaley=this.scaleY*this.parent.globalScaleY:this._globalScaley=this.scaleY,this._syncGlobalFlag(br.Sprite_GlobalDeltaFlage_Matrix,!0)),this._globalScaley;for(var t=1,i=this;i&&i!==e.stage;)t*=i.scaleY,i=i.parent;return t}_getGlobalCacheFlag(t){return!!(this._globalDeltaFlages&t)}_getGlobalCacheLocalToGlobal(t,e){return this._cacheGlobal?this.getGlobalMatrix().transformPoint(s.TEMP.setTo(this.pivotX+t,this.pivotY+e)):this.localToGlobal(s.TEMP.setTo(t,e),!1,null)}_getGlobalCacheGlobalToLocal(t,e){if(this._cacheGlobal){let i=this.getGlobalMatrix().invertTransformPoint(s.TEMP.setTo(t,e));return i.x-=this.pivotX,i.y-=this.pivotY,i}return this.globalToLocal(s.TEMP.setTo(t,e),!1,null)}_setGlobalCacheFlag(t,e){e?this._globalDeltaFlages|=t:this._globalDeltaFlages&=~t,e&&this.event("GlobaChange",t)}get globalDeltaFlages(){return this._globalDeltaFlages}_syncGlobalFlag(t,e){this.cacheGlobal&&this._children.forEach((i=>{i._setGlobalCacheFlag(t,e),i._syncGlobalFlag(t,e)}))}}br.Sprite_GlobalDeltaFlage_Position_X=1,br.Sprite_GlobalDeltaFlage_Position_Y=2,br.Sprite_GlobalDeltaFlage_Rotation=4,br.Sprite_GlobalDeltaFlage_Scale_X=8,br.Sprite_GlobalDeltaFlage_Scale_Y=16,br.Sprite_GlobalDeltaFlage_Matrix=32;class Cr extends br{constructor(){super(),this.wrapMode=0,this._interval=f.animationInterval,this._isReverse=!1,this._frameRateChanged=!1,this._setBitUp(kt.DISPLAY)}play(t=0,e=!0,i=""){this._isPlaying=!0,this._actionName=i,this.index="string"==typeof t?this._getFrameByLabel(t):t,this.loop=e,this._isReverse=this.wrapMode===Cr.WRAP_REVERSE,0==this.index&&this._isReverse&&(this.index=this.count-1),this.interval>0&&this.timerLoop(this.interval,this,this._frameLoop,null,!0,!0)}get interval(){return this._interval}set interval(t){this._interval!=t&&(this._frameRateChanged=!0,this._interval=t,this._isPlaying&&t>0&&this.timerLoop(t,this,this._frameLoop,null,!0,!0))}_getFrameByLabel(t){for(var e=0;e<this._count;e++){var i=this._labels[e];if(i&&i.indexOf(t)>-1)return e}return 0}_frameLoop(){if(this._controlNode&&!this._controlNode._destroyed){if(this._isReverse){if(this._index--,this._index<0){if(!this.loop)return this._index=0,this.stop(),void this.event(r.COMPLETE);this.wrapMode==Cr.WRAP_PINGPONG?(this._index=this._count>0?1:0,this._isReverse=!1):this._index=this._count-1,this.event(r.COMPLETE)}}else if(this._index++,this._index>=this._count){if(!this.loop)return this._index--,this.stop(),void this.event(r.COMPLETE);this.wrapMode==Cr.WRAP_PINGPONG?(this._index=this._count-2>=0?this._count-2:0,this._isReverse=!0):this._index=0,this.event(r.COMPLETE)}this.index=this._index}else this.clearTimer(this,this._frameLoop)}_setControlNode(t){this._controlNode&&(this._controlNode.off(r.DISPLAY,this,this._resumePlay),this._controlNode.off(r.UNDISPLAY,this,this._resumePlay)),this._controlNode=t,t&&t!=this&&(t.on(r.DISPLAY,this,this._resumePlay),t.on(r.UNDISPLAY,this,this._resumePlay))}_setDisplay(t){super._setDisplay(t),this._resumePlay()}_resumePlay(){this._isPlaying&&(this._controlNode.displayedInStage?this.play(this._index,this.loop,this._actionName):this.clearTimer(this,this._frameLoop))}stop(){this._isPlaying=!1,this.clearTimer(this,this._frameLoop)}get isPlaying(){return this._isPlaying}addLabel(t,e){this._labels||(this._labels={}),this._labels[e]||(this._labels[e]=[]),this._labels[e].push(t)}removeLabel(t){if(t){if(this._labels)for(var e in this._labels)this._removeLabelFromList(this._labels[e],t)}else this._labels=null}_removeLabelFromList(t,e){if(t)for(var i=t.length-1;i>=0;i--)t[i]==e&&t.splice(i,1)}gotoAndStop(t){this.index="string"==typeof t?this._getFrameByLabel(t):t,this.stop()}get index(){return this._index}set index(t){if(this._index=t,this._displayToIndex(t),this._labels&&this._labels[t])for(var e=this._labels[t],i=0,s=e.length;i<s;i++)this.event(r.LABEL,e[i])}_displayToIndex(t){}get count(){return this._count}clear(){return this.stop(),this._labels=null,this}}Cr.WRAP_POSITIVE=0,Cr.WRAP_REVERSE=1,Cr.WRAP_PINGPONG=2;class Rr{static subtractVector3(t,e,i){i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2]}static lerp(t,e,i){return t*(1-i)+e*i}static scaleVector3(t,e,i){i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e}static lerpVector3(t,e,i,s){var r=t[0],a=t[1],n=t[2];s[0]=r+i*(e[0]-r),s[1]=a+i*(e[1]-a),s[2]=n+i*(e[2]-n)}static lerpVector4(t,e,i,s){var r=t[0],a=t[1],n=t[2],l=t[3];s[0]=r+i*(e[0]-r),s[1]=a+i*(e[1]-a),s[2]=n+i*(e[2]-n),s[3]=l+i*(e[3]-l)}static slerpQuaternionArray(t,e,i,s,r,a,n){var l,o,h,u,d,c=t[e+0],_=t[e+1],p=t[e+2],f=t[e+3],g=i[s+0],m=i[s+1],y=i[s+2],T=i[s+3];return(o=c*g+_*m+p*y+f*T)<0&&(o=-o,g=-g,m=-m,y=-y,T=-T),1-o>1e-6?(l=Math.acos(o),h=Math.sin(l),u=Math.sin((1-r)*l)/h,d=Math.sin(r*l)/h):(u=1-r,d=r),a[n+0]=u*c+d*g,a[n+1]=u*_+d*m,a[n+2]=u*p+d*y,a[n+3]=u*f+d*T,a}static getRotation(t,e,i,s){return Math.atan2(s-e,i-t)/Math.PI*180}static sortBigFirst(t,e){return t==e?0:e>t?1:-1}static sortSmallFirst(t,e){return t==e?0:e>t?-1:1}static sortNumBigFirst(t,e){return parseFloat(e)-parseFloat(t)}static sortNumSmallFirst(t,e){return parseFloat(t)-parseFloat(e)}static sortByKey(t,e=!1,i=!0){var s;return s=e?i?Rr.sortNumBigFirst:Rr.sortBigFirst:i?Rr.sortNumSmallFirst:Rr.sortSmallFirst,function(e,i){return s(e[t],i[t])}}}class Ar extends Cr{static _sortIndexFun(t,e){return t.index-e.index}constructor(){super(),void 0===Ar._sortIndexFun&&(Ar._sortIndexFun=Rr.sortByKey("index",!1,!0))}_setUp(t,e){this._targetDic=t,this._animationData=e,this.interval=1e3/e.frameRate,e.parsed?(this._count=e.count,this._labels=e.labels,this._usedFrames=e.animationNewFrames):(this._usedFrames=[],this._calculateDatas(),e.parsed=!0,e.labels=this._labels,e.count=this._count,e.animationNewFrames=this._usedFrames)}clear(){return super.clear(),this._targetDic=null,this._animationData=null,this}_displayToIndex(t){if(this._animationData){t<0&&(t=0),t>this._count&&(t=this._count);var e,i=this._animationData.nodes,s=i.length;for(e=0;e<s;e++)this._displayNodeToFrame(i[e],t)}}_displayNodeToFrame(t,e,i=null){i||(i=this._targetDic);var s=i[t.target];if(s){var r,a,n,l,o=t.frames,h=t.keys,u=h.length;for(l=0;l<u;l++)n=(a=o[r=h[l]]).length>e?a[e]:a[a.length-1],s[r]=n;var d,c=t.funkeys;if(0!=(u=c.length))for(l=0;l<u;l++)void 0!==(d=o[r=c[l]])[e]&&s[r]&&s[r].apply(s,d[e])}}_calculateDatas(){if(this._animationData){var t,e,i=this._animationData.nodes,s=i.length;for(this._count=0,t=0;t<s;t++)e=i[t],this._calculateKeyFrames(e);this._count+=1}}_calculateKeyFrames(t){var e,i,s=t.keyframes,r=t.target;for(e in t.frames||(t.frames={}),t.keys?t.keys.length=0:t.keys=[],t.funkeys?t.funkeys.length=0:t.funkeys=[],t.initValues||(t.initValues={}),s){var a=-1!=e.indexOf("()");if(i=s[e],a&&(e=e.substr(0,e.length-2)),t.frames[e]||(t.frames[e]=[]),a){t.funkeys.push(e);for(var n=t.frames[e],l=0;l<i.length;l++){var o=i[l];n[o.index]=o.value,o.index>this._count&&(this._count=o.index)}}else this._targetDic&&this._targetDic[r]&&(t.initValues[e]=this._targetDic[r][e]),i.sort(Ar._sortIndexFun),t.keys.push(e),this._calculateNodePropFrames(i,t.frames[e],e,r)}}resetNodes(){if(this._targetDic&&this._animationData){var t,e,i,s=this._animationData.nodes,r=s.length;for(t=0;t<r;t++)if(i=(e=s[t]).initValues){var a,n=this._targetDic[e.target];if(n)for(a in i)n[a]=i[a]}}}_calculateNodePropFrames(t,e,i,s){var r,a=t.length-1;for(e.length=t[a].index+1,r=0;r<a;r++)this._dealKeyFrame(t[r]),this._calculateFrameValues(t[r],t[r+1],e);0==a&&(e[0]=t[0].value,this._usedFrames&&(this._usedFrames[t[0].index]=!0)),this._dealKeyFrame(t[r])}_dealKeyFrame(t){t.label&&""!=t.label&&this.addLabel(t.label,t.index)}_calculateFrameValues(t,e,i){var s,r,a=t.index,n=e.index,l=t.value,o=e.value-t.value,h=n-a,u=this._usedFrames;if(n>this._count&&(this._count=n),t.tween)for(null==(r=Sr[t.tweenMethod])&&(r=Sr.linearNone),s=a;s<n;s++)i[s]=r(s-a,l,o,h),u&&(u[s]=!0);else for(s=a;s<n;s++)i[s]=l;u&&(u[t.index]=!0,u[e.index]=!0),i[e.index]=e.value}}class Ir extends Ar{constructor(){super(...arguments),this._nodeIDAniDic={}}_parseNodeList(t){this._nodeList||(this._nodeList=[]),this._nodeDefaultProps[t.compId]=t.props,t.compId&&this._nodeList.push(t.compId);var e=t.child;if(e){var i,s=e.length;for(i=0;i<s;i++)this._parseNodeList(e[i])}}_calGraphicData(t){var e;if(this._setUp(null,t),this._createGraphicData(),this._nodeIDAniDic)for(e in this._nodeIDAniDic)this._nodeIDAniDic[e]=null}_createGraphicData(){var t,e,i=[],s=this.count,r=this._usedFrames;for(r||(r=[]),t=0;t<s;t++)!r[t]&&e||(e=this._createFrameGraphic(t)),i.push(e);this._gList=i}_createFrameGraphic(t){var e=new gr;return Ir._rootMatrix||(Ir._rootMatrix=new G),this._updateNodeGraphic(this._rootNode,t,Ir._rootMatrix,e),e}_updateNodeGraphic(t,e,i,s,r=1){var a,n,l;(a=this._nodeGDic[t.compId]=this._getNodeGraphicData(t.compId,e,this._nodeGDic[t.compId])).resultTransform||(a.resultTransform=new G),n=a.resultTransform,G.mul(a.transform,i,n);var o=a.alpha*r;if(!(o<.01)){a.skin&&(l=this._getTextureByUrl(a.skin))&&(n._checkTransform()?(s.drawTexture(l,0,0,a.width,a.height,n,o),a.resultTransform=null):s.drawTexture(l,n.tx,n.ty,a.width,a.height,null,o));var h,u,d=t.child;if(d)for(u=d.length,h=0;h<u;h++)this._updateNodeGraphic(d[h],e,n,s,o)}}_updateNoChilds(t,e){if(t.skin){var i=this._getTextureByUrl(t.skin);if(i){var s=t.transform;s._checkTransform(),!s._bTransform?e.drawTexture(i,s.tx,s.ty,t.width,t.height,null,t.alpha):e.drawTexture(i,0,0,t.width,t.height,s.clone(),t.alpha)}}}_updateNodeGraphic2(t,e,i){var s;if(s=this._nodeGDic[t.compId]=this._getNodeGraphicData(t.compId,e,this._nodeGDic[t.compId]),t.child){var r,a,n,l=s.transform;l._checkTransform(),a=(r=!l._bTransform)&&(0!=l.tx||0!=l.ty),(n=l._bTransform||1!=s.alpha)&&i.save(),1!=s.alpha&&i.alpha(s.alpha),r?a&&i.translate(l.tx,l.ty):i.transform(l.clone());var o,h,u,d=t.child;if(s.skin&&(o=this._getTextureByUrl(s.skin))&&i.drawImage(o,0,0,s.width,s.height),d)for(u=d.length,h=0;h<u;h++)this._updateNodeGraphic2(d[h],e,i);n?i.restore():r?a&&i.translate(-l.tx,-l.ty):i.transform(l.clone().invert())}else this._updateNoChilds(s,i)}_calculateKeyFrames(t){super._calculateKeyFrames(t),this._nodeIDAniDic[t.target]=t}getNodeDataByID(t){return this._nodeIDAniDic[t]}_getParams(t,e,i,s){var r=Ir._temParam;r.length=e.length;var a,n=e.length;for(a=0;a<n;a++)r[a]=this._getObjVar(t,e[a][0],i,e[a][1],s);return r}_getObjVar(t,e,i,s,r){if(e in t){var a=t[e];return i>=a.length&&(i=a.length-1),t[e][i]}return e in r?r[e]:s}_getNodeGraphicData(t,e,i){i||(i=new Mr),i.transform?i.transform.identity():i.transform=new G;var s=this.getNodeDataByID(t);if(!s)return i;var r,a,n,l=s.frames,o=this._getParams(l,Ir._drawTextureCmd,e,this._nodeDefaultProps[t]),h=o[0],u=o[5],d=o[6],c=o[13],_=o[14],p=o[7],f=o[8],g=o[9],m=o[11],y=o[12];r=o[3],a=o[4],0!=r&&0!=a||(h=null),-1==r&&(r=0),-1==a&&(a=0),i.skin=h,i.width=r,i.height=a,h&&((n=this._getTextureByUrl(h))?(r||(r=n.sourceWidth),a||(a=n.sourceHeight)):console.warn("lost skin:",h,",you may load pics first")),i.alpha=o[10];var T=i.transform;0!=c&&(u=c*r),0!=_&&(d=_*a),0==u&&0==d||T.translate(-u,-d);var x=null;if(g||1!==p||1!==f||m||y){(x=Ir._tempMt).identity(),x._bTransform=!0;var v=.0174532922222222*(g-m),S=.0174532922222222*(g+y),E=Math.cos(S),w=Math.sin(S),D=Math.sin(v),b=Math.cos(v);x.a=p*E,x.b=p*w,x.c=-f*D,x.d=f*b,x.tx=x.ty=0}return x&&(T=G.mul(T,x,T)),T.translate(o[1],o[2]),i}_getTextureByUrl(t){return Bt.getRes(t)}setAniData(t,e=null){if(t.animations){this._nodeDefaultProps={},this._nodeGDic={},this._nodeList&&(this._nodeList.length=0),this._rootNode=t,this._parseNodeList(t);var i,s,r={},a=[],n=t.animations,l=n.length;for(i=0;i<l;i++)if(s=n[i],this._labels=null,(!e||e==s.name)&&s){try{this._calGraphicData(s)}catch(t){console.warn("parse animation fail:"+s.name+",empty animation created"),this._gList=[]}var o={};o.interval=1e3/s.frameRate,o.frames=this._gList,o.labels=this._labels,o.name=s.name,a.push(o),r[s.name]=o}this.animationList=a,this.animationDic=r}Ir._temParam.length=0}parseByData(t){var e,i;e=t.nodeRoot,i=t.aniO,delete t.nodeRoot,delete t.aniO,this._nodeDefaultProps={},this._nodeGDic={},this._nodeList&&(this._nodeList.length=0),this._rootNode=e,this._parseNodeList(e),this._labels=null;try{this._calGraphicData(i)}catch(t){console.warn("parse animation fail:"+i.name+",empty animation created"),this._gList=[]}var s=t;return s.interval=1e3/i.frameRate,s.frames=this._gList,s.labels=this._labels,s.name=i.name,s}setUpAniData(t){if(t.animations){var e,i,s={},r=[],a=t.animations,n=a.length;for(e=0;e<n;e++)if(i=a[e]){var l={};l.name=i.name,l.aniO=i,l.nodeRoot=t,r.push(l),s[i.name]=l}this.animationList=r,this.animationDic=s}}_clear(){this.animationList=null,this.animationDic=null,this._gList=null,this._nodeGDic=null}static parseAnimationByData(t){var e;return Ir._I||(Ir._I=new Ir),e=Ir._I.parseByData(t),Ir._I._clear(),e}static parseAnimationData(t){var e;return Ir._I||(Ir._I=new Ir),Ir._I.setUpAniData(t),(e={}).animationList=Ir._I.animationList,e.animationDic=Ir._I.animationDic,Ir._I._clear(),e}}Ir._drawTextureCmd=[["skin",null],["x",0],["y",0],["width",-1],["height",-1],["pivotX",0],["pivotY",0],["scaleX",1],["scaleY",1],["rotation",0],["alpha",1],["skewX",0],["skewY",0],["anchorX",0],["anchorY",0]],Ir._temParam=[],Ir._tempMt=new G;class Mr{constructor(){this.alpha=1}}class Br extends Cr{constructor(){super(),this._autoPlay=!1,this._setControlNode(this)}destroy(t=!0){if(this.stop(),super.destroy(t),this._atlasCatch)for(let t of this._atlasCatch)t._removeReference(),0==t.referenceCount&&t.destroy();this._atlasCatch=null,this._frames=null,this._labels=null}play(t=0,e=!0,i=""){i&&this._setFramesFromCache(i,!0),super.play(t,e,i)}_setFramesFromCache(t,e=!1){if(this._url&&(t=this._url+"#"+t),t&&Br.framesMap[t]){var i=Br.framesMap[t];return i instanceof Array?(this._frames=Br.framesMap[t],this._count=this._frames.length):(i.nodeRoot&&(Br.framesMap[t]=Ir.parseAnimationByData(i),i=Br.framesMap[t]),this._frames=i.frames,this._count=this._frames.length,this._frameRateChanged||(this._interval=i.interval),this._labels=this._copyLabels(i.labels)),!0}return e&&console.log("ani not found:",t),!1}_copyLabels(t){if(!t)return null;var e,i;for(i in e={},t)e[i]=P.copyArray([],t[i]);return e}_frameLoop(){this._visible&&this._style.alpha>.01&&this._frames&&super._frameLoop()}_displayToIndex(t){this._frames&&(this.graphics=this._frames[t])}get frames(){return this._frames}set frames(t){this._frames=t,t&&(this._count=t.length,this._actionName&&this._setFramesFromCache(this._actionName,!0),this.index=this._index)}get source(){return this._source}set source(t){this._source=t,t?t.indexOf(".ani")>-1?this.loadAnimation(t):t.startsWith("res://")||t.indexOf(".json")>-1||t.indexOf("als")>-1||t.indexOf("atlas")>-1?this.loadAtlas(t):this.loadImages(t.split(",")):this.clear()}set autoPlay(t){this._autoPlay=t,t?this.play():this.stop()}get autoPlay(){return this._autoPlay}clear(){return super.clear(),this.stop(),this.graphics=null,this._frames=null,this._labels=null,this}loadImages(t,e=""){return this._url="",this._setFramesFromCache(e)||(this.frames=Br.framesMap[e]?Br.framesMap[e]:Br.createFrames(t,e)),!this._isPlaying&&this._autoPlay&&this.play(),this}loadAtlas(t,i=null,s=""){if(this._url="",!this._setFramesFromCache(s)){let r=(e,r)=>{null==this._atlasCatch&&(this._atlasCatch=[]),0>this._atlasCatch.indexOf(r)&&(this._atlasCatch.push(r),r._addReference()),t===e&&(this.frames=Br.framesMap[s]?Br.framesMap[s]:Br.createFrames(t,s),!this._isPlaying&&this._autoPlay&&this.play(),i&&i.run())},a=Bt.getAtlas(t);a?r(t,a):e.loader.load(t,St.create(null,r,[t]),null,Bt.ATLAS)}return this}loadAnimation(t,i=null,s=null){this._url=t;return this._actionName||(this._actionName=""),this._setFramesFromCache(this._actionName)?(this._setFramesFromCache(this._actionName,!0),this.index=0,i&&i.run()):!s||Bt.getAtlas(s)?this._loadAnimationData(t,i,s):e.loader.load(s,St.create(this,this._loadAnimationData,[t,i,s]),null,Bt.ATLAS),this}_loadAnimationData(t,i=null,s=null){!s||Bt.getAtlas(s)?e.loader.fetch(t,"json").then((e=>{if(this._url!==t)return;if(!e)return void(Br.framesMap[t+"#"]&&(this._setFramesFromCache(this._actionName,!0),this.index=0,this._resumePlay(),i&&i.run()));let s;if(Br.framesMap[t+"#"])this._setFramesFromCache(this._actionName,!0),this.index=0,this._resumePlay();else{let i=Ir.parseAnimationData(e);if(!i)return;let r,a=i.animationList,n=a.length;for(let e=0;e<n;e++)s=a[e],Br.framesMap[t+"#"+s.name]=s,r||(r=s);r&&(Br.framesMap[t+"#"]=r,this._setFramesFromCache(this._actionName,!0),this.index=0),this._resumePlay()}i&&i.run()})):console.warn("atlas load fail:"+s)}static createFrames(t,e){var i;if("string"==typeof t){var s=Bt.getAtlas(t);if(s&&s.frames.length){let t=s.frames;i=[];for(var r=0,a=t.length;r<a;r++){var n=new gr;n.drawImage(t[r],0,0),i.push(n)}}}else if(t instanceof Array)for(i=[],r=0,a=t.length;r<a;r++)(n=new gr).loadImage(t[r],0,0),i.push(n);return e&&(Br.framesMap[e]=i),i}static clearCache(t){var e,i=Br.framesMap,s=t+"#";for(e in i)e!==t&&0!==e.indexOf(s)||delete Br.framesMap[e]}onAfterDeserialize(){super.onAfterDeserialize(),this.images&&(this._source||this.loadImages(this.images),delete this.images)}}Br.framesMap={};class Lr extends b{static loadFont(t,i){e.loader.load(t,Bt.FONT).then((t=>{i&&i.runWith(t)}))}constructor(){super(!1),this.dict={},this.fontSize=12,this.autoScaleSize=!1,this.tint=!0,this.maxWidth=0,this.lineHeight=12,this.letterSpacing=0}parseFont(t,e){var i;if(null==t||null==e)return;this.texture=e,e._addReference();let s=t.getNode("info");this.fontSize=s.getAttrInt("size",12),this.autoScaleSize=s.getAttrBool("autoScaleSize"),this.lineHeight=s.getAttrInt("lineHeight",this.fontSize),0==this.lineHeight&&(this.lineHeight=this.fontSize);let r=s.getAttrString("padding","").split(",");this.padding=[parseInt(r[0]),parseInt(r[1]),parseInt(r[2]),parseInt(r[3])];let a=(null===(i=t.getNode("chars"))||void 0===i?void 0:i.elements("char"))||[],n=0,l=this.dict;for(let t=0,i=a.length;t<i;t++){let i=a[t],s=i.getAttrInt("id"),r=i.getAttrInt("xoffset")/1,o=i.getAttrInt("yoffset")/1,h=i.getAttrInt("xadvance")/1,u=i.getAttrInt("x"),d=i.getAttrInt("y"),c=i.getAttrInt("width"),_=i.getAttrInt("height"),p=mt.create(e,u,d,c,_,r,o);0==h&&(h=c),h+=this.letterSpacing,n=Math.max(n,h),l[s]={x:0,y:0,width:c,height:_,advance:h,texture:p}}this.maxWidth=n>0?n:this.fontSize,l[32]||(l[32]={x:0,y:0,advance:Math.floor(.5*this.fontSize)+this.letterSpacing})}_disposeResource(){var t;if(this.texture){for(let e in this.dict)null===(t=this.dict[e].texture)||void 0===t||t.destroy();this.texture._removeReference(),this.dict=null,this.texture=null,this.padding=null}}getTextWidth(t,e){let i=0;for(let s=0,r=t.length;s<r;s++){let r=this.dict[t.charCodeAt(s)];if(r){let t=this.autoScaleSize?e/this.fontSize:1;i+=Math.round(r.advance*t)}}return i}getMaxWidth(t){return null!=t&&this.autoScaleSize?Math.round(this.maxWidth*(t/this.fontSize)):this.maxWidth}getMaxHeight(t){return null!=t&&this.autoScaleSize?Math.round(this.lineHeight*(t/this.fontSize)):this.lineHeight}}class Pr extends Ar{constructor(){super(...arguments),this._initData={}}get target(){return this._target}set target(t){this._target&&this._target.off(Pr.EFFECT_BEGIN,this,this._onOtherBegin),this._target=t,this._target&&this._target.on(Pr.EFFECT_BEGIN,this,this._onOtherBegin),this._addEvent()}_onOtherBegin(t){t!==this&&this.stop()}set playEvent(t){this._playEvent=t,t&&this._addEvent()}_addEvent(){this._target&&this._playEvent&&(this._setControlNode(this._target),this._target.on(this._playEvent,this,this._onPlayAction))}_onPlayAction(){this.play(0,!1)}play(t=0,e=!0,i=""){this._target&&(this._target.event(Pr.EFFECT_BEGIN,[this]),this._recordInitData(),super.play(t,e,i))}_recordInitData(){var t,e,i;if(this._aniKeys)for(e=this._aniKeys.length,t=0;t<e;t++)i=this._aniKeys[t],this._initData[i]=this._target[i]}set effectClass(t){if(this._effectClass=Ot.getClass(t),this._effectClass){var e=this._effectClass.uiView;if(e){var i=e.animations;if(i&&i[0]){var s=i[0];this._setUp({},s),s.nodes&&s.nodes[0]&&(this._aniKeys=s.nodes[0].keys)}}}}set effectData(t){if(t){var e=t.animations;if(e&&e[0]){var i=e[0];this._setUp({},i),i.nodes&&i.nodes[0]&&(this._aniKeys=i.nodes[0].keys)}}}_displayToIndex(t){if(this._animationData){t<0&&(t=0),t>this._count&&(t=this._count);var e,i=this._animationData.nodes,s=i.length;for(s=s>1?1:s,e=0;e<s;e++)this._displayNodeToFrame(i[e],t)}}_displayNodeToFrame(t,e,i=null){if(this._target){var s,r,a,n,l,o,h,u,d,c=this._target,_=t.frames,p=t.keys,f=p.length,g=t.secondFrames;for(n=0;n<f;n++)r=_[s=p[n]],-1==(l=g[s])?a=this._initData[s]:e<l?(u=(h=t.keyframes[s])[0]).tween?(null==(o=Sr[u.tweenMethod])&&(o=Sr.linearNone),d=h[1],a=o(e,this._initData[s],d.value-this._initData[s],d.index)):a=this._initData[s]:a=r.length>e?r[e]:r[r.length-1],c[s]=a}}_calculateKeyFrames(t){super._calculateKeyFrames(t);var e,i,s=t.keyframes;t.target;var r={};for(e in t.secondFrames=r,s)(i=s[e]).length<=1?r[e]=-1:r[e]=i[1].index}}Pr.EFFECT_BEGIN="effectbegin";class Nr{constructor(){this.font="",this.fontSize=12,this.color="#000000",this.bold=!1,this.italic=!1,this.underline=!1,this.underlineColor=null,this.strikethrough=!1,this.strikethroughColor=null,this.align="left",this.valign="top",this.leading=2,this.stroke=0,this.strokeColor="#000000",this.font="",this.fontSize=12,this.color="#000000",this.bold=!1,this.italic=!1,this.underline=!1,this.underlineColor=null,this.align="left",this.valign="top",this.alignItems="middle",this.leading=2,this.stroke=0,this.strokeColor="#000000"}}var Or;t.HtmlElementType=void 0,(Or=t.HtmlElementType||(t.HtmlElementType={}))[Or.Text=0]="Text",Or[Or.Link=1]="Link",Or[Or.Image=2]="Image",Or[Or.Input=3]="Input",Or[Or.Select=4]="Select",Or[Or.Object=5]="Object",Or[Or.LinkEnd=6]="LinkEnd";class Fr{constructor(){this.style=new Nr}getAttr(t){return null==this._attrs?null:this._attrs[t]}setAttr(t,e){null==this._attrs&&(this._attrs={}),this._attrs[t]=e}getAttrString(t,e){return wt.getString(this._attrs,t,e)}getAttrInt(t,e){return wt.getInt(this._attrs,t,e)}getAttrFloat(t,e){return wt.getFloat(this._attrs,t,e)}getAttrBool(t,e){return wt.getBool(this._attrs,t,e)}fetchAttributes(){this._attrs=Object.assign({},bt.attributes)}reset(){this.name=null,this.text=null,this.obj&&(this.obj.release(),i.recoverByClass(this.obj),this.obj=null),this._attrs=null}static getFromPool(e){let i;return i=this.pool.length>0?this.pool.pop():new Fr,i.type=e,i.type==t.HtmlElementType.Text||i._attrs||(i._attrs={}),i}static returnToPool(t){if(Array.isArray(t)){for(let e of t)e.reset();this.pool.push(...t),t.length=0}else t.reset(),this.pool.push(t)}}Fr.pool=[];class Ur{constructor(){this.obj=new br}get element(){return this._element}get width(){return this.obj.width}get height(){return this.obj.height}create(t,e){this._owner=t,this._element=e,this._owner.objContainer.addChild(this.obj);let i=this._element.getAttrString("src");i&&this.loadTexture(i)}loadTexture(t){let i=this._element.getAttrInt("width",-1),s=this._element.getAttrInt("height",-1);-1!=i&&(this.obj.width=i),-1!=s&&(this.obj.height=s);let r=Bt.getRes(t);r?(this.obj.texture=r,-1==i&&(this.obj.width=r.sourceWidth),-1==s&&(this.obj.height=r.sourceHeight)):e.loader.load(t,{silent:!0}).then((t=>{if(this.obj.destroyed)return;let e=this.obj.width,r=this.obj.height;this.obj.texture=t,-1==i&&(this.obj.width=t?t.sourceWidth:0),-1==s&&(this.obj.height=t?t.sourceHeight:0),!this._owner||e==this.obj.width&&r==this.obj.height||this._owner.refreshLayout()}))}pos(t,e){this.obj.pos(t,e)}release(){this.obj.removeSelf(),this.obj.offAll(),this.obj.texture=null,this._owner=null,this._element=null}destroy(){this.obj.destroy()}}class kr{constructor(){this._shape=new br,this._shape.hitArea=this,this._shape.on(r.CLICK,(()=>{this._owner.bubbleEvent(r.LINK,this._element.getAttrString("href"))})),this._rects=[],this._rectCnt=0}get element(){return this._element}get width(){return 0}get height(){return 0}create(t,e){this._owner=t,this._element=e,this._owner.objContainer.addChild(this._shape)}resetArea(){this._rectCnt=0}addRect(t,e,i,s){let r=this._rects[this._rectCnt];r||(r=this._rects[this._rectCnt]=new F),this._rectCnt++,r.setTo(t,e,i,s)}contains(t,e){for(let i=0;i<this._rectCnt;i++)if(this._rects[i].contains(t,e))return!0;return!1}pos(t,e){}release(){this._shape.removeSelf(),this._owner=null,this._element=null}destroy(){this._shape.destroy()}}class Gr{constructor(){this.linkUnderline=Gr.defaultLinkUnderline,this.linkColor=Gr.defaultLinkColor}}Gr.defaultLinkUnderline=!0,Gr.defaultLinkColor=null,Ot.regClass("HtmlParseOptions",Gr);const Vr=new Array,Hr=new Array;class zr{constructor(){this._styleStack=new Array,this._style=new Nr,this._options=new Gr}parse(e,i,s,r){null==r&&(r=this._options),this._elements=s,this._styleStackTop=0,Object.assign(this._style,i),this._style.colorChanged=!1;let a,n=0,l=r.ignoreWhiteSpace,o=!1;for(bt.begin(e,!0);bt.nextTag();)switch(0==n&&(a=bt.getText(l),a.length>0&&(o&&"\n"==a[0]&&(a=a.substring(1)),this.appendText(a))),o=!1,bt.tagName){case"b":bt.tagType==t.XMLTagType.Start?(this.pushStyle(),this._style.bold=!0):this.popStyle();break;case"i":bt.tagType==t.XMLTagType.Start?(this.pushStyle(),this._style.italic=!0):this.popStyle();break;case"u":bt.tagType==t.XMLTagType.Start?(this.pushStyle(),this._style.underline=!0):this.popStyle();break;case"strike":bt.tagType==t.XMLTagType.Start?(this.pushStyle(),this._style.strikethrough=!0):this.popStyle();break;case"font":if(bt.tagType==t.XMLTagType.Start){this.pushStyle(),this._style.fontSize=wt.getInt(bt.attributes,"size",this._style.fontSize);let t=bt.getAttribute("color");null!=t&&(this._style.color=t,this._style.colorChanged=!0)}else bt.tagType==t.XMLTagType.End&&this.popStyle();break;case"br":this.appendText("\n");break;case"img":if(bt.tagType==t.XMLTagType.Start||bt.tagType==t.XMLTagType.Void){let e=Fr.getFromPool(t.HtmlElementType.Image);e.fetchAttributes(),e.name=e.getAttrString("name"),e.style.align=this._style.align,e.style.underline=this._style.underline,e.style.underlineColor=this._style.underlineColor,this._elements.push(e)}break;case"a":if(bt.tagType==t.XMLTagType.Start){this.pushStyle(),this._style.underline=this._style.underline||r.linkUnderline,this._style.colorChanged||null==r.linkColor||(this._style.color=r.linkColor);let e=Fr.getFromPool(t.HtmlElementType.Link);e.fetchAttributes(),e.name=e.getAttrString("name"),e.style.align=this._style.align,this._elements.push(e)}else if(bt.tagType==t.XMLTagType.End){this.popStyle();let e=Fr.getFromPool(t.HtmlElementType.LinkEnd);this._elements.push(e)}break;case"input":{let e=Fr.getFromPool(t.HtmlElementType.Input);e.fetchAttributes(),e.name=e.getAttrString("name"),Object.assign(e.style,this._style),this._elements.push(e)}break;case"select":if(bt.tagType==t.XMLTagType.Start||bt.tagType==t.XMLTagType.Void){let e=Fr.getFromPool(t.HtmlElementType.Select);if(e.fetchAttributes(),bt.tagType==t.XMLTagType.Start){for(Vr.length=0,Hr.length=0;bt.nextTag()&&"select"!=bt.tagName;)"option"==bt.tagName&&(bt.tagType==t.XMLTagType.Start||bt.tagType==t.XMLTagType.Void?Hr.push(wt.getString(bt.attributes,"value","")):Vr.push(bt.getText()));e.setAttr("items",Vr.slice()),e.setAttr("values",Hr.slice())}e.name=e.getAttrString("name"),Object.assign(e.style,this._style),this._elements.push(e)}break;case"p":bt.tagType==t.XMLTagType.Start?(this.pushStyle(),this._style.align=bt.getAttribute("align"),this.isNewLine()||this.appendText("\n")):bt.tagType==t.XMLTagType.End&&(this.appendText("\n"),o=!0,this.popStyle());break;case"ui":case"div":case"li":bt.tagType==t.XMLTagType.Start?this.isNewLine()||this.appendText("\n"):(this.appendText("\n"),o=!0);break;case"html":case"body":l=!0;break;case"head":case"style":case"script":case"form":bt.tagType==t.XMLTagType.Start?n++:bt.tagType==t.XMLTagType.End&&n--}0==n&&(a=bt.getText(l),a.length>0&&(o&&"\n"==a[0]&&(a=a.substring(1)),this.appendText(a))),this._elements=null}pushStyle(){let t;this._styleStack.length<=this._styleStackTop?(t=new Nr,this._styleStack.push(t)):t=this._styleStack[this._styleStackTop],Object.assign(t,this._style),this._styleStackTop++}popStyle(){if(this._styleStackTop>0){let t=this._styleStack[this._styleStackTop-1];Object.assign(this._style,t),this._styleStackTop--}}isNewLine(){if(this._elements.length>0){let e=this._elements[this._elements.length-1];return!(!e||e.type!=t.HtmlElementType.Text)&&e.text.endsWith("\n")}return!0}appendText(e){let i;this._elements.length>0&&(i=this._elements[this._elements.length-1],i.type==t.HtmlElementType.Text&&function(t,e){for(let i in t)if(!i.startsWith("_")&&t[i]!=e[i])return!1;return!0}(i.style,this._style))?i.text+=e:(i=Fr.getFromPool(t.HtmlElementType.Text),i.text=e,Object.assign(i.style,this._style),this._elements.push(i))}}zr.defaultParser=new zr,zr.classMap={[t.HtmlElementType.Image]:Ur,[t.HtmlElementType.Link]:kr};class Wr{constructor(){this._readPos=0,this.defaultImgWidth=0,this.defaultImgHeight=0,this._handlers={},this._handlers.url=this.onTag_URL,this._handlers.img=this.onTag_IMG,this._handlers.b=this.onTag_B,this._handlers.i=this.onTag_I,this._handlers.u=this.onTag_U,this._handlers.sup=this.onTag_Simple,this._handlers.sub=this.onTag_Simple,this._handlers.color=this.onTag_COLOR,this._handlers.font=this.onTag_FONT,this._handlers.size=this.onTag_SIZE}onTag_URL(t,e,i){return e?"</a>":null!=i?'<a href="'+i+'">':'<a href="'+this.getTagText()+'">'}onTag_IMG(t,e,i){if(e)return null;var s=this.getTagText(!0);return s?this.defaultImgWidth?'<img src="'+s+'" width="'+this.defaultImgWidth+'" height="'+this.defaultImgHeight+'"/>':'<img src="'+s+'"/>':null}onTag_B(t,e,i){return e?"</b>":"<b>"}onTag_I(t,e,i){return e?"</i>":"<i>"}onTag_U(t,e,i){return e?"</u>":"<u>"}onTag_Simple(t,e,i){return e?"</"+t+">":"<"+t+">"}onTag_COLOR(t,e,i){return e?"</font>":(this.lastColor=i,'<font color="'+i+'">')}onTag_FONT(t,e,i){return e?"</font>":'<font face="'+i+'">'}onTag_SIZE(t,e,i){return e?"</font>":(this.lastSize=i,'<font size="'+i+'">')}getTagText(t){for(var e,i=this._readPos,s="";-1!=(e=this._text.indexOf("[",i));){if(92!=this._text.charCodeAt(e-1)){s+=this._text.substring(i,e);break}s+=this._text.substring(i,e-1),s+="[",i=e+1}return-1==e?null:(t&&(this._readPos=e),s)}parse(t,e){this._text=t,this.lastColor=null,this.lastSize=null;for(var i,s,r,a,n,l,o,h=0,u="";-1!=(i=t.indexOf("[",h));)if(i>0&&92==t.charCodeAt(i-1))u+=t.substring(h,i-1),u+="[",h=i+1;else{if(u+=t.substring(h,i),h=i,-1==(i=t.indexOf("]",h)))break;r="/"==t.charAt(h+1),a=t.substring(r?h+2:h+1,i),this._readPos=i+1,n=null,l=null,-1!=(s=a.indexOf("="))&&(n=a.substring(s+1),a=a.substring(0,s)),a=a.toLowerCase(),null!=(o=this._handlers[a])?e||null!=(l=o.call(this,a,r,n))&&(u+=l):u+=t.substring(h,this._readPos),h=this._readPos}return h<t.length&&(u+=t.substring(h)),this._text=null,u}}Wr.defaultParser=new Wr;class Yr extends br{constructor(){super(),this._overflow=Yr.VISIBLE,this._singleCharRender=!1,this._prompt="",this._textWidth=0,this._textHeight=0,this._textStyle=new Nr,this._textStyle.fontSize=f.defaultFontSize,this._text="",this.font="",this._elements=[],this._lines=[],this._padding=[0,0,0,0],this._fontSizeScale=1}static registerBitmapFont(t,e){e._addReference(),Yr._bitmapFonts[t]=e}static unregisterBitmapFont(t,e=!0){let i=Yr._bitmapFonts[t];i&&(i._removeReference(),e&&i.destroy(),delete Yr._bitmapFonts[t])}destroy(t=!0){qr(this._lines),Fr.returnToPool(this._elements),super.destroy(t)}_getBoundPointsM(t=!1){var e=F.TEMP;return e.setTo(0,0,this.width,this.height),e._getBoundPoints()}getGraphicBounds(t=!1){var e=F.TEMP;return e.setTo(0,0,this.width,this.height),e}get_width(){return this._isWidthSet?this._width:this.textWidth}_setWidth(t){super._setWidth(t),this._updatingLayout?this.drawBg():this.markChanged()}get_height(){return this._isHeightSet?this._height:this.textHeight}_setHeight(t){super._setHeight(t),this._updatingLayout?this.drawBg():this.markChanged()}get textWidth(){return this.typeset(),this._textWidth}get textHeight(){return this.typeset(),this._textHeight}get text(){return this._text}set text(t){null==t?t="":"string"!=typeof t&&(t=""+t),!this.ignoreLang&&Yr.langPacks&&(t=Yr.langPacks[t]||t),this._text!=t&&(this._text=t,this.markChanged(),this.event(r.CHANGE))}changeText(t){this.text=t}get font(){return this._textStyle.font}set font(t){if(this._textStyle.font=t,t||(t=f.defaultFont)||(t="Arial"),this._realFont=t,this._bitmapFont=Yr._bitmapFonts[t],this._bitmapFont)this._text&&this.markChanged();else if(t&&(P.getFileExtension(t)||t.startsWith("res://"))){let i=t,s=e.loader.getRes(t);!s||s.obsolute?e.loader.load(t).then((t=>{t&&this._realFont==i&&(t instanceof Lr?this._bitmapFont=t:this._realFont=t.family,this._text&&this.markChanged())})):(s instanceof Lr?this._bitmapFont=s:this._realFont=s.family,this._text&&this.markChanged())}else this._realFont=A.onIPhone&&f.fontFamilyMap[t]||t,this._text&&this.markChanged()}get fontSize(){return this._textStyle.fontSize}set fontSize(t){this._textStyle.fontSize!=t&&(this._textStyle.fontSize=t,this.markChanged())}get color(){return this._textStyle.color}set color(t){this.set_color(t)}set_color(t){this._textStyle.color!=t&&(this._textStyle.color=t,!this._isChanged&&this._graphics&&0==this._elements.length?this._graphics.replaceTextColor(this._textStyle.color):this.markChanged())}get bold(){return this._textStyle.bold}set bold(t){this._textStyle.bold!=t&&(this._textStyle.bold=t,this.markChanged())}get italic(){return this._textStyle.italic}set italic(t){this._textStyle.italic!=t&&(this._textStyle.italic=t,this.markChanged())}get align(){return this._textStyle.align}set align(t){this._textStyle.align!=t&&(this._textStyle.align=t,this.markChanged())}get valign(){return this._textStyle.valign}set valign(t){this._textStyle.valign!=t&&(this._textStyle.valign=t,this.markChanged())}get alignItems(){return this._textStyle.alignItems}set alignItems(t){this._textStyle.alignItems!=t&&(this._textStyle.alignItems=t,this.markChanged())}get wordWrap(){return this._wordWrap}set wordWrap(t){this._wordWrap!=t&&(this._wordWrap=t,this.markChanged())}get leading(){return this._textStyle.leading}set leading(t){this._textStyle.leading!=t&&(this._textStyle.leading=t,this.markChanged())}get padding(){return this._padding}set padding(t){if("string"==typeof t){let e=t.split(",");this._padding.length=0;for(let t=0;t<4;t++){let i=parseFloat(e[t]);isNaN(i)&&(i=0),this._padding.push(i)}}else this._padding=t;this.markChanged()}get bgColor(){return this._bgColor}set bgColor(t){this._bgColor=t,this.drawBg()}get borderColor(){return this._borderColor}set borderColor(t){this._borderColor=t,this.drawBg()}get stroke(){return this._textStyle.stroke}set stroke(t){this._textStyle.stroke!=t&&(this._textStyle.stroke=t,this.markChanged())}get strokeColor(){return this._textStyle.strokeColor}set strokeColor(t){this._textStyle.strokeColor!=t&&(this._textStyle.strokeColor=t,this.markChanged())}get overflow(){return this._overflow}set overflow(t){this._overflow!=t&&(this._overflow=t,this.markChanged())}get underline(){return this._textStyle.underline}set underline(t){this._textStyle.underline!=t&&(this._textStyle.underline=t,this.markChanged())}get underlineColor(){return this._textStyle.underlineColor}set underlineColor(t){this._textStyle.underlineColor!=t&&(this._textStyle.underlineColor=t,this.markChanged())}get strikethrough(){return this._textStyle.strikethrough}set strikethrough(t){this._textStyle.strikethrough!=t&&(this._textStyle.strikethrough=t,this.markChanged())}get strikethroughColor(){return this._textStyle.strikethroughColor}set strikethroughColor(t){this._textStyle.strikethroughColor!=t&&(this._textStyle.strikethroughColor=t,this.markChanged())}get singleCharRender(){return this._singleCharRender}set singleCharRender(t){this._singleCharRender=t}get html(){return this._html}set html(t){this._html!=t&&(this._html=t,this.markChanged())}get ubb(){return this._ubb}set ubb(t){this._ubb!=t&&(this._ubb=t,this.markChanged())}get maxWidth(){return this._maxWidth}set maxWidth(t){this._maxWidth!=t&&(this._maxWidth=t,this.markChanged())}get htmlParseOptions(){return this._htmlParseOptions}set htmlParseOptions(t){this._htmlParseOptions=t}parseTemplate(t){let e,i,s,r,a=0,n="";for(;-1!=(e=t.indexOf("{",a));)if(e>0&&92==t.charCodeAt(e-1))n+=t.substring(a,e-1),n+="{",a=e+1;else{if(n+=t.substring(a,e),a=e,e=t.indexOf("}",a),-1==e)break;e!=a+1?(s=t.substring(a+1,e),i=s.indexOf("="),-1!=i?(r=this._templateVars[s.substring(0,i)],n+=null==r?s.substring(i+1):r):(r=this._templateVars[s],null!=r&&(n+=r)),a=e+1):(n+=t.substring(a,a+2),a=e+1)}return a<t.length&&(n+=t.substring(a)),n}get templateVars(){return this._templateVars}set templateVars(t){(this._templateVars||t)&&(this._templateVars=!0===t?{}:!1===t?null:t,this.markChanged())}setVar(t,e){return this._templateVars||(this._templateVars={}),this._templateVars[t]=e,this.markChanged(),this}get scrollX(){return this._scrollPos?this._scrollPos.x:0}set scrollX(t){if(this.typeset(),!this._scrollPos)return;let e=this.maxScrollX;t=(t=t<0?0:t)>e?e:t,this._scrollPos.x=t,this.renderText()}get scrollY(){return this._scrollPos?this._scrollPos.y:0}set scrollY(t){if(this.typeset(),!this._scrollPos)return;let e=this.maxScrollY;t=(t=t<0?0:t)>e?e:t,this._scrollPos.y=t,this.renderText()}get maxScrollX(){let t=this.textWidth-this._width;return t<0?0:t}get maxScrollY(){let t=this.textHeight-this._height;return t<0?0:t}get lines(){return this.typeset(),this._lines}markChanged(){this._isChanged||(this._isChanged=!0,e.systemTimer.callLater(this,this._typeset))}typeset(){this._isChanged&&e.systemTimer.runCallLater(this,this._typeset)}refreshLayout(){e.systemTimer.callLater(this,this.doLayout)}get objContainer(){return this._objContainer||(this._objContainer=new br,this._objContainer.hideFlags|=Gt.HideAndDontSave,this.addChild(this._objContainer)),this._objContainer}_typeset(){if(this._isChanged=!1,this._hideText||this._destroyed)return;Fr.returnToPool(this._elements),this._objContainer&&this._objContainer.removeChildren();let e,i=this._text;if(!i&&this._prompt&&(i=this._prompt,e=!0),!i)return this.graphics.clear(!0),this.drawBg(),this._textWidth=this._textHeight=0,this._scrollPos=null,void(this._onPostLayout&&(this._updatingLayout=!0,this._onPostLayout(),this._updatingLayout=!1));let s,r=this._html;if(i=i.replace(Zr,"\n"),this._parseEscapeChars&&(i=i.replace(Jr,sa)),!e&&this._templateVars&&(i=this.parseTemplate(i)),this._ubb&&(i=Wr.defaultParser.parse(i),r=!0),!e&&this._asPassword&&(i=Yr._passwordChar.repeat(i.length)),e&&(s=this._textStyle.color,this._textStyle.color=this._promptColor),r)zr.defaultParser.parse(i,this._textStyle,this._elements,this._htmlParseOptions);else{let e=Fr.getFromPool(t.HtmlElementType.Text);Object.assign(e.style,this._textStyle),e.text=i,this._elements.push(e)}e&&(this._textStyle.color=s),this.doLayout()}doLayout(){if(this._destroyed)return;this._updatingLayout=!0,this._fontSizeScale=1;let e,r=this._wordWrap||this._overflow==Yr.ELLIPSIS,a=this._padding;if(e=this._isWidthSet?this._width-a[3]-a[1]:Number.MAX_VALUE,this._maxWidth>0){let t=this._maxWidth-a[3]-a[1];(!r||t<e)&&(e=t),r=!0}let n,l,o,h,u,d,c,_,p=this._isHeightSet?this._height-a[0]-a[2]:Number.MAX_VALUE,f=this._bitmapFont,g="middle"==this._textStyle.alignItems?1:"bottom"==this._textStyle.alignItems?2:0,m=t=>{if(f)return f.getTextWidth(t,c);{let e=A.context.measureText(t);return e?e.width:100}},y=(t,e)=>{if(f)return f.getTextWidth(t,e.fontSize);{let i=A.context.font;A.context.font=e.ctxFont;let s=A.context.measureText(t);return A.context.font=i,s?s.width:100}},T=(t,e)=>{if(c=Math.floor(e.fontSize*this._fontSizeScale),0==c&&(c=1),f)u=f.getMaxWidth(c),d=f.getMaxHeight(c);else{A.context.font=_=(e.italic?"italic ":"")+(e.bold?"bold ":"")+c+"px "+this._realFont;let t=A.context.measureText(Yr._testWord);t?(u=t.width,d=Math.ceil(t.height||c)):(u=100,d=c)}let i=t.split("\n");if(r)for(let t=0,s=i.length;t<s;t++){let r=i[t];r.length>0&&w(r,e),t!=s-1&&E()}else for(let t=0,s=i.length;t<s;t++){let r=i[t];r.length>0&&x(r,e,null),t!=s-1&&E()}},x=(t,e,i)=>{let s=Xr.length>0?Xr.pop():{};s.x=n,s.y=l,"string"==typeof t?(i||(i=m(t)),s.wt||(s.wt=new Zi),s.wt.setText(t),s.wt.width=i,s.wt.splitRender=this._singleCharRender,s.ctxFont=_,s.fontSize=c,s.width=i,s.height=d):(s.obj=t,s.width=t.width,s.height=t.height,t.width>0&&(s.x++,s.width+=2)),s.style=e,s.linkEnd=!1,s.next=null,s.prev=h,n+=Math.round(s.width),h?h.next=s:o.cmd=s,h=s},v=t=>{for(;t.linkEnd;)t=t.next;if(t)for(t.prev.next=null;t;){let e=t.next;t.x=n,t.y=l,t.next=null,t.prev=h,n+=Math.round(t.width),h?h.next=t:o.cmd=t,h=t,t=e}},S=(t,e)=>{if(aa(t.wt.text.charCodeAt(e))&&e--,0==e)return!1;let i=t.wt.text.substring(e);t.wt.setText(t.wt.text.substring(0,e)),t.width=t.wt.width=y(t.wt.text,t);let s=Xr.length>0?Xr.pop():{};return s.wt||(s.wt=new Zi),s.wt.setText(i),s.style=t.style,s.ctxFont=t.ctxFont,s.fontSize=t.fontSize,s.width=s.wt.width=y(i,t),s.height=t.height,s.next=t.next,s.prev=t,t.next=s,!0},E=t=>{if(n=0,o){let t=0,e=0,i=o.cmd;for(;i;)i.height>t&&(t=i.height),e+=i.width,i=i.next;for(i=o.cmd;i;)i.y=1==g?Math.floor(.5*(t-i.height)):2==g?Math.floor(t-i.height):0,i=i.next;0==t&&(t=d),t++,o.height=t,o.width=Math.round(e),l+=o.height+Math.floor(this._textStyle.leading*this._fontSizeScale)}return t?null:(o=jr.length>0?jr.pop():{},o.x=0,o.y=l,this._lines.push(o),h=null,o)},w=(t,i)=>{let s=Math.max(0,e-n),r=m(t);if(r<=s)return void x(t,i,r);let a,l,o=0,d=0,c=0,_=$r.test(t);f||_||(o=Math.floor(s/u),0!=o&&(d=m(t.substring(0,o))));let p=t.length;for(let u=o;u<p;u++){let f=t.charAt(u),g=f.charCodeAt(0);if(_&&ra(g)&&u+1<p&&(f+=t.charAt(u+1)),r=m(f),d+=r,d<s||u===c&&0===n){f.length>1&&u++;continue}let y=t.substring(c,u);if(d-=r,g>=65&&g<=90||g>=97&&g<=122||g>=48&&g<=57||(a=Qr.includes(g))){let i=y.length>0?(l=Kr.exec(y))?l.index:null:0;if(i>0)i>y.length-ia&&(u=c+i,y=t.substring(c,u),d=null,r=null);else if(null!=i&&null!=h){let t=h,i=y.length,o=!1;for(;t;){if(t.width>0){if(null!=t.obj)break;l=Kr.exec(t.wt.text);let e=t.wt.text.length;if(null==l){E(),a&&0==i?S(t,e-1)?v(t.next):t.x>0&&v(t):null!=t.next&&v(t.next),o=!0;break}if(l.index>0){l.index>e-(ia-i)&&(E(),S(t,l.index),v(t.next),o=!0);break}if(i+=e,i>=ia)break}t=t.prev}if(o&&(s=e-n,d+r<s)){d+=r;continue}}else if(a){let e=_&&u>=1&&aa(t.charCodeAt(u-1))?2:1;(u-e>c||n>0)&&(u-=e,y=t.substring(c,u),d=null,r=null)}}y.length>0&&x(y,i,d),E(),c=u,s=e,d=null,o>1?u+=o-1:null!=r?(d=r,f.length>1&&u++):_&&ra(t.charCodeAt(u))&&u++,null==d&&u<p-1&&(d=m(t.substring(c,u+1)))}x(t.substring(c,p),i)},D=()=>{let t=0,e=0;for(let e of this._lines)e.width>t&&(t=e.width);t>0&&(t+=a[1]+a[3]),this._textWidth=t;let i=this._lines[this._lines.length-1];i&&(e=i.y+i.height),e>0&&(e+=a[0]+a[2]),this._textHeight=e},b=()=>{n=l=u=d=0,o=null,h=null,qr(this._lines),E();let s=this._elements;for(let a=0,l=s.length;a<l;a++){let l=s[a];if(l.type==t.HtmlElementType.Text)T(l.text,l.style);else if(l.type==t.HtmlElementType.LinkEnd)h&&(h.linkEnd=!0);else{let t=l.obj;if(!t){let e=zr.classMap[l.type];e&&(t=i.createByClass(e),t.create(this,l),l.obj=t)}if(t){if(r){let i=e-n;t.width>0&&i<t.width+1&&n>0&&E()}x(t,l.style)}}}E(!0),D()};if(b(),this._overflow==Yr.SHRINK){if(this._lines.length>1&&this._textHeight>p){let t=0,i=this._textStyle.fontSize;this._fontSizeScale=Math.sqrt(p/this._textHeight);let s=Math.floor(this._fontSizeScale*this._textStyle.fontSize);for(;b(),this._textWidth>e||this._textHeight>p?i=s:t=s,i-t>1||i!=t&&s==i;)s=t+(i-t)/2,this._fontSizeScale=s/this._textStyle.fontSize}else if(this._textWidth>e&&(this._fontSizeScale=e/this._textWidth,b(),this._textWidth>e)){let t=Math.floor(this._textStyle.fontSize*this._fontSizeScale);t--,this._fontSizeScale=t/this._textStyle.fontSize,b()}}else if(this._overflow==Yr.ELLIPSIS&&(this._textWidth>e||this._textHeight>p)){let t=this._lines.findIndex((t=>t.y+t.height>p));0==t&&(t=1);let i=!1;-1!=t&&this._lines.length>t&&(qr(this._lines.splice(t,this._lines.length-t)),i=!0);let s,r=this._lines[this._lines.length-1].cmd,a=!1;for(;r;)s=r.next,a?(r.obj?r.obj=null:r.wt&&r.wt.cleanCache(),Xr.push(r)):(!s&&i||r.x+r.width>e)&&(r.obj&&(r.obj=null),r.wt||(r.wt=new Zi),r.wt.setText(r.wt.text.substring(0,Math.max(0,r.wt.text.length-2))+ea),c=r.style.fontSize,r.width=r.wt.width=m(r.wt.text),r.wt.splitRender=this._singleCharRender,r.next=null,a=!0),r=s;a&&D()}this._onPostLayout&&this._onPostLayout();let C="center"==this._textStyle.align?1:"right"==this._textStyle.align?2:0;if(0!=C&&this._isWidthSet){let t=this._width-a[3]-a[1];for(let e of this._lines){let i=0;1==C?i=Math.floor(.5*(t-e.width)):2==C&&(i=t-e.width),i>0&&(e.x=i)}}if(this._isHeightSet&&this._textHeight<this._height){let t=0;if("middle"===this._textStyle.valign?t=Math.floor(.5*(this._height-this._textHeight)):"bottom"===this._textStyle.valign&&(t=this._height-this._textHeight),t>0)for(let e of this._lines)e.y+=t}if(this._overflow==Yr.SCROLL&&(this._isWidthSet&&this._textWidth>this._width||this._isHeightSet&&this._textHeight>this._height))if(this._scrollPos){let t=this.maxScrollX,e=this.maxScrollY;this._scrollPos.x>t&&(this._scrollPos.x=t),this._scrollPos.y>e&&(this._scrollPos.y=e)}else this._scrollPos=new s(0,0);else this._scrollPos=null;this._objContainer&&(this._objContainer.size(this._width,this._height),this._scrollPos||this._overflow==Yr.HIDDEN&&this._objContainer.numChildren>0?(this._objContainer.scrollRect||(this._objContainer.scrollRect=new F),this._objContainer.scrollRect.setTo(0,0,this._width,this._height)):this._objContainer.scrollRect=null),this._updatingLayout=!1,this.renderText()}renderText(){let e=this.graphics;e.clear(!0),this.drawBg();let i=this._padding,s=i[3],r=i[0],a=this._bitmapFont,n=this._scrollPos,l=this._isWidthSet?this._width:this._textWidth,o=this._isHeightSet?this._height:this._textHeight,h=o-i[2],u=this._overflow==Yr.HIDDEN||this._overflow==Yr.SCROLL;u&&(e.save(),e.clipRect(0,0,l,o),this.repaint()),l-=i[3]+i[1],o-=i[0]+i[2];let d,c,_=0,p=0,f=this._lines,g=f.length;for(let i=0;i<g;i++){let o=f[i];_=s+o.x,p=r+o.y,n&&(_-=n.x,p-=n.y);let g=u&&(p+o.height<=r||p>=h),m=o.cmd;for(;m;){if(m.linkEnd&&d&&(d.addRect(c,p,_+m.x+m.width-c,o.height),d=null),m.obj)m.obj.pos(_+m.x,p+m.y),m.obj.element.type==t.HtmlElementType.Link&&(d=m.obj,d.resetArea(),c=_+m.x);else if(!g)if(a){let t=0,i=m.wt.text,s=a.tint?m.style.color:"#FFFFFF",r=Math.floor((a.autoScaleSize?m.style.fontSize:a.fontSize)*this._fontSizeScale)/a.fontSize;for(let n=0,l=i.length;n<l;n++){let l=i.charCodeAt(n),o=a.dict[l];o&&(o.texture&&e.drawImage(o.texture,_+m.x+t+o.x*r,p+m.y+o.y*r,o.width*r,o.height*r,s),t+=Math.round(o.advance*r))}}else m.style.stroke?e.fillBorderText(m.wt,_+m.x,p+m.y,m.ctxFont,m.style.color,null,m.style.stroke,m.style.strokeColor):e.fillText(m.wt,_+m.x,p+m.y,m.ctxFont,m.style.color,null);if(!g&&m.width>0){if(m.style.underline){let t=Math.max(1,m.fontSize/16);e.drawLine(_+m.x,p+o.height-t,_+m.x+m.width,p+o.height-t,m.style.underlineColor||m.style.color,t)}if(m.style.strikethrough){let t=Math.max(1,m.fontSize/16),i=_+m.x,s=p+o.height/2-t|0,r=4;e.drawLine(i-r,s,i+m.width+r,s,m.style.strikethroughColor||m.style.color,t)}}m=m.next}d&&(d.addRect(c,p,l-c+s,o.height),c=s)}u&&e.restore()}drawBg(){let t=this._bgDrawCmd;if(this._bgColor||this._borderColor){t||(t=new zs,t.x=t.y=0,t.width=t.height=1,t.percent=!0,this._bgDrawCmd=t),t.fillColor=this._bgColor,t.lineColor=this._borderColor,t.lineWidth=this._borderColor?1:0;let e=this.graphics.cmds,i=e.indexOf(t);0!=i&&(-1!=i&&e.splice(i,1),e.unshift(t),this.graphics.cmds=e)}else t&&this.graphics.removeCmd(t)}}Yr.VISIBLE="visible",Yr.SCROLL="scroll",Yr.HIDDEN="hidden",Yr.SHRINK="shrink",Yr.ELLIPSIS="ellipsis",Yr.RightToLeft=!1,Yr._testWord="游",Yr._passwordChar="●",Yr._bitmapFonts={};const Xr=[],jr=[];function qr(t){for(let e of t){let t=e.cmd;for(;t;)t.obj?t.obj=null:t.wt&&t.wt.cleanCache(),Xr.push(t),t=t.next;e.cmd=null}jr.push(...t),t.length=0}const $r=/[\uD800-\uDBFF][\uDC00-\uDFFF]/,Kr=/[a-zA-Z0-9\!-\+\/_]+$/,Qr=Array.from(".,，。、!！；;”’)）]】}》").map((t=>t.charCodeAt(0))),Zr=/\r\n/g,Jr=/\\(\w)/g,ta={"\\n":"\n","\\t":"\t"},ea="…",ia=20;function sa(t){return ta[t]}function ra(t){return t>=55296&&t<=56319}function aa(t){return t>=56320&&t<=57343}var na=!0;const la=new s,oa=new F,ha=[],ua=[];var da;class ca{constructor(){this._touches=[],this._touchPool=[],this._mouseTouch=new pa(this._touches),this._pressKeys=new Set,this._keyEvent=new r,this._keyEvent._touches=this._touches}static get inst(){return da}static getTouchPos(t){var e,i;return null==t?(null===(e=da._touches[0])||void 0===e?void 0:e.pos)||s.EMPTY:(null===(i=da.getTouch(t))||void 0===i?void 0:i.pos)||s.EMPTY}static get touchTarget(){return da._touchTarget}static get touches(){return da._touches}static get touchCount(){return da._touches.length}static cancelClick(t){let e=null==t?da._touches[0]:da.getTouch(t);e&&(e.clickCancelled=!0)}static hasKeyDown(t){return da._pressKeys.has(t)}static __init__(t,e){let i=da=new ca;i._stage=t,e.oncontextmenu=()=>!1,e.addEventListener("mousedown",(t=>{A.onIE||t.cancelable&&t.preventDefault(),i.handleMouse(t,0)}),{passive:!1}),e.addEventListener("mouseup",(t=>{t.cancelable&&t.preventDefault(),i.handleMouse(t,1)}),{passive:!1}),e.addEventListener("mousemove",(t=>{t.cancelable&&t.preventDefault(),i.handleMouse(t,2)}),{passive:!1}),e.addEventListener("mouseout",(t=>{i.handleMouse(t,3)}),{passive:!1}),e.addEventListener("touchstart",(t=>{na||ca.isTextInputting||t.cancelable&&t.preventDefault(),i.handleTouch(t,0)}),{passive:!1}),e.addEventListener("touchend",(t=>{na||ca.isTextInputting||t.cancelable&&t.preventDefault(),na=!1,i.handleTouch(t,1)}),{passive:!1}),e.addEventListener("touchmove",(t=>{t.cancelable&&t.preventDefault(),i.handleTouch(t,2)}),{passive:!1}),e.addEventListener("touchcancel",(t=>{t.cancelable&&t.preventDefault(),i.handleTouch(t,3)}),{passive:!1}),e.addEventListener("wheel",(t=>{i.handleMouse(t,4)}),{passive:!1}),e.addEventListener("pointerdown",(t=>{e.setPointerCapture(t.pointerId)})),e.addEventListener("pointerup",(t=>{e.releasePointerCapture(t.pointerId)}),!0);let s=A.document;s.addEventListener("keydown",(t=>{i.handleKeys(t)}),!0),s.addEventListener("keypress",(t=>{i.handleKeys(t)}),!0),s.addEventListener("keyup",(t=>{i.handleKeys(t)}),!0)}handleMouse(t,e){var i,s,a,n,l;this._eventType=e,this._nativeEvent=t;let o=A.now();if(null!=this._lastTouchTime&&o-this._lastTouchTime<100)return;let h=this._mouseTouch;la.setTo(t.pageX||t.clientX,t.pageY||t.clientY),this._stage._canvasTransform&&this._stage._canvasTransform.invertTransformPoint(la),ca.mouseX=la.x,ca.mouseY=la.y;let u=la.x/this._stage.clientScaleX,d=la.y/this._stage.clientScaleY;if(h.event.nativeEvent=t,3!=e&&ca.mouseEventsEnabled){h.target=this._touchTarget=this.getNodeUnderPoint(u,d);let t=Math.round(u),e=Math.round(d);if((t!=h.pos.x||e!=h.pos.y)&&(this._stage._mouseMoveTime=o,h.pos.setTo(t,e),h.move(),ca.mouseEventsEnabled)){h.target.bubbleEvent(r.MOUSE_MOVE,h.event);for(let t of h.downTargets)t.event(r.MOUSE_DRAG,h.event)}}else h.target=this._touchTarget=null;if(h.lastRollOver!=h.target&&this.handleRollOver(h),0==e)h.began||(h.begin(),this._touches[0]=h,h.event.button=t.button,h.downButton=t.button,ca.mouseEventsEnabled&&(this.handleFocus(),0==t.button?null===(i=h.target)||void 0===i||i.bubbleEvent(r.MOUSE_DOWN,h.event):null===(s=h.target)||void 0===s||s.bubbleEvent(r.RIGHT_MOUSE_DOWN,h.event)));else if(1==e){if(h.began&&t.button==h.downButton){if(h.end(),this._touches.length=0,h.event.button=t.button,ca.mouseEventsEnabled){if(0==t.button?null===(a=h.target)||void 0===a||a.bubbleEvent(r.MOUSE_UP,h.event):null===(n=h.target)||void 0===n||n.bubbleEvent(r.RIGHT_MOUSE_UP,h.event),h.moved)for(let t of h.downTargets)t.event(r.MOUSE_DRAG_END,h.event);let e=h.clickTest();e&&(0==t.button?(h.event.isDblClick=2==h.clickCount,e.bubbleEvent(r.CLICK,h.event),2==h.clickCount&&e.bubbleEvent(r.DOUBLE_CLICK,h.event),h.event.isDblClick=!1):(h.event.isDblClick=2==h.clickCount,e.bubbleEvent(r.RIGHT_CLICK,h.event),h.event.isDblClick=!1))}h.event.button=0}}else 4==e&&ca.mouseEventsEnabled&&(h.event.delta=.025*t.deltaY,null===(l=h.target)||void 0===l||l.bubbleEvent(r.MOUSE_WHEEL,h.event),h.event.delta=0)}handleTouch(t,e){var i,s;this._eventType=e,this._nativeEvent=t,this._lastTouchTime=A.now();let a=t.changedTouches;for(let n=0;n<a.length;++n){let l=a[n];if(!ca.multiTouchEnabled&&this._touches.length>0&&this._touches[0].touchId!=l.identifier)continue;la.setTo(l.pageX,l.pageY),this._stage._canvasTransform&&this._stage._canvasTransform.invertTransformPoint(la),ca.mouseX=la.x,ca.mouseY=la.y;let o=la.x/this._stage.clientScaleX,h=la.y/this._stage.clientScaleY,u=this.getTouch(l.identifier,0==e);if(u){if(u.event.nativeEvent=t,u.event.touchId=u.touchId,3!=e&&ca.mouseEventsEnabled){u.target=this._touchTarget=this.getNodeUnderPoint(o,h),this._stage._mouseMoveTime=this._lastTouchTime;let t=Math.round(o),i=Math.round(h);if((Math.abs(t-u.pos.x)>1.5||Math.abs(i-u.pos.y)>1.5)&&(u.pos.setTo(t,i),2==e&&(u.move(),ca.mouseEventsEnabled))){u.target.bubbleEvent(r.MOUSE_MOVE,u.event);for(let t of u.downTargets)t.event(r.MOUSE_DRAG,u.event)}}else u.target=this._touchTarget=null;if(u.lastRollOver!=u.target&&this.handleRollOver(u),0==e)u.began||(u.begin(),ca.mouseEventsEnabled&&(this.handleFocus(),null===(i=u.target)||void 0===i||i.bubbleEvent(r.MOUSE_DOWN,u.event)));else if(1==e||3==e){if(u.began){if(u.end(),ca.mouseEventsEnabled){if(null===(s=u.target)||void 0===s||s.bubbleEvent(r.MOUSE_UP,u.event),u.moved)for(let t of u.downTargets)t.event(r.MOUSE_DRAG_END,u.event);if(3!=e){let t=u.clickTest();null!=t&&(u.event.isDblClick=2==u.clickCount,t.bubbleEvent(r.CLICK,u.event),2==u.clickCount&&t.bubbleEvent(r.DOUBLE_CLICK,u.event),u.event.isDblClick=!1)}}u.target=null,this.handleRollOver(u)}u.reset(),this._touches.splice(this._touches.indexOf(u),1),this._touchPool.push(u)}}}}getTouch(t,e){let i=this._touches.find((e=>e.touchId==t));return i||!e||(i=this._touchPool.length>0?this._touchPool.pop():new pa(this._touches),i.touchId=t,this._touches.push(i)),i}handleFocus(){if(ca.isTextInputting&&this._stage.focus&&this._stage.focus.focus&&!this._stage.focus.contains(this._touchTarget)){let t=this._stage.focus._tf||this._stage.focus,e=this._touchTarget._tf||this._touchTarget;e.nativeInput&&e.multiline==t.multiline?t._focusOut():t.focus=!1}}handleKeys(t){let e=t.type,i=t.keyCode;if("keydown"===e?(0!=i&&this._pressKeys.add(i),this._pressKeys.add(t.key)):"keyup"===e&&(0!=i&&this._pressKeys.delete(i),this._pressKeys.delete(t.key)),this._keyEvent.nativeEvent=t,ca.keyEventsEnabled){let t=this._stage.focus&&null!=this._stage.focus.event&&this._stage.focus.displayedInStage?this._stage.focus:this._stage,i=t;for(;i;)i.event(e,this._keyEvent.setTo(e,i,t)),i=i.parent}this._keyEvent.nativeEvent=null}getNodeUnderPoint(t,e){let i=this.getSpriteUnderPoint(this._stage,t,e);return i||(i=this.getSprite3DUnderPoint(t,e)),i||this._stage}getSpriteUnderPoint(t,e,i){let s=t._style.scrollRect;if(s&&!t._getBit(kt.DISABLE_INNER_CLIPPING)&&(oa.setTo(s.x,s.y,s.width,s.height),!oa.contains(e,i)))return null;let r=t._getBit(kt.EDITING_NODE);if(!r&&t.hitTestPrior&&!t.mouseThrough&&t!=this._stage&&!this.hitTest(t,e,i))return null;for(let s=t._children.length-1;s>-1;s--){let a=t._children[s],n=r||a._getBit(kt.EDITING_NODE);if(!a._destroyed&&(n?(!a.hasHideFlag(Gt.HideInHierarchy)||a.mouseThrough)&&!a._getBit(kt.HIDE_BY_EDITOR):a._mouseState>1)&&(a._visible||a._getBit(kt.DISABLE_VISIBILITY))){la.setTo(e,i),a.fromParentPoint(la);let t=this.getSpriteUnderPoint(a,la.x,la.y);if(t)return t}}if(r){if(!t._getBit(kt.LOCK_BY_EDITOR)&&!t.hasHideFlag(Gt.HideInHierarchy)&&this.hitTest(t,e,i,r))return t}else if(t!=this._stage&&(t.hitTestPrior&&!t.mouseThrough||this.hitTest(t,e,i)))return t;return null}getSprite3DUnderPoint(t,e){return null}hitTest(t,e,i,s){let r=!1;t.scrollRect&&(e-=t._style.scrollRect.x,i-=t._style.scrollRect.y);let a=t._style.hitArea,n=t.mouseThrough;return s&&(a=null,n=!1),a?a.contains(e,i,t):((t.width>0&&t.height>0||n||a)&&(r=n?t.getGraphicBounds().contains(e,i):(a||oa.setTo(0,0,t.width,t.height)).contains(e,i,t)),r)}handleRollOver(t){if(!ca.mouseEventsEnabled)return void(t.lastRollOver=t.target);ha.length=0,ua.length=0;let e=t.lastRollOver;for(;e;)ua.push(e),e=e.parent;for(t.lastRollOver=t.target,e=t.target;e;){let t=ua.indexOf(e);if(-1!=t){ua.splice(t,ua.length-t);break}ha.push(e),e=e.parent}let i=ua.length;if(i>0){for(let s=0;s<i;s++)e=ua[s],e._destroyed||e.event(r.MOUSE_OUT,t.event.setTo(r.MOUSE_OUT,e,e));ua.length=0}if(i=ha.length,i>0){for(let s=0;s<i;s++)e=ha[s],e.activeInHierarchy&&e.event(r.MOUSE_OVER,t.event.setTo(r.MOUSE_OVER,e,e));ha.length=0}}}ca.multiTouchEnabled=!0,ca.mouseEventsEnabled=!0,ca.keyEventsEnabled=!0,ca.clickTestThreshold=10,ca.mouseX=0,ca.mouseY=0,ca.isTextInputting=!1,ca.isiOSWKwebView=!1;const _a={};class pa{constructor(t){this.downPos=new s,this.downTargets=[],this.event=new r,this.event._touches=t,this.pos=this.event.touchPos,this.touchId=0,this.reset()}begin(){if(this.began=!0,this.clickCancelled=!1,this.moved=!1,this.downPos.copy(this.pos),this.downTargets.length=0,this.target){let t=this.target;for(;t;)this.downTargets.push(t),t=t.parent}}move(){this.moved=!0,(Math.abs(this.pos.x-this.downPos.x)>ca.clickTestThreshold||Math.abs(this.pos.y-this.downPos.y)>ca.clickTestThreshold)&&(this.clickCancelled=!0)}end(){this.began=!1;let t=performance.now(),e=_a[this.touchId];e||(e={pos:new s,time:0,button:0},_a[this.touchId]=e),0==this.downTargets.length||this.clickCancelled||Math.abs(this.pos.x-this.downPos.x)>ca.clickTestThreshold||Math.abs(this.pos.y-this.downPos.y)>ca.clickTestThreshold?(this.clickCancelled=!0,e.time=0,this.clickCount=1):(t-e.time<350&&Math.abs(this.pos.x-e.pos.x)<ca.clickTestThreshold&&Math.abs(this.pos.y-e.pos.y)<ca.clickTestThreshold&&e.button==this.event.button?this.clickCount=2:this.clickCount=1,e.time=t,e.pos.copy(this.pos),e.button=this.event.button)}clickTest(){if(this.clickCancelled)return this.downTargets.length=0,null;let t=this.downTargets[0];if(t.activeInHierarchy)return this.downTargets.length=0,t;for(t=this.target;t;){if(-1!=this.downTargets.indexOf(t)&&t.activeInHierarchy)break;t=t.parent}return this.downTargets.length=0,t}reset(){this.pos.setTo(0,0),this.touchId=0,this.clickCount=0,this.began=!1,this.moved=!1,this.target=null,this.downTargets.length=0,this.lastRollOver=null,this.clickCancelled=!1,this.downButton=0}}class fa{constructor(t=!0){this.scale=1,this.currFrame=0,this._delta=0,this._map={},this._handlers=[],this._temp=[],this._count=0,t&&fa.gSysTimer&&fa.gSysTimer.frameLoop(1,this,this._update),this.currTimer=this._getNowData(),this._lastTimer=this._getNowData()}get delta(){return this._delta}_update(){if(this.scale<=0)return this._lastTimer=this._getNowData(),void(this._delta=0);var t=this.currFrame=this.currFrame+this.scale,e=this._getNowData(),i=e-this._lastTimer>3e4;this._delta=(e-this._lastTimer)*this.scale;var s=this.currTimer=this.currTimer+this._delta;this._lastTimer=e;var r=this._handlers;this._count=0;for(var a=0,n=r.length;a<n;a++){var l=r[a];if(null!==l.method){var o=l.userFrame?t:s;if(o>=l.exeTime)if(l.repeat)if(!l.jumpFrame||i)l.exeTime+=l.delay,l.run(!1),o>l.exeTime&&(l.exeTime+=Math.ceil((o-l.exeTime)/l.delay)*l.delay);else for(;o>=l.exeTime;)l.exeTime+=l.delay,l.run(!1);else l.run(!0)}else this._count++}(this._count>30||t%200==0)&&this._clearHandlers()}_clearHandlers(){for(var t=this._handlers,e=0,i=t.length;e<i;e++){var s=t[e];null!==s.method?this._temp.push(s):this._recoverHandler(s)}this._handlers=this._temp,t.length=0,this._temp=t}_recoverHandler(t){this._map[t.key]==t&&delete this._map[t.key],t.clear(),fa._pool.push(t)}_getNowData(){return Date.now()}_create(t,e,i,s,r,a,n){if(!i)return r.apply(s,a),null;if(n){var l=this._getHandler(s,r);if(l)return l.repeat=e,l.userFrame=t,l.delay=i,l.caller=s,l.method=r,l.args=a,l.exeTime=i+(t?this.currFrame:this.currTimer+this._getNowData()-this._lastTimer),l}return(l=fa._pool.length>0?fa._pool.pop():new ga).repeat=e,l.userFrame=t,l.delay=i,l.caller=s,l.method=r,l.args=a,l.exeTime=i+(t?this.currFrame:this.currTimer+this._getNowData()-this._lastTimer),this._indexHandler(l),this._handlers.push(l),l}_indexHandler(t){var e=t.caller,i=t.method,s=e?e.$_GID||(e.$_GID=P.getGID()):0,r=i.$_TID||(i.$_TID=fa._mid++);t.key=s+"_"+r,this._map[t.key]=t}once(t,e,i,s=null,r=!0){this._create(!1,!1,t,e,i,s,r)}loop(t,e,i,s=null,r=!0,a=!1){var n=this._create(!1,!0,t,e,i,s,r);n&&(n.jumpFrame=a)}frameOnce(t,e,i,s=null,r=!0){this._create(!0,!1,t,e,i,s,r)}frameLoop(t,e,i,s=null,r=!0){this._create(!0,!0,t,e,i,s,r)}toString(){return" handlers:"+this._handlers.length+" pool:"+fa._pool.length}clear(t,e){var i=this._getHandler(t,e);i&&i.clear()}clearAll(t){if(t)for(var e=0,i=this._handlers.length;e<i;e++){var s=this._handlers[e];s.caller===t&&s.clear()}}_getHandler(t,e){var i=(t?t.$_GID||(t.$_GID=P.getGID()):0)+"_"+(e.$_TID||(e.$_TID=fa._mid++));return this._map[i]}callLater(t,e,i=null){ma.I.callLater(t,e,i)}runCallLater(t,e){ma.I.runCallLater(t,e)}clearCallLater(t,e){ma.I.clear(t,e)}runTimer(t,e){var i=this._getHandler(t,e);i&&null!=i.method&&(this._map[i.key]=null,i.run(!0))}pause(){this.scale=0}resume(){this.scale=1}destroy(){for(var t=0,e=this._handlers.length;t<e;t++){this._handlers[t].clear()}this._handlers.length=0,this._map={},this._temp.length=0}}fa.gSysTimer=null,fa._pool=[],fa._mid=1;class ga{clear(){this.caller=null,this.method=null,this.args=null}run(t){var e=this.caller;if(e&&e.destroyed)return this.clear();var i=this.method,s=this.args;t&&this.clear(),null!=i&&(s?i.apply(e,s):i.call(e))}}class ma{constructor(){this._pool=[],this._map={},this._laters=[]}_update(){let t=this._laters,e=t.length;if(e>0){for(let i=0,s=e-1;i<=s;i++){let e=t[i];delete this._map[e.key],null!==e.method&&(e.run(),e.clear()),this._pool.push(e),i===s&&(s=t.length-1)}t.length=0}}_getHandler(t,e){var i=t?t.$_GID||(t.$_GID=P.getGID()):0,s=e.$_TID||(e.$_TID=fa._mid++);return this._map[i+"."+s]}callLater(t,e,i=null){if(null==this._getHandler(t,e)){let a;a=this._pool.length?this._pool.pop():new ya,a.caller=t,a.method=e,a.args=i;var s=t?t.$_GID:0,r=e.$_TID;a.key=s+"."+r,this._map[a.key]=a,this._laters.push(a)}}runCallLater(t,e){var i=this._getHandler(t,e);i&&null!=i.method&&(delete this._map[i.key],i.run(),i.clear())}clear(t,e){var i=this._getHandler(t,e);return!!i&&(delete this._map[i.key],i.key="",i.clear(),!0)}clearAll(t){if(t)for(var e=0,i=this._laters.length;e<i;e++){var s=this._laters[e];s.caller===t&&(delete this._map[s.key],s.key="",s.clear())}}}ma.I=new ma;class ya{clear(){this.caller=null,this.method=null,this.args=null}run(){var t=this.caller;if(t&&t.destroyed)return this.clear();var e=this.method,i=this.args;null!=e&&(i?e.apply(t,i):e.call(t))}}class Ta{static _nativeRender_enable(){}static enable(){return!0}static onStageResize(t,e){le.width=t,le.height=e,l.renderEngine.resizeOffScreen(t,e)}}Ta.isNativeRender_enable=!1;class xa{}xa.changeWebGLSize=function(t,e){Ta.onStageResize(t,e)};class va{constructor(){this._onUpdates=new Set,this._onLateUpdates=new Set,this._onPreRenders=new Set,this._onPostRenders=new Set,this._toStarts=new Set,this._toDestroys=new Set}callStart(){for(let t of this._toStarts)if(2==t._status){t._status=3;try{t.onStart()}catch(t){this.onError(t)}}this._toStarts.clear()}callUpdate(){for(let t of this._onUpdates)if(3==t._status)try{t.onUpdate()}catch(t){this.onError(t)}}callLateUpdate(){for(let t of this._onLateUpdates)if(3==t._status)try{t.onLateUpdate()}catch(t){this.onError(t)}}callPreRender(){for(let t of this._onPreRenders)if(3==t._status)try{t.onPreRender()}catch(t){this.onError(t)}}callPostRender(){for(let t of this._onPostRenders)if(3==t._status)try{t.onPostRender()}catch(t){this.onError(t)}}callDestroy(){for(let t of this._toDestroys)try{t._destroy(!0)}catch(t){this.onError(t)}this._toDestroys.clear()}add(t){1==t._status&&(t.onStart?(t._status=2,this._toStarts.add(t)):t._status=3),t.onUpdate&&this._onUpdates.add(t),t.onLateUpdate&&this._onLateUpdates.add(t),t.onPreRender&&this._onPreRenders.add(t),t.onPostRender&&this._onPostRenders.add(t)}remove(t){2==t._status&&(t._status=1),t.onUpdate&&this._onUpdates.delete(t),t.onLateUpdate&&this._onLateUpdates.delete(t),t.onPreRender&&this._onPreRenders.delete(t),t.onPostRender&&this._onPostRenders.delete(t)}destroy(){}onError(t){console.error(t)}}class Sa extends br{constructor(){super(),this.offset=new s,this._frameRate="fast",this.designWidth=0,this.designHeight=0,this.canvasRotation=!1,this.canvasDegree=0,this.renderingEnabled=!0,this.screenAdaptationEnabled=!0,this._canvasTransform=new G,this._mouseMoveTime=0,this._wgColor=new _t(0,0,0,0),this._scene3Ds=[],this._screenMode="none",this._scaleMode="noscale",this._alignV="top",this._alignH="left",this._bgColor="gray",this._renderCount=0,this._safariOffsetY=0,this._frameStartTime=0,this._previousOrientation=A.window.orientation,this._globalRepaintSet=!1,this._globalRepaintGet=!1,this.useRetinalCanvas=!1,this._needUpdateCanvasSize=!1,super.set_transform(this._createTransform()),this.mouseEnabled=!0,this.hitTestPrior=!0,this.autoSize=!1,this._setBit(kt.DISPLAYED_INSTAGE,!0),this._setBit(kt.ACTIVE_INHIERARCHY,!0),this._isFocused=!0,this._isVisibility=!0,this.useRetinalCanvas=!!n.isConch||f.useRetinalCanvas;var t=A.window;t.addEventListener("focus",(()=>{this._isFocused=!0,this.event(r.FOCUS),this.event(r.FOCUS_CHANGE)})),t.addEventListener("blur",(()=>{this._isFocused=!1,this.event(r.BLUR),this.event(r.FOCUS_CHANGE),this._isInputting()&&(ln.inputElement.target.focus=!1)}));var e="visibilityState",i="visibilitychange",a=t.document;void 0!==a.hidden?(i="visibilitychange",e="visibilityState"):void 0!==a.mozHidden?(i="mozvisibilitychange",e="mozVisibilityState"):void 0!==a.msHidden?(i="msvisibilitychange",e="msVisibilityState"):void 0!==a.webkitHidden&&(i="webkitvisibilitychange",e="webkitVisibilityState"),t.document.addEventListener(i,(()=>{"hidden"==A.document[e]?(this._isVisibility=!1,this._isInputting()&&(ln.inputElement.target.focus=!1)):this._isVisibility=!0,this.renderingEnabled=this._isVisibility,this.event(r.VISIBILITY_CHANGE)})),t.addEventListener("resize",(()=>{var t=A.window.orientation;null!=t&&t!=this._previousOrientation&&this._isInputting()&&(ln.inputElement.target.focus=!1),this._previousOrientation=t,this._isInputting()||(A.onSafari&&(this._safariOffsetY=A.getSafariToolbarOffset()),this.screenAdaptationEnabled&&(this.event(r.WILL_RESIZE),this.updateCanvasSize(!0)))})),t.addEventListener("orientationchange",(t=>{this.screenAdaptationEnabled&&(this.event(r.WILL_RESIZE),this.updateCanvasSize(!0))})),this._componentDriver=new va}_isInputting(){return A.onMobile&&ca.isTextInputting}set_width(t){this.designWidth=t,super.set_width(t),this.updateCanvasSize(!0)}get_width(){return this.needUpdateCanvasSize(),super.get_width()}set_height(t){this.designHeight=t,super.set_height(t),this.updateCanvasSize(!0)}get_height(){return this.needUpdateCanvasSize(),super.get_height()}get transform(){return this._tfChanged&&this._adjustTransform(),this._transform=this._transform||this._createTransform()}set transform(t){super.set_transform(t)}get isFocused(){return this._isFocused}get isVisibility(){return this._isVisibility}updateCanvasSize(t){t?this._needUpdateCanvasSize||(this._needUpdateCanvasSize=!0,e.systemTimer.callLater(this,this.updateCanvasSize)):this.setScreenSize(A.clientWidth*A.pixelRatio,A.clientHeight*A.pixelRatio)}needUpdateCanvasSize(){this._needUpdateCanvasSize&&this.updateCanvasSize()}setScreenSize(t,e){this._needUpdateCanvasSize=!1;var i=!1;if(this._screenMode!==Sa.SCREEN_NONE&&(i=(t/e<1?Sa.SCREEN_VERTICAL:Sa.SCREEN_HORIZONTAL)!==this._screenMode)){var s=e;e=t,t=s}this.canvasRotation=i;var a=Za._mainCanvas,n=this._canvasTransform.identity(),l=this._scaleMode,o=t/this.designWidth,h=e/this.designHeight,u=this.useRetinalCanvas?t:this.designWidth,d=this.useRetinalCanvas?e:this.designHeight,c=t,_=e,p=A.pixelRatio;switch(this._width=this.designWidth,this._height=this.designHeight,l){case Sa.SCALE_NOSCALE:o=h=1,c=this.designWidth,_=this.designHeight;break;case Sa.SCALE_SHOWALL:o=h=Math.min(o,h),u=c=Math.round(this.designWidth*o),d=_=Math.round(this.designHeight*h);break;case Sa.SCALE_NOBORDER:o=h=Math.max(o,h),c=Math.round(this.designWidth*o),_=Math.round(this.designHeight*h);break;case Sa.SCALE_FULL:o=h=p,u=t,d=e,this._width=t/p,this._height=e/p;break;case Sa.SCALE_FIXED_WIDTH:h=o,this._height=d=Math.round(e/o);break;case Sa.SCALE_FIXED_HEIGHT:o=h,this._width=u=Math.round(t/h);break;case Sa.SCALE_FIXED_AUTO:t/e<this.designWidth/this.designHeight?(h=o,this._height=d=Math.round(e/o)):(o=h,this._width=u=Math.round(t/h))}this.useRetinalCanvas&&(c=u=t,_=d=e),o*=this.scaleX,h*=this.scaleY,1===o&&1===h?this.transform.identity():(this.transform.a=this._formatData(o/(c/u)),this.transform.d=this._formatData(h/(_/d))),a.size(u,d),xa.changeWebGLSize(u,d),n.scale(c/u/p,_/d/p),this._alignH===Sa.ALIGN_LEFT?this.offset.x=0:this._alignH===Sa.ALIGN_RIGHT?this.offset.x=t-c:this.offset.x=.5*(t-c)/p,this._alignV===Sa.ALIGN_TOP?this.offset.y=0:this._alignV===Sa.ALIGN_BOTTOM?this.offset.y=e-_:this.offset.y=.5*(e-_)/p,this.offset.x=Math.round(this.offset.x),this.offset.y=Math.round(this.offset.y),n.translate(this.offset.x,this.offset.y),this._safariOffsetY&&n.translate(0,this._safariOffsetY),this.canvasDegree=0,i&&(this._screenMode===Sa.SCREEN_HORIZONTAL?(n.rotate(Math.PI/2),n.translate(e/p,0),this.canvasDegree=90):(n.rotate(-Math.PI/2),n.translate(0,t/p),this.canvasDegree=-90)),n.a=this._formatData(n.a),n.d=this._formatData(n.d),n.tx=this._formatData(n.tx),n.ty=this._formatData(n.ty),super.set_transform(this.transform),Sa._setStageStyle(a,u,d,n),this._safariOffsetY&&n.translate(0,-this._safariOffsetY),this.visible=!0,this._repaint|=re.REPAINT_CACHE,this.event(r.RESIZE)}static _setStageStyle(t,e,i,s){var r=t.source.style;r.transformOrigin=r.webkitTransformOrigin=r.msTransformOrigin=r.mozTransformOrigin=r.oTransformOrigin="0px 0px 0px",r.transform=r.webkitTransform=r.msTransform=r.mozTransform=r.oTransform="matrix("+s.toString()+")",r.width=e,r.height=i,s.translate(parseInt(r.left)||0,parseInt(r.top)||0)}setScreenSizeForScene(t,e,i){var s=!1;if(i!==Sa.SCREEN_NONE&&(s=(t/e<1?Sa.SCREEN_VERTICAL:Sa.SCREEN_HORIZONTAL)!==i)){var r=e;e=t,t=r}this.canvasRotation=s;var a=this._scaleMode,n=t/this.designWidth,l=e/this.designHeight,o=this.useRetinalCanvas?t:this.designWidth,h=this.useRetinalCanvas?e:this.designHeight,u=t,d=e;let c=this.designWidth,_=this.designHeight;switch(a){case Sa.SCALE_NOSCALE:n=l=1,u=this.designWidth,d=this.designHeight;break;case Sa.SCALE_SHOWALL:n=l=Math.min(n,l),o=u=Math.round(this.designWidth*n),h=d=Math.round(this.designHeight*l);break;case Sa.SCALE_NOBORDER:n=l=Math.max(n,l),u=Math.round(this.designWidth*n),d=Math.round(this.designHeight*l);break;case Sa.SCALE_FULL:n=l=1,c=o=t,_=h=e;break;case Sa.SCALE_FIXED_WIDTH:l=n,_=h=Math.round(e/n);break;case Sa.SCALE_FIXED_HEIGHT:n=l,c=o=Math.round(t/l);break;case Sa.SCALE_FIXED_AUTO:t/e<this.designWidth/this.designHeight?(l=n,_=h=Math.round(e/n)):(n=l,c=o=Math.round(t/l))}return this.useRetinalCanvas&&(u=o=t,d=h=e),{stageWidth:c,stageHeight:_,canvasWidth:o,canvasHeight:h,scaleX:n/(u/o),scaleY:l/(d/h)}}_formatData(t){return Math.abs(t)<1e-6?0:Math.abs(1-t)<.001?t>0?1:-1:t}get scaleMode(){return this._scaleMode}set scaleMode(t){this._scaleMode=t,this.updateCanvasSize(!0)}get alignH(){return this.needUpdateCanvasSize(),this._alignH}set alignH(t){this._alignH=t,this.updateCanvasSize(!0)}get alignV(){return this.needUpdateCanvasSize(),this._alignV}set alignV(t){this._alignV=t,this.updateCanvasSize(!0)}get bgColor(){return this._bgColor}set bgColor(t){if(this._bgColor=t,t){let e=mi.create(t).arrColor;this._wgColor.setValue(e[0],e[1],e[2],e[3])}else this._wgColor=null;Sa._setStyleBgColor(t)}static _setStyleBgColor(t){Za.canvas.style.background=t||"none"}get mouseX(){return Math.round(ca.mouseX/this.clientScaleX)}get mouseY(){return Math.round(ca.mouseY/this.clientScaleY)}getMousePoint(){return s.TEMP.setTo(this.mouseX,this.mouseY)}get clientScaleX(){return this.needUpdateCanvasSize(),this._transform?this._transform.getScaleX():1}get clientScaleY(){return this.needUpdateCanvasSize(),this._transform?this._transform.getScaleY():1}get screenMode(){return this._screenMode}set screenMode(t){this._screenMode=t}repaint(t=re.REPAINT_CACHE){this._repaint|=t}parentRepaint(t=re.REPAINT_CACHE){}_loop(){return this._globalRepaintGet=this._globalRepaintSet,this._globalRepaintSet=!1,this.render(Za._context,0,0),!0}getFrameTm(){return this._frameStartTime}getTimeFromFrameStart(){return A.now()-this._frameStartTime}get visible(){return super.visible}set visible(t){this.visible!==t&&(super.set_visible(t),Sa._setVisibleStyle(t))}static _setVisibleStyle(t){Za._mainCanvas.source.style.visibility=t?"visible":"hidden"}render(t,e,i){if(this._frameRate===Sa.FRAME_SLEEP){var s=A.now();if(s-this._frameStartTime<1e3)return;this._frameStartTime=s}else{if(!this._visible)return this._renderCount++,void(this._renderCount%5==0&&(ma.I._update(),ae.loopCount++,ki.loopCount=ae.loopCount,this._runComponents(),this._updateTimers()));this._frameStartTime=A.now(),ki.loopStTm=this._frameStartTime}this._renderCount++;var r=(this._frameRate===Sa.FRAME_MOUSE?this._frameStartTime-this._mouseMoveTime<2e3?Sa.FRAME_FAST:Sa.FRAME_SLOW:this._frameRate)!==Sa.FRAME_SLOW,a=this._renderCount%2==0;if(ae.renderSlow=!r,r||a){if(ma.I._update(),ae.loopCount++,ki.loopCount=ae.loopCount,this.renderingEnabled){for(let t=0,e=this._scene3Ds.length;t<e;t++)this._scene3Ds[t]._update();this._runComponents(),this._componentDriver.callPreRender(),t.render2D.renderStart(!f.preserveDrawingBuffer,this._wgColor);for(let t=0,e=this._scene3Ds.length;t<e;t++)this._scene3Ds[t].renderSubmit();this._render2d(t,e,i),this._componentDriver.callPostRender(),_r.instance&&_r.getInstance().endDispose()}else this._runComponents();this._updateTimers(),l.renderEngine.endFrame()}}_render2d(t,e,i){ae.draw2D=0,t.startRender(),super.render(t,e,i),ae.render(t,e,i),t.endRender()}_runComponents(){this._componentDriver.callStart(),this._componentDriver.callUpdate(),this._componentDriver.callLateUpdate(),this._componentDriver.callDestroy()}_updateTimers(){e.systemTimer._update(),e.physicsTimer._update(),e.timer._update()}set fullScreenEnabled(t){var e=A.document,i=Za.canvas;t?(i.addEventListener("mousedown",Ea),i.addEventListener("touchstart",Ea),e.addEventListener("fullscreenchange",wa),e.addEventListener("mozfullscreenchange",wa),e.addEventListener("webkitfullscreenchange",wa),e.addEventListener("msfullscreenchange",wa)):(i.removeEventListener("mousedown",Ea),i.removeEventListener("touchstart",Ea),e.removeEventListener("fullscreenchange",wa),e.removeEventListener("mozfullscreenchange",wa),e.removeEventListener("webkitfullscreenchange",wa),e.removeEventListener("msfullscreenchange",wa))}exitFullscreen(){var t=A.document;t.exitFullscreen?t.exitFullscreen():t.mozCancelFullScreen?t.mozCancelFullScreen():t.webkitExitFullscreen&&t.webkitExitFullscreen()}get frameRate(){return this._frameRate}set frameRate(t){this._frameRate=t}isGlobalRepaint(){return this._globalRepaintGet}setGlobalRepaint(){this._globalRepaintSet=!0}}function Ea(){var t=A.document.documentElement;t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen&&t.msRequestFullscreen();var e=Za.canvas;e.removeEventListener("mousedown",Ea),e.removeEventListener("touchstart",Ea)}function wa(){e.stage.event(r.FULL_SCREEN_CHANGE)}Sa.SCALE_NOSCALE="noscale",Sa.SCALE_SHOWALL="showall",Sa.SCALE_NOBORDER="noborder",Sa.SCALE_FULL="full",Sa.SCALE_FIXED_WIDTH="fixedwidth",Sa.SCALE_FIXED_HEIGHT="fixedheight",Sa.SCALE_FIXED_AUTO="fixedauto",Sa.ALIGN_LEFT="left",Sa.ALIGN_RIGHT="right",Sa.ALIGN_CENTER="center",Sa.ALIGN_TOP="top",Sa.ALIGN_MIDDLE="middle",Sa.ALIGN_BOTTOM="bottom",Sa.SCREEN_NONE="none",Sa.SCREEN_HORIZONTAL="horizontal",Sa.SCREEN_VERTICAL="vertical",Sa.FRAME_FAST="fast",Sa.FRAME_SLOW="slow",Sa.FRAME_MOUSE="mouse",Sa.FRAME_SLEEP="sleep";class Da extends v{constructor(){super(...arguments),this.isStopped=!1}get volume(){return 1}set volume(t){}get position(){return 0}get duration(){return 0}play(){}stop(){this.completeHandler&&this.completeHandler.runWith(!1)}pause(){}resume(){}__runComplete(t){t&&t.runWith(!0)}}class ba extends Da{constructor(t){super(),this._audio=null,this._onEnd=this.__onEnd.bind(this),this._resumePlay=this.__resumePlay.bind(this),t.addEventListener("ended",this._onEnd),this._audio=t,this._src=t.src}__onEnd(t){if(1==this.loops)return this.completeHandler&&(e.systemTimer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(r.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}__resumePlay(){if(this._audio&&this._audio.removeEventListener("canplay",this._resumePlay),!this.isStopped)try{this._audio.currentTime=this.startTime,A.container.appendChild(this._audio),this._audio.play()}catch(t){this.event(r.ERROR)}}play(){this.isStopped=!1;try{this._audio.playbackRate=Ia.playbackRate,this._audio.currentTime=this.startTime}catch(t){return void this._audio.addEventListener("canplay",this._resumePlay)}if(Ia.addChannel(this),A.container.appendChild(this._audio),"play"in this._audio){let t=this._audio.play();t&&t.catch((t=>{}))}}get position(){return this._audio?this._audio.currentTime:0}get duration(){return this._audio?this._audio.duration:0}stop(){super.stop(),this.isStopped=!0,Ia.removeChannel(this),this.completeHandler=null,this._audio&&("pause"in this._audio&&n.isConch&&this._audio.stop(),this._audio.pause(),this._audio.removeEventListener("ended",this._onEnd),this._audio.removeEventListener("canplay",this._resumePlay),e.Browser.onIE||this._audio!=Ca._musicAudio&&i.recover("audio:"+this.url,this._audio),A.removeElement(this._audio),this._audio=null,Ia.autoReleaseSound&&Ia.disposeSoundLater(this.url))}pause(){this.isStopped=!0,Ia.removeChannel(this),this._audio&&("pause"in this._audio&&this._audio.pause(),Ia.autoReleaseSound&&Ia.disposeSoundLater(this.url))}resume(){var t=this._audio;t&&(this.isStopped=!1,0==t.readyState&&(t.src=this._src,t.addEventListener("canplay",this._resumePlay),t.load()),Ia.addChannel(this),"play"in t&&t.play())}get volume(){return this._audio?this._audio.volume:1}set volume(t){this._audio&&(this._audio.volume=t)}}class Ca extends v{constructor(){super(...arguments),this.loaded=!1}dispose(){var t=Ca._audioCache[this.url];i.clearBySign("audio:"+this.url),t&&(n.isConch||(t.src=""),delete Ca._audioCache[this.url])}static _initMusicAudio(){Ca._musicAudio||(Ca._musicAudio||(Ca._musicAudio=A.createElement("audio")),n.isConch||A.document.addEventListener("mousedown",Ca._makeMusicOK))}static _makeMusicOK(){A.document.removeEventListener("mousedown",Ca._makeMusicOK),Ca._musicAudio.src?Ca._musicAudio.play():(Ca._musicAudio.src="",Ca._musicAudio.load())}load(t){var e;if(this.url=t,t==Ia._bgMusic?(Ca._initMusicAudio(),(e=Ca._musicAudio).originalUrl!=t&&(delete Ca._audioCache[e.originalUrl],e=null)):e=Ca._audioCache[t],e&&e.readyState>=2)this.event(r.COMPLETE);else{e||(t==Ia._bgMusic?(Ca._initMusicAudio(),e=Ca._musicAudio):e=A.createElement("audio"),Ca._audioCache[t]=e,N.inst.resolveURL(t,(t=>{e.src=O.postFormatURL(O.formatURL(t))}))),e.originalUrl=t,e.addEventListener("canplaythrough",s),e.addEventListener("error",a);var i=this;this.audio=e,e.load?e.load():a()}function s(){n(),i.loaded=!0,i.event(r.COMPLETE)}function a(){e.load=null,n(),i.event(r.ERROR)}function n(){e.removeEventListener("canplaythrough",s),e.removeEventListener("error",a)}}play(t=0,e=0){if(!this.url)return null;var s,r;if(this.url==Ia._bgMusic?""!=(s=Ca._musicAudio).src&&s.originalUrl!=this.url&&(delete Ca._audioCache[s.originalUrl],Ca._audioCache[this.url]=s):s=Ca._audioCache[this.url],!s)return null;r=i.getItem("audio:"+this.url),n.isConch?r||(r=A.createElement("audio"),N.inst.resolveURL(this.url,(t=>{r.src=O.postFormatURL(O.formatURL(t))}))):this.url==Ia._bgMusic?(Ca._initMusicAudio(),r=Ca._musicAudio,N.inst.resolveURL(this.url,(t=>{r.src=O.postFormatURL(O.formatURL(t))}))):r=r||s.cloneNode(!0),r.originalUrl=this.url;var a=new ba(r);return a.url=this.url,a.loops=e,a.startTime=t,a.play(),Ia.addChannel(a),a}get duration(){var t;return(t=Ca._audioCache[this.url])?t.duration:0}}Ca._audioCache={};class Ra extends Da{constructor(){super(),this.bufferSource=null,this._currentTime=0,this._volume=1,this._startTime=0,this._pauseTime=0,this.context=Aa.ctx,this._onPlayEnd=this.__onPlayEnd.bind(this),this.context.createGain?this.gain=this.context.createGain():this.gain=this.context.createGainNode()}play(){if(Ia.addChannel(this),this.isStopped=!1,this._clearBufferSource(),this.audioBuffer){if(this.startTime>=this.duration)return this.stop();var t=this.context,e=this.gain,i=t.createBufferSource();this.bufferSource=i,i.buffer=this.audioBuffer,i.connect(e),e&&e.disconnect(),e.connect(t.destination),i.onended=this._onPlayEnd,this._startTime=A.now(),this.gain.gain.setTargetAtTime?this.gain.gain.setTargetAtTime(this._volume,this.context.currentTime,Ra.SetTargetDelay):this.gain.gain.value=this._volume,0==this.loops&&(i.loop=!0),i.playbackRate.setTargetAtTime?i.playbackRate.setTargetAtTime(Ia.playbackRate,this.context.currentTime,Ra.SetTargetDelay):i.playbackRate.value=Ia.playbackRate,i.start(0,this.startTime),this._currentTime=0}}__onPlayEnd(){if(1==this.loops)return this.completeHandler&&(e.timer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(r.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}get position(){return this.bufferSource?(A.now()-this._startTime)/1e3+this.startTime:0}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}_clearBufferSource(){if(this.bufferSource){var t=this.bufferSource;t.stop?t.stop(0):t.noteOff(0),t.disconnect(0),t.onended=null,Ra._tryCleanFailed||this._tryClearBuffer(t),this.bufferSource=null}}_tryClearBuffer(t){try{t.buffer=null}catch(t){Ra._tryCleanFailed=!0}}stop(){super.stop(),this._clearBufferSource(),this.audioBuffer=null,this.gain&&this.gain.disconnect(),this.isStopped=!0,Ia.removeChannel(this),this.completeHandler=null,Ia.autoReleaseSound&&Ia.disposeSoundLater(this.url)}pause(){this.isStopped||(this._pauseTime=this.position),this._clearBufferSource(),this.gain&&this.gain.disconnect(),this.isStopped=!0,Ia.removeChannel(this),Ia.autoReleaseSound&&Ia.disposeSoundLater(this.url)}resume(){this.startTime=this._pauseTime,this.play()}get volume(){return this._volume}set volume(t){this._volume=t,this.isStopped||(this.gain.gain.setTargetAtTime?this.gain.gain.setTargetAtTime(t,this.context.currentTime,Ra.SetTargetDelay):this.gain.gain.value=t)}}Ra._tryCleanFailed=!1,Ra.SetTargetDelay=.001;class Aa extends v{constructor(){super(...arguments),this.loaded=!1,this._disposed=!1}static _playEmptySound(){if(null!=Aa.ctx){var t=Aa.ctx.createBufferSource();t.buffer=Aa._miniBuffer,t.connect(Aa.ctx.destination),t.start(0,0,0)}}static _unlock(){Aa._unlocked||(Aa._playEmptySound(),"running"==Aa.ctx.state&&(window.document.removeEventListener("mousedown",Aa._unlock,!0),window.document.removeEventListener("touchend",Aa._unlock,!0),window.document.removeEventListener("touchstart",Aa._unlock,!0),Aa._unlocked=!0))}static initWebAudio(){Aa.ctx=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),"running"!=Aa.ctx.state&&(Aa._unlock(),window.document.addEventListener("mousedown",Aa._unlock,!0),window.document.addEventListener("touchend",Aa._unlock,!0),window.document.addEventListener("touchstart",Aa._unlock,!0))}load(t){this.url=t,this.audioBuffer=e.loader.getRes(t),this.audioBuffer?this._loaded(this.audioBuffer):e.loader.load(t,Bt.SOUND).then((t=>this._loaded(t)))}_loaded(t){this._disposed||(this.audioBuffer=t,this.loaded=!0,this.event(r.COMPLETE))}__playAfterLoaded(){if(this.__toPlays){var t,e,i,s;for(e=(i=this.__toPlays).length,t=0;t<e;t++)(s=i[t])[2]&&!s[2].isStopped&&this.play(s[0],s[1],s[2]);this.__toPlays.length=0}}play(t=0,e=0,i=null){return i=i||new Ra,this.audioBuffer||this.url&&(this.__toPlays||(this.__toPlays=[]),this.__toPlays.push([t,e,i]),this.once(r.COMPLETE,this,this.__playAfterLoaded),this.load(this.url)),i.url=this.url,i.loops=e,i.audioBuffer=this.audioBuffer,i.startTime=t,i.play(),Ia.addChannel(i),i}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}dispose(){this._disposed=!0,this.audioBuffer&&(e.loader.clearRes(this.url,this.audioBuffer),this.audioBuffer=null),this.__toPlays=[]}}Aa._miniBuffer=Aa.ctx?Aa.ctx.createBuffer(1,1,22050):void 0,Aa._unlocked=!1;class Ia{static __init__(){var t=e.Browser.window,i=!!(t.AudioContext||t.webkitAudioContext||t.mozAudioContext);return i&&Aa.initWebAudio(),Ia._soundClass=i?Aa:Ca,A.onTBMiniGame||Ca._initMusicAudio(),Ia._musicClass=Ca,i}static addChannel(t){Ia._channels.indexOf(t)>=0||Ia._channels.push(t)}static removeChannel(t){for(let e=Ia._channels.length-1;e>=0;e--)Ia._channels[e]==t&&Ia._channels.splice(e,1)}static disposeSoundLater(t){Ia._lastSoundUsedTimeDic[t]=e.Browser.now(),Ia._isCheckingDispose||(Ia._isCheckingDispose=!0,e.timer.loop(5e3,null,Ia._checkDisposeSound))}static _checkDisposeSound(){let t=e.Browser.now(),i=!1;for(let e in Ia._lastSoundUsedTimeDic)t-Ia._lastSoundUsedTimeDic[e]>3e4?(delete Ia._lastSoundUsedTimeDic[e],Ia.disposeSoundIfNotUsed(e)):i=!0;i||(Ia._isCheckingDispose=!1,e.timer.clear(null,Ia._checkDisposeSound))}static disposeSoundIfNotUsed(t){for(let e=Ia._channels.length-1;e>=0;e--)if(Ia._channels[e].url==t)return;Ia.destroySound(t)}static get autoStopMusic(){return Ia._autoStopMusic}static set autoStopMusic(t){e.stage.off(r.BLUR,null,Ia._stageOnBlur),e.stage.off(r.FOCUS,null,Ia._stageOnFocus),e.stage.off(r.VISIBILITY_CHANGE,null,Ia._visibilityChange),Ia._autoStopMusic=t,t&&(e.stage.on(r.BLUR,null,Ia._stageOnBlur),e.stage.on(r.FOCUS,null,Ia._stageOnFocus),e.stage.on(r.VISIBILITY_CHANGE,null,Ia._visibilityChange))}static _visibilityChange(){e.stage.isVisibility?Ia._stageOnFocus():Ia._stageOnBlur()}static _stageOnBlur(){Ia._isActive=!1,Ia._musicChannel&&(Ia._musicChannel.isStopped||(Ia._blurPaused=!0,Ia._musicChannel.pause())),Ia.stopAllSound(),e.stage.once(r.MOUSE_DOWN,null,Ia._stageOnFocus)}static _recoverWebAudio(){Aa.ctx&&"running"!=Aa.ctx.state&&Aa.ctx.resume&&Aa.ctx.resume()}static _stageOnFocus(){Ia._isActive=!0,Ia._recoverWebAudio(),e.stage.off(r.MOUSE_DOWN,null,Ia._stageOnFocus),Ia._blurPaused&&Ia._musicChannel&&Ia._musicChannel.isStopped&&(Ia._blurPaused=!1,Ia._musicChannel.resume())}static get muted(){return Ia._muted}static set muted(t){t!=Ia._muted&&(t&&Ia.stopAllSound(),Ia.musicMuted=t,Ia._muted=t)}static get soundMuted(){return Ia._soundMuted}static set soundMuted(t){Ia._soundMuted=t}static get musicMuted(){return Ia._musicMuted}static set musicMuted(t){t!=Ia._musicMuted&&(t?(Ia._bgMusic&&Ia._musicChannel&&!Ia._musicChannel.isStopped?n.isConch?Ia._musicChannel._audio&&(Ia._musicChannel._audio.muted=!0):Ia._musicChannel.pause():Ia._musicChannel=null,Ia._musicMuted=t):(Ia._musicMuted=t,Ia._bgMusic&&Ia._musicChannel&&(n.isConch?Ia._musicChannel._audio&&(Ia._musicChannel._audio.muted=!1):Ia._musicChannel.resume())))}static get useAudioMusic(){return Ia._useAudioMusic}static set useAudioMusic(t){Ia._useAudioMusic=t,Ia._musicClass=t?Ca:null}static playSound(t,e=1,i=null,s=null,r=0){if(!Ia._isActive||!t)return null;if(Ia._muted)return null;if(Ia._recoverWebAudio(),t==Ia._bgMusic){if(Ia._musicMuted)return null}else if(Ia._soundMuted)return null;let a;A._isMiniGame||(a=Ia._soundCache[t]),s||(s=Ia._soundClass),a||(a=new s,a.load(t),A._isMiniGame||(Ia._soundCache[t]=a));let n=a.play(r,e);return n?(n.url=t,n.volume=t==Ia._bgMusic?Ia.musicVolume:Ia.soundVolume,n.completeHandler=i,n):null}static destroySound(t){let e=Ia._soundCache[t];e&&(delete Ia._soundCache[t],e.dispose())}static playMusic(t,e=0,i=null,s=0){return Ia._bgMusic=t,Ia._musicChannel&&Ia._musicChannel.stop(),Ia._musicChannel=Ia.playSound(t,e,i,Ia._musicClass,s)}static stopSound(t){for(let e=Ia._channels.length-1;e>=0;e--){let i=Ia._channels[e];i.url==t&&i.stop()}}static stopAll(){var t;for(Ia._bgMusic=null,t=Ia._channels.length-1;t>=0;t--)Ia._channels[t].stop()}static stopAllSound(){for(let t=Ia._channels.length-1;t>=0;t--){let e=Ia._channels[t];e.url!=Ia._bgMusic&&e.stop()}}static stopMusic(){Ia._musicChannel&&Ia._musicChannel.stop(),Ia._bgMusic=null}static setSoundVolume(t,e=null){if(e)Ia._setVolume(e,t);else{Ia.soundVolume=t;for(let e=Ia._channels.length-1;e>=0;e--){let i=Ia._channels[e];i.url!=Ia._bgMusic&&(i.volume=t)}}}static setMusicVolume(t){Ia.musicVolume=t,Ia._setVolume(Ia._bgMusic,t)}static _setVolume(t,e){for(let i=Ia._channels.length-1;i>=0;i--){let s=Ia._channels[i];s.url==t&&(s.volume=e)}}}Ia.musicVolume=1,Ia.soundVolume=1,Ia.playbackRate=1,Ia._useAudioMusic=!0,Ia._muted=!1,Ia._soundMuted=!1,Ia._musicMuted=!1,Ia._bgMusic=null,Ia._musicChannel=null,Ia._channels=[],Ia._blurPaused=!1,Ia._isActive=!0,Ia._lastSoundUsedTimeDic={},Ia._isCheckingDispose=!1,Ia._soundCache={},Ia.autoReleaseSound=!0;class Ma{static __init__(){return Ma._baseClass||(Ma._baseClass=Ba,Ba.init()),Ma.items=Ma._baseClass.items,Ma.support=Ma._baseClass.support,Ma.support}static setItem(t,e){Ma._baseClass.setItem(t,e)}static getItem(t){return Ma._baseClass.getItem(t)}static setJSON(t,e){Ma._baseClass.setJSON(t,e)}static getJSON(t){return Ma._baseClass.getJSON(t)}static removeItem(t){Ma._baseClass.removeItem(t)}static clear(){Ma._baseClass.clear()}}Ma.support=!1;class Ba{static init(){try{Ba.support=!0,Ba.items=window.localStorage,Ba.setItem("laya","1"),Ba.removeItem("laya")}catch(t){Ba.support=!1}Ba.support||console.log("LocalStorage is not supprot or browser is private mode.")}static setItem(t,e){try{Ba.support&&Ba.items.setItem(t,e)}catch(t){console.warn("set localStorage failed",t)}}static getItem(t){return Ba.support?Ba.items.getItem(t):null}static setJSON(t,e){try{Ba.support&&Ba.items.setItem(t,JSON.stringify(e))}catch(t){console.warn("set localStorage failed",t)}}static getJSON(t){try{return JSON.parse(Ba.support?Ba.items.getItem(t):null)}catch(e){return Ba.items.getItem(t)}}static removeItem(t){Ba.support&&Ba.items.removeItem(t)}static clear(){Ba.support&&Ba.items.clear()}}Ba.support=!1;class La extends Ai{constructor(){super(t.RenderSpriteData.Primitive),La.prototype.initialize.call(this)}initialize(){this._defaultShader=ci.find("Sprite2DPrimitive")}reinit(){super.initialize(),this.initialize()}}class Pa extends Ai{constructor(){super(t.RenderSpriteData.Texture2D),Pa.prototype.initialize.call(this)}initialize(){this._blurInfo=new Ze,this._u_blurInfo1=new u,this._u_blurInfo2=new u,this._u_TexRange=new u,this._colorMat=new Ke,this._colorAlpha=new u,this._strength_sig2_2sig2_gauss1=new u,this._defaultShader=ci.find("Sprite2DTexture"),this.blurInfo=this._blurInfo,this.u_blurInfo1=this._u_blurInfo1,this.u_blurInfo2=this._u_blurInfo2,this.u_TexRange=this._u_TexRange,this.colorMat=this._colorMat,this.colorAlpha=this._colorAlpha,this.strength_sig2_2sig2_gauss1=this._strength_sig2_2sig2_gauss1}reinit(){super.initialize(),this.initialize()}get blurInfo(){return this.shaderData.getVector2(Ri.UNIFORM_BLURINFO)}set blurInfo(t){this.shaderData.setVector2(Ri.UNIFORM_BLURINFO,t)}get u_blurInfo1(){return this.shaderData.getVector(Ri.UNIFORM_BLURINFO1)}set u_blurInfo1(t){this.shaderData.setVector(Ri.UNIFORM_BLURINFO1,t)}get u_blurInfo2(){return this.shaderData.getVector(Ri.UNIFORM_BLURINFO2)}set u_blurInfo2(t){this.shaderData.setVector(Ri.UNIFORM_BLURINFO2,t)}get u_TexRange(){return this.shaderData.getVector(Ri.UNIFORM_TEXRANGE)}set u_TexRange(t){this.shaderData.setVector(Ri.UNIFORM_TEXRANGE,t)}get colorMat(){return this.shaderData.getMatrix4x4(Ri.UNIFORM_COLORMAT)}set colorMat(t){this.shaderData.setMatrix4x4(Ri.UNIFORM_COLORMAT,t)}get colorAlpha(){return this.shaderData.getVector(Ri.UNIFORM_COLORALPHA)}set colorAlpha(t){this.shaderData.setVector(Ri.UNIFORM_COLORALPHA,t)}get strength_sig2_2sig2_gauss1(){return this.shaderData.getVector(Ri.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1)}set strength_sig2_2sig2_gauss1(t){this.shaderData.setVector(Ri.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1,t)}}class Na{static set cursor(t){Na._style.cursor=t}static get cursor(){return Na._style.cursor}static __init__(){Na._style=A.document.body.style}static hide(){"none"!=Na.cursor&&(Na._preCursor=Na.cursor,Na.cursor="none")}static show(){"none"==Na.cursor&&(Na._preCursor?Na.cursor=Na._preCursor:Na.cursor="auto")}}class Oa{static __init__(){Oa.I=new Oa,Oa.supportWeakMap||e.systemTimer.loop(Oa.delInterval,null,Oa.clearCache)}static clearCache(){for(var t=0,e=Oa._maps.length;t<e;t++){Oa._maps[t]._obj={}}}constructor(){this._obj={},Oa._maps.push(this)}set(t,e){null!=t&&(Oa.supportWeakMap||("string"==typeof t||"number"==typeof t?this._obj[t]=e:(t.$_GID||(t.$_GID=P.getGID()),this._obj[t.$_GID]=e)))}get(t){return null==t?null:Oa.supportWeakMap?void 0:"string"==typeof t||"number"==typeof t?this._obj[t]:this._obj[t.$_GID]}del(t){null!=t&&(Oa.supportWeakMap||("string"==typeof t||"number"==typeof t?delete this._obj[t]:delete this._obj[this._obj.$_GID]))}has(t){return null!=t&&(!Oa.supportWeakMap&&("string"==typeof t||"number"==typeof t?null!=this._obj[t]:null!=this._obj[this._obj.$_GID]))}}Oa.supportWeakMap=!1,Oa.delInterval=6e5,Oa._maps=[];class Fa{constructor(t,e,i){this._mapArray=[],this._blockName=t,this._singgle=i,this._glPointerID=e}add(t){-1==this._mapArray.indexOf(t)&&this._mapArray.push(t)}splitBuffer(t){let e=this._mapArray.indexOf(t);-1!=e&&this._mapArray.splice(e,1)}}class Ua{static create(t,e,i,s=!1){Ua._Map.get(t)||Ua._Map.set(t,new Fa(t,l.renderEngine.getUBOPointer(t),s));let r=Ua._Map.get(t);if(r._singgle&&r._mapArray.length>0)return null;{let a=l.renderOBJCreate.createUniformBufferObject(r._glPointerID,t,e,i,s);return r._singgle&&r.add(a),a}}static getBuffer(t,e){let i=Ua._Map.get(t);return i?i._mapArray[e]:null}constructor(e,i,s,r,a){this._isSingle=!1,this.bufferType=t.BufferTargetType.UNIFORM_BUFFER,this.bufferUsage=s,this._glPointer=e,this.byteLength=r,this._name=i,this._isSingle=a,this._glBuffer=l.renderEngine.createBuffer(t.BufferTargetType.UNIFORM_BUFFER,s),this.bind(),this._isSingle&&this._bindUniformBufferBase(),this._glBuffer.setDataLength(this.byteLength)}_bindUniformBufferBase(){this._glBuffer.bindBufferBase(this._glPointer)}_bindBufferRange(t,e){this.bind(),this._glBuffer.bindBufferRange(this._glPointer,t,e)}_reset(t){this._glBuffer&&(this._glBuffer.destroy(),this._glBuffer=null),this.byteLength=t,this._glBuffer=l.renderEngine.createBuffer(this.bufferType,this.bufferUsage),this._isSingle&&this._bindUniformBufferBase(),this._glBuffer.setDataLength(this.byteLength)}bind(){return this._glBuffer.bindBuffer()}setData(t,e=0,i=Number.MAX_SAFE_INTEGER){if(!(i<0))if(this.bind(),!(0==e&&i==this.byteLength)){var s=new Uint8Array(t.buffer,e,i);this._glBuffer.setData(s,e)}else this._glBuffer.setDataEx(t,e,t.length)}setDataByUniformBufferData(t){this._updateDataInfo==t?(this.setData(t._buffer,4*t._updateFlag.x,4*(t._updateFlag.y-t._updateFlag.x)),t._resetUpdateFlag()):(this.setData(t._buffer,0,this.byteLength),t._resetUpdateFlag(),this._updateDataInfo=t)}setDataByByUniformBufferDataOffset(t,e){let i=t.getbyteLength(),s=t._realByte;t._resetUpdateFlag(),this.bind(),this._glBuffer.setDataEx(t._buffer,e*i,s/4)}destroy(){this._glBuffer&&(this._glBuffer.destroy(),this._glBuffer=null)}}var ka;Ua.UBONAME_SCENE="SceneUniformBlock",Ua.UBONAME_CAMERA="CameraUniformBlock",Ua.UBONAME_SPRITE3D="SpriteUniformBlock",Ua.UBONAME_SHADOW="ShadowUniformBlock",Ua._Map=new Map,t.MaterialRenderMode=void 0,(ka=t.MaterialRenderMode||(t.MaterialRenderMode={}))[ka.RENDERMODE_OPAQUE=0]="RENDERMODE_OPAQUE",ka[ka.RENDERMODE_CUTOUT=1]="RENDERMODE_CUTOUT",ka[ka.RENDERMODE_TRANSPARENT=2]="RENDERMODE_TRANSPARENT",ka[ka.RENDERMODE_ADDTIVE=3]="RENDERMODE_ADDTIVE",ka[ka.RENDERMODE_ALPHABLENDED=4]="RENDERMODE_ALPHABLENDED",ka[ka.RENDERMODE_CUSTOME=5]="RENDERMODE_CUSTOME";class Ga extends b{static load(t,i){e.loader.load(t,i,null,Bt.MATERIAL)}static __initDefine__(){Ga.SHADERDEFINE_ALPHATEST=ci.getDefineByName("ALPHATEST"),Ga.SHADERDEFINE_MAINTEXTURE=ci.getDefineByName("MAINTEXTURE"),Ga.SHADERDEFINE_ADDTIVEFOG=ci.getDefineByName("ADDTIVEFOG"),Ga.ALPHATESTVALUE=ci.propertyNameToID("u_AlphaTestValue"),ci.CULL=ci.propertyNameToID("s_Cull"),ci.BLEND=ci.propertyNameToID("s_Blend"),ci.BLEND_SRC=ci.propertyNameToID("s_BlendSrc"),ci.BLEND_DST=ci.propertyNameToID("s_BlendDst"),ci.BLEND_SRC_RGB=ci.propertyNameToID("s_BlendSrcRGB"),ci.BLEND_DST_RGB=ci.propertyNameToID("s_BlendDstRGB"),ci.BLEND_SRC_ALPHA=ci.propertyNameToID("s_BlendSrcAlpha"),ci.BLEND_DST_ALPHA=ci.propertyNameToID("s_BlendDstAlpha"),ci.BLEND_EQUATION=ci.propertyNameToID("s_BlendEquation"),ci.BLEND_EQUATION_RGB=ci.propertyNameToID("s_BlendEquationRGB"),ci.BLEND_EQUATION_ALPHA=ci.propertyNameToID("s_BlendEquationAlpha"),ci.DEPTH_TEST=ci.propertyNameToID("s_DepthTest"),ci.DEPTH_WRITE=ci.propertyNameToID("s_DepthWrite"),ci.STENCIL_Ref=ci.propertyNameToID("s_StencilRef"),ci.STENCIL_TEST=ci.propertyNameToID("s_StencilTest"),ci.STENCIL_WRITE=ci.propertyNameToID("s_StencilWrite"),ci.STENCIL_Op=ci.propertyNameToID("s_StencilOp")}get renderQueue(){return this._renderQueue}set renderQueue(t){this._renderQueue=t,this._notifyOwnerElements()}_setOwnerElement(t){this.ownerElements.add(t),t.materialShaderData=this.shaderData,t.materialRenderQueue=this.renderQueue,t.subShader=this._shader.getSubShaderAt(0),t.materialId=this.id}_removeOwnerElement(t){this.ownerElements.delete(t)}_notifyOwnerElements(){this.ownerElements.forEach((t=>{this._setOwnerElement(t)}))}get shaderData(){return this._shaderValues}get alphaTestValue(){return this._shaderValues.getNumber(Ga.ALPHATESTVALUE)}set alphaTestValue(t){this._shaderValues.setNumber(Ga.ALPHATESTVALUE,t)}get alphaTest(){return this.shaderData.hasDefine(Ga.SHADERDEFINE_ALPHATEST)}set alphaTest(t){t?this._shaderValues.addDefine(Ga.SHADERDEFINE_ALPHATEST):this._shaderValues.removeDefine(Ga.SHADERDEFINE_ALPHATEST)}addDefine(t){this._shaderValues.addDefine(t)}removeDefine(t){this._shaderValues.removeDefine(t)}setDefine(t,e){e?this._shaderValues.addDefine(t):this._shaderValues.removeDefine(t)}hasDefine(t){return this._shaderValues.hasDefine(t)}get depthWrite(){return this._shaderValues.getBool(ci.DEPTH_WRITE)}set depthWrite(t){this._shaderValues.setBool(ci.DEPTH_WRITE,t)}get cull(){return this._shaderValues.getInt(ci.CULL)}set cull(t){this._shaderValues.setInt(ci.CULL,t)}get blend(){return this._shaderValues.getInt(ci.BLEND)}set blend(t){this._shaderValues.setInt(ci.BLEND,t)}get blendSrc(){return this._shaderValues.getInt(ci.BLEND_SRC)}set blendSrc(t){this._shaderValues.setInt(ci.BLEND_SRC,t)}get blendDst(){return this._shaderValues.getInt(ci.BLEND_DST)}set blendDst(t){this._shaderValues.setInt(ci.BLEND_DST,t)}get blendSrcAlpha(){return this._shaderValues.getInt(ci.BLEND_SRC_ALPHA)}set blendSrcAlpha(t){this._shaderValues.setInt(ci.BLEND_SRC_ALPHA,t)}get blendSrcRGB(){return this._shaderValues.getInt(ci.BLEND_SRC_RGB)}set blendSrcRGB(t){this._shaderValues.setInt(ci.BLEND_SRC_RGB,t)}get blendDstRGB(){return this._shaderValues.getInt(ci.BLEND_DST_RGB)}set blendDstRGB(t){this._shaderValues.setInt(ci.BLEND_DST_RGB,t)}get blendDstAlpha(){return this._shaderValues.getInt(ci.BLEND_DST_ALPHA)}set blendDstAlpha(t){this._shaderValues.setInt(ci.BLEND_DST_ALPHA,t)}get blendEquation(){return this._shaderValues.getInt(ci.BLEND_EQUATION)}set blendEquation(t){this._shaderValues.setInt(ci.BLEND_EQUATION,t)}get blendEquationRGB(){return this._shaderValues.getInt(ci.BLEND_EQUATION_RGB)}set blendEquationRGB(t){this._shaderValues.setInt(ci.BLEND_EQUATION_RGB,t)}get blendEquationAlpha(){return this._shaderValues.getInt(ci.BLEND_EQUATION_ALPHA)}set blendEquationAlpha(t){this._shaderValues.setInt(ci.BLEND_EQUATION_ALPHA,t)}get depthTest(){return this._shaderValues.getInt(ci.DEPTH_TEST)}set depthTest(t){this._shaderValues.setInt(ci.DEPTH_TEST,t)}get stencilTest(){return this._shaderValues.getInt(ci.STENCIL_TEST)}set stencilTest(t){this._shaderValues.setInt(ci.STENCIL_TEST,t)}get stencilWrite(){return this._shaderValues.getBool(ci.STENCIL_WRITE)}set stencilWrite(t){this._shaderValues.setBool(ci.STENCIL_WRITE,t)}get stencilRef(){return this._shaderValues.getInt(ci.STENCIL_Ref)}set stencilRef(t){this._shaderValues.setInt(ci.STENCIL_Ref,t)}get stencilOp(){return this._shaderValues.getVector3(ci.STENCIL_Op)}set stencilOp(t){this._shaderValues.setVector3(ci.STENCIL_Op,t)}get MaterialProperty(){let t={};var e=this._shaderValues.getData();for(let i in e)t[l.renderEngine.propertyIDToName(parseInt(i))]=e[i];return t}get MaterialDefine(){let t=new Array,e=this._shaderValues.getDefineData();return ci._getNamesByDefineData(e,t),t}get materialRenderMode(){return this._matRenderNode}set materialRenderMode(e){switch(this._matRenderNode=e,e){case t.MaterialRenderMode.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=Ga.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.blend=ve.BLEND_DISABLE,this.depthTest=ve.DEPTHTEST_LESS;break;case t.MaterialRenderMode.RENDERMODE_CUTOUT:this.renderQueue=Ga.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.blend=ve.BLEND_DISABLE,this.depthTest=ve.DEPTHTEST_LESS;break;case t.MaterialRenderMode.RENDERMODE_TRANSPARENT:this.renderQueue=Ga.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=ve.BLEND_ENABLE_ALL,this.blendSrc=ve.BLENDPARAM_SRC_ALPHA,this.blendDst=ve.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=ve.DEPTHTEST_LESS;break;case t.MaterialRenderMode.RENDERMODE_ADDTIVE:this.renderQueue=Ga.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=ve.BLEND_ENABLE_ALL,this.blendSrc=ve.BLENDPARAM_SRC_ALPHA,this.blendDst=ve.BLENDPARAM_ONE,this.depthTest=ve.DEPTHTEST_LESS,this._shaderValues.addDefine(Ga.SHADERDEFINE_ADDTIVEFOG);break;case t.MaterialRenderMode.RENDERMODE_ALPHABLENDED:this.renderQueue=Ga.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=ve.BLEND_ENABLE_ALL,this.blendSrc=ve.BLENDPARAM_SRC_ALPHA,this.blendDst=ve.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=ve.DEPTHTEST_LESS,this._shaderValues.removeDefine(Ga.SHADERDEFINE_ADDTIVEFOG);break;case t.MaterialRenderMode.RENDERMODE_CUSTOME:break;default:console.warn(`Material : renderMode value error - (${e}).`)}}constructor(){super(),this.ownerElements=new Set,this._shaderValues=l.renderDeviceFactory.createShaderData(this),this.renderQueue=Ga.RENDERQUEUE_OPAQUE,this._matRenderNode=0,this.alphaTest=!1,this.cull=ve.CULL_BACK,this.blend=ve.BLEND_DISABLE,this.blendSrc=ve.BLENDPARAM_ONE,this.blendDst=ve.BLENDPARAM_ZERO,this.blendSrcRGB=ve.BLENDPARAM_ONE,this.blendDstRGB=ve.BLENDPARAM_ZERO,this.blendSrcAlpha=ve.BLENDPARAM_ONE,this.blendDstAlpha=ve.BLENDPARAM_ZERO,this.blendEquation=ve.BLENDEQUATION_ADD,this.blendEquationRGB=ve.BLENDEQUATION_ADD,this.blendEquationAlpha=ve.BLENDEQUATION_ADD,this.depthTest=ve.DEPTHTEST_LEQUAL,this.depthWrite=!0,this.stencilRef=1,this.stencilTest=ve.STENCILTEST_OFF,this.stencilWrite=!1,this.stencilOp=new d(ve.STENCILOP_KEEP,ve.STENCILOP_KEEP,ve.STENCILOP_REPLACE),this.destroyedImmediately=f.destroyResourceImmediatelyDefault}_bindShaderInfo(e){let i=e.getSubShaderAt(0)._uniformBufferDataMap;if(i)for(let e of i.keys()){let s=i.get(e).clone(),r=Ua.create(e,t.BufferUsage.Dynamic,s.getbyteLength(),!1);this._shaderValues.setUniformBuffer(ci.propertyNameToID(e),r),this._shaderValues._addCheckUBO(e,r,s)}}_releaseUBOData(){this._shaderValues._releaseUBOData()}_disposeResource(){this._releaseUBOData(),this._shaderValues.destroy(),this._shaderValues=null,this.ownerElements.clear()}get shader(){return this._shader}effectiveProperty(){return this._shader.getSubShaderAt(0)._uniformTypeMap}setShaderName(t){this._shader=ci.find(t),this._shader||(console.warn(`Material: unknown shader name '${t}'`),this._shader=ci.find("BLINNPHONG")),_._uniformBlock&&(this._releaseUBOData(),this._bindShaderInfo(this._shader));let e=this._shader.getSubShaderAt(0),i=e._uniformDefaultValue,s=e._uniformTypeMap;this.applyUniformDefaultValue(s,i),this._notifyOwnerElements()}applyUniformDefaultValue(t,e){t.forEach(((t,i)=>{if(e&&null!=e[i]){let s=e[i];this.setShaderData(i,t,s)}else{let e=ii(t);e&&this.setShaderData(i,t,e)}}))}getBoolByIndex(t){return this.shaderData.getBool(t)}setBoolByIndex(t,e){this.shaderData.setBool(t,e)}getBool(t){let e=ci.propertyNameToID(t);return this.getBoolByIndex(e)}setBool(t,e){let i=ci.propertyNameToID(t);this.setBoolByIndex(i,e)}getFloatByIndex(t){return this.shaderData.getNumber(t)}setFloatByIndex(t,e){this.shaderData.setNumber(t,e)}getFloat(t){let e=ci.propertyNameToID(t);return this.getFloatByIndex(e)}setFloat(t,e){let i=ci.propertyNameToID(t);this.setFloatByIndex(i,e)}getIntByIndex(t){return this.shaderData.getInt(t)}setIntByIndex(t,e){this.shaderData.setInt(t,e)}getInt(t){let e=ci.propertyNameToID(t);return this.getIntByIndex(e)}setInt(t,e){let i=ci.propertyNameToID(t);this.setIntByIndex(i,e)}getVector2ByIndex(t){return this.shaderData.getVector2(t)}setVector2ByIndex(t,e){this.shaderData.setVector2(t,e)}getVector2(t){let e=ci.propertyNameToID(t);return this.getVector2ByIndex(e)}setVector2(t,e){let i=ci.propertyNameToID(t);this.setVector2ByIndex(i,e)}getVector3ByIndex(t){return this.shaderData.getVector3(t)}setVector3ByIndex(t,e){this.shaderData.setVector3(t,e)}getVector3(t){let e=ci.propertyNameToID(t);return this.getVector3ByIndex(e)}setVector3(t,e){let i=ci.propertyNameToID(t);this.setVector3ByIndex(i,e)}setVector4ByIndex(t,e){this.shaderData.setVector(t,e)}getVector4ByIndex(t){return this.shaderData.getVector(t)}setVector4(t,e){let i=ci.propertyNameToID(t);this.setVector4ByIndex(i,e)}getVector4(t){let e=ci.propertyNameToID(t);return this.getVector4ByIndex(e)}getColorByIndex(t){return this.shaderData.getColor(t)}setColorByIndex(t,e){this.shaderData.setColor(t,e)}getColor(t){let e=ci.propertyNameToID(t);return this.shaderData.getColor(e)}setColor(t,e){let i=ci.propertyNameToID(t);this.setColorByIndex(i,e)}getMatrix4x4ByIndex(t){return this.shaderData.getMatrix4x4(t)}setMatrix4x4ByIndex(t,e){this.shaderData.setMatrix4x4(t,e)}getMatrix4x4(t){let e=ci.propertyNameToID(t);return this.getMatrix4x4ByIndex(e)}setMatrix4x4(t,e){let i=ci.propertyNameToID(t);this.setMatrix4x4ByIndex(i,e)}getMatrix3x3ByIndex(t){return this.shaderData.getMatrix3x3(t)}setMatrix3x3ByIndex(t,e){this.shaderData.setMatrix3x3(t,e)}getMatrix3x3(t){let e=ci.propertyNameToID(t);return this.getMatrix3x3ByIndex(e)}setMatrix3x3(t,e){let i=ci.propertyNameToID(t);this.setMatrix3x3ByIndex(i,e)}setTextureByIndex(t,e){this.shaderData.setTexture(t,e),e&&!e._texture&&e.once(r.READY,this,this.reSetTexture,[t,e])}reSetTexture(t,e){this.setTextureByIndex(t,e)}getTextureByIndex(t){return this.shaderData.getTexture(t)}setTexture(t,e){let i=ci.propertyNameToID(t);this.setTextureByIndex(i,e)}getTexture(t){let e=ci.propertyNameToID(t);return this.getTextureByIndex(e)}getBufferByIndex(t){return this.shaderData.getBuffer(t)}setBufferByIndex(t,e){this.shaderData.setBuffer(t,e)}getBuffer(t){let e=ci.propertyNameToID(t);return this.getBufferByIndex(e)}setBuffer(t,e){let i=ci.propertyNameToID(t);this.setBufferByIndex(i,e)}setShaderDataByIndex(t,e,i){this.shaderData.setShaderData(t,e,i)}setShaderData(t,e,i){let s=ci.propertyNameToID(t);this.setShaderDataByIndex(s,e,i)}getShaderData(t,e){let i=ci.propertyNameToID(t);return this.getShaderDataByIndex(i,e)}getShaderDataByIndex(t,e){return this._shaderValues.getShaderData(t,e)}cloneTo(t){t.name=this.name,t.renderQueue=this.renderQueue,t.setShaderName(this._shader._name),this._shaderValues.cloneTo(t._shaderValues)}clone(){var t=new Ga;return this.cloneTo(t),t}get _defineDatas(){return this._shaderValues.getDefineData()}oldparseEndEvent(){}}Ga.RENDERQUEUE_OPAQUE=2e3,Ga.RENDERQUEUE_ALPHATEST=2450,Ga.RENDERQUEUE_TRANSPARENT=3e3;class Va{static init(...i){if(Va._inited)return Promise.resolve();if(Va._inited=!0,ae.renderPassStatArray.length=t.RenderPassStatisticsInfo.RenderPassStatisticCount,!Ta.enable())throw new Error("Must support webGL!");let s;s="number"==typeof i[0]?{designWidth:i[0],designHeight:i[1]}:i[0],A.__init__(),O.__init__();let r=window.Laya3D;r&&(xa.changeWebGLSize=r._changeWebGLSize,Za.is3DMode=!0);let a=A.mainCanvas=new Cs(!0);Va._setStyleInfo(a),A.onKGMiniGame||A.onAlipayMiniGame||A.onTBMiniGame||A.container.appendChild(a.source),A.canvas=new Cs(!0),A.context=A.canvas.getContext("2d"),A.supportWebAudio=Ia.__init__(),A.supportLocalStorage=Ma.__init__(),t.systemTimer=new fa(!1),t.physicsTimer=new fa(!1),t.timer=new fa(!1),t.loader=new Bt,Va.systemTimer=fa.gSysTimer=t.systemTimer,Va.timer=t.timer,Va.physicsTimer=t.physicsTimer,Va.loader=t.loader,e.systemTimer=t.systemTimer,e.physicsTimer=t.physicsTimer,e.timer=t.timer,e.loader=t.loader,Oa.__init__(),Na.__init__(),cr.beginCheck();let o=[];n.beforeInit&&o.push((()=>n.beforeInit(s))),Va._beforeInitCallbacks.forEach((t=>o.push((()=>t(s))))),o.push((()=>l.renderOBJCreate.createEngine(null,A.mainCanvas))),o.push((()=>Va.initRender2D(s))),r&&o.push((()=>r.__init__())),o.push((()=>Promise.all(Va._initCallbacks.map((t=>t()))))),o.push((()=>{let t=Promise.resolve();for(let e of Va._afterInitCallbacks)t=t.then(e);return t})),n.afterInit&&o.push((()=>n.afterInit()));let h=Promise.resolve();for(let t of o)h=h.then(t);return h}static _setStyleInfo(t){let e=t.source.style;e.position="absolute",e.top=e.left="0px",e.background="#000000"}static initRender2D(i){t.stage=window.stage=e.stage=Va.stage=new Sa,Kt.__init__(),ci.init(),ee.__int__(),rs.__init__(),ss.__init__(),Va.render=Va.createRender(),t.render=Va.render,t.stage.size(i.designWidth,i.designHeight),i.scaleMode&&(t.stage.scaleMode=i.scaleMode),i.screenMode&&(t.stage.screenMode=i.screenMode),i.alignV&&(t.stage.alignV=i.alignV),i.alignH&&(t.stage.alignH=i.alignH),f.isAlpha?t.stage.bgColor="#000000":i.backgroundColor&&(t.stage.bgColor=i.backgroundColor),n.isConch&&window.conch.setGlobalRepaint&&window.conch.setGlobalRepaint(t.stage.setGlobalRepaint.bind(t.stage)),pi.__init__(),bs.__init__(),Ga.__initDefine__(),yi._Defaultinit(),ca.__init__(t.stage,Za.canvas),window.conch&&"conchUseWXAdapter"in A.window&&(ln.isAppUseNewInput=!0),ln.__init__(),Ia.autoStopMusic=!0,Ai._initone(t.RenderSpriteData.Texture2D,Pa),Ai._initone(t.RenderSpriteData.Primitive,La)}static createRender(){return new Za(0,0,A.mainCanvas)}static alertGlobalError(t){var e=0;A.window.onerror=t?function(t,i,s,r,a){e++<5&&a&&this.alert("出错啦，请把此信息截图给研发商\n"+t+"\n"+a.stack)}:null}static _runScript(t){return A.window[Va._evcode](t)}static enableDebugPanel(t="libs/laya.debugtool.js"){if(window.Laya.DebugPanel)window.Laya.DebugPanel.enable();else{var e=A.createElement("script");e.onload=function(){window.Laya.DebugPanel.enable()},e.src=t,A.document.body.appendChild(e)}}static addInitCallback(t){Va._initCallbacks.push(t)}static addBeforeInitCallback(t){Va._beforeInitCallbacks.push(t)}static addAfterInitCallback(t){Va._afterInitCallbacks.push(t)}}Va.stage=null,Va.systemTimer=null,Va.physicsTimer=null,Va.timer=null,Va.loader=null,Va._inited=!1,Va._initCallbacks=[],Va._beforeInitCallbacks=[],Va._afterInitCallbacks=[],Va._evcode="eval",Va.isNativeRender_enable=!1,e.Laya=Va,e.Loader=Bt,e.Context=os,e.Browser=A;var Ha=Va.init;t.stage=void 0,t.systemTimer=void 0,t.physicsTimer=void 0,t.timer=void 0,t.loader=void 0,t.render=void 0;var za,Wa=Va.alertGlobalError,Ya=Va.enableDebugPanel,Xa=Va.addInitCallback,ja=Va.addBeforeInitCallback,qa=Va.addAfterInitCallback;class $a extends C{static get defaultTexture(){return this._defaultTexture}static __init__(){l.renderEngine.getCapable(t.RenderCapable.Texture3D)&&(this._defaultTexture=new $a(1,1,1,t.TextureFormat.R8G8B8A8,!1,!1,!1),this._defaultTexture.lock=!0,this._defaultTexture.setPixelsData(new Uint8Array([255,255,255,255]),!1,!1))}constructor(e,i,s,r,a=!0,n,o=!1){super(e,i,r),this._dimension=t.TextureDimension.Texture2DArray,this._gammaSpace=o,this.depth=s;let h=l.textureContext;this._texture=h.createTexture3DInternal(this._dimension,e,i,s,r,a,o,!1)}setImageData(t,e,i){let s=this._texture;l.textureContext.setTexture3DImageData(s,t,this.depth,e,i)}setPixelsData(t,e,i){let s=this._texture;l.textureContext.setTexture3DPixelsData(s,t,this.depth,e,i)}setSubPixelsData(t,e,i,s,r,a,n,o,h,u,d){let c=this._texture;l.textureContext.setTexture3DSubPixelsData(c,n,o,h,t,e,i,s,r,a,u,d)}}t.TextureCubeFace=void 0,(za=t.TextureCubeFace||(t.TextureCubeFace={}))[za.PositiveX=0]="PositiveX",za[za.NegativeX=1]="NegativeX",za[za.PositiveY=2]="PositiveY",za[za.NegativeY=3]="NegativeY",za[za.PositiveZ=4]="PositiveZ",za[za.NegativeZ=5]="NegativeZ";const Ka=new Uint8Array(4);class Qa extends C{static get blackTexture(){return Qa._blackTexture}static get grayTexture(){return Qa._grayTexture}static get whiteTexture(){return Qa._whiteTexture}static get errorTexture(){return Qa._errorTexture}static __init__(){var e=new Qa(1,t.TextureFormat.R8G8B8A8,!1),i=new Qa(1,t.TextureFormat.R8G8B8A8,!1),s=new Qa(1,t.TextureFormat.R8G8B8A8,!1),r=Ka;r[0]=0,r[1]=0,r[2]=0,r[3]=255,e.setPixelsData([r,r,r,r,r,r],!1,!1),e.lock=!0,r[0]=128,r[1]=128,r[2]=128,r[3]=255,i.setPixelsData([r,r,r,r,r,r],!1,!1),i.lock=!0,r[0]=255,r[1]=255,r[2]=255,r[3]=255,s.setPixelsData([r,r,r,r,r,r],!1,!1),s.lock=!0,Qa._grayTexture=i,Qa._blackTexture=e,Qa._whiteTexture=s,Qa._errorTexture=s}constructor(e,i,s=!0,r=!1,a=!1){super(e,e,i),this._dimension=t.TextureDimension.Cube,this._texture=l.textureContext.createTextureInternal(this._dimension,e,e,i,s,r,a)}setImageData(t,e,i){let s=!1,r=t.findIndex((t=>null!=t));if(-1!=r){let e=t[r];t.every((t=>null!=t&&t.width==e.width&&t.height==e.height))||(s=!0)}else s=!0;let a=this._texture;if(s){let t=Ka;l.textureContext.setCubePixelsData(a,[t,t,t,t,t,t],e,i)}else l.textureContext.setCubeImageData(a,t,e,i)}setPixelsData(t,e,i){let s=this._texture;l.textureContext.setCubePixelsData(s,t,e,i)}updateSubPixelsData(t,e,i,s,r,a,n,o,h){let u=this._texture;l.textureContext.setCubeSubPixelData(u,t,a,n,e,i,s,r,o,h)}setDDSData(t){let e=this._texture;l.textureContext.setCubeDDSData(e,t)}setKTXData(t){let e=this._texture;l.textureContext.setCubeKTXData(e,t)}get defaultTexture(){return Qa.grayTexture}}class Za{static customRequestAnimationFrame(t,e){Za._customRequestAnimationFrame=t,Za._loopFunction=e}static set customRenderEngine(t){Za._customEngine=t}static get customRenderEngine(){return Za._customEngine}static gc(){n.isConch&&window.gc({type:"major",execution:"async"})}constructor(t,i,s){this._first=!0,this._startTm=0,this._timeId=0,Za._Render=this,Za._mainCanvas=s;let r=Za._mainCanvas.source;r.id="layaCanvas",r.width=t,r.height=i,n.isConch&&(document.body.appendChild(r),Za._mainCanvas.getContext("2d")),this.initRender(Za._mainCanvas,t,i),f._enableWindowRAFFunction?window.requestAnimationFrame(h):requestAnimationFrame(h);let a=this;performance.now();let l=f.FPS,o=Za.ifps=1e3/l;function h(t){performance.now(),a._first&&(a._startTm=Math.floor(t/o)*o,a._first=!1),t-=a._startTm;let i=Math.floor(t/o);(i-Za.lastFrm>0||!f.fixedFrames)&&(Za.lastFrm=i,e.stage._loop()),Za._customRequestAnimationFrame&&Za._loopFunction?Za._customRequestAnimationFrame(Za._loopFunction):f._enableWindowRAFFunction?window.requestAnimationFrame(h):requestAnimationFrame(h)}e.stage.on("visibilitychange",this,this._onVisibilitychange),n.isConch&&Va.timer.frameOnce(2,null,Za.gc)}_onVisibilitychange(){e.stage.isVisibility?0!=this._timeId&&window.clearInterval(this._timeId):this._timeId=window.setInterval(this._enterFrame,1e3)}static vsyncTime(){return Za.lastFrm*Za.ifps}initRender(t,e,i){t.size(e,i),Ri.__init__(),os.__init__();var s=new os;return s.isMain=!0,Za._context=s,t._setContext(s),Ci.__init__(),fi._init_(),ct.__init__(),Qa.__init__(),$a.__init__(),Y.__init__(),!0}_enterFrame(t=null){e.stage._loop()}static get context(){return Za._context}static get canvas(){return Za._mainCanvas.source}}Za.lastFrm=0,Za.ifps=1e3/60;const Ja={Int8Array:Int8Array,Uint8Array:Uint8Array,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};var tn,en,sn;class rn{static decodeObj(t,e,i){i?(tn=i.outErrors,en=i.getNodeByRef,sn=i.getNodeData):(tn=null,en=null,sn=null),rn.isDeserializing=!0;try{return rn._decodeObj(t,e)}finally{rn.isDeserializing=!1}}static _decodeObj(t,i){if(null==t)return null;if(Array.isArray(t)){let e=[];for(let i=0;i<t.length;i++){let s=t[i];if(null!=s)try{e[i]=rn._decodeObj(s)}catch(t){tn&&tn.push(t),e[i]=null}else e[i]=null}return e}if("object"==typeof t){if(null!=t._$uuid){let i=O.getResURLByUUID(t._$uuid);return e.loader.getRes(i,rn.getLoadTypeByEngineType(t._$type))}if(null!=t._$ref){let e=null==en?void 0:en(t._$ref);if(e&&t._$type){let i=Ot.getClass(t._$type);return i?e.getComponent(i):null}return e}let s=t._$type;if("any"===s)return t._$type?t.value:t;let r=Ja[s];if(null!=r)return t._$type?new r(t.value):new r(t);if(!i){let t=Ot.getClass(s);if(!t)return null;i=new t}for(let e in t){if(e.startsWith("_$"))continue;let s=t[e];if(null==s||"object"!=typeof s||Array.isArray(s)||s._$type||s._$uuid||s._$ref)try{let t=rn._decodeObj(s);i[e]=t,null!=t&&null!=s&&s._$tmpl&&(i[s._$tmpl]=sn(t))}catch(t){tn&&tn.push(t)}else{let t=i[e];if(t)try{rn._decodeObj(s,t)}catch(t){tn&&tn.push(t)}}}return i.onAfterDeserialize&&i.onAfterDeserialize(),i}return t}static getLoadTypeByEngineType(t){switch(t){case"Texture2D":case"RenderTexture":return Bt.TEXTURE2D;case"TextureCube":return Bt.TEXTURECUBE;case"Prefab":return Bt.HIERARCHY;case"Material":return Bt.MATERIAL;case"Mesh":return Bt.MESH;default:return null}}static bakeOverrideData(t){let e=null;for(let i=t.length,s=i-1;s>=0;s--){let r=t[s];if(r&&r.length>0)for(let t of r){let r,a=t._$override||t._$parent;if(Array.isArray(a)?r=a[i-s-1]:s==i-1&&(r=a),null!=r){e||(e={});let a=e[r];a||(e[r]=a=[]),a.push(i-s,t)}}}return e}static applyOverrideData(t,e){return function t(i){if(e[i._$id])return!0;let s=i._$child;return!(!s||!s.find((e=>t(e))))}(t)&&(t=function t(e){let i=Object.assign({},e),s=i._$child;s&&(i._$child=s.map((e=>t(e))));let r=i._$comp;return r&&(i._$comp=r.map((t=>Object.assign({},t)))),i}(t),function t(i){let s=i._$child;if(s)for(let e of s)e._$id&&t(e);let r=e[i._$id];if(r)for(let t=0;t<r.length;t+=2){let e,a=r[t],n=r[t+1];if(e=n._$override){let t;if(Array.isArray(e))if(a==e.length-1){let r=e[a];s?t=s.find((t=>t._$override==r)):i._$child=s=[],t||(t={_$override:r},s.push(t))}else if(a<e.length-1){let r=e.slice(a);s?t=s.find((t=>{let e=t._$override;return Array.isArray(e)&&nn(e,r)})):i._$child=s=[],t||(t={_$override:r},s.push(t))}else t=i;else t=i;if(an(t,n),n._$comp){let e=t._$comp;e||(t._$comp=e=[]);for(let t of n._$comp){let i=t._$type||t._$override,s=e.find((t=>t._$override==i||t._$type==i||t._$id==i));s||(s={},t._$type?s._$type=i:s._$override=i,e.push(s)),an(s,t)}}}else if(e=n._$parent){let t;if(s||(i._$child=s=[]),a<e.length){t=a==e.length-1?e[a]:e.slice(a);let i=Object.assign({},n);i._$parent=t,s.push(i)}else{let t=Object.assign({},n);delete t._$parent,i._$prefab?s.push(t):(delete t._$index,n._$index<s.length?s.splice(n._$index,0,t):s.push(t))}}}}(t)),t}}function an(t,e){for(let i in e){if(i.startsWith("_$"))continue;let s=e[i];if(null==s||"object"!=typeof s||Array.isArray(s)||(s._$type||s._$uuid||s._$ref))t[i]=s;else{let e=t[i];null!=e&&"object"==typeof e?(t[i]=e=Object.assign({},e),an(e,s)):t[i]=s}}}function nn(t,e){if(t.length===e.length){for(var i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}return!1}rn.isDeserializing=!1;class ln extends Yr{constructor(){super(),this._multiline=!1,this._editable=!0,this._maxChars=0,this._type="text",ln.IOS_IFRAME=e.Browser.onIOS&&e.Browser.window.top!=e.Browser.window.self,this._width=100,this._height=20,this.multiline=!1,this.overflow=Yr.SCROLL,this._promptColor="#A9A9A9",this.on(r.MOUSE_DOWN,this,this._onMouseDown),this.on(r.UNDISPLAY,this,this._onUnDisplay)}static __init__(){if(ln._createInputElement(),e.Browser.onMobile){var t=!1;(e.Browser.onMiniGame||e.Browser.onBDMiniGame||e.Browser.onQGMiniGame||e.Browser.onKGMiniGame||e.Browser.onVVMiniGame||e.Browser.onAlipayMiniGame||e.Browser.onQQMiniGame||e.Browser.onBLMiniGame||e.Browser.onTTMiniGame||e.Browser.onHWMiniGame||e.Browser.onTBMiniGame)&&(t=!0),Za.canvas.addEventListener(ln.IOS_IFRAME?t?"touchend":"click":"touchend",ln._popupInputMethod)}}static _popupInputMethod(t){ca.isTextInputting&&ln.inputElement.focus()}static _createInputElement(){ln._initInput(ln.area=e.Browser.createElement("textarea")),ln._initInput(ln.input=e.Browser.createElement("input")),ln.inputContainer=e.Browser.createElement("div"),ln.inputContainer.style.position="absolute",ln.inputContainer.style.zIndex="1E5",e.Browser.container.appendChild(ln.inputContainer),ln.inputContainer.setPos=function(t,e){ln.inputContainer.style.left=t+"px",ln.inputContainer.style.top=e+"px"}}static _initInput(t){var e=t.style;e.cssText="position:absolute;overflow:hidden;resize:none;transform-origin:0 0;-webkit-transform-origin:0 0;-moz-transform-origin:0 0;-o-transform-origin:0 0;",e.resize="none",e.backgroundColor="transparent",e.border="none",e.outline="none",e.zIndex="1",t.addEventListener("input",ln._processInputting),t.addEventListener("mousemove",ln._stopEvent,{passive:!1}),t.addEventListener("mousedown",ln._stopEvent,{passive:!1}),t.addEventListener("touchmove",ln._stopEvent,{passive:!1}),t.setFontFace=function(e){t.style.fontFamily=e},n.isConch&&!ln.isAppUseNewInput||(t.setColor=function(e){t.style.color=e},t.setFontSize=function(e){t.style.fontSize=e+"px"})}static _processInputting(t){var e=ln.inputElement.target;if(e){var i=ln.inputElement.value;e._restrictPattern&&(i=i.replace(/\u2006|\x27/g,""),e._restrictPattern.test(i)&&(i=i.replace(e._restrictPattern,""),ln.inputElement.value=i)),null==i&&(i=""),e._text=i,e.event(r.INPUT)}}static _stopEvent(t){"touchmove"==t.type&&t.preventDefault(),t.stopPropagation&&t.stopPropagation()}setSelection(t,e){this.focus=!0,ln.inputElement.selectionStart=t,ln.inputElement.selectionEnd=e}get multiline(){return this._multiline}set multiline(t){this._multiline=t,rn.isDeserializing||(this.valign=t?"top":"middle")}get nativeInput(){return this._multiline?ln.area:ln.input}_onUnDisplay(t=null){this.focus=!1}_onMouseDown(t){this.focus=!0}_syncInputTransform(){var t=this.nativeInput,i=Dr.getTransformRelativeToWindow(this,this._padding[3],this._padding[0]),s=this._width-this._padding[1]-this._padding[3],r=this._height-this._padding[0]-this._padding[2];n.isConch&&!ln.isAppUseNewInput?(t.setScale(i.scaleX,i.scaleY),t.setSize(s,r),t.setPos(i.x,i.y)):(ln.inputContainer.style.transform=ln.inputContainer.style.webkitTransform="scale("+i.scaleX+","+i.scaleY+") rotate("+e.stage.canvasDegree+"deg)",t.style.width=s+"px",t.style.height=r+"px",ln.inputContainer.style.left=i.x+"px",ln.inputContainer.style.top=i.y+"px")}select(){this.nativeInput.select()}get focus(){return this._focus}set focus(t){var i=this.nativeInput;this._focus!==t&&(t?(i.target?i.target._focusOut():this._setInputMethod(),(i=this.nativeInput).target=this,this._focusIn()):(i.target=null,this._focusOut(),e.Browser.document.body.scrollTop=0,i.blur(),n.isConch&&!ln.isAppUseNewInput?i.setPos(-1e4,-1e4):ln.inputContainer.contains(i)&&ln.inputContainer.removeChild(i)))}_setInputMethod(){ln.input.parentElement&&ln.inputContainer.removeChild(ln.input),ln.area.parentElement&&ln.inputContainer.removeChild(ln.area),e.Browser.onAndroid&&(ln.input=ln.inputElement=e.Browser.createElement("input"),ln._initInput(ln.input)),ln.inputElement=this._multiline?ln.area:ln.input,ln.inputContainer.appendChild(ln.inputElement),Yr.RightToLeft&&(ln.inputElement.style.direction="rtl")}_focusIn(){ca.isTextInputting=!0;var t=this.nativeInput;ln.input&&(ln.input.type=this._type),this._focus=!0;var i=t.style;i.whiteSpace=this.wordWrap?"pre-wrap":"nowrap",this._setPromptColor(),t.readOnly=!this._editable,n.isConch&&!ln.isAppUseNewInput&&(t.setType(this._type),t.setForbidEdit(!this._editable)),t.maxLength=this._maxChars<=0?1e5:this._maxChars,t.value=this._text,t.placeholder=this._prompt,e.stage.off(r.KEY_DOWN,this,this._onKeyDown),e.stage.on(r.KEY_DOWN,this,this._onKeyDown),e.stage.focus=this,this.event(r.FOCUS),e.Browser.onPC&&t.focus(),n.isConch&&ln.isAppUseNewInput||e.Browser.onMiniGame||e.Browser.onBDMiniGame||e.Browser.onQGMiniGame||e.Browser.onKGMiniGame||e.Browser.onVVMiniGame||e.Browser.onAlipayMiniGame||e.Browser.onQQMiniGame||e.Browser.onBLMiniGame||e.Browser.onTTMiniGame||e.Browser.onHWMiniGame||e.Browser.onTBMiniGame||(this.graphics.clear(!0),this.drawBg(),this._hideText=!0),t.setColor(this.color),t.setFontSize(this.fontSize),t.setFontFace(this._realFont),n.isConch&&!ln.isAppUseNewInput&&t.setMultiAble&&t.setMultiAble(this._multiline),i.lineHeight=this.leading+this.fontSize+"px",i.fontStyle=this.italic?"italic":"normal",i.fontWeight=this.bold?"bold":"normal",i.textAlign=this.align,i.padding="0 0",this._syncInputTransform(),!n.isConch&&e.Browser.onPC&&e.systemTimer.frameLoop(1,this,this._syncInputTransform)}_setPromptColor(){ln.promptStyleDOM=e.Browser.getElementById("promptStyle"),ln.promptStyleDOM||(ln.promptStyleDOM=e.Browser.createElement("style"),ln.promptStyleDOM.setAttribute("id","promptStyle"),e.Browser.document.head.appendChild(ln.promptStyleDOM)),ln.promptStyleDOM.innerText="input::-webkit-input-placeholder, textarea::-webkit-input-placeholder {color:"+this._promptColor+"}input:-moz-placeholder, textarea:-moz-placeholder {color:"+this._promptColor+"}input::-moz-placeholder, textarea::-moz-placeholder {color:"+this._promptColor+"}input:-ms-input-placeholder, textarea:-ms-input-placeholder {color:"+this._promptColor+"}"}_focusOut(){ca.isTextInputting&&(ca.isiOSWKwebView||(ca.isTextInputting=!1),this._focus=!1,this._hideText=!1,this.text=this.nativeInput.value,this.markChanged(),this.typeset(),e.stage.off(r.KEY_DOWN,this,this._onKeyDown),e.stage.focus=null,this.event(r.BLUR),this.event(r.CHANGE),n.isConch&&!ln.isAppUseNewInput&&this.nativeInput.blur(),e.Browser.onPC&&e.systemTimer.clear(this,this._syncInputTransform))}_onKeyDown(t){13===t.keyCode&&(e.Browser.onMobile&&!this._multiline&&(this.focus=!1),this.event(r.ENTER))}miniGameTxt(t){t+="",this._multiline||(t=t.replace(/\r?\n/g,"")),this.text=t}get text(){return this._focus?this.nativeInput.value:super.text}set text(t){null==t?t="":"string"!=typeof t&&(t=""+t),this._focus?(this.nativeInput.value=t,this.event(r.CHANGE)):(this._multiline||(t=t.replace(/\r?\n/g,"")),super.text=t)}set_color(t){this._focus&&this.nativeInput.setColor(t),super.set_color(t)}get bgColor(){return super.bgColor}set bgColor(t){super.bgColor=t,n.isConch&&!ln.isAppUseNewInput&&this.nativeInput.setBgColor(t)}get restrict(){return this._restrict}set restrict(t){this._restrict=t,t?((t="[^"+t+"]").indexOf("^^")>-1&&(t=t.replace("^^","")),this._restrictPattern=new RegExp(t,"g")):this._restrictPattern=null}get editable(){return this._editable}set editable(t){this._editable=t,n.isConch&&!ln.isAppUseNewInput&&ln.input.setForbidEdit(!t)}get maxChars(){return this._maxChars}set maxChars(t){this._maxChars=t}get prompt(){return this._prompt}set prompt(t){var e;t=(null===(e=Yr.langPacks)||void 0===e?void 0:e[t])||t,this._prompt!=t&&(this._prompt=t,this.markChanged())}get promptColor(){return this._promptColor}set promptColor(t){this._promptColor!=t&&(this._promptColor=t,this.markChanged())}get type(){return this._type}set type(t){this._asPassword="password"===t,this._type=t,this.markChanged()}}ln.TYPE_TEXT="text",ln.TYPE_PASSWORD="password",ln.TYPE_EMAIL="email",ln.TYPE_URL="url",ln.TYPE_NUMBER="number",ln.TYPE_RANGE="range",ln.TYPE_DATE="date",ln.TYPE_MONTH="month",ln.TYPE_WEEK="week",ln.TYPE_TIME="time",ln.TYPE_DATE_TIME="datetime",ln.TYPE_DATE_TIME_LOCAL="datetime-local",ln.TYPE_SEARCH="search",ln.IOS_IFRAME=!1,ln.isAppUseNewInput=!1;class on extends Vt{constructor(){super(),this._top=null,this._bottom=null,this._left=null,this._right=null,this._centerX=null,this._centerY=null,this.runInEditor=!0,this.hideFlags|=Gt.HideAndDontSave}onReset(){this._top=this._bottom=this._left=this._right=this._centerX=this._centerY=null}_onEnable(){this.owner.parent?this._onAdded():this.owner.once(r.ADDED,this,this._onAdded)}_onDisable(){this.owner.off(r.ADDED,this,this._onAdded),this.owner.parent&&this.owner.parent.off(r.RESIZE,this,this._onParentResize)}_onAdded(){this.owner.parent&&this.owner.parent.on(r.RESIZE,this,this._onParentResize),this.resetLayoutX(),this.resetLayoutY()}_onParentResize(){var t=this.resetLayoutX(),e=this.resetLayoutY();(t||e)&&this.owner.event(r.RESIZE)}resetLayoutX(){var t=this.owner;if(!t)return!1;var e=t.parent;if(e)if(null!=this._centerX)t.x=Math.round(.5*(e.width-t.displayWidth)+this._centerX+t.pivotX*t.scaleX);else if(null!=this._left){if(t.x=Math.round(this._left+t.pivotX*t.scaleX),null!=this._right){if(!e._width)return!1;var i=(e._width-this._left-this._right)/(t.scaleX||.01);if(i!=t._width)return t.width=i,!0}}else null!=this._right&&(t.x=Math.round(e.width-t.displayWidth-this._right+t.pivotX*t.scaleX));return!1}resetLayoutY(){var t=this.owner;if(!t)return!1;var e=t.parent;if(e)if(null!=this._centerY)t.y=Math.round(.5*(e.height-t.displayHeight)+this._centerY+t.pivotY*t.scaleY);else if(null!=this._top){if(t.y=Math.round(this._top+t.pivotY*t.scaleY),null!=this._bottom){if(!e._height)return!1;var i=(e._height-this._top-this._bottom)/(t.scaleY||.01);if(i!=t._height)return t.height=i,!0}}else null!=this._bottom&&(t.y=Math.round(e.height-t.displayHeight-this._bottom+t.pivotY*t.scaleY));return!1}resetLayout(){this.owner&&(this.resetLayoutX(),this.resetLayoutY())}get top(){return this._top}set top(t){isNaN(t)&&(t=null),this._top!=t&&(this._top=t,this.resetLayoutY())}get bottom(){return this._bottom}set bottom(t){isNaN(t)&&(t=null),this._bottom!=t&&(this._bottom=t,this.resetLayoutY())}get left(){return this._left}set left(t){isNaN(t)&&(t=null),this._left!=t&&(this._left=t,this.resetLayoutX())}get right(){return this._right}set right(t){isNaN(t)&&(t=null),this._right!=t&&(this._right=t,this.resetLayoutX())}get centerX(){return this._centerX}set centerX(t){isNaN(t)&&(t=null),this._centerX!=t&&(this._centerX=t,this.resetLayoutX())}get centerY(){return this._centerY}set centerY(t){isNaN(t)&&(t=null),this._centerY!=t&&(this._centerY=t,this.resetLayoutY())}}on.EMPTY=null,on.EMPTY=new on;class hn extends b{constructor(t){super(),this.version=t,this._traceDeps=!0}create(t,e){return this.json?_n.legacySceneOrPrefab.createByData(null,this.json):null}}var un=hn;class dn extends hn{constructor(t,e,i){super(i),this.api=t,this.data=e}create(t,e){let i=this.api.parse(this.data,t,e);return Array.isArray(i)?(1==i.length&&(i[0].url=this.url),i[0]):(i.url=this.url,i)}}class cn{static parse(t,e,i){let s=null==i;i=i||[];let r,a,n,l,o,h,u,d={},c=[],_=[],p=[];function f(t,e){for(let i of t._$child)if(i._$child){let t=g(i,e);f(i,i._$prefab?t:e),c.push(i),_.push(t)}else{let t=g(i,e);c.push(i),_.push(t)}}function g(t,e,s){let r,a;if(a=t._$override){if(e&&n)if(Array.isArray(a)){r=e;for(let t=0,e=a.length;t<e;t++){let e=n.get(r);if(r=null==e?void 0:e[a[t]],!r)break}}else{let i=n.get(e);i&&(r=i[t._$override])}}else{if(a=t._$prefab){let e=Bt.getRes(O.getResURLByUUID(a),Bt.HIERARCHY);if(e){n||(n=new Map);let s=[],a=t._$id;if(o)for(let t=0,e=o.length;t<e;t++){let i=o[t];i&&i.length>0?s[t]=i.filter((i=>{let s=i._$override||i._$parent;return Array.isArray(s)&&s.length>e-t&&s[e-t-1]==a})):s[t]=i}s.push(t._$child),r=e.create({inPrefab:!0,prefabNodeDict:n,overrideData:s},i)}}else if(a=t._$type){let t=Ot.getClass(s||a);if(t)try{r=new t,null==s||r instanceof yr||(i.push(new Error(`runtime class invalid - '${s}', must derive from Node`)),r=null)}catch(t){i.push(t)}else i.push(new Error(`unknown type '${s||a}'`))}r&&(d[t._$id]=r)}return r}function m(t,e,i=0){if(!e)return t;let s=null==n?void 0:n.get(t);if(!s)return null;if(Array.isArray(e)){let t;for(let r=i,a=e.length;r<a;r++){if(!s)return null;if(t=s[e[r]],!t)break;s=n.get(t)}return t}return s[e]}if(e&&(a=e.inPrefab,a&&(n=e.prefabNodeDict),l=e.skinBaseUrl,o=e.overrideData),t._$type||t._$prefab){u=t._$runtime,u&&u.startsWith("res://")&&(u=u.substring(6));let e=g(t,null,u);e&&(t._$child&&f(t,t._$prefab?e:null),c.push(t),_.push(e),e instanceof pn&&(r=e))}else t._$child&&f(t,null);let y=c.length,T=0,x=[];for(let t=0;t<y;t++){let e=c[t],i=_[t],s=e._$child;if(s){let t=s.length;if(i)if(e._$prefab)for(let e=0;e<t;e++){let s=T-t+e,r=p[s];if(r&&!r.parent){let t=x[s],e=m(i,t._$parent);if(e){let i=t._$index;null!=i&&i<e.numChildren?e.addChildAt(r,i):e.addChild(r)}else i.addChildAt(r,0)}}else for(let e=0;e<t;e++){let s=p[T-t+e];s&&(i===r&&s._is3D?r._scene3D=s:i.addChild(s))}T-=t}p[T]=i,x[T]=e,T++}p.length=T,p=p.filter((t=>null!=t));let v=p[0],S=[];for(let t=0;t<y;t++){let e=c[t]._$comp;if(!e)continue;let s=_[t];if(s)for(let t of e){let e,r=t._$override;if(t._$override){let t=Ot.getClass(r);e=t?s.getComponent(t):s.components.find((t=>t._extra.storeId==r))}else{let r=Ot.getClass(t._$type);if(r&&(t._$id||(e=s.getComponent(r)),!e))try{e=s.addComponent(r),e._extra.storeId=t._$id}catch(t){i.push(t)}}e&&S.push(t,e)}}const E={outErrors:i,getNodeByRef:function(t){if(Array.isArray(t)){let e=d[t[0]];return e&&t.length>1?m(e,t,1):e}return d[t]},getNodeData:function(t){t.visible=!1;let e=_.indexOf(t),i=c[e];return o?(void 0===h&&(h=rn.bakeOverrideData(o)),h?rn.applyOverrideData(i,h):i):i}};for(let t=0;t<y;t++){let e=c[t],s=_[t];if(s&&(null!=l&&s instanceof br&&(s._skinBaseUrl=l),rn.decodeObj(e,s,E),u&&e._$var&&s.name))try{v[s.name]=s}catch(t){i.push(t)}}y=S.length;for(let t=0;t<y;t+=2)rn.decodeObj(S[t],S[t+1],E);return a&&n&&v&&n.set(v,d),s&&i.length>0&&i.forEach((t=>console.error(t))),p}static collectResourceLinks(t,e){let i,s={},r=[];function a(t,i){if(!t)return"";let a=s[t];if(void 0===a){let n;n=P.isUUID(t)?"res://"+t:O.join(e,t),r.push({url:n,type:i}),s[t]=a=[n,i]}else-1==a.indexOf(i,1)&&(a.push(i),r.push({url:a[0],type:i}));return a[0]}function l(t){if(null==t._$uuid){if(null!=t._$prefab)t._$prefab=a(t._$prefab,Bt.HIERARCHY);else if(null!=(i=t._$type))if(i.endsWith(".bp"))a(i,null);else if(n.isPreview&&P.isUUID(i)){let t=Ot.getClass(i);(null==t||t._$loadable)&&a("res://"+i,null)}o(t)}else t._$uuid=a(t._$uuid,rn.getLoadTypeByEngineType(t._$type))}function o(t){for(let e in t){let i=t[e];if(null!=i)if(Array.isArray(i))for(let t of i)null!=t&&"object"==typeof t&&l(t);else"object"==typeof i&&l(i)}}if(o(t),t._$preloads)for(let e of t._$preloads)r.push(e);return r}}class _n{load(t){let e=t.url;return("gltf"==t.ext||"fbx"==t.ext||"glb"==t.ext||"obj"==t.ext)&&(e=N.inst.getSubAssetURL(e,t.uuid,"0","lh")),t.loader.fetch(e,"json",t.progress.createCallback(.2),t.options).then((e=>e?null!=e._$ver?this._load(_n.v3,t,e,3):"ls"==t.ext||"lh"==t.ext?this._load(_n.v2,t,e,2):"scene"==t.ext||"prefab"==t.ext?this._load(_n.legacySceneOrPrefab,t,e,2):null:null))}_load(t,e,i,s){let r=O.getPath(e.url),a=t.collectResourceLinks(i,r),n=Object.assign({},e.options);return n.initiator=e,delete n.cache,delete n.ignoreCache,e.loader.load(a,n,e.progress.createCallback()).then((e=>{let r=new dn(t,i,s);return r.addDeps(e),r}))}}_n.v3=cn,_n.v2=null,Bt.registerLoader(["lh","ls","scene","prefab"],_n,Bt.HIERARCHY);class pn extends br{constructor(t=!0){super(),this.autoDestroyAtClosed=!1,this._viewCreated=!1,this._timer=e.timer,this._widget=on.EMPTY,this._scene=this,t&&this.createChildren()}createChildren(){}static setUIMap(t){let i=e.loader.getRes(t);if(!i)throw"请提前加载uimap的json，再使用该接口设置！";for(let t in i)e.Loader.loadedMap[t+".scene"]=i[t]}loadScene(t){pn.unDestroyedScenes.add(this);let i=t.indexOf(".")>-1?t:t+".scene",s=e.loader.getRes(i);s?this._viewCreated||(s.create({root:this}),this._viewCreated=!0,pn.unDestroyedScenes.add(this)):(this._setBit(kt.NOT_READY,!0),e.loader.load(i,null,(t=>{pn._loadPage&&pn._loadPage.event("progress",t)})).then((e=>{if(!e)throw"Can not find scene:"+t;this._viewCreated?this._setBit(kt.NOT_READY,!1):(this.url=i,pn.hideLoadingPage(),e.create({root:this}),this._viewCreated=!0,pn.unDestroyedScenes.add(this))})))}createView(t){t&&!this._viewCreated&&(this._viewCreated=!0,_n.legacySceneOrPrefab.createByData(this,t))}getNodeByID(t){return this._idMap?this._idMap[t]:null}open(t=!0,i=null){t&&pn.closeAll(),pn.root.addChild(this),this._scene3D&&e.stage.addChildAt(this._scene3D,0),this.onOpened(i)}onOpened(t){}close(t=null){this.onClosed(t),this.autoDestroyAtClosed?(this.destroy(),this._scene3D&&this._scene3D.destroy()):(this.removeSelf(),this._scene3D&&this._scene3D.removeSelf())}onClosed(t=null){}destroy(t=!0){super.destroy(t),this._scene3D&&(this._scene3D.destroy(),this._scene3D=null),this._idMap=null,pn.unDestroyedScenes.delete(this)}get_width(){if(this._isWidthSet)return this._width;for(var t=0,e=this.numChildren-1;e>-1;e--){var i=this.getChildAt(e);i._visible&&(t=Math.max(i._x+i.width*i.scaleX,t))}return t}get_height(){if(this._isHeightSet)return this._height;for(var t=0,e=this.numChildren-1;e>-1;e--){var i=this.getChildAt(e);i._visible&&(t=Math.max(i._y+i.height*i.scaleY,t))}return t}get timer(){return this._timer}set timer(t){this._timer=t}get scene3D(){return this._scene3D}get top(){return this._widget.top}set top(t){t!=this._widget.top&&(this._getWidget().top=t)}get bottom(){return this._widget.bottom}set bottom(t){t!=this._widget.bottom&&(this._getWidget().bottom=t)}get left(){return this._widget.left}set left(t){t!=this._widget.left&&(this._getWidget().left=t)}get right(){return this._widget.right}set right(t){t!=this._widget.right&&(this._getWidget().right=t)}get centerX(){return this._widget.centerX}set centerX(t){t!=this._widget.centerX&&(this._getWidget().centerX=t)}get centerY(){return this._widget.centerY}set centerY(t){t!=this._widget.centerY&&(this._getWidget().centerY=t)}_shouldRefreshLayout(){super._shouldRefreshLayout(),this.callLater(this._sizeChanged)}_sizeChanged(){this.event(r.RESIZE),this._widget!==on.EMPTY&&this._widget.resetLayout()}freshLayout(){this._widget!=on.EMPTY&&this._widget.resetLayout()}_getWidget(){return this._widget===on.EMPTY&&(this._widget=this.addComponent(on)),this._widget}static get root(){let t=pn._root;return t||(t=pn._root=e.stage.addChild(new br),t.name="root",t.mouseThrough=!0,e.stage.on("resize",null,(()=>{t.size(e.stage.width,e.stage.height),t.event(r.RESIZE)})),t.size(e.stage.width,e.stage.height),t.event(r.RESIZE)),t}static load(t,i=null,s=null){return e.loader.load(t,null,(t=>{pn._loadPage&&pn._loadPage.event("progress",t),s&&s.runWith(t)})).then((e=>{if(!e)throw"Can not find scene:"+t;let s,r=[],a=e.create(null,r);if(r.length>0&&console.warn(`Error loading ${t}: \n${r.join("\n")}`),a instanceof pn)s=a;else{if(!a._is3D)throw"Not a scene:"+t;s=new pn,s.left=s.right=s.top=s.bottom=0,s._scene3D=a}return s._viewCreated=!0,s._scene3D&&(s._scene3D._scene2D=s),pn.unDestroyedScenes.add(s),pn.hideLoadingPage(),i&&i.runWith(s),s}))}static open(t,e=!0,i=null,s=null,r=null){if(i instanceof St){var a=s;s=i,i=a}return pn.showLoadingPage(),pn.load(t,St.create(null,this._onSceneLoaded,[e,s,i]),r)}static _onSceneLoaded(t,e,i,s){s.open(t,i),e&&e.runWith(s)}static close(t,e){let i=!1;for(let s of pn.unDestroyedScenes)if(s&&s.parent&&s.url===t&&(null==e||s.name==e)){s.close(),i=!0;break}return i}static closeAll(){let t=pn.root;for(let i=0,s=t.numChildren;i<s;i++){var e=t.getChildAt(0);e instanceof pn?e.close():e.removeSelf()}}static destroy(t,e){let i=!1;for(let s of pn.unDestroyedScenes)if(s.url===t&&(null==e||s.name==e)&&!s._destroyed){s.destroy(),i=!0;break}return i}static gc(){b.destroyUnusedResources()}static setLoadingPage(t){pn._loadPage=t}static showLoadingPage(t=null,i=500){pn._loadPage&&(e.systemTimer.clear(null,pn._showLoading),e.systemTimer.clear(null,pn._hideLoading),e.systemTimer.once(i,null,pn._showLoading,[t],!1))}static _showLoading(t){e.stage.addChild(pn._loadPage),pn._loadPage instanceof pn&&pn._loadPage.onOpened(t)}static _hideLoading(){pn._loadPage instanceof pn?pn._loadPage.close():pn._loadPage.removeSelf()}static hideLoadingPage(t=500){pn._loadPage&&(e.systemTimer.clear(null,pn._showLoading),e.systemTimer.clear(null,pn._hideLoading),e.systemTimer.once(t,null,pn._hideLoading))}}pn.unDestroyedScenes=new Set;var fn={};class gn extends ie{constructor(t=4){super(),this.shaderData=new Pa,this._shaderV1=new u,this.strength=t}get strength(){return this._strength}set strength(t){this._strength=Math.max(Math.abs(t),2);var e=this._strength/3,i=e*e;let s=this._shaderV1=new u(this.strength,i,2*i,1/(2*Math.PI*i)),r=0,a=Math.floor(10*this.strength);if(null!=fn[a])r=fn[a];else{for(let t=-4;t<=4;++t)for(let e=-4;e<=4;++e)r+=s.w*Math.exp(-(e*e+t*t)/s.z);fn[a]=r}s.w/=r,this.onChange()}render(e,i,s){let r=50;this.left=-50,this.top=-50;let a=i+100,n=s+100;this.width=a,this.height=n,this.texture&&!this.texture.destroyed&&this.texture.width==a&&this.texture.height==n||(this.texture&&this.texture.destroy(),this.texture=new pt(a,n,t.RenderTargetFormat.R8G8B8A8));let l=this._render2D.clone(this.texture);l.renderStart(!0,new _t(0,0,0,0));let o=this._rectMeshVB,h=this._rectMesh.vertexDeclarition.vertexStride/4;o[0]=50,o[1]=r,o[h]=50+i,o[h+1]=r,o[2*h]=50+i,o[2*h+1]=r+s,o[3*h]=r,o[3*h+1]=r+s;let u=this.shaderData;u.shaderData.addDefine(Ri.FILTERBLUR),u.size=new Ze(a,n),u.textureHost=e,u.blurInfo=new Ze(a,n),u.strength_sig2_2sig2_gauss1=this._shaderV1,l.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,u,null),l.renderEnd()}}const mn=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10],yn=[.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,0,0,0,1,0],Tn=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1];class xn extends ie{constructor(t=null){super(),t||(t=this._copyMatrix(Tn)),this._mat=new Float32Array(16),this._alpha=new Float32Array(4),this.setByMatrix(t)}render(e,i,s){let r=i,a=s;this.width=r,this.height=a,this.texture&&!this.texture.destroyed&&this.texture.width==r&&this.texture.height==a||(this.texture&&this.texture.destroy(),this.texture=new pt(r,a,t.RenderTargetFormat.R8G8B8A8));let n=this._render2D.clone(this.texture);n.renderStart(!0,new _t(0,0,0,0));let l=this._rectMeshVB,o=this._rectMesh.vertexDeclarition.vertexStride/4;l[0]=0,l[1]=0,l[o]=i,l[o+1]=0,l[2*o]=i,l[2*o+1]=s,l[3*o]=0,l[3*o+1]=s;let h=new Pa;h.setFilter(this),Ke.TEMPMatrix0.cloneByArray(this._mat),h.shaderData.setMatrix4x4(Ri.UNIFORM_COLORMAT,Ke.TEMPMatrix0),u.tempVec4.setValue(this._alpha[0],this._alpha[1],this._alpha[2],this._alpha[3]),h.shaderData.setVector(Ri.UNIFORM_COLORALPHA,u.tempVec4),h.size=new Ze(r,a),h.textureHost=e,n.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,h,null),n.renderEnd()}gray(){return this.setByMatrix(yn)}color(t=0,e=0,i=0,s=1){return this.setByMatrix([t,0,0,0,1,0,e,0,0,1,0,0,i,0,1,0,0,0,s,0])}setColor(t){var e=mi.create(t).arrColor,i=[0,0,0,0,256*e[0],0,0,0,0,256*e[1],0,0,0,0,256*e[2],0,0,0,1,0];return this.setByMatrix(i)}setByMatrix(t){this._matrix!=t&&this._copyMatrix(t);for(var e=0,i=0,s=0;s<20;s++)s%5!=4?this._mat[e++]=t[s]:this._alpha[i++]=t[s];return this.onChange(),this}get type(){return ie.COLOR}get typeDefine(){return Ri.FILTERCOLOR}adjustColor(t,e,i,s){return this.adjustHue(s),this.adjustContrast(e),this.adjustBrightness(t),this.adjustSaturation(i),this}adjustBrightness(t){return 0==(t=this._clampValue(t,100))||isNaN(t)?this:this._multiplyMatrix([1,0,0,0,t,0,1,0,0,t,0,0,1,0,t,0,0,0,1,0,0,0,0,0,1])}adjustContrast(t){if(0==(t=this._clampValue(t,100))||isNaN(t))return this;var e,i=(e=t<0?127+t/100*127:127*(e=0==(e=t%1)?mn[t]:mn[t|0]*(1-e)+mn[1+(t|0)]*e)+127)/127,s=.5*(127-e);return this._multiplyMatrix([i,0,0,0,s,0,i,0,0,s,0,0,i,0,s,0,0,0,1,0,0,0,0,0,1])}adjustSaturation(t){if(0==(t=this._clampValue(t,100))||isNaN(t))return this;var e=1+(t>0?3*t/100:t/100),i=1-e,s=.3086*i,r=.6094*i,a=.082*i;return this._multiplyMatrix([s+e,r,a,0,0,s,r+e,a,0,0,s,r,a+e,0,0,0,0,0,1,0,0,0,0,0,1])}adjustHue(t){if(0==(t=this._clampValue(t,180)/180*Math.PI)||isNaN(t))return this;var e=Math.cos(t),i=Math.sin(t),s=.213,r=.715,a=.072;return this._multiplyMatrix([s+e*(1-s)+i*-s,r+e*-r+i*-r,a+e*-a+i*(1-a),0,0,s+e*-s+.143*i,r+e*(1-r)+.14*i,a+e*-a+-.283*i,0,0,s+e*-s+-.787*i,r+e*-r+i*r,a+e*(1-a)+i*a,0,0,0,0,0,1,0,0,0,0,0,1])}reset(){return this.setByMatrix(this._copyMatrix(Tn))}_multiplyMatrix(t){var e=[];this._matrix=this._fixMatrix(this._matrix);for(var i=0;i<5;i++){for(var s=0;s<5;s++)e[s]=this._matrix[s+5*i];for(s=0;s<5;s++){for(var r=0,a=0;a<5;a++)r+=t[s+5*a]*e[a];this._matrix[s+5*i]=r}}return this.setByMatrix(this._matrix)}_clampValue(t,e){return Math.min(e,Math.max(-e,t))}_fixMatrix(t=null){return null==t?Tn:(t.length<25?t=t.slice(0,t.length).concat(Tn.slice(t.length,25)):t.length>25&&(t=t.slice(0,25)),t)}_copyMatrix(t){this._matrix||(this._matrix=[]);for(var e=0;e<25;e++)this._matrix[e]=t[e];return this._matrix}onAfterDeserialize(){let t=mi.create(this._color||"#FFFFFF").arrColor;this.color(t[0],t[1],t[2],t[3]),this.adjustColor(this._brightness||0,this._contrast||0,this._saturation||0,this._hue||0)}}class vn extends ie{constructor(t,e=4,i=6,s=6){super(),this._sv_blurInfo1=new Array(4),this._sv_blurInfo2=[0,0,1,0],this._flipY=!1,this._color=new mi(t||"#000"),this.blur=Math.min(e,20),this.offX=i,this.offY=s,this._sv_blurInfo1[1]=this.blur,this.shaderDataBlur=new Pa,this.shaderDataBlur.u_blurInfo1=new u,this.shaderDataBlur.u_blurInfo2=new u,this.shaderDataBlur.color=new u,this.shaderDataBlur.size=new Ze,this.shaderDataBlur.blurInfo=new Ze,this.shaderDataCopy=new Pa,this.shaderDataCopy.size=new Ze,this.shaderDataCopy1=new Pa}_fillQuad(t,e,i,s,r=!1){let a;a=r?[0,1,1,0]:[0,0,1,1];let n=this._rectMeshVB,l=this._rectMesh.vertexDeclarition.vertexStride/4;n[0]=t,n[1]=e,n[2]=a[0],n[3]=a[1],n[l]=t+i,n[l+1]=e,n[l+2]=a[2],n[l+3]=a[1],n[2*l]=t+i,n[2*l+1]=e+s,n[2*l+2]=a[2],n[2*l+3]=a[3],n[3*l]=e,n[3*l+1]=e+s,n[3*l+2]=a[0],n[3*l+3]=a[3]}useFlipY(t){super.useFlipY(t),this._flipY=t}render(e,i,s){this.left=-50,this.top=-50;let r=i+100,a=s+100;this.width=r,this.height=a,this.textureExtend&&!this.textureExtend.destroyed&&this.textureExtend.width==r&&this.textureExtend.height==a||(this.textureExtend&&this.textureExtend.destroy(),this.textureExtend=new pt(r,a,t.RenderTargetFormat.R8G8B8A8));let n=this._render2D.clone(this.textureExtend);n.renderStart(!0,new _t(0,0,0,0)),this.shaderDataCopy1.size=new Ze(r,a),this.shaderDataCopy1.textureHost=e,this._fillQuad(50,50,e.width,e.height,this._flipY),n.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,this.shaderDataCopy1,null),n.renderEnd(),this.texture&&!this.texture.destroyed&&this.texture.width==r&&this.texture.height==a||(this.texture&&this.texture.destroy(),this.texture=new pt(r,a,t.RenderTargetFormat.R8G8B8A8)),n=n.clone(this.texture),n.renderStart(!0,new _t(0,0,0,0)),this._fillQuad(0,0,r,a,!0);let l=this.shaderDataBlur;l.shaderData.addDefine(Ri.FILTERGLOW);let o=l.size;o.setValue(r,a),l.size=o,l.textureHost=this.textureExtend;let h=l.blurInfo;h.setValue(r,a),l.blurInfo=h;let u=l.u_blurInfo1;u.setValue(this._sv_blurInfo1[0],this._sv_blurInfo1[1],this._sv_blurInfo1[2],this._sv_blurInfo1[3]),l.u_blurInfo1=u;let d=l.u_blurInfo2;d.setValue(e.width,e.height,this._sv_blurInfo2[2],this._sv_blurInfo2[3]),l.u_blurInfo2=d;let c=this.getColor(),_=l.color;_.setValue(c[0],c[1],c[2],c[3]),l.color=_,n.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,l,null);let p=this.shaderDataCopy;o=p.size,o.setValue(r,a),p.size=o,p.textureHost=e,this._fillQuad(50,50,e.width,e.height,this._flipY),n.draw(this._rectMesh,0,4*this._rectMesh.vertexDeclarition.vertexStride,0,12,p,null),n.renderEnd()}get typeDefine(){return Ri.FILTERGLOW}get offY(){return this._sv_blurInfo1[3]}set offY(t){this._sv_blurInfo1[3]=t,this.onChange()}get offX(){return this._sv_blurInfo1[2]}set offX(t){this._sv_blurInfo1[2]=t,this.onChange()}get color(){return this._color.strColor}set color(t){this._color=new mi(t),this.onChange()}getColor(){return this._color.arrColor}get blur(){return this._sv_blurInfo1[1]}set blur(t){this._sv_blurInfo1[0]=this._sv_blurInfo1[1]=t,this.onChange()}}class Sn extends br{constructor(){super(),this._loop=1,this.on(r.ADDED,this,this._onParentChange),this.on(r.REMOVED,this,this._onParentChange)}get source(){return this._source}set source(t){this._source=t,t?this._autoPlay&&(!this._channel||this._channel.isStopped)&&n.isPlaying&&this.play():this.stop()}get isMusic(){return this._isMusic}set isMusic(t){this._isMusic=t}get loop(){return this._loop}set loop(t){this._loop=t}get autoPlay(){return this._autoPlay}set autoPlay(t){this._autoPlay=t,t&&this._source&&(!this._channel||this._channel.isStopped)&&n.isPlaying&&this.play()}_onParentChange(){this.target=this.parent}play(t,e){this._source&&((null==t||isNaN(t))&&(t=this._loop),this.stop(),this._isMusic?this._channel=Ia.playMusic(this._source,t,e):this._channel=Ia.playSound(this._source,t,e))}stop(){this._channel&&!this._channel.isStopped&&this._channel.stop(),this._channel=null}_setPlayAction(t,e,i,s=!0){this[i]&&t&&(s?t.on(e,this,this[i]):t.off(e,this,this[i]))}_setPlayActions(t,e,i,s=!0){if(!t)return;if(!e)return;let r=e.split(","),a=r.length;for(let e=0;e<a;e++)this._setPlayAction(t,r[e],i,s)}set playEvent(t){this._playEvents=t,t&&this._tar&&this._setPlayActions(this._tar,t,"play")}set target(t){this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!1),this._setPlayActions(this._tar,this._stopEvents,"stop",!1)),this._tar=t,this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!0),this._setPlayActions(this._tar,this._stopEvents,"stop",!0))}set stopEvent(t){this._stopEvents=t,t&&this._tar&&this._setPlayActions(this._tar,t,"stop")}}class En extends C{set updateFrame(t){this._frameDelty=1/t*1e3,this._updateFrame=t}get updateFrame(){return this._updateFrame}set useFrame(t){this._useFrame=t}get useFrame(){return this._useFrame}constructor(){let i=e.Browser.createElement("video");super(i.videoWidth,i.videoHeight,t.RenderTargetFormat.R8G8B8),this._requestVideoFrame=!1,this._lastTimer=0,this._frameRender=!0,this._isLoaded=!1,this._needUpdate=!1,this.immediatelyPlay=!1,this.element=i,this.useFrame=!1,this.updateFrame=30,this._listeningEvents={},this._dimension=t.TextureDimension.Tex2D;var s=this.element.style;if(s.position="absolute",s.top="0px",s.left="0px",i.setAttribute("crossorigin","anonymous"),e.Browser.onMobile&&(i["x5-playsInline"]=!0,i["x5-playsinline"]=!0,i.x5PlaysInline=!0,i.playsInline=!0,i["webkit-playsInline"]=!0,i["webkit-playsinline"]=!0,i.webkitPlaysInline=!0,i.playsinline=!0,i.style.playsInline=!0,i.crossOrigin="anonymous",i.setAttribute("playsinline","true"),i.setAttribute("x5-playsinline","true"),i.setAttribute("webkit-playsinline","true"),i.autoplay=!0),i.addEventListener("loadedmetadata",(()=>{this.loadedmetadata()})),"requestVideoFrameCallback"in HTMLVideoElement.prototype){const r=this;function a(){r._needUpdate=!0,i.requestVideoFrameCallback(a)}i.requestVideoFrameCallback(a),this._requestVideoFrame=!0}else this._needUpdate=!0}isNeedUpdate(){if(this.useFrame){let t=A.now();return t-this._lastTimer>this._frameDelty&&(this._lastTimer=t,!0)}return!this._requestVideoFrame||this._needUpdate}loadedmetadata(){this._isLoaded||(this._width=this.element.videoWidth,this._height=this.element.videoHeight,A.onLayaRuntime?this._texture=l.textureContext.createTextureInternal(this._dimension,this.element.videoWidth,this.element.videoHeight,t.TextureFormat.R8G8B8A8,!1,!1,!1):this._texture=l.textureContext.createTextureInternal(this._dimension,this.element.videoWidth,this.element.videoHeight,t.TextureFormat.R8G8B8,!1,!1,!1),this.wrapModeU=t.WrapMode.Clamp,this.wrapModeV=t.WrapMode.Clamp,this.filterMode=t.FilterMode.Bilinear,l.textureContext.initVideoTextureData(this._texture),this._texture.gammaCorrection=2.2,this.immediatelyPlay&&this.play(),this._isLoaded=!0,this.event(r.READY,this))}get gammaCorrection(){return 2.2}get source(){return this._source}set source(t){this._source=t,t&&N.inst.resolveURL(t,(t=>{for(;this.element.childElementCount;)this.element.firstChild.remove();t.startsWith("blob:")?this.element.src=t:this.appendSource(t)}))}appendSource(t){var i=e.Browser.createElement("source");i.src=O.postFormatURL(O.formatURL(t));let s=P.getFileExtension(t);i.type="m3u8"==s?"application/vnd.apple.mpegurl":"video/"+s,this.element.appendChild(i)}render(){0!=this.element.readyState&&(this.isNeedUpdate()||A.onLayaRuntime)&&(l.textureContext.updateVideoTexture(this._texture,this.element,!1,!1),this._needUpdate=!1,this.event(En.videoEvent_update))}get frameRender(){return this._frameRender}set frameRender(t){this._frameRender&&!t&&e.timer.clear(this,this.render),!this._frameRender&&t&&e.timer.frameLoop(1,this,this.render),this._frameRender=t}play(){this._texture?(this.element.play().catch((()=>{this.event("NotAllowedError")})),this._frameRender&&e.timer.frameLoop(1,this,this.render)):this.immediatelyPlay=!0}_getSource(){return this._texture?this._texture.resource:null}get defaultTexture(){return ct.whiteTexture}pause(){this.element.pause(),this._frameRender&&e.timer.clear(this,this.render)}load(){this.element.load()}canPlayType(t){return t="m3u8"==t?"application/vnd.apple.mpegurl":"video/"+t,this.element.canPlayType(t)}get buffered(){return this.element.buffered}get currentSrc(){return this.element.currentSrc}get currentTime(){return this.element.currentTime}set currentTime(t){this.element&&(this.element.currentTime=t,this.render())}get volume(){return this.element.volume}set volume(t){this.element&&(this.element.volume=t)}get readyState(){return this.element.readyState}get videoWidth(){return this.element.videoWidth}get videoHeight(){return this.element.videoHeight}get duration(){return this.element.duration}get ended(){return this.element.ended}get error(){return this.element.error}get loop(){return this.element.loop}set loop(t){this.element&&(this.element.loop=t)}get playbackRate(){return this.element.playbackRate}set playbackRate(t){this.element&&(this.element.playbackRate=t)}get muted(){return this.element.muted}set muted(t){this.element&&(this.element.muted=t)}get paused(){return this.element.paused}get preload(){return this.element.preload}set preload(t){this.element&&(this.element.preload=t)}get seekable(){return this.element.seekable}get seeking(){return this.element.seeking}onStartListeningToType(t){if(wn.has(t)){let e=this._listeningEvents[t];e||(e=this._listeningEvents[t]=()=>{this.event(t)}),this.element.addEventListener(t,e)}}destroy(){if(this.element)if(n.isConch)this.element._destroy();else for(this.element.pause(),this.element.src="";this.element.childElementCount;)this.element.firstChild.remove();e.timer.clear(this,this.render),super.destroy()}}En.videoEvent_update="videoUpdate";const wn=new Set(["abort","canplay","canplaythrough","durationchange","emptied","error","loadeddata","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting","ended"]);class Dn extends br{constructor(){if(super(),this.texture=this._internalTex=new mt,n.isPlaying&&e.Browser.onMobile){let t=()=>{e.Browser.document.removeEventListener("touchend",t),this._videoTexture&&(A.onIOS?this._videoTexture.load():(this._videoTexture.play(),this._videoTexture.pause()))};e.Browser.document.addEventListener("touchend",t)}}get videoTexture(){return this._videoTexture}set videoTexture(t){this._videoTexture&&(this._videoTexture._removeReference(),this._videoTexture.off(r.READY,this,this.onVideoMetaLoaded),this._videoTexture.off(En.videoEvent_update,this,this._repaintCachAs)),this._videoTexture=t,t?(this._videoTexture._addReference(),this._videoTexture.on(r.READY,this,this.onVideoMetaLoaded),this._videoTexture._isLoaded&&this._internalTex.setTo(this._videoTexture)):this._internalTex.setTo(null),this._checkCachAs()}get source(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.source}set source(t){t?(this._videoTexture||(this.videoTexture=new En),this._videoTexture.source=t):this._videoTexture&&(this._videoTexture.source=t),this._checkCachAs()}_checkCachAs(){null!=this.videoTexture&&this.videoTexture.on(En.videoEvent_update,this,this._repaintCachAs)}_repaintCachAs(){("none"!=this.cacheAs||this._getCacheStyle().mask)&&this.repaint()}load(t){this.source=t}play(){this._videoTexture&&this._videoTexture.play()}pause(){this._videoTexture&&this._videoTexture.pause()}reload(){this._videoTexture&&this._videoTexture.load()}canPlayType(t){return this._videoTexture||(this.videoTexture=new En),this._videoTexture.canPlayType(t)}onVideoMetaLoaded(){this._internalTex.setTo(this._videoTexture)}get buffered(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.buffered}get currentSrc(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.currentSrc}get currentTime(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.currentTime}set currentTime(t){this._videoTexture&&(this._videoTexture.currentTime=t)}get volume(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.volume}set volume(t){this._videoTexture&&(this._videoTexture.volume=t)}get readyState(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.readyState}get videoWidth(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.videoWidth}get videoHeight(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.videoHeight}get duration(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.duration}get ended(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.ended}get error(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.error}get loop(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.loop}set loop(t){this._videoTexture&&(this._videoTexture.loop=t)}get playbackRate(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.playbackRate}set playbackRate(t){this._videoTexture&&(this._videoTexture.playbackRate=t)}get muted(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.muted}set muted(t){this._videoTexture&&(this._videoTexture.muted=t)}get paused(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.paused}get preload(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.preload}set preload(t){this._videoTexture&&(this._videoTexture.preload=t)}get seekable(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.seekable}get seeking(){var t;return null===(t=this._videoTexture)||void 0===t?void 0:t.seeking}_setX(t){if(super._setX(t),this._videoTexture&&n.isConch){var e=Dr.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.style.left=e.x}}_setY(t){if(super._setY(t),this._videoTexture&&n.isConch){var e=Dr.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.style.top=e.y}}set_width(t){if(super.set_width(t),this._videoTexture)if(n.isConch){var i=Dr.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.width=t*i.scaleX}else this._videoTexture.element.width=this.width/e.Browser.pixelRatio}set_height(t){if(super.set_height(t),this._videoTexture)if(n.isConch){var i=Dr.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.height=t*i.scaleY}else this._videoTexture.element.height=this.height/e.Browser.pixelRatio}destroy(t=!0){this.videoTexture=null,super.destroy(t)}}class bn{get duration(){return this._duration}get animatorState(){return this._currentState}constructor(){this._currentState=null,this._frontPlay=!0}_resetPlayState(t,e){this._finish=!1,this._startPlayTime=t,this._elapsedTime=t,this._lastIsFront=!0,this._parentPlayTime=null,this._playNum=0,this._playAllTime=0;var i=this._elapsedTime/e%1;this._normalizedPlayTime=i<0?i+1:i,this._frontPlay=!0}_cloneTo(t){t._finish=this._finish,t._startPlayTime=this._startPlayTime,t._elapsedTime=this._elapsedTime,t._playNum=this._playNum,t._parentPlayTime=this._parentPlayTime,t._normalizedPlayTime=this._normalizedPlayTime,t._lastIsFront=this._lastIsFront,t._frontPlay=this._frontPlay,t._playAllTime=this._playAllTime}}class Cn{constructor(t){this._referenceCount=0,this._playStateInfo=new bn,this._crossPlayStateInfo=new bn,this._crossMark=0,this._crossNodesOwnersCount=0,this._crossNodesOwnersIndicesMap={},this._srcCrossClipNodeIndices=[],this._destCrossClipNodeIndices=[],this.playOnWake=!0,this.defaultWeight=1,this.blendingMode=Cn.BLENDINGMODE_OVERRIDE,this.enable=!0,this._states=[],this._playType=-1,this.name=t}get states(){return this._states}set states(t){if(this._states!==t){for(let t=this.states.length-1;t>=0;t--)this.removeState(this.states[t]);for(let e=t.length-1;e>=0;e--)this.addState(t[e])}}get defaultStateName(){return this._defaultState?this._defaultState.name:null}set defaultStateName(t){if(this._defaultState=this.getStateByName(t),null==this._defaultState)if(0==this._states.length)this._defaultStateNameCatch=t;else for(var e=this._states.length-1;e>=0;e--)if(this._states[e].name==t){this._defaultState=this._states[e];break}}get defaultState(){return this._defaultState}set defaultState(t){this._defaultState=t}_removeClip(t,e,i){t.splice(e,1)}_getReferenceCount(){return this._referenceCount}_addReference(t){for(var e=0,i=this._states.length;e<i;e++)this._states[e]._addReference(t);this._referenceCount+=t}_removeReference(t=1){for(var e=0,i=this._states.length;e<i;e++)this._states[e]._removeReference(t);this._referenceCount-=t}_clearReference(){this._removeReference(-this._referenceCount)}getCurrentPlayState(){return this._playStateInfo}getStateByName(t){for(let e=this._states.length-1;e>=0;e--)if(this._states[e].name==t)return this._states[e];return null}addState(t){var e=t.name;if(this.getStateByName(e))throw new Error("AnimatorControllerLayer:this stat's name has exist.");this._states.push(t),e==this._defaultStateNameCatch&&(this._defaultState=t,this._defaultStateNameCatch=null)}removeState(t){for(var e=this._states,i=-1,s=0,r=e.length;s<r;s++)if(e[s]===t){i=s;break}-1!=i&&this._removeClip(e,i,t)}clone(){var t=new Cn(this.name);return this.cloneTo(t),t}cloneTo(t){t.name=this.name}destroy(){this._removeReference();for(var t=0,e=this._states.length;t<e;t++)this._states[t].destroy();this._states.length=0}}var Rn,An,In,Mn,Bn,Ln,Pn;Cn.BLENDINGMODE_OVERRIDE=0,Cn.BLENDINGMODE_ADDTIVE=1,t.AniParmType=void 0,(Rn=t.AniParmType||(t.AniParmType={}))[Rn.Float=0]="Float",Rn[Rn.Bool=1]="Bool",Rn[Rn.Trigger=2]="Trigger",t.AniStateConditionType=void 0,(An=t.AniStateConditionType||(t.AniStateConditionType={}))[An.Number=0]="Number",An[An.Bool=1]="Bool",An[An.Trigger=2]="Trigger",t.AniStateConditionNumberCompressType=void 0,(In=t.AniStateConditionNumberCompressType||(t.AniStateConditionNumberCompressType={}))[In.Less=0]="Less",In[In.Greater=1]="Greater";class Nn{static parse(t){let e=t,i=e.controllerLayers;null==i&&(i=[]);let s=[];for(let t=i.length-1;t>=0;t--){let r=i[t],a=r.states;a||(a=[],r.states=a),r.defaultStateName=null;let n=this.checkStates(a,s,e);n?r.defaultStateName=n.enterName:i.splice(t,1)}return{ret:e,clipsID:s}}static checkStates(t,e,i){let s=null,r=null;for(let a=t.length-1;a>=0;a--){let n=t[a];n.states?null==this.checkStates(n.states,e,i)?t.splice(a,1):(null==s&&(s=[]),s.push(n)):"-1"==n.id?r=n:"-2"==n.id||"-3"==n.id||(null==n.clip||null==n.clip._$uuid||""==n.clip._$uuid?t.splice(a,1):(0>e.indexOf(n.clip._$uuid)&&e.push(n.clip._$uuid),this.checkNext(n,t,i),null==s&&(s=[]),s.push(n)))}let a=null;if(s&&r){let t=this.checkDefault(r,s);null!=t&&(a={states:s,enterName:t})}return a}static checkNext(t,e,i){let s=t.soloTransitions;if(s)for(let t=s.length-1;t>=0;t--){let r=s[t],a=this.getStateByID(e,r.id);!a||null==a.clip&&"-3"!=a.id&&null==a.states?s.splice(t,1):(r.name=a.name,r.conditions=this.checkConditions(r.conditions,i))}}static checkConditions(e,i){if(!e||0==e.length||null==i.animatorParams||0==i.animatorParams.length)return[];let s=i.animatorParams;for(let i=e.length-1;i>=0;i--){let r=e[i],a=null;for(let t=s.length-1;t>=0;t--)if(s[t].id==r.id){a=s[t];break}if(null==a)e.splice(i,1);else if(r.name=a.name,a.type==t.AniParmType.Float){let t=Number(r.checkValue);isNaN(t)&&(r.checkValue=0),t=Number(r.type),isNaN(t)&&(r.type=0)}}return e}static checkDefault(t,e){let i=t.soloTransitions,s=null;i&&0<i.length&&(s=i[0].id);let r=null;if(null!=s&&(r=this.getStateByID(e,s)),null!=r&&(null!=r.clip||null!=r.states))return r.name;for(let t=e.length-1;t>=0;t--)if(e[t].clip)return e[t].name;return null}static getStateByID(t,e){if(t)for(let i=t.length-1;i>=0;i--)if(t[i].id==e)return t[i];return null}}t.AnimatorUpdateMode=void 0,(Mn=t.AnimatorUpdateMode||(t.AnimatorUpdateMode={}))[Mn.Normal=0]="Normal",Mn[Mn.LowFrame=1]="LowFrame",Mn[Mn.UnScaleTime=2]="UnScaleTime";class On extends Vt{constructor(){super(),this._speed=1,this._updateMode=t.AnimatorUpdateMode.Normal,this._lowUpdateDelty=20,this._isPlaying=!0,this._controllerLayers=[],this._parameters={}}get controller(){return this._controller}set controller(t){this._controller=t,t&&t.updateTo(this)}get parameters(){return this._parameters}set parameters(t){this._parameters=t}get speed(){return this._speed}set speed(t){this._speed=t}get isPlaying(){return this._isPlaying}_updateStateFinish(t,e){e._finish&&t._eventExit()}_setClipDatasToNode(t,e,i,s=null){for(var r=t._realtimeDatas,a=t._clip._nodes,n=0,l=a.count;n<l;n++)if(null!=r[n]){var o=a.getNodeByIndex(n),h=this.getOwner(o);h&&this._applyFloat(h,e,i,r[n])}}_applyFloat(t,e,i,s){var r=t.pro;r&&r.ower&&(r.ower[r.key]=e&&"number"==typeof s?r.defVal+i*s:"number"==typeof s?i*s:s)}getOwner(t){var e;if(this._ownerMap&&(e=this._ownerMap.get(t)))return e;for(var i=this.owner,s=0,r=t.ownerPathCount;s<r;s++){var a=t.getOwnerPathByIndex(s);if(""!=a&&!(i=i.getChildByName(a)))break}if(e={ower:i},i){var n=i,l=t.propertyCount;if(1==l){var o=t.getPropertyByIndex(0);e.pro={ower:i,key:o,defVal:i[o]}}else for(var h=0;h<l;h++){o=t.getPropertyByIndex(h);if(h==l-1||null==n){e.pro={ower:n,key:o,defVal:n?n[o]:null};break}if("_gcmds"===o&&null==n[o]&&n.graphics&&(n=n.graphics,o="cmds"),null==n[o]&&i==n){n=null;var u=Ot.getClass(o);u&&(n=i.getComponent(u))}else n=n[o]}}return null==this._ownerMap&&(this._ownerMap=new Map),this._ownerMap.set(t,e),e}_updateClipDatas(t,e,i){var s=t._clip,r=s._duration,a=t.clipStart*r+i._normalizedPlayTime*i._duration,n=t._currentFrameIndices;s._evaluateClipDatasRealTime(a,n,e,!0,t._realtimeDatas)}_updatePlayer(t,e,i,s,r){let a=!1;var n=t._clip._duration*(t.clipEnd-t.clipStart),l=e._elapsedTime;let o=e._playAllTime;e._playAllTime+=Math.abs(i),i=l+i,e._lastElapsedTime=l,e._elapsedTime=i;var h=i/n;let u=1;t.yoyo&&(u=2);let d=e._playAllTime/(n*u);Math.floor(o/(n*u))<Math.floor(d)&&(a=!0);var c=h%1;let _=c<0?c+1:c;if(e._normalizedPlayTime=_,e._duration=n,1!=u&&(_=(c=(h=e._playAllTime/(n*u))%1)<0?c+1:c,t.yoyo&&(.5>_?e._frontPlay||(0>t.speed?(e._elapsedTime=t.clipEnd*o,e._normalizedPlayTime=t.clipEnd):(e._elapsedTime=t.clipStart*o,e._normalizedPlayTime=t.clipStart),e._frontPlay=!0):e._frontPlay&&(e._frontPlay=!1,0>t.speed?(e._elapsedTime=t.clipStart*o,e._normalizedPlayTime=t.clipStart):(e._elapsedTime=t.clipEnd*o,e._normalizedPlayTime=t.clipEnd)))),t._eventStateUpdate(_),!this._applyTransition(r,t._eventtransition(_,this.parameters,a))&&a){let i=e._playAllTime/(n*u);if(0<s&&s<=i)return e._finish=!0,void(0>t.speed?t.yoyo?(e._elapsedTime=t.clipEnd*o,e._normalizedPlayTime=t.clipEnd):(e._elapsedTime=t.clipStart*o,e._normalizedPlayTime=t.clipStart):t.yoyo?(e._elapsedTime=t.clipStart*o,e._normalizedPlayTime=t.clipStart):(e._elapsedTime=t.clipEnd*o,e._normalizedPlayTime=t.clipEnd));t._eventLoop()}}_updateEventScript(t,e){let i=t._clip,s=i._animationEvents;if(!s||0==s.length)return;let r=i._duration,a=e._normalizedPlayTime*r,n=e._frontPlay;0>e._currentState.speed&&(n=!n);let l=e._parentPlayTime,o=e._parentPlayTime;null==o&&(o=n?r*e.animatorState.clipStart:r*e.animatorState.clipEnd),n?a<o&&(this._eventScript(s,o,a,!0),o=r*e.animatorState.clipStart):a>o&&(this._eventScript(s,o,a,!1),o=r*e.animatorState.clipEnd),this._eventScript(s,o,a,n),l==e._parentPlayTime&&(e._parentPlayTime=a)}_eventScript(t,e,i,s){let r=this.owner.components;if(s)for(let s=0,a=t.length;s<a;s++){let a=t[s];if(a.time>e&&a.time<=i)for(let t=0,e=r.length;t<e;t++){let e=r[t];if(e._isScript()){let t=e[a.eventName];t&&t.apply(e,a.params)}}else if(a.time>i)break}else for(let s=t.length-1;s>=0;s--){let a=t[s];if(a.time<e&&a.time>=i)for(let t=0,e=r.length;t<e;t++){let e=r[t];if(e._isScript()){let t=e[a.eventName];t&&t.apply(e,a.params)}}else if(a.time<i)break}}_applyTransition(t,e){return!!e&&this.crossFade(e.destState.name,t,e.transstartoffset,e.transduration)}_applyUpdateMode(e){let i;switch(this._updateMode){case t.AnimatorUpdateMode.Normal:i=e;break;case t.AnimatorUpdateMode.LowFrame:i=ae.loopCount%this._lowUpdateDelty==0?e*this._lowUpdateDelty:0;break;case t.AnimatorUpdateMode.UnScaleTime:i=0}return i}gotoAndStopByFrame(t,e,i){var s=this._controllerLayers[e];if(s){var r=s.getStateByName(t);if(!r||!r._clip)return;let a=i/(r._clip._duration*r._clip._frameRate);1<a&&(a=1),this.gotoAndStop(t,e,a)}}gotoAndStop(t,e,i){var s=this._controllerLayers[e];if(s){var r=s.getStateByName(t);if(!r||!r._clip)return;var a=s._playStateInfo,n=a._currentState,l=r._clip._duration,o=r._clip._duration*(r.clipEnd-r.clipStart);a._resetPlayState(l*i,o),a._normalizedPlayTime=i,s._playType=0,n!==r&&(a._currentState=r),r._eventStart(this,e);let h=s.blendingMode!=Cn.BLENDINGMODE_OVERRIDE;this._updateClipDatas(r,h,a),this._setClipDatasToNode(r,h,s.defaultWeight,s),this.stop()}}play(t,e=0,i=Number.NEGATIVE_INFINITY){if(this._checkEnterIndex){let t=this._checkEnterIndex.indexOf(e);0<=t&&this._checkEnterIndex.splice(t,1)}this._isPlaying=!0;var s=this._controllerLayers[e];if(s){var r=s.defaultState;if(!t&&!r)throw new Error("Animator:must have default clip value,please set clip property.");var a=s._playStateInfo,n=a._currentState,l=t?s.getStateByName(t):r;if(!l._clip)return;var o=l._clip._duration,h=l._clip._duration*(l.clipEnd-l.clipStart);n!==l?(i!==Number.NEGATIVE_INFINITY?a._resetPlayState(o*i,h):a._resetPlayState(0,h),s._playType=0,a._currentState=l):i!==Number.NEGATIVE_INFINITY&&(a._resetPlayState(o*i,h),s._playType=0),l._eventStart(this,e)}}stop(){this._isPlaying=!1}onUpdate(){if(this._isPlaying){if(this._checkEnterIndex)for(let e=this._checkEnterIndex.length-1;e>=0;e--){let i=this._checkEnterIndex[e];if(this._controllerLayers[i]._enterTransition.check(0,this.parameters,!0)){var t=this.getDefaultState(i);this.play(null,i,t.cycleOffset)}}var e=this.owner.timer._delta/1e3;if(e=this._applyUpdateMode(e),0!=this.speed&&0!=e)for(var i=0,s=this._controllerLayers.length;i<s;i++){var r=this._controllerLayers[i];if(r.enable){var a=r._playStateInfo,n=r.blendingMode!=Cn.BLENDINGMODE_OVERRIDE;if(0===r._playType){var l=a._currentState,o=this._speed*l.speed,h=a._finish,u=l.loop;-1>=u&&(u=l._clip.islooping?0:1);let t=1;a._frontPlay||(t=-1),h||this._updatePlayer(l,a,e*o*t,u,i),l=(a=r._playStateInfo)._currentState,this._updateClipDatas(l,n,a),h||(this._setClipDatasToNode(l,n,r.defaultWeight,r),this._updateEventScript(l,a)),h||this._updateStateFinish(l,a)}}}}}addControllerLayer(t){this._controllerLayers.push(t)}crossFade(t,e=0,i=Number.NEGATIVE_INFINITY,s){var r=this._controllerLayers[e];if(r){if(r.getStateByName(t))return this.play(t,e,i),!0;console.warn("Invalid layerIndex "+e+".")}return!1}onAfterDeserialize(){let t=this.controllerLayers;if(t&&null==this.controller){delete this.controllerLayers,this._controllerLayers.length=0;for(let e of t)this.addControllerLayer(e)}}onEnable(){if(this._checkEnterIndex?this._checkEnterIndex.length=0:this._checkEnterIndex=[],this._isPlaying)for(var t=0,e=this._controllerLayers.length;t<e;t++)if(this._controllerLayers[t].playOnWake){var i=this.getDefaultState(t);if(i){let e=this._controllerLayers[t]._enterTransition;e?(this._isPlaying=!0,e.check(0,this.parameters,!0)?this.play(null,t,i.cycleOffset):this._checkEnterIndex.push(t)):this.play(null,t,i.cycleOffset)}}}getDefaultState(t=0){return this._controllerLayers[t].defaultState}setParamsTrigger(e){this._parameters[e]={name:e,type:t.AniParmType.Trigger,value:!0}}setParamsNumber(e,i){this._parameters[e]={name:e,type:t.AniParmType.Float,value:i}}setParamsBool(e,i){this._parameters[e]={name:e,type:t.AniParmType.Float,value:i}}getParamsvalue(t){let e=this._parameters[t];return e?e.value:null}onDestroy(){for(var t=0,e=this._controllerLayers.length;t<e;t++)this._controllerLayers[t].destroy();this._controllerLayers.length=0,this._isPlaying=!1,this._parameters=null}}class Fn extends v{constructor(){super(...arguments),this._referenceCount=0,this._clip=null,this._currentFrameIndices=null,this.cycleOffset=0,this.speed=1,this.clipStart=0,this.clipEnd=1,this.loop=-1,this.yoyo=!1,this.transitions=[],this.soloTransitions=[],this._scripts=null,this._realtimeDatas=[]}get clip(){return this._clip}set clip(t){if(this._clip!=t){if(this._clip&&this._referenceCount>0&&this._clip._removeReference(this._referenceCount),t){var e=t._nodes.count;this._currentFrameIndices=new Int16Array(e),this._resetFrameIndices(),this._referenceCount>0&&t._addReference(this._referenceCount),this._realtimeDatas.length=e}this._clip=t}}_eventStateUpdate(t){if(this.event(Fn.EVENT_OnStateUpdate,t),this._scripts)for(var e=0,i=this._scripts.length;e<i;e++)this._scripts[e].onStateUpdate(t)}_eventStart(t,e){if(this.event(Fn.EVENT_OnStateEnter),this._scripts)for(var i=0,s=this._scripts.length;i<s;i++)this._scripts[i].setPlayScriptInfo(t,e,this),this._scripts[i].onStateEnter()}_eventExit(){if(this.event(Fn.EVENT_OnStateExit),this._scripts)for(let t=0,e=this._scripts.length;t<e;t++)this._scripts[t].onStateExit()}_eventLoop(){if(this.event(Fn.EVENT_OnStateLoop),this._scripts)for(let t=0,e=this._scripts.length;t<e;t++)this._scripts[t].onStateLoop&&this._scripts[t].onStateLoop()}_eventtransition(t,e,i){let s=this.soloTransitions.length;if(s>0){for(var r=0;r<s;r++)if(this.soloTransitions[r].check(t,e,i))return this.soloTransitions[r];return null}let a=this.transitions.length;for(r=0;r<a;r++)if(this.transitions[r].check(t,e,i))return this.transitions[r];return null}_resetFrameIndices(){for(var t=0,e=this._currentFrameIndices.length;t<e;t++)this._currentFrameIndices[t]=-1}_getReferenceCount(){return this._referenceCount}_addReference(t){this._clip&&this._clip._addReference(t),this._referenceCount+=t}_removeReference(t){this._clip&&this._clip._removeReference(t),this._referenceCount-=t}_clearReference(){this._removeReference(-this._referenceCount)}addScript(t){var e=new t;return this._scripts=this._scripts||[],this._scripts.push(e),e}getScript(t){if(this._scripts)for(var e=0,i=this._scripts.length;e<i;e++){var s=this._scripts[e];if(s instanceof t)return s}return null}getScripts(t){var e=null;if(this._scripts)for(var i=0,s=this._scripts.length;i<s;i++){var r=this._scripts[i];r instanceof t&&(e=e||[]).push(r)}return e}clone(){var t=new Fn;return this.cloneTo(t),t}cloneTo(t){t.name=this.name,t.speed=this.speed,t.clip=this._clip}destroy(){this._clip=null,this._currentFrameIndices=null,this._scripts=null,this._realtimeDatas.length=0}}Fn.EVENT_OnStateEnter="OnStartEnter",Fn.EVENT_OnStateUpdate="OnStateUpdate",Fn.EVENT_OnStateExit="OnStateExit",Fn.EVENT_OnStateLoop="OnStateLoop";class Un{constructor(){this._ownerPath=[],this._propertys=[],this._keyFrames=[]}get keyFramesCount(){return this._keyFrames.length}_setOwnerPathCount(t){this._ownerPath.length=t}_setOwnerPathByIndex(t,e){this._ownerPath[t]=e}_setPropertyCount(t){this._propertys.length=t}_setPropertyByIndex(t,e){this._propertys[t]=e}_setKeyframeCount(t){this._keyFrames.length=t}_joinOwnerPath(t){return this._ownerPath.join(t)}_joinProperty(t){return this._propertys.join(t)}getKeyframeByIndex(t){return this._keyFrames[t]}get ownerPathCount(){return this._ownerPath.length}get propertyCount(){return this._propertys.length}getOwnerPathByIndex(t){return this._ownerPath[t]}getPropertyByIndex(t){return this._propertys[t]}}class kn{clone(){var t=new kn;return this.cloneTo(t),t}cloneTo(t){t.time=this.time}}kn.defaultWeight=.33333;class Gn{constructor(){}}class Vn{static READ_DATA(){this._DATA.offset=this._reader.getUint32(),this._DATA.size=this._reader.getUint32()}static READ_BLOCK(){for(var t=this._BLOCK.count=this._reader.getUint16(),e=this._BLOCK.blockStarts=[],i=this._BLOCK.blockLengths=[],s=0;s<t;s++)e.push(this._reader.getUint32()),i.push(this._reader.getUint32())}static READ_STRINGS(){var t=this._reader.getUint32(),e=this._reader.getUint16(),i=this._reader.pos;this._reader.pos=t+this._DATA.offset;for(var s=0;s<e;s++)this._strings[s]=this._reader.readUTFString();this._reader.pos=i}static parse(t,e,i){this._clip=t,this._reader=e,this._version=i,this.READ_DATA(),this.READ_BLOCK(),this.READ_STRINGS();for(var s=0,r=this._BLOCK.count;s<r;s++){var a=e.getUint16(),n=this._strings[a],l=this["READ_"+n];if(!l)throw new Error("model file err,no this function:"+a+" "+n);l.call(this)}this._version=null,this._reader=null,this._clip=null,this._strings.length=0}static timeToFrame(t,e){return Math.round(t*e)}static READ_ANIMATIONS2D(){var t,e,i,s=this._reader,r=this._clip,a=[],n=s.getUint16();for(a.length=n,t=0;t<n;t++)a[t]=s.getFloat32();r._duration=a[s.getInt16()],r.islooping=!!s.getByte(),r._frameRate=s.getInt16();var l=s.getInt16(),o=r._nodes;o.count=l;var h=r._nodesMap={},u=r._nodesDic={};for(t=0;t<l;t++){i=new Un,o.setNodeByIndex(t,i),i._indexInList=t;var d=s.getUint16();for(i._setOwnerPathCount(d),e=0;e<d;e++)i._setOwnerPathByIndex(e,this._strings[s.getUint16()]);var c=i._joinOwnerPath("/"),_=h[c];_||(h[c]=_=[]),_.push(i);var p=s.getUint16();for(i._setPropertyCount(p),e=0;e<p;e++)i._setPropertyByIndex(e,this._strings[s.getUint16()]);var f=c+"."+i._joinProperty(".");u[f]=i,i.fullPath=f,i.nodePath=c;var g=s.getUint16();for(e=0;e<g;e++){var m=new kn;m.time=a[s.getUint16()],m.data={f:this.timeToFrame(m.time,r._frameRate),val:0},1==s.getByte()&&(m.data.tweenType=this._strings[s.getUint16()]),1==s.getByte()&&(m.data.tweenInfo={},m.data.tweenInfo.inTangent=a[s.getUint16()],m.data.tweenInfo.outTangent=a[s.getUint16()],1==s.getByte()&&(m.data.tweenInfo.inWeight=a[s.getUint16()]),1==s.getByte()&&(m.data.tweenInfo.outWeight=a[s.getUint16()]));var y=s.getByte();if(0==y?m.data.val=a[s.getUint16()]:1==y?m.data.val=this._strings[s.getUint16()]:2==y&&(m.data.val=!!s.getByte()),1==s.getByte())try{m.data.extend=JSON.parse(this._strings[s.getUint16()])}catch(t){}i._keyFrames.push(m)}}var T=s.getUint16();for(t=0;t<T;t++){var x=new Gn;x.time=a[s.getUint16()],x.eventName=this._strings[s.getUint16()];var v=[],S=s.getUint16();for(S>0&&(x.params=v=[]),e=0;e<S;e++){switch(s.getByte()){case 0:v.push(!!s.getByte());break;case 1:v.push(s.getInt32());break;case 2:v.push(a[s.getUint16()]);break;case 3:v.push(this._strings[s.getUint16()]);break;default:throw new Error("unknown type.")}}r.addEvent(x)}}}Vn._strings=[],Vn._DATA={offset:0,size:0},Vn._BLOCK={count:0};class Hn{constructor(){this._nodes=[]}get count(){return this._nodes.length}set count(t){this._nodes.length=t}getNodeByIndex(t){return this._nodes[t]}setNodeByIndex(t,e){this._nodes[t]=e}}class zn extends b{static _parse(t){var e=new zn,i=new W(t),s=i.readUTFString();if("LAYAANIMATION2D:01"!==s)throw"unknown animationClip version.";return Vn.parse(e,i,s),e}constructor(){super(),this._nodes=new Hn,this._animationEvents=[]}duration(){return this._duration}_evaluateClipDatasRealTime(t,e,i,s,r){for(var a=this._nodes,n=0,l=a.count;n<l;n++){var o,h=a.getNodeByIndex(n)._keyFrames,u=h.length;if(0!=u){var d=e[n];if(s)for(-1!=d&&t<h[d].time&&(d=-1,e[n]=d),o=d+1;o<u&&!(h[o].time>t);)d++,o++,e[n]=d;else for((o=d+1)!=u&&t>h[o].time&&(d=u-1,e[n]=d),o=d+1;d>-1&&!(h[d].time<t);)d--,o--,e[n]=d;var c=o==u;if(-1!=d){var _=h[d];if(c)r[n]=_.data.val;else{var p,f=h[o],g=f.time-_.time;p=0!==g?(t-_.time)/g:0,r[n]=this._getTweenVal(_,f,p,g)}}else r[n]=h[0].data.val;i&&"number"==typeof h[0].data.val&&(r[n]=r[n]-h[0].data.val)}}}_getTweenVal(t,e,i,s){var r=t.data,a=e.data;if("number"!=typeof r.val||"number"!=typeof a.val)return r.val;var n=zn.tween[r.tweenType],l=r.val,o=a.val;if(null!=n)return n(i,l,o-l,1);var h=0,u=0,d=NaN,c=NaN;return null!=r.tweenInfo&&(h=r.tweenInfo.outTangent,d=r.tweenInfo.outWeight),null!=a.tweenInfo&&(u=a.tweenInfo.inTangent,c=a.tweenInfo.inWeight),(isNaN(d)||0>=d)&&(d=kn.defaultWeight),(isNaN(c)||0>=c)&&(c=kn.defaultWeight),isNaN(h)&&(h=0),isNaN(u)&&(u=0),Math.abs(h)==Number.MAX_VALUE&&(h=0>h?-1/0:1/0),Math.abs(u)==Number.MAX_VALUE&&(u=0>u?-1/0:1/0),!r.tweenInfo&&!a.tweenInfo||kn.defaultWeight==c&&kn.defaultWeight==d?zn.tween.hermiteInterpolate(h,u,l,o,i,s):this.hermiteCurveSplineWeight(l,t.time,d,h,o,e.time,c,u,i)}_binarySearchEventIndex(t){for(var e,i=0,s=this._animationEvents.length-1;i<=s;){e=i+s>>1;var r=this._animationEvents[e].time;if(r==t)return e;r>t?s=e-1:i=e+1}return i}hermiteCurveSplineWeight(t,e,i,s,r,a,n,l,o){let h=222e-18,u=o,d=t,c=i,_=n,p=a-e,f=r-d;f=Math.max(Math.abs(f),h)*(f<0?-1:1);let g=s,m=l;if(!Number.isFinite(g)||!Number.isFinite(m))return t;g=g*p/f,m=m*p/f;let y=1-_,T=.5,x=0;if(Math.abs(c-.33333334)<1e-4&&Math.abs(_-.33333334)<1e-4)T=u,x=1-T;else for(;;){x=1-T;let t=3*x*x*T*c+3*x*T*T*y+T*T*T-u;if(Math.abs(t)<=2.5*h)break;let e=3*x*x*c+6*x*T*(y-c)+3*T*T*(1-y),i=6*x*(y-2*c)+6*T*(1-2*y+c);T-=(6*t*e*e-3*t*t*i)/(6*e*e*e-6*t*e*i+t*t*(18*c-18*y+6))}return(3*x*x*T*c*g+3*x*T*T*(1-_*m)+T*T*T)*f+d}addEvent(t){var e=this._binarySearchEventIndex(t.time);this._animationEvents.splice(e,0,t)}}zn.tween={Linear:function(t,e,i,s){return i*t/s+e},Quad_EaseIn:function(t,e,i,s){return i*(t/=s)*t+e},Quad_EaseOut:function(t,e,i,s){return-i*(t/=s)*(t-2)+e},Quad_EaseInOut:function(t,e,i,s){return(t/=s/2)<1?i/2*t*t+e:-i/2*(--t*(t-2)-1)+e},Cubic_EaseIn:function(t,e,i,s){return i*(t/=s)*t*t+e},Cubic_EaseOut:function(t,e,i,s){return i*((t=t/s-1)*t*t+1)+e},Cubic_EaseInOut:function(t,e,i,s){return(t/=s/2)<1?i/2*t*t*t+e:i/2*((t-=2)*t*t+2)+e},Quart_EaseIn:function(t,e,i,s){return i*(t/=s)*t*t*t+e},Quart_EaseOut:function(t,e,i,s){return-i*((t=t/s-1)*t*t*t-1)+e},Quart_EaseInOut:function(t,e,i,s){return(t/=s/2)<1?i/2*t*t*t*t+e:-i/2*((t-=2)*t*t*t-2)+e},Quint_EaseIn:function(t,e,i,s){return i*(t/=s)*t*t*t*t+e},Quint_EaseOut:function(t,e,i,s){return i*((t=t/s-1)*t*t*t*t+1)+e},Quint_EaseInOut:function(t,e,i,s){return(t/=s/2)<1?i/2*t*t*t*t*t+e:i/2*((t-=2)*t*t*t*t+2)+e},Sine_EaseIn:function(t,e,i,s){return-i*Math.cos(t/s*(Math.PI/2))+i+e},Sine_EaseOut:function(t,e,i,s){return i*Math.sin(t/s*(Math.PI/2))+e},Sine_EaseInOut:function(t,e,i,s){return-i/2*(Math.cos(Math.PI*t/s)-1)+e},Expo_EaseIn:function(t,e,i,s){return 0==t?e:i*Math.pow(2,10*(t/s-1))+e},Expo_EaseOut:function(t,e,i,s){return t==s?e+i:i*(1-Math.pow(2,-10*t/s))+e},Expo_EaseInOut:function(t,e,i,s){return 0==t?e:t==s?e+i:(t/=s/2)<1?i/2*Math.pow(2,10*(t-1))+e:i/2*(2-Math.pow(2,-10*--t))+e},Circ_EaseIn:function(t,e,i,s){return-i*(Math.sqrt(1-(t/=s)*t)-1)+e},Circ_EaseOut:function(t,e,i,s){return i*Math.sqrt(1-(t=t/s-1)*t)+e},Circ_EaseInOut:function(t,e,i,s){return(t/=s/2)<1?-i/2*(Math.sqrt(1-t*t)-1)+e:i/2*(Math.sqrt(1-(t-=2)*t)+1)+e},Elastic_EaseIn:function(t,e,i,s,r,a){if(0==t)return e;if(1==(t/=s))return e+i;if(a||(a=.3*s),!r||r<Math.abs(i)){r=i;var n=a/4}else n=a/(2*Math.PI)*Math.asin(i/r);return-r*Math.pow(2,10*(t-=1))*Math.sin((t*s-n)*(2*Math.PI)/a)+e},Elastic_EaseOut:function(t,e,i,s,r,a){if(0==t)return e;if(1==(t/=s))return e+i;if(a||(a=.3*s),!r||r<Math.abs(i)){r=i;var n=a/4}else n=a/(2*Math.PI)*Math.asin(i/r);return r*Math.pow(2,-10*t)*Math.sin((t*s-n)*(2*Math.PI)/a)+i+e},Elastic_EaseInOut:function(t,e,i,s,r,a){if(0==t)return e;if(2==(t/=s/2))return e+i;if(a||(a=s*(.3*1.5)),!r||r<Math.abs(i)){r=i;var n=a/4}else n=a/(2*Math.PI)*Math.asin(i/r);return t<1?r*Math.pow(2,10*(t-=1))*Math.sin((t*s-n)*(2*Math.PI)/a)*-.5+e:r*Math.pow(2,-10*(t-=1))*Math.sin((t*s-n)*(2*Math.PI)/a)*.5+i+e},Back_EaseIn:function(t,e,i,s,r=void 0){return null==r&&(r=1.70158),i*(t/=s)*t*((r+1)*t-r)+e},Back_EaseOut:function(t,e,i,s,r=void 0){return null==r&&(r=1.70158),i*((t=t/s-1)*t*((r+1)*t+r)+1)+e},Back_EaseInOut:function(t,e,i,s,r=void 0){return null==r&&(r=1.70158),(t/=s/2)<1?i/2*(t*t*((1+(r*=1.525))*t-r))+e:i/2*((t-=2)*t*((1+(r*=1.525))*t+r)+2)+e},Bounce_EaseIn:function(t,e,i,s){return i-zn.tween.Bounce_EaseOut(s-t,0,i,s)+e},Bounce_EaseOut:function(t,e,i,s){return(t/=s)<1/2.75?i*(7.5625*t*t)+e:t<2/2.75?i*(7.5625*(t-=1.5/2.75)*t+.75)+e:t<2.5/2.75?i*(7.5625*(t-=2.25/2.75)*t+.9375)+e:i*(7.5625*(t-=2.625/2.75)*t+.984375)+e},Bounce_EaseInOut:function(t,e,i,s){return t<s/2?.5*zn.tween.Bounce_EaseIn(2*t,0,i,s)+e:.5*zn.tween.Bounce_EaseOut(2*t-s,0,i,s)+.5*i+e},hermiteInterpolate:function(t,e,i,s,r,a){if(Math.abs(t)==1/0||Math.abs(e)==1/0)return i;var n=r*r,l=n*r;return(2*l-3*n+1)*i+(l-2*n+r)*t*a+(l-n)*e*a+(-2*l+3*n)*s}};class Wn{}t.AniConditionType=void 0,(Bn=t.AniConditionType||(t.AniConditionType={}))[Bn.Greater=0]="Greater",Bn[Bn.Less=1]="Less",Bn[Bn.Equals=2]="Equals",Bn[Bn.NotEqual=3]="NotEqual";class Yn{}class Xn{static conditionNameToID(t){if(null!=Xn._conditionNameMap[t])return Xn._conditionNameMap[t];var e=this._propertyNameCounter++;return this._conditionNameMap[t]=e,this._conditionNameMap[e]=t,e}static conditionIDToName(t){return this._conditionNameMap[t]}constructor(t=null){t&&(this._id=Xn.conditionNameToID(t),this._name=t)}get id(){return this._id}get name(){return this._name}set name(t){this._id=Xn.conditionNameToID(t),this._name=t}get type(){return this._type}checkState(t){return!1}}Xn._conditionNameMap={},Xn._propertyNameCounter=0;class jn extends Xn{constructor(e){super(e),this._numberValue=0,this._numberCompareFlag=t.AniStateConditionNumberCompressType.Greater,this._type=t.AniStateConditionType.Number}get numberValue(){return this._numberValue}set numberValue(t){this._numberValue=t}get compareFlag(){return this._numberCompareFlag}set compareFlag(t){this._numberCompareFlag=t}checkState(e){return t.AniStateConditionNumberCompressType.Greater==this._numberCompareFlag?e>this._numberValue:e<this._numberValue}}class qn extends Xn{constructor(e){super(e),this._compareFlag=!0,this._type=t.AniStateConditionType.Bool}get compareFlag(){return this._compareFlag}set compareFlag(t){this._compareFlag=t}checkState(t){return this._compareFlag==t}}class $n extends Xn{constructor(e){super(e),this._type=t.AniStateConditionType.Trigger}checkState(t){return t}}class Kn{constructor(){this.conditions=[],this.exitByTime=!0,this.exitTime=1,this.transduration=0,this.transstartoffset=0,this.mute=!1}addCondition(t){-1==this.conditions.indexOf(t)&&this.conditions.push(t)}removeCondition(t){let e=this.conditions.indexOf(t);-1!=e&&this.conditions.splice(e,0)}check(e,i,s){if(this.mute)return!1;if(this.exitByTime&&e<this.exitTime&&!s)return!1;if(null==this.conditions||0==this.conditions.length)return!0;if(this.isAndOperEnabled){let e;for(var r=0;r<this.conditions.length;r++){let s=this.conditions[r];if(!s.checkState(i[s.name].value))return!1;s.type==t.AniStateConditionType.Trigger&&e.push(s.name)}return!0}for(r=0;r<this.conditions.length;r++){let e=this.conditions[r];if(e.checkState(i[e.name].value))return e.type==t.AniStateConditionType.Trigger&&(i[e.name].value=!1),!0}return!1}}class Qn extends b{constructor(t){super();let e=Nn.parse(t);this.data=e.ret,this.clipsID=e.clipsID}getLayers(){let t=this.data.controllerLayers,e=[];for(let i=t.length-1;i>=0;i--){let s=t[i],r=new Cn(s.name);e.unshift(r);for(let t in s)if("name"!=t&&"states"!=t&&null!=s[t])try{r[t]=s[t]}catch(t){}this.getState(s.states,r,this.data)}return e}createState(t,e,i){if(!t)return null;let s={},r=null;for(let a=t.length-1;a>=0;a--){let n=t[a],l=n.states;if(l){let t=this.createState(l,e,i);t&&(e[n.id]=t.states[t.id]);continue}if(0>Number(n.id)){if("-1"==n.id){let t=n.soloTransitions;t&&0<t.length&&(r=t[0].id)}continue}let o=new Fn;e[n.id]=o,s[n.id]=o;for(let t in n)try{if("scripts"==t){let e=n[t];if(e&&Array.isArray(e))for(let t=e.length-1;t>=0;t--){let i=e[t];i&&0==i.indexOf("res://")&&(i=i.substring(6));let s=Ot.getClass(i);s&&o.addScript(s)}continue}if("soloTransitions"==t)continue;null!=n[t]&&(o[t]=n[t])}catch(t){}i.addState(o)}return{id:r,states:s}}getState(t,e,i){if(t){let s={};this.createState(t,s,e),this.setTransitions(t,s,e,i)}}setExitTransition(t,e,i,s,r){for(let a in t){let n=i[a];if(n){let l=n.transitions,o=n.soloTransitions,h=t[a];for(let t=e.length-1;t>=0;t--){let n=e[t];if("-3"!=n.id)for(let t=h.length-1;t>=0;t--){let e=h[t],r=new Kn;r.destState=i[n.id],n.conditions&&this.addConditions(n.conditions,r,s),e.conditions&&this.addConditions(e.conditions,r,s);for(let t in n)"solo"!=t&&"id"!=t&&"conditions"!=t&&(r[t]=n[t]);n.solo?o.unshift(r):l.unshift(r)}else null==r[a]&&(r[a]=[]),r[a].push(n)}}}}_getAnimatorTransition2D(t,e,i){let s=new Kn;e[t.id]&&(s.destState=e[t.id]),t.conditions&&this.addConditions(t.conditions,s,i);for(let e in t)"solo"!=e&&"id"!=e&&"conditions"!=e&&(s[e]=t[e]);return s}setTransitions(t,e,i,s,r){if(!t)return null;let a={};for(let r=t.length-1;r>=0;r--){let n=t[r];if(n.states){let t=this.setTransitions(n.states,e,i,s,n);if(t){let i=n.soloTransitions;i&&this.setExitTransition(t,i,e,s,a)}}}for(let n=t.length-1;n>=0;n--){let l=t[n];if(l.states)continue;if("-1"==l.id){if(l.soloTransitions&&0<l.soloTransitions.length){null==r?(i.defaultState=e[l.soloTransitions[0].id],i._enterTransition=this._getAnimatorTransition2D(l.soloTransitions[0],e,s)):e[r.id]=e[l.soloTransitions[0].id];continue}}else{if("-2"==l.id){let t=l.soloTransitions;if(t)for(let i=t.length-1;i>=0;i--){let r=t[i];if(e[r.id])for(let t in e){let i=e[t],a=this._getAnimatorTransition2D(r,e,s);r.solo?i.soloTransitions.unshift(a):i.transitions.unshift(a)}}continue}if("-3"==l.id)continue}let o=l.soloTransitions;if(o&&e[l.id]){let t=e[l.id].transitions,i=e[l.id].soloTransitions;for(let r=o.length-1;r>=0;r--){let n=o[r];if("-3"==n.id){null==a[l.id]&&(a[l.id]=[]),a[l.id].push(n);continue}let h=this._getAnimatorTransition2D(n,e,s);n.solo?i.unshift(h):t.unshift(h)}}}return a}addConditions(e,i,s){let r=s.animatorParams;if(null!=r&&0!=r.length)for(let s=0,a=e.length;s<a;s++){let a,n=e[s],l=null;for(let t=r.length-1;t>=0;t--)if(r[t].id==n.id){l=r[t];break}if(null==l)return;if(l.type==t.AniParmType.Bool){let t=new qn(l.name);t.compareFlag=Boolean(n.checkValue),a=t}else if(l.type==t.AniParmType.Float){let t=new jn(l.name);t.numberValue=Number(n.checkValue),t.compareFlag=n.type,a=t}else if(l.type==t.AniParmType.Trigger){a=new $n(l.name)}i.addCondition(a)}}updateTo(t){let e=t._controllerLayers;for(let t=0,i=e.length;t<i;t++)e[t].destroy();e.length=0;let i=this.getLayers();for(let e=0,s=i.length;e<s;e++)t.addControllerLayer(i[e]);let s=this.data.animatorParams;if(s){let e={};for(let t=s.length-1;t>=0;t--){let i=s[t],r=new Wn;r.name=i.name,r.type=i.type,r.value=i.val,e[i.name]=r}t.parameters=e}}}class Zn extends Vt{_isScript(){return!0}setupScript(){let t,i=this.owner;this.onTriggerEnter!=Zn.prototype.onTriggerEnter&&i.on(r.TRIGGER_ENTER,this,this.onTriggerEnter),this.onTriggerStay!=Zn.prototype.onTriggerStay&&i.on(r.TRIGGER_STAY,this,this.onTriggerStay),this.onTriggerExit!=Zn.prototype.onTriggerExit&&i.on(r.TRIGGER_EXIT,this,this.onTriggerExit),this.onCollisionEnter!=Zn.prototype.onCollisionEnter&&i.on(r.COLLISION_ENTER,this,this.onCollisionEnter),this.onCollisionStay!=Zn.prototype.onCollisionStay&&i.on(r.COLLISION_STAY,this,this.onCollisionStay),this.onCollisionExit!=Zn.prototype.onCollisionExit&&i.on(r.COLLISION_EXIT,this,this.onCollisionExit),(t=this.onJointBreak)&&i.on(r.JOINT_BREAK,this,t),(t=this.onMouseDown)&&i.on(r.MOUSE_DOWN,this,t),(t=this.onMouseUp)&&i.on(r.MOUSE_UP,this,t),(t=this.onRightMouseDown)&&i.on(r.RIGHT_MOUSE_DOWN,this,t),(t=this.onRightMouseUp)&&i.on(r.RIGHT_MOUSE_UP,this,t),(t=this.onMouseMove)&&i.on(r.MOUSE_MOVE,this,t),(t=this.onMouseDrag)&&i.on(r.MOUSE_DRAG,this,t),(t=this.onMouseDragEnd)&&i.on(r.MOUSE_DRAG_END,this,t),(t=this.onMouseOver)&&i.on(r.MOUSE_OVER,this,t),(t=this.onMouseOut)&&i.on(r.MOUSE_OUT,this,t),(t=this.onMouseClick)&&i.on(r.CLICK,this,t),(t=this.onMouseDoubleClick)&&i.on(r.DOUBLE_CLICK,this,t),(t=this.onMouseRightClick)&&i.on(r.RIGHT_CLICK,this,t),(t=this.onKeyDown)&&e.stage.on(r.KEY_DOWN,this,t),(t=this.onKeyPress)&&e.stage.on(r.KEY_PRESS,this,t),(t=this.onKeyUp)&&e.stage.on(r.KEY_UP,this,t),i.event(r._Add_Script)}}t.TextResourceFormat=void 0,(Ln=t.TextResourceFormat||(t.TextResourceFormat={}))[Ln.Buffer=0]="Buffer",Ln[Ln.Plain=1]="Plain",Ln[Ln.JSON=2]="JSON",Ln[Ln.XML=3]="XML";class Jn extends b{constructor(t,e){super(),this.data=t,this.format=e}}Bt.registerLoader(["txt","csv"],class{load(e){return e.loader.fetch(e.url,"text",e.progress.createCallback(),e.options).then((e=>e?new Jn(e,t.TextResourceFormat.Plain):null))}},Bt.TEXT),Bt.registerLoader(["bin","bytes","fui"],class{load(e){return e.loader.fetch(e.url,"arraybuffer",e.progress.createCallback(),e.options).then((e=>e?new Jn(e,t.TextResourceFormat.Buffer):null))}},Bt.BUFFER),Bt.registerLoader(["json"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(),e.options).then((e=>e?new Jn(e,t.TextResourceFormat.JSON):null))}},Bt.JSON),Bt.registerLoader(["xml"],class{load(e){return e.loader.fetch(e.url,"xml",e.progress.createCallback(),e.options).then((e=>e?new Jn(e,t.TextResourceFormat.XML):null))}},Bt.XML);Bt.registerLoader(["atlas"],class{load(t){return t.loader.fetch(t.url,"json",t.progress.createCallback(.2),t.options).then((e=>{if(!e)return null;let i=[];if(e.meta&&e.meta.image){let s="",r=t.url.lastIndexOf("/");-1!=r&&(s=t.url.substring(0,r+1));let a="";r=t.url.lastIndexOf("?"),-1!=r&&(a=t.url.substring(r));let n=e.meta.image.split(",");for(let e of n)i.push(t.loader.load(s+e+a,null,t.progress.createCallback()))}else i.push(t.loader.load(P.replaceFileExtension(t.url,"png"),null,t.progress.createCallback()));return Promise.all(i).then((i=>{let s=t.options.baseUrl||"",r=e.frames,a=e.meta&&null!=e.meta.prefix?e.meta.prefix:t.url.substring(0,t.url.lastIndexOf("."))+"/",n=[],l=1;e.meta&&e.meta.scale&&1!=e.meta.scale&&(l=parseFloat(e.meta.scale));for(let t of i)t&&(t._addReference(),t.scaleRate=l);for(let e in r){let l=r[e],o=i[l.frame.idx?l.frame.idx:0];if(!o)continue;let h=s+a+(l.filename||e),u=mt.create(o,l.frame.x,l.frame.y,l.frame.w,l.frame.h,l.spriteSourceSize.x,l.spriteSourceSize.y,l.sourceSize.w,l.sourceSize.h);u.lock=!0,u._sizeGrid=l.sizeGrid,u._stateNum=l.stateNum,t.loader.cacheRes(h,u),u.url=h,n.push(u)}return new xt(a,i,n)}))}))}},Bt.ATLAS);class tl{static _parseHDRTexture(t,e=null,i=null){let s=tl.getHDRInfo(t),r=new ct(s.width,s.height,s.format,!1,!1,!1);return r.setHDRData(s),e&&(null!=e.wrapModeU&&(r.wrapModeU=e.wrapModeU),null!=e.wrapModeV&&(r.wrapModeV=e.wrapModeV),null!=e.filterMode&&(r.filterMode=e.filterMode),null!=e.anisoLevel&&(r.anisoLevel=e.anisoLevel)),r}static getHDRInfo(e){let i=new Uint8Array(e),s=0;const r=()=>{let t=tl.getLineString(i,s);return s+=t.length+1,t};if("#?RADIANCE"!=r())throw"HDR image: identifier wrong.";let a=new Map,n="";do{if(n=r(),"#"!=n[0]){let t=n.split("=");a.set(t[0],t[1])}}while(""!=n);if("32-bit_rle_rgbe"!=a.get("FORMAT"))throw"HDR image: unsupported format.";let l=r().split(" "),o="-Y"==l[0],h="-X"==l[2],u=parseInt(l[1]),d=parseInt(l[3]);return new tl(e,s,h,o,d,u,t.TextureFormat.R32G32B32A32)}static getLineString(t,e){let i=t.length,s=e,r="",a="";for(;s<i&&"\n"!=a;)r=`${r}${a}`,a=String.fromCharCode(t[s]),s++;return r}constructor(t,e,i,s,r,a,n){this.source=t,this.byteOffset=e,this.decreaseX=i,this.decreaseY=s,this.width=r,this.height=a,this.format=n}get_32_bit_rle_rgbe(){let t=this.width,e=this.height;this.decreaseX,this.decreaseY;let i=new Uint8Array(this.source,this.byteOffset),s=0,r=new ArrayBuffer(4*t),a=new Uint8Array(r),n=new ArrayBuffer(t*e*4*3),l=new Float32Array(n);for(let r=e;r>0;r--){i[s++],i[s++];let n=i[s++]<<8|i[s++];if(n!=t)throw"HDR info: scanlineLength wrong.";let o=0;for(let t=0;t<4;t++){let e=(t+1)*n;for(;o<e;){let t=i[s++],r=i[s++];if(t>128){let i=t-128;if(i>e-o)throw"HDR info: ??";for(;i-- >0;)a[o++]=r}else{let n=t;if(0==n||n>e-o)throw"HDR info: ??";if(a[o++]=r,--n>0)for(let t=0;t<n;t++)a[o++]=i[s++]}}}for(let t=0;t<n;t++){let i=a[t],s=a[t+n],o=a[t+2*n],h=a[t+3*n],u=(e-r)*n*3+3*t;const d=(t,e)=>e>1023?t*Math.pow(2,1023)*Math.pow(2,e-1023):e<-1074?t*Math.pow(2,-1074)*Math.pow(2,e+1074):t*Math.pow(2,e);if(h>0){let t=d(1,h-136);l[u]=i*t,l[u+1]=s*t,l[u+2]=o*t}else l[u]=0,l[u+1]=0,l[u+2]=0}}return l}readScanLine(){let e=this.width,i=this.height,s=this.decreaseX,r=this.decreaseY,a=3;this.format==t.TextureFormat.R32G32B32A32&&(a=4);let n=new Float32Array(e*i*a),l=new Uint8Array(4*e),o=new Uint8Array(this.source,this.byteOffset),h=o.length,u=0;const d=()=>{if(u>=h)throw"HDR info: data wrong.";return o[u++]},c=()=>{throw"HDR info: data wrong."};for(let t=i-1;t>=0;t--){this.readcolors(l,d,c);for(let o=0;o<e;o++){let h=4*o,u=l[h],d=l[h+1],c=l[h+2],_=l[h+3],p=t,f=o;r&&(p=i-1-t),s&&(f=e-1-o);let g=p*e*a+f*a;if(0==_)n[g]=0,n[g+1]=0,n[g+2]=0,4==a&&(n[g+3]=1);else{let t=el(1,_-136);n[g]=(u+.5)*t,n[g+1]=(d+.5)*t,n[g+2]=(c+.5)*t,4==a&&(n[g+3]=1)}}}return n}readcolors(t,e,i){const s=(e,i,s)=>{t[4*e+i]=s};let r=this.width,a=e(),n=e(),l=e(),o=e();if(r<8||r>32767)this.olddreadcolors(t,e,a,n,l,o);else if(2!=a||2!=n||128&l)this.olddreadcolors(t,e,a,n,l,o);else{(l<<8|o)!=r&&i();for(let t=0;t<4;t++)for(let a=0;a<r;){let n=e();if(n>128){n&=127;let l=e();for(a+n>r&&i();n--;)s(a++,t,l)}else for(a+n>r&&i();n--;){s(a++,t,e())}}}}olddreadcolors(t,e,i,s,r,a){let n=0,l=this.width;t[0]=i,t[1]=s,t[2]=r,t[3]=a;for(let i=1;i<l;i++){let s=e(),r=e(),a=e(),l=e(),o=4*i;if(t[o]=s,t[o+1]=r,t[o+2]=a,t[o+3]=l,1==s&&1==r&&1==a){let e=o-4;for(let i=l<<n;i>0;i--)t[o]=t[e],t[o+1]=t[e+1],t[o+2]=t[e+2],t[o+3]=t[e+3];n+=8}else n=0}}color_color(t,e){let i=0;0==e.w?t.x=t.y=t.z=0:(i=el(1,e.w-136),t.x=e.x*i,t.y=e.y*i,t.z=e.z*i)}}function el(t,e){return t*Math.pow(2,e)}tl.HDRTEXTURE="HDRTEXTURE";class il{constructor(){Pn||(Pn={"WhiteTexture.png":ct.whiteTexture,"BlackTexture.png":ct.blackTexture,"GrayTexture.png":ct.grayTexture,"NormalTexture.png":ct.normalTexture})}load(t){if(-1!=t.url.indexOf("internal/")){let e=Pn[P.getBaseName(t.url)];if(e)return Promise.resolve(e)}let e;return t.url.startsWith("data:")||(e=N.inst.metaMap[t.url],e||!n.isPreview)?this.load2(t,e):N.inst.getMeta(t.url,t.uuid).then((e=>this.load2(t,e)))}load2(e,i){var s,r,a;let n,o,h=e.ext,u=e.url;if(i){let t=A.platform,l=(null===(s=i.platforms)||void 0===s?void 0:s[t])||0,d=(null===(r=i.files)||void 0===r?void 0:r[l])||{};d.file&&(u=N.inst.getSubAssetURL(u,e.uuid,d.file,d.ext),h=d.ext),n=[0,0,null!==(a=d.format)&&void 0!==a?a:1,i.mipmap,i.readWrite,i.sRGB],o={wrapModeU:i.wrapMode,wrapModeV:i.wrapMode,filterMode:i.filterMode,anisoLevel:i.anisoLevel,premultiplyAlpha:!!i.pma,hdrEncodeFormat:i.hdrEncodeFormat}}else n=e.options.constructParams,o=e.options.propertyParams;let d=-1!=ol.indexOf(h)?h:null;if(null!=d)return e.loader.fetch(u,"arraybuffer",e.progress.createCallback(),e.options).then((s=>{if(!s)return null;let r;switch(d){case"dds":let e=lt.getDDSTextureInfo(s);if(e.isCube){let t=Ot.getClass("TextureCube");if(!t)return null;{let i=!!n&&!!n[5],s=new t(e.width,e.format,e.mipmapCount>1,i);s.setDDSData(e),r=s}}else r=ct._parseDDS(s,o,n);break;case"ktx":let i=dt.getKTXTextureInfo(s);if(i.dimension==t.TextureDimension.Cube){let t=Ot.getClass("TextureCube");if(!t)return null;{let e=new t(i.width,i.format,i.mipmapCount>1,i.sRGB);e.setKTXData(i),r=e}}else i.dimension==t.TextureDimension.Tex2D&&(r=ct._parseKTX(s,o,n));break;case"pvr":r=ct._parsePVR(s,o,n);break;case"hdr":r=tl._parseHDRTexture(s,o,n);break;case"lanit.ls":r=ct._SimpleAnimatorTextureParse(s,o,n)}let a=e.obsoluteInst;return a&&Object.getPrototypeOf(a)==Object.getPrototypeOf(r)&&(r=this.move(a,r)),o&&o.hdrEncodeFormat&&(r.hdrEncodeFormat=o.hdrEncodeFormat),i&&(r._sizeGrid=i.sizeGrid,r._stateNum=i.stateNum),r}));{let t=e.options,s=o&&o.premultiplyAlpha?"premultiply":"none";return t.useWorkerLoader&&"none"===s&&(t=Object.assign({workerLoaderOptions:{premultiplyAlpha:s}},t)),e.loader.fetch(u,"image",e.progress.createCallback(),t).then((e=>l.textureContext.needBitmap?e instanceof ImageBitmap?e:createImageBitmap(e,t.workerLoaderOptions||{premultiplyAlpha:s}):e)).then((t=>{if(!t)return null;let s=ct._parseImage(t,o,n),r=e.obsoluteInst;return r&&Object.getPrototypeOf(r)==Object.getPrototypeOf(s)&&(s=this.move(r,s)),i&&(s._sizeGrid=i.sizeGrid,s._stateNum=i.stateNum),s}))}}move(t,e){return t._texture=e._texture,t._format=e.format,t.width=e.width,t.height=e.height,t.obsolute=!1,delete b._idResourcesMap[e.id],t}}class sl{load(t){return t.loader.fetch(t.url,"json",t.progress.createCallback(),t.options).then((e=>{if(!e)return null;let i=t.obsoluteInst;return i?i.recreate(e.width,e.height,e.colorFormat,e.depthFormat,e.generateMipmap,e.multiSamples,e.generateDepthTexture,e.sRGB):i=new R(e.width,e.height,e.colorFormat,e.depthFormat,e.generateMipmap,e.multiSamples,e.generateDepthTexture,e.sRGB),null!=e.anisoLevel&&(i.anisoLevel=e.anisoLevel),null!=e.filterMode&&(i.filterMode=e.filterMode),null!=e.wrapModeU&&(i.wrapModeU=e.wrapModeU),null!=e.wrapModeV&&(i.wrapModeV=e.wrapModeV),i}))}}class rl{load(t){let e=t.obsoluteInst||new En;return e.source=t.url,Promise.resolve(e)}}const al={premultiplyAlpha:!0},nl=[null,null,t.TextureFormat.R8G8B8A8,!1,!1,!0];class ll{wrapTex2D(t,e){if(!e)return null;let i=t.obsoluteInst;return i?(i.setTo(e),i.obsolute=!1,i._sizeGrid=e._sizeGrid,i._stateNum=e._stateNum,i.event("reload"),i._clipCache&&i._clipCache.forEach((t=>{t.event("reload"),t._sizeGrid=i._sizeGrid,t._stateNum=i._stateNum}))):(i=new mt(e),i._sizeGrid=e._sizeGrid,i._stateNum=e._stateNum),i}load(t){let e=t.loader.getRes(t.url,Bt.TEXTURE2D);if(!e||e.obsolute){let e={url:t.url,type:Bt.TEXTURE2D};return t.options.propertyParams?null==t.options.propertyParams.premultiplyAlpha&&(e.propertyParams=Object.assign({},al,t.options.propertyParams)):e.propertyParams=al,t.options.constructParams?null==t.options.constructParams[5]&&(e.constructParams=Object.assign([],nl,t.options.constructParams)):e.constructParams=nl,t.loader.load(e,t.options,t.progress.createCallback()).then((e=>this.wrapTex2D(t,e)))}return Promise.resolve(this.wrapTex2D(t,e))}}const ol=["ktx","pvr","dds","hdr","lanit.ls"],hl=["mp4","webm"];Bt.registerLoader(["tga","tif","tiff","png","jpg","jpeg","rendertexture",...hl,...ol],ll,Bt.IMAGE,!0),Bt.registerLoader([],il,Bt.TEXTURE2D,!0),Bt.registerLoader(["rendertexture"],sl,Bt.TEXTURE2D,!0),Bt.registerLoader(hl,rl,Bt.TEXTURE2D);Bt.registerLoader(["mc"],class{load(t){return t.loader.fetch(t.url,"arraybuffer",t.progress.createCallback(),t.options).then((t=>t?zn._parse(t):null))}});Bt.registerLoader(["mcc"],class{load(t){return t.loader.fetch(t.url,"json",t.progress.createCallback(.2),t.options).then((e=>{let i=new Qn(e);if(i.data&&i.data.controllerLayers){let e=i.data.controllerLayers,s=[];for(let i=e.length-1;i>=0;i--){let r=e[i].states;this.loadStates(r,s,t)}return Promise.all(s).then((()=>i))}return i}))}loadStates(t,e,i){let s=O.getPath(i.url);for(let r=t.length-1;r>=0;r--){if(t[r].clip&&t[r].clip._$uuid){let a=O.getResURLByUUID(t[r].clip._$uuid);a.startsWith("res://")||(a=O.join(s,a)),e.push(i.loader.load(a).then((e=>{t[r].clip=e})))}t[r].states&&this.loadStates(t[r].states,e,i)}}});class ul{load(t){return Promise.resolve(null)}}Bt.registerLoader(["lighting"],ul);Bt.registerLoader(["fnt"],class{load(t){let e=P.replaceFileExtension(t.url,"png");return Promise.all([t.loader.fetch(t.url,"xml",t.progress.createCallback(.2),t.options),t.loader.load(e,t.options,t.progress.createCallback(.8))]).then((([t,e])=>{if(!t||!e)return null;let i=new Lr;return i.parseFont(t,e),i}))}},Bt.FONT);const dl="LayaTTFFont";Bt.registerLoader(["ttf","woff","woff2","otf"],class{load(t){let i=P.replaceFileExtension(P.getBaseName(t.url),"");if(n.isConch)return t.loader.fetch(t.url,"arraybuffer").then((t=>(t&&window.conch.registerFont(i,t),{family:i})));if(window.FontFace){let e=new window.FontFace(i,"url('"+O.postFormatURL(O.formatURL(t.url))+"')");return document.fonts.add(e),e.load().then((()=>e))}{let s="40px "+i,r=A.measureText(dl,s).width,a=A.createElement("style");return a.type="text/css",document.body.appendChild(a),a.textContent="@font-face { font-family:'"+i+"'; src:url('"+O.postFormatURL(O.formatURL(t.url))+"');}",new Promise((t=>{let a=()=>{A.measureText(dl,s).width!=r&&n()},n=()=>{e.systemTimer.clear(this,a),e.systemTimer.clear(this,n),t({family:i})};e.systemTimer.once(1e4,this,n),e.systemTimer.loop(20,this,a)}))}}},Bt.TTF);class cl{static parse(t){let e=t.props;switch(t.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":case"LAYAMATERIAL:03":let e=cl.parseLegacy(t);return e.oldparseEndEvent(),e;case"LAYAMATERIAL:04":break;default:throw new Error(`unkonwn material version: ${t.version}`)}let i,s=new Ga;s.setShaderName(e.type);for(let t in e)switch(t){case"type":case"name":break;case"defines":let a=e[t];for(let t=0,e=a.length;t<e;t++){let e=ci.getDefineByName(a[t]);s._shaderValues.addDefine(e)}break;case"textures":let n=e[t];for(let t=0,e=n.length;t<e;t++){let e=n[t],i=e.path;i&&s._shaderValues.setTexture(ci.propertyNameToID(e.name),Bt.getBaseTexture(i))}break;case"renderQueue":i=e[t];break;case"alphaTest":s.alphaTest=e[t];break;case"materialRenderMode":s.materialRenderMode=e[t];break;default:let l=e[t],o=ci.propertyNameToID(t);switch(o){case ci.CULL:s.cull=l;break;case ci.BLEND:s.blend=l;break;case ci.BLEND_SRC:s.blendSrc=l;break;case ci.BLEND_DST:s.blendDst=l;break;case ci.BLEND_DST_ALPHA:s.blendDstAlpha=l;break;case ci.BLEND_SRC_ALPHA:s.blendSrcAlpha=l;break;case ci.BLEND_SRC_RGB:s.blendSrcRGB=l;break;case ci.BLEND_SRC_RGB:s.blendDstRGB=l;break;case ci.DEPTH_TEST:s.depthTest=l;break;case ci.DEPTH_WRITE:s.depthWrite=!!e[t];break;case ci.STENCIL_TEST:s.stencilTest=l;break;case ci.STENCIL_Op:s.stencilOp=l;break;case ci.STENCIL_Ref:s.stencilRef=l;break;case ci.STENCIL_WRITE:s.stencilWrite=l;break;default:if(l.length){var r=l;switch(r.length){case 2:s._shaderValues.setVector2(o,new Ze(r[0],r[1]));break;case 3:s._shaderValues.setVector3(o,new d(r[0],r[1],r[2]));break;case 4:s._shaderValues.getColor(o)?s._shaderValues.setColor(o,new _t(r[0],r[1],r[2],r[3])):s._shaderValues.setVector(o,new u(r[0],r[1],r[2],r[3]));break;case 9:let t=new Fe;t.elements=new Float32Array(r),s._shaderValues.setMatrix3x3(o,t);break;case 16:let e=new Ke;e.elements=new Float32Array(r),s._shaderValues.setMatrix4x4(o,e);break;default:s._shaderValues.setBuffer(o,r)}}else"boolean"==typeof l?s._shaderValues.setBool(o,e[t]):s._shaderValues.setNumber(o,e[t])}}return null!=i&&(s.renderQueue=i),s}static collectLinks(t,e){var i;let s=[],r=null===(i=t.props)||void 0===i?void 0:i.textures;if(r)for(let t=0,i=r.length;t<i;t++){let i=r[t],a=i.path;a&&(i.path=O.join(e,a),s.push({url:i.path,type:Bt.TEXTURE2D,constructParams:i.constructParams,propertyParams:i.propertyParams}))}return s}static parseLegacy(t){let e,i=t,s=i.props,r=s.type,a=Ot.getClass(r);switch(!a&&r&&r.startsWith("Laya.")&&(a=Ot.getClass(r.substring(5))),a?e=new a:(e=new Ga,e.setShaderName(r)),i.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":for(let t in s)switch(t){case"type":break;case"vectors":let i=s[t];for(let t=0,s=i.length;t<s;t++){let s=i[t],r=s.value;switch(r.length){case 2:e[s.name]=new Ze(r[0],r[1]);break;case 3:e[s.name]instanceof _t?e[s.name]=new _t(r[0],r[1],r[2],1):e[s.name]=new d(r[0],r[1],r[2]);break;case 4:e[s.name]instanceof _t?e[s.name]=new _t(r[0],r[1],r[2],r[3]):e[s.name]=new u(r[0],r[1],r[2],r[3]);break;default:throw new Error("unknown material color length: "+r.length)}}break;case"colors":let r=s[t];for(let t=0,i=r.length;t<i;t++){let i=r[t],s=i.value;e[i.name]=new _t(s[0],s[1],s[2],s[3])}break;case"textures":let a=s[t];for(let t=0,i=a.length;t<i;t++){let i=a[t],s=i.path;s&&(e[i.name]=Bt.getBaseTexture(s))}break;case"defines":let n=s[t];for(let t=0,i=n.length;t<i;t++){let i=ci.getDefineByName(n[t]);e._shaderValues.addDefine(i)}break;case"renderStates":let l=s[t][0];e.blend=l.blend,e.cull=this._getRenderStateParams(l.cull),e.depthTest=this._getRenderStateParams(l.depthTest),e.depthWrite=l.depthWrite,e.blendSrc=this._getRenderStateParams(l.srcBlend),e.blendDst=this._getRenderStateParams(l.dstBlend);break;case"cull":e.cull=this._getRenderStateParams(s[t]);break;case"blend":e.blend=this._getRenderStateParams(s[t]);break;case"depthWrite":e.depthWrite=!!s[t];break;case"srcBlend":case"blendSrc":e.blendSrc=this._getRenderStateParams(s[t]);break;case"dstBlend":case"blendDst":e.blendDst=this._getRenderStateParams(s[t]);break;case"depthTest":e.depthTest=this._getRenderStateParams(s[t]);break;default:e[t]=s[t]}break;case"LAYAMATERIAL:03":for(let t in s)switch(t){case"type":case"name":break;case"defines":let i=s[t];for(let t=0,s=i.length;t<s;t++){let s=ci.getDefineByName(i[t]);e._shaderValues.addDefine(s)}break;case"textures":let r=s[t];for(let t=0,i=r.length;t<i;t++){let i=r[t],s=i.path;s&&e._shaderValues.setTexture(ci.propertyNameToID(i.name),Bt.getBaseTexture(s))}break;case"renderQueue":e.renderQueue=s[t];break;default:let a=s[t],l=ci.propertyNameToID(t);switch(l){case ci.CULL:e.cull=this._getRenderStateParams(a);break;case ci.BLEND:e.blend=this._getRenderStateParams(a);break;case ci.BLEND_SRC:e.blendSrc=this._getRenderStateParams(a);break;case ci.BLEND_DST:e.blendDst=this._getRenderStateParams(a);break;case ci.DEPTH_TEST:e.depthTest=this._getRenderStateParams(a);break;case ci.DEPTH_WRITE:e.depthWrite=!!s[t];break;default:if(a.length){var n=a;switch(n.length){case 2:e._shaderValues.setVector2(l,new Ze(n[0],n[1]));break;case 3:e._shaderValues.setVector3(l,new d(n[0],n[1],n[2]));break;case 4:e._shaderValues.getColor(l)?e._shaderValues.setColor(l,new _t(n[0],n[1],n[2],n[3])):e._shaderValues.setVector(l,new u(n[0],n[1],n[2],n[3]));break;default:throw new Error("unknown material color length: "+n.length)}}else"boolean"==typeof a?e._shaderValues.setBool(l,s[t]):e._shaderValues.setNumber(l,s[t])}}break;default:throw new Error("unknown material version: "+i.version)}return e}static _getRenderStateParams(e){switch(e){case 768:return t.BlendFactor.SourceColor;case 769:return t.BlendFactor.OneMinusSourceColor;case 774:return t.BlendFactor.DestinationColor;case 775:return t.BlendFactor.OneMinusDestinationColor;case 770:return t.BlendFactor.SourceAlpha;case 771:return t.BlendFactor.OneMinusSourceAlpha;case 772:return t.BlendFactor.DestinationAlpha;case 773:return t.BlendFactor.OneMinusDestinationAlpha;case 776:return t.BlendFactor.SourceAlphaSaturate;case 32774:return t.BlendEquationSeparate.ADD;case 32778:return t.BlendEquationSeparate.SUBTRACT;case 32779:return t.BlendEquationSeparate.REVERSE_SUBTRACT;case 512:return t.CompareFunction.Never;case 513:return t.CompareFunction.Less;case 514:return t.CompareFunction.Equal;case 515:return t.CompareFunction.LessEqual;case 516:return t.CompareFunction.Greater;case 517:return t.CompareFunction.NotEqual;case 518:return t.CompareFunction.GreaterEqual;case 519:return t.CompareFunction.Always;default:return e}}}class _l{load(t){return t.loader.fetch(t.url,"json",t.progress.createCallback(.3),t.options).then((e=>{if(!e)return null;let i=O.getPath(t.url),s=cl.collectLinks(e,i);if("LAYAMATERIAL:04"===e.version){let r=e.props.type;if(!ci.find(r)){let a=N.inst.shaderName_to_URL(r);if(!a)return N.inst.shaderName_to_URL_async(r).then((a=>(a?s.push(a):e.props.shaderPath?s.push(O.join(i,e.props.shaderPath)):Bt.warn(`unknown shaderName: ${r}`),this.load2(t,e,s))));s.push(a)}}return this.load2(t,e,s)}))}load2(t,e,i){if(0==i.length){let i=cl.parse(e),s=t.obsoluteInst;return s&&(i=this.move(s,i)),Promise.resolve(i)}let s=Object.assign({},t.options);return s.initiator=t,delete s.cache,delete s.ignoreCache,t.loader.load(i,s,t.progress.createCallback()).then((()=>{let i=cl.parse(e),s=t.obsoluteInst;return t.obsoluteInst&&(i=this.move(s,i)),i}))}move(t,e){return t._shaderValues.reset(),t.setShaderName(e._shader.name),e._shaderValues.cloneTo(t._shaderValues),t.materialRenderMode=e.materialRenderMode,t.renderQueue=e.renderQueue,t.obsolute=!1,e.destroy(),t}}Bt.registerLoader(["lmat"],_l,Bt.MATERIAL,!0);class pl{static parse(t){return this.parseStart(t)}static findIndex(t,e,i,s){var r=t.indexOf(i,e+1);return 0>r&&(r=s),{str:t.substring(e+1,r),i:r}}static finCurrObj(){if(this.type=1,null==this.cobj)return null;if(0==this.currArr.length)return this.cobj.k&&(this.ret[this.cobj.k]=this.cobj.val),null;var t=this.currArr.pop();if(this.cobj.k)if(Array.isArray(t.val)){if(null!=this.cobj.k){var e={};e[this.cobj.k]=this.cobj.val,t.val.push(e)}}else t.val[this.cobj.k]=this.cobj.val;else Array.isArray(this.cobj.val)&&(Array.isArray(t.val)?t.val.push(this.cobj.val):t.val=this.cobj.val);return t}static formatVal(t){if(null==t)return null;var e=Number(t);return isNaN(e)?"false"!=t.toLowerCase()&&("true"==t.toLowerCase()||("null"==t?null:t)):e}static finCurrStr(){null!=this.currStr&&(this.currStr=this.currStr.trim(),""!=this.currStr&&(null!=this.cobj&&(Array.isArray(this.cobj.val)?this.cobj.val.push(this.formatVal(this.currStr)):(this.cobj.val=this.formatVal(this.currStr),this.cobj=this.finCurrObj())),this.currStr=""))}static parseStart(t){this.len=t.length;var e=0;for(this.ret={},this.currStr=null,this.currArr=[],this.cobj=null,this.type=0;e<this.len;){var i=t.charAt(e);if("/"==i){if(e+1<this.len){e+=1;var s=t.charAt(e),r=null;if("/"==s?r="\n":"*"==s&&(r="*/"),null!=r){this.finCurrStr();var a=t.indexOf(r,e);0>a?(console.log("没有找到注释结尾，应该是一直注释到最后了"),e=this.len):e=a+r.length-1}}}else if("}"==i)null!=this.cobj&&(this.finCurrStr(),null!=this.cobj&&(this.cobj=this.finCurrObj())),this.currStr="",this.type=1;else if("{"==i)this.currStr="",this.type=1;else if("'"==i||'"'==i||"‘"==i||"“"==i){"‘"==i?i="’":"“"==i&&(i="”");var n=this.findIndex(t,e,i,this.len);2==this.type&&null!=this.cobj&&Array.isArray(this.cobj.val)?(null!=this.currStr&&(this.currStr=this.currStr.trim(),""!=this.currStr&&this.cobj.val.push(this.formatVal(this.currStr))),this.cobj.val.push(n.str),this.currStr=""):null!=this.currStr&&(this.currStr+=n.str),e=n.i}else if(";"==i||","==i||"\n"==i)this.finCurrStr();else if("]"==i)null!=this.currStr&&null!=this.cobj&&Array.isArray(this.cobj.val)&&(this.currStr=this.currStr.trim(),""!=this.currStr&&this.cobj.val.push(this.formatVal(this.currStr))),null!=this.cobj&&(this.cobj=this.finCurrObj(),this.cobj=this.finCurrObj()),this.currStr="";else if("["==i)2!=this.type?console.warn("没有key值，忽略掉一个数组"):(null!=this.cobj&&this.currArr.push(this.cobj),this.cobj={val:[]});else if(":"==i){if(null!=this.currStr&&1==this.type){if(this.type=2,null!=this.cobj&&this.currArr.push(this.cobj),null!=this.cobj&&Array.isArray(this.cobj.val)){var l=this.cobj;this.cobj={val:{}},l.val.push(this.cobj.val),this.currArr.push(this.cobj)}this.cobj={k:this.currStr.trim(),val:{}},this.currStr=""}}else null!=this.currStr&&(this.currStr+=i);e++}return this.ret}}const fl=["GLSL Start","GLSL End"],gl=["#defineGLSL","#endGLSL"],ml=["Shader3D Start","Shader3D End"],yl={Color:t.ShaderDataType.Color,Int:t.ShaderDataType.Int,Bool:t.ShaderDataType.Bool,Float:t.ShaderDataType.Float,Vector2:t.ShaderDataType.Vector2,Vector3:t.ShaderDataType.Vector3,Vector4:t.ShaderDataType.Vector4,Matrix4x4:t.ShaderDataType.Matrix4x4,Matrix3x3:t.ShaderDataType.Matrix3x3,Texture2D:t.ShaderDataType.Texture2D,TextureCube:t.ShaderDataType.TextureCube,Texture2DArray:t.ShaderDataType.Texture2DArray,Texture3D:t.ShaderDataType.Texture3D};class Tl{static parse(t,e){let i=Tl.getShaderBlock(t),s=Tl.getCGBlock(t);return Tl.bindCG(i,s),ci.parse(i,e)}static compileToTree(t,e,i){if(i==t.length)return[e];let s=t[i],r=e.split(s);if(1==r.length)return r;let a=[];for(let e=0,n=r.length;e<n;e++)a=a.concat(Tl.compileToTree(t,r[e],i+1)),e!=n-1&&a.push(s);return a}static getMapKey(t){let e=t.indexOf("\n");return t=(t=(t=t.slice(0,e).replace("\r","")).slice(0,e).replace(" ","")).trim()}static getShaderBlock(t){let e=null;try{let i=t.indexOf(ml[0]);if(-1==i)throw new Error(`no '${ml[0]}' tag`);let s=t.indexOf(ml[1]);if(-1==s)throw new Error(`no '${ml[1]}' tag`);let r=t.substring(i+ml[0].length,s);e=pl.parse(r)}catch(e){console.error("Shader parse error: "+e+"\n"+t.substring(0,100)+"...")}return e}static getCGBlock(t){let e={};try{let i=t.indexOf(fl[0]);if(-1==i)throw new Error(`no '${ml[0]}' tag`);let s=t.indexOf(fl[1]);if(-1==s)throw new Error(`no '${ml[1]}' tag`);let r=t.substring(i,s),a=Tl.compileToTree(gl,r,0);for(let t=0,i=a.length;t<i;t++){if(a[t]==gl[0]){t+=1;let i=a[t];e[Tl.getMapKey(i)]=i.slice(i.indexOf("\n"),i.length-1)}}}catch(e){console.error("Shader parse error: "+e+"\n"+t.substring(0,100)+"...")}return e}static bindCG(t,e){let i=t.shaderPass;i&&i.forEach((t=>{t.VS&&(t.VS=e[t.VS]),t.FS&&(t.FS=e[t.FS])}));let s=t.attributeMap;if(s){let e=0;for(let i in s)if(s[i]instanceof Array){let e=s[i],r=Tl.getShaderDataType(e[0]);if(null==r){console.warn(`${t.name}: unkown attribute type '${e[0]}'`);continue}s[i]=[e[1],r]}else{let r=Tl.getShaderDataType(s[i]);if(null==r){console.warn(`${t.name}: unkown attribute type '${s[i]}'`);continue}s[i]=[e,r],e++}}let r=t.uniformMap;if(r){let e={};t.defaultValue=e;let i={};t.uniformMap=i;for(let s in r){let a=r[s];if(!1===a.serializable)continue;let n=Tl.getShaderDataType(a.type);if(null!=n)if(null!=a.default&&(e[s]=Tl.getDefaultData(n,a.default)),a.block){let t=i[a.block];t||(i[a.block]=t={}),t[s]=n}else i[s]=n;else console.warn(`${t.name}: unkown uniform type '${a.type}'`)}}}static getShaderDataType(t){return yl[t]}static getDefaultData(e,i){switch(e){case t.ShaderDataType.Int:case t.ShaderDataType.Float:case t.ShaderDataType.Bool:return i;case t.ShaderDataType.Vector2:return new Ze(i[0],i[1]);case t.ShaderDataType.Vector3:return new d(i[0],i[1],i[2]);case t.ShaderDataType.Vector4:return new u(i[0],i[1],i[2],i[3]);case t.ShaderDataType.Color:return new _t(i[0],i[1],i[2],i[3]);case t.ShaderDataType.Matrix4x4:let e=new Ke;return e.cloneByArray(i),e;case t.ShaderDataType.Matrix3x3:let s=new Fe;return s.cloneByArray(i),s;case t.ShaderDataType.Texture2D:let r=null;return"white"==i?r=ct.whiteTexture:"black"==i?r=ct.blackTexture:"gray"==i?r=ct.grayTexture:"normal"==i&&(r=ct.normalTexture),r;case t.ShaderDataType.TextureCube:let a=Qa.grayTexture;return"white"==i?a=Qa.whiteTexture:"black"==i?a=Qa.blackTexture:"gray"==i&&(a=Qa.grayTexture),a}}}Bt.registerLoader(["shader","bps"],class{load(t){let e=t.url;return"bps"===t.ext&&(e=N.inst.getSubAssetURL(e,t.uuid,"0","shader")),t.loader.fetch(e,"text",t.progress.createCallback(),t.options).then((e=>{if(!e)return null;let i=Tl.getShaderBlock(e),s=Tl.getCGBlock(e);if(Tl.bindCG(i,s),!i.name||!i.uniformMap)return null;let r=O.getPath(t.url),a=i.shaderPass;return Promise.all(a.map((t=>Be.compileAsync(t.VS,t.FS,r)))).then((e=>{var s;if(-1!=e.findIndex((t=>null==t)))return Bt.warn("some pass null "+t.url),null;let r=ci.add(i.name,i.enableInstancing,i.supportReflectionProbe);r._surportVolumetricGI=i.surportVolumetricGI;let n=new ui(i.attributeMap?i.attributeMap:ui.DefaultAttributeMap,i.uniformMap,i.defaultValue);r.addSubShader(n);for(let t in a){let i=n._addShaderPass(e[t],a[t].pipeline);i.statefirst=null!==(s=a[t].statefirst)&&void 0!==s&&s,Be.getRenderState(a[t].renderState,i.renderState)}return r}))}))}});Bt.registerLoader(["mp3","wav","ogg"],class{load(t){return t.loader.fetch(t.url,"arraybuffer",t.progress.createCallback(),t.options).then((t=>t?Aa.ctx.decodeAudioData(t):null))}},Bt.SOUND);let xl=Ot.regClass;xl("Record",Object),xl("Node",yr),xl("Sprite",br),xl("Widget",on),xl("Text",Yr),xl("Input",ln),xl("AnimationBase",Cr),xl("Animation",Br),xl("FrameAnimation",Ar),xl("EffectAnimation",Pr),xl("SoundNode",Sn),xl("VideoNode",Dn),xl("Scene",pn),xl("Stage",Sa),xl("Component",Vt),xl("Script",Zn),xl("BitmapFont",Lr),xl("BlurFilter",gn),xl("ColorFilter",xn),xl("GlowFilter",vn),xl("Point",s),xl("Rectangle",F),xl("Texture",mt),xl("Texture2D",ct),xl("Prefab",hn),xl("Animator2D",On),xl("AnimatorControllerLayer2D",Cn),xl("AnimatorState2D",Fn),xl("AnimationClip2D",zn),xl("AnimatorController2D",Qn),xl("Animation2DParm",Wn),xl("Animation2DCondition",Yn),xl("Vector2",Ze),xl("Vector3",d),xl("Vector4",u),xl("Quaternion",ze),xl("Color",_t),xl("Matrix",G),xl("Matrix3x3",Fe),xl("Matrix4x4",Ke);class vl{static create(t,e,i){}constructor(t){this.blendType=0}}vl._blend_All_pool={},vl._blend_seperate_pool={};class Sl{static getHash(t,e,i){return t+(e<<3)+(i<<7)}static getBlendComponent(t,e,i){let s=Sl.getHash(t,e,i);return Sl._pool[s]||(Sl._pool[s]=new Sl(t,e,i,s)),Sl._pool[s]}constructor(t,e,i,s){this._hashIndex=0,this._hashIndex=s,this._blendOperationGLData=t,this._sourceBlendFactor=e,this._destinationFactor=i}}Sl._pool={};class El{get bufferUsage(){return this._bufferUsage}constructor(t,e){this._byteLength=0,this._bufferType=t,this._bufferUsage=e}destroy(){}}class wl{static getVertexLayoutByPool(t){let e=wl._pool;for(var i in e){let s=e[i];if(s.deepthEqaul(t))return s}return new wl(t)}constructor(t){this.VAElements=new Array,this.attributeByteSize=new Array,this.instanceMode=new Array;for(let e=0;e<t.length;e++){let i=[],s=t[e].vertexDeclaration.vertexStride,r=t[e].vertexDeclaration._VAElements;for(let t=0;t<r.length;t++)i.push({format:r[t].format,stride:r[t].stride,shaderLocation:r[t].shaderLocation});this.attributeByteSize.push(s),this.VAElements.push(i),this.instanceMode.push(t[e].instanceBuffer)}this.id=wl.IPoint,wl._pool[wl.IPoint++]=this}deepthEqaul(t){if(t.length!=this.VAElements.length)return!1;for(var e=0;e<t.length;e++){let r=t[e]._vertexDeclaration._VAElements,a=this.VAElements[e];if(r.length!=a.length)return!1;for(var i=0,s=r.length;i<s;i++){let t=r[i],e=a[i];if(t.format!=e.format||t.stride!=e.stride||t.shaderLocation!=e.shaderLocation)return!1}}return!0}}wl.IPoint=0,wl._pool={};class Dl extends Vt{constructor(){super(...arguments),this.duration=1e3,this.delay=0,this.repeat=0,this.autoDestroyAtComplete=!0}_onAwake(){this.target=this.target||this.owner,this.autoDestroyAtComplete&&(this._comlete=St.create(this.target,this.target.destroy,null,!1)),this.eventName?this.owner.on(this.eventName,this,this._exeTween):this._exeTween()}_exeTween(){this._tween=this._doTween(),this._tween.repeat=this.repeat}_doTween(){return null}onReset(){this.duration=1e3,this.delay=0,this.repeat=0,this.ease=null,this.target=null,this.eventName&&(this.owner.off(this.eventName,this,this._exeTween),this.eventName=null),this._comlete&&(this._comlete.recover(),this._comlete=null),this._tween&&(this._tween.clear(),this._tween=null)}}class bl{}bl.STANDARD=0,bl.LEFT=1,bl.RIGHT=2,bl.NUM_PAD=3;class Cl{}Cl.NUMBER_0=48,Cl.NUMBER_1=49,Cl.NUMBER_2=50,Cl.NUMBER_3=51,Cl.NUMBER_4=52,Cl.NUMBER_5=53,Cl.NUMBER_6=54,Cl.NUMBER_7=55,Cl.NUMBER_8=56,Cl.NUMBER_9=57,Cl.A=65,Cl.B=66,Cl.C=67,Cl.D=68,Cl.E=69,Cl.F=70,Cl.G=71,Cl.H=72,Cl.I=73,Cl.J=74,Cl.K=75,Cl.L=76,Cl.M=77,Cl.N=78,Cl.O=79,Cl.P=80,Cl.Q=81,Cl.R=82,Cl.S=83,Cl.T=84,Cl.U=85,Cl.V=86,Cl.W=87,Cl.X=88,Cl.Y=89,Cl.Z=90,Cl.F1=112,Cl.F2=113,Cl.F3=114,Cl.F4=115,Cl.F5=116,Cl.F6=117,Cl.F7=118,Cl.F8=119,Cl.F9=120,Cl.F10=121,Cl.F11=122,Cl.F12=123,Cl.F13=124,Cl.F14=125,Cl.F15=126,Cl.NUMPAD=21,Cl.NUMPAD_0=96,Cl.NUMPAD_1=97,Cl.NUMPAD_2=98,Cl.NUMPAD_3=99,Cl.NUMPAD_4=100,Cl.NUMPAD_5=101,Cl.NUMPAD_6=102,Cl.NUMPAD_7=103,Cl.NUMPAD_8=104,Cl.NUMPAD_9=105,Cl.NUMPAD_ADD=107,Cl.NUMPAD_DECIMAL=110,Cl.NUMPAD_DIVIDE=111,Cl.NUMPAD_ENTER=108,Cl.NUMPAD_MULTIPLY=106,Cl.NUMPAD_SUBTRACT=109,Cl.SEMICOLON=186,Cl.EQUAL=187,Cl.COMMA=188,Cl.MINUS=189,Cl.PERIOD=190,Cl.SLASH=191,Cl.BACKQUOTE=192,Cl.LEFTBRACKET=219,Cl.BACKSLASH=220,Cl.RIGHTBRACKET=221,Cl.QUOTE=222,Cl.ALTERNATE=18,Cl.BACKSPACE=8,Cl.CAPS_LOCK=20,Cl.COMMAND=15,Cl.CONTROL=17,Cl.DELETE=46,Cl.ENTER=13,Cl.ESCAPE=27,Cl.PAGE_UP=33,Cl.PAGE_DOWN=34,Cl.END=35,Cl.HOME=36,Cl.LEFT=37,Cl.UP=38,Cl.RIGHT=39,Cl.DOWN=40,Cl.SHIFT=16,Cl.SPACE=32,Cl.TAB=9,Cl.INSERT=45;class Rl{static getMCDName(t){return Rl._typeToNameDic[t]}static showRenderTypeInfo(t,e=!1){if(e||!Rl.showedDic[t]){if(Rl.showedDic[t]=!0,!Rl._rendertypeToStrDic[t]){var i,s=[];for(i=1;i<=t;)i&t&&s.push(Rl.getMCDName(i&t)),i<<=1;Rl._rendertypeToStrDic[t]=s.join(",")}console.log("cmd:",Rl._rendertypeToStrDic[t])}}static __init__(){Rl._typeToNameDic[re.ALPHA]="ALPHA",Rl._typeToNameDic[re.TRANSFORM]="TRANSFORM",Rl._typeToNameDic[re.TEXTURE]="TEXTURE",Rl._typeToNameDic[re.GRAPHICS]="GRAPHICS",Rl._typeToNameDic[re.CHILDS]="CHILDS",Rl._typeToNameDic[re.TRANSFORM|re.ALPHA]="TRANSFORM|ALPHA",Rl._typeToNameDic[re.CANVAS]="CANVAS",Rl._typeToNameDic[re.BLEND]="BLEND",Rl._typeToNameDic[re.FILTERS]="FILTERS",Rl._typeToNameDic[re.MASK]="MASK",Rl._typeToNameDic[re.CLIP]="CLIP"}constructor(){}render(t,e,i){Rl._addType(this._renderType),Rl.showRenderTypeInfo(this._renderType),bs.renders[this._renderType]._fun(this,t,e+this._x,i+this._y),this._repaint=0}_stageRender(t,i,s){Rl._countStart(),Rl._PreStageRender.call(e.stage,t,i,s),Rl._countEnd()}static _countStart(){var t;for(t in Rl._countDic)Rl._countDic[t]=0}static _countEnd(){Rl._i++,Rl._i>60&&(Rl.showCountInfo(),Rl._i=0)}static _addType(t){Rl._countDic[t]?Rl._countDic[t]+=1:Rl._countDic[t]=1}static showCountInfo(){var t;for(t in console.log("==================="),Rl._countDic)console.log("count:"+Rl._countDic[t]),Rl.showRenderTypeInfo(t,!0)}static enableQuickTest(){Rl.__init__(),br.prototype.render=Rl.prototype.render,Rl._PreStageRender=Sa.prototype.render,Sa.prototype.render=Rl.prototype._stageRender}}var Al,Il,Ml,Bl,Ll,Pl;Rl.showedDic={},Rl._rendertypeToStrDic={},Rl._typeToNameDic={},Rl._countDic={},Rl._i=0,t.RenderClearFlag=void 0,(Al=t.RenderClearFlag||(t.RenderClearFlag={}))[Al.Nothing=0]="Nothing",Al[Al.Color=1]="Color",Al[Al.Depth=2]="Depth",Al[Al.Stencil=4]="Stencil",t.RenderDrawMode=void 0,(Il=t.RenderDrawMode||(t.RenderDrawMode={}))[Il.TRIANGLES=0]="TRIANGLES",Il[Il.POINTS=1]="POINTS",Il[Il.LINES=2]="LINES",t.RenderIndexMode=void 0,(Ml=t.RenderIndexMode||(t.RenderIndexMode={}))[Ml.UNSIGNED_BYTE=0]="UNSIGNED_BYTE",Ml[Ml.UNSIGNED_SHORT=1]="UNSIGNED_SHORT",Ml[Ml.UNSIGNED_INT=2]="UNSIGNED_INT",t.RenderStateType=void 0,(Bl=t.RenderStateType||(t.RenderStateType={}))[Bl.DepthTest=0]="DepthTest",Bl[Bl.DepthMask=1]="DepthMask",Bl[Bl.DepthFunc=2]="DepthFunc",Bl[Bl.StencilTest=3]="StencilTest",Bl[Bl.StencilMask=4]="StencilMask",Bl[Bl.StencilFunc=5]="StencilFunc",Bl[Bl.StencilOp=6]="StencilOp",Bl[Bl.BlendType=7]="BlendType",Bl[Bl.BlendEquation=8]="BlendEquation",Bl[Bl.BlendEquationSeparate=9]="BlendEquationSeparate",Bl[Bl.BlendFunc=10]="BlendFunc",Bl[Bl.BlendFuncSeperate=11]="BlendFuncSeperate",Bl[Bl.CullFace=12]="CullFace",Bl[Bl.FrontFace=13]="FrontFace",t.TextureCompareMode=void 0,(Ll=t.TextureCompareMode||(t.TextureCompareMode={}))[Ll.None=0]="None",Ll[Ll.LEQUAL=1]="LEQUAL",Ll[Ll.GEQUAL=2]="GEQUAL",Ll[Ll.LESS=3]="LESS",Ll[Ll.GREATER=4]="GREATER",Ll[Ll.EQUAL=5]="EQUAL",Ll[Ll.NOTEQUAL=6]="NOTEQUAL",Ll[Ll.ALWAYS=7]="ALWAYS",Ll[Ll.NEVER=8]="NEVER",t.TextureDecodeFormat=void 0,(Pl=t.TextureDecodeFormat||(t.TextureDecodeFormat={}))[Pl.Normal=0]="Normal",Pl[Pl.RGBM=1]="RGBM";class Nl{static glslAttributeString(t){let e="";for(const i in t){let s=Ol(t[i][1]);""!=s&&(e=`${e}attribute ${s} ${i};\n`)}return e}static glslUniformString(t,e){if(e){let e="",i="";for(const s in t)if("object"==typeof t[s]){let i=t[s];e+=`uniform ${s} {\n`;for(const t in i){let s=Ol(i[t]);""!=s&&(e+=`${s} ${t};\n`)}e+="};\n"}else{let e=Ol(t[s]);""!=e&&(i+=`uniform ${e} ${s};\n`)}return e+i}{let e="";for(const i in t)if("object"==typeof t[i]){let s=t[i];for(const t in s){let i=Ol(s[t]);""!=i&&(e+=`uniform ${i} ${t};\n`)}}else{let s=Ol(t[i]);""!=s&&(e+=`uniform ${s} ${i};\n`)}return e}}static GLShaderLanguageProcess3D(e,i,s,r,a){var n,o,h=_.lightClusterCount,u={},d="";let c=_._uniformBlock,p=Nl.glslAttributeString(i),f=Nl.glslUniformString(s,c);l.renderEngine.getParams(t.RenderParams.SHADER_CAPAILITY_LEVEL)>30?(e.push("GRAPHICS_API_GLES3"),n=`#version 300 es\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n    precision highp sampler2DArray;\n    precision highp sampler3D;\n#else\n    precision mediump float;\n    precision mediump int;\n    precision mediump sampler2DArray;\n    precision mediump sampler3D;\n#endif\nlayout(std140, column_major) uniform;\n#define attribute in\n#define varying out\n#define textureCube texture\n#define texture2D texture\n${p}\n${f}\n`,o=`#version 300 es\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n    precision highp sampler2DArray;\n\tprecision highp sampler3D;\n#else\n    precision mediump float;\n    precision mediump int;\n    precision mediump sampler2DArray;\n\tprecision mediump sampler3D;\n#endif\nlayout(std140, column_major) uniform;\n#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define gl_FragDepthEXT gl_FragDepth\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n${f}`):(n=`#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\n${p}\n${f}`,o=`#ifdef GL_EXT_shader_texture_lod\n    #extension GL_EXT_shader_texture_lod : enable\n#endif\n\n#ifdef GL_OES_standard_derivatives\n\t#extension GL_OES_standard_derivatives : enable \n#endif\n\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\n\n#if !defined(GL_EXT_shader_texture_lod)\n    #define texture1DLodEXT texture1D\n    #define texture2DLodEXT texture2D\n    #define texture2DProjLodEXT texture2DProj\n    #define texture3DLodEXT texture3D\n    #define textureCubeLodEXT textureCube\n#endif\n${f}`),d+="#define MAX_LIGHT_COUNT "+_.maxLightCount+"\n",d+="#define MAX_LIGHT_COUNT_PER_CLUSTER "+_._maxAreaLightCountPerClusterAverage+"\n",d+="#define CLUSTER_X_COUNT "+h.x+"\n",d+="#define CLUSTER_Y_COUNT "+h.y+"\n",d+="#define CLUSTER_Z_COUNT "+h.z+"\n",d+="#define MORPH_MAX_COUNT "+_.maxMorphTargetCount+"\n",d+="#define SHADER_CAPAILITY_LEVEL "+l.renderEngine.getParams(t.RenderParams.SHADER_CAPAILITY_LEVEL)+"\n";for(var g=0,m=e.length;g<m;g++){var y=e[g];d+="#define "+y+"\n",u[y]=!0}var T=r.toscript(u,[]),x="";0==T[0].indexOf("#version")&&(x=T[0]+"\n",T.shift());var v=a.toscript(u,[]),S="";return 0==v[0].indexOf("#version")&&(S=v[0]+"\n",v.shift()),{vs:x+n+d+T.join("\n"),fs:S+o+d+v.join("\n")}}}function Ol(e){switch(e){case t.ShaderDataType.Int:return"int";case t.ShaderDataType.Bool:return"bool";case t.ShaderDataType.Float:return"float";case t.ShaderDataType.Vector2:return"vec2";case t.ShaderDataType.Vector3:return"vec3";case t.ShaderDataType.Vector4:case t.ShaderDataType.Color:return"vec4";case t.ShaderDataType.Matrix4x4:return"mat4";case t.ShaderDataType.Matrix3x3:return"mat3";case t.ShaderDataType.Texture2D:return"sampler2D";case t.ShaderDataType.TextureCube:return"samplerCube";case t.ShaderDataType.Texture2DArray:return l.renderEngine.getCapable(t.RenderCapable.Texture3D)?"sampler2DArray":"";case t.ShaderDataType.Texture3D:return l.renderEngine.getCapable(t.RenderCapable.Texture3D)?"sampler3D":"";default:return""}}class Fl{constructor(){this.onID=Fl.pointID++,this.textureID=-1}}Fl.pointID=0;class Ul{constructor(t,e,i,s){this.minDepth=0,this.maxDepth=1,this.x=null!=t?t:0,this.y=null!=e?e:0,this.width=null!=i?i:0,this.height=null!=s?s:0}project(t,e,i){d.transformV3ToV4(t,e,i);var s=i.x,r=i.y,a=i.z,n=i.w;1!==n&&(s/=n,r/=n,a/=n),i.x=.5*(s+1)*this.width+this.x,i.y=.5*(1-r)*this.height+this.y,i.z=a*(this.maxDepth-this.minDepth)+this.minDepth}unprojectFromMat(t,e,i){var s=e.elements;i.x=(t.x-this.x)/this.width*2-1,i.y=-((t.y-this.y)/this.height*2-1),i.z=(t.z-this.minDepth)/(this.maxDepth-this.minDepth);var r=i.x*s[3]+i.y*s[7]+i.z*s[11]+s[15];d.transformV3ToV3(i,e,i),1!==r&&(i.x=i.x/r,i.y=i.y/r,i.z=i.z/r)}unprojectFromWVP(t,e,i,s,r){Ke.multiply(e,i,kl),s&&Ke.multiply(kl,s,kl),kl.invert(kl),this.unprojectFromMat(t,kl,r)}set(t,e,i,s){this.x=t,this.y=e,this.width=i,this.height=s}cloneTo(t){t.x=this.x,t.y=this.y,t.width=this.width,t.height=this.height,t.minDepth=this.minDepth,t.maxDepth=this.maxDepth}}Ul._tempViewport=new Ul(0,0,0,0);const kl=new Ke;var Gl,Vl;t.BaseRender2DType=void 0,(Gl=t.BaseRender2DType||(t.BaseRender2DType={}))[Gl.baseRenderNode=0]="baseRenderNode",Gl[Gl.spine=1]="spine",Gl[Gl.particle=2]="particle",Gl[Gl.spineSimple=3]="spineSimple",t.Render2DOrderMode=void 0,(Vl=t.Render2DOrderMode||(t.Render2DOrderMode={}))[Vl.elementIndex=0]="elementIndex",Vl[Vl.ysort=1]="ysort";class Hl extends Vt{_getcommonUniformMap(){return["sprite2D"]}_getRect(){return null}_transformChange(){}get sharedMaterial(){return this._materials[0]}set sharedMaterial(t){var e=this._materials[0];e!==t&&(this._materials[0]=t,this._changeMaterialReference(e,t),this._renderElements[0]&&this._setRenderElement2DMaterial(this._renderElements[0],t))}_setRenderElement2DMaterial(t,e){t.subShader=e._shader.getSubShaderAt(0),t.materialShaderData=e._shaderValues}_changeMaterialReference(t,e){t&&t._removeReference(),e&&e._addReference()}constructor(){super(),this._renderType=t.BaseRender2DType.baseRenderNode,this._renderUpdateMask=0,this._layer=0,this._renderid=Hl._uniqueIDCounter++,this._spriteShaderData=l.renderDeviceFactory.createShaderData(null),this._renderType=t.BaseRender2DType.baseRenderNode,this._ordingMode=t.Render2DOrderMode.elementIndex,this._layer=1}_onEnable(){super._onEnable(),this.owner&&(this.owner.renderNode2D=this)}_onDisable(){this.owner&&(this.owner.renderNode2D=null)}_onDestroy(){for(var t=0,e=this._materials.length;t<e;t++){let e=this._materials[t];e&&!e.destroyed&&e._removeReference()}this._spriteShaderData.destroy(),this.owner=null}clear(){this._renderElements.length=0}}Hl._uniqueIDCounter=0;class zl{static getVertexDeclaration(t,e=!0){let i=[];for(let l=0,o=t.length;l<o;l++){let o=t[l],h=zl._vertexDeclarationMap[o+(e?"_0":"_1")];if(!h){var s=o.split(","),r=0,a=[];for(let t=0,i=s.length;t<i;t++){var n;switch(s[l]){case"POSITION":n=new Jt(r,Kt.Vector3,hi.MESH_POSITION0),r+=8;break;case"COLOR":n=new Jt(r,Kt.Vector4,hi.MESH_COLOR0),r+=16;break;case"UV":n=new Jt(r,Kt.Vector2,hi.MESH_TEXTURECOORDINATE0),r+=8;break;case"BLENDWEIGHT":n=new Jt(r,Kt.Vector4,hi.MESH_BLENDWEIGHT0),r+=16;break;case"BLENDINDICES":e?(n=new Jt(r,Kt.Vector4,hi.MESH_BLENDINDICES0),r+=16):(n=new Jt(r,Kt.Byte4,hi.MESH_BLENDINDICES0),r+=4);break;default:throw"VertexMesh: unknown vertex flag."}a.push(n)}h=new Zt(r,a),zl._vertexDeclarationMap[o+(e?"_0":"_1")]=h,i.push(h)}}return i}}zl._vertexDeclarationMap={};class Wl extends C{static get defaultTexture(){return this._defaultTexture}static __init__(){l.renderEngine.getCapable(t.RenderCapable.Texture3D)&&(this._defaultTexture=new Wl(1,1,1,t.TextureFormat.R8G8B8A8,!1,!1),this._defaultTexture.lock=!0,this._defaultTexture.setPixelsData(new Uint8Array([255,255,255,255])))}constructor(e,i,s,r,a=!0,n=!1){super(e,i,r),this._dimension=t.TextureDimension.Tex3D,this.depth=s,this._gammaSpace=n;let o=l.textureContext;this._texture=o.createTexture3DInternal(this._dimension,e,i,s,r,a,n,!1)}setPixelsData(t){let e=this._texture;l.textureContext.setTexture3DPixelsData(e,t,this.depth,!1,!1)}setSubPixelsData(t,e,i,s,r,a,n,o,h){let u=this._texture;l.textureContext.setTexture3DSubPixelsData(u,n,o,h,t,e,i,s,r,a,!1,!1)}}class Yl{static getRT(e,i){return i|=0,(e|=0)>=1e4&&console.error("getRT error! w too big"),new pt(e,i,t.RenderTargetFormat.R8G8B8A8,t.RenderTargetFormat.None)}static releaseRT(t){t.destroy()}}Yl.dict={};class Xl{static init(){if(!Xl.lookup){Xl.lookup=new Uint8Array(256);for(var t=0;t<Xl.chars.length;t++)Xl.lookup[Xl.chars.charCodeAt(t)]=t}}static isBase64String(t){return Xl.reg.test(t)}static encode(t){var e,i=new Uint8Array(t),s=i.length,r="";for(e=0;e<s;e+=3)r+=Xl.chars[i[e]>>2],r+=Xl.chars[(3&i[e])<<4|i[e+1]>>4],r+=Xl.chars[(15&i[e+1])<<2|i[e+2]>>6],r+=Xl.chars[63&i[e+2]];return s%3==2?r=r.substring(0,r.length-1)+"=":s%3==1&&(r=r.substring(0,r.length-2)+"=="),r}static decode(t){Xl.init();var e,i,s,r,a,n=.75*t.length,l=t.length,o=0;"="===t[t.length-1]&&(n--,"="===t[t.length-2]&&n--);var h=new ArrayBuffer(n),u=new Uint8Array(h);for(e=0;e<l;e+=4)i=Xl.lookup[t.charCodeAt(e)],s=Xl.lookup[t.charCodeAt(e+1)],r=Xl.lookup[t.charCodeAt(e+2)],a=Xl.lookup[t.charCodeAt(e+3)],o+1>n||(u[o++]=i<<2|s>>4,o+1>n||(u[o++]=(15&s)<<4|r>>2,o+1>n||(u[o++]=(3&r)<<6|63&a)));return h}}Xl.chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Xl.reg=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s]*?)\s*$/i,Xl.reghead=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,/i,Xl.lookup=null,ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=function(t,e){var i=new Uint8Array(this,t,e-t),s=new Uint8Array(i.length);return s.set(i),s.buffer}),Float32Array.prototype.slice||(Float32Array.prototype.slice=function(){for(var t=this.length,e=new Float32Array(this.length),i=0;i<t;i++)e[i]=this[i];return e}),Uint16Array.prototype.slice||(Uint16Array.prototype.slice=function(...t){var e,i,s;if(0===t.length)for(e=this.length,i=new Uint16Array(e),s=0;s<e;s++)i[s]=this[s];else if(2===t.length){var r=t[0],a=t[1];if(a>r)for(e=a-r,i=new Uint16Array(e),s=r;s<a;s++)i[s-r]=this[s];else i=new Uint16Array(0)}return i}),Uint8Array.prototype.slice||(Uint8Array.prototype.slice=function(){for(var t=this.length,e=new Uint8Array(this.length),i=0;i<t;i++)e[i]=this[i];return e});const jl=new F,ql=new s;class $l{contains(t,e,i){return!!$l._isHitGraphic(t,e,i,this._hit)&&!$l._isHitGraphic(t,e,i,this._unHit)}static _isHitGraphic(t,e,i,s){if(!s)return!1;let r=s.cmds;if(0==r.length)return!1;let a=r.length;for(let s=0;s<a;s++){let a=r[s];if(a){if("Translate"===a.cmdID)t-=a.tx,e-=a.ty;if($l._isHitCmd(t,e,i,a))return!0}}return!1}static _isHitCmd(t,e,i,s){if(!s)return!1;var r=!1;switch(s.cmdID){case"DrawRect":s.percent?jl.setTo(s.x*i.width,s.y*i.height,s.width*i.width,s.height*i.height):jl.setTo(s.x,s.y,s.width,s.height),r=jl.contains(t,e);break;case"DrawCircle":let a=s.radius;s.percent?(t-=s.x*i.width,e-=s.y*i.height,a*=i.width):(t-=s.x,e-=s.y),r=t*t+e*e<a*a;break;case"DrawPoly":t-=s.x,e-=s.y,r=$l._ptInPolygon(t,e,s.points)}return r}static _ptInPolygon(t,e,i){var s=ql;s.setTo(t,e);var r,a,n,l,o,h=0;o=i.length;for(var u=0;u<o;u+=2){if(r=i[u],a=i[u+1],n=i[(u+2)%o],a!=(l=i[(u+3)%o]))if(!(s.y<Math.min(a,l)))if(!(s.y>=Math.max(a,l)))(s.y-a)*(n-r)/(l-a)+r>s.x&&h++}return h%2==1}get hit(){return this._hit||(this._hit=new gr),this._hit}set hit(t){this._hit=t}get unHit(){return this._unHit||(this._unHit=new gr),this._unHit}set unHit(t){this._unHit=t}onAfterDeserialize(){n.isPlaying&&(this._hitCmds&&(this.hit.cmds=this._hitCmds,delete this._hitCmds),this._unHitCmds&&(this.unHit.cmds=this._unHitCmds,delete this._unHitCmds))}}Ot.regClass("HitArea",$l);class Kl{static enable(){Kl._logdiv||(Kl._logdiv=A.createElement("div"),Kl._logdiv.style.cssText="border:white;padding:4px;overflow-y:auto;z-index:1000000;background:rgba(100,100,100,0.6);color:white;position: absolute;left:0px;top:0px;width:50%;height:50%;",A.document.body.appendChild(Kl._logdiv),Kl._btn=A.createElement("button"),Kl._btn.innerText="Hide",Kl._btn.style.cssText="z-index:1000001;position: absolute;left:10px;top:10px;",Kl._btn.onclick=Kl.toggle,A.document.body.appendChild(Kl._btn))}static toggle(){var t=Kl._logdiv.style;""===t.display?(Kl._btn.innerText="Show",t.display="none"):(Kl._btn.innerText="Hide",t.display="")}static print(t){Kl._logdiv&&(Kl._count>=Kl.maxCount&&Kl.clear(),Kl._count++,Kl._logdiv.innerText+=t+"\n",Kl.autoScrollToBottom&&Kl._logdiv.scrollHeight-Kl._logdiv.scrollTop-Kl._logdiv.clientHeight<50&&(Kl._logdiv.scrollTop=Kl._logdiv.scrollHeight))}static clear(){Kl._logdiv.innerText="",Kl._count=0}}Kl._count=0,Kl.maxCount=50,Kl.autoScrollToBottom=!0;class Ql{constructor(t,e,i,s){this.scale=1,this.datas=new Array(300),this.datapos=0,this.id=t,this.color=e,this.name=i,this.scale=s}addData(t){this.datas[this.datapos]=t,this.datapos++,this.datapos%=300}}class Zl extends br{constructor(){super(),this.datas=[],this.xdata=new Array(Zl.DATANUM),this.ydata=new Array(Zl.DATANUM),this.hud_width=800,this.hud_height=200,this.gMinV=0,this.gMaxV=100,this.textSpace=40,this.sttm=0,Zl.inst=this,this._renderType|=re.CUSTOM,this._setCustomRender(),this.addDataDef(0,16777215,"frame",1),this.addDataDef(1,65280,"update",1),this.addDataDef(2,16711680,"flush",1),Zl._now=performance?performance.now.bind(performance):Date.now}now(){return Zl._now()}start(){this.sttm=Zl._now()}end(t){var e=Zl._now()-this.sttm;this.updateValue(t,e)}config(t,e){this.hud_width=t,this.hud_height=e}addDataDef(t,e,i,s){this.datas[t]=new Ql(t,e,i,s)}updateValue(t,e){this.datas[t].addData(e)}v2y(t){return this._y+this.hud_height*(1-(t-this.gMinV)/this.gMaxV)}drawHLine(t,e,i,s){var r=this._x,a=this.v2y(e);t.fillText(s,r,a-6,null,"green",null),r+=this.textSpace,t.fillStyle=i,t.fillRect(r,a,this._x+this.hud_width,1,null)}customRender(t,e,i){var s=performance.now();Zl._lastTm<=0&&(Zl._lastTm=s),this.updateValue(0,s-Zl._lastTm),Zl._lastTm=s,t.save(),t.fillRect(this._x,this._y,this.hud_width,this.hud_height+4,"#000000cc"),t.globalAlpha=.9,this.drawHLine(t,0,"green","    0"),this.drawHLine(t,10,"green","  10"),this.drawHLine(t,16.667,"red"," "),this.drawHLine(t,20,"green","50|20"),this.drawHLine(t,33.334,"yellow",""),this.drawHLine(t,16.667*3,"yellow",""),this.drawHLine(t,66.668,"yellow",""),this.drawHLine(t,50,"green","20|50"),this.drawHLine(t,100,"green","10|100");for(var r=0,a=this.datas.length;r<a;r++){var n=this.datas[r];if(n){var l=n.datas.length,o=(this.hud_width-this.textSpace)/l,h=n.datapos,u=this._x+this.textSpace;t.fillStyle=n.color;for(var d=l;h<d;h++){var c=this.v2y(n.datas[h]*n.scale);t.fillRect(u,c,o,this.hud_height+this._y-c,null),u+=o}for(h=0;h<n.datapos;h++)c=this.v2y(n.datas[h]*n.scale),t.fillRect(u,c,o,this.hud_height+this._y-c,null),u+=o}}t.restore()}}Zl._lastTm=0,Zl._now=null,Zl.DATANUM=300,Zl.drawTexTm=0;class Jl{constructor(){this.maxCount=1e3}getCacheList(){return i.getPoolBySign(this.sign)}tryDispose(t){var e;(e=i.getPoolBySign(this.sign)).length>this.maxCount&&e.splice(this.maxCount,e.length-this.maxCount)}static addPoolCacheManager(t,e=100){var i;(i=new Jl).sign=t,i.maxCount=e,cr.regCacheByFunction(i.tryDispose.bind(i),i.getCacheList.bind(i))}}class to extends v{constructor(){super(...arguments),this._tweenDic={},this._tweenDataList=[],this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._gidIndex=0,this._firstTweenDic={},this._startTimeSort=!1,this._endTimeSort=!1,this._loopKey=!1,this.scale=1,this._frameRate=60,this._frameIndex=0,this._total=0}static to(t,e,i,s=null,r=0){return(new to).to(t,e,i,s,r)}static from(t,e,i,s=null,r=0){return(new to).from(t,e,i,s,r)}to(t,e,i,s=null,r=0){return this._create(t,e,i,s,r,!0)}from(t,e,i,s=null,r=0){return this._create(t,e,i,s,r,!1)}_create(t,e,s,r,a,n){var l=i.getItemByClass("tweenData",eo);return l.isTo=n,l.type=0,l.target=t,l.duration=s,l.data=e,l.startTime=this._startTime+a,l.endTime=l.startTime+l.duration,l.ease=r,this._startTime=Math.max(l.endTime,this._startTime),this._tweenDataList.push(l),this._startTimeSort=!0,this._endTimeSort=!0,this}addLabel(t,e){var s=i.getItemByClass("tweenData",eo);return s.type=1,s.data=t,s.endTime=s.startTime=this._startTime+e,this._labelDic||(this._labelDic={}),this._labelDic[t]=s,this._tweenDataList.push(s),this}removeLabel(t){if(this._labelDic&&this._labelDic[t]){var e=this._labelDic[t];if(e){var i=this._tweenDataList.indexOf(e);i>-1&&this._tweenDataList.splice(i,1)}delete this._labelDic[t]}}gotoTime(t){if(null!=this._tweenDataList&&0!=this._tweenDataList.length){var e,s,r,a;for(var n in this._firstTweenDic)if(s=this._firstTweenDic[n])for(var l in s)l in s.diyTarget&&(s.diyTarget[l]=s[l]);for(n in this._tweenDic)(e=this._tweenDic[n]).clear(),delete this._tweenDic[n];if(this._index=0,this._gidIndex=0,this._currTime=t,this._lastTime=A.now(),null==this._endTweenDataList||this._endTimeSort){function c(t,e){return t.endTime>e.endTime?1:t.endTime<e.endTime?-1:0}this._endTimeSort=!1,this._endTweenDataList=r=this._tweenDataList.concat(),r.sort(c)}else r=this._endTweenDataList;for(var o=0,h=r.length;o<h;o++)if(0==(a=r[o]).type){if(!(t>=a.endTime))break;this._index=Math.max(this._index,o+1);var u=a.data;if(a.isTo)for(var d in u)a.target[d]=u[d]}for(o=0,h=this._tweenDataList.length;o<h;o++)0==(a=this._tweenDataList[o]).type&&t>=a.startTime&&t<a.endTime&&(this._index=Math.max(this._index,o+1),this._gidIndex++,(e=i.getItemByClass("tween",Er))._create(a.target,a.data,a.duration,a.ease,St.create(this,this._animComplete,[this._gidIndex]),0,!1,a.isTo,!0,!1),e.setStartTime(this._currTime-(t-a.startTime)),e._updateEase(this._currTime),e.gid=this._gidIndex,this._tweenDic[this._gidIndex]=e)}}gotoLabel(t){if(null!=this._labelDic){var e=this._labelDic[t];e&&this.gotoTime(e.startTime)}}pause(){e.timer.clear(this,this._update)}resume(){this.play(this._currTime,this._loopKey)}play(t=0,i=!1){if(this._tweenDataList){if(this._startTimeSort){function u(t,e){return t.startTime>e.startTime?1:t.startTime<e.startTime?-1:0}this._startTimeSort=!1,this._tweenDataList.sort(u);for(var s=0,r=this._tweenDataList.length;s<r;s++){var a=this._tweenDataList[s];if(null!=a&&0==a.type){var n=a.target,l=n.$_GID||(n.$_GID=P.getGID()),o=null;for(var h in null==this._firstTweenDic[l]?((o={}).diyTarget=n,this._firstTweenDic[l]=o):o=this._firstTweenDic[l],a.data)null==o[h]&&(o[h]=n[h])}}}"string"==typeof t?this.gotoLabel(t):this.gotoTime(t),this._loopKey=i,this._lastTime=A.now(),e.timer.frameLoop(1,this,this._update)}}_update(){if(this._currTime>=this._startTime){if(!this._loopKey){for(var t in this._tweenDic)(e=this._tweenDic[t]).complete();return this.pause(),void this._complete()}if(this._complete(),!this._tweenDataList)return;this.gotoTime(0)}var e,s=A.now(),a=s-this._lastTime,n=this._currTime+=a*this.scale;for(t in this._lastTime=s,this._tweenDic)(e=this._tweenDic[t])._updateEase(n);if(0!=this._tweenDataList.length&&this._index<this._tweenDataList.length){var l=this._tweenDataList[this._index];n>=l.startTime&&(this._index++,0==l.type?(this._gidIndex++,(e=i.getItemByClass("tween",Er))._create(l.target,l.data,l.duration,l.ease,St.create(this,this._animComplete,[this._gidIndex]),0,!1,l.isTo,!0,!1),e.setStartTime(n),e.gid=this._gidIndex,this._tweenDic[this._gidIndex]=e,e._updateEase(n)):this.event(r.LABEL,l.data))}}_animComplete(t){this._tweenDic[t]&&delete this._tweenDic[t]}_complete(){this.event(r.COMPLETE)}get index(){return this._frameIndex}set index(t){this._frameIndex=t,this.gotoTime(this._frameIndex/this._frameRate*1e3)}get total(){return this._total=Math.floor(this._startTime/1e3*this._frameRate),this._total}reset(){var t,i,s;if(this._labelDic)for(t in this._labelDic)delete this._labelDic[t];for(t in this._tweenDic)this._tweenDic[t].clear(),delete this._tweenDic[t];for(t in this._firstTweenDic)delete this._firstTweenDic[t];if(this._endTweenDataList=null,this._tweenDataList&&this._tweenDataList.length)for(s=this._tweenDataList.length,i=0;i<s;i++)this._tweenDataList[i]&&this._tweenDataList[i].destroy();this._tweenDataList.length=0,this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._gidIndex=0,this.scale=1,e.timer.clear(this,this._update)}destroy(){this.reset(),this._labelDic=null,this._tweenDic=null,this._tweenDataList=null,this._firstTweenDic=null}}class eo{constructor(){this.type=0,this.isTo=!0}destroy(){this.target=null,this.ease=null,this.data=null,this.isTo=!0,this.type=0,i.recover("tweenData",this)}}class io{static create(t,e){var i;let s;return"undefined"!=typeof document&&(s=null===(i=document.currentScript)||void 0===i?void 0:i.src,s&&(s=s.substring(0,s.replace(/[?#].*/,"").lastIndexOf("/")+1))),()=>{let i={};return null!=io.instantiateWasm&&(i.instantiateWasm=function(t,i){return io.instantiateWasm(e,t).then((t=>(i(t.instance),t)))}),i.locateFile=function(t,i){return e=null!=io.locateFile?io.locateFile(t,i,s):i+t},t(i)}}}io.Memory="undefined"!=typeof WebAssembly?WebAssembly.Memory:null;class so{static begin(t){}static end(t){}}class ro{}function ao(t){so.begin(t)}function no(t){so.end(t)}function lo(){}window.PerformanceDefine=ro,window.PERF_BEGIN=ao,window.PERF_BEGIN=no,window.PERF_FRAMECLEAR=lo;class oo{constructor(t,e,i,s,r,a){this.destroyed=!1,this.sn=t,this.cluster=e,this.index=i,this.size=s,this.alignedSize=r,this.offset=r*i,this.user=a,this.uploadNum=0,this.moved=!1}needUpload(){this.uploadNum++,this.cluster.needUpload[this.index]=!0}destroy(){return this.destroyed?(console.warn("UniformBufferBlock: object alreay destroyed!"),!1):(this.cluster=null,this.user=null,this.destroyed=!0,!0)}}class ho{constructor(t,e,i){this.sn=0,this.needUpload=[],this.destroyed=!1,this.blocks=[],this.expand=10,this.manager=i,this.blockSize=t,this.blockNum=e,this.totalSize=t*e,this.data=new ArrayBuffer(this.totalSize),this.move=new Uint8Array(this.blockSize),this.buffer=this.manager.createGPUBuffer(this.totalSize),this.needUpload.length=this.blockNum,this.needUpload.fill(!1),this.manager.statisGPUMemory(this.totalSize)}get usedNum(){return this.blocks.length}_expandBuffer(){let t=this.blockNum;this.blockNum+=this.expand,this.blockNum>this.manager.clusterMaxBlock&&(this.blockNum=this.manager.clusterMaxBlock),t=this.blockNum-t,this.totalSize=this.blockSize*this.blockNum;const e=this.blockSize*this.expand;this.needUpload=this.needUpload.concat(new Array(t).fill(!1));const i=new ArrayBuffer(this.totalSize);new Uint8Array(i).set(new Uint8Array(this.data)),this.data=i,this.buffer=this.manager.createGPUBuffer(this.totalSize),this.manager.statisGPUMemory(e),this.blocks.forEach((t=>t&&t.user.notifyGPUBufferChange())),this.manager.renderContext.notifyGPUBufferChange()}_moveBlock(t){const e=this.blocks.length;if(t>=e)return;const i=new Uint8Array(this.data),s=this.blockSize;for(let r=t+1;r<e;r++){const t=r*s,e=t+s,a=t-s;i.copyWithin(a,t,e),this.needUpload[r-1]=this.needUpload[r],this.blocks[r-1]=this.blocks[r],this.blocks[r-1]&&(this.blocks[r-1].index--,this.blocks[r-1].offset-=s,this.blocks[r-1].user.notifyGPUBufferChange())}this.blocks.length--,this.manager.renderContext.notifyGPUBufferChange()}getBlock(t,e){const i=uo(t,this.manager.byteAlign);if(i!==this.blockSize)return console.warn("WebGPUBufferCluster: 获取内存块时, 长度错误!"),null;const s=this._getBlockWithExpand(),r=new oo(this.manager.snCounter++,this,s,t,i,e);return this.blocks[s]=r,r}freeBlock(t){const e=this.blocks.indexOf(t);return-1!==e&&(e===this.blocks.length-1?this.blocks.length--:(this.blocks[e]=null,this.needUpload[e]=!1),t.destroy(),!0)}upload(){let t=0,e=0,i=!1,s=-1,r=-1,a=0,n=0;for(let l=0,o=this.blocks.length;l<o;l++)this.needUpload[l]?(-1===s&&(s=l),r=l,i=!0,this.needUpload[l]=!1):i&&(a=s*this.blockSize,n=(r-s+1)*this.blockSize,this.manager.writeBuffer(this.buffer,this.data,a,n),t++,e+=n,s=-1,r=-1,i=!1);i&&(a=s*this.blockSize,n=(r-s+1)*this.blockSize,this.manager.writeBuffer(this.buffer,this.data,a,n),t++,e+=n),this.manager.uploadNum+=t,this.manager.uploadByte+=e,this.manager.statisUpload(t,e)}optimize(){for(let t=this.blocks.length-1;t>-1;t--){const e=this.blocks[t];if(e&&e.uploadNum>this.manager.uploadThreshold&&!e.moved&&t>0){const i=this.needUpload[t],s=this.blockSize,r=new Uint8Array(this.data);this.move.set(new Uint8Array(this.data,s*t,s));for(let e=t-1;e>=0;e--){const t=e*s,i=t+s,a=t+s;r.copyWithin(a,t,i),this.needUpload[e+1]=this.needUpload[e],this.blocks[e+1]=this.blocks[e],this.blocks[e+1]&&(this.blocks[e+1].index++,this.blocks[e+1].offset+=s,this.blocks[e+1].user.notifyGPUBufferChange())}r.set(this.move),this.needUpload[0]=i,e.index=0,e.offset=0,e.moved=!0,this.blocks[0]=e,this.blocks[0].user.notifyGPUBufferChange(),this.manager.renderContext.notifyGPUBufferChange(),this.manager.moveNum++;break}}}removeHole(){for(let t=this.blocks.length-1;t>-1;t--)if(!this.blocks[t]){this._moveBlock(t);break}}clear(t){this.blocks.forEach((t=>t&&t.destroy())),this.blocks.length=0,null!=t&&t>0&&t!==this.blockNum?(this.blockNum=t,this.totalSize=this.blockSize*this.blockNum,this.buffer=this.manager.createGPUBuffer(this.totalSize),this.data=new ArrayBuffer(this.totalSize)):(this.blockNum=0,this.totalSize=0,this.buffer=null,this.data=null),this.needUpload.length=this.blockNum,this.needUpload.fill(!1)}_getBlockWithExpand(){for(let t=this.blocks.length-1;t>-1;t--)if(!this.blocks[t])return t;return this.blocks.length<this.blockNum||this._expandBuffer(),this.blocks.length}destroy(){var t;return this.destroyed?(console.warn("UniformBufferCluster: object alreay destroyed!"),!1):(this.clear(),null!==(t=this.buffer.destroy)&&void 0!==t||this.buffer.destroy(),this.manager.statisGPUMemory(-this.totalSize),this.destroyed=!0,!0)}}function uo(t,e){return((t+e-1)/e|0)*e}class co{constructor(t,e){this.destroyed=!1,this.data=new ArrayBuffer(t),this.buffer=e.getBufferAlone(t),this.manager=e,this.size=t,this.alignedSize=uo(t,e.byteAlign)}upload(){const t=performance.now();this.manager.writeBuffer(this.buffer,this.data,0,this.size),this.manager.timeCostSum+=performance.now()-t,this.manager.timeCostCount++,this.manager.timeCostCount>100&&(this.manager.timeCostAvg=this.manager.timeCostSum/this.manager.timeCostCount*1e3|0,this.manager.timeCostSum=0,this.manager.timeCostCount=0),this.manager.uploadNum++,this.manager.uploadByte+=this.size,this.manager.statisUpload(1,this.size)}destroy(){var t;return this.destroyed?(console.warn("UniformBufferAlone: object alreay destroyed!"),!1):(this.data=null,null!==(t=this.buffer.destroy)&&void 0!==t||this.buffer.destroy(),this.manager.statisGPUMemory(-this.size),this.destroyed=!0,!0)}}class _o{constructor(t,e,i,s){this.destroyed=!1,this.name=t,this.strId="",this.items=new Map,this.itemNum=0,this.data=s,this.size=e,this.manager=i,this.needUpload=!1,i.useBigBuffer?(this.bufferBlock=i.getBlock(e,this),this.offset=this.bufferBlock.offset):this.bufferAlone=new co(e,i)}notifyGPUBufferChange(){const t=this.bufferBlock.offset-this.offset;this.offset=this.bufferBlock.offset,this.items.forEach((e=>{const i=_o._typeArray(e.type);e.view=new i(this.bufferBlock.cluster.data,e.view.byteOffset+t,e.size/i.BYTES_PER_ELEMENT)})),this.clearGPUBufferBind(),this.needUpload=!0}clearGPUBufferBind(){}addUniform(t,e,i,s,r,a,n,l){this.items.has(t)||(this.items.set(t,this._getUniformItem(e,_o._typeArray(i),i,s,r,a,n,l)),this.strId.length>0&&(this.strId+="|"),this.strId+=t,this.itemNum++)}setUniformData(t,e){const i=this.items.get(t);if(i)if(this.needUpload=!0,1==i.count)switch(i.type){case"int":case"float":i.view[0]=e;break;case"vec2":i.view[0]=e.x,i.view[1]=e.y;break;case"vec3":i.view[0]=e.x,i.view[1]=e.y,i.view[2]=e.z;break;case"vec4":i.view[0]=e.x,i.view[1]=e.y,i.view[2]=e.z,i.view[3]=e.w;break;case"mat3":for(let t=0;t<3;t++)i.view[4*t+0]=e.elements[3*t+0],i.view[4*t+1]=e.elements[3*t+1],i.view[4*t+2]=e.elements[3*t+2];break;case"mat4":i.view.set(e.elements)}else{const t=i.count*i.elements,s=i.size/i.count/i.view.BYTES_PER_ELEMENT;for(let r=0,a=0;r<t;r+=i.elements,a+=s)i.view.set(e.subarray(r,r+i.elements),a)}}setBool(t,e){const i=this.items.get(t);i&&(i.view[0]=e?1:0,this.needUpload=!0)}setBoolArray(t,e){const i=this.items.get(t);if(i){for(let t=0,s=Math.min(i.count,e.length);t<s;t++)i.view[t]=e[t]?1:0;this.needUpload=!0}}setInt(t,e){const i=this.items.get(t);i&&(i.view[0]=e,this.needUpload=!0)}setIntArray(t,e){const i=this.items.get(t);if(i){for(let t=0,s=Math.min(i.count,e.length);t<s;t++)i.view[t]=e[t];this.needUpload=!0}}setFloat(t,e){const i=this.items.get(t);i&&(i.view[0]=e,this.needUpload=!0)}setFloatArray(t,e){const i=this.items.get(t);if(i){for(let t=0,s=Math.min(i.count,e.length);t<s;t++)i.view[t]=e[t];this.needUpload=!0}}setVector2(t,e){const i=this.items.get(t);i&&(i.view[0]=e.x,i.view[1]=e.y,this.needUpload=!0)}setVector2Array(t,e){const i=this.items.get(t);if(i){for(let t=0,s=Math.min(i.count,e.length);t<s;t++)i.view[2*t+0]=e[t].x,i.view[2*t+1]=e[t].y;this.needUpload=!0}}setVector3(t,e){const i=this.items.get(t);i&&(i.view[0]=e.x,i.view[1]=e.y,i.view[2]=e.z,this.needUpload=!0)}setVector3Array(t,e){const i=this.items.get(t);if(i){for(let t=0,s=Math.min(i.count,e.length);t<s;t++)i.view[4*t+0]=e[t].x,i.view[4*t+1]=e[t].y,i.view[4*t+2]=e[t].z;this.needUpload=!0}}setVector4(t,e){const i=this.items.get(t);i&&(i.view[0]=e.x,i.view[1]=e.y,i.view[2]=e.z,i.view[3]=e.w,this.needUpload=!0)}setVector4Array(t,e){const i=this.items.get(t);if(i){for(let t=0,s=Math.min(i.count,e.length);t<s;t++)i.view[4*t+0]=e[t].x,i.view[4*t+1]=e[t].y,i.view[4*t+2]=e[t].z,i.view[4*t+3]=e[t].w;this.needUpload=!0}}setMatrix3x3(t,e){const i=this.items.get(t);if(i){for(let t=0;t<3;t++)i.view[4*t+0]=e.elements[3*t+0],i.view[4*t+1]=e.elements[3*t+1],i.view[4*t+2]=e.elements[3*t+2];this.needUpload=!0}}setMatrix3x3Array(t,e){const i=this.items.get(t);if(i){for(let t=0,s=Math.min(i.count,e.length);t<s;t++)for(let s=0;s<3;s++)i.view[16*t+4*s+0]=e[t].elements[3*s+0],i.view[16*t+4*s+1]=e[t].elements[3*s+1],i.view[16*t+4*s+2]=e[t].elements[3*s+2];this.needUpload=!0}}setMatrix4x4(t,e){const i=this.items.get(t);i&&(i.view.set(e.elements),this.needUpload=!0)}setMatrix4x4Array(t,e){const i=this.items.get(t);if(i){for(let t=0,s=Math.min(i.count,e.length);t<s;t++)i.view.set(e[t].elements,16*t);this.needUpload=!0}}setBuffer(t,e){this.setUniformData(t,e)}getUniform(t){return this.items.get(t)}hasUniform(t){return this.items.has(t)}isMe(t){return this.strId===t}upload(){this.needUpload&&(this.manager.useBigBuffer?this.bufferBlock.needUpload():this.bufferAlone.upload(),this.needUpload=!1)}clear(){this.manager.useBigBuffer?new Uint8Array(this.bufferBlock.cluster.data).fill(0,this.bufferBlock.offset,this.bufferBlock.offset+this.bufferBlock.size):new Uint8Array(this.bufferAlone.data).fill(0),this.strId="",this.items.clear(),this.itemNum=0,this.needUpload=!1}destroy(){return this.destroyed?(console.warn("UniformBufferUser: object alreay destroyed!"),!1):(this.manager.useBigBuffer?this.manager.freeBlock(this.bufferBlock):this.bufferAlone.destroy(),this.destroyed=!0,!0)}_getUniformItem(t,e,i,s,r,a,n,l){let o;return o=this.manager.useBigBuffer?new e(this.bufferBlock.cluster.data,this.bufferBlock.offset+s,a/e.BYTES_PER_ELEMENT):new e(this.bufferAlone.data,s,a/e.BYTES_PER_ELEMENT),{name:t,view:o,type:i,align:r,size:a,elements:n,count:l}}static _typeArray(t){return"int"===t?Int32Array:Float32Array}}class po extends v{get input(){return this._input}get output(){return this._output}get connected(){return this._connected}get endian(){return this._endian}set endian(t){this._endian=t,null!=this._input&&(this._input.endian=t),null!=this._output&&(this._output.endian=t)}constructor(t=null,e=0,i=null,s=null,r=!1){super(),this.disableInput=!1,this.protocols=[],this._byteClass=i||W,this.protocols=s,this.endian=po.BIG_ENDIAN,t&&e>0&&e<65535&&this.connect(t,e,r)}connect(t,e,i=!1){this.connectByUrl(`${i?"wss":"ws"}://${t}:${e}`)}connectByUrl(t){null!=this._socket&&this.close(),this._socket&&this.cleanSocket(),this.protocols&&0!=this.protocols.length?this._socket=new A.window.WebSocket(t,this.protocols):this._socket=new A.window.WebSocket(t),this._socket.binaryType="arraybuffer",this._output=new this._byteClass,this._output.endian=this.endian,this._input=new this._byteClass,this._input.endian=this.endian,this._addInputPosition=0,this._socket.onopen=t=>{this._onOpen(t)},this._socket.onmessage=t=>{this._onMessage(t)},this._socket.onclose=t=>{this._onClose(t)},this._socket.onerror=t=>{this._onError(t)}}cleanSocket(){this.close(),this._connected=!1,this._socket.onopen=null,this._socket.onmessage=null,this._socket.onclose=null,this._socket.onerror=null,this._socket=null}close(){if(null!=this._socket)try{this._socket.close()}catch(t){}}_onOpen(t){this._connected=!0,this.event(r.OPEN,t)}_onMessage(t){if(t&&t.data){var e=t.data;if(this.disableInput&&e)this.event(r.MESSAGE,e);else{this._input.length>0&&this._input.bytesAvailable<1&&(this._input.clear(),this._addInputPosition=0);var i=this._input.pos;!this._addInputPosition&&(this._addInputPosition=0),this._input.pos=this._addInputPosition,e&&("string"==typeof e?this._input.writeUTFBytes(e):this._input.writeArrayBuffer(e),this._addInputPosition=this._input.pos,this._input.pos=i),this.event(r.MESSAGE,e)}}}_onClose(t){this._connected=!1,this.event(r.CLOSE,t)}_onError(t){this.event(r.ERROR,t)}send(t){this._socket.send(t)}flush(){if(this._output&&this._output.length>0){var t;try{this._socket&&this._socket.send(this._output.__getBuffer().slice(0,this._output.length))}catch(e){t=e}this._output.endian=this.endian,this._output.clear(),t&&this.event(r.ERROR,t)}}}po.LITTLE_ENDIAN="littleEndian",po.BIG_ENDIAN="bigEndian";class fo{constructor(){}static getHash(t,e,i,s=9191891){var r,a=0;for(r=0;r<i;r++)a=(2*a+t[e+r])%s;return a}static isSame(t,e,i,s,r,a){if(i!=a)return!1;var n,l;for(l=i,n=0;n<l;n++)if(t[e+n]!=s[r+n])return!1;return!0}}class go{static get instance(){return go._instance||(go._instance=new go)}static IsJsonbin(t){if(t.byteLength<5)return!1;const e=new Uint32Array(t,0,4)[0];return e==go.ISJSONBIN||e==go.ISJSONBIN2||e==go.ISJSONBIN3}static parse(t){var e=new Int32Array(t,0,4);if(e[0]!==go.ISJSONBIN&&e[0]!==go.ISJSONBIN2){var i=new W;i.writeArrayBuffer(t),i.pos=0;var s=i.readUTFBytes();return JSON.parse(s)}return(new go).read(t)}static parsePack(t){var e=(new go).read(t);for(var i in e)Bt.cacheRes(i,e[i]);return e}constructor(){}_readArray(t,e,i,s,r){var a,n=[];n.length=i,e>=0&&(a=t.pos,t.pos=e);for(var l=0;l<i;l++)n[l]=this._readOne({},t,null,t.readUint8(),r);return e>=0&&(t.pos=a),n}_getLen(t){let e=t.readUint8();return 128&e?t.readUint8()|(-129&e)<<8:e}static _toLargeNumber(t,e){let i=e.toString(16);if(i.length<7)for(let t=i.length;t<7;t++)i="0"+i;return parseInt(t.toString(16)+""+i,16)}static readInt8Array(t,e,i){var s=e+i;s=s>t._length?t._length:s;var r=new Int8Array(t._d_.buffer.slice(e,s));return t._pos_=s,r}_readOne(t,e,i,s,r){let a,n;switch(s){case go.NULL:n=null;break;case go.NUM8:n=e.readByte();break;case go.NUM16:n=e.readInt16();break;case go.NUM32:n=e.readInt32();break;case go.NUM64:n=go._toLargeNumber(e.readInt32(),e.readInt32());break;case go.BOOLEAN:n=!!e.readByte();break;case go.DOUBLE:n=e.readFloat32();break;case go.NUM16_1000:n=e.readInt16()/1e3;break;case go.NUM32_1000:n=e.readInt32()/1e3;break;case go.STRING:n=r.keyArray[e.readUint16()][0];break;case go.WORDTEXT:a=e.readUint16(),n=r.keyArray[a][3],n||(n=r.keyArray[a][3]=new Zi,n.setText(r.keyArray[a][0]));break;case go.ARRAYEMPTY:e.readUint8(),n=[];break;case go.ARRAYNUM8:n=[],n.length=a=e.readUint8();for(let t=0;t<a;t++)n[t]=e.readByte();break;case go.ARRAYNUM16:n=[],n.length=a=e.readUint8();for(let t=0;t<a;t++)n[t]=e.readInt16();break;case go.ARRAYNUM32:n=[],n.length=a=e.readUint8();for(let t=0;t<a;t++)n[t]=e.readInt32();break;case go.ARRAYDOUBLE:n=[],n.length=a=e.readUint8();for(let t=0;t<a;t++)n[t]=e.readFloat32();break;case go.ARRAYBUFFER:n=e.readArrayBuffer(e.readUint16());break;case go.ARRAYBUFFER32:n=e.readArrayBuffer(e.readUint32());break;case go.INT8ARRAY:a=this._getLen(e),n=go.readInt8Array(e,e.pos,a);break;case go.UINT8ARRAY:a=this._getLen(e),n=e.readUint8Array(e.pos,a);break;case go.INT16ARRAY:a=this._getLen(e),n=e.readInt16Array(e.pos,a);break;case go.FLOAT32ARRAY:a=this._getLen(e),n=e.readFloat32Array(e.pos,a);break;default:return this._readOne_other(t,e,i,s,r)}return t&&i&&(t[i]=n),n}_readOne_other(t,e,i,s,r){let a,n,l,o,h=t;switch(s){case go.ARRAY8:case go.ARRAY16:case go.ARRAY32:switch(s){case go.ARRAY8:n=e.readUint8();break;case go.ARRAY16:n=e.readInt16();break;case go.ARRAY32:n=e.readUint32()}var u=a=[];for(u.length=n,l=0;l<n;l++)s=e.readUint8(),u[l]=this._readOne(null,e,null,s,r);break;case go.ARRAYREFSOURCE8:case go.ARRAYREFSOURCE16:n=s===go.ARRAYREFSOURCE8?e.readUint8():e.readInt16(),o=e.pos-this._dataStartOfs,a=this._readArray(e,-1,n,s,r),this._objectRef[o]={array:a,pos:o};break;case go.ARRAYREF:case go.ARRAYREF32:l=e.readByte(),o=s==go.ARRAYREF?e.readUint16():e.readUint32();let d=this._objectRef[o];if(!d)throw"load ref err";a=l==go.COMPRESS_NEW?this._readArray(e,o+this._dataStartOfs,d.array.length,s,r):d.array;break;case go.OBJECT:case go.OBJECTTHISCLASS:if(null!=i||!t){if(s==go.OBJECT)h={};else if(n=e.readUint16(),h=this._createObjWithClass(r.keyArray[n][0]),!h)throw"jsonbin read err,no this class:"+r.keyArray[n][0];i&&t&&(t[i]=h)}let c;for(;n=e.readUint16(),n!=go.OBJECTEND;)c=r.keyArray[n],this._readOne(h,e,c[0],c[1],r);a=h,h=t}return null!=i&&(h[i]=a),a}read(t,e=null){this._createObjWithClass=e;let i,s,r=A.now(),a=new W;switch(a.writeArrayBuffer(t),a.pos=0,this._objectRef={},s=a.readInt32(),s){case go.ISJSONBIN:i=a.readUTFString();break;case go.ISJSONBIN2:case go.ISJSONBIN3:i=a.readUTFString32();break;default:return a.pos=0,null}var n=new mo;n.strs=i.split(go.SPLITCHAR),n.keyArray.length=n.strs.length/2;for(var l=0,o=n.strs.length;l<o;l+=2)n.keyArray[l/2]=[n.strs[l],parseInt(n.strs[l+1])];let h=A.now();this._dataStartOfs=a.pos;var u={};return this._readOne(u,a,null,go.OBJECT,n),A.now()-r>10&&console.debug("jsonbinread delay:",A.now()-r+"/"+(h-r),t.byteLength),s==go.ISJSONBIN3?u.top:u}}go.ISJSONBIN=16777215,go.ISJSONBIN2=16777214,go.ISJSONBIN3=16777213,go.SPLITCHAR=String.fromCharCode(3),go.COMPRESS_NEW=1,go.COMPRESS_REF=2,go.COMPRESS_REFMODIFY=3,go.NUM8=0,go.NUM16=1,go.NUM32=2,go.BOOLEAN=3,go.DOUBLE=4,go.STRING=5,go.ARRAY8=6,go.ARRAY16=7,go.ARRAYEMPTY=8,go.ARRAYNUM8=9,go.ARRAYNUM16=10,go.ARRAYNUM32=11,go.ARRAYDOUBLE=12,go.ARRAYSTRING=13,go.NULL=14,go.OBJECT=15,go.NUM16_1000=16,go.NUM32_1000=17,go.WORDTEXT=18,go.ARRAYBUFFER=19,go.ARRAYREF=20,go.ARRAYREFSOURCE8=21,go.ARRAYREFSOURCE16=22,go.ARRAYBUFFER32=23,go.ARRAYREF32=24,go.ARRAY32=25,go.OBJECTTHISCLASS=26,go.NUM64=27,go.INT8ARRAY=28,go.UINT8ARRAY=29,go.INT16ARRAY=30,go.FLOAT32ARRAY=31,go.OBJECTEND=32767;class mo{constructor(){this.keys={},this.strs=["BEGIN",0],this.keyArray=[],this.keyIndex=1}}class yo{static get instance(){return yo._instance||(yo._instance=new yo)}constructor(){this.objectRef={},this.deep=0}_saveKey(t,e,i,s){this.deep++;var r=t+"/&&__*?/"+e,a=i.keys[r];a||(a=i.keys[r]=i.keyIndex,i.strs.push(t,e),i.keyIndex++),s.writeUint16(a),this.deep--}_getValueArrayType(t){switch(typeof t){case"number":if(Math.floor(t)!==t)return go.ARRAYDOUBLE;var e=Math.abs(t);return e<128?go.ARRAYNUM8:e<32767?go.ARRAYNUM16:go.ARRAYNUM32;case"string":return go.OBJECT;case"boolean":return go.BOOLEAN}return go.OBJECT}_writeStrOrWordText(t,e,i,s,r){var a=r?go.WORDTEXT:go.STRING;null!=e?this._saveKey(e,a,t,s):s.writeUint8(a);var n=t.keys[i];n||(n=t.keys[i]=t.keyIndex,t.strs.push(i,0),t.keyIndex++),s.writeUint16(n)}_writeString(t,e,i){var s=t.keys[e];s||(s=t.keys[e]=t.keyIndex,t.strs.push(e,0),t.keyIndex++),i.writeUint16(s)}_getObjectTypeof(t){return t instanceof ArrayBuffer?"ArrayBuffer":t instanceof Uint8Array?"Uint8Array":t instanceof Int8Array?"Int8Array":t instanceof Int16Array?"Int16Array":t instanceof Float32Array?"Float32Array":t instanceof WordText||yo.isWordText(t)?"WordText":"object"}static isWordText(t){return t&&t._text&&(t._$_$ISWORDTYEXT||null!=t.lastGCCnt)}_writeLen(t,e){if(e<128)t.writeUint8(e);else{if(!(e<32768))throw"jsonbin save len must<0x8000 "+e;t.writeUint8(e>>8|128),t.writeUint8(255&e)}}_writeBigNumber(t,e){let i=e.toString(16),s=parseInt(i.substring(0,i.length-7),16),r=parseInt(i.substring(i.length-7),16);if(t.writeInt32(s),t.writeInt32(r),go._toLargeNumber(s,r)!=e)throw"save big number err:"+e}_writeOne(t,e,i,s,r){if(null==s)return!1;let a=typeof s;if("object"==a&&s){if(s.$__$disbaleJsonBinSv)return s.$__$disbaleJsonBinSv,yo.NOSAVETHISOBJ_DELETE,!1;a=this._getObjectTypeof(s)}switch(a){case"number":if(Math.floor(s)!==s){var n=1e3*s;if((0|n)===n){if(Math.abs(s)<32)return null!=i?this._saveKey(i,go.NUM16_1000,e,t):t.writeUint8(go.NUM16_1000),t.writeInt16(n),!0;if(Math.abs(s)<2147483)return null!=i?this._saveKey(i,go.NUM32_1000,e,t):t.writeUint8(go.NUM32_1000),t.writeInt32(n),!0}return null!=i?this._saveKey(i,go.DOUBLE,e,t):t.writeUint8(go.DOUBLE),t.writeFloat32(s),!0}var l=Math.abs(s);return l<128?(null!=i?this._saveKey(i,go.NUM8,e,t):t.writeUint8(go.NUM8),t.writeByte(s),!0):l<32767?(null!=i?this._saveKey(i,go.NUM16,e,t):t.writeUint8(go.NUM16),t.writeInt16(s),!0):l<2147483647?(null!=i?this._saveKey(i,go.NUM32,e,t):t.writeUint8(go.NUM32),t.writeInt32(s),!0):(null!=i?this._saveKey(i,go.NUM64,e,t):t.writeUint8(go.NUM64),this._writeBigNumber(t,s),!0);case"string":return this._writeStrOrWordText(e,i,s,t,!1),!0;case"boolean":return null!=i?this._saveKey(i,go.BOOLEAN,e,t):t.writeUint8(go.BOOLEAN),t.writeByte(s?1:0),!0;case"ArrayBuffer":return null!=i?this._saveKey(i,go.ARRAYBUFFER32,e,t):t.writeUint8(go.ARRAYBUFFER32),t.writeUint32(s.byteLength),t.writeArrayBuffer(s),!0;case"Uint8Array":return null!=i?this._saveKey(i,go.UINT8ARRAY,e,t):t.writeUint8(go.UINT8ARRAY),this._writeLen(t,s.byteLength),t.writeArrayBuffer(s.buffer),!0;case"Int8Array":return null!=i?this._saveKey(i,go.INT8ARRAY,e,t):t.writeUint8(go.INT8ARRAY),this._writeLen(t,s.byteLength),t.writeArrayBuffer(s.buffer),!0;case"Int16Array":return null!=i?this._saveKey(i,go.INT16ARRAY,e,t):t.writeUint8(go.INT16ARRAY),this._writeLen(t,s.byteLength),t.writeArrayBuffer(s.buffer),!0;case"Float32Array":return null!=i?this._saveKey(i,go.FLOAT32ARRAY,e,t):t.writeUint8(go.FLOAT32ARRAY),this._writeLen(t,s.byteLength),t.writeArrayBuffer(s.buffer),!0;case"WordText":return this._writeStrOrWordText(e,i,s._text,t,!0),!0;case"object":break;default:throw"jsonbin no this type:"+a}return s?s instanceof Array?this._saveArray(r,t,e,i,s):(this._classEnable_&&s.__CLASS__?null!=i?this._saveKey(i,go.OBJECTTHISCLASS,e,t):t.writeUint8(go.OBJECTTHISCLASS):null!=i?this._saveKey(i,go.OBJECT,e,t):t.writeUint8(go.OBJECT),this._writeObject(t,e,s),t.writeUint16(go.OBJECTEND),!0):(null!=i?this._saveKey(i,go.NULL,e,t):t.writeUint8(go.NULL),!0)}_saveArray(t,e,i,s,r){var a,n,l,o=r.length;if(0===o)return null!=s?this._saveKey(s,go.ARRAYEMPTY,i,e):e.writeUint8(go.ARRAYEMPTY),e.writeByte(0),!0;if(o>1&&o<250&&(n=this._getValueArrayType(r[0]))!=go.OBJECT){for(a=1;a<o;a++)if(n!==this._getValueArrayType(r[a])){n=go.OBJECT;break}if(n!=go.OBJECT&&n!=go.BOOLEAN){switch(null!=s?this._saveKey(s,n,i,e):e.writeUint8(n),e.writeUint8(r.length),n){case go.ARRAYNUM8:for(a=0;a<o;a++)e.writeByte(r[a]);break;case go.ARRAYNUM16:for(a=0;a<o;a++)e.writeInt16(r[a]);break;case go.ARRAYNUM32:for(a=0;a<o;a++)e.writeInt32(r[a]);break;case go.ARRAYDOUBLE:for(a=0;a<o;a++)e.writeFloat32(r[a])}return!0}}l=o<250?go.ARRAY8:o<32700?go.ARRAY16:go.ARRAY32;var h=e.pos;null!=s?this._saveKey(s,l,i,e):e.writeUint8(l);var u=e.pos,d=0;switch(l){case go.ARRAY8:e.writeUint8(o);break;case go.ARRAY16:e.writeInt16(o);break;case go.ARRAY32:e.writeUint32(o)}var c,_=e.pos;for(a=0;a<o;a++)this._writeOne(e,i,null,r[a],t)&&d++;if(d!=o){var p=e.pos;e.pos=u,l==go.ARRAY8?e.writeUint8(d):e.writeInt16(d),e.pos=p}return s&&t&&(c=t[yo.COMPRESS+s])&&this._useCompress(e,i,s,r,h,_,c,l),!0}_useCompress(t,e,i,s,r,a,n,l){var o,h,u,d,c=t.pos-a,_=fo.getHash(t._u8d_,a,c);if(this.objectRef[_]){var p=this.objectRef[_];for(d=p.length,u=0;u<d;u++)if((h=p[u]).value==s){o=h;break}if(!o)for(u=0;u<d;u++)if(h=p[u],fo.isSame(t._u8d_,h.pos,h.len,t._u8d_,a,c)){o=h;break}}else this.objectRef[_]=[];o?(t.pos=r,this._saveKey(i,go.ARRAYREF32,e,t),t.writeByte(n),t.writeUint32(o.pos)):(this.objectRef[_].push({hashCode:_,pos:a,len:c,value:s}),t.pos=r,this._saveKey(i,l==go.ARRAY8?go.ARRAYREFSOURCE8:go.ARRAYREFSOURCE16,e,t),t.pos=a+c)}_writeObject(t,e,i){for(var s in this._classEnable_&&i.__CLASS__&&this._writeString(e,i.__CLASS__,t),i)s&&s.length>yo.NOSAVE_KEY_LEN&&s.substr(0,yo.NOSAVE_KEY_LEN)==yo.NOSAVEKEY||this._classEnable_&&"__CLASS__"==s||this._writeOne(t,e,s,i[s],i)}write(t,e=!1){this.deep=0,this._classEnable_=e;var i=new To;this.objectRef={};var s=new W;this._writeObject(s,i,{top:t}),s.writeUint16(go.OBJECTEND);var r=new W;return r.writeInt32(go.ISJSONBIN3),r.writeUTFString32(i.strs.join(go.SPLITCHAR)),r.writeArrayBuffer(s.buffer),r.buffer}}yo.COMPRESS="_$TeMpkEy$_CoMpReSs",yo.NOSAVEKEY="_$TeMpkEyNoSv$_",yo.NOSAVETHISOBJ="$__$disbaleJsonBinSv",yo.NOSAVE_KEY_LEN=15,yo.NOSAVETHISOBJ_DELETE=2,yo.NOSAVETHISOBJ_TRUE=1;class To{constructor(){this.keys={},this.strs=["BEGIN",0],this.keyArray=[],this.keyIndex=1}}class xo{constructor(t,e){this.submitStartPos=0,this.submitEndPos=0,this.touches=[],this.submits=[],this.sprite=null,this.meshlist=[],this.cachedClipInfo=new G,this.oldTx=0,this.oldTy=0,this.invMat=new G,this.context=t,this.sprite=e,t._globalClipMatrix.copyTo(this.cachedClipInfo)}startRec(){}endRec(){}isTextNeedRestore(){var t=!1,e=this.touches;if(e)for(var i=0;i<e.length;i++)if(e[i].deleted){t=!0;break}return t}flushsubmit(){Ui.RENDERBASE,this.submits.forEach((t=>{Ui.RENDERBASE}))}releaseMem(){}}xo.matI=new G;class vo{constructor(){this._deviceBufferState=l.renderDeviceFactory.createBufferState()}applyState(t,e){this._vertexBuffers=t,this._bindedIndexBuffer=e,this._deviceBufferState&&(1==t.length?(vo.vertexBufferArray.length=1,vo.vertexBufferArray[0]=t[0]._deviceBuffer):(vo.vertexBufferArray.length=0,t.forEach((t=>{vo.vertexBufferArray.push(t._deviceBuffer)}))),this._deviceBufferState.applyState(vo.vertexBufferArray,e?e._deviceBuffer:null))}destroy(){this._deviceBufferState&&(this._deviceBufferState.destroy(),this._deviceBufferState=null)}}vo.vertexBufferArray=[];class So{static ArrayMul(t,e,i){if(t)if(e)for(var s,r,a,n,l=0;l<4;l++)s=t[l],r=t[l+4],a=t[l+8],n=t[l+12],i[l]=s*e[0]+r*e[1]+a*e[2]+n*e[3],i[l+4]=s*e[4]+r*e[5]+a*e[6]+n*e[7],i[l+8]=s*e[8]+r*e[9]+a*e[10]+n*e[11],i[l+12]=s*e[12]+r*e[13]+a*e[14]+n*e[15];else So.copyArray(t,i);else So.copyArray(e,i)}static copyArray(t,e){if(t&&e)for(var i=0;i<t.length;i++)e[i]=t[i]}}const Eo=[[1569,65152,null,null,null],[1570,65153,null,null,65154],[1571,65155,null,null,65156],[1572,65157,null,null,65158],[1573,65159,null,null,65160],[1574,65161,65163,65164,65162],[1575,65165,null,null,65166],[1576,65167,65169,65170,65168],[1577,65171,null,null,65172],[1578,65173,65175,65176,65174],[1579,65177,65179,65180,65178],[1580,65181,65183,65184,65182],[1581,65185,65187,65188,65186],[1582,65189,65191,65192,65190],[1583,65193,null,null,65194],[1584,65195,null,null,65196],[1585,65197,null,null,65198],[1586,65199,null,null,65200],[1587,65201,65203,65204,65202],[1588,65205,65207,65208,65206],[1589,65209,65211,65212,65210],[1590,65213,65215,65216,65214],[1591,65217,65219,65220,65218],[1592,65221,65223,65224,65222],[1593,65225,65227,65228,65226],[1594,65229,65231,65232,65230],[1600,1600,1600,1600,1600],[1601,65233,65235,65236,65234],[1602,65237,65239,65240,65238],[1603,65241,65243,65244,65242],[1604,65245,65247,65248,65246],[1605,65249,65251,65252,65250],[1606,65253,65255,65256,65254],[1607,65257,65259,65260,65258],[1608,65261,null,null,65262],[1609,65263,null,null,65264],[1610,65265,65267,65268,65266],[1662,64342,64344,64345,64343],[1740,64508,64510,64511,64509],[1670,64378,64380,64381,64379],[1705,64398,64400,64401,64399],[1711,64402,64404,64405,64403],[1688,64394,null,null,64395]],wo=[[[1604,1570],65269,null,null,65270],[[1604,1571],65271,null,null,65272],[[1604,1573],65273,null,null,65274],[[1604,1575],65275,null,null,65276]],Do=[1552,1554,1555,1556,1557,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1648,1750,1751,1752,1753,1754,1755,1756,1759,1760,1761,1762,1763,1764,1767,1768,1770,1771,1772,1773];return t.AlphaCmd=Ms,t.Animation=Br,t.Animation2DCondition=Yn,t.Animation2DEvent=Gn,t.Animation2DParm=Wn,t.AnimationBase=Cr,t.AnimationClip2D=zn,t.AnimationClip2DParse01=Vn,t.Animator2D=On,t.AnimatorController2D=Qn,t.AnimatorControllerLayer2D=Cn,t.AnimatorControllerParse=Nn,t.AnimatorPlayState2D=bn,t.AnimatorState2D=Fn,t.AnimatorState2DScript=class{setPlayScriptInfo(t,e,i){this.playStateInfo.animator=t,this.playStateInfo.layerindex=e,this.playStateInfo.playState=i}constructor(){this.playStateInfo={animator:null,layerindex:-1,playState:null}}onStateEnter(){}onStateUpdate(t){}onStateExit(){}onStateLoop(){}},t.AnimatorStateBoolCondition=qn,t.AnimatorStateCondition=Xn,t.AnimatorStateNumberCondition=jn,t.AnimatorStateTriggerCondition=$n,t.AnimatorTransition2D=Kn,t.ArabicReshaper=class{characterMapContains(t){for(var e=0;e<Eo.length;++e)if(Eo[e][0]===t)return!0;return!1}getCharRep(t){for(var e=0;e<Eo.length;++e)if(Eo[e][0]===t)return Eo[e];return!1}getCombCharRep(t,e){for(var i=0;i<wo.length;++i)if(wo[i][0][0]===t&&wo[i][0][1]===e)return wo[i];return!1}isTransparent(t){for(var e=0;e<Do.length;++e)if(Do[e]===t)return!0;return!1}getOriginalCharsFromCode(t){var e;for(e=0;e<Eo.length;++e)if(Eo[e].indexOf(t)>-1)return String.fromCharCode(Eo[e][0]);for(e=0;e<wo.length;++e)if(wo[e].indexOf(t)>-1)return String.fromCharCode(wo[e][0][0])+String.fromCharCode(wo[e][0][1]);return String.fromCharCode(t)}convertArabic(t){for(var e,i,s="",r=0;r<t.length;++r){var a=t.charCodeAt(r);if(this.characterMapContains(a)){for(var n=null,l=null,o=r-1,h=r+1;o>=0&&this.isTransparent(t.charCodeAt(o));--o);for((!(e=!!(n=o>=0?t.charCodeAt(o):null)&&this.getCharRep(n))||null==e[2]&&null==e[3])&&(n=null);h<t.length&&this.isTransparent(t.charCodeAt(h));++h);if((!(e=!!(l=h<t.length?t.charCodeAt(h):null)&&this.getCharRep(l))||null==e[3]&&null==e[4])&&(l=null),1604===a&&null!=l&&(1570===l||1571===l||1573===l||1575===l)){i=this.getCombCharRep(a,l),s+=null!=n?String.fromCharCode(i[4]):String.fromCharCode(i[1]),++r;continue}if(e=this.getCharRep(a),null!=n&&null!=l&&null!=e[3]){s+=String.fromCharCode(e[3]);continue}if(null!=n&&null!=e[4]){s+=String.fromCharCode(e[4]);continue}if(null!=l&&null!=e[2]){s+=String.fromCharCode(e[2]);continue}s+=String.fromCharCode(e[1])}else s+=String.fromCharCode(a)}return s}convertArabicBack(t){var e,i,s="";for(i=0;i<t.length;++i)e=t.charCodeAt(i),s+=this.getOriginalCharsFromCode(e);return s}},t.AssetDb=N,t.AtlasGrid=Yi,t.AtlasInfoManager=yt,t.AtlasResource=xt,t.AudioSound=Ca,t.AudioSoundChannel=ba,t.Base64Tool=Xl,t.BasePoly=Pi,t.BaseRenderNode2D=Hl,t.BaseTexture=C,t.Batch2DInfo=ce,t.BatchProgress=vt,t.Bezier=_i,t.BinHashUtils=fo,t.BitmapFont=Lr,t.BlendComponent=Sl,t.BlendMode=fi,t.BlendState=vl,t.BlurFilter=gn,t.BoundsStyle=Rs,t.Browser=A,t.Buffer=El,t.BufferState=vo,t.ButtonEffect=class{constructor(){this._curState=0,this.effectScale=1.5,this.tweenTime=300}set target(t){this._tar=t,t.on(r.MOUSE_DOWN,this,this.toChangedState),t.on(r.MOUSE_UP,this,this.toInitState),t.on(r.MOUSE_OUT,this,this.toInitState)}toChangedState(){this._curState=1,this._curTween&&Er.clear(this._curTween),this._curTween=Er.to(this._tar,{scaleX:this.effectScale,scaleY:this.effectScale},this.tweenTime,Sr[this.effectEase],St.create(this,this.tweenComplete))}toInitState(){2!=this._curState&&(this._curTween&&Er.clear(this._curTween),this._curState=2,this._curTween=Er.to(this._tar,{scaleX:1,scaleY:1},this.tweenTime,Sr[this.backEase],St.create(this,this.tweenComplete)))}tweenComplete(){this._curState=0,this._curTween=null}},t.Byte=W,t.CacheManger=cr,t.CachePage=ys,t.CacheStyle=As,t.Cache_Info=fs,t.CallLater=ma,t.CharRenderInfo=Vi,t.CharRender_Canvas=ts,t.CharSubmitCache=Gi,t.ClassUtils=Ot,t.ClipRectCmd=ur,t.Color=_t,t.ColorFilter=xn,t.ColorUtils=mi,t.CommandEncoder=class{constructor(){this._idata=[]}getArrayData(){return this._idata}getCount(){return this._idata.length}addShaderUniform(t){this._idata.push(t)}},t.CommandUniformMap=class{constructor(t){}addShaderUniform(t,e,i,s=null){throw"need override it"}addShaderUniformArray(t,e,i,s,r=""){throw"need override it"}addShaderBlockUniform(t,e,i){throw"need override it"}},t.Component=Vt,t.ComponentDriver=va,t.Config=f,t.Config3D=_,t.Const=Ut,t.Context=os,t.DDSTextureInfo=lt,t.DefferTouchResContext=cs,t.Delegate=T,t.DepthState=class{},t.Downloader=At,t.Dragging=wr,t.Draw9GridTextureCmd=Zs,t.DrawCircleCmd=Bs,t.DrawCurvesCmd=Ls,t.DrawEllipseCmd=er,t.DrawGeoCmd=pr,t.DrawGeosCmd=fr,t.DrawImageCmd=Ps,t.DrawLineCmd=Ns,t.DrawLinesCmd=Fs,t.DrawPathCmd=Us,t.DrawPieCmd=Gs,t.DrawPolyCmd=Hs,t.DrawRectCmd=zs,t.DrawRoundRectCmd=ir,t.DrawStyle=yi,t.DrawTextureCmd=Ws,t.DrawTexturesCmd=dr,t.DrawTrianglesCmd=Qs,t.Earcut=Oi,t.EarcutNode=Ni,t.Ease=Sr,t.EffectAnimation=Pr,t.EffectBase=Dl,t.Event=r,t.EventDispatcher=v,t.FadeIn=class extends Dl{_doTween(){return this.target.alpha=0,Er.to(this.target,{alpha:1},this.duration,Sr[this.ease],this._comlete,this.delay)}},t.FadeOut=class extends Dl{_doTween(){return this.target.alpha=1,Er.to(this.target,{alpha:0},this.duration,Sr[this.ease],this._comlete,this.delay)}},t.FastSinglelist=de,t.FillTextCmd=sr,t.FillTextureCmd=Ys,t.Filter=ie,t.FontInfo=$i,t.FrameAnimation=Ar,t.GLSLCodeGenerator=Nl,t.GlowFilter=vn,t.GrahamScan=se,t.GraphicAnimation=Ir,t.Graphics=gr,t.GraphicsBounds=lr,t.HDRTextureInfo=tl,t.HTMLCanvas=Cs,t.HalfFloatUtils=Y,t.Handler=St,t.HideFlags=Gt,t.HierarchyLoader=_n,t.HierarchyParser=cn,t.HierarchyResource=un,t.HitArea=$l,t.HtmlElement=Fr,t.HtmlImage=Ur,t.HtmlLink=kr,t.HtmlParseOptions=Gr,t.HtmlParser=zr,t.HttpRequest=Rt,t.ICharRender=Ji,t.ILaya=e,t.ImgUtils=Et,t.IncludeFile=Se,t.IndexBuffer=class extends El{constructor(e,i){super(e,i),this._indexType=t.IndexFormat.UInt16}},t.Input=ln,t.InputManager=ca,t.JsonBinRead=go,t.JsonBinWrite=yo,t.KTXTextureInfo=dt,t.KeyLocation=bl,t.Keyboard=Cl,t.Keyframe2D=kn,t.KeyframeNode2D=Un,t.KeyframeNodeList2D=Hn,t.Laya=Va,t.LayaEnv=n,t.LayaGL=l,t.LayaGLQuickRunner=us,t.Loader=Bt,t.LocalStorage=Ma,t.Log=Kl,t.Material=Ga,t.MaterialLoader=_l,t.MaterialParser=cl,t.MathUtil=Rr,t.MathUtils3D=h,t.MatirxArray=So,t.Matrix=G,t.Matrix3x3=Fe,t.Matrix4x4=Ke,t.MeasureFont=Wi,t.Mesh2D=class extends b{static load(t,i){e.loader.load(t,i,null,Bt.MESH)}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get vertexCount(){return this._vertexCount}get indexCount(){return this._indexBuffer.indexCount}get subMeshCount(){return this._subMeshes.length}get indexFormat(){return this._indexFormat}set indexFormat(t){this._indexFormat=t,this._subMeshes.forEach((e=>{e.indexFormat=t}))}constructor(){super(),this._instanceBufferStateType=0,this._vertexBuffers=null,this._indexBuffer=null,this._vertexCount=0,this._indexFormat=t.IndexFormat.UInt16,this._bufferState=l.renderDeviceFactory.createBufferState(),this._subMeshes=[],this.destroyedImmediately=f.destroyResourceImmediatelyDefault}_disposeResource(){for(let t=0,e=this._subMeshes.length;t<e;t++)this._subMeshes[t].destroy();for(let t=0,e=this._vertexBuffers.length;t<e;t++)this._vertexBuffers[t].destroy();this._indexBuffer&&this._indexBuffer.destroy(),this._bufferState.destroy(),this._instanceBufferState&&this._instanceBufferState.destroy(),this._instanceWorldVertexBuffer&&this._instanceWorldVertexBuffer.destroy(),this._instanceSimpleAniVertexBuffer&&this._instanceSimpleAniVertexBuffer.destroy(),this._setCPUMemory(0),this._setGPUMemory(0),this._bufferState=null,this._instanceBufferState=null,this._vertexBuffers=null,this._indexBuffer=null,this._subMeshes=null,this._indexBuffer=null}_setSubMeshes(t){this._subMeshes=t}_setBuffer(t,e){this._bufferState.applyState([t],e)}getSubMesh(t){return this._subMeshes[t]}setVertices(t){for(let e=0,i=t.length;e<i;e++)t[e]&&this._vertexBuffers[e]&&this._vertexBuffers[e].setData(t[e],0,0,t[e].byteLength)}setIndices(e){var i;e instanceof Uint32Array?i=t.IndexFormat.UInt32:e instanceof Uint16Array?i=t.IndexFormat.UInt16:e instanceof Uint8Array&&(i=t.IndexFormat.UInt8);let s=this._indexBuffer;this._indexFormat===i&&s.indexCount===e.length||(s.destroy(),this._indexBuffer=s=l.renderDeviceFactory.createIndexBuffer(t.BufferUsage.Static),s.indexCount=s.indexCount,s.indexType=i),s._setIndexData(e,0),this.indexFormat=i}},t.MeshQuadTexture=ee,t.MeshTexture=ss,t.MeshVG=rs,t.Mouse=Na,t.Node=yr,t.NodeFlags=kt,t.NotImplementedError=V,t.NotReadableError=z,t.NullLoader=ul,t.OutOfRangeError=H,t.PERF_BEGIN=ao,t.PERF_END=no,t.PERF_FRAMECLEAR=lo,t.ParseJSON=pl,t.Path=Ti,t.PerfData=Ql,t.PerfHUD=Zl,t.PerfTools=so,t.PerformanceDefine=ro,t.PlayerConfig=g,t.Point=s,t.Pool=i,t.PoolCache=Jl,t.Prefab=hn,t.PrefabImpl=dn,t.PrimitiveSV=La,t.Quaternion=ze,t.QuickTestTool=Rl,t.Rectangle=F,t.Render=Za,t.Render2D=oe,t.Render2DSimple=he,t.RenderInfo=ki,t.RenderManager2D=_e,t.RenderObject2D=ps,t.RenderSprite=bs,t.RenderState=ve,t.RenderState2D=le,t.RenderStateContext=pi,t.RenderTexture=R,t.RenderTexture2D=pt,t.RenderTextureCube=class extends R{constructor(t,e,i,s,r){super(t,t,e,i,s,r),this.faceIndex=0}_createRenderTarget(){this._dimension=t.TextureDimension.Cube,this._renderTarget=l.textureContext.createRenderTargetCubeInternal(this.width,this._format,this._depthStencilFormat,this._generateMipmap,this._gammaSpace,this._multiSamples),this._texture=this._renderTarget._textures[0]}},t.RenderTextureLoader=sl,t.RenderToCache=_s,t.Resource=b,t.RestoreCmd=Xs,t.RotateCmd=js,t.RunDriver=xa,t.SaveBase=vi,t.SaveClipRect=Si,t.SaveCmd=tr,t.SaveMark=Ei,t.SaveTransform=wi,t.SaveTranslate=Di,t.ScaleCmd=qs,t.Scene=pn,t.Script=Zn,t.SerializeUtil=rn,t.Shader2D=Ci,t.Shader3D=ci,t.ShaderCompile=Be,t.ShaderCompileDefineBase=ai,t.ShaderData=class{constructor(t=null){this._ownerResource=t}_addCheckUBO(t,e,i){throw new V}_releaseUBOData(){throw new V}getDefineData(){throw new V}getData(){throw new V}addDefine(t){throw new V}addDefines(t){throw new V}removeDefine(t){throw new V}hasDefine(t){throw new V}clearDefine(){throw new V}getBool(t){throw new V}setBool(t,e){throw new V}getInt(t){throw new V}setInt(t,e){throw new V}getNumber(t){throw new V}setNumber(t,e){throw new V}getVector2(t){throw new V}setVector2(t,e){throw new V}getVector3(t){throw new V}setVector3(t,e){throw new V}getVector(t){throw new V}setVector(t,e){throw new V}getColor(t){throw new V}setColor(t,e){throw new V}getMatrix4x4(t){throw new V}setMatrix4x4(t,e){throw new V}getMatrix3x3(t){throw new V}setMatrix3x3(t,e){throw new V}getBuffer(t){throw new V}setBuffer(t,e){throw new V}setTexture(t,e){throw new V}getTexture(t){throw new V}setUniformBuffer(t,e){throw new V}getUniformBuffer(t){throw new V}setShaderData(e,i,s){switch(i){case t.ShaderDataType.Int:this.setInt(e,s);break;case t.ShaderDataType.Bool:this.setBool(e,s);break;case t.ShaderDataType.Float:this.setNumber(e,s);break;case t.ShaderDataType.Vector2:this.setVector2(e,s);break;case t.ShaderDataType.Vector3:this.setVector3(e,s);break;case t.ShaderDataType.Vector4:this.setVector(e,s);break;case t.ShaderDataType.Color:this.setColor(e,s);break;case t.ShaderDataType.Matrix4x4:this.setMatrix4x4(e,s);break;case t.ShaderDataType.Matrix3x3:this.setMatrix3x3(e,s);break;case t.ShaderDataType.Texture2D:case t.ShaderDataType.TextureCube:this.setTexture(e,s);break;case t.ShaderDataType.Buffer:this.setBuffer(e,s);break;default:throw new Error(`unknown shader data type: ${i}`)}}getShaderData(e,i){switch(i){case t.ShaderDataType.Int:return this.getInt(e);case t.ShaderDataType.Bool:return this.getBool(e);case t.ShaderDataType.Float:return this.getNumber(e);case t.ShaderDataType.Vector2:return this.getVector2(e);case t.ShaderDataType.Vector3:return this.getVector3(e);case t.ShaderDataType.Vector4:return this.getVector(e);case t.ShaderDataType.Color:return this.getColor(e);case t.ShaderDataType.Matrix4x4:return this.getMatrix4x4(e);case t.ShaderDataType.Texture2D:case t.ShaderDataType.TextureCube:return this.getTexture(e);case t.ShaderDataType.Buffer:return this.getBuffer(e);case t.ShaderDataType.Matrix3x3:return this.getMatrix3x3(e);case t.ShaderDataType.Matrix4x4:return this.getMatrix4x4(e);default:throw"unknown shader data type."}}_setInternalTexture(t,e){throw new V}cloneTo(t){throw new V}_cloneUBO(t){throw new V}clone(){throw new V}reset(){throw new V}destroy(){throw new V}},t.ShaderDataDefaultValue=ii,t.ShaderDefine=class{constructor(t,e){this._index=t,this._value=e}},t.ShaderDefines2D=Ri,t.ShaderNode=Ee,t.ShaderParser=Tl,t.ShaderPass=oi,t.ShaderProcessInfo=ri,t.ShaderVariable=Fl,t.ShaderVariant=ni,t.ShaderVariantCollection=li,t.SingletonList=ue,t.Socket=po,t.Sound=class extends v{load(t){}play(t=0,e=0){return null}get duration(){return 0}dispose(){}},t.SoundChannel=Da,t.SoundManager=Ia,t.SoundNode=Sn,t.Sprite=br,t.Sprite2DGeometry=te,t.SpriteCache=xs,t.SpriteConst=re,t.SpriteStyle=Is,t.SpriteUtils=Dr,t.Stage=Sa,t.Stat=ae,t.StencilState=class{},t.StringKey=class{constructor(){this._strsToID={},this._idToStrs=[],this._length=0}add(t){var e=this._strsToID[t];return null!=e?e:(this._idToStrs[this._length]=t,this._strsToID[t]=this._length++)}getID(t){var e=this._strsToID[t];return null==e?-1:e}getName(t){var e=this._idToStrs[t];return null==e?void 0:e}},t.SubShader=ui,t.SubUniformBufferData=class extends si{constructor(t,e){super(t),this._isInPool=!1,this._needUpdate=!1,this._realByte=0,this._offset=e,this._realByte=this._bytelength,this._bytelength=256*Math.ceil(this._bytelength/256)}},t.SubmitBase=Ui,t.SubmitKey=Fi,t.System=class{static changeDefinition(t,e){window.Laya[t]=e;var i=t+"=classObj";window.eval(i)}},t.Text=Yr,t.TextAtlas=qi,t.TextRender=es,t.TextResource=Jn,t.TextStyle=Nr,t.TextTexture=ji,t.Texture=mt,t.Texture2D=ct,t.Texture2DArray=$a,t.Texture2DLoader=il,t.Texture3D=Wl,t.TextureCube=Qa,t.TextureLoader=ll,t.TextureSV=Pa,t.TimeLine=to,t.Timer=fa,t.TransformCmd=$s,t.TranslateCmd=Ks,t.Tween=Er,t.TypedArrayClasses=Ja,t.UBBParser=Wr,t.URL=O,t.UniformBufferAlone=co,t.UniformBufferBase=Fa,t.UniformBufferBlock=oo,t.UniformBufferCluster=ho,t.UniformBufferManager=class{constructor(t){this.useBigBuffer=!0,this.destroyed=!1,this.snCounter=0,this.byteAlign=256,this.clusterMaxBlock=256,this.uploadThreshold=200,this.moveNum=0,this.uploadNum=0,this.uploadByte=0,this.removeHoleTimer=0,this.timeCostAvg=0,this.timeCostSum=0,this.timeCostCount=0,this.clustersAll=new Map,this.clustersCur=new Map,this.useBigBuffer=t}_addCluster(t,e=10){const i=uo(t,this.byteAlign),s=new ho(i,e,this),r=this.clustersAll.get(i);return r?(r.push(s),s.sn=r.length-1):this.clustersAll.set(i,[s]),this.clustersCur.set(i,s),s}_removeHole(){this.useBigBuffer&&this.clustersAll.forEach((t=>{for(let e=t.length-1;e>-1;e--)t[e].removeHole()}))}startFrame(){this.uploadNum=0,this.uploadByte=0}setRenderContext(t){this.renderContext=t}getBufferAlone(t,e){const i=uo(t,this.byteAlign);return this.statisGPUMemory(i),this.createGPUBuffer(i,e)}removeCluster(t,e){const i=uo(t,this.byteAlign);if(-1===e)return this.clustersAll.delete(i),void this.clustersCur.delete(i);const s=this.clustersCur.get(i),r=this.clustersAll.get(i);if(r.length>e){if(r.splice(e,1),0===r.length)return this.clustersAll.delete(i),void this.clustersCur.delete(i);for(let t=e;t<r.length;t++)r[t].sn--;if(s.sn===e)if(1===r.length)this.clustersCur.set(i,r[0]);else{let t=0,e=r[0].usedNum;for(let i=1;i<r.length;i++)r[i].usedNum<e&&(t=i,e=r[i].usedNum);this.clustersCur.set(i,r[t])}}}getBlock(t,e){const i=uo(t,this.byteAlign);let s=this.clustersCur.get(i);if(!s)return this._addCluster(i).getBlock(t,e);if(s.usedNum<this.clusterMaxBlock)return s.getBlock(t,e);s=null;const r=this.clustersAll.get(i);for(let t=r.length-1;t>-1;t--)if(r[t].usedNum<this.clusterMaxBlock){s=r[t],this.clustersCur.set(i,s);break}return s?s.getBlock(t,e):this._addCluster(i).getBlock(t,e)}freeBlock(t){const e=t.cluster;return!!e&&(!!e.freeBlock(t)&&(0===e.usedNum&&this.removeCluster(e.blockSize,e.sn),!0))}upload(){if(this.useBigBuffer){const t=performance.now();this.clustersAll.forEach((t=>{for(let e=t.length-1;e>-1;e--)t[e].upload(),t[e].optimize()})),this.timeCostSum+=performance.now()-t,this.timeCostCount++,this.timeCostCount>100&&(this.timeCostAvg=this.timeCostSum/this.timeCostCount*1e3|0,this.timeCostSum=0,this.timeCostCount=0),this.removeHoleTimer++,this.removeHoleTimer>1e3&&(this.removeHoleTimer=0,this._removeHole())}}clear(){this.clustersAll.forEach((t=>{for(let e=t.length-1;e>-1;e--)t[e].clear()}))}destroy(){return this.destroyed?(console.warn("UniformBufferManager: object alreay destroyed!"),!1):(this.clear(),this.clustersAll.clear(),this.clustersCur.clear(),this.destroyed=!0,!0)}createGPUBuffer(t,e){}writeBuffer(t,e,i,s){}statisGPUMemory(t){}statisUpload(t,e){}},t.UniformBufferObject=Ua,t.UniformBufferUser=_o,t.UnifromBufferData=si,t.Utils=P,t.Value2D=Ai,t.Value2DManager=class{},t.Vector2=Ze,t.Vector3=d,t.Vector4=u,t.VectorGraphManager=_r,t.VertexAttributeLayout=wl,t.VertexBuffer=class extends El{get vertexDeclaration(){return this._vertexDeclaration}set vertexDeclaration(t){this._vertexDeclaration=t}get instanceBuffer(){return this._instanceBuffer}set instanceBuffer(t){this._instanceBuffer=t}constructor(t,e){super(t,e),this._instanceBuffer=!1,this._vertexDeclaration=null}},t.VertexDeclaration=Zt,t.VertexElement=Jt,t.VertexElementFormat=Kt,t.VertexMesh=hi,t.VertexMesh2D=zl,t.VertexStateContext=Qt,t.VideoNode=Dn,t.VideoTexture=En,t.VideoTextureLoader=rl,t.Viewport=Ul,t.WasmAdapter=io,t.WeakObject=Oa,t.WebAudioSound=Aa,t.WebAudioSoundChannel=Ra,t.WebGL=Ta,t.WebGLCacheAsNormalCanvas=xo,t.WebGLRTMgr=Yl,t.Widget=on,t.WordText=Zi,t.WorkerLoader=Tt,t.XML=Ct,t.XMLIterator=bt,t.XMLUtils=wt,t.addAfterInitCallback=qa,t.addBeforeInitCallback=ja,t.addInitCallback=Xa,t.alertGlobalError=Wa,t.allowMultiple=function(t){t.prototype._$singleton=!1},t.classInfo=function(t){return Ft},t.enableDebugPanel=Ya,t.init=Ha,t.property=function(t){return Ft},t.regClass=function(t){return function(e){Ot.regClass(t,e)}},t.regLoader=function(t,e,i){return function(s){Bt.registerLoader(t,s,e,i)}},t.roundDown=function(t,e){const i=((t+e-1)/e|0)*e;return i>t?i-e:i},t.roundUp=uo,t.runInEditor=function(t){},t}({});